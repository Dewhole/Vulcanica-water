function _toConsumableArray2(a){return _arrayWithoutHoles2(a)||_iterableToArray2(a)||_nonIterableSpread2()}function _nonIterableSpread2(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray2(a){return Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a)?Array.from(a):void 0}function _arrayWithoutHoles2(a){if(Array.isArray(a)){for(var b=0,c=new Array(a.length);b<a.length;b++)c[b]=a[b];return c}}function _slicedToArray(a,b){return _arrayWithHoles(a)||_iterableToArrayLimit(a,b)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(a,b){var c=[],d=!0,e=!1,f=void 0;try{for(var g,h=a[Symbol.iterator]();!(d=(g=h.next()).done)&&(c.push(g.value),!b||c.length!==b);d=!0);}catch(i){e=!0,f=i}finally{try{d||null==h["return"]||h["return"]()}finally{if(e)throw f}}return c}function _arrayWithHoles(a){return Array.isArray(a)?a:void 0}function _get2(a,b,c){return(_get2="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(a,b,c){var d=_superPropBase2(a,b);if(d){var e=Object.getOwnPropertyDescriptor(d,b);return e.get?e.get.call(c):e.value}})(a,b,c||a)}function _superPropBase2(a,b){for(;!Object.prototype.hasOwnProperty.call(a,b)&&(a=_getPrototypeOf2(a),null!==a););return a}function _possibleConstructorReturn2(a,b){return!b||"object"!==_typeof2(b)&&"function"!=typeof b?_assertThisInitialized2(a):b}function _assertThisInitialized2(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function _getPrototypeOf2(a){return(_getPrototypeOf2=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)})(a)}function _inherits2(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),b&&_setPrototypeOf2(a,b)}function _setPrototypeOf2(a,b){return(_setPrototypeOf2=Object.setPrototypeOf||function(a,b){return a.__proto__=b,a})(a,b)}function _classCallCheck2(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function _createClass2(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),a}function _typeof2(a){return(_typeof2="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a})(a)}!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b.adapter=a()}}(function(){return function(){function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c||a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}return a}()({1:[function(a,b,c){"use strict";var d=a("./adapter_factory.js"),e=(0,d.adapterFactory)({window:window});b.exports=e},{"./adapter_factory.js":2}],2:[function(a,b,c){"use strict";function d(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b["default"]=a,b}function e(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},b=a.window,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0},d=g.log,e=g.detectBrowser(b),f={browserDetails:e,commonShim:q,extractVersion:g.extractVersion,disableLog:g.disableLog,disableWarnings:g.disableWarnings};switch(e.browser){case"chrome":if(!i||!i.shimPeerConnection||!c.shimChrome)return d("Chrome shim is not included in this adapter release."),f;d("adapter.js shimming chrome."),f.browserShim=i,i.shimGetUserMedia(b),i.shimMediaStream(b),i.shimPeerConnection(b),i.shimOnTrack(b),i.shimAddTrackRemoveTrack(b),i.shimGetSendersWithDtmf(b),i.shimGetStats(b),i.shimSenderReceiverGetStats(b),i.fixNegotiationNeeded(b),q.shimRTCIceCandidate(b),q.shimConnectionState(b),q.shimMaxMessageSize(b),q.shimSendThrowTypeError(b),q.removeAllowExtmapMixed(b);break;case"firefox":if(!m||!m.shimPeerConnection||!c.shimFirefox)return d("Firefox shim is not included in this adapter release."),f;d("adapter.js shimming firefox."),f.browserShim=m,m.shimGetUserMedia(b),m.shimPeerConnection(b),m.shimOnTrack(b),m.shimRemoveStream(b),m.shimSenderGetStats(b),m.shimReceiverGetStats(b),m.shimRTCDataChannel(b),q.shimRTCIceCandidate(b),q.shimConnectionState(b),q.shimMaxMessageSize(b),q.shimSendThrowTypeError(b);break;case"edge":if(!k||!k.shimPeerConnection||!c.shimEdge)return d("MS edge shim is not included in this adapter release."),f;d("adapter.js shimming edge."),f.browserShim=k,k.shimGetUserMedia(b),k.shimGetDisplayMedia(b),k.shimPeerConnection(b),k.shimReplaceTrack(b),q.shimMaxMessageSize(b),q.shimSendThrowTypeError(b);break;case"safari":if(!o||!c.shimSafari)return d("Safari shim is not included in this adapter release."),f;d("adapter.js shimming safari."),f.browserShim=o,o.shimRTCIceServerUrls(b),o.shimCreateOfferLegacy(b),o.shimCallbacksAPI(b),o.shimLocalStreamsAPI(b),o.shimRemoteStreamsAPI(b),o.shimTrackEventTransceiver(b),o.shimGetUserMedia(b),q.shimRTCIceCandidate(b),q.shimMaxMessageSize(b),q.shimSendThrowTypeError(b),q.removeAllowExtmapMixed(b);break;default:d("Unsupported browser!")}return f}Object.defineProperty(c,"__esModule",{value:!0}),c.adapterFactory=e;var f=a("./utils"),g=d(f),h=a("./chrome/chrome_shim"),i=d(h),j=a("./edge/edge_shim"),k=d(j),l=a("./firefox/firefox_shim"),m=d(l),n=a("./safari/safari_shim"),o=d(n),p=a("./common_shim"),q=d(p)},{"./chrome/chrome_shim":3,"./common_shim":6,"./edge/edge_shim":7,"./firefox/firefox_shim":11,"./safari/safari_shim":14,"./utils":15}],3:[function(a,b,c){"use strict";function d(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b["default"]=a,b}function e(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function f(a){a.MediaStream=a.MediaStream||a.webkitMediaStream}function g(a){if("object"!==("undefined"==typeof a?"undefined":o(a))||!a.RTCPeerConnection||"ontrack"in a.RTCPeerConnection.prototype)s.wrapPeerConnectionEvent(a,"track",function(a){return a.transceiver||Object.defineProperty(a,"transceiver",{value:{receiver:a.receiver}}),a});else{Object.defineProperty(a.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(a){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=a)},enumerable:!0,configurable:!0});var b=a.RTCPeerConnection.prototype.setRemoteDescription;a.RTCPeerConnection.prototype.setRemoteDescription=function(){var c=this;return this._ontrackpoly||(this._ontrackpoly=function(b){b.stream.addEventListener("addtrack",function(d){var e=void 0;e=a.RTCPeerConnection.prototype.getReceivers?c.getReceivers().find(function(a){return a.track&&a.track.id===d.track.id}):{track:d.track};var f=new Event("track");f.track=d.track,f.receiver=e,f.transceiver={receiver:e},f.streams=[b.stream],c.dispatchEvent(f)}),b.stream.getTracks().forEach(function(d){var e=void 0;e=a.RTCPeerConnection.prototype.getReceivers?c.getReceivers().find(function(a){return a.track&&a.track.id===d.id}):{track:d};var f=new Event("track");f.track=d,f.receiver=e,f.transceiver={receiver:e},f.streams=[b.stream],c.dispatchEvent(f)})},this.addEventListener("addstream",this._ontrackpoly)),b.apply(this,arguments)}}}function h(a){if("object"===("undefined"==typeof a?"undefined":o(a))&&a.RTCPeerConnection&&!("getSenders"in a.RTCPeerConnection.prototype)&&"createDTMFSender"in a.RTCPeerConnection.prototype){var b=function(a,b){return{track:b,get dtmf(){return void 0===this._dtmf&&("audio"===b.kind?this._dtmf=a.createDTMFSender(b):this._dtmf=null),this._dtmf},_pc:a}};if(!a.RTCPeerConnection.prototype.getSenders){a.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var c=a.RTCPeerConnection.prototype.addTrack;a.RTCPeerConnection.prototype.addTrack=function(a,d){var e=c.apply(this,arguments);return e||(e=b(this,a),this._senders.push(e)),e};var d=a.RTCPeerConnection.prototype.removeTrack;a.RTCPeerConnection.prototype.removeTrack=function(a){d.apply(this,arguments);var b=this._senders.indexOf(a);-1!==b&&this._senders.splice(b,1)}}var e=a.RTCPeerConnection.prototype.addStream;a.RTCPeerConnection.prototype.addStream=function(a){var c=this;this._senders=this._senders||[],e.apply(this,[a]),a.getTracks().forEach(function(a){c._senders.push(b(c,a))})};var f=a.RTCPeerConnection.prototype.removeStream;a.RTCPeerConnection.prototype.removeStream=function(a){var b=this;this._senders=this._senders||[],f.apply(this,[a]),a.getTracks().forEach(function(a){var c=b._senders.find(function(b){return b.track===a});c&&b._senders.splice(b._senders.indexOf(c),1)})}}else if("object"===("undefined"==typeof a?"undefined":o(a))&&a.RTCPeerConnection&&"getSenders"in a.RTCPeerConnection.prototype&&"createDTMFSender"in a.RTCPeerConnection.prototype&&a.RTCRtpSender&&!("dtmf"in a.RTCRtpSender.prototype)){var g=a.RTCPeerConnection.prototype.getSenders;a.RTCPeerConnection.prototype.getSenders=function(){var a=this,b=g.apply(this,[]);return b.forEach(function(b){return b._pc=a}),b},Object.defineProperty(a.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function i(a){if(a.RTCPeerConnection){var b=a.RTCPeerConnection.prototype.getStats;a.RTCPeerConnection.prototype.getStats=function(){var a=this,c=Array.prototype.slice.call(arguments),d=c[0],e=c[1],f=c[2];if(arguments.length>0&&"function"==typeof d)return b.apply(this,arguments);if(0===b.length&&(0===arguments.length||"function"!=typeof d))return b.apply(this,[]);var g=function(a){var b={},c=a.result();return c.forEach(function(a){var c={id:a.id,timestamp:a.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[a.type]||a.type};a.names().forEach(function(b){c[b]=a.stat(b)}),b[c.id]=c}),b},h=function(a){return new Map(Object.keys(a).map(function(b){return[b,a[b]]}))};if(arguments.length>=2){var i=function(a){e(h(g(a)))};return b.apply(this,[i,d])}return new Promise(function(c,d){b.apply(a,[function(a){c(h(g(a)))},d])}).then(e,f)}}}function j(a){if("object"===("undefined"==typeof a?"undefined":o(a))&&a.RTCPeerConnection&&a.RTCRtpSender&&a.RTCRtpReceiver){if(!("getStats"in a.RTCRtpSender.prototype)){var b=a.RTCPeerConnection.prototype.getSenders;b&&(a.RTCPeerConnection.prototype.getSenders=function(){var a=this,c=b.apply(this,[]);return c.forEach(function(b){return b._pc=a}),c});var c=a.RTCPeerConnection.prototype.addTrack;c&&(a.RTCPeerConnection.prototype.addTrack=function(){var a=c.apply(this,arguments);return a._pc=this,a}),a.RTCRtpSender.prototype.getStats=function(){var a=this;return this._pc.getStats().then(function(b){return s.filterStats(b,a.track,!0)})}}if(!("getStats"in a.RTCRtpReceiver.prototype)){var d=a.RTCPeerConnection.prototype.getReceivers;d&&(a.RTCPeerConnection.prototype.getReceivers=function(){var a=this,b=d.apply(this,[]);return b.forEach(function(b){return b._pc=a}),b}),s.wrapPeerConnectionEvent(a,"track",function(a){return a.receiver._pc=a.srcElement,a}),a.RTCRtpReceiver.prototype.getStats=function(){var a=this;return this._pc.getStats().then(function(b){return s.filterStats(b,a.track,!1)})}}if("getStats"in a.RTCRtpSender.prototype&&"getStats"in a.RTCRtpReceiver.prototype){var e=a.RTCPeerConnection.prototype.getStats;a.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof a.MediaStreamTrack){var b=arguments[0],c=void 0,d=void 0,f=void 0;return this.getSenders().forEach(function(a){a.track===b&&(c?f=!0:c=a)}),this.getReceivers().forEach(function(a){return a.track===b&&(d?f=!0:d=a),a.track===b}),f||c&&d?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):c?c.getStats():d?d.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}}}function k(a){a.RTCPeerConnection.prototype.getLocalStreams=function(){var a=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(function(b){return a._shimmedLocalStreams[b][0]})};var b=a.RTCPeerConnection.prototype.addTrack;a.RTCPeerConnection.prototype.addTrack=function(a,c){if(!c)return b.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var d=b.apply(this,arguments);return this._shimmedLocalStreams[c.id]?-1===this._shimmedLocalStreams[c.id].indexOf(d)&&this._shimmedLocalStreams[c.id].push(d):this._shimmedLocalStreams[c.id]=[c,d],d};var c=a.RTCPeerConnection.prototype.addStream;a.RTCPeerConnection.prototype.addStream=function(a){var b=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},a.getTracks().forEach(function(a){var c=b.getSenders().find(function(b){return b.track===a});if(c)throw new DOMException("Track already exists.","InvalidAccessError")});var d=this.getSenders();c.apply(this,arguments);var e=this.getSenders().filter(function(a){return-1===d.indexOf(a)});this._shimmedLocalStreams[a.id]=[a].concat(e)};var d=a.RTCPeerConnection.prototype.removeStream;a.RTCPeerConnection.prototype.removeStream=function(a){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[a.id],d.apply(this,arguments)};var e=a.RTCPeerConnection.prototype.removeTrack;a.RTCPeerConnection.prototype.removeTrack=function(a){var b=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},a&&Object.keys(this._shimmedLocalStreams).forEach(function(c){var d=b._shimmedLocalStreams[c].indexOf(a);-1!==d&&b._shimmedLocalStreams[c].splice(d,1),1===b._shimmedLocalStreams[c].length&&delete b._shimmedLocalStreams[c]}),e.apply(this,arguments)}}function l(a){function b(a,b){var c=b.sdp;return Object.keys(a._reverseStreams||[]).forEach(function(b){var d=a._reverseStreams[b],e=a._streams[d.id];c=c.replace(new RegExp(e.id,"g"),d.id)}),new RTCSessionDescription({type:b.type,sdp:c})}function c(a,b){var c=b.sdp;return Object.keys(a._reverseStreams||[]).forEach(function(b){var d=a._reverseStreams[b],e=a._streams[d.id];c=c.replace(new RegExp(d.id,"g"),e.id)}),new RTCSessionDescription({type:b.type,sdp:c})}if(a.RTCPeerConnection){var d=s.detectBrowser(a);if(a.RTCPeerConnection.prototype.addTrack&&d.version>=65)return k(a);var f=a.RTCPeerConnection.prototype.getLocalStreams;a.RTCPeerConnection.prototype.getLocalStreams=function(){var a=this,b=f.apply(this);return this._reverseStreams=this._reverseStreams||{},b.map(function(b){return a._reverseStreams[b.id]})};var g=a.RTCPeerConnection.prototype.addStream;a.RTCPeerConnection.prototype.addStream=function(b){var c=this;if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},b.getTracks().forEach(function(a){var b=c.getSenders().find(function(b){return b.track===a});if(b)throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[b.id]){var d=new a.MediaStream(b.getTracks());this._streams[b.id]=d,this._reverseStreams[d.id]=b,b=d}g.apply(this,[b])};var h=a.RTCPeerConnection.prototype.removeStream;a.RTCPeerConnection.prototype.removeStream=function(a){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},h.apply(this,[this._streams[a.id]||a]),delete this._reverseStreams[this._streams[a.id]?this._streams[a.id].id:a.id],delete this._streams[a.id]},a.RTCPeerConnection.prototype.addTrack=function(b,c){var d=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var e=[].slice.call(arguments,1);if(1!==e.length||!e[0].getTracks().find(function(a){return a===b}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var f=this.getSenders().find(function(a){return a.track===b});if(f)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};var g=this._streams[c.id];if(g)g.addTrack(b),Promise.resolve().then(function(){d.dispatchEvent(new Event("negotiationneeded"))});else{var h=new a.MediaStream([b]);this._streams[c.id]=h,this._reverseStreams[h.id]=c,this.addStream(h)}return this.getSenders().find(function(a){return a.track===b})},["createOffer","createAnswer"].forEach(function(c){var d=a.RTCPeerConnection.prototype[c],f=e({},c,function(){var a=this,c=arguments,e=arguments.length&&"function"==typeof arguments[0];return e?d.apply(this,[function(d){var e=b(a,d);c[0].apply(null,[e])},function(a){c[1]&&c[1].apply(null,a)},arguments[2]]):d.apply(this,arguments).then(function(c){return b(a,c)})});a.RTCPeerConnection.prototype[c]=f[c]});var i=a.RTCPeerConnection.prototype.setLocalDescription;a.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=c(this,arguments[0]),i.apply(this,arguments)):i.apply(this,arguments)};var j=Object.getOwnPropertyDescriptor(a.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(a.RTCPeerConnection.prototype,"localDescription",{get:function(){var a=j.get.apply(this);return""===a.type?a:b(this,a)}}),a.RTCPeerConnection.prototype.removeTrack=function(a){var b=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!a._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");var c=a._pc===this;if(!c)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};var d=void 0;Object.keys(this._streams).forEach(function(c){var e=b._streams[c].getTracks().find(function(b){return a.track===b});e&&(d=b._streams[c])}),d&&(1===d.getTracks().length?this.removeStream(this._reverseStreams[d.id]):d.removeTrack(a.track),this.dispatchEvent(new Event("negotiationneeded")))}}}function m(a){var b=s.detectBrowser(a);if(!a.RTCPeerConnection&&a.webkitRTCPeerConnection&&(a.RTCPeerConnection=a.webkitRTCPeerConnection),a.RTCPeerConnection){b.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(b){var c=a.RTCPeerConnection.prototype[b],d=e({},b,function(){return arguments[0]=new("addIceCandidate"===b?a.RTCIceCandidate:a.RTCSessionDescription)(arguments[0]),c.apply(this,arguments)});a.RTCPeerConnection.prototype[b]=d[b]});var c=a.RTCPeerConnection.prototype.addIceCandidate;a.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?b.version<78&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():c.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}}function n(a){s.wrapPeerConnectionEvent(a,"negotiationneeded",function(a){var b=a.target;if("stable"===b.signalingState)return a})}Object.defineProperty(c,"__esModule",{value:!0}),c.shimGetDisplayMedia=c.shimGetUserMedia=void 0;var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},p=a("./getusermedia");Object.defineProperty(c,"shimGetUserMedia",{enumerable:!0,get:function(){return p.shimGetUserMedia}});var q=a("./getdisplaymedia");Object.defineProperty(c,"shimGetDisplayMedia",{enumerable:!0,get:function(){return q.shimGetDisplayMedia}}),c.shimMediaStream=f,c.shimOnTrack=g,c.shimGetSendersWithDtmf=h,c.shimGetStats=i,c.shimSenderReceiverGetStats=j,c.shimAddTrackRemoveTrackWithNative=k,c.shimAddTrackRemoveTrack=l,c.shimPeerConnection=m,c.fixNegotiationNeeded=n;var r=a("../utils.js"),s=d(r)},{"../utils.js":15,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(a,b,c){"use strict";function d(a,b){return a.navigator.mediaDevices&&"getDisplayMedia"in a.navigator.mediaDevices||!a.navigator.mediaDevices?void 0:"function"!=typeof b?void console.error("shimGetDisplayMedia: getSourceId argument is not a function"):void(a.navigator.mediaDevices.getDisplayMedia=function(c){return b(c).then(function(b){var d=c.video&&c.video.width,e=c.video&&c.video.height,f=c.video&&c.video.frameRate;return c.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:b,maxFrameRate:f||3}},d&&(c.video.mandatory.maxWidth=d),e&&(c.video.mandatory.maxHeight=e),a.navigator.mediaDevices.getUserMedia(c)})})}Object.defineProperty(c,"__esModule",{value:!0}),c.shimGetDisplayMedia=d},{}],5:[function(a,b,c){"use strict";function d(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b["default"]=a,b}function e(a){var b=a&&a.navigator;if(b.mediaDevices){var c=h.detectBrowser(a),d=function(a){if("object"!==("undefined"==typeof a?"undefined":f(a))||a.mandatory||a.optional)return a;var b={};return Object.keys(a).forEach(function(c){if("require"!==c&&"advanced"!==c&&"mediaSource"!==c){var d="object"===f(a[c])?a[c]:{ideal:a[c]};void 0!==d.exact&&"number"==typeof d.exact&&(d.min=d.max=d.exact);var e=function(a,b){return a?a+b.charAt(0).toUpperCase()+b.slice(1):"deviceId"===b?"sourceId":b};if(void 0!==d.ideal){b.optional=b.optional||[];var g={};"number"==typeof d.ideal?(g[e("min",c)]=d.ideal,b.optional.push(g),g={},g[e("max",c)]=d.ideal,b.optional.push(g)):(g[e("",c)]=d.ideal,b.optional.push(g))}void 0!==d.exact&&"number"!=typeof d.exact?(b.mandatory=b.mandatory||{},b.mandatory[e("",c)]=d.exact):["min","max"].forEach(function(a){void 0!==d[a]&&(b.mandatory=b.mandatory||{},b.mandatory[e(a,c)]=d[a])})}}),a.advanced&&(b.optional=(b.optional||[]).concat(a.advanced)),b},e=function(a,e){if(c.version>=61)return e(a);if(a=JSON.parse(JSON.stringify(a)),a&&"object"===f(a.audio)){var g=function(a,b,c){b in a&&!(c in a)&&(a[c]=a[b],delete a[b])};a=JSON.parse(JSON.stringify(a)),g(a.audio,"autoGainControl","googAutoGainControl"),g(a.audio,"noiseSuppression","googNoiseSuppression"),a.audio=d(a.audio)}if(a&&"object"===f(a.video)){var h=a.video.facingMode;h=h&&("object"===("undefined"==typeof h?"undefined":f(h))?h:{ideal:h});var j=c.version<66;if(h&&("user"===h.exact||"environment"===h.exact||"user"===h.ideal||"environment"===h.ideal)&&(!b.mediaDevices.getSupportedConstraints||!b.mediaDevices.getSupportedConstraints().facingMode||j)){delete a.video.facingMode;var k=void 0;if("environment"===h.exact||"environment"===h.ideal?k=["back","rear"]:("user"===h.exact||"user"===h.ideal)&&(k=["front"]),k)return b.mediaDevices.enumerateDevices().then(function(b){b=b.filter(function(a){return"videoinput"===a.kind});var c=b.find(function(a){return k.some(function(b){return a.label.toLowerCase().includes(b)})});return!c&&b.length&&k.includes("back")&&(c=b[b.length-1]),c&&(a.video.deviceId=h.exact?{exact:c.deviceId}:{ideal:c.deviceId}),a.video=d(a.video),i("chrome: "+JSON.stringify(a)),e(a)})}a.video=d(a.video)}return i("chrome: "+JSON.stringify(a)),e(a)},g=function(a){return c.version>=64?a:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[a.name]||a.name,message:a.message,constraint:a.constraint||a.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},j=function(a,c,d){e(a,function(a){b.webkitGetUserMedia(a,c,function(a){d&&d(g(a))})})};if(b.getUserMedia=j.bind(b),b.mediaDevices.getUserMedia){var k=b.mediaDevices.getUserMedia.bind(b.mediaDevices);b.mediaDevices.getUserMedia=function(a){return e(a,function(a){return k(a).then(function(b){if(a.audio&&!b.getAudioTracks().length||a.video&&!b.getVideoTracks().length)throw b.getTracks().forEach(function(a){a.stop()}),new DOMException("","NotFoundError");return b},function(a){return Promise.reject(g(a))})})}}}}Object.defineProperty(c,"__esModule",{value:!0});var f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};c.shimGetUserMedia=e;var g=a("../utils.js"),h=d(g),i=h.log},{"../utils.js":15}],6:[function(a,b,c){"use strict";function d(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b["default"]=a,b}function e(a){return a&&a.__esModule?a:{"default":a}}function f(a){if(a.RTCIceCandidate&&!(a.RTCIceCandidate&&"foundation"in a.RTCIceCandidate.prototype)){var b=a.RTCIceCandidate;a.RTCIceCandidate=function(a){if("object"===("undefined"==typeof a?"undefined":k(a))&&a.candidate&&0===a.candidate.indexOf("a=")&&(a=JSON.parse(JSON.stringify(a)),a.candidate=a.candidate.substr(2)),a.candidate&&a.candidate.length){var c=new b(a),d=m["default"].parseCandidate(a.candidate),e=Object.assign(c,d);return e.toJSON=function(){return{candidate:e.candidate,sdpMid:e.sdpMid,sdpMLineIndex:e.sdpMLineIndex,usernameFragment:e.usernameFragment}},e}return new b(a)},a.RTCIceCandidate.prototype=b.prototype,o.wrapPeerConnectionEvent(a,"icecandidate",function(b){return b.candidate&&Object.defineProperty(b,"candidate",{value:new a.RTCIceCandidate(b.candidate),writable:"false"}),b})}}function g(a){if(a.RTCPeerConnection){var b=o.detectBrowser(a);"sctp"in a.RTCPeerConnection.prototype||Object.defineProperty(a.RTCPeerConnection.prototype,"sctp",{get:function(){return"undefined"==typeof this._sctp?null:this._sctp}});var c=function(a){if(!a||!a.sdp)return!1;var b=m["default"].splitSections(a.sdp);return b.shift(),b.some(function(a){var b=m["default"].parseMLine(a);return b&&"application"===b.kind&&-1!==b.protocol.indexOf("SCTP")})},d=function(a){var b=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===b||b.length<2)return-1;var c=parseInt(b[1],10);return c!==c?-1:c},e=function(a){var c=65536;return"firefox"===b.browser&&(c=b.version<57?-1===a?16384:2147483637:b.version<60?57===b.version?65535:65536:2147483637),c},f=function(a,c){var d=65536;"firefox"===b.browser&&57===b.version&&(d=65535);var e=m["default"].matchPrefix(a.sdp,"a=max-message-size:");return e.length>0?d=parseInt(e[0].substr(19),10):"firefox"===b.browser&&-1!==c&&(d=2147483637),d},g=a.RTCPeerConnection.prototype.setRemoteDescription;a.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===b.browser&&b.version>=76){var a=this.getConfiguration(),h=a.sdpSemantics;"plan-b"===h&&Object.defineProperty(this,"sctp",{get:function(){return"undefined"==typeof this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(c(arguments[0])){var i=d(arguments[0]),j=e(i),k=f(arguments[0],i),l=void 0;l=0===j&&0===k?Number.POSITIVE_INFINITY:0===j||0===k?Math.max(j,k):Math.min(j,k);var m={};Object.defineProperty(m,"maxMessageSize",{get:function(){return l}}),this._sctp=m}return g.apply(this,arguments)}}}function h(a){function b(a,b){var c=a.send;a.send=function(){var d=arguments[0],e=d.length||d.size||d.byteLength;if("open"===a.readyState&&b.sctp&&e>b.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+b.sctp.maxMessageSize+" bytes)");return c.apply(a,arguments)}}if(a.RTCPeerConnection&&"createDataChannel"in a.RTCPeerConnection.prototype){var c=a.RTCPeerConnection.prototype.createDataChannel;a.RTCPeerConnection.prototype.createDataChannel=function(){var a=c.apply(this,arguments);return b(a,this),a},o.wrapPeerConnectionEvent(a,"datachannel",function(a){return b(a.channel,a.target),a})}}function i(a){if(a.RTCPeerConnection&&!("connectionState"in a.RTCPeerConnection.prototype)){var b=a.RTCPeerConnection.prototype;Object.defineProperty(b,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(b,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(a){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),a&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=a)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(function(a){var c=b[a];b[a]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=function(a){var b=a.target;if(b._lastConnectionState!==b.connectionState){b._lastConnectionState=b.connectionState;var c=new Event("connectionstatechange",a);b.dispatchEvent(c)}return a},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),c.apply(this,arguments)}})}}function j(a){if(a.RTCPeerConnection){var b=o.detectBrowser(a);if(!("chrome"===b.browser&&b.version>=71)){var c=a.RTCPeerConnection.prototype.setRemoteDescription;a.RTCPeerConnection.prototype.setRemoteDescription=function(a){return a&&a.sdp&&-1!==a.sdp.indexOf("\na=extmap-allow-mixed")&&(a.sdp=a.sdp.split("\n").filter(function(a){return"a=extmap-allow-mixed"!==a.trim()}).join("\n")),c.apply(this,arguments)}}}}Object.defineProperty(c,"__esModule",{value:!0});var k="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};c.shimRTCIceCandidate=f,c.shimMaxMessageSize=g,c.shimSendThrowTypeError=h,c.shimConnectionState=i,c.removeAllowExtmapMixed=j;var l=a("sdp"),m=e(l),n=a("./utils"),o=d(n)},{"./utils":15,sdp:17}],7:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}function e(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b["default"]=a,b}function f(a){var b=k.detectBrowser(a);if(a.RTCIceGatherer&&(a.RTCIceCandidate||(a.RTCIceCandidate=function(a){return a}),a.RTCSessionDescription||(a.RTCSessionDescription=function(a){return a}),b.version<15025)){var c=Object.getOwnPropertyDescriptor(a.MediaStreamTrack.prototype,"enabled");Object.defineProperty(a.MediaStreamTrack.prototype,"enabled",{set:function(a){c.set.call(this,a);var b=new Event("enabled");b.enabled=a,this.dispatchEvent(b)}})}!a.RTCRtpSender||"dtmf"in a.RTCRtpSender.prototype||Object.defineProperty(a.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new a.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),a.RTCDtmfSender&&!a.RTCDTMFSender&&(a.RTCDTMFSender=a.RTCDtmfSender);var d=(0,n["default"])(a,b.version);a.RTCPeerConnection=function(a){return a&&a.iceServers&&(a.iceServers=(0,l.filterIceServers)(a.iceServers,b.version),k.log("ICE servers after filtering:",a.iceServers)),
new d(a)},a.RTCPeerConnection.prototype=d.prototype}function g(a){!a.RTCRtpSender||"replaceTrack"in a.RTCRtpSender.prototype||(a.RTCRtpSender.prototype.replaceTrack=a.RTCRtpSender.prototype.setTrack)}Object.defineProperty(c,"__esModule",{value:!0}),c.shimGetDisplayMedia=c.shimGetUserMedia=void 0;var h=a("./getusermedia");Object.defineProperty(c,"shimGetUserMedia",{enumerable:!0,get:function(){return h.shimGetUserMedia}});var i=a("./getdisplaymedia");Object.defineProperty(c,"shimGetDisplayMedia",{enumerable:!0,get:function(){return i.shimGetDisplayMedia}}),c.shimPeerConnection=f,c.shimReplaceTrack=g;var j=a("../utils"),k=e(j),l=a("./filtericeservers"),m=a("rtcpeerconnection-shim"),n=d(m)},{"../utils":15,"./filtericeservers":8,"./getdisplaymedia":9,"./getusermedia":10,"rtcpeerconnection-shim":16}],8:[function(a,b,c){"use strict";function d(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b["default"]=a,b}function e(a,b){var c=!1;return a=JSON.parse(JSON.stringify(a)),a.filter(function(a){if(a&&(a.urls||a.url)){var b=a.urls||a.url;a.url&&!a.urls&&g.deprecated("RTCIceServer.url","RTCIceServer.urls");var d="string"==typeof b;return d&&(b=[b]),b=b.filter(function(a){if(0===a.indexOf("stun:"))return!1;var b=a.startsWith("turn")&&!a.startsWith("turn:[")&&a.includes("transport=udp");return b&&!c?(c=!0,!0):b&&!c}),delete a.url,a.urls=d?b[0]:b,!!b.length}})}Object.defineProperty(c,"__esModule",{value:!0}),c.filterIceServers=e;var f=a("../utils"),g=d(f)},{"../utils":15}],9:[function(a,b,c){"use strict";function d(a){"getDisplayMedia"in a.navigator&&a.navigator.mediaDevices&&(a.navigator.mediaDevices&&"getDisplayMedia"in a.navigator.mediaDevices||(a.navigator.mediaDevices.getDisplayMedia=a.navigator.getDisplayMedia.bind(a.navigator)))}Object.defineProperty(c,"__esModule",{value:!0}),c.shimGetDisplayMedia=d},{}],10:[function(a,b,c){"use strict";function d(a){var b=a&&a.navigator,c=function(a){return{name:{PermissionDeniedError:"NotAllowedError"}[a.name]||a.name,message:a.message,constraint:a.constraint,toString:function(){return this.name}}},d=b.mediaDevices.getUserMedia.bind(b.mediaDevices);b.mediaDevices.getUserMedia=function(a){return d(a)["catch"](function(a){return Promise.reject(c(a))})}}Object.defineProperty(c,"__esModule",{value:!0}),c.shimGetUserMedia=d},{}],11:[function(a,b,c){"use strict";function d(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b["default"]=a,b}function e(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function f(a){"object"===("undefined"==typeof a?"undefined":l(a))&&a.RTCTrackEvent&&"receiver"in a.RTCTrackEvent.prototype&&!("transceiver"in a.RTCTrackEvent.prototype)&&Object.defineProperty(a.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})}function g(a){var b=p.detectBrowser(a);if("object"===("undefined"==typeof a?"undefined":l(a))&&(a.RTCPeerConnection||a.mozRTCPeerConnection)){!a.RTCPeerConnection&&a.mozRTCPeerConnection&&(a.RTCPeerConnection=a.mozRTCPeerConnection),b.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(b){var c=a.RTCPeerConnection.prototype[b],d=e({},b,function(){return arguments[0]=new("addIceCandidate"===b?a.RTCIceCandidate:a.RTCSessionDescription)(arguments[0]),c.apply(this,arguments)});a.RTCPeerConnection.prototype[b]=d[b]});var c=a.RTCPeerConnection.prototype.addIceCandidate;a.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?b.version<68&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():c.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var d={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},f=a.RTCPeerConnection.prototype.getStats;a.RTCPeerConnection.prototype.getStats=function(){var a=Array.prototype.slice.call(arguments),c=a[0],e=a[1],g=a[2];return f.apply(this,[c||null]).then(function(a){if(b.version<53&&!e)try{a.forEach(function(a){a.type=d[a.type]||a.type})}catch(c){if("TypeError"!==c.name)throw c;a.forEach(function(b,c){a.set(c,Object.assign({},b,{type:d[b.type]||b.type}))})}return a}).then(e,g)}}}function h(a){if("object"===("undefined"==typeof a?"undefined":l(a))&&a.RTCPeerConnection&&a.RTCRtpSender&&!(a.RTCRtpSender&&"getStats"in a.RTCRtpSender.prototype)){var b=a.RTCPeerConnection.prototype.getSenders;b&&(a.RTCPeerConnection.prototype.getSenders=function(){var a=this,c=b.apply(this,[]);return c.forEach(function(b){return b._pc=a}),c});var c=a.RTCPeerConnection.prototype.addTrack;c&&(a.RTCPeerConnection.prototype.addTrack=function(){var a=c.apply(this,arguments);return a._pc=this,a}),a.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}}function i(a){if("object"===("undefined"==typeof a?"undefined":l(a))&&a.RTCPeerConnection&&a.RTCRtpSender&&!(a.RTCRtpSender&&"getStats"in a.RTCRtpReceiver.prototype)){var b=a.RTCPeerConnection.prototype.getReceivers;b&&(a.RTCPeerConnection.prototype.getReceivers=function(){var a=this,c=b.apply(this,[]);return c.forEach(function(b){return b._pc=a}),c}),p.wrapPeerConnectionEvent(a,"track",function(a){return a.receiver._pc=a.srcElement,a}),a.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}}function j(a){!a.RTCPeerConnection||"removeStream"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.removeStream=function(a){var b=this;p.deprecated("removeStream","removeTrack"),this.getSenders().forEach(function(c){c.track&&a.getTracks().includes(c.track)&&b.removeTrack(c)})})}function k(a){a.DataChannel&&!a.RTCDataChannel&&(a.RTCDataChannel=a.DataChannel)}Object.defineProperty(c,"__esModule",{value:!0}),c.shimGetDisplayMedia=c.shimGetUserMedia=void 0;var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},m=a("./getusermedia");Object.defineProperty(c,"shimGetUserMedia",{enumerable:!0,get:function(){return m.shimGetUserMedia}});var n=a("./getdisplaymedia");Object.defineProperty(c,"shimGetDisplayMedia",{enumerable:!0,get:function(){return n.shimGetDisplayMedia}}),c.shimOnTrack=f,c.shimPeerConnection=g,c.shimSenderGetStats=h,c.shimReceiverGetStats=i,c.shimRemoveStream=j,c.shimRTCDataChannel=k;var o=a("../utils"),p=d(o)},{"../utils":15,"./getdisplaymedia":12,"./getusermedia":13}],12:[function(a,b,c){"use strict";function d(a,b){a.navigator.mediaDevices&&"getDisplayMedia"in a.navigator.mediaDevices||a.navigator.mediaDevices&&(a.navigator.mediaDevices.getDisplayMedia=function(c){if(!c||!c.video){var d=new DOMException("getDisplayMedia without video constraints is undefined");return d.name="NotFoundError",d.code=8,Promise.reject(d)}return c.video===!0?c.video={mediaSource:b}:c.video.mediaSource=b,a.navigator.mediaDevices.getUserMedia(c)})}Object.defineProperty(c,"__esModule",{value:!0}),c.shimGetDisplayMedia=d},{}],13:[function(a,b,c){"use strict";function d(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b["default"]=a,b}function e(a){var b=h.detectBrowser(a),c=a&&a.navigator,d=a&&a.MediaStreamTrack;if(c.getUserMedia=function(a,b,d){h.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),c.mediaDevices.getUserMedia(a).then(b,d)},!(b.version>55&&"autoGainControl"in c.mediaDevices.getSupportedConstraints())){var e=function(a,b,c){b in a&&!(c in a)&&(a[c]=a[b],delete a[b])},g=c.mediaDevices.getUserMedia.bind(c.mediaDevices);if(c.mediaDevices.getUserMedia=function(a){return"object"===("undefined"==typeof a?"undefined":f(a))&&"object"===f(a.audio)&&(a=JSON.parse(JSON.stringify(a)),e(a.audio,"autoGainControl","mozAutoGainControl"),e(a.audio,"noiseSuppression","mozNoiseSuppression")),g(a)},d&&d.prototype.getSettings){var i=d.prototype.getSettings;d.prototype.getSettings=function(){var a=i.apply(this,arguments);return e(a,"mozAutoGainControl","autoGainControl"),e(a,"mozNoiseSuppression","noiseSuppression"),a}}if(d&&d.prototype.applyConstraints){var j=d.prototype.applyConstraints;d.prototype.applyConstraints=function(a){return"audio"===this.kind&&"object"===("undefined"==typeof a?"undefined":f(a))&&(a=JSON.parse(JSON.stringify(a)),e(a,"autoGainControl","mozAutoGainControl"),e(a,"noiseSuppression","mozNoiseSuppression")),j.apply(this,[a])}}}}Object.defineProperty(c,"__esModule",{value:!0});var f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};c.shimGetUserMedia=e;var g=a("../utils"),h=d(g)},{"../utils":15}],14:[function(a,b,c){"use strict";function d(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);return b["default"]=a,b}function e(a){if("object"===("undefined"==typeof a?"undefined":m(a))&&a.RTCPeerConnection){if("getLocalStreams"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in a.RTCPeerConnection.prototype)){var b=a.RTCPeerConnection.prototype.addTrack;a.RTCPeerConnection.prototype.addStream=function(a){var c=this;this._localStreams||(this._localStreams=[]),this._localStreams.includes(a)||this._localStreams.push(a),a.getAudioTracks().forEach(function(d){return b.call(c,d,a)}),a.getVideoTracks().forEach(function(d){return b.call(c,d,a)})},a.RTCPeerConnection.prototype.addTrack=function(a,c){return c&&(this._localStreams?this._localStreams.includes(c)||this._localStreams.push(c):this._localStreams=[c]),b.call(this,a,c)}}"removeStream"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.removeStream=function(a){var b=this;this._localStreams||(this._localStreams=[]);var c=this._localStreams.indexOf(a);if(-1!==c){this._localStreams.splice(c,1);var d=a.getTracks();this.getSenders().forEach(function(a){d.includes(a.track)&&b.removeTrack(a)})}})}}function f(a){if("object"===("undefined"==typeof a?"undefined":m(a))&&a.RTCPeerConnection&&("getRemoteStreams"in a.RTCPeerConnection.prototype||(a.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in a.RTCPeerConnection.prototype))){Object.defineProperty(a.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(a){var b=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=a),this.addEventListener("track",this._onaddstreampoly=function(a){a.streams.forEach(function(a){if(b._remoteStreams||(b._remoteStreams=[]),!b._remoteStreams.includes(a)){b._remoteStreams.push(a);var c=new Event("addstream");c.stream=a,b.dispatchEvent(c)}})})}});var b=a.RTCPeerConnection.prototype.setRemoteDescription;a.RTCPeerConnection.prototype.setRemoteDescription=function(){var a=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(b){b.streams.forEach(function(b){if(a._remoteStreams||(a._remoteStreams=[]),!(a._remoteStreams.indexOf(b)>=0)){a._remoteStreams.push(b);var c=new Event("addstream");c.stream=b,a.dispatchEvent(c)}})}),b.apply(a,arguments)}}}function g(a){if("object"===("undefined"==typeof a?"undefined":m(a))&&a.RTCPeerConnection){var b=a.RTCPeerConnection.prototype,c=b.createOffer,d=b.createAnswer,e=b.setLocalDescription,f=b.setRemoteDescription,g=b.addIceCandidate;b.createOffer=function(a,b){var d=arguments.length>=2?arguments[2]:arguments[0],e=c.apply(this,[d]);return b?(e.then(a,b),Promise.resolve()):e},b.createAnswer=function(a,b){var c=arguments.length>=2?arguments[2]:arguments[0],e=d.apply(this,[c]);return b?(e.then(a,b),Promise.resolve()):e};var h=function(a,b,c){var d=e.apply(this,[a]);return c?(d.then(b,c),Promise.resolve()):d};b.setLocalDescription=h,h=function(a,b,c){var d=f.apply(this,[a]);return c?(d.then(b,c),Promise.resolve()):d},b.setRemoteDescription=h,h=function(a,b,c){var d=g.apply(this,[a]);return c?(d.then(b,c),Promise.resolve()):d},b.addIceCandidate=h}}function h(a){var b=a&&a.navigator;if(b.mediaDevices&&b.mediaDevices.getUserMedia){var c=b.mediaDevices,d=c.getUserMedia.bind(c);b.mediaDevices.getUserMedia=function(a){return d(i(a))}}!b.getUserMedia&&b.mediaDevices&&b.mediaDevices.getUserMedia&&(b.getUserMedia=function(a,c,d){b.mediaDevices.getUserMedia(a).then(c,d)}.bind(b))}function i(a){return a&&void 0!==a.video?Object.assign({},a,{video:o.compactObject(a.video)}):a}function j(a){var b=a.RTCPeerConnection;a.RTCPeerConnection=function(a,c){if(a&&a.iceServers){for(var d=[],e=0;e<a.iceServers.length;e++){var f=a.iceServers[e];!f.hasOwnProperty("urls")&&f.hasOwnProperty("url")?(o.deprecated("RTCIceServer.url","RTCIceServer.urls"),f=JSON.parse(JSON.stringify(f)),f.urls=f.url,delete f.url,d.push(f)):d.push(a.iceServers[e])}a.iceServers=d}return new b(a,c)},a.RTCPeerConnection.prototype=b.prototype,"generateCertificate"in a.RTCPeerConnection&&Object.defineProperty(a.RTCPeerConnection,"generateCertificate",{get:function(){return b.generateCertificate}})}function k(a){"object"===("undefined"==typeof a?"undefined":m(a))&&a.RTCPeerConnection&&"receiver"in a.RTCTrackEvent.prototype&&!a.RTCTransceiver&&Object.defineProperty(a.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})}function l(a){var b=a.RTCPeerConnection.prototype.createOffer;a.RTCPeerConnection.prototype.createOffer=function(a){if(a){"undefined"!=typeof a.offerToReceiveAudio&&(a.offerToReceiveAudio=!!a.offerToReceiveAudio);var c=this.getTransceivers().find(function(a){return"audio"===a.receiver.track.kind});a.offerToReceiveAudio===!1&&c?"sendrecv"===c.direction?c.setDirection?c.setDirection("sendonly"):c.direction="sendonly":"recvonly"===c.direction&&(c.setDirection?c.setDirection("inactive"):c.direction="inactive"):a.offerToReceiveAudio!==!0||c||this.addTransceiver("audio"),"undefined"!=typeof a.offerToReceiveVideo&&(a.offerToReceiveVideo=!!a.offerToReceiveVideo);var d=this.getTransceivers().find(function(a){return"video"===a.receiver.track.kind});a.offerToReceiveVideo===!1&&d?"sendrecv"===d.direction?d.setDirection?d.setDirection("sendonly"):d.direction="sendonly":"recvonly"===d.direction&&(d.setDirection?d.setDirection("inactive"):d.direction="inactive"):a.offerToReceiveVideo!==!0||d||this.addTransceiver("video")}return b.apply(this,arguments)}}Object.defineProperty(c,"__esModule",{value:!0});var m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};c.shimLocalStreamsAPI=e,c.shimRemoteStreamsAPI=f,c.shimCallbacksAPI=g,c.shimGetUserMedia=h,c.shimConstraints=i,c.shimRTCIceServerUrls=j,c.shimTrackEventTransceiver=k,c.shimCreateOfferLegacy=l;var n=a("../utils"),o=d(n)},{"../utils":15}],15:[function(a,b,c){"use strict";function d(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function e(a,b,c){var d=a.match(b);return d&&d.length>=c&&parseInt(d[c],10)}function f(a,b,c){if(a.RTCPeerConnection){var d=a.RTCPeerConnection.prototype,e=d.addEventListener;d.addEventListener=function(a,d){if(a!==b)return e.apply(this,arguments);var f=function(a){var b=c(a);b&&d(b)};return this._eventMap=this._eventMap||{},this._eventMap[d]=f,e.apply(this,[a,f])};var f=d.removeEventListener;d.removeEventListener=function(a,c){if(a!==b||!this._eventMap||!this._eventMap[c])return f.apply(this,arguments);var d=this._eventMap[c];return delete this._eventMap[c],f.apply(this,[a,d])},Object.defineProperty(d,"on"+b,{get:function(){return this["_on"+b]},set:function(a){this["_on"+b]&&(this.removeEventListener(b,this["_on"+b]),delete this["_on"+b]),a&&this.addEventListener(b,this["_on"+b]=a)},enumerable:!0,configurable:!0})}}function g(a){return"boolean"!=typeof a?new Error("Argument type: "+("undefined"==typeof a?"undefined":p(a))+". Please use a boolean."):(q=a,a?"adapter.js logging disabled":"adapter.js logging enabled")}function h(a){return"boolean"!=typeof a?new Error("Argument type: "+("undefined"==typeof a?"undefined":p(a))+". Please use a boolean."):(r=!a,"adapter.js deprecation warnings "+(a?"disabled":"enabled"))}function i(){if("object"===("undefined"==typeof window?"undefined":p(window))){if(q)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function j(a,b){r&&console.warn(a+" is deprecated, please use "+b+" instead.")}function k(a){var b=a.navigator,c={browser:null,version:null};if("undefined"==typeof a||!a.navigator)return c.browser="Not a browser.",c;if(b.mozGetUserMedia)c.browser="firefox",c.version=e(b.userAgent,/Firefox\/(\d+)\./,1);else if(b.webkitGetUserMedia||a.isSecureContext===!1&&a.webkitRTCPeerConnection&&!a.RTCIceGatherer)c.browser="chrome",c.version=e(b.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(b.mediaDevices&&b.userAgent.match(/Edge\/(\d+).(\d+)$/))c.browser="edge",c.version=e(b.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!a.RTCPeerConnection||!b.userAgent.match(/AppleWebKit\/(\d+)\./))return c.browser="Not a supported browser.",c;c.browser="safari",c.version=e(b.userAgent,/AppleWebKit\/(\d+)\./,1),c.supportsUnifiedPlan=a.RTCRtpTransceiver&&"currentDirection"in a.RTCRtpTransceiver.prototype}return c}function l(a){return"[object Object]"===Object.prototype.toString.call(a)}function m(a){return l(a)?Object.keys(a).reduce(function(b,c){var e=l(a[c]),f=e?m(a[c]):a[c],g=e&&!Object.keys(f).length;return void 0===f||g?b:Object.assign(b,d({},c,f))},{}):a}function n(a,b,c){b&&!c.has(b.id)&&(c.set(b.id,b),Object.keys(b).forEach(function(d){d.endsWith("Id")?n(a,a.get(b[d]),c):d.endsWith("Ids")&&b[d].forEach(function(b){n(a,a.get(b),c)})}))}function o(a,b,c){var d=c?"outbound-rtp":"inbound-rtp",e=new Map;if(null===b)return e;var f=[];return a.forEach(function(a){"track"===a.type&&a.trackIdentifier===b.id&&f.push(a)}),f.forEach(function(b){a.forEach(function(c){c.type===d&&c.trackId===b.id&&n(a,c,e)})}),e}Object.defineProperty(c,"__esModule",{value:!0});var p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};c.extractVersion=e,c.wrapPeerConnectionEvent=f,c.disableLog=g,c.disableWarnings=h,c.log=i,c.deprecated=j,c.detectBrowser=k,c.compactObject=m,c.walkStats=n,c.filterStats=o;var q=!0,r=!0},{}],16:[function(a,b,c){"use strict";function d(a){return{inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[a.type]||a.type}function e(a,b,c,d,e){var f=k.writeRtpDescription(a.kind,b);if(f+=k.writeIceParameters(a.iceGatherer.getLocalParameters()),f+=k.writeDtlsParameters(a.dtlsTransport.getLocalParameters(),"offer"===c?"actpass":e||"active"),f+="a=mid:"+a.mid+"\r\n",f+=a.rtpSender&&a.rtpReceiver?"a=sendrecv\r\n":a.rtpSender?"a=sendonly\r\n":a.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",a.rtpSender){var g=a.rtpSender._initialTrackId||a.rtpSender.track.id;a.rtpSender._initialTrackId=g;var h="msid:"+(d?d.id:"-")+" "+g+"\r\n";f+="a="+h,f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" "+h,a.sendEncodingParameters[0].rtx&&(f+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" "+h,f+="a=ssrc-group:FID "+a.sendEncodingParameters[0].ssrc+" "+a.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" cname:"+k.localCName+"\r\n",a.rtpSender&&a.sendEncodingParameters[0].rtx&&(f+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" cname:"+k.localCName+"\r\n"),f}function f(a,b){var c=!1;return a=JSON.parse(JSON.stringify(a)),a.filter(function(a){if(a&&(a.urls||a.url)){var d=a.urls||a.url;a.url&&!a.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var e="string"==typeof d;return e&&(d=[d]),d=d.filter(function(a){var d=0===a.indexOf("turn:")&&-1!==a.indexOf("transport=udp")&&-1===a.indexOf("turn:[")&&!c;return d?(c=!0,!0):0===a.indexOf("stun:")&&b>=14393&&-1===a.indexOf("?transport=udp")}),delete a.url,a.urls=e?d[0]:d,!!d.length}})}function g(a,b){var c={codecs:[],headerExtensions:[],fecMechanisms:[]},d=function(a,b){a=parseInt(a,10);for(var c=0;c<b.length;c++)if(b[c].payloadType===a||b[c].preferredPayloadType===a)return b[c]},e=function(a,b,c,e){var f=d(a.parameters.apt,c),g=d(b.parameters.apt,e);return f&&g&&f.name.toLowerCase()===g.name.toLowerCase()};return a.codecs.forEach(function(d){for(var f=0;f<b.codecs.length;f++){var g=b.codecs[f];if(d.name.toLowerCase()===g.name.toLowerCase()&&d.clockRate===g.clockRate){if("rtx"===d.name.toLowerCase()&&d.parameters&&g.parameters.apt&&!e(d,g,a.codecs,b.codecs))continue;g=JSON.parse(JSON.stringify(g)),g.numChannels=Math.min(d.numChannels,g.numChannels),c.codecs.push(g),g.rtcpFeedback=g.rtcpFeedback.filter(function(a){for(var b=0;b<d.rtcpFeedback.length;b++)if(d.rtcpFeedback[b].type===a.type&&d.rtcpFeedback[b].parameter===a.parameter)return!0;return!1});break}}}),a.headerExtensions.forEach(function(a){for(var d=0;d<b.headerExtensions.length;d++){var e=b.headerExtensions[d];if(a.uri===e.uri){c.headerExtensions.push(e);break}}}),c}function h(a,b,c){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[b][a].indexOf(c)}function i(a,b){var c=a.getRemoteCandidates().find(function(a){return b.foundation===a.foundation&&b.ip===a.ip&&b.port===a.port&&b.priority===a.priority&&b.protocol===a.protocol&&b.type===a.type});return c||a.addRemoteCandidate(b),!c}function j(a,b){var c=new Error(b);return c.name=a,c.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[a],c}var k=a("sdp");b.exports=function(a,b){function c(b,c){c.addTrack(b),c.dispatchEvent(new a.MediaStreamTrackEvent("addtrack",{track:b}))}function l(b,c){c.removeTrack(b),c.dispatchEvent(new a.MediaStreamTrackEvent("removetrack",{track:b}))}function m(b,c,d,e){var f=new Event("track");f.track=c,f.receiver=d,f.transceiver={receiver:d},f.streams=e,a.setTimeout(function(){b._dispatchEvent("track",f)})}var n=function(c){var d=this,e=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(a){d[a]=e[a].bind(e)}),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",c=JSON.parse(JSON.stringify(c||{})),this.usingBundle="max-bundle"===c.bundlePolicy,"negotiate"===c.rtcpMuxPolicy)throw j("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(c.rtcpMuxPolicy||(c.rtcpMuxPolicy="require"),c.iceTransportPolicy){case"all":case"relay":break;default:c.iceTransportPolicy="all"}switch(c.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:c.bundlePolicy="balanced"}if(c.iceServers=f(c.iceServers||[],b),this._iceGatherers=[],c.iceCandidatePoolSize)for(var g=c.iceCandidatePoolSize;g>0;g--)this._iceGatherers.push(new a.RTCIceGatherer({iceServers:c.iceServers,gatherPolicy:c.iceTransportPolicy}));else c.iceCandidatePoolSize=0;this._config=c,this.transceivers=[],this._sdpSessionId=k.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(n.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(n.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),n.prototype.onicecandidate=null,n.prototype.onaddstream=null,n.prototype.ontrack=null,n.prototype.onremovestream=null,n.prototype.onsignalingstatechange=null,n.prototype.oniceconnectionstatechange=null,n.prototype.onconnectionstatechange=null,n.prototype.onicegatheringstatechange=null,n.prototype.onnegotiationneeded=null,n.prototype.ondatachannel=null,n.prototype._dispatchEvent=function(a,b){this._isClosed||(this.dispatchEvent(b),"function"==typeof this["on"+a]&&this["on"+a](b))},n.prototype._emitGatheringStateChange=function(){var a=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",a)},n.prototype.getConfiguration=function(){return this._config},n.prototype.getLocalStreams=function(){return this.localStreams},n.prototype.getRemoteStreams=function(){return this.remoteStreams},n.prototype._createTransceiver=function(a,b){var c=this.transceivers.length>0,d={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:a,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&c)d.iceTransport=this.transceivers[0].iceTransport,d.dtlsTransport=this.transceivers[0].dtlsTransport;else{var e=this._createIceAndDtlsTransports();d.iceTransport=e.iceTransport,d.dtlsTransport=e.dtlsTransport}return b||this.transceivers.push(d),d},n.prototype.addTrack=function(b,c){if(this._isClosed)throw j("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var d=this.transceivers.find(function(a){return a.track===b});if(d)throw j("InvalidAccessError","Track already exists.");for(var e,f=0;f<this.transceivers.length;f++)this.transceivers[f].track||this.transceivers[f].kind!==b.kind||(e=this.transceivers[f]);return e||(e=this._createTransceiver(b.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(c)&&this.localStreams.push(c),e.track=b,e.stream=c,e.rtpSender=new a.RTCRtpSender(b,e.dtlsTransport),e.rtpSender},n.prototype.addStream=function(a){var c=this;if(b>=15025)a.getTracks().forEach(function(b){c.addTrack(b,a)});else{var d=a.clone();a.getTracks().forEach(function(a,b){var c=d.getTracks()[b];a.addEventListener("enabled",function(a){c.enabled=a.enabled})}),d.getTracks().forEach(function(a){c.addTrack(a,d)})}},n.prototype.removeTrack=function(b){if(this._isClosed)throw j("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(b instanceof a.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var c=this.transceivers.find(function(a){return a.rtpSender===b});if(!c)throw j("InvalidAccessError","Sender was not created by this connection.");var d=c.stream;c.rtpSender.stop(),c.rtpSender=null,c.track=null,c.stream=null;var e=this.transceivers.map(function(a){return a.stream});-1===e.indexOf(d)&&this.localStreams.indexOf(d)>-1&&this.localStreams.splice(this.localStreams.indexOf(d),1),this._maybeFireNegotiationNeeded()},n.prototype.removeStream=function(a){var b=this;a.getTracks().forEach(function(a){var c=b.getSenders().find(function(b){return b.track===a});c&&b.removeTrack(c)})},n.prototype.getSenders=function(){return this.transceivers.filter(function(a){return!!a.rtpSender}).map(function(a){return a.rtpSender})},n.prototype.getReceivers=function(){return this.transceivers.filter(function(a){return!!a.rtpReceiver}).map(function(a){return a.rtpReceiver})},n.prototype._createIceGatherer=function(b,c){var d=this;if(c&&b>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var e=new a.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(e,"state",{value:"new",writable:!0}),this.transceivers[b].bufferedCandidateEvents=[],this.transceivers[b].bufferCandidates=function(a){var c=!a.candidate||0===Object.keys(a.candidate).length;e.state=c?"completed":"gathering",null!==d.transceivers[b].bufferedCandidateEvents&&d.transceivers[b].bufferedCandidateEvents.push(a)},e.addEventListener("localcandidate",this.transceivers[b].bufferCandidates),e},n.prototype._gather=function(b,c){var d=this,e=this.transceivers[c].iceGatherer;if(!e.onlocalcandidate){var f=this.transceivers[c].bufferedCandidateEvents;this.transceivers[c].bufferedCandidateEvents=null,e.removeEventListener("localcandidate",this.transceivers[c].bufferCandidates),e.onlocalcandidate=function(a){if(!(d.usingBundle&&c>0)){var f=new Event("icecandidate");f.candidate={sdpMid:b,sdpMLineIndex:c};var g=a.candidate,h=!g||0===Object.keys(g).length;if(h)("new"===e.state||"gathering"===e.state)&&(e.state="completed");else{"new"===e.state&&(e.state="gathering"),g.component=1,g.ufrag=e.getLocalParameters().usernameFragment;var i=k.writeCandidate(g);f.candidate=Object.assign(f.candidate,k.parseCandidate(i)),f.candidate.candidate=i,f.candidate.toJSON=function(){return{candidate:f.candidate.candidate,sdpMid:f.candidate.sdpMid,sdpMLineIndex:f.candidate.sdpMLineIndex,usernameFragment:f.candidate.usernameFragment}}}var j=k.getMediaSections(d._localDescription.sdp);h?j[f.candidate.sdpMLineIndex]+="a=end-of-candidates\r\n":j[f.candidate.sdpMLineIndex]+="a="+f.candidate.candidate+"\r\n",d._localDescription.sdp=k.getDescription(d._localDescription.sdp)+j.join("");var l=d.transceivers.every(function(a){return a.iceGatherer&&"completed"===a.iceGatherer.state});"gathering"!==d.iceGatheringState&&(d.iceGatheringState="gathering",d._emitGatheringStateChange()),h||d._dispatchEvent("icecandidate",f),l&&(d._dispatchEvent("icecandidate",new Event("icecandidate")),d.iceGatheringState="complete",d._emitGatheringStateChange())}},a.setTimeout(function(){f.forEach(function(a){e.onlocalcandidate(a)})},0)}},n.prototype._createIceAndDtlsTransports=function(){var b=this,c=new a.RTCIceTransport(null);c.onicestatechange=function(){b._updateIceConnectionState(),b._updateConnectionState()};var d=new a.RTCDtlsTransport(c);return d.ondtlsstatechange=function(){b._updateConnectionState()},d.onerror=function(){Object.defineProperty(d,"state",{value:"failed",writable:!0}),b._updateConnectionState()},{iceTransport:c,dtlsTransport:d}},n.prototype._disposeIceAndDtlsTransports=function(a){var b=this.transceivers[a].iceGatherer;b&&(delete b.onlocalcandidate,delete this.transceivers[a].iceGatherer);var c=this.transceivers[a].iceTransport;c&&(delete c.onicestatechange,delete this.transceivers[a].iceTransport);var d=this.transceivers[a].dtlsTransport;d&&(delete d.ondtlsstatechange,delete d.onerror,delete this.transceivers[a].dtlsTransport)},n.prototype._transceive=function(a,c,d){var e=g(a.localCapabilities,a.remoteCapabilities);c&&a.rtpSender&&(e.encodings=a.sendEncodingParameters,e.rtcp={cname:k.localCName,compound:a.rtcpParameters.compound},a.recvEncodingParameters.length&&(e.rtcp.ssrc=a.recvEncodingParameters[0].ssrc),a.rtpSender.send(e)),d&&a.rtpReceiver&&e.codecs.length>0&&("video"===a.kind&&a.recvEncodingParameters&&15019>b&&a.recvEncodingParameters.forEach(function(a){delete a.rtx}),a.recvEncodingParameters.length?e.encodings=a.recvEncodingParameters:e.encodings=[{}],e.rtcp={compound:a.rtcpParameters.compound},a.rtcpParameters.cname&&(e.rtcp.cname=a.rtcpParameters.cname),a.sendEncodingParameters.length&&(e.rtcp.ssrc=a.sendEncodingParameters[0].ssrc),a.rtpReceiver.receive(e))},n.prototype.setLocalDescription=function(a){var b=this;if(-1===["offer","answer"].indexOf(a.type))return Promise.reject(j("TypeError",'Unsupported type "'+a.type+'"'));
if(!h("setLocalDescription",a.type,b.signalingState)||b._isClosed)return Promise.reject(j("InvalidStateError","Can not set local "+a.type+" in state "+b.signalingState));var c,d;if("offer"===a.type)c=k.splitSections(a.sdp),d=c.shift(),c.forEach(function(a,c){var d=k.parseRtpParameters(a);b.transceivers[c].localCapabilities=d}),b.transceivers.forEach(function(a,c){b._gather(a.mid,c)});else if("answer"===a.type){c=k.splitSections(b._remoteDescription.sdp),d=c.shift();var e=k.matchPrefix(d,"a=ice-lite").length>0;c.forEach(function(a,c){var f=b.transceivers[c],h=f.iceGatherer,i=f.iceTransport,j=f.dtlsTransport,l=f.localCapabilities,m=f.remoteCapabilities,n=k.isRejected(a)&&0===k.matchPrefix(a,"a=bundle-only").length;if(!n&&!f.rejected){var o=k.getIceParameters(a,d),p=k.getDtlsParameters(a,d);e&&(p.role="server"),b.usingBundle&&0!==c||(b._gather(f.mid,c),"new"===i.state&&i.start(h,o,e?"controlling":"controlled"),"new"===j.state&&j.start(p));var q=g(l,m);b._transceive(f,q.codecs.length>0,!1)}})}return b._localDescription={type:a.type,sdp:a.sdp},"offer"===a.type?b._updateSignalingState("have-local-offer"):b._updateSignalingState("stable"),Promise.resolve()},n.prototype.setRemoteDescription=function(d){var e=this;if(-1===["offer","answer"].indexOf(d.type))return Promise.reject(j("TypeError",'Unsupported type "'+d.type+'"'));if(!h("setRemoteDescription",d.type,e.signalingState)||e._isClosed)return Promise.reject(j("InvalidStateError","Can not set remote "+d.type+" in state "+e.signalingState));var f={};e.remoteStreams.forEach(function(a){f[a.id]=a});var n=[],o=k.splitSections(d.sdp),p=o.shift(),q=k.matchPrefix(p,"a=ice-lite").length>0,r=k.matchPrefix(p,"a=group:BUNDLE ").length>0;e.usingBundle=r;var s=k.matchPrefix(p,"a=ice-options:")[0];return s?e.canTrickleIceCandidates=s.substr(14).split(" ").indexOf("trickle")>=0:e.canTrickleIceCandidates=!1,o.forEach(function(h,j){var m=k.splitLines(h),o=k.getKind(h),s=k.isRejected(h)&&0===k.matchPrefix(h,"a=bundle-only").length,t=m[0].substr(2).split(" ")[2],u=k.getDirection(h,p),v=k.parseMsid(h),w=k.getMid(h)||k.generateIdentifier();if(s||"application"===o&&("DTLS/SCTP"===t||"UDP/DTLS/SCTP"===t))return void(e.transceivers[j]={mid:w,kind:o,protocol:t,rejected:!0});!s&&e.transceivers[j]&&e.transceivers[j].rejected&&(e.transceivers[j]=e._createTransceiver(o,!0));var x,y,z,A,B,C,D,E,F,G,H,I=k.parseRtpParameters(h);s||(G=k.getIceParameters(h,p),H=k.getDtlsParameters(h,p),H.role="client"),D=k.parseRtpEncodingParameters(h);var J=k.parseRtcpParameters(h),K=k.matchPrefix(h,"a=end-of-candidates",p).length>0,L=k.matchPrefix(h,"a=candidate:").map(function(a){return k.parseCandidate(a)}).filter(function(a){return 1===a.component});if(("offer"===d.type||"answer"===d.type)&&!s&&r&&j>0&&e.transceivers[j]&&(e._disposeIceAndDtlsTransports(j),e.transceivers[j].iceGatherer=e.transceivers[0].iceGatherer,e.transceivers[j].iceTransport=e.transceivers[0].iceTransport,e.transceivers[j].dtlsTransport=e.transceivers[0].dtlsTransport,e.transceivers[j].rtpSender&&e.transceivers[j].rtpSender.setTransport(e.transceivers[0].dtlsTransport),e.transceivers[j].rtpReceiver&&e.transceivers[j].rtpReceiver.setTransport(e.transceivers[0].dtlsTransport)),"offer"!==d.type||s){if("answer"===d.type&&!s){x=e.transceivers[j],y=x.iceGatherer,z=x.iceTransport,A=x.dtlsTransport,B=x.rtpReceiver,C=x.sendEncodingParameters,E=x.localCapabilities,e.transceivers[j].recvEncodingParameters=D,e.transceivers[j].remoteCapabilities=I,e.transceivers[j].rtcpParameters=J,L.length&&"new"===z.state&&(!q&&!K||r&&0!==j?L.forEach(function(a){i(x.iceTransport,a)}):z.setRemoteCandidates(L)),r&&0!==j||("new"===z.state&&z.start(y,G,"controlling"),"new"===A.state&&A.start(H));var M=g(x.localCapabilities,x.remoteCapabilities),N=M.codecs.filter(function(a){return"rtx"===a.name.toLowerCase()}).length;!N&&x.sendEncodingParameters[0].rtx&&delete x.sendEncodingParameters[0].rtx,e._transceive(x,"sendrecv"===u||"recvonly"===u,"sendrecv"===u||"sendonly"===u),!B||"sendrecv"!==u&&"sendonly"!==u?delete x.rtpReceiver:(F=B.track,v?(f[v.stream]||(f[v.stream]=new a.MediaStream),c(F,f[v.stream]),n.push([F,B,f[v.stream]])):(f["default"]||(f["default"]=new a.MediaStream),c(F,f["default"]),n.push([F,B,f["default"]])))}}else{x=e.transceivers[j]||e._createTransceiver(o),x.mid=w,x.iceGatherer||(x.iceGatherer=e._createIceGatherer(j,r)),L.length&&"new"===x.iceTransport.state&&(!K||r&&0!==j?L.forEach(function(a){i(x.iceTransport,a)}):x.iceTransport.setRemoteCandidates(L)),E=a.RTCRtpReceiver.getCapabilities(o),15019>b&&(E.codecs=E.codecs.filter(function(a){return"rtx"!==a.name})),C=x.sendEncodingParameters||[{ssrc:1001*(2*j+2)}];var O=!1;if("sendrecv"===u||"sendonly"===u){if(O=!x.rtpReceiver,B=x.rtpReceiver||new a.RTCRtpReceiver(x.dtlsTransport,o),O){var P;F=B.track,v&&"-"===v.stream||(v?(f[v.stream]||(f[v.stream]=new a.MediaStream,Object.defineProperty(f[v.stream],"id",{get:function(){return v.stream}})),Object.defineProperty(F,"id",{get:function(){return v.track}}),P=f[v.stream]):(f["default"]||(f["default"]=new a.MediaStream),P=f["default"])),P&&(c(F,P),x.associatedRemoteMediaStreams.push(P)),n.push([F,B,P])}}else x.rtpReceiver&&x.rtpReceiver.track&&(x.associatedRemoteMediaStreams.forEach(function(a){var b=a.getTracks().find(function(a){return a.id===x.rtpReceiver.track.id});b&&l(b,a)}),x.associatedRemoteMediaStreams=[]);x.localCapabilities=E,x.remoteCapabilities=I,x.rtpReceiver=B,x.rtcpParameters=J,x.sendEncodingParameters=C,x.recvEncodingParameters=D,e._transceive(e.transceivers[j],!1,O)}}),void 0===e._dtlsRole&&(e._dtlsRole="offer"===d.type?"active":"passive"),e._remoteDescription={type:d.type,sdp:d.sdp},"offer"===d.type?e._updateSignalingState("have-remote-offer"):e._updateSignalingState("stable"),Object.keys(f).forEach(function(b){var c=f[b];if(c.getTracks().length){if(-1===e.remoteStreams.indexOf(c)){e.remoteStreams.push(c);var d=new Event("addstream");d.stream=c,a.setTimeout(function(){e._dispatchEvent("addstream",d)})}n.forEach(function(a){var b=a[0],d=a[1];c.id===a[2].id&&m(e,b,d,[c])})}}),n.forEach(function(a){a[2]||m(e,a[0],a[1],[])}),a.setTimeout(function(){e&&e.transceivers&&e.transceivers.forEach(function(a){a.iceTransport&&"new"===a.iceTransport.state&&a.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),a.iceTransport.addRemoteCandidate({}))})},4e3),Promise.resolve()},n.prototype.close=function(){this.transceivers.forEach(function(a){a.iceTransport&&a.iceTransport.stop(),a.dtlsTransport&&a.dtlsTransport.stop(),a.rtpSender&&a.rtpSender.stop(),a.rtpReceiver&&a.rtpReceiver.stop()}),this._isClosed=!0,this._updateSignalingState("closed")},n.prototype._updateSignalingState=function(a){this.signalingState=a;var b=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",b)},n.prototype._maybeFireNegotiationNeeded=function(){var b=this;"stable"===this.signalingState&&this.needNegotiation!==!0&&(this.needNegotiation=!0,a.setTimeout(function(){if(b.needNegotiation){b.needNegotiation=!1;var a=new Event("negotiationneeded");b._dispatchEvent("negotiationneeded",a)}},0))},n.prototype._updateIceConnectionState=function(){var a,b={"new":0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(a){a.iceTransport&&!a.rejected&&b[a.iceTransport.state]++}),a="new",b.failed>0?a="failed":b.checking>0?a="checking":b.disconnected>0?a="disconnected":b["new"]>0?a="new":b.connected>0?a="connected":b.completed>0&&(a="completed"),a!==this.iceConnectionState){this.iceConnectionState=a;var c=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",c)}},n.prototype._updateConnectionState=function(){var a,b={"new":0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach(function(a){a.iceTransport&&a.dtlsTransport&&!a.rejected&&(b[a.iceTransport.state]++,b[a.dtlsTransport.state]++)}),b.connected+=b.completed,a="new",b.failed>0?a="failed":b.connecting>0?a="connecting":b.disconnected>0?a="disconnected":b["new"]>0?a="new":b.connected>0&&(a="connected"),a!==this.connectionState){this.connectionState=a;var c=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",c)}},n.prototype.createOffer=function(){var c=this;if(c._isClosed)return Promise.reject(j("InvalidStateError","Can not call createOffer after close"));var d=c.transceivers.filter(function(a){return"audio"===a.kind}).length,f=c.transceivers.filter(function(a){return"video"===a.kind}).length,g=arguments[0];if(g){if(g.mandatory||g.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==g.offerToReceiveAudio&&(d=g.offerToReceiveAudio===!0?1:g.offerToReceiveAudio===!1?0:g.offerToReceiveAudio),void 0!==g.offerToReceiveVideo&&(f=g.offerToReceiveVideo===!0?1:g.offerToReceiveVideo===!1?0:g.offerToReceiveVideo)}for(c.transceivers.forEach(function(a){"audio"===a.kind?(d--,0>d&&(a.wantReceive=!1)):"video"===a.kind&&(f--,0>f&&(a.wantReceive=!1))});d>0||f>0;)d>0&&(c._createTransceiver("audio"),d--),f>0&&(c._createTransceiver("video"),f--);var h=k.writeSessionBoilerplate(c._sdpSessionId,c._sdpSessionVersion++);c.transceivers.forEach(function(d,e){var f=d.track,g=d.kind,h=d.mid||k.generateIdentifier();d.mid=h,d.iceGatherer||(d.iceGatherer=c._createIceGatherer(e,c.usingBundle));var i=a.RTCRtpSender.getCapabilities(g);15019>b&&(i.codecs=i.codecs.filter(function(a){return"rtx"!==a.name})),i.codecs.forEach(function(a){"H264"===a.name&&void 0===a.parameters["level-asymmetry-allowed"]&&(a.parameters["level-asymmetry-allowed"]="1"),d.remoteCapabilities&&d.remoteCapabilities.codecs&&d.remoteCapabilities.codecs.forEach(function(b){a.name.toLowerCase()===b.name.toLowerCase()&&a.clockRate===b.clockRate&&(a.preferredPayloadType=b.payloadType)})}),i.headerExtensions.forEach(function(a){var b=d.remoteCapabilities&&d.remoteCapabilities.headerExtensions||[];b.forEach(function(b){a.uri===b.uri&&(a.id=b.id)})});var j=d.sendEncodingParameters||[{ssrc:1001*(2*e+1)}];f&&b>=15019&&"video"===g&&!j[0].rtx&&(j[0].rtx={ssrc:j[0].ssrc+1}),d.wantReceive&&(d.rtpReceiver=new a.RTCRtpReceiver(d.dtlsTransport,g)),d.localCapabilities=i,d.sendEncodingParameters=j}),"max-compat"!==c._config.bundlePolicy&&(h+="a=group:BUNDLE "+c.transceivers.map(function(a){return a.mid}).join(" ")+"\r\n"),h+="a=ice-options:trickle\r\n",c.transceivers.forEach(function(a,b){h+=e(a,a.localCapabilities,"offer",a.stream,c._dtlsRole),h+="a=rtcp-rsize\r\n",!a.iceGatherer||"new"===c.iceGatheringState||0!==b&&c.usingBundle||(a.iceGatherer.getLocalCandidates().forEach(function(a){a.component=1,h+="a="+k.writeCandidate(a)+"\r\n"}),"completed"===a.iceGatherer.state&&(h+="a=end-of-candidates\r\n"))});var i=new a.RTCSessionDescription({type:"offer",sdp:h});return Promise.resolve(i)},n.prototype.createAnswer=function(){var c=this;if(c._isClosed)return Promise.reject(j("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==c.signalingState&&"have-local-pranswer"!==c.signalingState)return Promise.reject(j("InvalidStateError","Can not call createAnswer in signalingState "+c.signalingState));var d=k.writeSessionBoilerplate(c._sdpSessionId,c._sdpSessionVersion++);c.usingBundle&&(d+="a=group:BUNDLE "+c.transceivers.map(function(a){return a.mid}).join(" ")+"\r\n"),d+="a=ice-options:trickle\r\n";var f=k.getMediaSections(c._remoteDescription.sdp).length;c.transceivers.forEach(function(a,h){if(!(h+1>f)){if(a.rejected)return"application"===a.kind?d+="DTLS/SCTP"===a.protocol?"m=application 0 DTLS/SCTP 5000\r\n":"m=application 0 "+a.protocol+" webrtc-datachannel\r\n":"audio"===a.kind?d+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===a.kind&&(d+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(d+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+a.mid+"\r\n");if(a.stream){var i;"audio"===a.kind?i=a.stream.getAudioTracks()[0]:"video"===a.kind&&(i=a.stream.getVideoTracks()[0]),i&&b>=15019&&"video"===a.kind&&!a.sendEncodingParameters[0].rtx&&(a.sendEncodingParameters[0].rtx={ssrc:a.sendEncodingParameters[0].ssrc+1})}var j=g(a.localCapabilities,a.remoteCapabilities),k=j.codecs.filter(function(a){return"rtx"===a.name.toLowerCase()}).length;!k&&a.sendEncodingParameters[0].rtx&&delete a.sendEncodingParameters[0].rtx,d+=e(a,j,"answer",a.stream,c._dtlsRole),a.rtcpParameters&&a.rtcpParameters.reducedSize&&(d+="a=rtcp-rsize\r\n")}});var h=new a.RTCSessionDescription({type:"answer",sdp:d});return Promise.resolve(h)},n.prototype.addIceCandidate=function(a){var b,c=this;return a&&void 0===a.sdpMLineIndex&&!a.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(d,e){if(!c._remoteDescription)return e(j("InvalidStateError","Can not add ICE candidate without a remote description"));if(a&&""!==a.candidate){var f=a.sdpMLineIndex;if(a.sdpMid)for(var g=0;g<c.transceivers.length;g++)if(c.transceivers[g].mid===a.sdpMid){f=g;break}var h=c.transceivers[f];if(!h)return e(j("OperationError","Can not add ICE candidate"));if(h.rejected)return d();var l=Object.keys(a.candidate).length>0?k.parseCandidate(a.candidate):{};if("tcp"===l.protocol&&(0===l.port||9===l.port))return d();if(l.component&&1!==l.component)return d();if((0===f||f>0&&h.iceTransport!==c.transceivers[0].iceTransport)&&!i(h.iceTransport,l))return e(j("OperationError","Can not add ICE candidate"));var m=a.candidate.trim();0===m.indexOf("a=")&&(m=m.substr(2)),b=k.getMediaSections(c._remoteDescription.sdp),b[f]+="a="+(l.type?m:"end-of-candidates")+"\r\n",c._remoteDescription.sdp=k.getDescription(c._remoteDescription.sdp)+b.join("")}else for(var n=0;n<c.transceivers.length&&(c.transceivers[n].rejected||(c.transceivers[n].iceTransport.addRemoteCandidate({}),b=k.getMediaSections(c._remoteDescription.sdp),b[n]+="a=end-of-candidates\r\n",c._remoteDescription.sdp=k.getDescription(c._remoteDescription.sdp)+b.join(""),!c.usingBundle));n++);d()})},n.prototype.getStats=function(b){if(b&&b instanceof a.MediaStreamTrack){var c=null;if(this.transceivers.forEach(function(a){a.rtpSender&&a.rtpSender.track===b?c=a.rtpSender:a.rtpReceiver&&a.rtpReceiver.track===b&&(c=a.rtpReceiver)}),!c)throw j("InvalidAccessError","Invalid selector.");return c.getStats()}var d=[];return this.transceivers.forEach(function(a){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(b){a[b]&&d.push(a[b].getStats())})}),Promise.all(d).then(function(a){var b=new Map;return a.forEach(function(a){a.forEach(function(a){b.set(a.id,a)})}),b})};var o=["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"];o.forEach(function(b){var c=a[b];if(c&&c.prototype&&c.prototype.getStats){var e=c.prototype.getStats;c.prototype.getStats=function(){return e.apply(this).then(function(a){var b=new Map;return Object.keys(a).forEach(function(c){a[c].type=d(a[c]),b.set(c,a[c])}),b})}}});var p=["createOffer","createAnswer"];return p.forEach(function(a){var b=n.prototype[a];n.prototype[a]=function(){var a=arguments;return"function"==typeof a[0]||"function"==typeof a[1]?b.apply(this,[arguments[2]]).then(function(b){"function"==typeof a[0]&&a[0].apply(null,[b])},function(b){"function"==typeof a[1]&&a[1].apply(null,[b])}):b.apply(this,arguments)}}),p=["setLocalDescription","setRemoteDescription","addIceCandidate"],p.forEach(function(a){var b=n.prototype[a];n.prototype[a]=function(){var a=arguments;return"function"==typeof a[1]||"function"==typeof a[2]?b.apply(this,arguments).then(function(){"function"==typeof a[1]&&a[1].apply(null)},function(b){"function"==typeof a[2]&&a[2].apply(null,[b])}):b.apply(this,arguments)}}),["getStats"].forEach(function(a){var b=n.prototype[a];n.prototype[a]=function(){var a=arguments;return"function"==typeof a[1]?b.apply(this,arguments).then(function(){"function"==typeof a[1]&&a[1].apply(null)}):b.apply(this,arguments)}}),n}},{sdp:17}],17:[function(a,b,c){"use strict";var d={};d.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},d.localCName=d.generateIdentifier(),d.splitLines=function(a){return a.trim().split("\n").map(function(a){return a.trim()})},d.splitSections=function(a){var b=a.split("\nm=");return b.map(function(a,b){return(b>0?"m="+a:a).trim()+"\r\n"})},d.getDescription=function(a){var b=d.splitSections(a);return b&&b[0]},d.getMediaSections=function(a){var b=d.splitSections(a);return b.shift(),b},d.matchPrefix=function(a,b){return d.splitLines(a).filter(function(a){return 0===a.indexOf(b)})},d.parseCandidate=function(a){var b;b=0===a.indexOf("a=candidate:")?a.substring(12).split(" "):a.substring(10).split(" ");for(var c={foundation:b[0],component:parseInt(b[1],10),protocol:b[2].toLowerCase(),priority:parseInt(b[3],10),ip:b[4],address:b[4],port:parseInt(b[5],10),type:b[7]},d=8;d<b.length;d+=2)switch(b[d]){case"raddr":c.relatedAddress=b[d+1];break;case"rport":c.relatedPort=parseInt(b[d+1],10);break;case"tcptype":c.tcpType=b[d+1];break;case"ufrag":c.ufrag=b[d+1],c.usernameFragment=b[d+1];break;default:c[b[d]]=b[d+1]}return c},d.writeCandidate=function(a){var b=[];b.push(a.foundation),b.push(a.component),b.push(a.protocol.toUpperCase()),b.push(a.priority),b.push(a.address||a.ip),b.push(a.port);var c=a.type;return b.push("typ"),b.push(c),"host"!==c&&a.relatedAddress&&a.relatedPort&&(b.push("raddr"),b.push(a.relatedAddress),b.push("rport"),b.push(a.relatedPort)),a.tcpType&&"tcp"===a.protocol.toLowerCase()&&(b.push("tcptype"),b.push(a.tcpType)),(a.usernameFragment||a.ufrag)&&(b.push("ufrag"),b.push(a.usernameFragment||a.ufrag)),"candidate:"+b.join(" ")},d.parseIceOptions=function(a){return a.substr(14).split(" ")},d.parseRtpMap=function(a){var b=a.substr(9).split(" "),c={payloadType:parseInt(b.shift(),10)};return b=b[0].split("/"),c.name=b[0],c.clockRate=parseInt(b[1],10),c.channels=3===b.length?parseInt(b[2],10):1,c.numChannels=c.channels,c},d.writeRtpMap=function(a){var b=a.payloadType;void 0!==a.preferredPayloadType&&(b=a.preferredPayloadType);var c=a.channels||a.numChannels||1;return"a=rtpmap:"+b+" "+a.name+"/"+a.clockRate+(1!==c?"/"+c:"")+"\r\n"},d.parseExtmap=function(a){var b=a.substr(9).split(" ");return{id:parseInt(b[0],10),direction:b[0].indexOf("/")>0?b[0].split("/")[1]:"sendrecv",uri:b[1]}},d.writeExtmap=function(a){return"a=extmap:"+(a.id||a.preferredId)+(a.direction&&"sendrecv"!==a.direction?"/"+a.direction:"")+" "+a.uri+"\r\n"},d.parseFmtp=function(a){for(var b,c={},d=a.substr(a.indexOf(" ")+1).split(";"),e=0;e<d.length;e++)b=d[e].trim().split("="),c[b[0].trim()]=b[1];return c},d.writeFmtp=function(a){var b="",c=a.payloadType;if(void 0!==a.preferredPayloadType&&(c=a.preferredPayloadType),a.parameters&&Object.keys(a.parameters).length){var d=[];Object.keys(a.parameters).forEach(function(b){a.parameters[b]?d.push(b+"="+a.parameters[b]):d.push(b)}),b+="a=fmtp:"+c+" "+d.join(";")+"\r\n"}return b},d.parseRtcpFb=function(a){var b=a.substr(a.indexOf(" ")+1).split(" ");return{type:b.shift(),parameter:b.join(" ")}},d.writeRtcpFb=function(a){var b="",c=a.payloadType;return void 0!==a.preferredPayloadType&&(c=a.preferredPayloadType),a.rtcpFeedback&&a.rtcpFeedback.length&&a.rtcpFeedback.forEach(function(a){b+="a=rtcp-fb:"+c+" "+a.type+(a.parameter&&a.parameter.length?" "+a.parameter:"")+"\r\n"}),b},d.parseSsrcMedia=function(a){var b=a.indexOf(" "),c={ssrc:parseInt(a.substr(7,b-7),10)},d=a.indexOf(":",b);return d>-1?(c.attribute=a.substr(b+1,d-b-1),c.value=a.substr(d+1)):c.attribute=a.substr(b+1),c},d.parseSsrcGroup=function(a){var b=a.substr(13).split(" ");return{semantics:b.shift(),ssrcs:b.map(function(a){return parseInt(a,10)})}},d.getMid=function(a){var b=d.matchPrefix(a,"a=mid:")[0];return b?b.substr(6):void 0},d.parseFingerprint=function(a){var b=a.substr(14).split(" ");return{algorithm:b[0].toLowerCase(),value:b[1]}},d.getDtlsParameters=function(a,b){var c=d.matchPrefix(a+b,"a=fingerprint:");return{role:"auto",fingerprints:c.map(d.parseFingerprint)}},d.writeDtlsParameters=function(a,b){var c="a=setup:"+b+"\r\n";return a.fingerprints.forEach(function(a){c+="a=fingerprint:"+a.algorithm+" "+a.value+"\r\n"}),c},d.getIceParameters=function(a,b){var c=d.splitLines(a);c=c.concat(d.splitLines(b));var e={usernameFragment:c.filter(function(a){return 0===a.indexOf("a=ice-ufrag:")})[0].substr(12),password:c.filter(function(a){return 0===a.indexOf("a=ice-pwd:")})[0].substr(10)};return e},d.writeIceParameters=function(a){return"a=ice-ufrag:"+a.usernameFragment+"\r\na=ice-pwd:"+a.password+"\r\n"},d.parseRtpParameters=function(a){for(var b={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},c=d.splitLines(a),e=c[0].split(" "),f=3;f<e.length;f++){var g=e[f],h=d.matchPrefix(a,"a=rtpmap:"+g+" ")[0];if(h){var i=d.parseRtpMap(h),j=d.matchPrefix(a,"a=fmtp:"+g+" ");switch(i.parameters=j.length?d.parseFmtp(j[0]):{},i.rtcpFeedback=d.matchPrefix(a,"a=rtcp-fb:"+g+" ").map(d.parseRtcpFb),b.codecs.push(i),i.name.toUpperCase()){case"RED":case"ULPFEC":b.fecMechanisms.push(i.name.toUpperCase())}}}return d.matchPrefix(a,"a=extmap:").forEach(function(a){b.headerExtensions.push(d.parseExtmap(a))}),b},d.writeRtpDescription=function(a,b){var c="";c+="m="+a+" ",c+=b.codecs.length>0?"9":"0",c+=" UDP/TLS/RTP/SAVPF ",c+=b.codecs.map(function(a){return void 0!==a.preferredPayloadType?a.preferredPayloadType:a.payloadType}).join(" ")+"\r\n",c+="c=IN IP4 0.0.0.0\r\n",c+="a=rtcp:9 IN IP4 0.0.0.0\r\n",b.codecs.forEach(function(a){c+=d.writeRtpMap(a),c+=d.writeFmtp(a),c+=d.writeRtcpFb(a)});var e=0;return b.codecs.forEach(function(a){a.maxptime>e&&(e=a.maxptime)}),e>0&&(c+="a=maxptime:"+e+"\r\n"),c+="a=rtcp-mux\r\n",b.headerExtensions&&b.headerExtensions.forEach(function(a){c+=d.writeExtmap(a)}),c},d.parseRtpEncodingParameters=function(a){var b,c=[],e=d.parseRtpParameters(a),f=-1!==e.fecMechanisms.indexOf("RED"),g=-1!==e.fecMechanisms.indexOf("ULPFEC"),h=d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute}),i=h.length>0&&h[0].ssrc,j=d.matchPrefix(a,"a=ssrc-group:FID").map(function(a){var b=a.substr(17).split(" ");return b.map(function(a){return parseInt(a,10)})});j.length>0&&j[0].length>1&&j[0][0]===i&&(b=j[0][1]),e.codecs.forEach(function(a){if("RTX"===a.name.toUpperCase()&&a.parameters.apt){var d={ssrc:i,codecPayloadType:parseInt(a.parameters.apt,10)};i&&b&&(d.rtx={ssrc:b}),c.push(d),f&&(d=JSON.parse(JSON.stringify(d)),d.fec={ssrc:i,mechanism:g?"red+ulpfec":"red"},c.push(d))}}),0===c.length&&i&&c.push({ssrc:i});var k=d.matchPrefix(a,"b=");return k.length&&(k=0===k[0].indexOf("b=TIAS:")?parseInt(k[0].substr(7),10):0===k[0].indexOf("b=AS:")?1e3*parseInt(k[0].substr(5),10)*.95-16e3:void 0,c.forEach(function(a){a.maxBitrate=k})),c},d.parseRtcpParameters=function(a){var b={},c=d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute})[0];c&&(b.cname=c.value,b.ssrc=c.ssrc);var e=d.matchPrefix(a,"a=rtcp-rsize");b.reducedSize=e.length>0,b.compound=0===e.length;var f=d.matchPrefix(a,"a=rtcp-mux");return b.mux=f.length>0,b},d.parseMsid=function(a){var b,c=d.matchPrefix(a,"a=msid:");if(1===c.length)return b=c[0].substr(7).split(" "),{stream:b[0],track:b[1]};var e=d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"msid"===a.attribute});return e.length>0?(b=e[0].value.split(" "),{stream:b[0],track:b[1]}):void 0},d.generateSessionId=function(){return Math.random().toString().substr(2,21)},d.writeSessionBoilerplate=function(a,b,c){var e,f=void 0!==b?b:2;e=a?a:d.generateSessionId();var g=c||"thisisadapterortc";return"v=0\r\no="+g+" "+e+" "+f+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},d.writeMediaSection=function(a,b,c,e){var f=d.writeRtpDescription(a.kind,b);if(f+=d.writeIceParameters(a.iceGatherer.getLocalParameters()),f+=d.writeDtlsParameters(a.dtlsTransport.getLocalParameters(),"offer"===c?"actpass":"active"),f+="a=mid:"+a.mid+"\r\n",f+=a.direction?"a="+a.direction+"\r\n":a.rtpSender&&a.rtpReceiver?"a=sendrecv\r\n":a.rtpSender?"a=sendonly\r\n":a.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",a.rtpSender){var g="msid:"+e.id+" "+a.rtpSender.track.id+"\r\n";f+="a="+g,f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" "+g,a.sendEncodingParameters[0].rtx&&(f+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" "+g,f+="a=ssrc-group:FID "+a.sendEncodingParameters[0].ssrc+" "+a.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return f+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" cname:"+d.localCName+"\r\n",a.rtpSender&&a.sendEncodingParameters[0].rtx&&(f+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" cname:"+d.localCName+"\r\n"),f},d.getDirection=function(a,b){for(var c=d.splitLines(a),e=0;e<c.length;e++)switch(c[e]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return c[e].substr(2)}return b?d.getDirection(b):"sendrecv"},d.getKind=function(a){var b=d.splitLines(a),c=b[0].split(" ");return c[0].substr(2)},d.isRejected=function(a){return"0"===a.split(" ",2)[1]},d.parseMLine=function(a){var b=d.splitLines(a),c=b[0].substr(2).split(" ");return{kind:c[0],port:parseInt(c[1],10),protocol:c[2],fmt:c.slice(3).join(" ")}},d.parseOLine=function(a){var b=d.matchPrefix(a,"o=")[0],c=b.substr(2).split(" ");return{username:c[0],sessionId:c[1],sessionVersion:parseInt(c[2],10),netType:c[3],addressType:c[4],address:c[5]}},d.isValidSDP=function(a){if("string"!=typeof a||0===a.length)return!1;for(var b=d.splitLines(a),c=0;c<b.length;c++)if(b[c].length<2||"="!==b[c].charAt(1))return!1;return!0},"object"==typeof b&&(b.exports=d)},{}]},{},[1])(1)}),!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b():"function"==typeof define&&define.amd?define(b):b()}(0,function(){"use strict";function a(a){var b=this.constructor;return this.then(function(c){return b.resolve(a()).then(function(){return c})},function(c){return b.resolve(a()).then(function(){return b.reject(c)})})}function b(){}function c(a){if(!(this instanceof c))throw new TypeError("Promises must be constructed via new");if("function"!=typeof a)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],h(a,this)}function d(a,b){for(;3===a._state;)a=a._value;0!==a._state?(a._handled=!0,c._immediateFn(function(){var c=1===a._state?b.onFulfilled:b.onRejected;if(null!==c){var d;try{d=c(a._value)}catch(g){return void f(b.promise,g)}e(b.promise,d)}else(1===a._state?e:f)(b.promise,a._value)})):a._deferreds.push(b)}function e(a,b){try{if(b===a)throw new TypeError("A promise cannot be resolved with itself.");if(b&&("object"==typeof b||"function"==typeof b)){var d=b.then;if(b instanceof c)return a._state=3,a._value=b,void g(a);if("function"==typeof d)return void h(function(a,b){return function(){a.apply(b,arguments)}}(d,b),a)}a._state=1,a._value=b,g(a)}catch(e){f(a,e)}}function f(a,b){a._state=2,a._value=b,g(a)}function g(a){2===a._state&&0===a._deferreds.length&&c._immediateFn(function(){a._handled||c._unhandledRejectionFn(a._value)});for(var b=0,e=a._deferreds.length;e>b;b++)d(a,a._deferreds[b]);a._deferreds=null}function h(a,b){var c=!1;try{a(function(a){c||(c=!0,e(b,a))},function(a){c||(c=!0,f(b,a))})}catch(d){if(c)return;c=!0,f(b,d)}}var i=setTimeout;c.prototype["catch"]=function(a){return this.then(null,a)},c.prototype.then=function(a,c){var e=new this.constructor(b);return d(this,new function(a,b,c){this.onFulfilled="function"==typeof a?a:null,this.onRejected="function"==typeof b?b:null,this.promise=c}(a,c,e)),e},c.prototype["finally"]=a,c.all=function(a){return new c(function(b,c){function d(a,g){try{if(g&&("object"==typeof g||"function"==typeof g)){var h=g.then;if("function"==typeof h)return void h.call(g,function(b){d(a,b)},c)}e[a]=g,0==--f&&b(e)}catch(i){c(i)}}if(!a||"undefined"==typeof a.length)throw new TypeError("Promise.all accepts an array");var e=Array.prototype.slice.call(a);if(0===e.length)return b([]);for(var f=e.length,g=0;e.length>g;g++)d(g,e[g])})},c.resolve=function(a){return a&&"object"==typeof a&&a.constructor===c?a:new c(function(b){b(a)})},c.reject=function(a){return new c(function(b,c){c(a)})},c.race=function(a){return new c(function(b,c){for(var d=0,e=a.length;e>d;d++)a[d].then(b,c)})},c._immediateFn="function"==typeof setImmediate&&function(a){setImmediate(a)}||function(a){i(a,0)},c._unhandledRejectionFn=function(a){void 0!==console&&console&&console.warn("Possible Unhandled Promise Rejection:",a)};var j=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw Error("unable to locate global object")}();"Promise"in j?j.Promise.prototype["finally"]||(j.Promise.prototype["finally"]=a):j.Promise=c}),function(a){function b(a,b,k){var l=0,m=[0],n="",o=null,n=k||"UTF8";if("UTF8"!==n&&"UTF16BE"!==n&&"UTF16LE"!==n)throw"encoding must be UTF8, UTF16BE, or UTF16LE";if("HEX"===b){if(0!==a.length%2)throw"srcString of HEX type must be in byte increments";o=d(a),l=o.binLen,m=o.value}else if("TEXT"===b||"ASCII"===b)o=c(a,n),l=o.binLen,m=o.value;else if("B64"===b)o=f(a),l=o.binLen,m=o.value;else{if("BYTES"!==b)throw"inputFormat must be HEX, TEXT, ASCII, B64, or BYTES";o=e(a),l=o.binLen,m=o.value}this.getHash=function(a,b,c,d){var e,f=null,k=m.slice(),n=l;if(3===arguments.length?"number"!=typeof c&&(d=c,c=1):2===arguments.length&&(c=1),c!==parseInt(c,10)||1>c)throw"numRounds must a integer >= 1";switch(b){case"HEX":f=g;break;case"B64":f=h;break;case"BYTES":f=i;break;default:throw"format must be HEX, B64, or BYTES"}if("SHA-224"===a)for(e=0;c>e;e+=1)k=u(k,n,a),n=224;else{if("SHA-256"!==a)throw"Chosen SHA variant is not supported";for(e=0;c>e;e+=1)k=u(k,n,a),n=256}return f(k,j(d))},this.getHMAC=function(a,b,k,o,p){var q,r,s,t,v=[],w=[];switch(q=null,o){case"HEX":o=g;break;case"B64":o=h;break;case"BYTES":o=i;break;default:throw"outputFormat must be HEX, B64, or BYTES"}if("SHA-224"===k)r=64,t=224;else{if("SHA-256"!==k)throw"Chosen SHA variant is not supported";r=64,t=256}if("HEX"===b)q=d(a),s=q.binLen,q=q.value;else if("TEXT"===b||"ASCII"===b)q=c(a,n),s=q.binLen,q=q.value;else if("B64"===b)q=f(a),s=q.binLen,q=q.value;else{if("BYTES"!==b)throw"inputFormat must be HEX, TEXT, ASCII, B64, or BYTES";q=e(a),s=q.binLen,q=q.value}if(a=8*r,b=r/4-1,s/8>r){for(q=u(q,s,k);q.length<=b;)q.push(0);q[b]&=4294967040}else if(r>s/8){for(;q.length<=b;)q.push(0);q[b]&=4294967040}for(r=0;b>=r;r+=1)v[r]=909522486^q[r],w[r]=1549556828^q[r];return k=u(w.concat(u(v.concat(m),a+l,k)),a+t,k),o(k,j(p))}}function c(a,b){var c,d,e,f,g=[],h=[],i=0;if("UTF8"===b)for(d=0;d<a.length;d+=1)for(c=a.charCodeAt(d),h=[],128>c?h.push(c):2048>c?(h.push(192|c>>>6),h.push(128|63&c)):55296>c||c>=57344?h.push(224|c>>>12,128|c>>>6&63,128|63&c):(d+=1,c=65536+((1023&c)<<10|1023&a.charCodeAt(d)),h.push(240|c>>>18,128|c>>>12&63,128|c>>>6&63,128|63&c)),e=0;e<h.length;e+=1){for(f=i>>>2;g.length<=f;)g.push(0);g[f]|=h[e]<<24-i%4*8,i+=1}else if("UTF16BE"===b||"UTF16LE"===b)for(d=0;d<a.length;d+=1){for(c=a.charCodeAt(d),"UTF16LE"===b&&(e=255&c,c=e<<8|c>>8),f=i>>>2;g.length<=f;)g.push(0);g[f]|=c<<16-i%4*8,i+=2}return{value:g,binLen:8*i}}function d(a){var b,c,d,e=[],f=a.length;if(0!==f%2)throw"String of HEX type must be in byte increments";for(b=0;f>b;b+=2){if(c=parseInt(a.substr(b,2),16),isNaN(c))throw"String of HEX type contains invalid characters";for(d=b>>>3;e.length<=d;)e.push(0);e[b>>>3]|=c<<24-b%8*4}return{value:e,binLen:4*f}}function e(a){var b,c,d,e=[];for(c=0;c<a.length;c+=1)b=a.charCodeAt(c),d=c>>>2,e.length<=d&&e.push(0),e[d]|=b<<24-c%4*8;return{value:e,binLen:8*a.length}}function f(a){var b,c,d,e,f,g=[],h=0;if(-1===a.search(/^[a-zA-Z0-9=+\/]+$/))throw"Invalid character in base-64 string";if(c=a.indexOf("="),a=a.replace(/\=/g,""),-1!==c&&c<a.length)throw"Invalid '=' found in base-64 string";for(c=0;c<a.length;c+=4){for(f=a.substr(c,4),d=e=0;d<f.length;d+=1)b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(f[d]),e|=b<<18-6*d;for(d=0;d<f.length-1;d+=1){
for(b=h>>>2;g.length<=b;)g.push(0);g[b]|=(e>>>16-8*d&255)<<24-h%4*8,h+=1}}return{value:g,binLen:8*h}}function g(a,b){var c,d,e="",f=4*a.length;for(c=0;f>c;c+=1)d=a[c>>>2]>>>8*(3-c%4),e+="0123456789abcdef".charAt(d>>>4&15)+"0123456789abcdef".charAt(15&d);return b.outputUpper?e.toUpperCase():e}function h(a,b){var c,d,e,f="",g=4*a.length;for(c=0;g>c;c+=3)for(e=c+1>>>2,d=a.length<=e?0:a[e],e=c+2>>>2,e=a.length<=e?0:a[e],e=(a[c>>>2]>>>8*(3-c%4)&255)<<16|(d>>>8*(3-(c+1)%4)&255)<<8|e>>>8*(3-(c+2)%4)&255,d=0;4>d;d+=1)f=8*c+6*d<=32*a.length?f+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>>6*(3-d)&63):f+b.b64Pad;return f}function i(a){var b,c,d="",e=4*a.length;for(b=0;e>b;b+=1)c=a[b>>>2]>>>8*(3-b%4)&255,d+=String.fromCharCode(c);return d}function j(a){var b={outputUpper:!1,b64Pad:"="};try{a.hasOwnProperty("outputUpper")&&(b.outputUpper=a.outputUpper),a.hasOwnProperty("b64Pad")&&(b.b64Pad=a.b64Pad)}catch(c){}if("boolean"!=typeof b.outputUpper)throw"Invalid outputUpper formatting option";if("string"!=typeof b.b64Pad)throw"Invalid b64Pad formatting option";return b}function k(a,b){return a>>>b|a<<32-b}function l(a,b,c){return a&b^~a&c}function m(a,b,c){return a&b^a&c^b&c}function n(a){return k(a,2)^k(a,13)^k(a,22)}function o(a){return k(a,6)^k(a,11)^k(a,25)}function p(a){return k(a,7)^k(a,18)^a>>>3}function q(a){return k(a,17)^k(a,19)^a>>>10}function r(a,b){var c=(65535&a)+(65535&b);return((a>>>16)+(b>>>16)+(c>>>16)&65535)<<16|65535&c}function s(a,b,c,d){var e=(65535&a)+(65535&b)+(65535&c)+(65535&d);return((a>>>16)+(b>>>16)+(c>>>16)+(d>>>16)+(e>>>16)&65535)<<16|65535&e}function t(a,b,c,d,e){var f=(65535&a)+(65535&b)+(65535&c)+(65535&d)+(65535&e);return((a>>>16)+(b>>>16)+(c>>>16)+(d>>>16)+(e>>>16)+(f>>>16)&65535)<<16|65535&f}function u(a,b,c){var d,e,f,g,h,i,j,k,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M=[],N=[1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298];if(v=[3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428],e=[1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225],"SHA-224"!==c&&"SHA-256"!==c)throw"Unexpected error in SHA-2 implementation";for(w=64,d=(b+65>>>9<<4)+15,z=16,A=1,K=Number,B=r,C=s,D=t,E=p,F=q,G=n,H=o,J=m,I=l,v="SHA-224"===c?v:e;a.length<=d;)a.push(0);for(a[b>>>5]|=128<<24-b%32,a[d]=b,L=a.length,x=0;L>x;x+=z){for(b=v[0],d=v[1],e=v[2],f=v[3],g=v[4],h=v[5],i=v[6],j=v[7],y=0;w>y;y+=1)16>y?(u=y*A+x,k=a.length<=u?0:a[u],u=a.length<=u+1?0:a[u+1],M[y]=new K(k,u)):M[y]=C(F(M[y-2]),M[y-7],E(M[y-15]),M[y-16]),k=D(j,H(g),I(g,h,i),N[y],M[y]),u=B(G(b),J(b,d,e)),j=i,i=h,h=g,g=B(f,k),f=e,e=d,d=b,b=B(k,u);v[0]=B(b,v[0]),v[1]=B(d,v[1]),v[2]=B(e,v[2]),v[3]=B(f,v[3]),v[4]=B(g,v[4]),v[5]=B(h,v[5]),v[6]=B(i,v[6]),v[7]=B(j,v[7])}if("SHA-224"===c)a=[v[0],v[1],v[2],v[3],v[4],v[5],v[6]];else{if("SHA-256"!==c)throw"Unexpected error in SHA-2 implementation";a=v}return a}"function"==typeof define&&define.amd?define(function(){return b}):"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports?module.exports=exports=b:exports=b:a.jsSHA=b}(this),!function(a,b){"object"==typeof exports&&"object"==typeof module?module.exports=b():"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?exports.Recorder=b():a.Recorder=b()}("undefined"!=typeof self?self:this,function(){return function(a){function b(d){if(c[d])return c[d].exports;var e=c[d]={i:d,l:!1,exports:{}};return a[d].call(e.exports,e,e.exports,b),e.l=!0,e.exports}var c={};return b.m=a,b.c=c,b.d=function(a,c,d){b.o(a,c)||Object.defineProperty(a,c,{configurable:!1,enumerable:!0,get:d})},b.n=function(a){var c=a&&a.__esModule?function(){return a["default"]}:function(){return a};return b.d(c,"a",c),c},b.o=function(a,b){return Object.prototype.hasOwnProperty.call(a,b)},b.p="",b(b.s=0)}([function(a,b,c){"use strict";(function(b){var c=b.AudioContext||b.webkitAudioContext,d=function(a){if(!d.isRecordingSupported())throw new Error("Recording is not supported in this browser");this.state="inactive",this.config=Object.assign({bufferLength:4096,encoderApplication:2049,encoderFrameSize:20,encoderPath:"encoderWorker.min.js",encoderSampleRate:48e3,leaveStreamOpen:!1,maxBuffersPerPage:40,mediaTrackConstraints:!0,monitorGain:0,numberOfChannels:1,recordingGain:1,resampleQuality:3,streamPages:!1,wavBitDepth:16},a),this.initWorker()};d.isRecordingSupported=function(){return c&&b.navigator&&b.navigator.mediaDevices&&b.navigator.mediaDevices.getUserMedia&&b.WebAssembly},d.prototype.clearStream=function(){this.stream&&(this.stream.getTracks?this.stream.getTracks().forEach(function(a){a.stop()}):this.stream.stop(),delete this.stream),this.audioContext&&(this.audioContext.close(),delete this.audioContext)},d.prototype.encodeBuffers=function(a){if("recording"===this.state){for(var b=[],c=0;c<a.numberOfChannels;c++)b[c]=a.getChannelData(c);this.encoder.postMessage({command:"encode",buffers:b})}},d.prototype.initAudioContext=function(a){return a&&a.context&&(this.audioContext=a.context),this.audioContext||(this.audioContext=new c),this.audioContext},d.prototype.initAudioGraph=function(){var a=this;this.encodeBuffers=function(){delete this.encodeBuffers},this.scriptProcessorNode=this.audioContext.createScriptProcessor(this.config.bufferLength,this.config.numberOfChannels,this.config.numberOfChannels),this.scriptProcessorNode.connect(this.audioContext.destination),this.scriptProcessorNode.onaudioprocess=function(b){a.encodeBuffers(b.inputBuffer)},this.monitorGainNode=this.audioContext.createGain(),this.setMonitorGain(this.config.monitorGain),this.monitorGainNode.connect(this.audioContext.destination),this.recordingGainNode=this.audioContext.createGain(),this.setRecordingGain(this.config.recordingGain),this.recordingGainNode.connect(this.scriptProcessorNode)},d.prototype.initSourceNode=function(a){var c=this;return a&&a.context?b.Promise.resolve(a):this.stream&&this.sourceNode?b.Promise.resolve(this.sourceNode):b.navigator.mediaDevices.getUserMedia({audio:this.config.mediaTrackConstraints}).then(function(a){return c.stream=a,c.audioContext.createMediaStreamSource(a)})},d.prototype.initWorker=function(){var a=this,c=function(b){a.streamPage(b.data)},d=function(b){a.storePage(b.data)};this.recordedPages=[],this.totalLength=0,this.encoder=new b.Worker(this.config.encoderPath),this.encoder.addEventListener("message",this.config.streamPages?c:d)},d.prototype.pause=function(){"recording"===this.state&&(this.state="paused",this.onpause())},d.prototype.resume=function(){"paused"===this.state&&(this.state="recording",this.onresume())},d.prototype.setRecordingGain=function(a){this.config.recordingGain=a,this.recordingGainNode&&this.audioContext&&this.recordingGainNode.gain.setTargetAtTime(a,this.audioContext.currentTime,.01)},d.prototype.setMonitorGain=function(a){this.config.monitorGain=a,this.monitorGainNode&&this.audioContext&&this.monitorGainNode.gain.setTargetAtTime(a,this.audioContext.currentTime,.01)},d.prototype.start=function(a){if("inactive"===this.state){var b=this;return this.initAudioContext(a),this.initAudioGraph(),this.initSourceNode(a).then(function(a){b.state="recording",b.encoder.postMessage(Object.assign({command:"init",originalSampleRate:b.audioContext.sampleRate,wavSampleRate:b.audioContext.sampleRate},b.config)),b.sourceNode=a,b.sourceNode.connect(b.monitorGainNode),b.sourceNode.connect(b.recordingGainNode),b.onstart()})}},d.prototype.stop=function(){"inactive"!==this.state&&(this.state="inactive",this.monitorGainNode.disconnect(),this.scriptProcessorNode.disconnect(),this.recordingGainNode.disconnect(),this.sourceNode.disconnect(),this.config.leaveStreamOpen||this.clearStream(),this.encoder.postMessage({command:"done"}))},d.prototype.storePage=function(a){if(null===a){var b=new Uint8Array(this.totalLength);this.recordedPages.reduce(function(a,c){return b.set(c,a),a+c.length},0),this.ondataavailable(b),this.initWorker(),this.onstop()}else this.recordedPages.push(a),this.totalLength+=a.length},d.prototype.streamPage=function(a){null===a?(this.initWorker(),this.onstop()):this.ondataavailable(a)},d.prototype.ondataavailable=function(){},d.prototype.onpause=function(){},d.prototype.onresume=function(){},d.prototype.onstart=function(){},d.prototype.onstop=function(){},a.exports=d}).call(b,c(1))},function(a,b){var c;c=function(){return this}();try{c=c||Function("return this")()||(0,eval)("this")}catch(a){"object"==typeof window&&(c=window)}a.exports=c}])});var _this4=void 0;!function(){Function.prototype.bind||(Function.prototype.bind=function(a){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var b=Array.prototype.slice.call(arguments,1),c=this,d=function(){},e=function(){return c.apply(this instanceof d&&a?this:a,b.concat(Array.prototype.slice.call(arguments)))};return d.prototype=this.prototype,e.prototype=new d,e}),String.prototype.startsWith||Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,configurable:!1,writable:!1,value:function(a,b){var c=b||0;return this.indexOf(a,c)===c}}),Object.keys||(Object.keys=function(){"use strict";var a=Object.prototype.hasOwnProperty,b=!{toString:null}.propertyIsEnumerable("toString"),c=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],d=c.length;return function(e){if("function"!=typeof e&&("object"!==_typeof2(e)||null===e))throw new TypeError("Object.keys called on non-object");var f,g,h=[];for(f in e)a.call(e,f)&&h.push(f);if(b)for(g=0;d>g;g++)a.call(e,c[g])&&h.push(c[g]);return h}}()),Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:function(a,b){"use strict";if(void 0===a||null===a)throw new TypeError("Cannot convert first argument to object");for(var c=Object(a),d=1;d<arguments.length;d++){var e=arguments[d];if(void 0!==e&&null!==e)for(var f=Object.keys(Object(e)),g=0,h=f.length;h>g;g++){var i=f[g],j=Object.getOwnPropertyDescriptor(e,i);void 0!==j&&j.enumerable&&(c[i]=e[i])}}return c}}),Element.prototype.matches||(Element.prototype.matches=Element.prototype.webkitMatchesSelector||Element.prototype.mozMatchesSelector||Element.prototype.msMatchesSelector||Element.prototype.oMatchesSelector),!document.contains&&document.documentElement&&"function"==typeof document.documentElement.contains&&(document.contains=function(){return document.documentElement.contains.apply(document.documentElement,arguments)})}();var WA=window.WebIM=window.WebIM||{},MESSENGER_ID=WA.msgrId="PUBLIC",RESTART_SESSION_INDEX=4,PUBLIC_BUILD_CONFIG={icq_specific:!0,title_key:"icq",product_name:"webIM",api_client:"icq",akes_dev_id:"ic1rtwz1s1Hj1O0r",root_css_class:"im-root_icq",theme_schema:"themes_default",jslog_name:"ICQLOG",radar_name:"wicq",api_version:"25",restart_session_index:"25_"+RESTART_SESSION_INDEX,disable_tracking:!1,disable_notification_text:!1,disable_secure_files:!1,disable_ptt_speech:!1,disable_snippet_preview_service:!1,disable_avatar_change:!1,disable_name_change:!1,disable_self_info_change:!1,disable_gdpr:!1,hide_all_policy_notes:!1,enable_otp_auth:!1,enable_email_mpop_auth:!1,disable_phone_signin:!1,disable_phone_attach:!1,disable_phone_switch:!1,disable_add_contact_by_phone:!1,disable_remove_user_button:!1,disable_password_recovery:!1,disable_session_list:!1,disable_webrtc_calls:!0,enable_account_delete_button:!0,enable_password_change:!1,disable_polls:!1,alt_recents_default_screen:!1,alternative_incoming_sound:!1,server_suggests_enabled:!0,smart_reply_enabled:!0,enable_smart_reply_text:!0,enable_smart_reply_stickers:!0},AGENT_BUILD_CONFIG={title_key:"agent",product_name:"agent",api_client:"agent",akes_dev_id:"ic1pzYNtEU6dDnEQ",root_css_class:"im-root_agent",theme_schema:"themes_agent",jslog_name:"WALOG",radar_name:"webim_agent",api_version:"25",restart_session_index:"25_"+RESTART_SESSION_INDEX,disable_tracking:!1,disable_notification_text:!1,disable_secure_files:!1,disable_ptt_speech:!1,disable_snippet_preview_service:!1,disable_avatar_change:!1,disable_name_change:!1,disable_gdpr:!1,hide_all_policy_notes:!1,enable_otp_auth:!1,enable_email_mpop_auth:!0,disable_phone_signin:!1,disable_phone_attach:!1,disable_phone_switch:!1,disable_add_contact_by_phone:!1,disable_remove_user_button:!1,disable_password_recovery:!1,disable_webrtc_calls:!0,enable_account_delete_button:!1,disable_polls:!1,alt_recents_default_screen:!1,alternative_incoming_sound:!0,server_suggests_enabled:!0,smart_reply_enabled:!0,enable_smart_reply_text:!0,enable_smart_reply_stickers:!0},MYTEAM_BUILD_CONFIG={title_key:"myteam",product_name:"myteam",api_client:"myteam",akes_dev_id:"ic1zmlWFTdkiTnkL",root_css_class:"im-root_myteam",theme_schema:"themes_myteam",jslog_name:"MYTEAMLOG",radar_name:"webim_myteam",api_version:"25",restart_session_index:"25_"+RESTART_SESSION_INDEX,external_url_config:{config_name:"myteam-config.json",fixed_host:"u.myteam.vmailru.net",last_chance_host:"",last_chance_self_host:!0},phone_attach_options:{enabled:!0,allowBypass:!0,showTimeout:86400},disable_tracking:!1,disable_notification_text:!0,disable_secure_files:!1,disable_ptt_speech:!0,disable_snippet_preview_service:!1,disable_avatar_change:!0,disable_name_change:!0,disable_self_info_change:!0,disable_gdpr:!0,hide_all_policy_notes:!0,enable_otp_auth:!0,enable_email_mpop_auth:!0,disable_phone_signin:!0,disable_phone_attach:!0,disable_phone_switch:!0,disable_add_contact_by_phone:!0,disable_remove_user_button:!0,disable_password_recovery:!0,disable_session_list:!0,disable_webrtc_calls:!0,restricted_webrtc_domains:["corp.mail.ru"],enable_account_delete_button:!1,disable_polls:!1,alt_recents_default_screen:!0,alternative_incoming_sound:!0,app_start_stats:!0,server_suggests_enabled:!1,smart_reply_enabled:!1,enable_smart_reply_text:!1,enable_smart_reply_stickers:!1},ONPREMISE_BUILD_CONFIG={title_key:"myteam",product_name:"webOnprem",api_client:"myteam",akes_dev_id:"on2eeJ1ahgh-icqweb",root_css_class:"im-root_myteam",theme_schema:"themes_myteam",jslog_name:"ONPREMLOG",radar_name:"webim_onprem",api_version:"16",restart_session_index:"16_"+RESTART_SESSION_INDEX,external_url_config:{config_name:"myteam-config.json",last_chance_host:"",last_chance_self_host:!0},disable_tracking:!0,disable_notification_text:!0,disable_secure_files:!1,disable_ptt_speech:!0,disable_snippet_preview_service:!0,disable_avatar_change:!0,disable_name_change:!0,disable_self_info_change:!0,disable_gdpr:!0,hide_all_policy_notes:!0,enable_otp_auth:!0,enable_email_mpop_auth:!0,disable_phone_signin:!0,disable_phone_attach:!0,disable_phone_switch:!0,disable_add_contact_by_phone:!0,disable_remove_user_button:!0,disable_password_recovery:!0,disable_session_list:!0,disable_webrtc_calls:!0,enable_account_delete_button:!1,disable_polls:!1,alt_recents_default_screen:!0,alternative_incoming_sound:!0,server_suggests_enabled:!1,smart_reply_enabled:!1,enable_smart_reply_text:!1,enable_smart_reply_stickers:!1},ROSMINZDRAV_BUILD_CONFIG={title_key:"myteam",product_name:"webOnprem",api_client:"onprem",akes_dev_id:"on2eeJ1ahgh-icqweb",root_css_class:"im-root_myteam",theme_schema:"themes_myteam",jslog_name:"ONPREMLOG",radar_name:"webim_onprem",restart_session_index:RESTART_SESSION_INDEX,external_url_config_required:"myteam-config.json",last_chance_config_host:"",last_chance_self_host:!0,disable_notification_text:!0,disable_secure_files:!1,disable_ptt_speech:!0,disable_snippet_preview_service:!0,disable_avatar_change:!0,disable_name_change:!0,disable_gdpr:!0,hide_all_policy_notes:!0,enable_otp_auth:!0,enable_email_mpop_auth:!0,disable_phone_signin:!0,disable_phone_attach:!0,disable_phone_switch:!0,disable_add_contact_by_phone:!0,disable_remove_user_button:!0,disable_password_recovery:!0,disable_session_list:!0,disable_webrtc_calls:!0,enable_account_delete_button:!1,disable_polls:!1,alt_recents_default_screen:!0,alternative_incoming_sound:!0,server_suggests_enabled:!1,smart_reply_enabled:!1},GOVER_BUILD_CONFIG={title_key:"messenger",product_name:"webOnprem",api_client:"onprem",akes_dev_id:"on2eeJ1ahgh-icqweb",root_css_class:"im-root_myteam",theme_schema:"themes_myteam",jslog_name:"ONPREMLOG",radar_name:"webim_onprem",restart_session_index:RESTART_SESSION_INDEX,disable_notification_text:!0,external_url_config_required:"myteam-config.json",request_avatars_via_api:!0,disable_secure_files:!1,disable_ptt_speech:!0,disable_snippet_preview_service:!0,disable_avatar_change:!0,disable_name_change:!0,disable_gdpr:!0,hide_all_policy_notes:!0,enable_otp_auth:!0,enable_email_mpop_auth:!0,disable_phone_signin:!0,disable_phone_attach:!0,disable_phone_switch:!0,disable_add_contact_by_phone:!0,disable_remove_user_button:!0,disable_password_recovery:!0,disable_session_list:!0,disable_webrtc_calls:!0,enable_account_delete_button:!1,disable_polls:!1,alt_recents_default_screen:!0,alternative_incoming_sound:!0,server_suggests_enabled:!1,smart_reply_enabled:!1},DIT_BUILD_CONFIG={title_key:"messenger",product_name:"webIMOnPremise",api_client:"dit",akes_dev_id:"on2eeJ1ahgh-icqweb",root_css_class:"im-root_onpremise",theme_schema:"themes_onpremise",jslog_name:"DITLOG",radar_name:"webim_dit",restart_session_index:RESTART_SESSION_INDEX,disable_secure_files:!0,disable_ptt_speech:!0,disable_snippet_preview_service:!0,disable_avatar_change:!1,disable_name_change:!0,disable_gdpr:!0,hide_all_policy_notes:!0,enable_otp_auth:!1,enable_email_mpop_auth:!0,disable_phone_signin:!0,disable_phone_attach:!0,disable_phone_switch:!0,disable_add_contact_by_phone:!0,disable_remove_user_button:!0,disable_password_recovery:!0,disable_webrtc_calls:!0,enable_account_delete_button:!1,disable_polls:!0,alt_recents_default_screen:!0,alternative_incoming_sound:!0,server_suggests_enabled:!1,smart_reply_enabled:!1},GREENATOM_BUILD_CONFIG={title_key:"messenger",product_name:"webGreenatom",api_client:"dit",akes_dev_id:"on2eeJ1ahgh-icqweb",root_css_class:"im-root_greenatom",theme_schema:"themes_greenatom",jslog_name:"GATOMLOG",radar_name:"webim_gatom",restart_session_index:RESTART_SESSION_INDEX,disable_notification_text:!0,disable_secure_files:!0,disable_ptt_speech:!0,disable_snippet_preview_service:!0,disable_avatar_change:!0,disable_name_change:!0,disable_gdpr:!0,hide_all_policy_notes:!0,enable_otp_auth:!0,enable_email_mpop_auth:!0,disable_phone_signin:!0,disable_phone_attach:!0,disable_phone_switch:!0,disable_add_contact_by_phone:!0,disable_remove_user_button:!0,disable_password_recovery:!0,disable_webrtc_calls:!0,enable_account_delete_button:!1,disable_polls:!0,alt_recents_default_screen:!0,alternative_incoming_sound:!0,server_suggests_enabled:!1,smart_reply_enabled:!1},PUBLIC_URL_CONFIG={mainApi:"u.icq.net",stickerShare:"cicq.org/s",profile:"agent.mail.ru/profile",fileParsing:"files.icq.net/get",passwordRemind:"icq.com/password/",termsOfUse:"privacy.icq.com/legal/terms",privacyPolicy:"privacy.icq.com/legal/ppr",cookiePolicy:"privacy.icq.com/legal/cookiepolicy",profilePrivacy:"icq.com/help/visibility/"},AGENT_URL_CONFIG={profileStamp:"agent.mail.ru/profile",passwordRemind:"account.mail.ru/recovery",termsOfUse:"agent.mail.ru/legal/terms",privacyPolicy:"agent.mail.ru/legal/pp",cookiePolicy:"help.mail.ru/legal/terms/agent/eng/cookiepolicy",profilePrivacy:"agent.mail.ru/help/visibility/",mrimLoginAuth:"icqapilogin.mail.ru/auth/mrimLogin",sdcCookieAuth:"auth.mail.ru/sdc"},MYTEAM_URL_CONFIG={mainApi:"u.myteam.vmailru.net",binaryApiHost:"ub.myteam.vmailru.net",fileParsing:"files.myteam.mail.ru/get",stickerShare:"myteam.mail.ru/s",profile:"myteam.mail.ru/profile",profileStamp:"myteam.mail.ru/profile",accountMailBindPhonePage:"account.mail.ru/security/recovery/add-phone",bindPhoneReturnPage:"myteam.mail.ru/webim/bind_phone_result",mrimLoginAuth:"icqapilogin.mail.ru/auth/mrimLogin",sdcCookieAuth:"auth.mail.ru/sdc"},AGENT_RB_COUNTERS={41352497:"50271780",41352514:"50271783",41352518:"50271824",50271788:"50271788",32743984:"50271784",32743980:"50271785",41352564:"50271826"},ONPREMISE_RB_COUNTERS={41352497:"41352658",41352514:"41352662",32743984:"41352691",32743980:"41352695",41352564:"41352727"},DIT_RB_COUNTERS={41352497:"41352658",41352514:"41352662",32743984:"41352691",32743980:"41352695",41352564:"41352727"},GREENATOM_RB_COUNTERS={41352497:"45284229",41352514:"45284235",32743984:"45284237",32743980:"45284238",41352564:"45284239"},MYTEAM_RB_COUNTERS={41352497:"43374488",41352514:"43374489",50271788:"53980177",32743984:"43374490",32743980:"43374491",41352564:"43374492",50271289:"50271289",50271323:"50271323",50271324:"50271324"},THEME_SCHEMA_ALL={themes_default:["green","dark_green","blue","dark_blue"],themes_agent:["blue","green","dark_blue"],themes_greenatom:["dit_blue","dark_blue"],themes_onpremise:["dit_blue","dark_blue"],themes_myteam:["myteam_green","dark_blue"]},EXTERNAL_CONFIG_SCHEMA={"api-urls":{"main-api":"mainApi","main-binary-api":"binaryApiHost"},"templates-urls":{"files-parsing":"fileParsing","stickerpack-sharing":"stickerShare",profile:"profileStamp"},"mail-interop":{"web-mrim-auth":"mrimLoginAuth","web-sdc-cookie-auth":"sdcCookieAuth"}},copyObject=function(a){return Object.keys(a).reduce(function(b,c){return b[c]=a[c],b},{})},applyObject=function(a,b){return Object.keys(b).forEach(function(c){a[c]=b[c]}),a},trimTrailingSlashesAndProtocol=function(a){return a.replace(/^https?:\/\//,"").replace(/\/+$/,"")},applyExternalConfig=function(a){var b=!0,c={};return Object.keys(EXTERNAL_CONFIG_SCHEMA).forEach(function(d){Object.keys(EXTERNAL_CONFIG_SCHEMA[d]).forEach(function(e){if(a[d]&&a[d][e])try{c[EXTERNAL_CONFIG_SCHEMA[d][e]]=trimTrailingSlashesAndProtocol(a[d][e])}catch(f){b=!1}else"mail-interop"!==d&&(b=!1)})}),void 0!==a["allow-self-avatar-change"]&&(buildConfig.disable_avatar_change=!a["allow-self-avatar-change"]),void 0!==a["allow-self-name-change"]&&(buildConfig.disable_name_change=!a["allow-self-name-change"]),void 0!==a["allow-self-info-change"]&&(buildConfig.disable_self_info_change=!a["allow-self-info-change"]),void 0!==a["snippets-enabled"]&&(buildConfig.disable_snippet_preview_service=!a["snippets-enabled"]),void 0!==a["attach-phone-enabled"]&&(buildConfig.disable_phone_attach=!a["attach-phone-enabled"]),void 0!==a["server-suggests-enabled"]&&(buildConfig.server_suggests_enabled=!!a["server-suggests-enabled"]),void 0!==a["smart-reply-text-enabled"]&&(buildConfig.enable_smart_reply_text=!!a["smart-reply-text-enabled"]),void 0!==a["smart-reply-stickers-enabled"]&&(buildConfig.enable_smart_reply_stickers=!!a["smart-reply-stickers-enabled"]),b&&(c.profile=c.profileStamp,urlConfig=c),b},urlConfig,buildConfig,projectRbSchema,projectUrlConfig;switch(MESSENGER_ID){case"AGENT":projectUrlConfig=AGENT_URL_CONFIG,buildConfig=AGENT_BUILD_CONFIG,projectRbSchema=AGENT_RB_COUNTERS;break;case"GREENATOM":buildConfig=GREENATOM_BUILD_CONFIG,projectRbSchema=GREENATOM_RB_COUNTERS;break;case"ONPREMISE":buildConfig=ONPREMISE_BUILD_CONFIG,projectRbSchema=ONPREMISE_RB_COUNTERS;break;case"ROSMINZDRAV":buildConfig=ROSMINZDRAV_BUILD_CONFIG,projectRbSchema=ONPREMISE_RB_COUNTERS;break;case"GOVER":buildConfig=GOVER_BUILD_CONFIG,projectRbSchema=ONPREMISE_RB_COUNTERS;break;case"DIT":buildConfig=DIT_BUILD_CONFIG,projectRbSchema=DIT_RB_COUNTERS;break;case"MYTEAM":projectUrlConfig=MYTEAM_URL_CONFIG,buildConfig=MYTEAM_BUILD_CONFIG,projectRbSchema=MYTEAM_RB_COUNTERS;break;default:buildConfig=PUBLIC_BUILD_CONFIG}buildConfig.external_url_config||(projectUrlConfig&&applyObject(PUBLIC_URL_CONFIG,projectUrlConfig),urlConfig=PUBLIC_URL_CONFIG),WA.THEME_SCHEMA=THEME_SCHEMA_ALL[buildConfig.theme_schema||"themes_default"],WA.configurator={isConfigLoaded:function(){return!!urlConfig},applyConfig:applyExternalConfig,getUrls:function(){return urlConfig&&copyObject(urlConfig)},getOption:function(a){return buildConfig[a]},isBoard:function(){return!!window.BOARD_MODE},resolveRbCounter:function(a){return projectRbSchema?projectRbSchema[a]:a}},function(){function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c||a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}return a}()({1:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}function e(){for(m.innerHTML=g;m.firstElementChild;)k[m.firstElementChild.id]=m.firstElementChild.innerHTML,m.removeChild(m.firstElementChild)}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var f=d(a("../util/util")),g='<div id="UIDialogBlock">    <div class="im-overlay-screen__tablewrap">        <div class="im-overlay-screen__table">            <div class="im-overlay-screen__wrap">                <div class="im-overlay-screen__block">${content}</div>            </div>        </div>    </div></div><div id="avatar">    <div class="im-avatarbox {1}" __safe__style="{0}" data-sn="{2}" title="">{4}</div></div><div id="contextMenuItem">    <div class="imButton im-context-menu__item im-cmitem_{0}" data-action="{0}">{1}</div></div><div id="contextMenuFileItem">    <div class="imButton im-context-menu__item im-cmitem_{0}" data-action="{0}">        <span>{1}</span><input type="file"/>    </div></div><div id="overlayBox">    <div class="im-overlay__wrap">        <div class="im-overlay__box">${content}</div>    </div></div><div id="CircleSpinner">    <div class="imSpinner im-circ-spinner active">        <div class="im-circ-spinner__layer">            <div class="im-circ-spinner__clipper">                <div class="im-circ-spinner__circle"></div>            </div><div class="im-circ-spinner__gap-patch">                <div class="im-circ-spinner__circle"></div>            </div><div class="im-circ-spinner__clipper">                <div class="im-circ-spinner__circle"></div>            </div>        </div>    </div></div><div id="Switcher">    <div class="im-switch"><input checked="" type="checkbox"> <span class="im-switch-lever"></span></div></div><div id="mainTabSwitcher">    <div class="im-ui-button app-tab-button clist-tab" data-tab="clist"><span></span><div>tr{{tabs.contacts}}</div></div><!--        --><div class="im-ui-button app-tab-button tab-active recent-tab" data-tab="recent"><span></span><div class="im-msg-counter"></div><div>tr{{tabs.chats}}</div></div><!--        --><div class="im-ui-button app-tab-button settings-tab" data-tab="settings"><span></span><div>tr{{tabs.settings}}</div></div></div><div id="searchNothingFound">    <div class="im-search-results__nothing">tr{{search.noResults}}</div></div><div id="galleryCounterItem">    <div class="imButton im-sidebar-button im-gallery-counters__button im-gallery-counter__${type}" data-action="${action}">        ${title}<span>${counter}</span>    </div></div><div id="galleryPreviewItem">    <div class="im-gallery-preview im-gallery-item imButton ${idClass}" __safe__style="background-image:url(${url})" data-action="preview" data-url="${orig_url}" data-mid="${mid}" data-type="${type}"><div class="im-gallery-preview__info">${info}</div>${additionalHtml}</div></div><div id="galleryTopbar">    <div class="app-back-button appBack"></div>    <div class="im-gallery-topbar__title">${title}</div>    <div class="im-gallery-dropdown"></div>    <div class="im-gallery-topbar__menu-wrapper">        <div class="im-gallery-topbar__menu">${counters}</div>    </div></div><div id="infoPaneLayout">    <div id="infoPane">        <div class="im-infopane-overlay"></div>        <div class="im-infopane"></div>    </div></div><div id="dialogInfo">    <div class="im-sidebar" data-keep-element="1">        <div class="im-sidebar__topbar">            <div class="imButton im-sidebar-back" data-action="closeSidebar"></div>            <div class="imButton im-sidebar__editinfo" data-action="editInfo"></div>            <span class="imSidebarTopTitle">tr{{box.info}}</span>        </div>        <div class="im-sidebar__content">            <div class="imAvatarBox imButton im-sidebar__topinfo-ava" data-action="avatarPreview"></div>            <div class="imSidebarTopInfo im-sidebar__topinfo-item" data-key="name">                <span class="imSidebarTitle im-sidebar-topinfo__name"></span><br/><span class="imSidebarSubtitle im-sidebar-topinfo__subtitle"></span>            </div>            <div class="imSidebarWarning im-sidebar__topinfo-warning"></div>            <div class="im-sidebar__button-wrap"><div class="imButton imButtonAccent im-button-accent" data-action=""><span></span></div></div>            <div class="imSidebarTop im-sidebar-module im-sidebar-topinfo"></div>            <div class="im-sidebar-delimiter imSidebarActions">                <div class="imButton im-sidebar-button" data-action="shareGroup">tr{{contextmenu.shareGroup}}</div>                <div class="imButton im-sidebar-button" data-action="shareContact">tr{{contextmenu.shareContact}}</div>                <label class="imButton imSidebarNotifications im-sidebar-button" data-action="muteChat">tr{{dialog.tools.alerts}}                    <div class="im-switch"><input type="checkbox"><span class="im-switch-lever"></span></div>                </label>                <div class="imButton im-sidebar-button" data-action="groupSettings">tr{{group.groupSettings}}</div>            </div>            <div class="imSidebarCounters im-sidebar-module im-sidebar-gallery-counters im-sidebar-delimiter"></div>            <div class="imSidebarGroupMembers im-sidebar-module im-sidebar__members im-sidebar-delimiter"></div>            <div class="imSidebarUserGroups im-sidebar-module im-sidebar-delimiter">                <div class="imButton im-sidebar-button" data-action="commonGroups">tr{{contact.commonGroups}}<span>0</span></div>                <div class="imButton im-sidebar-button" data-action="addToChat">tr{{contact.createCommonGroup}}</div>            </div>            <div class="imSidebarNegative im-sidebar-module im-sidebar__negative im-sidebar-delimiter">                <div class="imButton im-sidebar-button" data-action="clearHistory">tr{{dialog.tools.clearHistory}}</div>                <div class="imButton im-sidebar-button" data-action="blockContact">tr{{contextmenu.block}}</div>                <div class="imButton im-sidebar-button" data-action="unblockContact">tr{{contextmenu.unblock}}</div>                <div class="imButton im-sidebar-button" data-action="reportSpam">tr{{contact.reportAndBlock}}</div>                <div class="imButton im-sidebar-button" data-action="removeContact">tr{{dialog.tools.remove}}</div>                <div class="imButton im-sidebar-button" data-action="leave">tr{{group.deleteAndLeave}}</div>            </div>        </div>    </div></div><div id="dialogInfoTopUser">    <div class="im-sidebar__topinfo-item" __safe__style="${aboutStyle}" data-key="aboutMe">        <span class="im-sidebar__topinfo-title">tr{{profile.aboutMe}}</span>        <span class="im-sidebar__topinfo-value">${infoAbout}</span>    </div>    <div class="imNick im-sidebar__topinfo-item" __safe__style="${nickStyle}" data-key="uNick">        <span class="im-sidebar__topinfo-title">tr{{profile.nickname}}</span>        <span class="imButton im-sidebar__topinfo-value" data-action="copyNick">${infoNick}</span>        <div class="imButton im-sidebar-context-button" data-action="shareNick" title="tr{{contextmenu.share}}"></div>        <div class="imButton im-sidebar-context-button" data-action="copyNick" title="tr{{contextmenu.copy}}"></div>    </div>    <div class="imPhoneNumber im-sidebar__topinfo-item" __safe__style="${phoneStyle}" data-key="phone">        <span class="im-sidebar__topinfo-title">tr{{profile.phoneNumber}}</span>        <span class="imButton im-sidebar__topinfo-value" data-action="copyPhoneNumber">${infoPhone}</span>        <div class="imButton im-sidebar-context-button" data-action="shareContact" title="tr{{contextmenu.share}}"></div>        <div class="imButton im-sidebar-context-button" data-action="copyPhoneNumber" title="tr{{contextmenu.copy}}"></div>    </div>    <div class="imEmail im-sidebar__topinfo-item" __safe__style="${emailStyle}" data-key="email">        <span class="im-sidebar__topinfo-title">tr{{profile.email}}</span>        <span class="imButton im-sidebar__topinfo-value" data-action="copySn">${infoEmail}</span>        <div class="imButton im-sidebar-context-button" data-action="shareSn" title="tr{{contextmenu.share}}"></div>        <div class="imButton im-sidebar-context-button" data-action="copySn" title="tr{{contextmenu.copy}}"></div>    </div></div><div id="dialogInfoTopGroup">    <div class="imSidebarAbout im-sidebar__topinfo-item ${clsAbout}" __safe__style="${styleAbout}" data-key="groupAbout">        <span class="im-sidebar__topinfo-title">${titleAbout}</span>        <span class="im-sidebar__topinfo-value">${infoAbout}</span>        <span class="imButton im-sidebar-topinfo__expand" data-action="showGroupAbout">tr{{group.readFullText}}</span>    </div>    <div class="imSidebarRules im-sidebar__topinfo-item ${clsRules}" __safe__style="${styleRules}" data-key="groupRules">        <span class="im-sidebar__topinfo-title">tr{{channel.rules}}</span>        <span class="im-sidebar__topinfo-value">${infoRules}</span>        <span class="imButton im-sidebar-topinfo__expand" data-action="showGroupRules">tr{{group.readFullText}}</span>    </div>    <div class="imGroupLink im-sidebar__topinfo-item" __safe__style="${styleLink}" data-key="link">        <span class="im-sidebar__topinfo-title">tr{{group.link}}</span>        <span class="imButton im-sidebar__topinfo-link" data-action="copyGroupLink">${infoLink}</span>        <div class="imButton im-sidebar-context-button" data-action="shareGroup" title="tr{{contextmenu.share}}"></div>        <div class="imButton im-sidebar-context-button" data-action="copyGroupLink" title="tr{{contextmenu.copy}}"></div>    </div></div><div id="dialogInfoGroupMembers">    <div class="im-sidebar__members-title"><span>${title}</span><div class="imButton im-sidebar__members-search" data-action="allMembers">tr{{search.search}}</div></div>    <div class="imButton im-sidebar-button" data-action="addToChat">tr{{group.addMember}}</div>    ${memberList}</div><div id="commonGroupsItem">    <div class="imButton im-member-item im-member-item_no-action" __safe__style="top:${offset}px" data-action="openProfile" data-sn="${sn}" data-friendly="${dataFriendly}">        ${avatarHtml}        <div class="im-member-item__namebox">            <span class="im-member-item__name">${friendly}</span>            <span class="im-member-item__subtitle">${subtitle}</span>        </div>    </div></div><div id="dialogInfoMember">    <div class="imButton im-member-item ${classes}" data-action="openProfile" data-sn="${sn}" data-friendly="${dataFriendly}">        <span class="im-member-item__role">${role}</span>        ${avatarHtml}<div class="im-member-item__namebox">            <span class="im-member-item__name">${friendly}</span>            <span class="im-member-item__subtitle">${lastSeen}</span>        </div>        <div class="imButton im-member-item__action-menu" data-action="memberMenu"></div>    </div></div><div id="groupMemberItem">    <div __safe__style="top:${offset}px" class="imButton imContact im-member-item ${extraClasses} ${classes}" data-sn="${email}" data-role="${role}" data-friendly="${nick}" idx="${idx}" ${attributes}>        <span class="im-member-item__role">${roleTitle}</span>        ${avatarHtml}<div class="im-member-item__namebox">            <span class="im-member-item__name">${vNick}</span>            <span class="im-member-item__subtitle">${subTitle}</span>        </div>        <div class="imButton im-member-item__action-menu" data-action="memberMenu"></div>        <div class="im-member-item__actions">            <div class="imButton im-chat__approve" data-action="approveUser"><span></span></div>            <div class="imButton im-chat__exclude" data-action="exclude"><span></span></div>        </div>    </div></div><div id="searchTag">    <div class="imButton im-search-tag ${cls}" data-action="${action}">${title}<div class="imButtonClose"></div></div></div><div id="searchTitleItem">    <div class="im-search-item-title ${cls}">${text}</div></div><div id="searchMessageItem">    <div class="imSearchEntry im-search-item ${classes}" data-entry="message" data-sn="${sn}" data-arch-id="${arch_id}" data-idx="${idx}" data-abs-idx="${absIdx}" data-selectable="1">        <span class="im-search-item__date">${date}</span>        ${avatarHtml}        <div class="im-search-item__wrap">            <span class="im-search-item__nick"><span>${title}</span></span>            <span class="im-search-item__text"><span class="im-search-item__sender">${textPrefix}</span>${text}</span>        </div>    </div></div><div id="searchContactItem">    <div class="imSearchEntry im-cl-contact ${classes}" data-entry="contact" data-sn="${sn}" data-friendly="${dataFriendly}" data-selectable="1">        ${avatarHtml}        <div class="im-contact-namebox">            <span class="im-contact-namebox__friendly">${friendly}</span>            <span class="im-contact-namebox__msg">${subtitle}</span>        </div>    </div></div><div id="dialogInfoCounterButton">    <div class="imButton im-sidebar-button" data-action="${action}">${title}<span>${counter}</span></div></div><div id="RecentItem">    <div class="im-recent-item" data-mail="${sn}" data-nick="${nick}" id="imDialogTab_recent${sn}">        <div class="im-recent-item__box ${classes}">            ${avatarHtml}            <div class="im-recent-item__title">                <span>${nickView}</span>            </div>            <div tab="div" class="im-recent-item__subtitle">                <span class="im-recent-item__lastmsg">${submessage}</span>            </div>            <div class="im-recent-item__date">${date}</div>            <div class="im-recent-item__flags">                <div class="im-msg-counter">${count}</div>                <div class="im-recent-item__mentioned"></div>                <div class="im-msg-seenby">${seenBy}</div>            </div>        </div>    </div></div><div id="UnknownItem">    <div class="im-recent-item im-ui-button" data-mail="${sn}" data-nick="${nick}" id="imDialogTab_unknown${sn}">        <div class="im-recent-item__box ${classes}">            ${avatarHtml}            <div class="im-recent-item__title"><span>${nickView}</span></div>            <div class="im-msg-counter">${count}</div>            <div class="im-unknown-buttons">                <button class="imButton im-unknown-add" data-action="add"></button>                <button class="imButton im-unknown-remove" data-action="remove"></button>            </div>        </div>    </div></div><div id="dialogMessage">    <div class="imMessage im-message {4}" data-nick="{11}" data-from="{5}" data-message-id="{16}" data-ind="{8}" data-time="{10}" data-arch-id="{9}">        {18}        <div class="im-avatar-block">{7}</div>        <span class="im-message__wrap-text">            <span class="im-message__text {3}" __safe__style="{6}">                <div class="im-message__from" __safe__style="{15}"><span>{1}</span></div>{2}                <div class="im-message__date">{0}</div>                <span class="im-message__status"></span>            </span>            {17}        </span>        <div class="im-message__seens">{14}</div>    </div></div><div id="dialogMessageDate">    <div class="im-messages__date" data-next-id="${mid}"><span>${date}</span></div></div><div id="dialogPinnedMessage">    <div class="im-pin-bar-wrap" data-arch-id="{0}">        <div class="im-pin-bar-author"><span>{1}</span></div>        <div class="im-pin-bar-text">{2}</div>    </div>    <a rel="nofollow noopener noreferrer" target="_blank" href="{6}">        <div class="im-pin-bar-widget imPinBarWidget {4}" __safe__style="{3}" data-url="{7}" data-file-id="{5}"></div>    </a>    <div class="im-pin-bar-msg">tr{{dialog.pinnedMessage}}</div>    <div class="im-pin-bar-arrow imPinBarToggle"></div></div><div id="dialogQuoteMessage">    <div class="imQuote {4}" data-nick="{11}" data-from="{5}" data-chat="{13}" data-time="{10}" data-arch-id="{9}" data-stamp="{8}">        <div class="im-message__from">{1}</div>        {14}        <span class="im-message__text {3}" __safe__style="{6}">{2}</span>    </div></div><div id="dialogQuoteReply">    <div class="im-message-quote__reply {4}">        {14}        <span class="im-message__text {3}" __safe__style="{6}">{2}</span>    </div></div><div id="dialogTopInputMessage">    <div class="{4}" data-msg-id="{3}">        <span class="im-quoted-message__from">{0}{1}</span>        <span class="im-quoted-message__text">{2}</span>    </div></div><div id="dialogMentionHolder">    <mark class="im-mention-inline" data-solid="true" data-mention="${sn}">${nick}</mark></div><div id="editProfileField">    <input type="text" class="imField${idx} im-field-text" value="${val}" placeholder="${placeholder}"/></div><div id="editProfileRichField">    <div class="im-field-rich-wrap"><div class="imField im-field-rich" contenteditable="true"></div></div>    <div class="imFieldSubinfo im-field-subinfo"></div></div><div id="LiveChatItem">    <div class="im-livechat-item ${className}" data-ind="${ind}">        ${avatar}        <div class="im-livechat-block">            <div class="im-livechat-name">${name}</div>            <div class="im-livechat-about">                ${about}            </div>            <div class="im-livechat-friends">${loc_friends}</div>            <div class="im-livechat-floor">                <div class="im-livechat-users">                    <div class="im-livechat-users__wrap">                        ${usersAvatars}                        <span class="im-livechat-count">${count}</span>                        <span class="im-livechat-count__full">${fullCount}</span>                    </div>                </div>                <div class="im-livechat-actions">                    <div class="im-livechat-join__comment">tr{{chat.adminReview}}</div>                    <div class="imButton im-ui-button im-livechat-join" data-action="ok">tr{{chat.joinChat}}</div>                    <div class="imButton im-ui-button im-livechat-open" data-action="ok">tr{{chat.openChat}}</div>                    <div class="im-livechat-pending_butt">tr{{chat.pendingInvite}}</div>                </div>            </div>        </div>    </div></div><div id="rightPaneDefault">    <div class="im-pane im-pane_default">        <div class="im-connection-title__wrapper">            <div class="im-connection-title">                <span class="im-connection-title__offline">tr{{network.offline}}</span>                <span class="im-connection-title__troubles">tr{{network.troubles}}</span>            </div>        </div>        <div class="im-pane-default-title im-connection-title__online"><span>tr{{dialog.selectChatToStart}}</span></div>    </div></div><div id="unknownRecentButton">    <div class="im-ui-button im-unknown-button" data-target="unknowns">        tr{{dialog.unknownContacts}}        <div class="im-msg-counter"></div>    </div></div><div id="liveChatSwitcher">    <div class="im-livechat-switcher" data-action="${action}" __safe__style="${style}">        ${name}        <div class="im-chat__actions_desc">${description}</div>        <div class="im-chat__actions">            <label class="im-switch"><input ${checked} ${disabled} type="checkbox"><span class="im-switch-lever"></span></label>        </div>    </div></div><div id="chatLink">    <div class="im-box-nick__link-desc">${linkExplanation}</div>    <div class="imNickLink imButton im-box-nick__link" ${link_attr} >${link}</div>    <div class="imButton im-box-nick__generate-link" data-action="generateNewLink">tr{{nickBox.generateNewLink}}</div>    <div class="im-chat-link__overlay">${spinner}</div></div><div id="editGroupNick">    <div class="im-box-nick__link-desc">${linkExplanation} <span class="imNickLink imButton im-box-nick__link"></span></div>    <div class="im-box-nick__input-block">        <div class="im-box-nick__input">            <span class="im-box-nick__prefield">${preText}</span>            <input type="text" class="imField im-field-text" placeholder="link"/>            <div class="im-box-nick__input__border"></div>        </div>        <div class="imFieldCounter im-box-nick__counter"></div>        <div class="imFieldSubinfo im-box-nick__subinfo"></div>        <div class="im-box-nick__rules">            tr{{nickBox.rules}}        </div>        <div class="im-box-nick__example-block imNickLinkExample">            <div class="im-box-nick__example-desc">${nickExampleTitle}</div>            <div class="imNickExample imButton im-box-nick__example"></div>        </div>    </div>    <div class="im-box-nick__loading-screen">        ${spinner}        <div class="imButton im-box-nick__loading-cross" data-action="closeLoadingScreen"></div>    </div></div><div id="groupSettings">    <div class="im-group-settings">        <div class="imAvatarBox im-avatar-uploader im-group-settings__avatar">            <div class="im-avatar-uploader__wrap"></div><input type="file" title=""/>        </div>        <div class="im-livechat-fields">            <div class="im-livechat-field">                <div class="imField im-livechat-edit im-livechat-edit__name"></div>                <div class="im-livechat-label">                    <span class="im-livechat-label__group">tr{{group.name}}</span>                    <span class="im-livechat-label__channel">tr{{channel.name}}</span>                </div>            </div>            <div class="im-livechat-field">                <div class="imField im-livechat-edit"></div>                <div class="im-livechat-label">                    <span class="im-livechat-label__group">tr{{group.about}}</span>                    <span class="im-livechat-label__channel">tr{{channel.about}}</span>                </div>            </div>            <div class="im-livechat-field">                <div class="imField im-livechat-edit"></div>                <div class="im-livechat-label">tr{{channel.rules}}</div>            </div>        </div>        <div class="im-livechat-switchers">            ${switchers}        </div>        <div class="im-livechat-link"></div>    </div></div><div id="forwardConfig">    <div class="im-forward-config">        <div class="im-forward-config__title ${cls}">${author}<span class="im-forward-config__subtitle">${chat}</span></div>        <label class="im-forward-config__option imButton" data-action="showAuthor">            <span>tr{{forward.showAuthor}}</span><div class="im-tickbox"></div>        </label>    </div></div><div id="stickersSuggest">    <div class="im-stickers-suggest">        <div class="im-stickers-suggest__content imStickersSuggestContent">${content}</div>        <div class="im-stickers-suggest__controls">            <div class="im-ui-button imButton im-stickers-suggest__controls-left"><span></span></div>            <div class="im-ui-button imButton im-stickers-suggest__controls-right"><span></span></div>        </div>        <div class="im-ui-button imButton im-stickers-suggest__close"><span></span></div>    </div>    <div class="im-stickers-suggest__arrow"><span></span></div></div><div id="stickersSuggestItem">    <img class="im-showcase__preview-content__item suggestItem" data-type="sticker" data-mid="${mid}" __safe__src="${icon}"/></div><div id="textSuggestItem">    <div class="im-smart-reply__text-item suggestItem" data-type="text" data-mid="${mid}"><span>${text}</span></div></div><div id="phoneInput">    <div class="im-phone__code">+7</div>    <input class="im-phone__input" type="tel" placeholder="tr{{profile.phoneNumber}}"/></div><div id="verifyPhoneBySMS">    <div class="im-verify-phone__input">        <div class="im-verify-phone__title">${phoneTitle}</div>        <div class="imPhoneField"></div>        <div class="icVerifyPhoneSubmessage im-verify-phone__submessage"></div>        <div class="im-verify-phone__bottom">            <button class="btnVerifyCancel imVerifyPhoneBtn im-button">tr{{box.cancel}}</button>            <button class="btnVerifyPhone imVerifyPhoneBtn im-button im-button_highlight" disabled>${phoneOk}</button>        </div>    </div>    <div class="im-verify-phone__sms">        <div class="im-verify-phone__title">${codeTitle}</div>        <div class="im-verify-phone__number">            <span class="imVerifyPhoneNumber"></span>            <span class="btnGoBack imVerifyPhoneBtn im-verify-phone__change">tr{{auth.change}}</span>        </div>        <input type="tel" class="txtSmsCode im-verify-phone__code" placeholder="tr{{auth.smsCode}}">        <span class="imVerifyPhoneErrorMsg im-verify-phone__error"></span>        <button class="btnResendCode imVerifyPhoneBtn im-verify-phone__resend" disabled>tr{{auth.resendCode}}<span>${resendTime}</span></button>        <button class="btnVoiceCode imVerifyPhoneBtn im-verify-phone__voice" disabled>tr{{auth.dictateByPhone}}</button>        <div class="im-verify-phone__bottom">            <button class="btnVerifyCancel imVerifyPhoneBtn im-button">tr{{box.cancel}}</button>            <button class="btnSubmitCode imVerifyPhoneBtn im-button im-button_highlight im-verify-phone__button_ok" disabled>tr{{box.ok}}</button>        </div>    </div>    <div class="im-verify-phone__overlay"></div></div><div id="addContactForm">    <input class="im-field-text" type="text" placeholder="tr{{profile.firstname}}"/>    <input class="im-field-text" type="text" placeholder="tr{{profile.lastname}}"/>    <div class="im-new-contact__phone-block"></div></div><div id="sendFileBox">    <div class="imSendFileList im-filebox-list"><div><!-- File list or preview --></div></div>    <!--input class="imSendFileText im-field-text" type="text" placeholder="tr{{dialog.addCaption}}"/-->    <div class="im-filebox-text">        <div class="im-filebox-text__wrapper">            <div class="imSendFileText im-field-text im-textfield_rich" contenteditable="true" maxlength="9000" placeholder="tr{{dialog.addCaption}}"></div>        </div>    </div></div><div id="contactListItem">    <div __safe__style="top:${offset}px" class="im-cl-contact im-ui-button ${extraClasses} ${classes}" mute="${mute}" status="${status}" mail="${email}" nick="${nick}" time="${time}" idx="${idx}" ${attributes}>        ${avatarHtml}<div class="im-contact-namebox">            <span class="im-contact-namebox__friendly">${vNick}</span>            <span class="im-contact-namebox__msg">${subTitle}</span>        </div>        ${ending}    </div></div><div id="pasteFileBox">    <div class="imButton im-chat__input-file-bar__close" data-action="removeFile"><span></span></div>    ${icon}<span>${title}</span></div><div id="fileBox">    ${object}    <div class="imFile im-file ${wrap_cls}" __safe__style="${wrap_style}" ${wrap_attrs} data-ready="${ready}" data-file-id="${file_id}" data-context-id="${contextId}" data-url="${url}" >        ${fileIconHtml}        <div class="im-file__title"><span>${name}</span>${file_info}${additional_info}</div>        <a class="im-file__action imFileDrop" title="${title}" rel="nofollow noopener noreferrer" download href="${url}">&nbsp;</a>        ${file_preview}        ${progressbar}        ${additional_html}    </div>    <div class="im-ui-button im-file__forward imForward" data-action="file-forward" data-url="${data_url}"></div>    <div class="im-file-message">${message}</div></div><div id="fileBoxClean">    <div class="imFile im-file ${wrap_cls}" ${wrap_attrs} data-ready="${ready}" data-file-id="${file_id}" data-context-id="${contextId}" data-url="${url}" >        ${fileIconHtml}        <div class="im-file__title"><span>${name}</span>${file_info}</div>        <div class="imButton im-file__remove" data-action="removeFile"></div>    </div></div><div id="galleryFileBox">    <div class="imFile im-file ${wrap_cls}" data-ready="${ready}" data-file-id="${file_id}" data-context-id="${contextId}" data-url="${url}" >        <a class="im-file__action imFileDrop" title="${title}" rel="nofollow noopener noreferrer" download ${href_attr}>            ${fileIconHtml}            <div class="im-file__title"><span>${name}</span>${file_info}${additional_info}</div>        </a>        ${file_preview}        ${additional_html}    </div>    <div class="im-ui-button im-file__forward imForward" data-action="file-forward" data-url="${data_url}"></div>    <div class="im-file-message">${message}</div></div><div id="fileIcon">    <div class="im-file__drop im-file__icon im-file__icon_${fileExtension}" __safe__style="${iconStyle}">${fileExtension}</div></div><div id="fileProgressBar">    <div class="im-file__circlebar" data-action="upload-abort">        <div class="im-file__circle-mask" style="transform:rotate(${progress}deg);-webkit-transform:transform:rotate(${progress}deg);">            <div class="im-file__circle-fill"></div>        </div>        <div class="im-file__circle-mask">            <div class="im-file__circle-fill" style="transform:rotate(${progress}deg);-webkit-transform:transform:rotate(${progress}deg);"></div>        </div>    </div></div><div id="fileObject">    <sub data-type="file" data-name="${name}" data-id="${id}" data-text="${text}" data-mid="${mid}" data-single="${single}" style="display:none;"></sub></div><div id="fileImagePreview">    <div __safe__style="${url_style}" class="im-file__image"><img __safe__style="${img_style}" ${img_src}/></div></div><div id="filePttBox">    <div class="imPttBox im-file__ptt-box ${boxClass}" data-url="${url}" data-id="imPtt_${domId}">        <div class="im-file__ptt-progress_box" __safe__style="${progressBarStyle}">            <div class="im-file__ptt-progress imPttProgress" __safe__style="${progressStyle}"></div>            <div class="im-file__ptt-play imPttPlay imButton"><span></span></div>            <div class="im-file__ptt-duration imPttDuration">${duration}</div>            <div class="imButton imPttTranslate im-file__ptt-translate"><span></span></div>        </div>        <div class="im-file__ptt-speech imPttSpeech">${speech_text}</div>    </div></div><div id="snippetBox">    <div class="imSnippet im-snippet ${wrap_cls}" __safe__style="${wrap_style}" data-content="${content_type}" data-url="${data_url}">        <a class="im-snippet__link imSnippetLink" rel="nofollow noopener noreferrer" target="_blank" href="${url}">            <div __safe__style="${preview_style}" class="${preview_cls}"><span class="im-snippet__preview-icon"></span></div>            <div class="im-snippet__title">                <span>${title}</span>                <div class="im-snippet__domain" __safe__style="${domain_style}">${domain}</div>            </div>        </a>    </div>    <div class="im-ui-button im-snippet__forward imForward" data-url="${data_url}"></div></div><div id="gallerySnippetBox">    <div class="imSnippet im-gallery-snippet ${wrap_cls}" __safe__style="${wrap_style}" data-content="${content_type}" data-url="${data_url}">        <a class="im-gallery-snippet__link imSnippetLink" rel="nofollow noopener noreferrer" target="_blank" href="${url}">            <div __safe__style="${preview_style}" class="im-gallery-snippet__image ${preview_cls}">${preview_avatar}</div>            <div class="im-gallery-snippet__title">                <span>${title}</span>                ${snippetBody}            </div>            <div class="im-gallery-snippet__domain">${domain}</div>            ${additionalInfo}        </a>        ${additionalHtml}    </div></div><div id="photoPreviewControls">    <div class="im-ppreview__profile im-ui-button" draggable="false" unselectable="on" data-action="profile"></div>    <div class="im-ppreview__progressbar"><div class="im-ppreview__progress"></div></div>    <a class="im-ppreview__get im-ui-button" rel="nofollow noopener noreferrer" download>&nbsp;</a>    <div class="im-ui-button im-ppreview__playcontrol" data-action="playcontrol"><span></span></div>    <div class="im-ui-button im-ppreview__resend" data-action="resend"></div>    <div class="im-ui-button im-ppreview__close" data-action="close"><span></span></div></div><div id="contactCard">    <div class="imSnippet im-contact-card" data-content="${content_type}" data-phone="${phone}" data-url="${data_url}" data-stamp="${stamp}" data-sn="${sn}" data-name="${name}">        <div class="im-contact-card__title">            <div class="im-contact-card__avatar">${avatar}</div>            <span class="im-contact-card__name">${title}</span>            <span class="im-contact-card__subtitle">${subtitle}</span>        </div>        <div class="im-contact-card__about">            ${snippetBody}        </div>        <div class="im-contact-card__action">${action_title}</div>    </div>    <div class="im-ui-button im-snippet__forward imForward" data-url="${data_url}"></div></div><div id="contactBoxContent">    <div class="im-contact-card__title imButton" data-action="openProfile">        <div class="im-contact-card__avatar">${avatar}</div>        <span class="im-contact-card__name">${title}</span>        <span class="im-contact-card__subtitle">${subtitle}</span>    </div>    <div class="im-contact-box__button-wrap">        <div class="imButton imButtonAccent im-button-accent" data-action="openDialog"><span class="im-button-accent_message">tr{{contextmenu.message}}</span></div>    </div>    <div class="im-contact-box__info">        <div class="imPhoneNumber im-contact-box__info-item" data-key="phone">            <span class="im-contact-box__info-title">tr{{profile.phoneNumber}}</span>            <span class="imPhoneNumberValue imButton im-contact-box__info-value" data-action="copyPhoneNumber">${contactPhone}</span>            <div class="imButton im-contact-box__context-button" data-action="shareContact" title="tr{{contextmenu.share}}"></div>            <div class="imButton im-contact-box__context-button" data-action="copyPhoneNumber" title="tr{{contextmenu.copy}}"></div>            <div class="im-tickbox im-tickbox_checked"></div>        </div>        <div class="imInfoMessage im-contact-box__info-item" data-key="infoMessage">tr{{box.noPhoneAndNicknameInfo}}</div>        <!--div class="imEmail im-contact-box__info-item" data-key="email">            <span class="im-contact-box__info-title">tr{{profile.email}}</span>            <span class="imButton im-contact-box__info-value" data-action="copySn">${contactEmail}</span>            <div class="imButton im-contact-box__context-button" data-action="shareSn" title="tr{{contextmenu.share}}"></div>            <div class="imButton im-contact-box__context-button" data-action="copySn" title="tr{{contextmenu.copy}}"></div>        </div-->    </div>    <div class="im-contact-box__save-wrap">        <div class="imButton im-contact-box__save" data-action="saveContact"><span>tr{{box.save}}</span></div>    </div></div><div id="botButtonSection">    <div class="imMessageButtons im-message__bot-section" __safe__style="${style}">${rows}</div></div><div id="botButtonRow">    <div class="im-message__bot-row ${cls}">${buttons}</div></div><div id="botButton">    <button class="imButton im-button-free im-message__bot-button ${cls}" data-action="bot" data-url="${url}" data-data="${data}" data-index="${index}" ${attributes}><span>${title}</span>${spinner}</button></div><div id="botCommand">    <span class="imButton im-message__mention" data-action="command" data-com="{0}">{0}</span></div><div id="createPoll">    <div class="imPollCreate im-poll-create__wrap">        <input type="text" class="imFieldTitle im-field-text" value="" placeholder="tr{{polls.askYourQuestion}}"/>        <div class="imOptions im-poll-create__answers"></div>        <button class="imButton im-poll-create__add" data-action="addOption" type="button"><div></div><span>tr{{polls.addAnswer}}</span></button>    </div></div><div id="createPollOption">    <div class="imOption im-poll-create__option" data-index="${idx}">        <div class="imPollText im-field-text im-textfield_rich" contenteditable="true" placeholder="tr{{polls.possibleAnswer}}"></div>        <div class="im-poll-controls">            <div class="imButton im-poll-create__option__remove" data-action="removeOption"></div>            <div class="imButton im-poll-create__option__drag" data-action="dragOption"></div>            <div class="imOptionCounter im-poll-create__option__counter"></div>        </div>    </div></div><div id="pollCardWrap">    <div class="imPollCard" data-id="${id}">${content}</div></div><div id="pollCard">    <div class="im-poll-card ${cls}">        <div class="imPollTitle im-poll-card__title">${title}</div>        <div class="imPollItems im-poll-card__items">${items}</div>        <div class="im-poll-card__subtitle">${subtitle}</div>    </div></div><div id="pollCardItem">    <div class="imButton im-poll-card__item ${cls}" data-id="${id}">        <div class="im-poll-card__item__bubble" __safe__style="${bubbleStyle}"></div>        <span class="im-poll-card__item__title">${title}</span>        <div class="im-poll-card__item__votes">            <span>${percent}</span>            <span class="im-poll-card__item__abs">${votes}</span>        </div>    </div></div><div id="pollShortSnippet">    <div class="im-poll-snippet">        <div class="im-poll-snippet__icon"></div>        <span>${title}</span>    </div></div><div id="voipCallCard">    <div class="imCallCard im-voip-callcard ${cls}">        <div class="im-voip-callcard__body">            <div class="im-voip-callcard__icon"></div>            <span class="im-voip-callcard__title">${title}</span>            <span class="im-voip-callcard__subtitle">${subtitle}</span>            <div class="im-voip-callcard__coins">${coins}</div>        </div>        <div class="imButton im-voip-callcard__button" data-action="callBack" data-sn="${sn}" data-video="${video}" data-group="${group}">tr{{calls.callBack}}</div>    </div></div><div id="galleryMenuButton">    <div class="im-gallery-menu__button imButton" data-action="itemMenu" data-url="${url}" data-mid="${mid}"><div></div></div></div><div id="galleryAdditionalInfo">    <div class="im-gallery-additional_info">        <span class="im-gallery-item__author imButton" data-action="author">${author}</span>        <span class="im-gallery-item__date imButton" data-action="goToMessage">${dateString}</span>    </div></div><div id="mediaAsText">    <span class="im-link-as-text im-link-${type}">${text}</span></div><div id="confirmModalBox">    <div class="im-modal-box__title">${title}</div>    <div class="im-modal-box__body">${content}</div>    <div class="im-modal-box__bottom">${buttons}</div></div><div id="button">    <button class="imButton im-button ${cls}" data-action="${action}">${text}</button></div><div id="linkButton">    <a href="${href}" target="_blank" class="imButton imButton im-linkbutton-green ${cls}" data-action="${action}">${text}</a></div><div id="myProfileBox">    <div class="im-myname">        <div class="imAvatarBox im-avatar-uploader im-group-settings__avatar">            <div class="im-avatar-uploader__wrap"></div><input type="file" title=""/>        </div>        <input type="text" class="imField0 im-field-text" value="" placeholder="tr{{profile.firstname}}"/>        <input type="text" class="imField1 im-field-text" value="" placeholder="tr{{profile.lastname}}"/>    </div></div><div id="startProfileBox">    <div class="im-start-profile__wrap">        <div class="im-start-profile__form">            <div class="imAvatarBox im-avatar-uploader">                <div class="im-avatar-uploader__wrap"></div><input type="file" title=""/>            </div>            <input type="text" class="imField0 im-text-input" value="" placeholder="tr{{profile.firstname}}*"/>            <input type="text" class="imField1 im-text-input" value="" placeholder="tr{{profile.lastname}}"/>            <span class="imAuthError im-auth-error"></span>            <button class="imButton im-auth-submit" data-action="ok" type="button" disabled>tr{{next}}</button>        </div>        <button data-action="signout" class="imButton im-auth-button-blank im-auth-switch-form" data-form="frmProfile" type="button" title="tr{{signOut}}"></button>    </div></div><div id="deleteAccountBox">    <div class="im-delete-account__wrap">        <div class="imStage1">            <div class="imAvatarBox"></div>            <span class="im-delete-account__title">tr{{settings.accountDeleting}}</span><br/><span class="imNick im-delete-account__title"></span>            <div class="imInfo im-delete-account__info"></div>        </div>        <div class="imStage2" style="display: none">            <span class="im-delete-account__title">tr{{settings.deleteConfirmationCode}}</span>            <div class="im-delete-account__warning">tr{{settings.accountIsAboutToDeleteWarning}}</div>            <input type="tel" class="imSmsCode im-field-text" autocomplete="off" placeholder="tr{{auth.smsCode}}">            <span class="imError im-auth-error"></span>            <button class="imButton im-button-text" data-action="resendCode" type="button" disabled>tr{{auth.resendCode}}</button>        </div>    </div></div><div id="changePasswordBox">    <div>        <span class="im-change-password__title">tr{{settings.changePassword}}</span>        <div class="imInfo im-change-password__info"></div>        <input class="imField0 im-field-text" type="password" value="" placeholder="tr{{settings.oldPassword}}"/>        <input class="imField1 im-field-text" type="password" value="" placeholder="tr{{settings.newPassword}}"/>        <input class="imField2 im-field-text" type="password" value="" placeholder="tr{{settings.repeatNewPassword}}"/>        <span class="imError im-auth-error"></span>    </div></div><div id="sessionItem">    <div class="im-settings__option_dry im-settings__session ${cls}">        <div class="im-settings__session__title"><span>${client}</span></div>        <div class="im-settings__session__info"><span>${started} &bull; ${location} &bull; IP: ${ip}</span></div>        <div class="imButton im-settings__option-close" data-action="closeSession" data-client="${client}" data-hash="${hash}"></div>    </div></div><div id="offlineBox">    <div class="imOfflineAva im-offline-box__avatar">${avatar}</div>    <div class="im-offline-box__msg">tr{{auth.msgNetworkError}}</div>    <button class="imButton im-auth-submit" data-action="ok" type="button">tr{{auth.goOn}}</button></div><div id="authFormPassword">    <div class="frmPassword im-auth-form-password">        <span class="imAuthTitle im-auth-title">${title}</span>        <span class="imAuthSubtitle im-auth-description">${subtitle}</span>        <input type="text" class="imAuthLogin im-text-input im-auth-input-login" placeholder="tr{{auth.username}}">        <input type="password" class="imAuthPassword im-text-input im-auth-input-pswd" placeholder="tr{{auth.password}}">        <span class="imAuthError im-auth-error"></span>        <button class="imButton im-auth-submit" data-action="submit" type="button" disabled>${buttonTitle}</button>        <a href="${passwordRemindLink}" class="im-auth-link">${passwordRecovery}</a>    </div></div><div id="authFormPhone">    <div class="frmPhone im-auth-form">        <span class="im-auth-title">tr{{auth.phoneNumber}}</span>        <span class="im-auth-description">tr{{auth.phoneNumberDescription}}</span>        <div class="im-input-country-phone">            <div class="imSelectCountryCode im-input-country-phone__code"></div>            <input type="tel" class="imAuthPhone im-input-country-phone__phone" autocomplete="off">        </div>        <span class="imAuthError im-auth-error"></span>        <button class="imButton im-auth-submit" data-action="submit" type="button">tr{{auth.login}}</button>    </div></div><div id="authFormSmsCode">    <div class="frmSmsCode im-auth-form-code">        <span class="imAuthTitle im-auth-title">tr{{auth.smsCode}}</span>        <div class="im-auth-description">            <span class="imAuthCodeSentPhrase">tr{{auth.codeWasSentTo}}</span>            <button class="imButton im-auth-button-accent" data-action="switchForm" type="button">tr{{auth.change}}</button>        </div>        <div class="im-auth-code-input">            <input type="tel" class="imAuthCode im-text-input" autocomplete="off" maxlength="6">            ${spinner}        </div>        <span class="imAuthError im-auth-error"></span>        <button class="imButton im-auth-button-accent" data-action="resendCode" type="button" disabled>tr{{auth.resendCode}}</button>    </div></div><div id="welcomeScreen">    <div class="imWelcome im-welcome-screen">        <div class="im-welcome-screen__top">            <div class="im-welcome-screen__image"></div>        </div>        <div class="im-welcome-screen__box">            <div class="im-welcome-screen__text">                <div class="im-welcome-screen__title">${welcomeTo}</div>                <div class="im-welcome-screen__description">${welcomeAgreement}</div>                <button class="imButton im-auth-submit" data-action="acceptAgreement" type="button">tr{{auth.acceptAndStart}}</button>            </div>        </div>    </div></div><div id="editProfileNick">    <div class="im-box-nick__example-desc">        tr{{nickBox.exampleDescription}}    </div>    <div class="imNickExample imButton im-box-nick__example"></div>    <div class="im-box-nick__input-block">        <input type="text" class="imField im-field-text" placeholder="tr{{nickBox.placeholder}}"/>        <div class="imFieldCounter im-box-nick__counter"></div>        <div class="imFieldSubinfo im-box-nick__subinfo"></div>        <div class="im-box-nick__rules">            tr{{nickBox.rules}}        </div>        <div class="im-box-nick__link-block imNickLinkExample">            <div class="im-box-nick__link-desc">${linkExplanation}</div>            <div class="imNickLink imButton im-box-nick__link"></div>        </div>    </div>    <div class="im-box-nick__loading-screen">        ${spinner}        <div class="imButton im-box-nick__loading-cross" data-action="closeLoadingScreen"></div>    </div></div><div id="nickBoxRepeatCheck">    <span class="imButton" data-action="repeatCheck">tr{{nickBox.repeatCheck}}</span></div><div id="nickBoxSuccessMessage">    <span class="im-box-nick__check-success">${message}</span></div><div id="themeRadioButton">    <label class="im-settings__i im-field-radio">${themeName}        <input type="radio" name="imThemeRadioButton" data-id="${themeId}" value="${themeIndex}"><span></span>    </label></div><div id="incomingCallBox">        ${avatarHtml}        <span class="im-box-incoming__name">${friendly}</span>        <span class="im-box-incoming__status">tr{{calls.incomingCall}}</span>        <div class="im-box-incoming__button-panel">            <div class="imButton im-voip-button im-voip-button_hangup" data-action="hangup"><div></div>tr{{calls.decline}}</div>            <div class="imButton im-voip-button im-voip-button_answer" data-action="answerAudio"><div></div>tr{{calls.audio}}</div>            <div class="imButton im-voip-button im-voip-button_answer-video" data-action="answerVideo"><div></div>tr{{calls.video}}</div>        </div></div><div id="voipStreamBox">    <div id="imStreamBox_${sn}" class="imStream im-stream ${cls}" data-stream="${sid}" data-sn="${sn}">        <div class="im-stream__avatar">${avatarHtml}</div>        <video muted="${muted}" autoplay="true"></video>        <audio muted="${muted}" autoplay="true"></audio>        <div class="im-stream__controls">            <span class="imStreamName im-stream__name">${friendly}</span>            <span class="imStreamStatus im-stream__status">${status}</span>            <button class="imButton im-button-free im-stream__screen-expand" data-action="goFull" title="tr{{calls.expand}}"></button>        </div>    </div></div><div id="voipCallBox">    <div class="imVoipBoxWrap im-callbox__wrap" style="display: none">        <div class="im-callbox">            <div class="imVoipBox im-voip" data-finished="tr{{calls.finished}}">                <!-- streams go here -->                <div class="imVoipLayout im-voip__layout"></div>                <div class="imBoxCarousel im-voip__carousel">                    <button class="imButton im-voip__carousel__up" data-action="slideUp"></button>                    <div class="imBoxCarouselItems im-voip__carousel-inner"><div class="imButton im-stream im-voip_add-user" data-action="addUser"></div></div>                    <button class="imButton im-voip__carousel__down" data-action="slideDown"></button>                </div>                <div class="im-voip__controls">                    <span class="imVoipName im-voip__name"></span>                    <span class="imVoipStatus im-voip__status"></span>                    <button class="imButton im-button-free im-voip__screen-collapse" data-action="exitFull">tr{{calls.showEveryone}}</button>                </div>                <div class="im-voip__button-panel"><!--                    --><div class="imButton im-button-free im-voip-button_maximize" data-action="maximize"></div><!--                    --><div class="imButton im-voip-button im-voip-button_video" data-action="toggleVideo"><div></div>tr{{calls.video}}</div><!--                    --><div class="imButton im-voip-button im-voip-button_mute" data-action="muteMic"><div></div>tr{{calls.mute}}</div><!--                    --><div class="imButton im-voip-button im-voip-button_speaker im-voip-button_activated" data-action="muteSpeaker"><div></div>tr{{calls.speaker}}</div><!--                    --><div style="display: none" class="imButton im-voip-button im-voip-button_screen-share" data-action="screenShare"><div></div>tr{{calls.screen}}</div><!--                    --><div class="imButton im-voip-button im-voip-button_hangup" data-action="hangup"><div></div>tr{{calls.hangup}}</div><!--                    --><div class="imButton im-voip-button im-voip-button_add" data-action="addUser"><div></div>tr{{calls.addMember}}</div><!--                    --><div class="imButton im-voip-button im-voip-button_menu" data-action="menu"><div></div>tr{{calls.other}}</div><!--                    --><div class="imButtonMenu im-voip__panel-menu">                        <div class="imButton im-voip__panel-menu__item im-voip__panel-menu__item_fullscreen" data-action="fullscreen">tr{{calls.fullscreen}}</div>                        <div class="imButton im-voip__panel-menu__item im-voip__panel-menu__item_minimize" data-action="minimize">tr{{calls.openChat}}</div>                        <div class="imButton im-voip__panel-menu__item im-voip__panel-menu__item_settings" data-action="settings">tr{{calls.settings}}</div>                    </div><!--                    --><div class="im-voip-button-dragger"></div><!--                --></div>                <div class="imButton imVoipDuration im-voip__duration" data-action="security"></div>            </div>        </div>    </div></div><div id="recentListDefaultScreen">    <div class="im-recent__default-screen__sticker"></div>    <span>tr{{cl.youHaveNoOpenedChatsYet}}</span></div><div id="recentListDefaultScreenAlternative">    <div class="im-recent__default-screen__icon"></div>    <span class="im-recent__default-screen__title">tr{{cl.emptyRecentListMessage}}</span>    <button class="imButton im-button im-button_highlight" data-action="searchContact">tr{{cl.search}}</button></div><div id="avatarBoxFull">    ${modifiers}<div class="im-avatarbox ${cls}" __safe__style="${avaStyle}" data-sn="${sn}" title="${title}">${content}</div></div><div id="groupNameField">    <div class="im-create-group__avatar imGroupAvatarBlock">        <div class="im-avatar-uploader__wrap imGroupAvatar"></div><span class="im-create-group__avatar__edit-btn"></span><input type="file" title=""/>        <!--div class="im-create-group__avatar__wrap imGroupAvatar"></div><span class="im-create-group__avatar__edit-btn"></span><input type="file" title=""-->    </div>    <input class="im-field-text imGroupNameField" type="text" placeholder="${placeHolder}"/>    <div class="imButton im-create-group__name__refresh" data-action="generateName"></div></div><div id="inviteEventButtons">    ${text}    <div class="im-message__buttons ${classes}">        <div class="im-message__button-wrapper im-message__button-wrapper_avatar"><div class="imButton im-message__button" data-action="editAvatar">tr{{group.addAvatar}}<input title="" type="file"/></div></div><!--        --><div class="im-message__button-wrapper im-message__button-wrapper_about"><div class="imButton im-message__button" data-action="editInfo">tr{{group.addAbout}}</div></div>    </div></div><div id="showcaseItem">    <div class="im-showcase__item im-ui-button imShowcaseItembox im-showcase_itembox ${cls_installed}" data-purchased="${purchased}" data-id="${id}" data-storeid="${store_id}">        <img class="im-showcase__item-icon" __safe__src="${icon}"/>        <div class="im-showcase__item-info">            <span class="im-showcase__item-name">${name}</span>        </div>        <div class="im-showcase__item-readyok"><span></span></div>        <div class="im-showcase-action im-button ${action_cls}" data-action="${action}" data-id="${id}" data-storeid="${store_id}">${action_title}</div>    </div></div><div id="packPreviewItem">    <div class="im-showcase__preview imShowcaseItembox im-showcase_itembox" data-purchased="${purchased}" data-id="${id}" data-storeid="${store_id}">        <div class="im-showcase__preview-content">${content}</div>        <div class="im-showcase__preview-bottom">            <div class="im-showcase-action im-button" data-id="${id}" data-storeid="${store_id}"></div>            <div class="im-showcase-action im-showcase-share im-ui-button" data-action="share"><span></span></div>        </div>    </div></div><div id="stickerSuggestItem">    <img class="im-showcase__preview-content__item" __safe__src="${icon}" /></div><div id="stickerPackPreviewItem">    <img class="im-showcase__preview-content__item" __safe__src="${icon}" />    <div __safe__src="${icon}" class="im-showcase__preview-content__item im-img__overlay"></div></div><div id="editFieldRadio">    <label class="im-field-radio">${title}<input type="radio" name="_imRadBtn" value="${value}"/><span></span></label></div><div id="editFieldText">    <input type="text" class="im-field-text" value="${defaultValue}" placeholder="${defaultValue}"/></div><div id="banUserSubtitle">    <span class="im-box-banuser__subtitle">${nick}</span></div><div id="banUserOption">    <label class="im-field-radio">${title}<input type="radio" name="_imRadBtn" value="${value}" ${checked}/><span></span></label></div><div id="actionButton">    <div class="imButton im-button ${cls}" data-action="${action}">${text}</div></div><div id="mentionSuggestItem">    <div data-selectable="1" class="imSearchEntry im-suggest-item im-ui-button ${classes}" data-sn="${email}" data-idx="${idx}">        ${avatarHtml}<div class="im-suggest-item-title"><span>${vNick}</span></div>    </div></div><div id="mentionSuggestSeparator">    <div class="im-suggest-item im-suggest-item_separator">tr{{search.restContacts}}</div></div><div id="stickerMessage">    <div data-action="sticker" data-pack="{0}" class="im-sticker-wrap" style="background-image: url({1})"><sub data-type="sticker" data-id="{2}" style="display:none;"></sub></div></div><div id="plainListIconItem">    <div class="im-plainlist-item" data-key="{0}" data-ind="{4}">        <span class="im-plainlist-item-icon {1}"></span>        <span class="im-plainlist-item-label">{2}</span>{3}    </div></div><div id="plainListItem">    <div class="im-plainlist-item im-plainlist-item_noicon"  data-key="{0}" data-ind="{4}">        <span class="im-plainlist-item-label">{2}</span>{3}    </div></div><div id="tabBoxItem">    <div id="{3}" class="app-tab-button im-ui-button im-multitabs__tab im-multitabs__tab_{1}" href="#{5}"  data-options="{6}" data-tab="{2}" data-tab-index="{0}">{4}</div></div><div id="tabBoxDownloadButton">    <div class="im-tabbox__layer-overlay"></div><div class="im-showcase-action im-button im-button_highlight" data-code="showcase#{0}">tr{{sticker.add}}</div></div><div id="promoChatBoard">    <div class="im-dialogpage im-dialogpage__is_chat im-dialogpage_readonly" data-page="dialog">        <div class="dialog-page-content">            <div class="app-topbar">                <span class="app-topbar__title">                    <div class="im-dialog__title-avatarbox imDialogTitleAvatar">                        <div class="im-avatarbox" __safe__style="background-image:url(${avatarUrl})"></div>                    </div>                    <div class="im-dialog__title imDialogTitle">                        <span class="im-dialog__title-span">${title}</span>                    </div>                    <div class="im-dialog__subtitle imDialogSubTitle">${subtitle}</div>                </span>            </div>            <div class="imChatContent app-content">                <div class="im-chat__shadow">                    <div class="im-chat__history">                        <div class="im-history"><div class="im-chat__history-wrap"><div class="im-chat__messages-wrap">${messages}</div></div></div>                    </div>                </div>            </div>            <div class="app-bottombar">                <div class="im-chat__no-input im-dialogpage_input-subscribe">                    <a href="${linkUrl}" target="${target}" class="imButton im-button im-linkbutton-green im-chat__input-inner im-chat__no-input__button" data-tabindex="2">tr{{dialog.noinput.subscribe}}</a>                </div>            </div>        </div>    </div></div><div id="privateBoardModeMessage">    <div class="im-mode_private-board__message">${text}</div></div><div id="imForwardFrom">    <span class="imForwardFrom im-forward__from" data-sn="${sn}">${name}</span></div><div id="bigEventMessage">    <div class="im-dialogpage__big-event-message">        <div class="im-dialogpage__big-event-message__wrap">            <div class="im-dialogpage__big-event-message__icon"></div><br/>            <div class="im-dialogpage__big-event-message__text">${text}</div>        </div>    </div></div>',h=/tr{{([\w.]+)(?:\(([^}]*)\))?}}/g,i=/\${([^}]+)}/g,j=/{(\d+)}/g,k={},l={},m=document.createElement("div"),n={
getTMPL:function(a,b){if(k[a]&&!l[a]&&(k[a]=k[a].replace(/^\s+|\s+$/g,"").replace(/__safe__/g,"").replace(h,function(a,b,c){var d=c?c.split(","):{};return d.defaultNull=!0,f["default"].tr(b,d)||"["+b+"]"}),l[a]=!0),b){m.innerHTML=k[a]||"";for(var c=document.createDocumentFragment();m.firstChild;)c.appendChild(m.firstChild);return c}return k[a]||""},_applyData:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},d=Array.isArray(b)?j:i;return a.replace(d,function(a,d){var e=b[d];return"number"==typeof e&&isFinite(e)&&(e=e.toString()),(null===e||void 0===e)&&(e=c.reusable?a:""),c.safe||c.safeKeys&&-1!==c.safeKeys.indexOf(d)||(e=f["default"].String.htmlEntity(e)),e})},parseString:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n._applyData(a,b,c)},parseSafe:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return n._applyData(n.getTMPL(a),b,c)}};e();var o=n;c["default"]=o},{"../util/util":25}],2:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function f(a,b,c){return b&&e(a.prototype,b),c&&e(a,c),a}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var g=function(){function a(){d(this,a),this.__isActive=!1}return f(a,[{key:"isActive",value:function(){return this.__isActive===!0}},{key:"_toggle",value:function(a,b){var c=!1;return this.__isActive!==b&&(this.__isActive=b,c=this[b?"_onActivate":"_onDeactivate"](a)!==!1),c}},{key:"activate",value:function(a){return this._toggle(a,!0)}},{key:"deactivate",value:function(a){return this._toggle(a,!1)}},{key:"_onActivate",value:function(a){}},{key:"_onDeactivate",value:function(a){}}]),a}();c["default"]=g},{}],3:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var e=d(a("../util/util")),f=WebIM,g={dynamicHistory:{all:!0,slots:[],corp:!0}},h=function(a){return a?(a.match(/^[0-9]+$/)?parseInt(a):e["default"].String.crc32(a))%100:-1};window.WIDGET_MODE||(window.PRIVATE_BOARD_MODE?window.WIDGET_MODE="d206c1d1":window.BOARD_MODE&&(window.WIDGET_MODE="Y2FsbHMu"));var i=window.WIDGET_MODE,j={projectName:"release",createGroupTitleTrKey:"group.createGroup",disableAutoScale:!1,disableLoginByPassword:!1,disabledGdprWhileAuth:!1,openOnlyPublicChat:!1,hideDialogTopbar:!1,hideDialogTopbarButtons:!1,showWidgetWelcomePage:!1,readOnlyWidgetWelcomePage:!1,loginWithoutReload:!1,disableManualAuthorization:!1,ignoreAuthByEmail:!1,disableOfflineMode:!1,disableNetworkStateMessages:!1,disablePollsSending:!1,disableContactSending:!1,useInstantStorageForCL:!1,hideBackButtonInFirstChat:!1,disableDialogSidebar:!1,disableSearch:!1,allowOnlyChatSearch:!1,skipEventMessages:!1,attachedPhoneIsRequired:!1,disableUserRequiredDataChecking:!1,disableNotificationSounds:!1,disableNotifications:!1,forceSoundInFocusedDialog:!1,disableStickerSuggest:!1,disableSmartReply:!1,tryUseMainAuthData:!1,useMainStorageForIdenticalUser:!1,copyMainSessionData:!1,msgUnauthorized:"board.msgLoginToViewComments",boardJoinButtonTitle:"board.comment",hideStickerPickerOnMobile:!1},k={"6a12cf9b":{projectName:"mozgo",createGroupTitleTrKey:"widget.createGroupTitle",widgetWelcomePageAuthorizedBottomTrKey:"widget.makeChatButton",widgetWelcomePageAuthorizedMessageTrKey:"widget.makeChatMessage",widgetWelcomePageUnAuthorizedMessageTrKey:"widget.loginToChatWithTeam",widgetWelcomePageAuthorizedBottomAction:"makeChat",widgetWelcomePageContentTemplate:"bigEventMessage",prefixAuthData:"mozgo_",skipWidgetWelcomePageAfterAuth:!0,disableAutoScale:!0,showWidgetWelcomePage:!0,disabledGdprWhileAuth:!0,disableLoginByPassword:!0,readOnlyWidgetWelcomePage:!0,disableNetworkStateMessages:!0,ignoreAuthByEmail:!0,useInstantStorageForCL:!0,disableContactSending:!0,disableDialogSidebar:!0,hideDialogTopbarButtons:!0,disableSearch:!0,attachedPhoneIsRequired:!0,forceSoundInFocusedDialog:!0,disableNotificationSounds:!0,disableStickerSuggest:!0,disableSmartReply:!0,tryUseMainAuthData:!0},d206c1d1:{projectName:"health.mail.ru",extDialogTopBarTrKey:"widget.workTimeFromUpTo",extDialogTopBarTrParams:["time_from","time_up_to"],extDialogTopBarUseLink:!0,widgetWelcomePageContentTemplate:"privateBoardModeMessage",widgetWelcomePageAuthorizedBottomAction:"sendMessage",disableAutoScale:!0,prefixAuthData:"private_",loginWithoutReload:!0,showWidgetWelcomePage:!0,hideDialogTopbarButtons:!0,disableLoginByPassword:!0,disabledGdprWhileAuth:!0,ignoreAuthByEmail:!0,disableNetworkStateMessages:!0,disablePollsSending:!0,disableContactSending:!0,disableDialogSidebar:!0,disableSearch:!0,skipEventMessages:!0,attachedPhoneIsRequired:!0,disableNotificationSounds:!0,disableNotifications:!0,tryUseMainAuthData:!0},"58562b47":{projectName:"news.mail.ru",disableUserRequiredDataChecking:!0,prefixAuthData:"board_",disableAutoScale:!0,openOnlyPublicChat:!0,hideDialogTopbar:!0,disableOfflineMode:!0,disableManualAuthorization:!0,disableNetworkStateMessages:!0,useInstantStorageForCL:!0,disableDialogSidebar:!0,disableSearch:!0,skipEventMessages:!0,disableNotificationSounds:!0,disableNotifications:!0,msgUnauthorized:"board.msgLoginToViewComments"},Y2FsbHMu:{projectName:"calls.mail.ru",disableUserRequiredDataChecking:!0,prefixAuthData:"calls_",disableAutoScale:!0,openOnlyPublicChat:!0,hideDialogTopbar:!0,disableOfflineMode:!0,disableManualAuthorization:!0,disableNetworkStateMessages:!0,useInstantStorageForCL:!0,disableDialogSidebar:!0,disableSearch:!0,skipEventMessages:!0,disableNotificationSounds:!0,disableNotifications:!0,boardAutoJoin:!0,specificTheme:"dark_calls",msgUnauthorized:"board.msgAuthFailed",boardJoinButtonTitle:"board.join",hideEmptyDialog:!0,hideStickerPickerOnMobile:!0}}[i]||{},l=Object.assign({},j,k),m=function(a){return l[a]},n={getSlot:function(){return h(f.ACTIVE_MAIL)},enabled:function(a){var b=f.ACTIVE_MAIL,c=g[a];return!!(c&&b&&(c.all||c.corp&&b.indexOf("@corp.mail.ru")>0||c.slots&&c.slots.indexOf(h(b))>-1))},getModeParameter:m},o=n;c["default"]=o},{"../util/util":25}],4:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function f(a,b,c){return b&&e(a.prototype,b),c&&e(a,c),a}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var g=WebIM,h={statistics:"stat.icq.in/stat",snippetInfo:"api.icq.net/preview/getPreview",store:"store.icq.com",phoneValidation:"icq.com/smsreg/requestPhoneValidation.php",attachPhone:"icq.com/smsreg/attachPhoneNumber.php",loginWithPhone:"icq.com/smsreg/loginWithPhoneNumber.php",gdprSave:"wapi.icq.com/agreement/save",stickerShare:"cicq.org/s/",commonImProfile:"icq.im/",imProfile:"icq.im/",chatProfile:"icq.com/chat/",chatInvite:"icq.com/invite/",uinProfile:"icq.com/",defaultChatProfile:"icq.com/chat/",stickerView:"icq.com/storeviewicq/",storePreview:"c.icq.com/store",authMailPage:"auth.mail.ru/cgi-bin/auth",accountMailBindPhonePage:"account.mail.ru/security/recovery/add-phone",bindPhoneReturnPage:"myteam.mail.ru/webim/bind_phone_result",binaryApiHost:"ub.icq.net",log:"",radar:"",rb:"rs.mail.ru/",rbRedirect:"r.mail.ru/",fileParsing:"files.icq.net/get",filesLinks:["files.mail.ru","files.icq.net","files.icq.com","icq.com","chat.my.com/files","files.chat.my.com","files.icq.net/get"]},i={statistics:"/stat/stat",snippetInfo:"/misc/preview/getPreview",phoneValidation:"/smsreg/requestPhoneValidation.php",attachPhone:"/smsreg/attachPhoneNumber.php",loginWithPhone:"/smsreg/loginWithPhoneNumber.php",gdprSave:"/wapi/agreement/save"},j=["mainApi","mrimLoginAuth","sdcCookieAuth","passwordRemind","termsOfUse","privacyPolicy","cookiePolicy","profilePrivacy","accountMailBindPhonePage","bindPhoneReturnPage","binaryApiHost","fileParsing","profile","stickerShare"],k=["mainApi","binaryApiHost"],l="https://",m="academy|accountant|accountants|active|actor|adult|aero|agency|airforce|apartments|app|archi|army|associates|asia|attorney|auction|audio|autos|biz|cat|com|coop|dance|edu|gov|info|int|jobs|mil|mobi|museum|name|net|one|ong|onl|online|ooo|org|organic|partners|parts|party|pharmacy|photo|photography|photos|physio|pics|pictures|feedback|pink|pizza|place|plumbing|plus|poker|porn|post|press|pro|productions|prof|properties|property|qpon|racing|recipes|red|rehab|ren|rent|rentals|repair|report|republican|rest|review|reviews|rich|site|tel|travel|xxx|xyz|yoga|zone|ac|ad|ae|af|ag|ai|al|am|an|ao|aq|ar|as|at|au|aw|ax|az|ba|bb|bd|be|bf|bg|bh|bi|bj|bm|bn|bo|br|bs|bt|bv|bw|by|бел|bz|ca|cc|cd|cf|cg|ch|ci|ck|cl|cm|cn|co|cr|cu|cv|cx|cy|cz|dd|de|dj|dk|dm|do|dz|ec|ee|eg|er|es|et|eu|fi|fj|fk|fm|fo|fr|ga|gb|gd|ge|gf|gg|gh|gi|gl|gm|gn|gp|gq|gr|gs|gt|gu|gw|gy|hk|hm|hn|hr|ht|hu|id|ie|il|im|in|io|iq|ir|is|it|je|jm|jo|jp|ke|kg|kh|ki|km|kn|kp|kr|krd|kw|ky|kz|la|lb|lc|li|lk|lr|ls|lt|lu|lv|ly|ma|mc|md|me|mg|mh|mk|ml|mm|mn|мон|mo|mp|mq|mr|ms|mt|mu|mv|mw|mx|my|mz|na|nc|ne|nf|ng|ni|nl|no|np|nr|nu|nz|om|pa|pe|pf|pg|ph|pk|pl|pm|pn|pr|ps|pt|pw|py|qa|re|ro|rs|срб|ru|rw|sa|sb|sc|sd|se|sg|sh|si|sj|sk|sl|sm|sn|so|sr|st|su|sv|sy|sz|tc|td|tf|tg|th|tj|tk|tl|tm|tn|to|tp|tr|tt|tv|tw|tz|ua|укр|ug|uk|us|uy|uz|va|vc|ve|vg|vi|vn|vu|wf|ws|ye|yt|za|zm|zw|рф|xn--lgbbat1ad8j|xn--90ais|xn--fiqs8s|xn--fiqz9s|xn--wgbh1c|xn--j6w193g|xn--h2brj9c|xn--mgbbh1a71e|xn--fpcrj9c3d|xn--gecrj9c|xn--s9brj9c|xn--xkc2dl3a5ee0h|xn--45brj9c|xn--mgba3a4f16a|xn--mgbayh7gpa|xn--mgbc0a9azcg|xn--ygbi2ammx|xn--wgbl6a|xn--p1ai|xn--mgberp4a5d4ar|xn--90a3ac|xn--yfro4i67o|xn--clchc0ea0b2g2a9gcd|xn--3e0b707e|xn--fzc2c9e2c|xn--xkc2al3hye2a|xn--ogbpf8fl|xn--kprw13d|xn--kpry57d|xn--o3cw4h|xn--pgbs0dh|xn--j1amh|xn--mgbaam7a8h|xn--54b7fta0cc|xn--90ae|xn--node|xn--4dbrk0ce|xn--mgb9awbf|xn--mgbai9azgqp6j|xn--mgb2ddes|中国|中國|香港|भारत|భారత్|ભારત|ਭਾਰਤ|இந்தியா|ভারত|新加坡|சிங்கப்பூர்|한국|ලංකා|இலங்கை|台湾|台灣|ไทย|გე|বাংলা|الجزائر|مصر|بھارت|ایران|الاردن|المغرب|فلسطين|قطر|السعودية|سورية|تونس|امارات|ru",n=/^\s*\/chat\/([@.a-zA-Z0-9\-_]+)/,o="icq.com/pubchat-history/",p=decodeURIComponent("A-Za-z%C2%AA%C2%B5%C2%BA%C3%80-%C3%96%C3%98-%C3%B6%C3%B8-%CB%81%CB%86-%CB%91%CB%A0-%CB%A4%CB%AC%CB%AE%CD%B0-%CD%B4%CD%B6%CD%B7%CD%BA-%CD%BD%CD%BF%CE%86%CE%88-%CE%8A%CE%8C%CE%8E-%CE%A1%CE%A3-%CF%B5%CF%B7-%D2%81%D2%8A-%D4%AF%D4%B1-%D5%96%D5%99%D5%A1-%D6%87%D7%90-%D7%AA%D7%B0-%D7%B2%D8%A0-%D9%8A%D9%AE%D9%AF%D9%B1-%DB%93%DB%95%DB%A5%DB%A6%DB%AE%DB%AF%DB%BA-%DB%BC%DB%BF%DC%90%DC%92-%DC%AF%DD%8D-%DE%A5%DE%B1%DF%8A-%DF%AA%DF%B4%DF%B5%DF%BA%E0%A0%80-%E0%A0%95%E0%A0%9A%E0%A0%A4%E0%A0%A8%E0%A1%80-%E0%A1%98%E0%A2%A0-%E0%A2%B4%E0%A2%B6-%E0%A2%BD%E0%A4%84-%E0%A4%B9%E0%A4%BD%E0%A5%90%E0%A5%98-%E0%A5%A1%E0%A5%B1-%E0%A6%80%E0%A6%85-%E0%A6%8C%E0%A6%8F%E0%A6%90%E0%A6%93-%E0%A6%A8%E0%A6%AA-%E0%A6%B0%E0%A6%B2%E0%A6%B6-%E0%A6%B9%E0%A6%BD%E0%A7%8E%E0%A7%9C%E0%A7%9D%E0%A7%9F-%E0%A7%A1%E0%A7%B0%E0%A7%B1%E0%A8%85-%E0%A8%8A%E0%A8%8F%E0%A8%90%E0%A8%93-%E0%A8%A8%E0%A8%AA-%E0%A8%B0%E0%A8%B2%E0%A8%B3%E0%A8%B5%E0%A8%B6%E0%A8%B8%E0%A8%B9%E0%A9%99-%E0%A9%9C%E0%A9%9E%E0%A9%B2-%E0%A9%B4%E0%AA%85-%E0%AA%8D%E0%AA%8F-%E0%AA%91%E0%AA%93-%E0%AA%A8%E0%AA%AA-%E0%AA%B0%E0%AA%B2%E0%AA%B3%E0%AA%B5-%E0%AA%B9%E0%AA%BD%E0%AB%90%E0%AB%A0%E0%AB%A1%E0%AB%B9%E0%AC%85-%E0%AC%8C%E0%AC%8F%E0%AC%90%E0%AC%93-%E0%AC%A8%E0%AC%AA-%E0%AC%B0%E0%AC%B2%E0%AC%B3%E0%AC%B5-%E0%AC%B9%E0%AC%BD%E0%AD%9C%E0%AD%9D%E0%AD%9F-%E0%AD%A1%E0%AD%B1%E0%AE%83%E0%AE%85-%E0%AE%8A%E0%AE%8E-%E0%AE%90%E0%AE%92-%E0%AE%95%E0%AE%99%E0%AE%9A%E0%AE%9C%E0%AE%9E%E0%AE%9F%E0%AE%A3%E0%AE%A4%E0%AE%A8-%E0%AE%AA%E0%AE%AE-%E0%AE%B9%E0%AF%90%E0%B0%85-%E0%B0%8C%E0%B0%8E-%E0%B0%90%E0%B0%92-%E0%B0%A8%E0%B0%AA-%E0%B0%B9%E0%B0%BD%E0%B1%98-%E0%B1%9A%E0%B1%A0%E0%B1%A1%E0%B2%80%E0%B2%85-%E0%B2%8C%E0%B2%8E-%E0%B2%90%E0%B2%92-%E0%B2%A8%E0%B2%AA-%E0%B2%B3%E0%B2%B5-%E0%B2%B9%E0%B2%BD%E0%B3%9E%E0%B3%A0%E0%B3%A1%E0%B3%B1%E0%B3%B2%E0%B4%85-%E0%B4%8C%E0%B4%8E-%E0%B4%90%E0%B4%92-%E0%B4%BA%E0%B4%BD%E0%B5%8E%E0%B5%94-%E0%B5%96%E0%B5%9F-%E0%B5%A1%E0%B5%BA-%E0%B5%BF%E0%B6%85-%E0%B6%96%E0%B6%9A-%E0%B6%B1%E0%B6%B3-%E0%B6%BB%E0%B6%BD%E0%B7%80-%E0%B7%86%E0%B8%81-%E0%B8%B0%E0%B8%B2%E0%B8%B3%E0%B9%80-%E0%B9%86%E0%BA%81%E0%BA%82%E0%BA%84%E0%BA%87%E0%BA%88%E0%BA%8A%E0%BA%8D%E0%BA%94-%E0%BA%97%E0%BA%99-%E0%BA%9F%E0%BA%A1-%E0%BA%A3%E0%BA%A5%E0%BA%A7%E0%BA%AA%E0%BA%AB%E0%BA%AD-%E0%BA%B0%E0%BA%B2%E0%BA%B3%E0%BA%BD%E0%BB%80-%E0%BB%84%E0%BB%86%E0%BB%9C-%E0%BB%9F%E0%BC%80%E0%BD%80-%E0%BD%87%E0%BD%89-%E0%BD%AC%E0%BE%88-%E0%BE%8C%E1%80%80-%E1%80%AA%E1%80%BF%E1%81%90-%E1%81%95%E1%81%9A-%E1%81%9D%E1%81%A1%E1%81%A5%E1%81%A6%E1%81%AE-%E1%81%B0%E1%81%B5-%E1%82%81%E1%82%8E%E1%82%A0-%E1%83%85%E1%83%87%E1%83%8D%E1%83%90-%E1%83%BA%E1%83%BC-%E1%89%88%E1%89%8A-%E1%89%8D%E1%89%90-%E1%89%96%E1%89%98%E1%89%9A-%E1%89%9D%E1%89%A0-%E1%8A%88%E1%8A%8A-%E1%8A%8D%E1%8A%90-%E1%8A%B0%E1%8A%B2-%E1%8A%B5%E1%8A%B8-%E1%8A%BE%E1%8B%80%E1%8B%82-%E1%8B%85%E1%8B%88-%E1%8B%96%E1%8B%98-%E1%8C%90%E1%8C%92-%E1%8C%95%E1%8C%98-%E1%8D%9A%E1%8E%80-%E1%8E%8F%E1%8E%A0-%E1%8F%B5%E1%8F%B8-%E1%8F%BD%E1%90%81-%E1%99%AC%E1%99%AF-%E1%99%BF%E1%9A%81-%E1%9A%9A%E1%9A%A0-%E1%9B%AA%E1%9B%B1-%E1%9B%B8%E1%9C%80-%E1%9C%8C%E1%9C%8E-%E1%9C%91%E1%9C%A0-%E1%9C%B1%E1%9D%80-%E1%9D%91%E1%9D%A0-%E1%9D%AC%E1%9D%AE-%E1%9D%B0%E1%9E%80-%E1%9E%B3%E1%9F%97%E1%9F%9C%E1%A0%A0-%E1%A1%B7%E1%A2%80-%E1%A2%84%E1%A2%87-%E1%A2%A8%E1%A2%AA%E1%A2%B0-%E1%A3%B5%E1%A4%80-%E1%A4%9E%E1%A5%90-%E1%A5%AD%E1%A5%B0-%E1%A5%B4%E1%A6%80-%E1%A6%AB%E1%A6%B0-%E1%A7%89%E1%A8%80-%E1%A8%96%E1%A8%A0-%E1%A9%94%E1%AA%A7%E1%AC%85-%E1%AC%B3%E1%AD%85-%E1%AD%8B%E1%AE%83-%E1%AE%A0%E1%AE%AE%E1%AE%AF%E1%AE%BA-%E1%AF%A5%E1%B0%80-%E1%B0%A3%E1%B1%8D-%E1%B1%8F%E1%B1%9A-%E1%B1%BD%E1%B2%80-%E1%B2%88%E1%B3%A9-%E1%B3%AC%E1%B3%AE-%E1%B3%B1%E1%B3%B5%E1%B3%B6%E1%B4%80-%E1%B6%BF%E1%B8%80-%E1%BC%95%E1%BC%98-%E1%BC%9D%E1%BC%A0-%E1%BD%85%E1%BD%88-%E1%BD%8D%E1%BD%90-%E1%BD%97%E1%BD%99%E1%BD%9B%E1%BD%9D%E1%BD%9F-%E1%BD%BD%E1%BE%80-%E1%BE%B4%E1%BE%B6-%E1%BE%BC%E1%BE%BE%E1%BF%82-%E1%BF%84%E1%BF%86-%E1%BF%8C%E1%BF%90-%E1%BF%93%E1%BF%96-%E1%BF%9B%E1%BF%A0-%E1%BF%AC%E1%BF%B2-%E1%BF%B4%E1%BF%B6-%E1%BF%BC%E2%81%B1%E2%81%BF%E2%82%90-%E2%82%9C%E2%84%82%E2%84%87%E2%84%8A-%E2%84%93%E2%84%95%E2%84%99-%E2%84%9D%E2%84%A4%E2%84%A6%E2%84%A8%E2%84%AA-%E2%84%AD%E2%84%AF-%E2%84%B9%E2%84%BC-%E2%84%BF%E2%85%85-%E2%85%89%E2%85%8E%E2%86%83%E2%86%84%E2%B0%80-%E2%B0%AE%E2%B0%B0-%E2%B1%9E%E2%B1%A0-%E2%B3%A4%E2%B3%AB-%E2%B3%AE%E2%B3%B2%E2%B3%B3%E2%B4%80-%E2%B4%A5%E2%B4%A7%E2%B4%AD%E2%B4%B0-%E2%B5%A7%E2%B5%AF%E2%B6%80-%E2%B6%96%E2%B6%A0-%E2%B6%A6%E2%B6%A8-%E2%B6%AE%E2%B6%B0-%E2%B6%B6%E2%B6%B8-%E2%B6%BE%E2%B7%80-%E2%B7%86%E2%B7%88-%E2%B7%8E%E2%B7%90-%E2%B7%96%E2%B7%98-%E2%B7%9E%E2%B8%AF%E3%80%85%E3%80%86%E3%80%B1-%E3%80%B5%E3%80%BB%E3%80%BC%E3%81%81-%E3%82%96%E3%82%9D-%E3%82%9F%E3%82%A1-%E3%83%BA%E3%83%BC-%E3%83%BF%E3%84%85-%E3%84%AD%E3%84%B1-%E3%86%8E%E3%86%A0-%E3%86%BA%E3%87%B0-%E3%87%BF%E3%90%80-%E4%B6%B5%E4%B8%80-%E9%BF%95%EA%80%80-%EA%92%8C%EA%93%90-%EA%93%BD%EA%94%80-%EA%98%8C%EA%98%90-%EA%98%9F%EA%98%AA%EA%98%AB%EA%99%80-%EA%99%AE%EA%99%BF-%EA%9A%9D%EA%9A%A0-%EA%9B%A5%EA%9C%97-%EA%9C%9F%EA%9C%A2-%EA%9E%88%EA%9E%8B-%EA%9E%AE%EA%9E%B0-%EA%9E%B7%EA%9F%B7-%EA%A0%81%EA%A0%83-%EA%A0%85%EA%A0%87-%EA%A0%8A%EA%A0%8C-%EA%A0%A2%EA%A1%80-%EA%A1%B3%EA%A2%82-%EA%A2%B3%EA%A3%B2-%EA%A3%B7%EA%A3%BB%EA%A3%BD%EA%A4%8A-%EA%A4%A5%EA%A4%B0-%EA%A5%86%EA%A5%A0-%EA%A5%BC%EA%A6%84-%EA%A6%B2%EA%A7%8F%EA%A7%A0-%EA%A7%A4%EA%A7%A6-%EA%A7%AF%EA%A7%BA-%EA%A7%BE%EA%A8%80-%EA%A8%A8%EA%A9%80-%EA%A9%82%EA%A9%84-%EA%A9%8B%EA%A9%A0-%EA%A9%B6%EA%A9%BA%EA%A9%BE-%EA%AA%AF%EA%AA%B1%EA%AA%B5%EA%AA%B6%EA%AA%B9-%EA%AA%BD%EA%AB%80%EA%AB%82%EA%AB%9B-%EA%AB%9D%EA%AB%A0-%EA%AB%AA%EA%AB%B2-%EA%AB%B4%EA%AC%81-%EA%AC%86%EA%AC%89-%EA%AC%8E%EA%AC%91-%EA%AC%96%EA%AC%A0-%EA%AC%A6%EA%AC%A8-%EA%AC%AE%EA%AC%B0-%EA%AD%9A%EA%AD%9C-%EA%AD%A5%EA%AD%B0-%EA%AF%A2%EA%B0%80-%ED%9E%A3%ED%9E%B0-%ED%9F%86%ED%9F%8B-%ED%9F%BB%EF%A4%80-%EF%A9%AD%EF%A9%B0-%EF%AB%99%EF%AC%80-%EF%AC%86%EF%AC%93-%EF%AC%97%EF%AC%9D%EF%AC%9F-%EF%AC%A8%EF%AC%AA-%EF%AC%B6%EF%AC%B8-%EF%AC%BC%EF%AC%BE%EF%AD%80%EF%AD%81%EF%AD%83%EF%AD%84%EF%AD%86-%EF%AE%B1%EF%AF%93-%EF%B4%BD%EF%B5%90-%EF%B6%8F%EF%B6%92-%EF%B7%87%EF%B7%B0-%EF%B7%BB%EF%B9%B0-%EF%B9%B4%EF%B9%B6-%EF%BB%BC%EF%BC%A1-%EF%BC%BA%EF%BD%81-%EF%BD%9A%EF%BD%A6-%EF%BE%BE%EF%BF%82-%EF%BF%87%EF%BF%8A-%EF%BF%8F%EF%BF%92-%EF%BF%97%EF%BF%9A-%EF%BF%9C%CC%80-%CD%AF%D2%83-%D2%89%D6%91-%D6%BD%D6%BF%D7%81%D7%82%D7%84%D7%85%D7%87%D8%90-%D8%9A%D9%8B-%D9%9F%D9%B0%DB%96-%DB%9C%DB%9F-%DB%A4%DB%A7%DB%A8%DB%AA-%DB%AD%DC%91%DC%B0-%DD%8A%DE%A6-%DE%B0%DF%AB-%DF%B3%E0%A0%96-%E0%A0%99%E0%A0%9B-%E0%A0%A3%E0%A0%A5-%E0%A0%A7%E0%A0%A9-%E0%A0%AD%E0%A1%99-%E0%A1%9B%E0%A3%94-%E0%A3%A1%E0%A3%A3-%E0%A4%83%E0%A4%BA-%E0%A4%BC%E0%A4%BE-%E0%A5%8F%E0%A5%91-%E0%A5%97%E0%A5%A2%E0%A5%A3%E0%A6%81-%E0%A6%83%E0%A6%BC%E0%A6%BE-%E0%A7%84%E0%A7%87%E0%A7%88%E0%A7%8B-%E0%A7%8D%E0%A7%97%E0%A7%A2%E0%A7%A3%E0%A8%81-%E0%A8%83%E0%A8%BC%E0%A8%BE-%E0%A9%82%E0%A9%87%E0%A9%88%E0%A9%8B-%E0%A9%8D%E0%A9%91%E0%A9%B0%E0%A9%B1%E0%A9%B5%E0%AA%81-%E0%AA%83%E0%AA%BC%E0%AA%BE-%E0%AB%85%E0%AB%87-%E0%AB%89%E0%AB%8B-%E0%AB%8D%E0%AB%A2%E0%AB%A3%E0%AC%81-%E0%AC%83%E0%AC%BC%E0%AC%BE-%E0%AD%84%E0%AD%87%E0%AD%88%E0%AD%8B-%E0%AD%8D%E0%AD%96%E0%AD%97%E0%AD%A2%E0%AD%A3%E0%AE%82%E0%AE%BE-%E0%AF%82%E0%AF%86-%E0%AF%88%E0%AF%8A-%E0%AF%8D%E0%AF%97%E0%B0%80-%E0%B0%83%E0%B0%BE-%E0%B1%84%E0%B1%86-%E0%B1%88%E0%B1%8A-%E0%B1%8D%E0%B1%95%E0%B1%96%E0%B1%A2%E0%B1%A3%E0%B2%81-%E0%B2%83%E0%B2%BC%E0%B2%BE-%E0%B3%84%E0%B3%86-%E0%B3%88%E0%B3%8A-%E0%B3%8D%E0%B3%95%E0%B3%96%E0%B3%A2%E0%B3%A3%E0%B4%81-%E0%B4%83%E0%B4%BE-%E0%B5%84%E0%B5%86-%E0%B5%88%E0%B5%8A-%E0%B5%8D%E0%B5%97%E0%B5%A2%E0%B5%A3%E0%B6%82%E0%B6%83%E0%B7%8A%E0%B7%8F-%E0%B7%94%E0%B7%96%E0%B7%98-%E0%B7%9F%E0%B7%B2%E0%B7%B3%E0%B8%B1%E0%B8%B4-%E0%B8%BA%E0%B9%87-%E0%B9%8E%E0%BA%B1%E0%BA%B4-%E0%BA%B9%E0%BA%BB%E0%BA%BC%E0%BB%88-%E0%BB%8D%E0%BC%98%E0%BC%99%E0%BC%B5%E0%BC%B7%E0%BC%B9%E0%BC%BE%E0%BC%BF%E0%BD%B1-%E0%BE%84%E0%BE%86%E0%BE%87%E0%BE%8D-%E0%BE%97%E0%BE%99-%E0%BE%BC%E0%BF%86%E1%80%AB-%E1%80%BE%E1%81%96-%E1%81%99%E1%81%9E-%E1%81%A0%E1%81%A2-%E1%81%A4%E1%81%A7-%E1%81%AD%E1%81%B1-%E1%81%B4%E1%82%82-%E1%82%8D%E1%82%8F%E1%82%9A-%E1%82%9D%E1%8D%9D-%E1%8D%9F%E1%9C%92-%E1%9C%94%E1%9C%B2-%E1%9C%B4%E1%9D%92%E1%9D%93%E1%9D%B2%E1%9D%B3%E1%9E%B4-%E1%9F%93%E1%9F%9D%E1%A0%8B-%E1%A0%8D%E1%A2%85%E1%A2%86%E1%A2%A9%E1%A4%A0-%E1%A4%AB%E1%A4%B0-%E1%A4%BB%E1%A8%97-%E1%A8%9B%E1%A9%95-%E1%A9%9E%E1%A9%A0-%E1%A9%BC%E1%A9%BF%E1%AA%B0-%E1%AA%BE%E1%AC%80-%E1%AC%84%E1%AC%B4-%E1%AD%84%E1%AD%AB-%E1%AD%B3%E1%AE%80-%E1%AE%82%E1%AE%A1-%E1%AE%AD%E1%AF%A6-%E1%AF%B3%E1%B0%A4-%E1%B0%B7%E1%B3%90-%E1%B3%92%E1%B3%94-%E1%B3%A8%E1%B3%AD%E1%B3%B2-%E1%B3%B4%E1%B3%B8%E1%B3%B9%E1%B7%80-%E1%B7%B5%E1%B7%BB-%E1%B7%BF%E2%83%90-%E2%83%B0%E2%B3%AF-%E2%B3%B1%E2%B5%BF%E2%B7%A0-%E2%B7%BF%E3%80%AA-%E3%80%AF%E3%82%99%E3%82%9A%EA%99%AF-%EA%99%B2%EA%99%B4-%EA%99%BD%EA%9A%9E%EA%9A%9F%EA%9B%B0%EA%9B%B1%EA%A0%82%EA%A0%86%EA%A0%8B%EA%A0%A3-%EA%A0%A7%EA%A2%80%EA%A2%81%EA%A2%B4-%EA%A3%85%EA%A3%A0-%EA%A3%B1%EA%A4%A6-%EA%A4%AD%EA%A5%87-%EA%A5%93%EA%A6%80-%EA%A6%83%EA%A6%B3-%EA%A7%80%EA%A7%A5%EA%A8%A9-%EA%A8%B6%EA%A9%83%EA%A9%8C%EA%A9%8D%EA%A9%BB-%EA%A9%BD%EA%AA%B0%EA%AA%B2-%EA%AA%B4%EA%AA%B7%EA%AA%B8%EA%AA%BE%EA%AA%BF%EA%AB%81%EA%AB%AB-%EA%AB%AF%EA%AB%B5%EA%AB%B6%EA%AF%A3-%EA%AF%AA%EA%AF%AC%EA%AF%AD%EF%AC%9E%EF%B8%80-%EF%B8%8F%EF%B8%A0-%EF%B8%AF"),q="[\\wа-я\\-"+p+"]",r="[\\wа-я"+p+"]",s="[\\wа-я\\-\\."+p+"]",t=/(https?:\/\/(?:firstLetterReg(?:hostLetterReg*firstLetterReg)?\.domainLetterReg{2,}(?::\d*)?(?:\/\S*?)?)|(?:firstLetterReg(?:hostLetterReg*(?:@hostLetterReg*)?firstLetterReg)?\.(?:ALL_DOMAINS)(?::\d*)?(?:\/\S*?)?))(?:[\.,\?!:;\)\]]*(?=\s|$))/.source.replace("ALL_DOMAINS",m).replace(/domainLetterReg/g,q).replace(/firstLetterReg/g,r).replace(/hostLetterReg/g,s),u=new RegExp("(^|\\s|>|\\(|\\[)"+t,"ig"),v=new RegExp("(?:^|\\s|>|\\(|\\[)"+t,"i"),w=new RegExp("^"+t+"$","i"),x=/(https?:\/\/)?([\w\-])+\.{1}([a-zA-Z]{2,63})([\/\w-]*)*\/?\??([^#\n\r]*)?#?([^\n\r]*)/,y=/(([^<>()\[\]\/\\.,;:\s@"]+(\.[^<>()\[\]\/\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))/gi,z=new RegExp("^"+y.source+"$","i"),A=function(a){return a.replace(/([.\/?])/g,"\\$1")},B=function(a){return a.replace(/^https?:\/\//,"").replace(/\/+$/,"")},C=function(a){return a.replace(/^https?:\/\//,"")},D=function(){function a(){d(this,a),this.ready=!1,this.urls={},g.configurator.isConfigLoaded()&&this.init()}return f(a,[{key:"isConfigReady",value:function(){return this.ready}},{key:"init",value:function(){var a=g.configurator.getUrls(),b=g.configurator.getOption("api_version"),c=h;if(a){b&&k.forEach(function(d){a[d]&&(a[d]=a[d]+"/api/v"+b),c[d]&&(c[d]=c[d]+"/api/v"+b)});var d=C(a.mainApi);Object.keys(i).forEach(function(a){c[a]=d+i[a]}),j.forEach(function(b){a[b]&&(c[b]=a[b])}),a.fileParsing&&-1===c.filesLinks.indexOf(a.fileParsing)&&c.filesLinks.push(a.fileParsing)}var e=g.configurator.getOption("radar_name");e&&(c.radar=e+".radar.imgsmail.ru/update?p="+e);var f=g.configurator.getOption("jslog_name");if(f){var l=window.VERSION_JS&&window.VERSION_JS.split(":")[0];c.log="mrilog.mail.ru/empty.gif?"+f+"="+(l||0)}var m=c.filesLinks.map(A),n=a.profile?a.profile+"/":h.chatProfile;this.IM_PROFILE_STAMP=a.profileStamp?a.profileStamp+"/":h.imProfile,this.STICKERS_LINK_MATCH=new RegExp("(?:(?:https?:)\\/\\/)?"+A(c.stickerShare)+"/([a-zA-Z0-9_]+)"),this.REGEX_STICKER=new RegExp("(?:(?:https?:)\\/\\/)?(?:www\\.)?"+A(c.stickerView)+"ext_(?:\\d+)_sticker_(?:\\d+)","ig"),this.LIVECHAT_LINK_MATCH=new RegExp("^\\s*(?:(?:https?:)\\/\\/)?(?:www\\.)?(?:"+A(n)+"|"+A(c.defaultChatProfile)+")([a-zA-Z0-9\\-_]+)\\s*$"),this.PROFILE_LINK_MATCH=new RegExp("^\\s*(?:(?:https?:)\\/\\/)?(?:www\\.)?(?:"+A(c.uinProfile)+"\\/(?:people\\/)?|"+A(c.profile+"/")+")([a-z0-9\\-_\\.]+\\@[a-z0-9_]+\\.(?:[a-z0-9_]+\\.)?[a-z]+|[0-9]{5,9})\\s*$"),this.ID_LINK_MATCH=new RegExp("^\\s*(?:(?:https?:)\\/\\/)?(?:www\\.)?(?:"+A(c.commonImProfile)+"|"+A(this.IM_PROFILE_STAMP)+"|"+A(c.profile+"/")+")([a-zA-Z0-9\\-_]+)(?:/[a-z]+)?\\s*$"),this.LEADING_FILE_LINKS=new RegExp("^[\\s\\n\\r]*(http(?:s)?://(?:"+m.join("|")+")/(?:get/|files/(?:get\\?fileId=)?)?([0-9a-zA-Z_\\-]{32,}|[0-9a-zA-Z_\\-]{50,}))(?:[\\n\\s\\r]+(.+))?[\\s\\n\\r]*$"),this.FILE_LINKS=new RegExp("^(?:(.+)[\\s\\n\\r]+)?[\\s\\n\\r]*(http(?:s)?://(?:"+m.join("|")+")/(?:get/|files/(?:get\\?fileId=)?)?([0-9a-zA-Z_\\-]{32,}|[0-9a-zA-Z_\\-]{50,}))(?:[\\n\\s\\r]+(.+))?[\\s\\n\\r]*$","m"),this.REG_REPLACE_URL=u,this.REG_FIRST_URL=v,this.REG_EXACT_URL=w,this.REG_EMAIL=y,this.REG_EXACT_EMAIL=z,this.APP_PROTOCOL=g.configurator.getOption("api_client"),this.urls=c,this.ready=!0}},{key:"applyConfig",value:function(a){return g.configurator.applyConfig(a)&&(this.init(),g.Api.initApiUrls()),this.ready}},{key:"encodeURIComponentFull",value:function(a){return encodeURIComponent(a).replace(/~/g,"%7E").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/!/g,"%21").replace(/'/g,"%27").replace(/\*/g,"%2A")}},{key:"chainParams",value:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},c=[];return Object.keys(b).forEach(function(d){c.push(encodeURIComponent(d)+"="+a.encodeURIComponentFull(b[d]))}),c.join("&")}},{key:"getUrl",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l;return this.urls[a]&&this.urls.hasOwnProperty(a)&&b+this.urls[a]}},{key:"getUrlWithQuery",value:function(a,b){return this.getUrl(a)+"?"+this.chainParams(b)}},{key:"getDomain",value:function(a){var b=this.getUrl(a);return b?b.match(/(?:(?:https?:)\/\/)?([^\/?#]+)/):void 0}},{key:"externalConfigUrl",value:function(a,b){return l+B(a)+"/"+g.configurator.getOption("external_url_config").config_name+"?domain="+b+"&r="+g.uniq()}},{key:"linksFromText",value:function(a){return a.match(this.REG_REPLACE_URL)}},{key:"liveChatMatch",value:function(a){return a.match(this.LIVECHAT_LINK_MATCH)}},{key:"openDialogLinkMatch",value:function(a){var b=a.match(n);return b&&b[1]}},{key:"idLinkMatch",value:function(a){return a.match(this.ID_LINK_MATCH)}},{key:"stickersMatch",value:function(a){return a.match(this.STICKERS_LINK_MATCH)}},{key:"profileMatch",value:function(a){return a.match(this.PROFILE_LINK_MATCH)}},{key:"stickersStoreMatch",value:function(a){return a.match(this.REGEX_STICKER)}},{key:"parseLeadingFileLink",value:function(a){return a.match(this.LEADING_FILE_LINKS)}},{key:"parseFileLink",value:function(a){return a.match(this.FILE_LINKS)}},{key:"chatLink",value:function(a){return a.live||a["public"]?l+this.IM_PROFILE_STAMP+(a.stamp||""):null}},{key:"clientChatDeepLink",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return l+window.location.hostname+"/chat/"+a}},{key:"inviteChatLink",value:function(a){return l+this.urls.chatInvite+a}},{key:"getPromoChatUrl",value:function(a){return l+o+a+".json"}},{key:"validUrlMatch",value:function(a){return a.match(x)}},{key:"emailLink",value:function(a){return l+this.urls.profile+"/"+(a||"")}},{key:"rbUrl",value:function(a){return this.urls.rb?l+this.urls.rb+"d"+a+".gif?rnd="+Math.random():void 0}},{key:"rbClickUrl",value:function(a){return l+this.urls.rbRedirect+"n"+a}},{key:"profileLink",value:function(a){return l+this.IM_PROFILE_STAMP+(a||"")}},{key:"appLink",value:function(a){return this.APP_PROTOCOL+"://"+(a||"")}},{key:"favoriteFirstMessageImageLink",value:function(){return"https://c.icq.com/fvrt/".concat(g.isDesktop?"d":"m").concat("ru"===g.resLanguage?"r":"e",".png")}}]),a}(),E=new D;c["default"]=E},{}],5:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function f(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function g(a,b,c){return b&&f(a.prototype,b),c&&f(a,c),a}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var h=d(a("../util/Array")),i=d(a("../util/Object")),j=d(a("../util/String")),k=d(a("../util/Monitoring")),l=d(a("../util/EventA")),m=d(a("../util/DomHelper")),n=WebIM,o=function(a,b,c,d){a.addEventListener?a.addEventListener(b,c,!!d):a.attachEvent&&a.attachEvent("on"+b,c)},p=function(a,b,c,d){a.removeEventListener?a.removeEventListener(b,c,!!d):a.detachEvent&&a.detachEvent("on"+b,c)},q=n.isIE?{b1:0,b4:1,b2:2}:{b0:0,b1:1,b2:2},r=function(){function a(b){e(this,a);var c,d=this.browserEvent=b||{};this.button=d.button?q["b"+d.button]:d.which?d.which-1:-1,/(dbl)?click/.test(d.type)&&-1===this.button&&(this.button=0),this.type=d.type,this.keyCode=d.keyCode,this.charCode=d.charCode,this.shiftKey=d.shiftKey,this.ctrlKey=d.ctrlKey||d.metaKey||!1,this.altKey=d.altKey,this.pageX=d.pageX/n.zoom,this.pageY=d.pageY/n.zoom,null==d.pageX&&null!=d.clientX&&(c=document.documentElement,this.pageX=d.clientX/n.zoom+(c&&c.scrollLeft||0),this.pageY=d.clientY/n.zoom+(c&&c.scrollTop||0))}return g(a,[{key:"getKeyCode",value:function(){return this.browserEvent.keyCode}},{key:"getCharCode",value:function(){return this.browserEvent.charCode}},{key:"getTarget",value:function(a){var b=this.browserEvent.target||this.browserEvent.srcElement;if(b){var c=3===b.nodeType?b.parentNode:b;return a?D.get(c):c}return null}},{key:"stopPropagation",value:function(){var a=this.browserEvent;a&&(a.stopPropagation?a.stopPropagation():a.cancelBubble=!0)}},{key:"preventDefault",value:function(){var a=this.browserEvent;a&&(a.preventDefault?a.preventDefault():a.returnValue=!1)}},{key:"stopEvent",value:function(){this.stopPropagation(),this.preventDefault()}}]),a}(),s={items:{},register:function(a){var b=a.identify();this.items[b]||(this.items[b]=new t(a))},getElement:function(a){var b=this.items[a];return b&&b.isValid()?b.el:null},each:function(a,b){i["default"].each(this.items,a,b||this)},addListener:function(a,b,c,d,e){this.register(a);var f=this.items[a.getId()];f.addListener(b,c,d,e)},removeListener:function(a,b,c,d){var e=this.items[a.getId()];e&&e.removeListener(b,c,d)},removeListeners:function(a,b,c){var d=this.items[a.getId()];d&&(d.removeListeners(c),b&&a.dom.childNodes&&a.each(function(a){this.removeListeners(a,b,c)},this))},remove:function(a){var b=a.getId(),c=this.items[b];c&&(c.destroy(),delete this.items[b])},garbageCollect:function(){var a=this;this.each(function(b){b.isValid()||b.isSafe()||a.remove(b.el)})}},t=function(){function a(b){e(this,a),this.el=b,this.events={},this.domHandlers={}}return g(a,[{key:"isValid",value:function(){var a=this.el,b=a.dom,c=!b||!b.parentNode||!b.offsetParent&&b!==document.getElementById(a.getId());return!c||b===document||b===document.body||b===window}},{key:"isSafe",value:function(){return this.el.hasAttr("data-keep-element")}},{key:"addListener",value:function(a,b,c,d){var e=this,f=this.events[a];f||(f=this.events[a]=new l["default"],this.domHandlers[a]=function(a,b){k["default"].wrapTryCatch(function(){this.events[a]&&this.events[a].fire(new r(b),this.el)},this)}.bind(this,a),"afterresize"===a?o(this.el.dom,"resize",function(b){e._timer>0&&clearTimeout(e._timer),e._timer=setTimeout(function(){e.domHandlers[a].call(window,b)},150)}):o(this.el.dom,a,this.domHandlers[a],!1)),f.on(b,c||this.el,d)}},{key:"removeListener",value:function(a,b,c){var d=this.events[a];d&&(d.un(b,c||this.el),!d.hasListeners()&&this.el&&"mousemove"===a&&(p(this.el.dom,a,this.domHandlers[a]),delete this.events[a],delete this.domHandlers[a]))}},{key:"removeListeners",value:function(a){if(a){var b=this.events[a];b&&b.removeAll()}else i["default"].each(this.events,function(a,b){this.removeListeners(b)},this)}},{key:"destroy",value:function(){var a=i["default"].getKeys(this.events);h["default"].each(a,function(a){this.removeListeners(a),p(this.el.dom,a,this.domHandlers[a]),delete this.events[a],delete this.domHandlers[a]},this),this.events=null,this.domHandlers=null,this.el=null}}]),a}(),u={},v=/(-[a-z])/gi,w=n.isIE?"styleFloat":"cssFloat",x=function(a,b){return b.charAt(1).toUpperCase()},y=function(a){return u[a]||(u[a]="float"===a?w:a.replace(v,x))},z={opacity:"setOpacity",transition:"setTransition",transform:"setTransform"},A=function(a,b){var c;return a.currentStyle?c=a.currentStyle[b]:window.getComputedStyle&&(c=document.defaultView.getComputedStyle(a,null).getPropertyValue(b)),c},B=function(a,b,c){return z[a]&&"function"==typeof c[z[a]]?(c[z[a]](b),!0):void 0},C=1,D=function(){function a(b){e(this,a),this.dom=b}return g(a,[{key:"getId",value:function(){return this.dom===window?a.buildId("window"):this.dom===document?a.buildId("document"):this.dom===document.body?a.buildId("body"):this.dom.id}},{key:"identify",value:function(){return this.getId()||(this.dom.id=a.generateId())}},{key:"getWidth",value:function(){return Math.max(this.dom.offsetWidth,this.isVisible()?0:this.dom.clientWidth)||0}},{key:"getHeight",value:function(){return Math.max(this.dom.offsetHeight,this.isVisible()?0:this.dom.clientHeight)||0}},{key:"getSize",value:function(){return{width:this.getWidth(),height:this.getHeight()}}},{key:"setWidth",value:function(a){return this.dom.style.width=a+"px",this}},{key:"setHeight",value:function(a){return this.dom.style.height=a+"px",this}},{key:"setSize",value:function(a,b){return n.isObject(a)?this.setSize(a.width,a.height):(this.setWidth(a),this.setHeight(b),this)}},{key:"addListener",value:function(a,b,c,d){var e=Array.isArray(a)?a:[a];return h["default"].each(e,function(a){s.addListener(this,a,b,c,d)},this),this}},{key:"on",value:function(a,b,c,d){return this.addListener(a,b,c,d)}},{key:"removeListener",value:function(a,b,c){var d=Array.isArray(a)?a:[a];return h["default"].each(d,function(a){s.removeListener(this,a,b,c)},this),this}},{key:"un",value:function(a,b,c){return this.removeListener(a,b,c)}},{key:"removeListeners",value:function(a,b){return s.removeListeners(this,a,b),this}},{key:"setAttribute",value:function(){var a;return(a=this.dom).setAttribute.apply(a,arguments),
this}},{key:"getAttribute",value:function(a){return this.dom.getAttribute(a)}},{key:"removeAttribute",value:function(a){return this.dom.removeAttribute(a),this}},{key:"setDisabled",value:function(a){return a===!1?this.removeAttribute("disabled"):this.setAttribute("disabled","disabled"),this}},{key:"removeClass",value:function(a){var b=this.dom.className.split(" ");return this.dom.className=h["default"].remove(b,a).join(" "),this}},{key:"addClass",value:function(a){return this.hasClass(a)||(this.dom.className+=" "+a),this}},{key:"hasClass",value:function(a){return(" "+this.dom.className+" ").indexOf(" "+a+" ")>-1}},{key:"toggleClass",value:function(a,b){var c="boolean"==typeof b,d=c?b:!this.hasClass(a);return this[d?"addClass":"removeClass"](a),this}},{key:"getClass",value:function(){return this.dom.className}},{key:"update",value:function(a){return this.dom.innerHTML=a,this}},{key:"updateHTML",value:function(a){return this.dom.innerHTML=a,this}},{key:"updateText",value:function(a){return this.dom.innerHTML=j["default"].htmlEntity(a),this}},{key:"insertFirst",value:function(b){var c=a.get(b);return this.first()?(this.insertBefore(c,this.first()),c):c.appendTo(this)}},{key:"appendChild",value:function(b){return a.get(b).appendTo(this)}},{key:"appendTo",value:function(b){return a.getDom(b).appendChild(this.dom),this}},{key:"insertBefore",value:function(b,c){return this.dom.insertBefore(a.getDom(b),a.getDom(c)),this}},{key:"createChild",value:function(b,c){var d=m["default"].insertHtml(c===!0?"afterBegin":"beforeEnd",this.dom,b);return a.fly(d)}},{key:"setVisible",value:function(a,b){return this.dom.style.display=a?b?"flex":"block":"none",this}},{key:"isVisible",value:function(a){var b=A(this.dom,"display"),c=!!b&&"none"!==b;return c&&a&&"BODY"!==this.dom.tagName&&(c=this.parent().isVisible(!0)),c}},{key:"getStyle",value:function(a){return A(this.dom,a)}},{key:"show",value:function(){return this.setVisible(!0)}},{key:"hide",value:function(){return this.setVisible(!1)}},{key:"toggle",value:function(){return this.setVisible(!this.isVisible())}},{key:"each",value:function(b,c){for(var d=this.dom.childNodes,e=d.length,f=0,g=0;e>g;++g){var h=n.isFunction(d)?d(g):d[g];if(1===h.nodeType){f++;var i=h.id?a.get(h):a.fly(h);if(b.call(c||this,i,f)===!1)return}}}},{key:"matchNode",value:function(b,c){for(var d=this.dom[c];d;){if(1===d.nodeType)return a.get(d);d=d[b]}return null}},{key:"first",value:function(){return this.matchNode("nextSibling","firstChild")}},{key:"last",value:function(){return this.matchNode("previousSibling","lastChild")}},{key:"prev",value:function(){return this.matchNode("previousSibling","previousSibling")}},{key:"next",value:function(){return this.matchNode("nextSibling","nextSibling")}},{key:"parent",value:function(){return this.matchNode("parentNode","parentNode")}},{key:"childAt",value:function(b){for(var c,d=0,e=0,f=this.dom.childNodes,g=f.length;g>e;e++)if(c=f.item(e),1===c.nodeType){if(d===+b)return a.get(c);d++}return null}},{key:"up",value:function(a){for(var b=this;b;){if(b.hasClass(a))return b;b=b.parent()}}},{key:"matchElement",value:function(a,b,c){for(var d=c?this[c]():this;d;){if(a(d))return d;d=d[b]()}return null}},{key:"hasAttr",value:function(a){var b=a.split("="),c=this.dom.getAttribute(b[0]);return!(!c||b[1]&&c!==b[1])}},{key:"inside",value:function(a){for(var b=this;b;){if(b.hasAttr(a))return b;b=b.parent()}}},{key:"offset",value:function(){var a=this.getBoundingClientRect(),b=this.dom.ownerDocument,c=b.documentElement,d=a.top+(window.pageYOffset||c.scrollTop),e=a.left+(window.pageXOffset||c.scrollLeft);return{top:d,left:e}}},{key:"getBoundingClientRect",value:function(){var a={top:0,left:0,width:this.dom.offsetWidth,height:this.dom.offsetHeight};if(a.x=a.left,a.y=a.top,a.right=a.width,a.bottom=a.height,"getBoundingClientRect"in document.documentElement)try{a=this.dom.getBoundingClientRect(),a.x/=n.zoom,a.y/=n.zoom,a.width/=n.zoom,a.height/=n.zoom}catch(b){}return a}},{key:"offsetBy",value:function(b,c){for(var d=a.getDom(b),e=this.dom.offsetParent,f=e.scrollTop,g=e.scrollLeft,h=this.dom.offsetLeft,i=this.dom.offsetTop;e&&e!==d;)h+=e.offsetLeft,i+=e.offsetTop,e=e.offsetParent,g+=e.scrollLeft,f+=e.scrollTop;return{left:h-(c?g:0),top:i-(c?f:0)}}},{key:"__removeDom",value:function(a){"BODY"!==a.tagName&&a.parentNode&&a.parentNode.removeChild(a)}},{key:"remove",value:function(){this._maskEl&&(this._maskEl.remove(),this._maskEl=null),s.remove(this),this.__removeDom(this.dom),this.dom=null}},{key:"isAncestor",value:function(b){var c=a.getDom(b);if(c&&c.contains)try{return c.contains(this.dom)}catch(d){}else if(c){for(var e=this.dom.parentNode;e&&e!==document;){if(c===e)return!0;e=e.parentNode}return!1}}},{key:"contains",value:function(b){return a.fly(b).isAncestor(this)}},{key:"getSelector",value:function(b){return a.get(this.dom.querySelector(b))}},{key:"matchSelector",value:function(a){return this.dom.matches(a)}},{key:"equals",value:function(a){return this.dom===a.dom}},{key:"setStyle",value:function(a,b){var c,d,e=a,f=b;n.isObject(e)||(c={},c[e]=f,e=c);for(d in e)f=e[d],B(d,f,this)||(this.dom.style[y(d)]=f);return this}},{key:"setTransform",value:function(a){this.dom.style.transform=a,this.dom.style["-webkit-transform"]=a,this.dom.style["-moz-transform"]=a,this.dom.style["-o-transform"]=a,this.dom.style["-ms-transform"]=a}},{key:"setTransition",value:function(a){this.dom.style.transition=a,this.dom.style["-webkit-transition"]=a,this.dom.style["-moz-transition"]=a,this.dom.style["-o-transition"]=a,this.dom.style["-ms-transition"]=a}},{key:"setOpacity",value:function(a){var b=this,c=b.dom.style;return n.isIE?(c.zoom=1,c.filter=(c.filter||"").replace(/alpha\([^)]*\)/gi,"")+(1===a?"":" alpha(opacity="+100*a+")")):c.opacity=a,b}}],[{key:"getDom",value:function(b){return b instanceof a?b.dom:"string"==typeof b?document.getElementById(b):b}},{key:"generateId",value:function(){return this.buildId("gen-"+C++)}},{key:"buildId",value:function(a){return"im-webim-"+a}},{key:"fly",value:function(b){return b instanceof a?b:new a(b)}},{key:"get",value:function(b){if(b instanceof a)return b;var c=this.getDom(b);if(c){var d=s.getElement(c.id);return d||(d=new a(c)),d}return null}}]),a}(),E={fly:function(a){return D.fly(a)},get:function(a){return D.get(a)},getSelector:function(a){return D.get(document.querySelector(a))},getBody:function(){return new D(document.body)},getDoc:function(){return new D(document)},initOverlay:function(){this._overlay||(this._overlay=this.getBody().appendChild(document.createElement("div")).addClass("im-overlay-layer"),this._overlay.on(["scroll","touchmove"],function(a){return a.stopEvent()}))},getOverlay:function(){return this.initOverlay(),this._overlay},runGarbageCollector:function(){setInterval(s.garbageCollect.bind(s),3e4)},generateId:function(){return D.generateId()}},F=E;c["default"]=F},{"../util/Array":11,"../util/DomHelper":14,"../util/EventA":15,"../util/Monitoring":21,"../util/Object":22,"../util/String":24}],6:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}var e=d(a("./core/UrlBuilder.js")),f=d(a("./util/util")),g=d(a("./core/Feature")),h=d(a("./core/element")),i=d(a("./core/Activatable")),j=d(a("./ui/ES6Component")),k=d(a("./ui/AvatarUploader")),l=d(a("./ui/GroupNameBlock")),m=d(a("./content/templates"));Object.assign(WebIM,{urlBuilder:e["default"]}),Object.assign(WebIM,{util:f["default"]}),Object.assign(WebIM,{tr:f["default"].tr}),Object.assign(WebIM,{Feature:g["default"]}),Object.assign(WebIM,{DomUtil:h["default"]}),Object.assign(WebIM,{Activatable:i["default"]}),Object.assign(WebIM,{TemplateDriver:m["default"],TD:m["default"]}),WebIM.ui=WebIM.ui||{},Object.assign(WebIM.ui,{ES6Component:j["default"]}),Object.assign(WebIM.ui,{AvatarUploader:k["default"]}),Object.assign(WebIM.ui,{GroupNameBlock:l["default"]})},{"./content/templates":1,"./core/Activatable":2,"./core/Feature":3,"./core/UrlBuilder.js":4,"./core/element":5,"./ui/AvatarUploader":7,"./ui/ES6Component":8,"./ui/GroupNameBlock":9,"./util/util":25}],7:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}function e(a){return(e="function"==typeof Symbol&&"symbol"===_typeof2(Symbol.iterator)?function(a){return _typeof2(a)}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":_typeof2(a)})(a)}function f(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function g(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function h(a,b,c){return b&&g(a.prototype,b),c&&g(a,c),a}function i(a,b){return!b||"object"!==e(b)&&"function"!=typeof b?j(a):b}function j(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function k(a,b,c){return(k="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(a,b,c){var d=l(a,b);if(d){var e=Object.getOwnPropertyDescriptor(d,b);return e.get?e.get.call(c):e.value}})(a,b,c||a)}function l(a,b){for(;!Object.prototype.hasOwnProperty.call(a,b)&&(a=m(a),null!==a););return a}function m(a){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)})(a)}function n(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),b&&o(a,b)}function o(a,b){return(o=Object.setPrototypeOf||function(a,b){return a.__proto__=b,a})(a,b)}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var p=d(a("./ES6Component")),q=d(a("../content/templates")),r=d(a("../util/util")),s=WebIM,t=function(a){function b(a){var c;f(this,b),a=a||{};var d={inputSelector:'input[type="file"]',avatarSelector:".imAvatar"};return s.applyIf(a,d),c=i(this,m(b).call(this,a)),c._avatarReady=!0,c._avatarUploading=!1,c._avatarId="",c._avatarUploadingPromise=null,c.autoEl={html:'<div class="imAvatar"></div><input type="file"/>'},c.changeEvent=new r["default"].Event,c}return n(b,a),h(b,[{key:"_onAfterRender",value:function(){this.avatarInput=this.el.getSelector(this.initialConfig.inputSelector),this.avatarBlock=this.el.getSelector(this.initialConfig.avatarSelector),this.avatarInput.on("change",this._onAvatarChange,this)}},{key:"_onAvatarChange",value:function(){var a=this,b=this.avatarInput.dom,c=b.files,d=c&&c[0];if(d){if(!(d.type||"").match(/^image\/(?:jpeg|png|gif)$/)||d.size>s.Ava.MAX_FILE_SIZE)return d.size>s.Ava.MAX_FILE_SIZE&&s.showPopup(r["default"].tr("file.errorFileTooLarge")),this.avatarInput.dom.value=null,void this.changeEvent.fire(!1);if(this._avatarReady=!1,this._avatarId="",window.File&&window.FileReader&&window.FileList&&window.Blob&&d){var e=new FileReader;e.onload=function(b){var c=b.target.result;if(a.avatarBlock){var d="width:56px;height:56px;background-image:url(data:image/png;base64,"+btoa(c)+");";a.avatarBlock.updateHTML(q["default"].parseSafe("avatar",[d,"","","",""])),a.changeEvent.fire(!0),a.el.addClass("im-avatar-uploader_loaded")}},e.readAsBinaryString(d)}}}},{key:"getLoaded",value:function(){var a=this.avatarInput&&this.avatarInput.dom.files;return a&&a[0]}},{key:"getUploaded",value:function(){return this._avatarId}},{key:"resetAvatar",value:function(){this.avatarBlock&&this.avatarInput&&(this.avatarInput.dom.value=null,this.el.removeClass("im-avatar-uploader_loaded"),this.avatarBlock.updateText(""),this.changeEvent.fire(!1)),this._avatarReady=!0,this._avatarId="",this._avatarUploading=!1,this._avatarUploadingPromise=null}},{key:"uploadSelected",value:function(){var a=this;return this._avatarUploadingPromise=new Promise(function(b){return!a.avatarInput.dom.value||a._avatarReady?b({avatarId:a._avatarId}):a._avatarUploading?void(a._avatarUploadingPromise?a._avatarUploadingPromise.then(b):b({avatarId:a._avatarId})):(a._avatarUploading=!0,void s.rapi.uploadAvatar(a.avatarInput.dom.files[0],{creating:1}).then(function(c){a._avatarUploading=!1,a._avatarReady=!0,a._avatarId=c.id,b({avatarId:a._avatarId})},function(c){a.resetAvatar(),b({error:c})}))})}},{key:"setAvatarHtml",value:function(a){this.avatarBlock&&(this.resetAvatar(),this.avatarBlock.updateHTML(a))}},{key:"destroy",value:function(){this._avatarReady=!0,this._avatarId="",this._avatarUploading=!1,this._avatarUploadingPromise=null,this.avatarInput&&(this.avatarInput.un("change",this._onAvatarChange,this),this.avatarInput.dom.value=null,this.avatarInput=null),this.avatarBlock=null,k(m(b.prototype),"destroy",this).call(this)}}]),b}(p["default"]),u=t;c["default"]=u},{"../content/templates":1,"../util/util":25,"./ES6Component":8}],8:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function f(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function g(a,b,c){return b&&f(a.prototype,b),c&&f(a,c),a}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var h=d(a("../util/util")),i=d(a("../core/element")),j=WebIM,k={visibility:{isVisible:function(){var a=this.getStyle("visibility");return"visible"===a},setVisible:function(a){return this.dom.style.visibility=a?"visible":"hidden",this}}},l=function(){function a(b){e(this,a),this.autoEl=null,this.overlayEl=null,this.initialConfig=b||{},this.id=this.initialConfig.id,this.hotKeyLayerConfig={name:this.id||i["default"].generateId(),overlayOnHandle:!0,activateOnCreate:!0},this.rendered=!1,this.bound=!1,this.autoRender=this.initialConfig.autoRender||!1,this.beforeShowEvent=new h["default"].Event,this.beforeShowEvent.on(this._onBeforeShow,this),this.beforeHideEvent=new h["default"].Event,this.beforeHideEvent.on(this._onBeforeHide,this),this.showEvent=new h["default"].Event,this.showEvent.on(this._onShow,this),this.hideEvent=new h["default"].Event,this.hideEvent.on(this._onHide,this),this.renderEvent=new h["default"].Event,this.initComponent()}return g(a,[{key:"getId",value:function(){if(!this.id)if(this.el){var a=this.el.getId();a?this.id=a:this.id=this.el.dom.id=i["default"].generateId()}else this.id=i["default"].generateId();return this.id}},{key:"getEl",value:function(){return this.el}},{key:"initComponent",value:function(){}},{key:"render",value:function(a,b){this.container=i["default"].get(a),this.el||(this.bound=!!b,this.autoEl?this.el=b&&i["default"].get(b)||this.container.createChild(this.autoEl):this._onRender(this.container,b));var c=this.el.getId();if(c?this.id&&this.id!==c?j.error("Different ids: "+this.id+", "+c):this.id=c:this.id&&(this.el.dom.id=this.id),this.initialConfig.cls&&this.el.addClass(this.initialConfig.cls),this.initialConfig.fadeIn&&!j.isIE,this.initialConfig.toggleMethod in k){var d=k[this.initialConfig.toggleMethod];this.el.isVisible=d.isVisible,this.el.setVisible=d.setVisible}"function"==typeof this.initialConfig.isVisibleFunction&&(this.el.isVisible=this.initialConfig.isVisibleFunction),"function"==typeof this.initialConfig.setVisibleFunction&&(this.el.setVisible=this.initialConfig.setVisibleFunction),this.rendered=!0,this._onAfterRender(),this.renderEvent.fire(this)}},{key:"_onRender",value:function(a){j.abstractError()}},{key:"_onAfterRender",value:function(){}},{key:"isVisible",value:function(){return this.rendered&&this.el.isVisible()}},{key:"setVisible",value:function(a){if(!this.rendered&&this.autoRender!==!1&&a&&this.render(j.isBoolean(this.autoRender)?i["default"].getBody():this.autoRender),a!==this.isVisible()){var b=a?"show":"hide",c=this["before"+h["default"].String.capitalize(b)+"Event"];if(c.fire(this)!==!1){this.el.setVisible(a,!!this.initialConfig.displayFlex);var d=this[b+"Event"];d.fire(this)}return this}}},{key:"toggle",value:function(){this.setVisible(!this.isVisible())}},{key:"show",value:function(){return this.setVisible(!0)}},{key:"hide",value:function(){return this.setVisible(!1)}},{key:"_onBeforeShow",value:function(a){}},{key:"_onBeforeHide",value:function(a){}},{key:"_onShow",value:function(a){this.initialConfig.modal&&(i["default"].initOverlay(),(this.initialConfig.overlay||this.container).addClass("im-overlay"),this.initialConfig.modalClass&&(this.initialConfig.overlay||this.container).addClass(this.initialConfig.modalClass)),this.initialConfig.hideOnEscape&&(j.hotKeyManager.on("esc",{handler:this._onEscape,scope:this},this.hotKeyLayerConfig.name,this.hotKeyLayerConfig),App.on("navigation:back",this._onBack,this))}},{key:"_onBack",value:function(a){return this.hide(),a&&a.canStop?!1:void 0}},{key:"_onHide",value:function(a){this.initialConfig.modal&&((this.initialConfig.overlay||this.container).removeClass("im-overlay"),this.initialConfig.modalClass&&(this.initialConfig.overlay||this.container).removeClass(this.initialConfig.modalClass),this.overlayEl&&this.overlayEl.remove()),j.hotKeyManager.un("esc",{handler:this._onEscape,scope:this},this.hotKeyLayerConfig.name),j.hotKeyManager.removeLayer(this.hotKeyLayerConfig.name),App.off("navigation:back",this._onBack,this)}},{key:"_onEscape",value:function(a){this.initialConfig.hideOnEscape&&this.hide()}},{key:"destroy",value:function(){this.initialConfig.modal&&(this.initialConfig.overlay||this.container)&&((this.initialConfig.overlay||this.container).removeClass("im-overlay"),this.initialConfig.modalClass&&(this.initialConfig.overlay||this.container).removeClass(this.initialConfig.modalClass),this.overlayEl&&this.overlayEl.remove()),this.initialConfig.hideOnEscape&&(i["default"].getDoc().un("keydown",this._onEscape,this),j.hotKeyManager.clearForce(this.hotKeyLayerConfig.name)),j.hotKeyManager.removeLayer(this.hotKeyLayerConfig.name),this.initialConfig=null,this.beforeShowEvent.removeAll(),this.beforeShowEvent=null,this.beforeHideEvent.removeAll(),this.beforeHideEvent=null,this.showEvent.removeAll(),this.showEvent=null,this.hideEvent.removeAll(),this.hideEvent=null,this.renderEvent.removeAll(),this.renderEvent=null,this.container=null,this.rendered&&(this.bound||this.el.remove(),this.el=null,this.rendered=!1,this.bound=!1)}}]),a}(),m=l;c["default"]=m},{"../core/element":5,"../util/util":25}],9:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}function e(a){return(e="function"==typeof Symbol&&"symbol"===_typeof2(Symbol.iterator)?function(a){return _typeof2(a)}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":_typeof2(a)})(a)}function f(a){for(var b=1;b<arguments.length;b++){var c=null!=arguments[b]?arguments[b]:{},d=Object.keys(c);"function"==typeof Object.getOwnPropertySymbols&&(d=d.concat(Object.getOwnPropertySymbols(c).filter(function(a){return Object.getOwnPropertyDescriptor(c,a).enumerable}))),d.forEach(function(b){g(a,b,c[b])})}return a}function g(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function h(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function i(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function j(a,b,c){return b&&i(a.prototype,b),c&&i(a,c),a}function k(a,b){return!b||"object"!==e(b)&&"function"!=typeof b?l(a):b}function l(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function m(a,b,c){return(m="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(a,b,c){var d=n(a,b);if(d){var e=Object.getOwnPropertyDescriptor(d,b);return e.get?e.get.call(c):e.value}})(a,b,c||a)}function n(a,b){for(;!Object.prototype.hasOwnProperty.call(a,b)&&(a=o(a),null!==a););return a}function o(a){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)})(a)}function p(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),b&&q(a,b)}function q(a,b){return(q=Object.setPrototypeOf||function(a,b){return a.__proto__=b,a})(a,b)}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var r=d(a("../util/util")),s=d(a("../content/templates")),t=d(a("./AvatarUploader")),u=d(a("./ES6Component")),v=WebIM,w=function(a){function b(){var a,c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return h(this,b),v.applyIf(c,{resetOnClick:!0,editAvatar:!0,placeHolder:"",chatName:""}),a=k(this,o(b).call(this,c)),a.autoEl={cls:"im-create-group__name",html:s["default"].parseSafe("groupNameField",{placeHolder:c.placeHolder})},a._firstNameLetter="",a._nameValue="",a.nameField=null,a.avatarUploader=null,a.changeEvent=new r["default"].Event,c.editAvatar&&(a.avatarUploader=new t["default"]({avatarSelector:".imGroupAvatar"})),a}return p(b,a),j(b,[{key:"_onAfterRender",value:function(){var a=this.el.getSelector(".imGroupAvatarBlock");a&&(this.avatarUploader?(this.avatarUploader.render(this.el,a),this.avatarUploader.el&&this.avatarUploader.el.on("click",this._onAvatarClick,this)):a.hide()),this.nameField=this.el.getSelector(".imGroupNameField"),this.initialConfig.chatName&&(this.nameField.dom.value=this.initialConfig.chatName,this._onNameChange()),this.nameField.on("input",this._onNameChange,this)}},{key:"_onAvatarClick",value:function(a){this.initialConfig.resetOnClick&&this.avatarUploader.getLoaded()&&(this.avatarUploader.resetAvatar(),this._firstNameLetter="",this._onNameChange(),a.stopEvent())}},{key:"_onNameChange",value:function(){if(this._nameValue=this.nameField.dom.value.replace(/^[\s\t\n]+|[\s\t\n]+$/,""),this.avatarUploader)if(this._nameValue){var a=this._nameValue,b=v.Emoji.shift(a)||a.charAt(0).toUpperCase();if(this._firstNameLetter!==b&&(this._firstNameLetter=b,!this.avatarUploader.getLoaded())){var c=this.avatarUploader.avatarInput.getStyle("color"),d=v.Ava.flyLetter(a,56,c);this.avatarUploader.setAvatarHtml(d)}}else this._firstNameLetter&&(this._firstNameLetter="",this.avatarUploader.getLoaded()||this.avatarUploader.setAvatarHtml(""));this.changeEvent.fire(this._nameValue)}},{key:"focus",value:function(){this.nameField&&this.nameField.dom.focus()}},{key:"getName",value:function(){return this._nameValue}},{key:"setName",value:function(a){this.nameField&&(this.nameField.dom.value=a||"",this._onNameChange())}},{key:"uploadAvatar",value:function(){var a=this;return(this.avatarUploader?this.avatarUploader.uploadSelected():Promise.resolve()).then(function(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return f({name:a._nameValue},b)})}},{key:"destroy",value:function(){this.avatarUploader&&(this.avatarUploader.el&&this.avatarUploader.el.un("click",this._onAvatarClick,this),this.avatarUploader.destroy(),this.avatarUploader=null),this.nameField&&(this.nameField.un("input",this._onNameChange,this),this.nameField=null),this.changeEvent.removeAll(),this.changeEvent=null,m(o(b.prototype),"destroy",this).call(this)}}]),b}(u["default"]),x=w;c["default"]=x},{"../content/templates":1,"../util/util":25,"./AvatarUploader":7,"./ES6Component":8}],10:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}function e(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function f(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function g(a,b,c){return b&&f(a.prototype,b),c&&f(a,c),a}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var h=d(a("./Object.js")),i=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){setTimeout(a,1e3/60)},j=function(){function a(){e(this,a),this._onFrameScope=this._onFrame.bind(this),this._list={},this._index=-1}return g(a,[{key:"_requestFrame",value:function(){i(this._onFrameScope)}},{key:"start",value:function(a,b,c,d,e){return a!==b?(this._started||(this._started=!0,this._requestFrame()),this._index++,this._list[this._index]={from:a,to:b,pxPerMs:c,cb:d,scope:e,date:+new Date,first:!0},this._index):void 0}},{key:"clear",value:function(a){delete this._list[a]}},{key:"_onFrame",value:function(){var a=0;h["default"].each(this._list,function(b,c){a++;var d,e=(+new Date-b.date)*b.pxPerMs,f=!1;b.from<b.to?(d=b.from+e,d>b.to&&(f=!0,d=b.to)):(d=b.from-e,d<b.to&&(f=!0,d=b.to)),b.cb.call(b.scope||window,d,f,b.first),b.first=!1,f&&this.clear(c)},this),a?this._requestFrame():this._started=!1}}]),a}(),k=j;c["default"]=k},{"./Object.js":22}],11:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var d={each:function(a,b,c){for(var d=a.length,e=0;d>e;++e)if(b.call(c||window,a[e],e,a)===!1)return;return a},unique:function(a){var b=[];return d.each(a,function(a){-1===d.indexOf(b,a)&&b.push(a)}),b},eachReverse:function(a,b){for(var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:window,d=a.length;d--;)if(b.call(c,a[d],d,a)===!1)return},transform:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:window,e=[];return d.each(a,function(){for(var a=arguments.length,d=new Array(a),f=0;a>f;f++)d[f]=arguments[f];var g=b.apply(c,d);e.push(g)},c),e},filter:function(a,b,c){var e=[];return d.each(a,function(a){for(var d=arguments.length,f=new Array(d>1?d-1:0),g=1;d>g;g++)f[g-1]=arguments[g];b.call.apply(b,[c,a].concat(f))&&e.push(a)},c),e},indexOf:function(a,b){var c=null;return c=b instanceof RegExp?function(a){return b.test(a)}:function(a){return b===a},d.indexOfBy(a,c)},indexOfBy:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:window,e=-1;return d.each(a,function(d,f){return b.call(c,d,f,a)===!0?(e=f,!1):void 0}),e},findBy:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:window,e=d.indexOfBy(a,b,c);return-1===e?null:a[e]},removeAt:function(a,b){return a.splice(b,1),a},remove:function(a,b){var c=d.indexOf(a,b);return-1===c?a:d.removeAt(a,c)},removeBy:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:window,e=d.indexOfBy(a,b,c);return-1===e?null:d.removeAt(a,e)},clone:function(a){return Array.prototype.slice.call(a)}},e=d;c["default"]=e},{}],12:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var d=WebIM,e={OUT_DAY_OR_TIME:0,formatDurationTime:function(a){return"".concat(Math.floor(a/3600),":").concat(Math.floor(a%3600/60),":").concat(Math.floor(a%3600%60)).replace(/^0:?/,"").replace(/(^|:)(\d)(?=:|$)/g,"$10$2")},formatPlainTime:function(a){return(a.getHours()+":"+a.getMinutes()).replace(/(^|:)(\d)(?=:|$)/g,"$10$2")},formatPlainDate:function(a){var b=".",c=[a.getDate(),a.getMonth()+1,(a.getFullYear()+"").slice(-2)];return c[1]<10&&(c[1]="0"+c[1]),c.join(b)},formatNicely:function(a,b){var c=new Date(1e3*a);b=b||new Date;var f=e.formatPlainDate(c);if(c.getFullYear()===b.getFullYear()){var g=new Date(b-1e3*d.DAY);f=c.getMonth()===g.getMonth()&&c.getDate()===g.getDate()?d.tr("time.yesterday"):Math.floor(b/1e3)-a<d.DAY?e.formatPlainTime(c):c.getDate()+" "+d.tr(c.getMonth()+1,{scope:"month_gen"}).substr(0,3)}return f},formatDateTime:function(a,b){var c=new Date(1e3*a),f=e.formatPlainDate(c),g=Math.floor(new Date/1e3);switch(b){case e.OUT_DAY_OR_TIME:default:g-a<d.DAY?f=e.formatPlainTime(c):g-a<d.YEAR&&(f=c.getDate()+" "+d.tr(c.getMonth()+1,{scope:"month_gen"}).substr(0,3))}return f},getTimeFromMidnight:function(a){return 1e3*(d.HOUR*a.getHours()+d.MINUTE*a.getMinutes()+a.getSeconds())},formatDate:function(a){var b=new Date(+a),c=b.toTimeString().replace(/:\d\d(\s(?:AM|PM))?(?:\s.*)?$/i,"$1"),d=".",e=b.getDate(),f=b.getMonth()+1;f+="",1===f.length&&(f="0"+f);var g=b.getFullYear()+"";return c=e+d+f+d+g+" "+c},formatTime:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Date,c=(b-a)/6e4,f=new Date(a),g=e.formatDate(a).split(" "),h={day:d.tr(f.getDay(),{scope:"at_day"}),date:g[0].replace(/^(\d+\.\d+\.)(\d+)?(\d\d)$/,"$1$3"),fullDate:g[0],time:g[1]};h.dateString=g[0].replace(/(\d+)\.(\d+)\.\d+/,function(a,b,c){return h.dateShortString=b+" "+d.tr(+c,{scope:"short_month_gen"}),b+" "+d.tr(+c,{scope:"month_gen"})});var i=e.getTimeFromMidnight(b)/6e4,j=b.getDate()===f.getDate();return 1>c?(h.now=!0,h.value=WebIM.tr("time.justNow")):1>c/60?(h.minutes=!0,h.value=WebIM.tr("time.minutes",{count:Math.floor(c)})):1>c/1440&&j?(h.hours=!0,h.value=WebIM.tr("time.hours",{count:Math.floor(c/60)})):1>c/(i+1440)&&!j?(h.yesterday=!0,h.value=WebIM.tr("time.yesterday")):h.value=h.dateString,h},formatLastSeenData:function(a){var b=new Date(1e3*a),c=new Date,f=e.formatTime(1e3*a),g="dialog.lastVisit";return f.now?f=d.tr(g,{date:d.tr("dialog.date",{date:f.value})}):f.minutes?f=d.tr(g,{date:d.tr("dialog.date",{date:f.value+d.tr("notify.timeElapsed")})}):f.hours?f=d.tr(g,{atTime:d.tr("dialog.atTime",{time:f.time})}).replace(/\s{2,}/g," "):c.getTime()-b.getTime()<7*d.DAY*1e3?(f.yesterday?f.value=d.tr("dialog.date",{date:d.tr("time.yesterday")}):f.value=f.day,f=d.tr(g,{date:f.value,atTime:d.tr("dialog.atTime",{time:f.time})})):c.getFullYear()>b.getFullYear()?f=c.getTime()-b.getTime()>365*d.DAY*1e3?d.tr(g,{date:d.tr("dialog.longTimeAgo")}):d.tr(g,{date:d.tr("dialog.date",{date:f.dateShortString+" "+b.getFullYear()})}):(f.value=d.tr("dialog.date",{date:f.value}),f=d.tr(g,{date:f.value,atTime:d.tr("dialog.atTime",{time:f.time})})),f},formatMessageDate:function(a,b,c){var f=new Date(1e3*a);b||(b=new Date),c||(c=e.getTimeFromMidnight(b));var g=b.getTime()-f.getTime();return f=c>g?WebIM.tr("time.today"):c+864e5>g?WebIM.tr("time.yesterday"):f.getDate()+" "+d.tr(f.getMonth()+1,{scope:"month_gen"})+(f.getFullYear()<b.getFullYear()?" "+f.getFullYear():"")}},f=e;c["default"]=f},{}],13:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function f(a,b,c){return b&&e(a.prototype,b),c&&e(a,c),a}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var g=function(){function a(b){d(this,a),WebIM.apply(this,b),this.id=null,this.fn&&this._initFn(this.fn,this.scope)}return f(a,[{key:"_initFn",value:function(a,b){this.scope=b||this.scope||this,this.fn=a.bind(this.scope)}},{key:"isStarted",value:function(){return null!=this.id}},{key:"start",value:function(a,b,c){this.isStarted()&&this.stop(),"number"==typeof a&&a>=0&&(this.interval=a),b&&this._initFn(b,c),this.id=setTimeout(this.fn,this.interval)}},{key:"startNow",value:function(){this.fn(),this.start.apply(this,arguments)}},{key:"stop",value:function(){this.isStarted()&&(clearTimeout(this.id),this.id=null)}}]),a}(),h=g;c["default"]=h},{}],14:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var e,f=d(a("./Object.js")),g=d(a("./Array")),h=d(a("../core/element")),i=WebIM,j=/^(?:br|frame|hr|img|input|link|meta|range|spacer|wbr|area|param|col)/i,k=function(){return document.createElement("div")},l=function o(a){var b="";if(i.isString(a))b=a;else if(i.isArray(a))g["default"].each(a,function(a){b+=o(a)});else{var c=a.tag||"div";b="<"+c;var d=[];f["default"].each(a,function(a,b){-1===g["default"].indexOf(["tag","children","html"],b)&&d.push(("cls"===b?"class":b)+'="'+a+'"')}),d.length>0&&(b+=" "+d.join(" ")),j.test(c)?b+="/>":(b+=">",a.children?b+=o(a.children):a.html&&(b+=a.html),b+="</"+c+">")}return b},m={createDiv:function(){return h["default"].fly(k())},elementFromPoint:function(a,b){return h["default"].get(document.elementFromPoint(a*i.zoom,b*i.zoom));
},elementFromHtml:function(a){var b;return e||(e=k()),e.innerHTML=a,b=e.getElementsByTagName("*")[0],b&&e.removeChild(b),e.innerHTML="",b},append:function(a,b,c){return m.insertHtml("beforeEnd",a,b,c)},insertHtml:function(a,b,c,d){var e,f,g,j,k,m,n={},o=a.toLowerCase(),p=l(c);return n.beforebegin=["BeforeBegin","previousSibling"],n.afterend=["AfterEnd","nextSibling"],b.insertAdjacentHTML?(n.afterbegin=["AfterBegin","firstChild"],n.beforeend=["BeforeEnd","lastChild"],(e=n[o])?(b.insertAdjacentHTML(e[0],p),m=b[e[1]],d?h["default"].get(m):m):void i.error('Illegal insertion point -> "'+o+'"')):(g=b.ownerDocument.createRange(),f="setStart"+(/end/i.test(o)?"After":"Before"),n[o]?(g[f](b),j=g.createContextualFragment(p),b.parentNode.insertBefore(j,"beforebegin"===o?b:b.nextSibling),m=b[("beforebegin"===o?"previous":"next")+"Sibling"],d?h["default"].get(m):m):(k=("afterbegin"===o?"first":"last")+"Child",b.firstChild?(g[f](b[k]),j=g.createContextualFragment(p),"afterbegin"===o?b.insertBefore(j,b.firstChild):b.appendChild(j)):b.innerHTML=p,m=b[k],d?h["default"].get(m):m))},testUrlAsImage:function(a,b){function c(){j("error",d),j("load",e)}function d(){c(),h.call(f,a,!1)}function e(){c(),"undefined"!=typeof g.naturalWidth&&(g.width=g.naturalWidth,g.height=g.naturalHeight),h.call(f,a,g)}var f=arguments.length>2&&void 0!==arguments[2]?arguments[2]:window,g=new Image,h="function"==typeof b?b:function(){};"function"==typeof h||(h=function(){});var i,j;return"function"==typeof g.addEventListener?(i=function(a,b){g.addEventListener(a,b)},j=function(a,b){g.removeEventListener(a,b)}):g.attachEvent?(i=function(a,b){g.attachEvent("on"+a,b)},j=function(a,b){g.detachEvent("on"+a,b)}):(i=function(a,b){g["on"+a]=b},j=function(a){g["on"+a]=void 0}),i("error",d),i("load",e),g.src=a,g},htmlTree:function(a,b){var c,d=a||document.getElementsByTagName("body")[0];if(d.hasChildNodes())for(c=d.firstChild;c;)1===c.nodeType&&(m.htmlTree(c,b),b(c)),c=c.nextSibling;return d},getWindowSize:function(){var a,b;return document.body&&document.body.offsetWidth&&(a=document.body.offsetWidth,b=document.body.offsetHeight),"CSS1Compat"===document.compatMode&&document.documentElement&&document.documentElement.offsetWidth&&(a=document.documentElement.offsetWidth,b=document.documentElement.offsetHeight),window.innerWidth&&window.innerHeight&&(a=window.innerWidth,b=window.innerHeight),{width:a,height:b}}},n=m;c["default"]=n},{"../core/element":5,"./Array":11,"./Object.js":22}],15:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}function e(a){return(e="function"==typeof Symbol&&"symbol"===_typeof2(Symbol.iterator)?function(a){return _typeof2(a)}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":_typeof2(a)})(a)}function f(a,b){return!b||"object"!==e(b)&&"function"!=typeof b?g(a):b}function g(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function h(a,b,c){return(h="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(a,b,c){var d=i(a,b);if(d){var e=Object.getOwnPropertyDescriptor(d,b);return e.get?e.get.call(c):e.value}})(a,b,c||a)}function i(a,b){for(;!Object.prototype.hasOwnProperty.call(a,b)&&(a=j(a),null!==a););return a}function j(a){return(j=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)})(a)}function k(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),b&&l(a,b)}function l(a,b){return(l=Object.setPrototypeOf||function(a,b){return a.__proto__=b,a})(a,b)}function m(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function n(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function o(a,b,c){return b&&n(a.prototype,b),c&&n(a,c),a}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var p=d(a("./Array")),q=WebIM;q.globalEvents={};var r=function(){function a(b,c){m(this,a),this.fn=b,this.scope=c}return o(a,[{key:"equals",value:function(a,b){if(this.fn===a){if(!b)return!0;if(this.scope===b)return!0}}},{key:"invoke",value:function(a){return this.fn?this.fn.apply(this.scope||window,a):void 0}},{key:"destroy",value:function(){delete this.fn,delete this.scope}}]),a}(),s=function(a){function b(a,c,d){var e;return m(this,b),e=f(this,j(b).call(this,a,c)),e.owner=d,e}return k(b,a),o(b,[{key:"invoke",value:function(a){var c=h(j(b.prototype),"invoke",this).call(this,a);return this.owner.removeListener(this.fn,this.scope),c}},{key:"destroy",value:function(){delete this.owner,h(j(b.prototype),"destroy",this).call(this)}}]),b}(r),t=function(){function a(){m(this,a),this.suspended=!1,this.listeners=[]}return o(a,[{key:"hasListeners",value:function(){return this.listeners.length>0}},{key:"addListener",value:function(a,b,c){c=c||{};var d;return d=c.single===!0?new s(a,b,this):new r(a,b),this.listeners.push(d),this}},{key:"on",value:function(a,b,c){return this.addListener(a,b,c)}},{key:"findListener",value:function(a,b){return p["default"].indexOfBy(this.listeners,function(c){return c.equals(a,b)})}},{key:"removeListener",value:function(a,b){var c=this.findListener(a,b);if(-1!==c){var d=this.listeners[c];d.destroy(),this.firing,this.listeners.splice(c,1)}return this}},{key:"un",value:function(a,b){return this.removeListener(a,b)}},{key:"fire",value:function(){for(var a=arguments.length,b=new Array(a),c=0;a>c;c++)b[c]=arguments[c];var d=!0;if(!this.suspended){this.firing=!0;var e=this.listeners.slice(0);e.forEach(function(a){return a.invoke(b)===!1?d=!1:void 0}),this.firing=!1,this._needRemoveAll&&(delete this._needRemoveAll,this.removeAll())}return d}},{key:"removeAll",value:function(){if(this.firing)this._needRemoveAll=!0;else for(;this.listeners.length>0;){var a=this.listeners.shift();a.destroy()}}},{key:"relay",value:function(a){var b=this;return a.on(function(){return b.fire.apply(b,arguments)}),this}},{key:"globalize",value:function(b){return q.globalEvents[b]||(q.globalEvents[b]=new a),q.globalEvents[b].relay(this),this}},{key:"suspend",value:function(){this.suspended=!0}},{key:"resume",value:function(){this.suspended=!1}}]),a}(),u=t;c["default"]=u},{"./Array":11}],16:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}function e(a){return(e="function"==typeof Symbol&&"symbol"===_typeof2(Symbol.iterator)?function(a){return _typeof2(a)}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":_typeof2(a)})(a)}function f(a){return i(a)||h(a)||g()}function g(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function h(a){return Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a)?Array.from(a):void 0}function i(a){if(Array.isArray(a)){for(var b=0,c=new Array(a.length);b<a.length;b++)c[b]=a[b];return c}}function j(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function k(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function l(a,b,c){return b&&k(a.prototype,b),c&&k(a,c),a}function m(a,b){return!b||"object"!==e(b)&&"function"!=typeof b?n(a):b}function n(a){if(void 0===a)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return a}function o(a){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(a){return a.__proto__||Object.getPrototypeOf(a)})(a)}function p(a,b){if("function"!=typeof b&&null!==b)throw new TypeError("Super expression must either be null or a function");a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,writable:!0,configurable:!0}}),b&&q(a,b)}function q(a,b){return(q=Object.setPrototypeOf||function(a,b){return a.__proto__=b,a})(a,b)}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var r=d(a("./EventA")),s=function(a){function b(){return j(this,b),m(this,o(b).apply(this,arguments))}return p(b,a),l(b,[{key:"fire",value:function(){for(var a=arguments.length,b=new Array(a),c=0;a>c;c++)b[c]=arguments[c];var d=!0;if(!this.suspended){this.firing=!0;var e=b.shift();e&&e.success&&(e=e.success.bind(e.scope||window));var g=0,h=function(){0===g&&e&&e()};b.push(function(){g--,h()});var i=f(this.listeners);i.forEach(function(a){var c=a.invoke(b);return c===!1?d=!1:void(c===!0&&g++)}),h(),this.firing=!1}return d}}]),b}(r["default"]),t=s;c["default"]=t},{"./EventA":15}],17:[function(a,b,c){"use strict";function d(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function e(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function f(a,b,c){return b&&e(a.prototype,b),c&&e(a,c),a}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var g=function(){function a(){d(this,a),this._listeners={}}return f(a,[{key:"addEventListener",value:function(a,b){this._listeners[a]||(this._listeners[a]=[]),this._listeners[a].push(b)}},{key:"dispatchEvent",value:function(a,b){this["on"+a]&&this["on"+a](b);var c=this._listeners[a];c&&c.forEach(function(a){a.call(window,b)})}},{key:"removeEventListener",value:function(a,b){var c=this._listeners[a];if(c){var d=[];c.forEach(function(a){a!==b&&d.push(a)}),this._listeners[a]=d}}},{key:"destroy",value:function(){}}]),a}(),h=g;c["default"]=h},{}],18:[function(a,b,c){"use strict";function d(a,b,c){var d,e=c+2+6;if(18761===a.getUint16(e))d=!1;else{if(19789!==a.getUint16(e))return!1;d=!0}if(42!==a.getUint16(e+2,!d))return!1;var f=a.getUint32(e+4,!d);if(8>f)return!1;for(var g=e+f,h=a.getUint16(g,!d),i=0;h>i;i++){var j=g+12*i+2;if(274===a.getUint16(j,!d)){var k=b.slice(c-2,g+2),l=b.slice(j,j+12);return new DataView(k).setUint16(2,k.byteLength+l.byteLength-2),[k,l]}}}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var e={cutDataFromJpeg:function(a){var b=new DataView(a),c=0,e=0,f=[],g=0;if(65496===b.getUint16(c)){c+=2;var h=b.getUint16(c);for(c+=2;c<b.byteLength;){if(65505===h)f[g]={recess:e,offset:c-2,replaceWith:d(b,a,c)},e=c+b.getUint16(c),g++;else if(65498===h)break;c+=b.getUint16(c),h=b.getUint16(c),c+=2}if(f.length>0){var i=[];return f.forEach(function(b){i.push(a.slice(b.recess,b.offset)),b.replaceWith&&b.replaceWith.forEach(function(a){i.push(a)})},this),i.push(a.slice(e)),new Blob(i,{type:"image/jpeg"})}}}},f=e;c["default"]=f},{}],19:[function(a,b,c){"use strict";function d(a){return(d="function"==typeof Symbol&&"symbol"===_typeof2(Symbol.iterator)?function(a){return _typeof2(a)}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":_typeof2(a)})(a)}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var e={favoriteCountries:"ru,kz",me:"Я",you:"Вы",to:"в",title:{icq:"ICQ New",icq_classic:"ICQ",agent:"Агент Mail.ru",myteam:"Myteam",messenger:"Мессенджер"},tabs:{chats:"Чаты",contacts:"Контакты",settings:"Настройки"},cl:{searchContacts:"Найти контакты",search:"Найти",hide:"Свернуть",closePopup:"Закрыть окно",openPopup:"Открыть в отдельном окне",options:"Настройки",makeCall:"Позвонить",turnOff:"Отключить",build:"Сборка {{0}}",photo:"Фото",video:"Видео",contact:"Контакт",voiceMessage:"Голосовое сообщение",noMessages:"Похоже, у вас пока нет сообщений",noContacts:"Похоже, у вас пока нет контактов",youHaveNoOpenedChatsYet:"У вас нет открытых чатов",emptyRecentListMessage:"Найдите коллегу по email и напишите ему",all:"Все",optAllContacts:"Все контакты",optSoundOff:"Отключить звуки",optSoundOn:"Включить звуки",optAvatarsOn:"Включить фото контактов",optAvatarsOff:"Отключить фото контактов",optPreviewsShow:"Показать картинки в диалогах",optPreviewsHide:"Скрыть картинки в диалогах",optSendByEnter:"Отправлять по Enter",optHideMessageTime:"Скрывать время сообщений",optShowNotifications:"Показывать оповещения",optShowNotificationsSwitchOnInfo:"Включите уведомления в настройках браузера",optHideNotificationsText:"Скрывать текст оповещений",optCommonSearch:"Общий поиск",optHotkeys:"Клавиши {{0}}",exit:"Выйти",noResults:"Результаты отсутствуют",editStatus:"Редактировать",contactIsNotExist:"К сожалению,  {{name}} с номером {{phone}} пока ещё не зарегистрирован в {{product}}.",addAnother:"Добавить другой",newContact:"Новый контакт",ignoreList:"Заблокированные контакты",hasNoIgnoreList:"У вас нет заблокированных контактов"},dialog:{favorite:"Избранное",openFavorite:"Открыть избранное",msgSentToFavorite:"Сообщение добавлено в {{0}}",typeMessage:"Напишите сообщение",message:"Сообщение",send:"Отправить",smiles:"Смайлы",preview:"просмотр",sendFile:"Отправить файл",sendImage:"Отправить картинку",closeChat:"Вы хотите скрыть этот диалог?",closeNewChat:"Закрывая чат, вы не сможете вернуться в него или найти через поиск. Добавьте собеседника в контакты, чтобы сохранить возможность общения.",addContact:"Вы уверены, что хотите добавить {{0}}?",unknownContacts:"Неизвестные контакты",readonly:"Чат доступен только для чтения",addToChat:"Добавить участников чата",confirmCancelSend:"Вы уверены, что хотите отменить отправку сообщения?",confirmClearHistory:"История переписки с этим контактом будет удалена. Продолжить?",selectContact:"Выберите контакт",smsFrom:"SMS от номера {{tel}}",smsTo:"SMS на номер {{tel}}",stateRead:"Прочитано",stateSent:"Отправлено",stateDelivered:"Доставлено",stateError:"Ошибка",stateSending:"Отправляется",seenBy:"Просмотрено",typing:"печатает",lastMaleVisit:"Был {{date}} {{atTime}}",lastFemaleVisit:"Была {{date}} {{atTime}}",lastVisit:"Был(а) {{date}} {{atTime}}",atTime:"в {{time}}",date:"{{date}}",longTimeAgo:"давно",hasBirthdayToday:"Сегодня празднует День Рождения!",addedYouToCL:"Пользователь {{0}} добавил(а) вас в список контактов",youAddToCL:"Вы добавили {{0}} в список контактов",nowAvailableFroChat:"Вот и {{0}} теперь здесь! Пишите, звоните 🙂",recentlyAddedToTelBook:"Вы недавно добавили {{0}} в тел. книгу. Пишите, звоните 🙂",wantFromVerifyedOnly:"{{0}} хочет получать сообщения только от проверенных пользователей. Пожалуйста, подтвердите ваш номер телефона по ссылке {{1}}",incomingCall:"Входящий звонок",outgoingCall:"Исходящий звонок",missedCall:"Пропущенный звонок",newMessages:"Новые сообщения",pinnedMessage:"Закрепленное сообщение",msgSendingFailed:"Не удалось отправить сообщение",msgFailedToRecognize:"Не удалось распознать сообщение",msgFailedToRecognizeTryLater:"Сообщение распознается. Повторите позже",msgFailedToPlayRecord:"Не удается воспроизвести запись",msgRecordIsNotReadyYet:"Данные не получены. Попробуйте позже",messageEditing:"Редактирование сообщения",dragDropFiles:"Перетащите файлы сюда",sendFileQuick:"Отправить быстро",sendFileAdvanced:"Отправить с подписью",addFiles:"Добавить файлы",addCaption:"Добавить подпись",sendFiles:"Отправить файлы",sendFilesCount:{one:"Отправить {{count}} файл",few:"Отправить {{count}} файла",many:"Отправить {{count}} файлов"},noinput:{remove:"Удалить и выйти",unblock:"Разблокировать",readonly:"Администраторы группы запретили вам писать в ней",pending:"Запрос на вступление отправлен администратору",mute:"Отключить уведомления",unmute:"Включить уведомления",subscribe:"Подписаться",join:"Вступить"},forwardedFrom:"Переслано от ",forwardedFromFrom:"Переслано от {{0}} из {{1}}",edited:"изменено",addMemberGroupError:"Вы не можете добавить этот контакт в группу из-за его настроек приватности",aboutContact:"О контакте",clCard:{view:"посмотреть",message:"написать"},photoOrVideo:"Фото или видео",tools:{profile:"Анкета",photo:"Фото",spam:"Спам",alerts:"Уведомления",ignore:"Заблокировать",rename:"Переименовать",remove:"Удалить",removeHistory:"Удалить историю",clearHistory:"Очистить историю",leave:"Покинуть чат",cancel:"Отмена",add:"Добавить"},selectChatToStart:"Пожалуйста, выберите чат"},gallery:{media:"Фото и видео",video:"Видео",ptt:"Голосовые сообщения",files:"Файлы",links:"Ссылки"},forward:{showAuthor:"Показать автора",authorVisible:"Автор показан",authorHidden:"Автор скрыт"},contextmenu:{message:"Написать",mention:"Упомянуть",profile:"Профиль",spam:"Сообщить о спаме",ignore:"Заблокировать",exclude:"Удалить из чата",mute:"Отключить уведомления",unmute:"Включить уведомления",reply:"Ответить",resend:"Переслать",remove:"Удалить",add:"Добавить",pollRecall:"Отменить голос",pollStop:"Остановить опрос",copyText:"Копировать",copyLink:"Копировать ссылку",copyObject:"Копировать в буфер",saveAs:"Сохранить как...",openInBrowser:"Открыть в новой вкладке",pinMessage:"Закрепить",unpinMessage:"Открепить",delForMe:"Удалить у себя",delForAll:"Удалить у всех",markAsReaded:"Отметить как прочитанное",markAsUnread:"Отметить как непрочитанное",block:"Заблокировать",unblock:"Разблокировать",giveAdminRights:"Назначить админом",removeAdminRights:"Снять права админа",allowWriting:"Разрешить писать",forbidWriting:"Запретить писать",close:"Закрыть",hideChat:"Скрыть",edit:"Изменить",readAll:"Прочитать все",shareGroup:"Поделиться группой",shareChannel:"Поделиться каналом",copyGroupLink:"Скопировать ссылку",copyPhoneNumber:"Скопировать номер",copyEmail:"Скопировать email",shareContact:"Поделиться контактом",shareProfile:"Поделиться ссылкой на профиль",shareNick:"Поделиться ссылкой на профиль",copyNick:"Скопировать никнейм",copyNickname:"Скопировать никнейм",copyProfileLink:"Скопировать ссылку на профиль",copy:"Копировать",share:"Поделиться",changeAvatar:"Изменить аватар",lookAvatar:"Посмотреть аватар",goToMessage:"Перейти к сообщению",goToProfile:"Перейти в профиль",addContact:"Добавить контакт",createGroup:"Новая группа",createChannel:"Новый канал",removeAndBlock:"Удалить и заблокировать",toFavorite:"В избранное",delMessage:"Удалить"},profile:{close:"Закрыть",changePhoto:"Изменить фото",birthdate:"Дата рождения",email:"Электронная почта",home:"Место жительства",phoneContact:"Телефонный контакт",password:"Пароль",mobile:"Мобильный телефон",phoneNumber:"Номер телефона",name:"Имя",firstname:"Имя",lastname:"Фамилия",lastnameNotRequired:"Фамилия",aboutMe__:"Обо мне",aboutMe:"О себе",infoAboutMe:"Небольшой текст о себе",maxLengthInfo:"Максимальная длина {{n}} символов",myProfile:"Мой профиль",inputName:"Добавить имя",inputAboutMe:"Добавить описание",inputPhone:"Добавить номер",editName:"Редактирование имени",editAboutMe:"Редактирование описания",profilePrivacy:"Кто видит мои данные?",nickname:"Никнейм",inputNickname:"Добавить никнейм"},chat:{settings:"Настройки чата",allMembers:"Все участники",admins:"Админы",outOfGroup:"Вы не участник группы",outOfChannel:"Вы не подписаны на канал",aloneMember:"Вы единственный участник группы",aloneSubscriber:"Вы единственный подписчик канала",countMembers:{one:"{{count}} участник",few:"{{count}} участника",many:"{{count}} участников"},blocked:"Заблокированные",beginChat:"Начать чат",beginChatWith:"Начать чат с {{nick}}",resumeChatWith:"Продолжить чат с {{nick}}",resumeChat:"Продолжить чат",selectViewContacts:"Добавить участников",membersListLoading:"Загружается список участников",pleaseWait:"Пожалуйста, подождите...",createFailed:"Не удалось создать чат. Попробуйте позже",addingFailed:"Не удалось добавить участников. Попробуйте позже",joinChat:"Вступить",openChat:"Открыть",pendingInvite:"Ожидание",friends:{one:"{{count}} друг",few:"{{count}} друга",many:"{{count}} друзей"},typeName:"Введите имя чата",typeAbout:"Введите описание чата",addAbout:"Добавьте описание",msgFailedToCreate:"Не удалось создать чат. Попробуйте позже",ageRestrict:"К сожалению, этот чат не доступен для вас.",approveAll:"Добавить всех",adminReview:"Админ рассмотрит вашу кандидатуру",pending:"Ожидают подтверждения",linkCopied:"Ссылка скопирована",message:{add:"{{0}} добавил(а) в группу новых участников: {{1}}",del:"{{0}} удалил(а) участников: {{1}}",invite:"{{0}} добавил(а) вас в группу",turnOut:"{{0}} удалил(а) вас из группы",attached:"{{0}} вступил(а) в группу",inviteSelf:"Вы присоединились к группе",detached:"{{0}} покинул(а) группу",turnOutSelf:"Вы покинули группу",rename:'{{0}} сменил(а) название группы на "{{1}}"',modifyAbout:'{{0}} сменил(а) описание группы на "{{1}}"',changeIcon:"{{0}} сменил(а) картинку группы",userChangedChatRules:'{{0}} сменил правила группы на "{{1}}"',youChangedChatRules:'Вы сменили правила группы на "{{1}}"',youRename:'Вы сменили название группы на "{{1}}"',youModifyAbout:'Вы сменили описание группы на "{{1}}"',youChangeIcon:"Вы сменили картинку группы",destroyed:"Группа удалена",create:"{{0}} создал(а) группу: {{1}}",admGranted:"{{0}} назначил(а) {{1}} админом группы",admRevoked:"{{0}} снял(а) права админа с {{1}}",pinMessage:"{{0}} закрепил(а) сообщение",youPinMessage:"Вы закрепили сообщение",invitationCanceled:"Приглашение было отменено"}},polls:{poll:"Опрос",createPoll:"Создать опрос",stopPoll:"Остановить опрос?",stopPollExplanation:"Если вы остановите опрос, никто не сможет проголосовать. Это действие нельзя отменить",publicPoll:"Публичный опрос",anonymousPoll:"Анонимный опрос",askYourQuestion:"Задайте свой вопрос",possibleAnswer:"Вариант ответа",addAnswer:"Добавить ещё вариант",nVotes:{one:"{{count}} голос",few:"{{count}} голоса",many:"{{count}} голосов"}},snaps:{stories:"Истории",myStory:"Моя история","new":"Новые",all:"Все",removeSnap:"Вы уверены, что хотите удалить?"},group:{link:"Ссылка",about:"О группе",name:"Название группы",readFullText:"Читать полностью",youAreBannedInGroup:"Вас заблокировали, поэтому вы не получаете сообщения и не можете писать",yourRequestUnderConsideration:"Дождитесь, пока администраторы группы подтвердят ваш запрос на вступление",createGroup:"Создать группу",groupSettings:"Настройки группы",channelSettings:"Настройки канала",blockChannel:"Заблокировать канал",addToGroup:"Добавить в группу",addToChannel:"Добавить в канал",addMember:"Добавить участника",roleCreator:"создатель",roleAdmin:"админ",roleReadonly:"только чтение",membershipRequests:"Запросы на вступление",deleteAndLeave:"Удалить и выйти",leave:"Выйти","public":"Публичная",publicDesc:"Публичную группу смогут найти в поиске и ее ссылка будет доступна всем участникам",live:"Ссылка на группу",liveDesc:"Возможность войти в группу по ссылке",coolGroup:"Классная группа",newGroup:"Новая группа",myCoolGroup:"Моя классная группа",myNewGroup:"Моя новая группа",addAbout:"Добавить описание",addAvatar:"Добавить аватар",createGroupWithoutMembers:"Вы не выбрали никого из списка, уверены, что хотите создать группу без участников?"},channel:{settings:"Настройки канала",name:"Название канала",about:"О канале",rules:"Правила",live:"Ссылка на канал",readonly:"Только чтение",createChannel:"Создать канал","public":"Публичный",publicDesc:"Публичный канал смогут найти в поиске и его ссылка будет доступна всем участникам",joinModeration:"Вступление по запросу",ageRestriction:"Возрастное ограничение",liveDesc:"Возможность подписаться на канал по ссылке",readonlyDesc:"Все участники могут только читать, одобренные админом могут писать",joinModerationDesc:"Новые участники ожидают разрешение админа на вступление",ageRestrictionDesc:"Участники чата должны быть совершеннолетними",message:{add:"{{0}} добавил(а) в канал новых участников: {{1}}",del:"{{0}} удалил(а) участников: {{1}}",invite:"{{0}} подписал(а) вас на канал",turnOut:"{{0}} удалил(а) вас из канала",attached:"{{0}} вступил(а) в канал",inviteSelf:"Вы подписались на канал",detached:"{{0}} покинул(а) канал",turnOutSelf:"Вы отписались от канала",rename:'Название сменилось на "{{1}}"',modifyAbout:'Описание сменилось на "{{1}}"',changeIcon:"Аватар канала сменился",userChangedChatRules:'Правила канала сменились на "{{1}}"',youChangedChatRules:'Вы сменили правила канала на "{{1}}"',youRename:'Вы сменили название канала на "{{1}}"',youModifyAbout:'Вы сменили описание канала на "{{1}}"',youChangeIcon:"Вы сменили картинку канала",destroyed:"Канал удален",create:"{{0}} создал(а) канал: {{1}}",admGranted:"{{1}} назначили админом канала",admRevoked:"С {{1}} сняли права админа",pinMessage:"Сообщение закреплено",youPinMessage:"Вы закрепили сообщение"}},search:{results:"Результаты поиска",dialogSearch:"Поиск по чату",messagesFound:"Найденные сообщения ({{count}})",title:"Поиск и добавление контактов",search:"Поиск",back:"Назад",restContacts:"не в этом чате",youMayKnow:"Вы можете их знать",mutualFriends:{one:"{{count}} общий друг",few:"{{count}} общих друга",many:"{{count}} общих друзей"},profile:"Анкета",add:"Добавить",noResults:"Ничего не найдено",phone:"Телефон",name:"имя",lastname:"Фамилия",sex:"Пол",age:"Возраст",country:"Страна",state:"Регион",city:"Город",male:"мужской",female:"женский",from:"от",to:"до",anyCountry:"Любая страна",any:"Любой",people:"Люди",groupChats:"Групчаты",messages:"Сообщения",contactsAndGroups:"Контакты и группы",chats:"Чаты",global:"Глобальный"},sticker:{sticker:"Стикер",stickers:"Стикеры",refresh:"Обновить",install:"Установить",download:"Скачать",add:"Добавить",remove:"Удалить",tryNow:"Попробовать",installed:"Установлено",forFree:"Бесплатно",stickerPackNotFound:"Стикерпак не найден",showcase:"Витрина"},calls:{makeCall:"Позвонить",callBack:"Перезвонить",videoCall:"Видеозвонок",incomingCall:"Входящий звонок",decline:"Отклонить",audio:"Аудио",video:"Видео",screen:"Экран",speaker:"Динамик",mute:"Без звука",hangup:"Завершить",addMember:"Добавить",other:"Другое",settings:"Настройки",showEveryone:"Показать всех",expand:"Увеличить",openChatPage:"Открыть чат",connecting:"Ожидаем соединения",connectingShort:"Соединение",calling:"Звоним",duration:"Длительность",finished:"Звонок завершён",fullscreen:"Во весь экран",exitFullscreen:"В окне",openChat:"Перейти в чат",youAreCalling:"В данный момент вы звоните",groupCall:"Групповой звонок",startGroupCall:"Начать групповой звонок",startGroupAudioCall:"Начать групповой аудиозвонок",startGroupVideoCall:"Начать групповой видеозвонок",event:{youCalledUser:"Вы звонили {{name}}",youCalledUserMissed:"Ваш звонок был пропущен",youCalledUserDeclined:"Ваш звонок был отклонён",callFromUser:"Вам звонил(-а) {{name}}",callFromUserMissed:"Вы пропустили звонок от {{name}}",callFromUserDeclined:"Вы не ответили на звонок от {{name}}",groupCall:"Групповой звонок",groupCallFromYou:"Групповой звонок от вас",groupCallMissed:"Вы пропустили групповой звонок"}},auth:{email:"Email",uinOrEmail:"UIN/Email",password:"Пароль",lostPassword:"Забыли пароль?",enter:"Вход",login:"Войти",offline:"Офлайн",acceptPolicy:'Продолжая, вы принимаете <a href="{{link}}" target="_blank">политику конфиденциальности</a>',typeNumber:"Введите номер",goOn:"Продолжить",typeCode:"Введите код",waitForCode:"Дождитесь авторизации номера",alreadyMember:"У меня уже есть аккаунт",loginWithUinOrEmail:"Вход по UIN/Email",loginByPhone:"Вход по номеру телефона",changeNumber:"Изменить номер телефона",missedCode:"Не получили SMS?",selectYourCountry:"Выберите страну",attachPhoneNumber:"Добавить номер телефона",welcomeTo:"Добро пожаловать в {{product}}",welcomeToIcq:"{{product}} — эволюция общения",welcomeAgreement:'Нажимая «Принять и продолжить», вы подтверждаете, что внимательно прочитали и соглашаетесь с нашими <a href="{{termsLink}}" target="_blank">Условиями предоставления услуг</a> и <a href="{{policyLink}}" target="_blank">Политикой конфиденциальности</a> и <a href="{{cookiePolicyLink}}" target="_blank">Политикой использования файлов cookie</a>.',acceptAndStart:"Принять и продолжить",phoneNumber:"Телефон",phoneNumberDescription:"Проверьте код страны и введите свой номер телефона",loginByPassword:"Вход по паролю",inputLoginPassword:"Укажите ваш логин и пароль",username:"Логин",codeWasSentTo:"Код подтверждения был отправлен на номер {{tel}}",weCalledYou:"Мы позвонили на номер <br/>{{tel}}",businessAuthSubtitle:'Для входа используйте корпоративный аккаунт, созданный в <a href="{{link}}" target="_blank">Mail.ru для бизнеса</a>',enterEmail:"Введите email",enterPassword:"Введите пароль",businessOTPAuthEmail:"Введите ваш корпоративный email, на него будет отправлен пароль для входа",businessOTPAuthPassword:"Введите одноразовый пароль, который был отправлен на <span>{{email}}</span>",enterOneTimePasswordSentByEmail:"Введите одноразовый пароль, полученный по email",businessAuthNote:'Авторизоваться можно только корпоративными аккаунтами, заведенными в "Mail.ru для бизнеса". Ознакомиться с мессенджером и завести аккаунты сотрудников можно тут <a href="{{link}}" target="_blank">{{link}}</a>',waitForCall:"Мы позвонили вам для подтверждения номера телефона на",typeCallCode:"Введите 6 последних цифр номера, с которого вам позвонили",numberCallCode:"6 последних цифр",recall:"Перезвонить",turnOnProtection:"Включить",smsCode:"Код из SMS",resendCode:"Отправить снова",change:"Изменить",searchCode:"Введите название или код",russia:"Россия",msgPhoneAttached:"Телефон успешно добавлен",msgPhoneAlreadyAttached:"Номер телефона {{tel}} привязан к другому аккаунту.",msgWrongLogin:"Неверный логин",msgWrongPassword:"Неверный пароль",msgWrongLoginOrPassword:"Неверный логин или пароль",msgWrongPhone:"Некорректный номер",msgPhoneBlocked:"Номер телефона заблокирован",msgTwoFactorAuth:"Необходима двухфакторная аутентификация",msgRequestRateLimit:"Слишком много попыток. Попробуйте позже.",msgValidationLimit:"Достигнут предел попыток. Запросите код снова.",msgCommonError:"Произошла ошибка. Попробуйте позже",msgNetworkError:"Сетевая ошибка. Попробуйте позже",msgNetworkUnavailable:"Сеть недоступна. Попробуйте позже",msgWrongCode:"Неправильный код",switchNumber:"Сменить номер",swithPhoneRule1:"Ваш аккаунт, контакты, чаты, сообщения будут перенесены на новый номер.",swithPhoneRule3:"Перед началом переноса убедитесь, что вы можете принимать SMS или звонки на новый номер.",yourPhone:"Ваш телефон",inputNewPhone:"Укажите ваш новый номер",dictateByPhone:"Продиктовать по телефону",numberIsSwitched:"Номер изменен",successSwitchedOn:"Номер телефона для учетной записи успешно изменен на {{number}}"},contact:{block:{block:"Заблокировать",blockContact:"Заблокировать контакт",reportSpamAndBlock:"Заблокировать контакт и пожаловаться"},report:{reportSpam:"Сообщить о спаме",spam:"Спам",porn:"Порнография",violation:"Нарушение законодательства",other:"Другое"},commonGroups:"Общие группы",reportContact:"Пожаловаться",reportAndBlock:"Пожаловаться и заблокировать",createCommonGroup:"Создать общую группу"},network:{offline:"Сеть недоступна",troubles:"Обновление данных"},settings:{general:"Основные",generalSettings:"Основные настройки",theme:"Оформление",defaultTheme:"По умолчанию",lightTheme:"Светлая",greenTheme:"Зелёная",darkGreenTheme:"Тёмная зелёная",darkCallsTheme:"Тёмная для звонков",darkTheme:"Тёмная",blueTheme:"Синяя",darkBlueTheme:"Тёмная синяя",security:"Безопасность",privacy:"Приватность",media:"Голос и видео",microphone:"Микрофон",speakers:"Динамики",webcam:"Веб-камера",notAvailable:"Недоступно",about:"О программе",openSSLLicenseInfo:"Этот продукт содержит программное обеспечение, разработанное проектом OpenSSL для использования в OpenSSL Toolkit<br/><br/><a target=_blank href='https://openssl.org'>https://openssl.org</a>",emojiLicenseInfo:"Emoji предоставлены бесплатно Emoji One",presentedInfo:"Разработано в Mail.ru Group",smartReply:"Показывать умные ответы",stickerSuggest:"Показывать подсказки на эмодзи",stickerSuggestByWords:"Показывать подсказки на слова",changePassword:"Изменить пароль",passwordRequirements:"Пароль должен состоять из {{count}} символов и должен включать в себя большие и маленькие латинские буквы и цифры",oldPassword:"Старый пароль",newPassword:"Новый пароль",repeatNewPassword:"Повторите новый пароль",emptyField:"Заполните все поля",passwordsDoNotMatch:"Пароли не совпадают",passwordWeak:"Новый пароль не отвечает требованиям",passwordWeakWord:"Пароль похож на словарное слово",passwordChanged:"Пароль обновлён",oldPasswordMismatch:"Старый пароль введён неверно",accountSecurity:"Безопасность аккаунта",sessionList:"Список сессий",currentSession:"Текущий сеанс",
activeSession:"Активный сеанс",activeSessions:"Активные сессии",closeOtherSessions:"Закрыть все другие сессии",closeSessions:"Закрыть сессии",closeSession:"Закрыть сессию",sessionWillBeClosed:"Сессия {{name}} будет закрыта",sessionsWillBeClosed:"Все сессии, кроме текущей, будут завершены",sessionClosed:"Сессия закрыта",sessionsClosed:"Сессии завершены",deleteMyAccount:"Удалить мой аккаунт",accountDeleting:"Удаление аккаунта",youWillGetSmsWithCode:"Мы пришлем SMS с кодом подтверждения на ваш номер <span>{{0}}</span>",sendSMS:"Отправить SMS",deleteConfirmationCode:"Код для удаления",accountIsAboutToDeleteWarning:"Внимание! Все данные вашего аккаунта будут безвозвратно удалены.","delete":"Удалить",groupsPrivacySetting:"Кто может добавлять в группы",callsPrivacySetting:"Кто может звонить",everybody:"Все",myContacts:"Те, с кем переписывался, и контакты из телефонной книги",nobody:"Никто",myData:"Мои данные",myDataTitle:"Здесь вы можете скачать данные о своём профиле"},nickBox:{exampleDescription:"По никнейму вас смогут найти те, у кого нет вашего номера телефона, указав",linkDescription:"По этой ссылке откроется чат с вами в {{product}}",stampExampleDescription:"Вы также можете указать группу в переписке как",channelStampExampleDescription:"Вы также можете указать канал в переписке как",stampLinkDescription:"По этой ссылке откроется группа “{{groupName}}” в {{product}}",channelStampLinkDescription:"По этой ссылке откроется канал “{{groupName}}” в {{product}}",rules:"Допустимые символы: латинские буквы (a-z), цифры (0-9), точка “.”, подчеркивание “_”",placeholder:"Придумайте уникальный никнейм",minLength:"Минимальная длина — {{0}} символов",maxLength:"Максимальная длина — {{0}} символов",wrongChar:"Недопустимый символ",wrongFirstChar:"Должен начинаться с латинской буквы (a-z)",check:"Проверка",freeNick:"Никнейм свободен",takenNick:"Этот никнейм занят",serverError:"Ошибка на сервере.",repeatCheck:"Повторить проверку",repeat:"Повторить",freeLink:"Ссылка свободна",takenLink:"Эта ссылка занята",generateNewLink:"Сгенерировать новую ссылку"},box:{ok:"ОK",ok_yes:"Да",cancel:"Отмена",cancel_no:"Нет",ignore:"Заблокировать",spam:"Спам",spamConfirm:"Да, это спам",remove:"Удалить",save:"Сохранить",apply:"Применить",leave:"Покинуть",close:"Закрыть",closeChat:"Закрыть чат",info:"Информация",removeMember:"Удалить участника",removeMemberAndMessages:"Удалить участника и сообщения",removeSubscriber:"Удалить подписчика",removeSubscriberAndMessages:"Удалить подписчика и сообщения",removeAndBlock:"Удалить и заблокировать {{friendly}}?",fromGroupRemovingDesc:"Участник не сможет вернуться в группу. Вы также можете удалить его последние сообщения",fromChannelRemovingDesc:"Подписчик не сможет вернуться в канал. Вы также можете удалить его последние сообщения",ignoreContact:"Вы уверены, что хотите заблокировать контакт?",ignoreChat:"Вы уверены, что хотите заблокировать группу?",spamUser:"Пожаловаться на пользователя {{nick}} {{andRemove}}?",andRemove:" и удалить из контактов",removeUserTitle:"Удалить контакт",removeUser:"Удалить {{nick}} из списка контактов?",leaveGroup:"Покинуть группу {{nick}}?",leaveChannel:"Покинуть канал {{nick}}?",leaveChat:"Вы уверены, что хотите покинуть чат?",blockUser:"Вы уверены, что хотите заблокировать {{nick}}?",unblockUser:"Вы уверены, что хотите разблокировать {{nick}}?",giveAdminRights:"Вы уверены, что хотите назначить админом {{nick}}?",removeAdminRights:"Вы уверены, что хотите снять админа {{nick}}?",allowWriting:"Разрешить {{nick}} писать в чат?",forbidWriting:"Запретить {{nick}} писать в чат?",unignoreContact:"Вы уверены, что хотите разблокировать контакт?",unignoreChat:"Вы уверены, что хотите разблокировать группу?",micNotFoundTitle:"Микрофон не найден",micNotFound:"Не удалось обнаружить ваш микрофон. Пожалуйста, убедитесь, что ваше устройство присоединено и включено.",recIsUnavailableTitle:"Аудиозапись недоступна",recIsUnavailable:"К сожалению ваш браузер не поддерживает запись звука",micPermissionTitle:"Ошибка доступа к микрофону",micPermission:"Для записи голосового сообщения, вам необходимо разрешить доступ к микрофону",generateNewLinkConfirmTitle:"Старая ссылка перестанет работать",generateNewLinkConfirmDesc:"Если вы сгенерируете новую ссылку на группу, то попасть в группу можно будет только по ней",generateNewChannelLinkConfirmDesc:"Если вы сгенерируете новую ссылку на канал, то попасть в канал можно будет только по ней",generateNewLinkConfirm:"Сгенерировать",publicOffConfirmTitle:"Публичная ссылка перестанет работать",publicOffConfirmDesc:"Если вы смените тип группы на частный, то ссылка группы поменяется и старая перестанет работать",publicOffChannelConfirmDesc:"Если вы смените тип канала на частный, то ссылка канала поменяется и старая перестанет работать",publicOffConfirm:"Сделать частной",publicOffChannelConfirm:"Сделать частным",extraDigits:{one:"{{count}} лишняя цифра",few:"{{count}} лишних цифры",many:"{{count}} лишних цифр"},remainingDigits:{one:"Еще {{count}} цифра",few:"Еще {{count}} цифры",many:"Еще {{count}} цифр"},readAllChatsConfirmation:"Вы уверены, что хотите пометить все сообщения прочитанными?",noPhoneAndNickname:"Нет телефона и никнейма",noPhoneAndNicknameInfo:"Чтобы поделиться контактом, попросите пользователя задать никнейм или добавьте новый контакт с его номером телефона.",channelsArePublicByDefault:"Каналы по умолчанию публичные, после создания можно изменить это в настройках"},bots:{youAreNotMember:"Вы не участник чата или вам запрещено писать",openLinkConfirmation:"Вы уверены, что хотите открыть внешнюю ссылку {{url}}?"},status:{status:"Статус",customStatus:"Расширенный статус",official:"Официальный аккаунт",absent:"Ни разу не заходил(-а)",blocked:"Заблокирован(-а)",bot:"Бот",online:"Онлайн",chat:"Готов поболтать",away:"Отошел",dnd:"Не беспокоить",na:"Недоступен",occupied:"Не беспокоить",offline:"Отключён",auth:"Не авторизован",gray:"Не авторизован",conf:"Групчат",tel:"Телефон",mobile:"С мобильного",unknown:"Не определён",invisible:"Невидимый"},notify:{leadEmoji:"👋 ",timeElapsed:"{{time}} назад",youHaveSticker:"Вам прислали стикер",mentionedYou:"Вас упомянули",newMessages:{one:"{{count}} новое сообщение",few:"{{count}} новых сообщения",many:"{{count}} новых сообщений"}},file:{file:"Файл",downloadFile:"Скачать файл",progressText:"{{0}} из {{1}}",mBytes:"Мб",kBytes:"Кб",bytes:"б",errorAbort:"Загрузка прервана",errorNotFound:"Файл не найден",errorInit:"Ошибка при отправке (#2)",errorReadFile:"Ошибка чтения файла",errorUpload:"Ошибка при отправке (#4)",errorSending:"Ошибка при отправке (#5)",errorFileTooLarge:"Размер файла слишкой большой",errorFile:"Файл имеет неверный формат, или поврежден",errorVideoCantPlay:"Кодек не поддерживается",snapIsExpired:"Снап устарел"},time:{today:"сегодня",justNow:"только что",yesterday:"вчера",years:{one:"{{count}} год",few:"{{count}} года",many:"{{count}} лет"},months:{one:"{{count}} месяц",few:"{{count}} месяца",many:"{{count}} месяцев"},days:{one:"{{count}} день",few:"{{count}} дня",many:"{{count}} дней"},hours:{one:"{{count}} час",few:"{{count}} часа",many:"{{count}} часов"},minutes:{one:"{{count}} минуту",few:"{{count}} минуты",many:"{{count}} минут"}},gdpr:{title:"Добро пожаловать в {{product}}",text:'Нажимая «Я согласен(-на)», вы подтверждаете, что внимательно прочитали и соглашаетесь с нашими <a target="_blank" href="{{termsLink}}">Условиями оказания услуг</a> и <a target="_blank" href="{{privacyLink}}">Политикой конфиденциальности</a>.',updateTitle:"Условия оказания услуг и Политика конфиденциальности",updateText:'Обращаем ваше внимание, что мы обновили наши <a target="_blank" href="{{termsLink}}">Условия оказания услуг</a> и <a target="_blank" href="{{privacyLink}}">Политику конфиденциальности</a>. Нажимая «Я согласен(-на)», вы подтверждаете, что внимательно прочитали обновленные документы и соглашаетесь с ними.',agree:"Я Согласен"},sex:{gender:"Пол",f:"Женщина",m:"Мужчина"},nom_month_gen:{0:"нулямберь",1:"январь",2:"февраль",3:"март",4:"апрель",5:"май",6:"июнь",7:"июль",8:"август",9:"сентябрь",10:"октябрь",11:"ноябрь",12:"декабрь"},month_gen:{0:"нулямберя",1:"января",2:"февраля",3:"марта",4:"апреля",5:"мая",6:"июня",7:"июля",8:"августа",9:"сентября",10:"октября",11:"ноября",12:"декабря"},short_month_gen:{0:"нул.",1:"янв.",2:"февр.",3:"марта",4:"апр.",5:"мая",6:"июня",7:"июля",8:"авг.",9:"сент.",10:"окт.",11:"нояб.",12:"дек."},at_day:{0:"в воскресенье",1:"в понедельник",2:"во вторник",3:"в среду",4:"в четверг",5:"в пятницу",6:"в субботу"},onpremise:{errorContactAdmin:"Уточните адрес у администратора",errorInputServerHost:"Введите адрес сервера",errorServerConfigMissingField:"Для работы приложения необходимо дополнить конфигурацию сервера. Обратитесь к администратору.",errorServerConfigIncorrect:"Некорректный формат конфигурации сервера. Обратитесь к администратору."},board:{msgAuthFailed:"Не удалось авторизоваться",msgLoginToViewComments:"Авторизуйтесь для просмотра комментариев",msgFailedToLogin:"Не удалось авторизоваться. Попробуйте обновить страницу.",msgFailedToConnect:"Не удалось установить соединение. Попробуйте обновить страницу.",msgChatNotFound:"Обсуждение не найдено",comment:"Комментировать",join:"Присоединиться"},widget:{createGroupTitle:"Создайте чат для общения с командой",makeChatButton:"Создать чат",makeChatMessage:"Создайте чат для общения с командой",loginToChatWithTeam:"Войдите в свой аккаунт, чтобы начать общаться в чате со своей командой",workTimeFromUpTo:'Врач отвечает с {{0}} до {{1}} по очереди поступления обращений. Чтобы вовремя получить ответ, установите <a class="imButton" href="{{2}}" target="_blank" data-action="openAppLink">ICQ</a>'},notSpecified:"Не указано",msgLinkCopied:"Ссылка скопирована",msgNickCopied:"Никнейм скопирован",msgEmailCopied:"Email скопирован",msgPhoneCopied:"Номер телефона скопирован",msgCopiedToClipboard:"Скопировано в буфер",msgTooLong:"Слишком длинное сообщение",msgTooLongAndCut:"Поместилась только часть сообщения",msgAddMePlease:"Здравствуйте. Пожалуйста, добавьте меня в список ваших контактов.",msgError400:"Ошибка авторизации (400)",msgTouchScreen:"Коснитесь экрана чтобы включить звуковые оповещения",msgSignOutConfirmation:"Вы уверены, что хотите сменить аккаунт?",msgNoProfileWithThisNick:"Нет профиля или группы с таким никнеймом",msgNoProfileWithThisEmail:"Нет профиля с такой почтой",msgSwitchAccountTo:"Сейчас вы авторизованы в {{productName}} как {{current}}.<br/>Хотите сменить аккаунт и войти как {{forced}}?",firstFavoriteMessage:"{{1}}\n{{0}}, это ваше личное пространство!\n\n ⭐️ Сохраняйте ссылки, файлы и другие сообщения\n ✅ Пишите заметки, списки дел, храните фото и видео\n 🏞 Создавайте черновики сообщений и опросов перед тем, как отправить их в чат с друзьями или в свой канал",firstFavoriteMessageBusiness:"{{0}}, это ваше рабочее пространство!\n\n 📎 Сохраняйте ссылки, файлы и другие сообщения\n ✔️ Пишите заметки, списки дел, храните фото и видео\n 📝 Создавайте черновики сообщений и опросов перед тем, как отправить их в чат с коллегами или в свой канал",nick:"Ник",next:"Далее",done:"Готово",create:" Создать",stop:"Остановить",titleAnimator:"({{count}}) Сообщение",signOut:"Выйти",pluralRule:function(a){return a%10==1&&a%100!=11?"one":[2,3,4].indexOf(a%10)>=0&&[12,13,14].indexOf(a%100)<0?"few":"many"}},f=/{{([a-zA-Z0-9_-]+?)}}/g,g=function(a){for(var b=e,c=a.split(".");c.length&&void 0!==b;)if(b=b[c.shift()],0===c.length)return b;return null},h=function(a,b){return a.replace(f,function(a,c){return"undefined"!=typeof b[c]?""+b[c]:""})},i=function(a,b){var c=e.pluralRule;return"object"===d(a)&&c?a[c(b)]:a},j=function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=a;b.scope&&(c=b.scope+"."+c),b.context&&(c=c+"_"+b.context);var d=g(c);return"undefined"!=typeof b.count&&(d=i(d,b.count)),d="string"==typeof d?h(d,b):b.defaultNull?null:"["+c+"]"},k=j;c["default"]=k},{}],20:[function(a,b,c){"use strict";function d(a){return g(a)||f(a)||e()}function e(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function f(a){return Symbol.iterator in Object(a)||"[object Arguments]"===Object.prototype.toString.call(a)?Array.from(a):void 0}function g(a){if(Array.isArray(a)){for(var b=0,c=new Array(a.length);b<a.length;b++)c[b]=a[b];return c}}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var h,i="qwertyuiopasdfghjklzxcvbnm[{]};:',<.> йцукенгшщзхъфывапролджэячсмитьбю",j="йцукенгшщзфывапролдячсмитьххъъжжэббюю qwertyuiop[]asdfghjkl;'zxcvbnm,.",k="qwertyuiopasdfghjklzxcvbnmйцукенгшщзхъфывапролджэёячсмитьбю",l="квертяуиопасдфгхйклз кс цвбнмjcukeng sh sh' z h  fivaprold zh e e ya ch smit'b yu",m=37,n=(h=[]).concat.apply(h,d(l.split(" ").map(function(a){return a.length>3?a.split(""):a}))),o={transliterate:function(a){for(var b="",c=-1,d="",e=0,f=(a||"").toLowerCase(),g=f.length;g>e;)d=f[e++],c=k.indexOf(d),c>-1&&(d=n[c]),b+=d;return b},translate:function(a){for(var b,c="",d=-1,e="",f=0,g=(a||"").toLowerCase(),h=g.length;h>f;)e=g[f++],d=i.indexOf(e),b||(d>-1&&m>d?b="en":d>m&&(b="ru")),("ru"===b&&d>m||"en"===b&&m>d&&d>-1)&&(e=j[d]),c+=e;return c}},p=o;c["default"]=p},{}],21:[function(a,b,c){"use strict";function d(a){return(d="function"==typeof Symbol&&"symbol"===_typeof2(Symbol.iterator)?function(a){return _typeof2(a)}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":_typeof2(a)})(a)}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var e=WebIM,f={stopcoronavirus:[60111076,324374186,60111154,324376362],shtabkrskstate:[60111169,324376556,60111170,324376582],covid19kuzbass:[60111075,324376841,60111176,324376842],covid2019_nso:[60111079,324376926,60111180,324376928],covid2019_official:[60111234,324378478,60111235,324378479],coronavirus_mo:[60111244,324378548,60111245,324378557],event193085715:[60111252,324378852,60111253,324378852],covid19_tula:[60111263,324379167,60111264,324379232],covid2019rzn:[60111265,324379233,60111266,324379261],coronavirus43:[60111267,324379266,60111268,324379267],coronavirussamaroblast:[60111269,324379282,60111270,324379283],bezpaniki21:[60111271,324379284,60111272,324379285],covid2019ul:[60111272,324379286,60111274,324379290],covid_arkhreg:[60111275,324379292,60111276,324379294],covid2019_official_pskov:[60111277,324379301,60111278,324379308],covid_murman:[60111279,324379327,60111280,324379330],koronavirus_spb:[60111366,324381111,60111365,324381110],coronavirus08:[60111367,324381114,60111369,324381116],club193205340:[60111370,324381121,60111371,324381122],club193271649:[60111372,324381124,60111373,324381125],koronavirus76:[60111374,324381126,60111375,324381131],club193280704:[60111379,324381137,60111382,324381138],koronavirus32:[60111383,324381145,60111384,324381146],public193281197:[60111389,324381147,60111391,324381148],udm_coronavirus:[60111396,324381166,60111397,324381179],public193353310:[60111398,324381206,60111400,324381227],covid19nn:[60111406,324381363,60111407,324381364],coronavirus_tverreg:[60111408,324381366,60111409,324381369],"covid2019.stav":[60111411,324381373,60111414,324381374],stopcovid57:[60111415,324381375,60111416,324381376],covid19_bel:[60111417,324381377,60111418,324381378],public193449877:[60111419,324381379,60111420,324381384],covid19pnz:[60111421,324381385,60111422,324381386]},g=0,h=0,i={log:function(a){try{"object"==d(a)&&(a=e.makeGet(a))}catch(b){}var c=e.urlBuilder.getUrl("log");e.isProduction&&c&&((new Image).src=c+"&"+a+"&r="+e.uniq())},wrapTryCatch:function(a,b){if(e.isProduction)try{a.call(b||window)}catch(c){this.catchException(c)}else a.call(b||window)},stringifyException:function(a,b){try{if(!("message"in a))try{a={message:window.JSON.stringify(a)}}catch(c){}}catch(c){a={message:""+a}}try{if("string"==typeof a.message&&a.message.indexOf("STRGFFERROR")>-1){var d=+new Date;if(!(d>g))return void h++;g=d+3e4,a.message=a.message.substring(11)}var f=a.stack;f||(f=a.fileName+":"+(a.line||a.lineNumber));var i=a.description||window.JSON.stringify(a.message);if("window"===b){if(f.indexOf("checkUnread")>0||f.indexOf("node.getElementsByTagName is not a function")>0)return;if('"Script error."'===i)return}this.err("js");var j=["login="+encodeURIComponent(e.ACTIVE_MAIL),"message="+encodeURIComponent(i),"stack="+encodeURIComponent(f)];return h>0&&(j.push("errcounter="+h),h=0),b&&j.push("source="+b),j.join("&")}catch(a){return"error on stringify error: "+a}},catchException:function(a,b){this.log(this.stringifyException(a,b))},err:function(a){if(!e.configurator.getOption("disable_tracking")){var b=e.urlBuilder.getUrl("radar");e.isProduction&&b&&((new Image).src=b+"&t="+a+"Error&v=1&rnd="+Math.random())}},radar:function(a){if(!e.configurator.getOption("disable_tracking")){var b=e.urlBuilder.getUrl("radar");e.isProduction&&b&&((new Image).src=b+"&t="+a+"&v=1&rnd="+Math.random())}},countRB:function(a,b){if(!e.configurator.getOption("disable_tracking")){var c;if(b)c=e.urlBuilder.rbUrl(a);else if(!e.promoMode){var d=e.configurator.resolveRbCounter(a);d&&(c=e.urlBuilder.rbUrl(d))}c&&e.setTimeout(function(){(new Image).src=c},0)}},countRbPromo:function(a){if(!e.configurator.getOption("disable_tracking")){var b=f[a];b&&this.countRB(b[e.ACTIVE_MAIL?2:0],!0)}},makeRbPromoLink:function(a){var b=f[a];return b?e.urlBuilder.rbClickUrl(b[e.ACTIVE_MAIL?3:1]):void 0},flog:function(a,b){this.log({freaklog:1,module:a,login:e.ACTIVE_MAIL,text:b})}};window.addEventListener("error",function(a){e.isProduction&&i.catchException(a.error||a,"window")});var j=i;c["default"]=j},{}],22:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var d={each:function(a,b,c){for(var d in a)if(a.hasOwnProperty(d)&&b.call(c||window,a[d],d)===!1)return},filter:function(a,b,c){var d={};return this.each(a,function(a,e){b.call(c||window,a,e)&&(d[e]=a)},c),d},getKeys:function(a){var b=[];return d.each(a,function(a,c){b.push(c)}),b},diff:function(a,b){var c={},d=!1;return this.each(b,function(b,e){a[e]!==b&&(c[e]=b,d=!0)}),d?c:!1},extend:function(a,b,c){if(c)for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);else for(var e in b)a[e]=b[e];return a},copy:function(a){return Object.assign({},a)},clone:function(a){return JSON.parse(JSON.stringify(a))}},e=d;c["default"]=e},{}],23:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var e=d(a("./DomHelper")),f=d(a("../core/element")),g=WebIM,h=160,i=1,j=3,k={getSelection:function(){var a=null;try{a=window.getSelection?window.getSelection():WebIM.util.rangy.getSelection()}catch(b){}return a},createRange:function(){return document.createRange?document.createRange():WebIM.util.rangy.createRange()},getRange:function(){var a=window.getSelection();return a.rangeCount?a.getRangeAt(0):null},getEndRange:function(){var a=window.getSelection();return a.rangeCount?a.getRangeAt(a.rangeCount-1):null},getRangeWithPosition:function(a,b,c,d){var e=this.getRange();return e.setStart(a,b),e.setEnd(c,d),e},getNodeBeforeCaret:function(){var a=this.getSelection(),b=null;return a.anchorNode&&(a.anchorNode.nodeType===i&&a.anchorNode.childNodes.length?a.anchorOffset>0?b=a.anchorNode.childNodes[a.anchorOffset-1]:a.anchorNode.previousSibling&&(b=a.anchorNode.previousSibling):a.anchorNode&&a.anchorNode.nodeType===j&&0===a.anchorOffset&&(b=a.anchorNode.previousSibling)),b&&b.nodeType===j&&""===b.data&&(b=b.previousSibling),b},getTextBeforeCaret:function(){var a,b="",c=this.getRange();if(c&&c.collapsed){var d=c.startContainer;d&&3===d.nodeType&&(b=d.nodeValue.substr(0,c.startOffset),a=b.length,b.charCodeAt(a-1)===h&&(b=b.substr(0,a-1)+" "))}return b},getCaretElement:function(){var a=this.getRange();return a&&a.collapsed?a.startContainer:null},insertNodeAtCaret:function(a,b){var c,d,f=window.getSelection();0!==f.rangeCount&&(c=f.getRangeAt(0),c.collapsed||c.deleteContents(),c.insertNode(a),c.setStartAfter(a),c.collapse(!0),b&&(d=e["default"].elementFromHtml("<span>&nbsp;</span>"),c.insertNode(d),c.setStartAfter(d),c.collapse(!1)),f.removeAllRanges(),f.addRange(c))},copy2clipboard:function(a){var b=!1,c=document.createElement("textarea");return c.className="im-input-out-of-sight",document.body.appendChild(c),c.value=a,g.isIOS?this.iosSelectNode(c):c.select(),document.execCommand&&(document.execCommand("Copy"),b=!0),document.body.removeChild(c),b},iosSelectNode:function(a){var b=a.contentEditable,c=a.readOnly,d=document.createRange();a.contenteditable=!0,a.readonly=!1,d.selectNodeContents(a);var e=window.getSelection();e.removeAllRanges(),e.addRange(d),a.setSelectionRange(0,999999),a.contentEditable=b,a.readOnly=c},isFocused:function(a){var b=!1;try{var c=this.getSelection().anchorNode;c&&(c===a||f["default"].fly(c).isAncestor(a))&&(b=!0)}catch(d){}return b}},l=k;c["default"]=l},{"../core/element":5,"./DomHelper":14}],24:[function(a,b,c){"use strict";Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var d=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,e={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},f={isEmpty:function(a){return!a||!a.trim()},format:function j(){for(var a=arguments.length,b=new Array(a),c=0;a>c;c++)b[c]=arguments[c];var j=b.shift();return j.replace(/\{(\d+)\}/g,function(a,c){return b[c]})},capitalize:function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()},pluralize:function(a,b,c,d){return a%10===1&&a%100!==11?c:a%10>=2&&4>=a%10&&(10>a%100||a%100>=20)?d:b},htmlEntity:function(a){return a?(""+a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"):""},entityDecode:function(a){return(a||"").replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&quot;/gi,'"').replace(/&nbsp;/gi," ")},encodeHref:function(a){return a.replace(/(["<>])/g,function(a,b){return encodeURIComponent(b)})},encodeAmp:function(a){return(""+a||"").replace(/&/g,"&amp;")},stripHtmlEntity:function(a){return(a||"").replace(/&\w+|#\d+;/,"")},ellipsis:function(a,b){return a.length>b?a.substr(0,b-3)+"...":a},formatPhoneNumber:function(a,b){var c=!b;return"+"===a.substr(0,1)&&(c=!0,a=a.substr(1)),11===a.length&&(a=a.replace(/^(\d)(\d{3})(\d{3})(\d{2})(\d{2})$/,"$1 $2 $3-$4-$5")),c&&(a="+"+a),f.htmlEntity(a)},formatPhone:function(a){var b=!1;if("string"==typeof a)if(a=a.replace(/\D+/g,""),a.length>3){var c="017".indexOf(a.substr(0,1))>-1?1:2;a="7"==a.substr(0,1)?"+7 ("+a.substr(1,3)+") "+a.substr(4):b?"+"+a.substr(0,c)+" "+a.substr(c):"+"+a}else a="+"+a;return f.htmlEntity(a)},quote:function(a){return d.lastIndex=0,d.test(a)?'"'+a.replace(d,function(a){var b=e[a];return"string"==typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+a+'"'},trim:function(a){return a.replace(/^\s+|\s+$/g,"")},rsplit:function(a,b,c){var d=a.split(b),e=[];return e.push(d.slice(0,d.length-c).join(b)),e=e.concat(d.slice(d.length-c))},rindexOf:function(a,b){var c=a.length,d=a.split("").reverse().join(""),e=d.indexOf(b);return-1==e?-1:c-e},multiply:function(a,b){return new Array(b+1).join(a)},getCodePointAt:function(a,b){b=b||0;var c=a.charCodeAt(b),d=a.charCodeAt(b+1);return isNaN(d)?c.toString(16).toLowerCase():(1024*(c-55296)+d-56320+65536).toString(16).toLowerCase()},fromCharCode:function(a){return a>65535?(a-=65536,String.fromCharCode(55296+(a>>10),56320+(1023&a))):String.fromCharCode(a)},hexDecode:function(a){for(var b=a.toString(),c="",d=0;d<b.length;d+=2)c+=f.fromCharCode(parseInt(b.substr(d,2),16));return c},crc32:function(a){f.crcTable||(f.crcTable=h());for(var b=f.crcTable,c=-1,d=0;d<a.length;d++)c=c>>>8^b[255&(c^a.charCodeAt(d))];return(-1^c)>>>0},utf8Decode:function(a){return g(a)},parseHostname:function(a){var b=a.match(/:\/\/(www[0-9]?\.)?(.[^/:]+)/i);return null!=b&&b.length>2&&"string"==typeof b[2]&&b[2].length>0?b[2]:""},parseQueryString:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",b={};return a.replace(/(?:[?&]?)([^=]+)=([^&]+)/g,function(a,c,d){b[c]=decodeURIComponent(d)}),b},ensureHttpsUrl:function(a){return(a||"").replace("http://","https://")}},g=function(a){var b=a.replace(/[\u00e0-\u00ef][\u0080-\u00bf][\u0080-\u00bf]/g,function(a){var b=(15&a.charCodeAt(0))<<12|(63&a.charCodeAt(1))<<6|63&a.charCodeAt(2);return String.fromCharCode(b)});return b=b.replace(/[\u00c0-\u00df][\u0080-\u00bf]/g,function(a){var b=(31&a.charCodeAt(0))<<6|63&a.charCodeAt(1);return String.fromCharCode(b)})},h=function(){for(var a,b=[],c=0;256>c;c++){a=c;for(var d=0;8>d;d++)a=1&a?3988292384^a>>>1:a>>>1;b[c]=a}return b},i=f;c["default"]=i},{}],25:[function(a,b,c){"use strict";function d(a){return a&&a.__esModule?a:{"default":a}}Object.defineProperty(c,"__esModule",{value:!0}),c["default"]=void 0;var e=d(a("./Object")),f=d(a("./Array")),g=d(a("./Animation")),h=d(a("./Date")),i=d(a("./DelayedTask")),j=d(a("./DomHelper")),k=d(a("./EventA")),l=d(a("./EventConfirm")),m=d(a("./EventDispatcher")),n=d(a("./I18n")),o=d(a("./KeyMapping")),p=d(a("./Monitoring")),q=d(a("./Selection")),r=d(a("./String")),s=d(a("./Exif")),t=Object.assign({},{Object:e["default"],Array:f["default"],animation:new g["default"],Date:h["default"],DelayedTask:i["default"],DomHelper:j["default"],Exif:s["default"],Event:k["default"],EventConfirm:l["default"],EventDispatcher:m["default"],tr:n["default"],KeyMapping:o["default"],Mnt:p["default"],Selection:q["default"],String:r["default"]}),u=t;c["default"]=u},{"./Animation":10,"./Array":11,"./Date":12,"./DelayedTask":13,"./DomHelper":14,"./EventA":15,"./EventConfirm":16,"./EventDispatcher":17,"./Exif":18,"./I18n":19,"./KeyMapping":20,"./Monitoring":21,"./Object":22,"./Selection":23,"./String":24}]},{},[6]);var _WA=window.WebIM=window.WebIM||{},getUserCookieLogin=function(){return(/Mpop=.*?:([^@:]+@[^:]+)/.exec(document.cookie.toString())||[0,!1])[1]},isDebug=location.href.indexOf("localhost")>0||location.href.indexOf("wa_debug")>0,forceSingleView=location.href.indexOf("singleview")>0,forceMailLogin=location.href.indexOf("mlogin")>0,forceEnableAutoScale=location.href.indexOf("autoscale")>0;if(!isDebug&&window.console){var _log=window.console.log,_logCache=[],MAX_LOG_CACHE=100;window.console.log=function(){_logCache.unshift(arguments),_logCache.length>MAX_LOG_CACHE&&(_logCache.length=MAX_LOG_CACHE)},window.alert=function(){},_WA.resumeLog=function(){window.console.log=_log;for(var a=_logCache.length;a--;)console.log.apply(console,_logCache[a]);_logCache=[]}}var docMode=document.documentMode,ua=navigator.userAgent.toLowerCase(),checkUA=function(a){return a.test(ua)},isOpera=checkUA(/opera/)||checkUA(/opr\//),isWebKit=checkUA(/webkit/),isChrome=!isOpera&&checkUA(/chrome/),isIE=!isOpera&&checkUA(/msie/)||ua.match(/rv:11\.0/i)&&ua.match(/Trident\/7\.0/i),isEdge=checkUA(/edge\/\d+/),isGecko=!isWebKit&&checkUA(/gecko/),isFF=isGecko&&!isIE,isMac=checkUA(/macintosh/),isIOS=checkUA(/iphone|ipad|ipod/),isIOSUnder10=isIOS&&(ua.match(/\sos\s(\d+)/)||["",1])[1]<10,isIOSOver10=isIOS&&(ua.match(/\sos\s(\d+)/)||["",1])[1]>10,isProblemStrictSafari=isWebKit&&isMac&&!isChrome&&!isOpera,isIOSSafari=isIOS&&isWebKit&&!isChrome&&!isOpera,pixelRatio=window.devicePixelRatio||1,orientationType=screen.msOrientation||screen.mozOrientation||(screen.orientation||{}).type||"",isRetina=pixelRatio>=1.5,isTouchDevice="ontouchstart"in document.documentElement,isMobile=-1!==ua.indexOf("; rv:")&&checkUA(/\(tablet;|\(mobile;/)||-1!==ua.indexOf("windows")&&-1!==ua.indexOf("phone")||checkUA(/Android|iPhone|iPad|iPod|IEMobile|Opera Mini|Lumia|meego|BlackBerry|bb10|rim/i),dl=window.location,isLocalhost=dl.hostname.indexOf("localhost")>-1,path="r/",base="",apply=function a(b,c,d){if(d&&a(b,d),c)for(var e in c)b[e]=c[e];return b},SPLITVIEW_COMFORT_WIDTH=768,snIsUIN=function(a){return a.indexOf("@uin.icq")>-1||null!=a.match(/^[0-9]+$/)},checkMinimalScreenRequirements=function(){var a=1,b=screen.width;return isMobile?b=Math.min(b,screen.height):isFF&&pixelRatio>1&&(a=pixelRatio),b*a>=SPLITVIEW_COMFORT_WIDTH};apply(WebIM,{resPath:base+path,imagePath:base+"images/",resLanguage:"ru",isDebug:isDebug,isIE:isIE,isEdge:isEdge,isFF:isFF,isWebKit:isWebKit,isChrome:isChrome,isOpera:isOpera,isMac:isMac,isIOS:isIOS,isIOSOver10:isIOSOver10,isIOSUnder10:isIOSUnder10,isProblemStrictSafari:isProblemStrictSafari,isIOSSafari:isIOSSafari,isRetina:isRetina,isTouchDevice:isTouchDevice,isDesktop:!isMobile,isSecure:"https"===(""+document.location).split(":")[0],isProduction:"string"==typeof PLATFORM_STRING&&"production"===PLATFORM_STRING,clipboardSupported:document.queryCommandSupported&&document.queryCommandSupported("Copy")&&!isIOSUnder10,MIN_WINDOW_HEIGHT:550,MIN_WINDOW_WIDTH:500,resizeableLayout:!0,orientation:orientationType,boardMode:!!window.BOARD_MODE,forceEnableAutoScale:forceEnableAutoScale,promoMode:!!window.PROMO_MODE,embedMode:self!==top,splitView:!window.BOARD_MODE&&!window.PROMO_MODE&&!forceSingleView&&!isIOS&&checkMinimalScreenRequirements(),zoom:1,apply:apply,applyIf:function(a,b){if(b)for(var c in b)"undefined"==typeof a[c]&&(a[c]=b[c]);return a},showPopup:function(a,b,c){return _WA.ui?_WA.ui.showInfoBubble(a,b,c):void 0},redirectToAuthPage:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};App.load("authPage",a)},waitForPromiseAuth:function(a){return new Promise(function(b){_WA.appIsLaunched||(_WA.authPage.loginWithoutReload=!0),_WA.authPage.successEvent.on(function(){b(a)},null,{single:!0}),_WA.redirectToAuthPage()})},namespace:function(a){var b=a.split("."),c=window[b[0]]=window[b[0]]||{};return WebIM.each(b.slice(1),function(a){c=c[a]=c[a]||{}}),c},getJSON:function(){return window.JSON},getUserCookieLogin:getUserCookieLogin,isNumber:function(a){return"number"==typeof a&&isFinite(a)},isString:function(a){return"string"==typeof a},isFunction:function(a){return"function"==typeof a},isObject:function(a){return"object"===_typeof2(a)},isBoolean:function(a){return"boolean"==typeof a},isDate:function(a){return"[object Date]"===Object.prototype.toString.apply(a)},isArray:function(a){return"[object Array]"===Object.prototype.toString.apply(a)},toArray:function(a){return WebIM.isArray(a)?a:Array.prototype.slice.call(a,0)},each:function(a,b,c){for(var d=a.length,e=0;d>e;++e)if(b.call(c||window,a[e],e,a)===!1)return},createDelegate:function(a,b,c,d){return function(){var e=WebIM.toArray(arguments);return d===!0?e=e.concat(c||[]):WebIM.isNumber(d)&&(e=e.slice(0,d).concat(c||[])),a.apply(b||window,e)}},emptyFn:function(){},now:function(){return Math.floor(new Date/1e3)},nowFixed:function(){var a=WebIM.serverTimeDiff||0;return Math.floor(+new Date/1e3)-a},setTimeout:function(a,b,c){return window.setTimeout(function(){_WA.util.Mnt.wrapTryCatch(a,c)},b)},setInterval:function(a,b,c){return window.setInterval(function(){_WA.util.Mnt.wrapTryCatch(a,c)},b)},debounce:function(a,b){function c(){return f?(d=arguments,void(e=this)):(a.apply(this,arguments),f=!0,void _WA.setTimeout(function(){f=!1,d&&(c.apply(e,d),d=e=null)},b))}var d,e,f=!1;return c},makeGet:function(a){var b=[];return WebIM.util.Object.each(a,function(a,c){b[b.length]=c+"="+encodeURIComponent(a)}),b.join("&")},error:function(a){throw isDebug&&console.log(a.message,a),_WA.util.Mnt,a},abstractError:function(){WebIM.error("Abstract method")},splitMail:function(a){return(a.match(/([^@]+)@(.+)/)||["",""]).slice(1)},sum:function(){var a="00000000 77073096 EE0E612C 990951BA 076DC419 706AF48F E963A535 9E6495A3 0EDB8832 79DCB8A4 E0D5E91E 97D2D988 09B64C2B 7EB17CBD E7B82D07 90BF1D91 1DB71064 6AB020F2 F3B97148 84BE41DE 1ADAD47D 6DDDE4EB F4D4B551 83D385C7 136C9856 646BA8C0 FD62F97A 8A65C9EC 14015C4F 63066CD9 FA0F3D63 8D080DF5 3B6E20C8 4C69105E D56041E4 A2677172 3C03E4D1 4B04D447 D20D85FD A50AB56B 35B5A8FA 42B2986C DBBBC9D6 ACBCF940 32D86CE3 45DF5C75 DCD60DCF ABD13D59 26D930AC 51DE003A C8D75180 BFD06116 21B4F4B5 56B3C423 CFBA9599 B8BDA50F 2802B89E 5F058808 C60CD9B2 B10BE924 2F6F7C87 58684C11 C1611DAB B6662D3D 76DC4190 01DB7106 98D220BC EFD5102A 71B18589 06B6B51F 9FBFE4A5 E8B8D433 7807C9A2 0F00F934 9609A88E E10E9818 7F6A0DBB 086D3D2D 91646C97 E6635C01 6B6B51F4 1C6C6162 856530D8 F262004E 6C0695ED 1B01A57B 8208F4C1 F50FC457 65B0D9C6 12B7E950 8BBEB8EA FCB9887C 62DD1DDF 15DA2D49 8CD37CF3 FBD44C65 4DB26158 3AB551CE A3BC0074 D4BB30E2 4ADFA541 3DD895D7 A4D1C46D D3D6F4FB 4369E96A 346ED9FC AD678846 DA60B8D0 44042D73 33031DE5 AA0A4C5F DD0D7CC9 5005713C 270241AA BE0B1010 C90C2086 5768B525 206F85B3 B966D409 CE61E49F 5EDEF90E 29D9C998 B0D09822 C7D7A8B4 59B33D17 2EB40D81 B7BD5C3B C0BA6CAD EDB88320 9ABFB3B6 03B6E20C 74B1D29A EAD54739 9DD277AF 04DB2615 73DC1683 E3630B12 94643B84 0D6D6A3E 7A6A5AA8 E40ECF0B 9309FF9D 0A00AE27 7D079EB1 F00F9344 8708A3D2 1E01F268 6906C2FE F762575D 806567CB 196C3671 6E6B06E7 FED41B76 89D32BE0 10DA7A5A 67DD4ACC F9B9DF6F 8EBEEFF9 17B7BE43 60B08ED5 D6D6A3E8 A1D1937E 38D8C2C4 4FDFF252 D1BB67F1 A6BC5767 3FB506DD 48B2364B D80D2BDA AF0A1B4C 36034AF6 41047A60 DF60EFC3 A867DF55 316E8EEF 4669BE79 CB61B38C BC66831A 256FD2A0 5268E236 CC0C7795 BB0B4703 220216B9 5505262F C5BA3BBE B2BD0B28 2BB45A92 5CB36A04 C2D7FFA7 B5D0CF31 2CD99E8B 5BDEAE1D 9B64C2B0 EC63F226 756AA39C 026D930A 9C0906A9 EB0E363F 72076785 05005713 95BF4A82 E2B87A14 7BB12BAE 0CB61B38 92D28E9B E5D5BE0D 7CDCEFB7 0BDBDF21 86D3D2D4 F1D4E242 68DDB3F8 1FDA836E 81BE16CD F6B9265B 6FB077E1 18B74777 88085AE6 FF0F6A70 66063BCA 11010B5C 8F659EFF F862AE69 616BFFD3 166CCF45 A00AE278 D70DD2EE 4E048354 3903B3C2 A7672661 D06016F7 4969474D 3E6E77DB AED16A4A D9D65ADC 40DF0B66 37D83BF0 A9BCAE53 DEBB9EC5 47B2CF7F 30B5FFE9 BDBDF21C CABAC28A 53B39330 24B4A3A6 BAD03605 CDD70693 54DE5729 23D967BF B3667A2E C4614AB8 5D681B02 2A6F2B94 B40BBE37 C30C8EA1 5A05DF1B 2D02EF8D".split(" ");
return function(b){for(var c=-1,d=0,e=b.length;e>d;d++){var f=255&(c^b.charCodeAt(d));c=c>>>8^parseInt(a[f],16)}return c^=-1,0>c&&(c+=4294967296),c.toString(16)}}(),TIME_INFINITY:9999999999,MINUTE:60,HOUR:3600,DAY:86400,WEEK:604800,YEAR:31536e3,serverTimeDiff:0,getFixedTS:function(a,b){var c=WebIM.serverTimeDiff||0;return+a+c*(b?1e3:1)},uniq:function(){return""+Math.round(99999*Math.random())},safeSn:function(a){return"string"==typeof a?a:""},isUIN:snIsUIN,isEmail:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",b=a.match(/[^@:]+@[^:]+/);return b&&b[0]||!1},uinAsName:function(a){return snIsUIN(a)?a.replace(/(\d{1,3})(?=\d{6}$|\d{3}$)/g,"$1 "):a},ts:function(){return+new Date}}),WebIM.populateList=[],WebIM.MIN_WINDOW_WIDTH=WebIM.splitView?660:350,WebIM.namespace("WebIM.util"),function(){if(!("getSelection"in window))var a=function(){var a;a=WebIM.util.rangy=function(){function a(a,b){var c=_typeof2(a[b]);return c==m||c==l&&!!a[b]||"unknown"==c}function b(a,b){return _typeof2(a[b])==l&&!!a[b]}function c(a,b){return _typeof2(a[b])!=n}function d(a){return function(b,c){for(var d=c.length;d--;)if(!a(b,c[d]))return!1;return!0}}function e(a){return a&&s(a,r)&&u(a,q)}function f(a,b){b?window.alert(a):_typeof2(window.console)!=n&&_typeof2(window.console.log)!=n&&window.console.log(a)}function g(a){v.initialized=!0,v.supported=!1,f("Rangy is not supported on this page in your browser. Reason: "+a,v.config.alertOnFail)}function h(a){f("Rangy warning: "+a,v.config.alertOnWarn)}function i(){if(!v.initialized){var c,d=!1,f=!1;a(document,"createRange")&&(c=document.createRange(),s(c,p)&&u(c,o)&&(d=!0),c.detach());var h=b(document,"body")?document.body:document.getElementsByTagName("body")[0];if(!h||"body"!=h.nodeName.toLowerCase())return void g("No body element found");if(h&&a(h,"createTextRange")&&(c=h.createTextRange(),e(c)&&(f=!0)),!d&&!f)return void g("Neither Range nor TextRange are available");v.initialized=!0,v.features={implementsDomRange:d,implementsTextRange:f};for(var i=x.concat(w),j=0,k=i.length;k>j;++j)try{i[j](v)}catch(l){b(window,"console")&&a(window.console,"log")&&window.console.log("Rangy init listener threw an exception. Continuing.",l)}}}function j(a){a=a||window,i();for(var b=0,c=y.length;c>b;++b)y[b](a)}function k(a){this.name=a,this.initialized=!1,this.supported=!1}var l="object",m="function",n="undefined",o=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],p=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],q=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],r=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],s=d(a),t=d(b),u=d(c),v={version:"1.3alpha.681",initialized:!1,supported:!0,util:{isHostMethod:a,isHostObject:b,isHostProperty:c,areHostMethods:s,areHostObjects:t,areHostProperties:u,isTextRange:e},features:{},modules:{},config:{alertOnFail:!0,alertOnWarn:!1,preferTextRange:!1}};v.fail=g,v.warn=h,{}.hasOwnProperty?v.util.extend=function(a,b,c){var d,e;for(var f in b)b.hasOwnProperty(f)&&(d=a[f],e=b[f],c&&null!==d&&"object"==_typeof2(d)&&null!==e&&"object"==_typeof2(e)&&v.util.extend(d,e,!0),a[f]=e);return a}:g("hasOwnProperty not supported");var w=[],x=[];v.init=i,v.addInitListener=function(a){v.initialized?a(v):w.push(a)};var y=[];v.addCreateMissingNativeApiListener=function(a){y.push(a)},v.createMissingNativeApi=j,k.prototype={fail:function(a){throw this.initialized=!0,this.supported=!1,new Error("Module '"+this.name+"' failed to load: "+a)},warn:function(a){v.warn("Module "+this.name+": "+a)},deprecationNotice:function(a,b){v.warn("DEPRECATED: "+a+" in module "+this.name+"is deprecated. Please use "+b+" instead")},createError:function(a){return new Error("Error in Rangy "+this.name+" module: "+a)}},v.createModule=function(a,b){var c=new k(a);v.modules[a]=c,x.push(function(a){b(a,c),c.initialized=!0,c.supported=!0})},v.requireModules=function(a){for(var b,c,d=0,e=a.length;e>d;++d){if(c=a[d],b=v.modules[c],!(b&&b instanceof k))throw new Error("Module '"+c+"' not found");if(!b.supported)throw new Error("Module '"+c+"' not supported")}};var z=!1,A=function(a){z||(z=!0,v.initialized||i())};return("undefined"==typeof window?"undefined":_typeof2(window))==n?void g("No window found"):("undefined"==typeof document?"undefined":_typeof2(document))==n?void g("No document found"):(a(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",A,!1),a(window,"addEventListener")?window.addEventListener("load",A,!1):a(window,"attachEvent")?window.attachEvent("onload",A):g("Window does not have required addEventListener or attachEvent method"),v)}(),a.createModule("DomUtil",function(a,b){function c(a){var b;return _typeof2(a.namespaceURI)==D||null===(b=a.namespaceURI)||"http://www.w3.org/1999/xhtml"==b}function d(a){var b=a.parentNode;return 1==b.nodeType?b:null}function e(a){for(var b=0;a=a.previousSibling;)b++;return b}function f(a){switch(a.nodeType){case 7:case 10:return 0;case 3:case 8:return a.length;default:return a.childNodes.length}}function g(a,b){var c,d=[];for(c=a;c;c=c.parentNode)d.push(c);for(c=b;c;c=c.parentNode)if(H(d,c))return c;return null}function h(a,b,c){for(var d=c?b:b.parentNode;d;){if(d===a)return!0;d=d.parentNode}return!1}function i(a,b){return h(a,b,!0)}function j(a,b,c){for(var d,e=c?a:a.parentNode;e;){if(d=e.parentNode,d===b)return e;e=d}return null}function k(a){var b=a.nodeType;return 3==b||4==b||8==b}function l(a){if(!a)return!1;var b=a.nodeType;return 3==b||8==b}function m(a,b){var c=b.nextSibling,d=b.parentNode;return c?d.insertBefore(a,c):d.appendChild(a),a}function n(a,b,c){var d=a.cloneNode(!1);if(d.deleteData(0,b),a.deleteData(b,a.length-b),m(d,a),c)for(var f,g=0;f=c[g++];)f.node==a&&f.offset>b?(f.node=d,f.offset-=b):f.node==a.parentNode&&f.offset>e(a)&&++f.offset;return d}function o(a){if(9==a.nodeType)return a;if(_typeof2(a.ownerDocument)!=D)return a.ownerDocument;if(_typeof2(a.document)!=D)return a.document;if(a.parentNode)return o(a.parentNode);throw b.createError("getDocument: no document found for node")}function p(a){var c=o(a);if(_typeof2(c.defaultView)!=D)return c.defaultView;if(_typeof2(c.parentWindow)!=D)return c.parentWindow;throw b.createError("Cannot get a window object for node")}function q(a){if(_typeof2(a.contentDocument)!=D)return a.contentDocument;if(_typeof2(a.contentWindow)!=D)return a.contentWindow.document;throw b.createError("getIframeDocument: No Document object found for iframe element")}function r(a){if(_typeof2(a.contentWindow)!=D)return a.contentWindow;if(_typeof2(a.contentDocument)!=D)return a.contentDocument.defaultView;throw b.createError("getIframeWindow: No Window object found for iframe element")}function s(a){return E.isHostObject(a,"body")?a.body:a.getElementsByTagName("body")[0]}function t(a){return a&&E.isHostMethod(a,"setTimeout")&&E.isHostObject(a,"document")}function u(a){var b;return a?E.isHostProperty(a,"nodeType")?b=1==a.nodeType&&"iframe"==a.tagName.toLowerCase()?q(a):o(a):t(a)&&(b=a.document):b=document,b}function v(a){for(var b;b=a.parentNode;)a=b;return a}function w(a,c,d,f){var h,i,k,l,m;if(a==d)return c===f?0:f>c?-1:1;if(h=j(d,a,!0))return c<=e(h)?-1:1;if(h=j(a,d,!0))return e(h)<f?-1:1;if(i=g(a,d),k=a===i?i:j(a,i,!0),l=d===i?i:j(d,i,!0),k===l)throw b.createError("comparePoints got to case 4 and childA and childB are the same!");for(m=i.firstChild;m;){if(m===k)return-1;if(m===l)return 1;m=m.nextSibling}}function x(a){if(!a)return"[No node]";if(k(a))return'"'+a.data+'"';if(1==a.nodeType){var b=a.id?' id="'+a.id+'"':"";return"<"+a.nodeName+b+">["+a.childNodes.length+"]"}return a.nodeName}function y(a){for(var b,c=o(a).createDocumentFragment();b=a.firstChild;)c.appendChild(b);return c}function z(a){this.root=a,this._next=a}function A(a){return new z(a)}function B(a,b){this.node=a,this.offset=b}function C(a){this.code=this[a],this.codeName=a,this.message="DOMException: "+this.codeName}var D="undefined",E=a.util;E.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||b.fail("document missing a Node creation method"),E.isHostMethod(document,"getElementsByTagName")||b.fail("document missing getElementsByTagName method");var F=document.createElement("div");E.areHostMethods(F,["insertBefore","appendChild","cloneNode"]||!E.areHostObjects(F,["previousSibling","nextSibling","childNodes","parentNode"]))||b.fail("Incomplete Element implementation"),E.isHostProperty(F,"innerHTML")||b.fail("Element is missing innerHTML property");var G=document.createTextNode("test");E.areHostMethods(G,["splitText","deleteData","insertData","appendData","cloneNode"]||!E.areHostObjects(F,["previousSibling","nextSibling","childNodes","parentNode"])||!E.areHostProperties(G,["data"]))||b.fail("Incomplete Text Node implementation");var H=function(a,b){for(var c=a.length;c--;)if(a[c]===b)return!0;return!1};z.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var a,b,c=this._current=this._next;if(this._current)if(a=c.firstChild)this._next=a;else{for(b=null;c!==this.root&&!(b=c.nextSibling);)c=c.parentNode;this._next=b}return this._current},detach:function(){this._current=this._next=this.root=null}},B.prototype={equals:function(a){return!!a&&this.node===a.node&&this.offset==a.offset},inspect:function(){return"[DomPosition("+x(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},C.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11},C.prototype.toString=function(){return this.message},a.dom={arrayContains:H,isHtmlNamespace:c,parentElement:d,getNodeIndex:e,getNodeLength:f,getCommonAncestor:g,isAncestorOf:h,isOrIsAncestorOf:i,getClosestAncestorIn:j,isCharacterDataNode:k,isTextOrCommentNode:l,insertAfter:m,splitDataNode:n,getDocument:o,getWindow:p,getIframeWindow:r,getIframeDocument:q,getBody:s,isWindow:t,getContentDocument:u,getRootContainer:v,comparePoints:w,inspectNode:x,fragmentFromNodeChildren:y,createIterator:A,DomPosition:B},a.DOMException=C}),a.createModule("DomRange",function(a,b){function c(a,b){return 3!=a.nodeType&&(M.isOrIsAncestorOf(a,b.startContainer)||M.isOrIsAncestorOf(a,b.endContainer))}function d(a){return M.getDocument(a.startContainer)}function e(a){return new O(a.parentNode,M.getNodeIndex(a))}function f(a){return new O(a.parentNode,M.getNodeIndex(a)+1)}function g(a,b,c){var d=11==a.nodeType?a.firstChild:a;return M.isCharacterDataNode(b)?c==b.length?M.insertAfter(a,b):b.parentNode.insertBefore(a,0==c?b:M.splitDataNode(b,c)):c>=b.childNodes.length?b.appendChild(a):b.insertBefore(a,b.childNodes[c]),d}function h(a,b,c){if(B(a),B(b),d(b)!=d(a))throw new P("WRONG_DOCUMENT_ERR");var e=M.comparePoints(a.startContainer,a.startOffset,b.endContainer,b.endOffset),f=M.comparePoints(a.endContainer,a.endOffset,b.startContainer,b.startOffset);return c?0>=e&&f>=0:0>e&&f>0}function i(a){for(var b,c,e,f=d(a.range).createDocumentFragment();c=a.next();){if(b=a.isPartiallySelectedSubtree(),c=c.cloneNode(!b),b&&(e=a.getSubtreeIterator(),c.appendChild(i(e)),e.detach(!0)),10==c.nodeType)throw new P("HIERARCHY_REQUEST_ERR");f.appendChild(c)}return f}function j(a,b,c){var d,e;c=c||{stop:!1};for(var f,g;f=a.next();)if(a.isPartiallySelectedSubtree()){if(b(f)===!1)return void(c.stop=!0);if(g=a.getSubtreeIterator(),j(g,b,c),g.detach(!0),c.stop)return}else for(d=M.createIterator(f);e=d.next();)if(b(e)===!1)return void(c.stop=!0)}function k(a){for(var b;a.next();)a.isPartiallySelectedSubtree()?(b=a.getSubtreeIterator(),k(b),b.detach(!0)):a.remove()}function l(a){for(var b,c,e=d(a.range).createDocumentFragment();b=a.next();){if(a.isPartiallySelectedSubtree()?(b=b.cloneNode(!1),c=a.getSubtreeIterator(),b.appendChild(l(c)),c.detach(!0)):a.remove(),10==b.nodeType)throw new P("HIERARCHY_REQUEST_ERR");e.appendChild(b)}return e}function m(a,b,c){var d,e=!!b&&!!b.length,f=!!c;e&&(d=new RegExp("^("+b.join("|")+")$"));var g=[];return j(new o(a,!1),function(a){(!e||d.test(a.nodeType))&&(!f||c(a))&&g.push(a)}),g}function n(a){var b="undefined"==typeof a.getName?"Range":a.getName();return"["+b+"("+M.inspectNode(a.startContainer)+":"+a.startOffset+", "+M.inspectNode(a.endContainer)+":"+a.endOffset+")]"}function o(a,b){if(this.range=a,this.clonePartiallySelectedTextNodes=b,!a.collapsed){this.sc=a.startContainer,this.so=a.startOffset,this.ec=a.endContainer,this.eo=a.endOffset;var c=a.commonAncestorContainer;this.sc===this.ec&&M.isCharacterDataNode(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==c||M.isCharacterDataNode(this.sc)?M.getClosestAncestorIn(this.sc,c,!0):this.sc.childNodes[this.so],this._last=this.ec!==c||M.isCharacterDataNode(this.ec)?M.getClosestAncestorIn(this.ec,c,!0):this.ec.childNodes[this.eo-1])}}function p(a){this.code=this[a],this.codeName=a,this.message="RangeException: "+this.codeName}function q(a){return function(b,c){for(var d,e=c?b:b.parentNode;e;){if(d=e.nodeType,M.arrayContains(a,d))return e;e=e.parentNode}return null}}function r(a,b){if(Y(a,b))throw new p("INVALID_NODE_TYPE_ERR")}function s(a){if(!a.startContainer)throw new P("INVALID_STATE_ERR")}function t(a,b){if(!M.arrayContains(b,a.nodeType))throw new p("INVALID_NODE_TYPE_ERR")}function u(a,b){if(0>b||b>(M.isCharacterDataNode(a)?a.length:a.childNodes.length))throw new P("INDEX_SIZE_ERR")}function v(a,b){if(W(a,!0)!==W(b,!0))throw new P("WRONG_DOCUMENT_ERR")}function w(a){if(X(a,!0))throw new P("NO_MODIFICATION_ALLOWED_ERR")}function x(a,b){if(!a)throw new P(b)}function y(a){return!M.arrayContains(R,a.nodeType)&&!W(a,!0)}function z(a,b){return b<=(M.isCharacterDataNode(a)?a.length:a.childNodes.length)}function A(a){return!!a.startContainer&&!!a.endContainer&&!y(a.startContainer)&&!y(a.endContainer)&&z(a.startContainer,a.startOffset)&&z(a.endContainer,a.endOffset)}function B(a){if(s(a),!A(a))throw new Error("Range error: Range is no longer valid after DOM mutation ("+a.inspect()+")")}function C(a,b){B(a);var c=a.startContainer,d=a.startOffset,e=a.endContainer,f=a.endOffset,g=c===e;M.isCharacterDataNode(e)&&f>0&&f<e.length&&M.splitDataNode(e,f,b),M.isCharacterDataNode(c)&&d>0&&d<c.length&&(c=M.splitDataNode(c,d,b),g?(f-=d,e=c):e==c.parentNode&&f>=M.getNodeIndex(c)&&f++,d=0),a.setStartAndEnd(c,d,e,f)}function D(){}function E(a){a.START_TO_START=ca,a.START_TO_END=da,a.END_TO_END=ea,a.END_TO_START=fa,a.NODE_BEFORE=ga,a.NODE_AFTER=ha,a.NODE_BEFORE_AND_AFTER=ia,a.NODE_INSIDE=ja}function F(a){E(a),E(a.prototype)}function G(a,b){return function(){B(this);var c,d,e=this.startContainer,g=this.startOffset,h=this.commonAncestorContainer,i=new o(this,!0);e!==h&&(c=M.getClosestAncestorIn(e,h,!0),d=f(c),e=d.node,g=d.offset),j(i,w),i.reset();var k=a(i);return i.detach(),b(this,e,g,e,g),k}}function H(a,b,d){function g(a,b){return function(c){s(this),t(c,Q),t(V(c),R);var d=(a?e:f)(c);(b?h:i)(this,d.node,d.offset)}}function h(a,c,d){var e=a.endContainer,f=a.endOffset;(c!==a.startContainer||d!==a.startOffset)&&((V(c)!=V(e)||1==M.comparePoints(c,d,e,f))&&(e=c,f=d),b(a,c,d,e,f))}function i(a,c,d){var e=a.startContainer,f=a.startOffset;(c!==a.endContainer||d!==a.endOffset)&&((V(c)!=V(e)||-1==M.comparePoints(c,d,e,f))&&(e=c,f=d),b(a,e,f,c,d))}a.prototype=new D,N.extend(a.prototype,{setStart:function(a,b){s(this),r(a,!0),u(a,b),h(this,a,b)},setEnd:function(a,b){s(this),r(a,!0),u(a,b),i(this,a,b)},setStartAndEnd:function(){s(this);var a=arguments,c=a[0],d=a[1],e=c,f=d;switch(a.length){case 3:f=a[2];break;case 4:e=a[2],f=a[3]}b(this,c,d,e,f)},setStartBefore:g(!0,!0),setStartAfter:g(!1,!0),setEndBefore:g(!0,!1),setEndAfter:g(!1,!1),collapse:function(a){B(this),a?b(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):b(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(a){s(this),r(a,!0),b(this,a,0,a,M.getNodeLength(a))},selectNode:function(a){s(this),r(a,!1),t(a,Q);var c=e(a),d=f(a);b(this,c.node,c.offset,d.node,d.offset)},extractContents:G(l,b),deleteContents:G(k,b),canSurroundContents:function(){B(this),w(this.startContainer),w(this.endContainer);var a=new o(this,!0),b=a._first&&c(a._first,this)||a._last&&c(a._last,this);return a.detach(),!b},detach:function(){d(this)},splitBoundaries:function(){C(this)},splitBoundariesPreservingPositions:function(a){C(this,a)},normalizeBoundaries:function(){B(this);var a=this.startContainer,c=this.startOffset,d=this.endContainer,e=this.endOffset,f=function(a){var b=a.nextSibling;b&&b.nodeType==a.nodeType&&(d=a,e=a.length,a.appendData(b.data),b.parentNode.removeChild(b))},g=function k(b){var f=b.previousSibling;if(f&&f.nodeType==b.nodeType){a=b;var k=b.length;if(c=f.length,b.insertData(0,f.data),f.parentNode.removeChild(f),a==d)e+=c,d=a;else if(d==b.parentNode){var g=M.getNodeIndex(b);e==g?(d=b,e=k):e>g&&e--}}},h=!0;if(M.isCharacterDataNode(d))d.length==e&&f(d);else{if(e>0){var i=d.childNodes[e-1];i&&M.isCharacterDataNode(i)&&f(i)}h=!this.collapsed}if(h){if(M.isCharacterDataNode(a))0==c&&g(a);else if(c<a.childNodes.length){var j=a.childNodes[c];j&&M.isCharacterDataNode(j)&&g(j)}}else a=d,c=e;b(this,a,c,d,e)},collapseToPoint:function(a,b){s(this),r(a,!0),u(a,b),this.setStartAndEnd(a,b)}}),F(a)}function I(a){a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset,a.commonAncestorContainer=a.collapsed?a.startContainer:M.getCommonAncestor(a.startContainer,a.endContainer)}function J(a,b,c,d,e){a.startContainer=b,a.startOffset=c,a.endContainer=d,a.endOffset=e,I(a)}function K(a){s(a),a.startContainer=a.startOffset=a.endContainer=a.endOffset=null,a.collapsed=a.commonAncestorContainer=null}function L(a){this.startContainer=a,this.startOffset=0,this.endContainer=a,this.endOffset=0,I(this)}a.requireModules(["DomUtil"]);var M=a.dom,N=a.util,O=M.DomPosition,P=a.DOMException;o.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var a=this._current=this._next;return a&&(this._next=a!==this._last?a.nextSibling:null,M.isCharacterDataNode(a)&&this.clonePartiallySelectedTextNodes&&(a===this.ec&&(a=a.cloneNode(!0)).deleteData(this.eo,a.length-this.eo),this._current===this.sc&&(a=a.cloneNode(!0)).deleteData(0,this.so))),a},remove:function(){var a,b,c=this._current;!M.isCharacterDataNode(c)||c!==this.sc&&c!==this.ec?c.parentNode&&c.parentNode.removeChild(c):(a=c===this.sc?this.so:0,b=c===this.ec?this.eo:c.length,a!=b&&c.deleteData(a,b-a))},isPartiallySelectedSubtree:function(){var a=this._current;return c(a,this.range)},getSubtreeIterator:function(){var a;if(this.isSingleCharacterDataNode)a=this.range.cloneRange(),a.collapse(!1);else{a=new L(d(this.range));var b=this._current,c=b,e=0,f=b,g=M.getNodeLength(b);M.isOrIsAncestorOf(b,this.sc)&&(c=this.sc,e=this.so),M.isOrIsAncestorOf(b,this.ec)&&(f=this.ec,g=this.eo),J(a,c,e,f,g)}return new o(a,this.clonePartiallySelectedTextNodes)},detach:function(a){a&&this.range.detach(),this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}},p.prototype={BAD_BOUNDARYPOINTS_ERR:1,INVALID_NODE_TYPE_ERR:2},p.prototype.toString=function(){return this.message};var Q=[1,3,4,5,7,8,10],R=[2,9,11],S=[5,6,10,12],T=[1,3,4,5,7,8,10,11],U=[1,3,4,5,7,8],V=M.getRootContainer,W=q([9,11]),X=q(S),Y=q([6,10,12]),Z=document.createElement("style"),$=!1;try{Z.innerHTML="<b>x</b>",$=3==Z.firstChild.nodeType}catch(_){}a.features.htmlParsingConforms=$;var aa=$?function(a){var b=this.startContainer,c=M.getDocument(b);if(!b)throw new P("INVALID_STATE_ERR");var d=null;return 1==b.nodeType?d=b:M.isCharacterDataNode(b)&&(d=M.parentElement(b)),d=null===d||"HTML"==d.nodeName&&M.isHtmlNamespace(M.getDocument(d).documentElement)&&M.isHtmlNamespace(d)?c.createElement("body"):d.cloneNode(!1),d.innerHTML=a,M.fragmentFromNodeChildren(d)}:function(a){s(this);var b=d(this),c=b.createElement("body");return c.innerHTML=a,M.fragmentFromNodeChildren(c)},ba=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],ca=0,da=1,ea=2,fa=3,ga=0,ha=1,ia=2,ja=3;D.prototype={compareBoundaryPoints:function(a,b){B(this),v(this.startContainer,b.startContainer);var c,d,e,f,g=a==fa||a==ca?"start":"end",h=a==da||a==ca?"start":"end";return c=this[g+"Container"],d=this[g+"Offset"],e=b[h+"Container"],f=b[h+"Offset"],M.comparePoints(c,d,e,f)},insertNode:function(a){if(B(this),t(a,T),w(this.startContainer),M.isOrIsAncestorOf(a,this.startContainer))throw new P("HIERARCHY_REQUEST_ERR");var b=g(a,this.startContainer,this.startOffset);this.setStartBefore(b)},cloneContents:function(){B(this);var a,b;if(this.collapsed)return d(this).createDocumentFragment();if(this.startContainer===this.endContainer&&M.isCharacterDataNode(this.startContainer))return a=this.startContainer.cloneNode(!0),a.data=a.data.slice(this.startOffset,this.endOffset),b=d(this).createDocumentFragment(),b.appendChild(a),b;var c=new o(this,!0);return a=i(c),c.detach(),a},canSurroundContents:function(){B(this),w(this.startContainer),w(this.endContainer);var a=new o(this,!0),b=a._first&&c(a._first,this)||a._last&&c(a._last,this);return a.detach(),!b},surroundContents:function(a){if(t(a,U),!this.canSurroundContents())throw new p("BAD_BOUNDARYPOINTS_ERR");var b=this.extractContents();if(a.hasChildNodes())for(;a.lastChild;)a.removeChild(a.lastChild);g(a,this.startContainer,this.startOffset),a.appendChild(b),this.selectNode(a)},cloneRange:function(){B(this);for(var a,b=new L(d(this)),c=ba.length;c--;)a=ba[c],b[a]=this[a];return b},toString:function(){B(this);var a=this.startContainer;if(a===this.endContainer&&M.isCharacterDataNode(a))return 3==a.nodeType||4==a.nodeType?a.data.slice(this.startOffset,this.endOffset):"";var b=[],c=new o(this,!0);return j(c,function(a){(3==a.nodeType||4==a.nodeType)&&b.push(a.data)}),c.detach(),b.join("")},compareNode:function(a){B(this);var b=a.parentNode,c=M.getNodeIndex(a);if(!b)throw new P("NOT_FOUND_ERR");var d=this.comparePoint(b,c),e=this.comparePoint(b,c+1);return 0>d?e>0?ia:ga:e>0?ha:ja},comparePoint:function(a,b){return B(this),x(a,"HIERARCHY_REQUEST_ERR"),v(a,this.startContainer),M.comparePoints(a,b,this.startContainer,this.startOffset)<0?-1:M.comparePoints(a,b,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:aa,toHtml:function(){B(this);var a=this.commonAncestorContainer.parentNode.cloneNode(!1);return a.appendChild(this.cloneContents()),a.innerHTML},intersectsNode:function(a,b){if(B(this),x(a,"NOT_FOUND_ERR"),M.getDocument(a)!==d(this))return!1;var c=a.parentNode,e=M.getNodeIndex(a);x(c,"NOT_FOUND_ERR");var f=M.comparePoints(c,e,this.endContainer,this.endOffset),g=M.comparePoints(c,e+1,this.startContainer,this.startOffset);return b?0>=f&&g>=0:0>f&&g>0},isPointInRange:function(a,b){return B(this),x(a,"HIERARCHY_REQUEST_ERR"),v(a,this.startContainer),M.comparePoints(a,b,this.startContainer,this.startOffset)>=0&&M.comparePoints(a,b,this.endContainer,this.endOffset)<=0},intersectsRange:function(a){return h(this,a,!1)},intersectsOrTouchesRange:function(a){return h(this,a,!0)},intersection:function(a){if(this.intersectsRange(a)){var b=M.comparePoints(this.startContainer,this.startOffset,a.startContainer,a.startOffset),c=M.comparePoints(this.endContainer,this.endOffset,a.endContainer,a.endOffset),d=this.cloneRange();return-1==b&&d.setStart(a.startContainer,a.startOffset),1==c&&d.setEnd(a.endContainer,a.endOffset),d}return null},union:function(a){if(this.intersectsOrTouchesRange(a)){var b=this.cloneRange();return-1==M.comparePoints(a.startContainer,a.startOffset,this.startContainer,this.startOffset)&&b.setStart(a.startContainer,a.startOffset),1==M.comparePoints(a.endContainer,a.endOffset,this.endContainer,this.endOffset)&&b.setEnd(a.endContainer,a.endOffset),b}throw new p("Ranges do not intersect")},containsNode:function(a,b){return b?this.intersectsNode(a,!1):this.compareNode(a)==ja},containsNodeContents:function(a){return this.comparePoint(a,0)>=0&&this.comparePoint(a,M.getNodeLength(a))<=0},containsRange:function(a){var b=this.intersection(a);return null!==b&&a.equals(b)},containsNodeText:function(a){var b=this.cloneRange();b.selectNode(a);var c=b.getNodes([3]);if(c.length>0){b.setStart(c[0],0);var d=c.pop();b.setEnd(d,d.length);var e=this.containsRange(b);return b.detach(),e}return this.containsNodeContents(a)},getNodes:function(a,b){return B(this),m(this,a,b)},getDocument:function(){return d(this)},collapseBefore:function(a){s(this),this.setEndBefore(a),this.collapse(!1)},collapseAfter:function(a){s(this),this.setStartAfter(a),this.collapse(!0)},getName:function(){return"DomRange"},equals:function(a){return L.rangesEqual(this,a)},isValid:function(){return A(this)},inspect:function(){return n(this)}},H(L,J,K),a.rangePrototype=D.prototype,N.extend(L,{rangeProperties:ba,RangeIterator:o,copyComparisonConstants:F,createPrototypeRange:H,inspect:n,getRangeDocument:d,rangesEqual:function(a,b){return a.startContainer===b.startContainer&&a.startOffset===b.startOffset&&a.endContainer===b.endContainer&&a.endOffset===b.endOffset}}),a.DomRange=L,a.RangeException=p}),a.createModule("WrappedRange",function(a,b){function c(a,c){if(a=i.getContentDocument(a),!a)throw b.createError(c+"(): Parameter must be a Document or other DOM node, or a Window object");return a}function d(a){var b=a.parentElement(),c=a.duplicate();c.collapse(!0);var d=c.parentElement();c=a.duplicate(),c.collapse(!1);var e=c.parentElement(),f=d==e?d:i.getCommonAncestor(d,e);return f==b?f:i.getCommonAncestor(b,f)}function e(a){return 0==a.compareEndPoints("StartToEnd",a)}function f(a,b,c,d,e){var f=a.duplicate();f.collapse(c);var g=f.parentElement();if(i.isOrIsAncestorOf(b,g)||(g=b),!g.canHaveHTML)return new k(g.parentNode,i.getNodeIndex(g));var h=i.getDocument(g).createElement("span");h.parentNode&&h.parentNode.removeChild(h);for(var j,l,m,n,o,p=c?"StartToStart":"StartToEnd",q=e&&e.containerElement==g?e.nodeIndex:0,r=g.childNodes.length,s=r,t=s;t==r?g.appendChild(h):g.insertBefore(h,g.childNodes[t]),f.moveToElementText(h),j=f.compareEndPoints(p,a),0!=j&&q!=s;){if(-1==j){if(s==q+1)break;q=t}else s=s==q+1?q:t;t=Math.floor((q+s)/2),g.removeChild(h)}if(o=h.nextSibling,-1==j&&o&&i.isCharacterDataNode(o)){f.setEndPoint(c?"EndToStart":"EndToEnd",a);var u;if(/[\r\n]/.test(o.data)){var v=f.duplicate(),w=v.text.replace(/\r\n/g,"\r").length;for(u=v.moveStart("character",w);-1==(j=v.compareEndPoints("StartToEnd",v));)u++,v.moveStart("character",1)}else u=f.text.length;n=new k(o,u)}else l=(d||!c)&&h.previousSibling,m=(d||c)&&h.nextSibling,n=m&&i.isCharacterDataNode(m)?new k(m,0):l&&i.isCharacterDataNode(l)?new k(l,l.data.length):new k(g,i.getNodeIndex(h));return h.parentNode.removeChild(h),{boundaryPosition:n,nodeInfo:{nodeIndex:t,containerElement:g}}}function g(a,b){var c,d,e,f,g=a.offset,h=i.getDocument(a.node),j=h.body.createTextRange(),k=i.isCharacterDataNode(a.node);return k?(c=a.node,d=c.parentNode):(f=a.node.childNodes,c=g<f.length?f[g]:null,d=a.node),e=h.createElement("span"),e.innerHTML="&#feff;",c?d.insertBefore(e,c):d.appendChild(e),j.moveToElementText(e),j.collapse(!b),d.removeChild(e),k&&j[b?"moveStart":"moveEnd"]("character",g),j}a.requireModules(["DomUtil","DomRange"]);var h,i=a.dom,j=a.util,k=i.DomPosition,l=a.DomRange;if(!a.features.implementsDomRange||a.features.implementsTextRange&&a.config.preferTextRange){if(a.features.implementsTextRange){h=function(a){this.textRange=a,this.refresh()},h.prototype=new l(document),h.prototype.refresh=function(){var a,b,c,g=d(this.textRange);e(this.textRange)?b=a=f(this.textRange,g,!0,!0).boundaryPosition:(c=f(this.textRange,g,!0,!1),a=c.boundaryPosition,b=f(this.textRange,g,!1,!1,c.nodeInfo).boundaryPosition),this.setStart(a.node,a.offset),this.setEnd(b.node,b.offset)},l.copyComparisonConstants(h);var m=function(){return this}();"undefined"==typeof m.Range&&(m.Range=h),a.createNativeRange=function(a){return a=c(a,"createNativeRange"),a.body.createTextRange()}}}else(function(){function a(a){for(var b,c=g.length;c--;)b=g[c],a[b]=a.nativeRange[b];a.collapsed=a.startContainer===a.endContainer&&a.startOffset===a.endOffset}function c(a,b,c,d,e){var f=a.startContainer!==b||a.startOffset!=c,g=a.endContainer!==d||a.endOffset!=e,h=!a.equals(a.nativeRange);(f||g||h)&&(a.setEnd(d,e),a.setStart(b,c))}function d(a){a.nativeRange.detach(),a.detached=!0;for(var b,c=g.length;c--;)b=g[c],a[b]=null}var e,f,g=l.rangeProperties;h=function(c){if(!c)throw b.createError("WrappedRange: Range must be specified");this.nativeRange=c,a(this)},l.createPrototypeRange(h,c,d),e=h.prototype,e.selectNode=function(b){this.nativeRange.selectNode(b),a(this)},e.cloneContents=function(){return this.nativeRange.cloneContents()},e.surroundContents=function(b){this.nativeRange.surroundContents(b),a(this)},e.collapse=function(b){this.nativeRange.collapse(b),a(this)},e.cloneRange=function(){return new h(this.nativeRange.cloneRange())},e.refresh=function(){a(this)},e.toString=function(){return this.nativeRange.toString()};var k=document.createTextNode("test");i.getBody(document).appendChild(k);var m=document.createRange();m.setStart(k,0),m.setEnd(k,0);try{m.setStart(k,1),e.setStart=function(b,c){this.nativeRange.setStart(b,c),a(this)},e.setEnd=function(b,c){this.nativeRange.setEnd(b,c),a(this)},f=function(b){return function(c){this.nativeRange[b](c),a(this)}}}catch(n){e.setStart=function(b,c){try{this.nativeRange.setStart(b,c)}catch(d){this.nativeRange.setEnd(b,c),this.nativeRange.setStart(b,c)}a(this)},e.setEnd=function(b,c){try{this.nativeRange.setEnd(b,c)}catch(d){this.nativeRange.setStart(b,c),this.nativeRange.setEnd(b,c)}a(this)},f=function(b,c){return function(d){try{this.nativeRange[b](d)}catch(e){this.nativeRange[c](d),this.nativeRange[b](d)}a(this)}}}e.setStartBefore=f("setStartBefore","setEndBefore"),e.setStartAfter=f("setStartAfter","setEndAfter"),e.setEndBefore=f("setEndBefore","setStartBefore"),e.setEndAfter=f("setEndAfter","setStartAfter"),m.selectNodeContents(k),m.startContainer==k&&m.endContainer==k&&0==m.startOffset&&m.endOffset==k.length?e.selectNodeContents=function(b){this.nativeRange.selectNodeContents(b),a(this)}:e.selectNodeContents=function(a){this.setStart(a,0),this.setEnd(a,l.getEndOffset(a))},m.selectNodeContents(k),m.setEnd(k,3);var o=document.createRange();o.selectNodeContents(k),o.setEnd(k,4),o.setStart(k,2),-1==m.compareBoundaryPoints(m.START_TO_END,o)&&1==m.compareBoundaryPoints(m.END_TO_START,o)?e.compareBoundaryPoints=function(a,b){return b=b.nativeRange||b,a==b.START_TO_END?a=b.END_TO_START:a==b.END_TO_START&&(a=b.START_TO_END),this.nativeRange.compareBoundaryPoints(a,b)}:e.compareBoundaryPoints=function(a,b){return this.nativeRange.compareBoundaryPoints(a,b.nativeRange||b)};var p=document.createElement("div");p.innerHTML="123";var q=p.firstChild;document.body.appendChild(p),m.setStart(q,1),m.setEnd(q,2),m.deleteContents(),"13"==q.data&&(e.deleteContents=function(){this.nativeRange.deleteContents(),a(this)},e.extractContents=function(){var b=this.nativeRange.extractContents();return a(this),b}),document.body.removeChild(p),j.isHostMethod(m,"createContextualFragment")&&(e.createContextualFragment=function(a){return this.nativeRange.createContextualFragment(a)}),i.getBody(document).removeChild(k),m.detach(),o.detach()})(),a.createNativeRange=function(a){return a=c(a,"createNativeRange"),a.createRange()};a.features.implementsTextRange&&(h.rangeToTextRange=function(a){if(a.collapsed)return g(new k(a.startContainer,a.startOffset),!0);var b=g(new k(a.startContainer,a.startOffset),!0),c=g(new k(a.endContainer,a.endOffset),!1),d=i.getDocument(a.startContainer).body.createTextRange();
return d.setEndPoint("StartToStart",b),d.setEndPoint("EndToEnd",c),d}),h.prototype.getName=function(){return"WrappedRange"},a.WrappedRange=h,a.createRange=function(b){return b=c(b,"createRange"),new h(a.createNativeRange(b))},a.createRangyRange=function(a){return a=c(a,"createRangyRange"),new l(a)},a.createIframeRange=function(c){return b.deprecationNotice("createIframeRange()","createRange(iframeEl)"),a.createRange(c)},a.createIframeRangyRange=function(c){return b.deprecationNotice("createIframeRangyRange()","createRangyRange(iframeEl)"),a.createRangyRange(c)},a.addCreateMissingNativeApiListener(function(b){var c=b.document;"undefined"==typeof c.createRange&&(c.createRange=function(){return a.createRange(c)}),c=b=null})}),a.createModule("WrappedSelection",function(a,b){function c(a){return"string"==typeof a?"backward"==a:!!a}function d(a,c){if(!a)return window;if(z.isWindow(a))return a;if(a instanceof q)return a.win;var d=z.getContentDocument(a);if(!d)throw b.createError(c+"(): Parameter must be a Window object or DOM node");return z.getWindow(d)}function e(a){return d(a,"getWinSelection").getSelection()}function f(a){return d(a,"getDocSelection").document.selection}function g(a,b,c){var d=c?"end":"start",e=c?"start":"end";a.anchorNode=b[d+"Container"],a.anchorOffset=b[d+"Offset"],a.focusNode=b[e+"Container"],a.focusOffset=b[e+"Offset"]}function h(a){var b=a.nativeSelection;a.anchorNode=b.anchorNode,a.anchorOffset=b.anchorOffset,a.focusNode=b.focusNode,a.focusOffset=b.focusOffset}function i(a){a.anchorNode=a.focusNode=null,a.anchorOffset=a.focusOffset=0,a.rangeCount=0,a.isCollapsed=!0,a._ranges.length=0}function j(b){var c;return b instanceof B?(c=a.createNativeRange(b.getDocument()),c.setEnd(b.endContainer,b.endOffset),c.setStart(b.startContainer,b.startOffset)):b instanceof C?c=b.nativeRange:a.features.implementsDomRange&&b instanceof z.getWindow(b.startContainer).Range&&(c=b),c}function k(a){if(!a.length||1!=a[0].nodeType)return!1;for(var b=1,c=a.length;c>b;++b)if(!z.isAncestorOf(a[0],a[b]))return!1;return!0}function l(a){var c=a.getNodes();if(!k(c))throw b.createError("getSingleElementFromRange: range "+a.inspect()+" did not consist of a single element");return c[0]}function m(a){return!!a&&"undefined"!=typeof a.text}function n(a,b){var c=new C(b);a._ranges=[c],g(a,c,!1),a.rangeCount=1,a.isCollapsed=c.collapsed}function o(b){if(b._ranges.length=0,"None"==b.docSelection.type)i(b);else{var c=b.docSelection.createRange();if(m(c))n(b,c);else{b.rangeCount=c.length;for(var d,e=z.getDocument(c.item(0)),f=0;f<b.rangeCount;++f)d=a.createRange(e),d.selectNode(c.item(f)),b._ranges.push(d);b.isCollapsed=1==b.rangeCount&&b._ranges[0].collapsed,g(b,b._ranges[b.rangeCount-1],!1)}}}function p(a,c){for(var d=a.docSelection.createRange(),e=l(c),f=z.getDocument(d.item(0)),g=z.getBody(f).createControlRange(),h=0,i=d.length;i>h;++h)g.add(d.item(h));try{g.add(e)}catch(j){throw b.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}g.select(),o(a)}function q(a,b,c){this.nativeSelection=a,this.docSelection=b,this._ranges=[],this.win=c,this.refresh()}function r(a){a.win=a.anchorNode=a.focusNode=a._ranges=null,a.detached=!0}function s(a,b){for(var c,d,e=U.length;e--;)if(c=U[e],d=c.selection,"deleteAll"==b)r(d);else if(c.win==a)return"delete"==b?(U.splice(e,1),!0):d;return"deleteAll"==b&&(U.length=0),null}function t(a,c){for(var d,e=z.getDocument(c[0].startContainer),f=z.getBody(e).createControlRange(),g=0;g<rangeCount;++g){d=l(c[g]);try{f.add(d)}catch(h){throw b.createError("setRanges(): Element within the one of the specified Ranges could not be added to control selection (does it have layout?)")}}f.select(),o(a)}function u(a,b){if(a.anchorNode&&z.getDocument(a.anchorNode)!==z.getDocument(b))throw new D("WRONG_DOCUMENT_ERR")}function v(a){var b=[],c=new E(a.anchorNode,a.anchorOffset),d=new E(a.focusNode,a.focusOffset),e="function"==typeof a.getName?a.getName():"Selection";if("undefined"!=typeof a.rangeCount)for(var f=0,g=a.rangeCount;g>f;++f)b[f]=B.inspect(a.getRangeAt(f));return"["+e+"(Ranges: "+b.join(", ")+")(anchor: "+c.inspect()+", focus: "+d.inspect()+"]"}a.requireModules(["DomUtil","DomRange","WrappedRange"]),a.config.checkSelectionRanges=!0;var w,x,y="boolean",z=a.dom,A=a.util,B=a.DomRange,C=a.WrappedRange,D=a.DOMException,E=z.DomPosition,F="Control",G=a.util.isHostMethod(window,"getSelection"),H=a.util.isHostObject(document,"selection");a.features.implementsWinGetSelection=G,a.features.implementsDocSelection=H;var I=H&&(!G||a.config.preferTextRange);I?(w=f,a.isSelectionValid=function(a){var b=d(a,"isSelectionValid").document,c=b.selection;return"None"!=c.type||z.getDocument(c.createRange().parentElement())==b}):G?(w=e,a.isSelectionValid=function(){return!0}):b.fail("Neither document.selection or window.getSelection() detected."),a.getNativeSelection=w;var J=w(),K=a.createNativeRange(document),L=z.getBody(document),M=A.areHostProperties(J,["anchorNode","focusNode","anchorOffset","focusOffset"]);a.features.selectionHasAnchorAndFocus=M;var N=A.isHostMethod(J,"extend");a.features.selectionHasExtend=N;var O="number"==typeof J.rangeCount;a.features.selectionHasRangeCount=O;var P=!1,Q=!0;A.areHostMethods(J,["addRange","getRangeAt","removeAllRanges"])&&"number"==typeof J.rangeCount&&a.features.implementsDomRange&&function(){var a=window.getSelection();if(a){var b=z.getBody(document),c=b.appendChild(document.createElement("div"));c.contentEditable="false";var d=c.appendChild(document.createTextNode("   ")),e=document.createRange();e.setStart(d,1),e.collapse(!0),a.addRange(e),Q=1==a.rangeCount,a.removeAllRanges();var f=e.cloneRange();e.setStart(d,0),f.setEnd(d,3),f.setStart(d,2),a.addRange(e),a.addRange(f),P=2==a.rangeCount,b.removeChild(c),a.removeAllRanges(),e.detach(),f.detach()}}(),a.features.selectionSupportsMultipleRanges=P,a.features.collapsedNonEditableSelectionsSupported=Q;var R,S=!1;L&&A.isHostMethod(L,"createControlRange")&&(R=L.createControlRange(),A.areHostProperties(R,["item","add"])&&(S=!0)),a.features.implementsControlRange=S,x=M?function(a){return a.anchorNode===a.focusNode&&a.anchorOffset===a.focusOffset}:function(a){return a.rangeCount?a.getRangeAt(a.rangeCount-1).collapsed:!1};var T;A.isHostMethod(J,"getRangeAt")?T=function(a,b){try{return a.getRangeAt(b)}catch(c){return null}}:M&&(T=function(b){var c=z.getDocument(b.anchorNode),d=a.createRange(c);return d.setStart(b.anchorNode,b.anchorOffset),d.setEnd(b.focusNode,b.focusOffset),d.collapsed!==this.isCollapsed&&(d.setStart(b.focusNode,b.focusOffset),d.setEnd(b.anchorNode,b.anchorOffset)),d});var U=[];a.getSelection=function(a){if(a&&a instanceof q)return a.refresh(),a;a=d(a,"getSelection");var b=s(a),c=w(a),e=H?f(a):null;return b?(b.nativeSelection=c,b.docSelection=e,b.refresh()):(b=new q(c,e,a),U.push({win:a,selection:b})),b},a.getIframeSelection=function(c){return b.deprecationNotice("getIframeSelection()","getSelection(iframeEl)"),a.getSelection(z.getIframeWindow(c))};var V=q.prototype;if(!I&&M&&A.areHostMethods(J,["removeAllRanges","addRange"])){V.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),i(this)};var W=function(b,c){var d=B.getRangeDocument(c),e=a.createRange(d);e.collapseToPoint(c.endContainer,c.endOffset),b.nativeSelection.addRange(j(e)),b.nativeSelection.extend(c.startContainer,c.startOffset),b.refresh()};O?V.addRange=function(b,d){if(S&&H&&this.docSelection.type==F)p(this,b);else if(c(d)&&N)W(this,b);else{var e;if(P?e=this.rangeCount:(this.removeAllRanges(),e=0),this.nativeSelection.addRange(j(b).cloneRange()),this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==e+1){if(a.config.checkSelectionRanges){var f=T(this.nativeSelection,this.rangeCount-1);f&&!B.rangesEqual(f,b)&&(b=new C(f))}this._ranges[this.rangeCount-1]=b,g(this,b,Z(this.nativeSelection)),this.isCollapsed=x(this)}else this.refresh()}}:V.addRange=function(a,b){c(b)&&N?W(this,a):(this.nativeSelection.addRange(j(a)),this.refresh())},V.setRanges=function(a){if(S&&a.length>1)t(this,a);else{this.removeAllRanges();for(var b=0,c=a.length;c>b;++b)this.addRange(a[b])}}}else{if(!(A.isHostMethod(J,"empty")&&A.isHostMethod(K,"select")&&S&&I))return b.fail("No means of selecting a Range or TextRange was found"),!1;V.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var a;if(this.anchorNode)a=z.getDocument(this.anchorNode);else if(this.docSelection.type==F){var b=this.docSelection.createRange();b.length&&(a=z.getDocument(b.item(0)).body.createTextRange())}if(a){var c=a.body.createTextRange();c.select(),this.docSelection.empty()}}}catch(d){}i(this)},V.addRange=function(a){this.docSelection.type==F?p(this,a):(C.rangeToTextRange(a).select(),this._ranges[0]=a,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,g(this,a,!1))},V.setRanges=function(a){this.removeAllRanges();var b=a.length;b>1?t(this,a):b&&this.addRange(a[0])}}V.getRangeAt=function(a){if(0>a||a>=this.rangeCount)throw new D("INDEX_SIZE_ERR");return this._ranges[a].cloneRange()};var X;if(I)X=function(b){var c;a.isSelectionValid(b.win)?c=b.docSelection.createRange():(c=z.getBody(b.win.document).createTextRange(),c.collapse(!0)),b.docSelection.type==F?o(b):m(c)?n(b,c):i(b)};else if(A.isHostMethod(J,"getRangeAt")&&"number"==typeof J.rangeCount)X=function(b){if(S&&H&&b.docSelection.type==F)o(b);else if(b._ranges.length=b.rangeCount=b.nativeSelection.rangeCount,b.rangeCount){for(var c=0,d=b.rangeCount;d>c;++c)b._ranges[c]=new a.WrappedRange(b.nativeSelection.getRangeAt(c));g(b,b._ranges[b.rangeCount-1],Z(b.nativeSelection)),b.isCollapsed=x(b)}else i(b)};else{if(!M||_typeof2(J.isCollapsed)!=y||_typeof2(K.collapsed)!=y||!a.features.implementsDomRange)return b.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;X=function(a){var b,c=a.nativeSelection;c.anchorNode?(b=T(c,0),a._ranges=[b],a.rangeCount=1,h(a),a.isCollapsed=x(a)):i(a)}}V.refresh=function(a){var b=a?this._ranges.slice(0):null,c=this.anchorNode,d=this.anchorOffset;if(X(this),a){var e=b.length;if(e!=this._ranges.length)return!0;if(this.anchorNode!=c||this.anchorOffset!=d)return!0;for(;e--;)if(!B.rangesEqual(b[e],this._ranges[e]))return!0;return!1}};var Y=function(b,c){var d=b.getAllRanges();b.removeAllRanges();for(var e=0,f=d.length;f>e;++e)a.DomRange.rangesEqual(c,d[e])||b.addRange(d[e]);b.rangeCount||i(b)};S?V.removeRange=function(a){if(this.docSelection.type==F){for(var b,c=this.docSelection.createRange(),d=l(a),e=z.getDocument(c.item(0)),f=z.getBody(e).createControlRange(),g=!1,h=0,i=c.length;i>h;++h)b=c.item(h),b!==d||g?f.add(c.item(h)):g=!0;f.select(),o(this)}else Y(this,a)}:V.removeRange=function(a){Y(this,a)};var Z;!I&&M&&a.features.implementsDomRange?(Z=function(a){var b=!1;return a.anchorNode&&(b=1==z.comparePoints(a.anchorNode,a.anchorOffset,a.focusNode,a.focusOffset)),b},V.isBackward=function(){return Z(this)}):Z=V.isBackward=function(){return!1},V.isBackwards=V.isBackward,V.toString=function(){for(var a=[],b=0,c=this.rangeCount;c>b;++b)a[b]=""+this._ranges[b];return a.join("")},V.collapse=function(b,c){u(this,b);var d=a.createRange(b);d.collapseToPoint(b,c),this.setSingleRange(d),this.isCollapsed=!0},V.collapseToStart=function(){if(!this.rangeCount)throw new D("INVALID_STATE_ERR");var a=this._ranges[0];this.collapse(a.startContainer,a.startOffset)},V.collapseToEnd=function(){if(!this.rangeCount)throw new D("INVALID_STATE_ERR");var a=this._ranges[this.rangeCount-1];this.collapse(a.endContainer,a.endOffset)},V.selectAllChildren=function(b){u(this,b);var c=a.createRange(b);c.selectNodeContents(b),this.removeAllRanges(),this.addRange(c)},V.deleteFromDocument=function(){if(S&&H&&this.docSelection.type==F){for(var a,b=this.docSelection.createRange();b.length;)a=b.item(0),b.remove(a),a.parentNode.removeChild(a);this.refresh()}else if(this.rangeCount){var c=this.getAllRanges();if(c.length){this.removeAllRanges();for(var d=0,e=c.length;e>d;++d)c[d].deleteContents();this.addRange(c[e-1])}}},V.getAllRanges=function(){for(var a=[],b=0,c=this._ranges.length;c>b;++b)a[b]=this.getRangeAt(b);return a},V.setSingleRange=function(a,b){this.removeAllRanges(),this.addRange(a,b)},V.containsNode=function(a,b){for(var c=0,d=this._ranges.length;d>c;++c)if(this._ranges[c].containsNode(a,b))return!0;return!1},V.toHtml=function(){var a=[];if(this.rangeCount)for(var b=0,c=this._ranges.length;c>b;++b)a.push(this._ranges[b].toHtml());return a.join("")},V.getName=function(){return"WrappedSelection"},V.inspect=function(){return v(this)},V.detach=function(){s(this.win,"delete"),r(this)},q.detachAll=function(){s(null,"deleteAll")},q.inspect=v,q.isDirectionBackward=c,a.Selection=q,a.selectionPrototype=V,a.addCreateMissingNativeApiListener(function(b){"undefined"==typeof b.getSelection&&(b.getSelection=function(){return a.getSelection(b)}),b=null})}),WebIM.util.rangy.init()},b=setInterval(function(){document.body&&(clearInterval(b),a())},100)}();var _WA2=WebIM,U=_WA2.util,DomUtil=_WA2.DomUtil,hidden,visibilityChange;"undefined"!=typeof document.hidden?(hidden="hidden",visibilityChange="visibilitychange"):"undefined"!=typeof document.mozHidden?(hidden="mozHidden",visibilityChange="mozvisibilitychange"):"undefined"!=typeof document.msHidden?(hidden="msHidden",visibilityChange="msvisibilitychange"):"undefined"!=typeof document.webkitHidden&&(hidden="webkitHidden",visibilityChange="webkitvisibilitychange");var winFocus,docFocus=hidden?!document[hidden]:!0,focused=docFocus&&("function"==typeof document.hasFocus?document.hasFocus():!0);winFocus=focused,_WA2.focusEvent=new U.Event,_WA2.blurEvent=new U.Event,visibilityChange&&DomUtil.fly(document).on(visibilityChange,function(){docFocus=!document[hidden],docFocus&&winFocus?focused||(focused=!0,_WA2.setTimeout(function(){return _WA2.focusEvent.fire()},0)):!docFocus&&focused&&(focused=!1,_WA2.blurEvent.fire())}),DomUtil.fly(window).on("focus",function(){winFocus=!0,docFocus&&!focused&&(focused=!0,_WA2.focusEvent.fire())}).on("blur",function(){winFocus=!1,focused&&(focused=!1,_WA2.blurEvent.fire())}),_WA2.inFocus=function(){return focused};var _WA3=WebIM,_U=_WA3.util,_DomUtil=_WA3.DomUtil,BAD_CONNECTION_TIMEOUT=4e3,BAD_CONNECTION_FETCH_TIMEOUT_DIFF=1e3,networkStatus=navigator.onLine?"online":"offline",onlinePromise=Promise.resolve(),resolveOnlinePromise=function(){},_requests={},_timers={};_WA3.onlineManager={toggleEvent:new _U.Event,hasProblem:function(){return"online"!==networkStatus},isOffline:function(){return"offline"===_this4.getStatus()},waitForOnline:function(){return onlinePromise},getStatus:function(){return navigator.onLine?"offline"===networkStatus&&(networkStatus="troubles"):networkStatus="offline",networkStatus},onOnline:function(){"offline"===networkStatus&&(networkStatus="troubles"),_WA3.onlineManager.toggleEvent.fire(networkStatus),resolveOnlinePromise()},onOffline:function(){onlinePromise=new Promise(function(a){resolveOnlinePromise=a}),networkStatus="offline",_WA3.onlineManager.toggleEvent.fire(networkStatus)},onNetworkRequestStart:function(a,b){_requests[a]=+new Date,b||(_timers[a]=_WA3.setTimeout(function(){delete _timers[a],_WA3.onlineManager.onNetworkRequest("timeout",a)},BAD_CONNECTION_TIMEOUT))},onNetworkRequest:function(a,b,c){var d=_requests[b];if(_timers[b]&&(clearTimeout(_timers[b]),delete _timers[b]),d&&navigator.onLine){var e=!1,f=new Date-d;if("success"===a)if(c){e=!0;var g=parseInt(c.response&&c.response.data&&c.response.data.pollTime);isNaN(g)||(g?BAD_CONNECTION_FETCH_TIMEOUT_DIFF>f-g&&(e=!1):e="troubles"===networkStatus)}else f>BAD_CONNECTION_TIMEOUT&&(e=!0);else e=!0;var h=e?"troubles":"online";networkStatus!==h&&(networkStatus=h,_WA3.onlineManager.toggleEvent.fire(h))}}},_DomUtil.fly(window).on("online",_WA3.onlineManager.onOnline).on("offline",_WA3.onlineManager.onOffline);var _WA4=WebIM,_U2=_WA4.util,Activatable=_WA4.Activatable,_DomUtil2=_WA4.DomUtil,layersStorage={},activeLayers=[],forceListenersStorage={},keyCodeMap={27:{eventName:"esc"},13:{eventName:"enter"},9:{eventName:"tab"},70:{eventName:"search",condition:function(a){var b=a.browserEvent,c=b.ctrlKey,d=b.metaKey;return c||d}},38:{eventName:"arrowUp"},40:{eventName:"arrowDown"},39:{eventName:"arrowRight"},37:{eventName:"arrowLeft"}},needToBePrevented={tab:!0},topLayerZIndex=99,HotKeyLayer=function(){function a(b){_classCallCheck2(this,a),this.name=b.name,this.events={},this.zIndex=0,this.applyConfig(b)}return _createClass2(a,[{key:"applyConfig",value:function(a){var b=this;"overlayAll"in a&&(this.overlayAll=!!a.overlayAll),"overlayOnHandle"in a&&(this.overlayOnHandle=!!a.overlayOnHandle),"overlayActions"in a&&(_WA4.isObject(a.overlayActions)?this.overlayActions=a.overlayActions:delete this.overlayActions),"zIndex"in a&&(this.zIndex=Number(a.zIndex),isNaN(this.zIndex)&&(this.zIndex=0)),_WA4.isObject(a.handlers)&&Object.keys(a.handlers).forEach(function(c){b.events[c]&&b.events[c].un(a.handlers[c]),b.on(c,a.handlers[c])})}},{key:"on",value:function(a,b,c,d){this.events[a]||(this.events[a]=new _U2.Event),this.events[a].on(b,c,d)}},{key:"un",value:function(a,b,c){this.events[a]&&(this.events[a].un(b,c),this.events[a].listeners.length||delete this.events[a])}},{key:"destroy",value:function(){var a=this;Object.keys(this.events).forEach(function(b){a.events[b].removeAll(),delete a.events[b]})}}]),a}(),HotKeyManager=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.activationLayerEvent=new _U2.Event,a.deactivationLayerEvent=new _U2.Event,a.layersStorage=layersStorage,a.activeLayers=activeLayers,a.forceListenersStorage=forceListenersStorage,a}return _inherits2(b,a),_createClass2(b,[{key:"_onActivate",value:function(){_DomUtil2.getDoc().on("keydown",this._onDocumentKeyDown,this)}},{key:"_onDeactivate",value:function(){_DomUtil2.getDoc().un("keydown",this._onDocumentKeyDown,this)}},{key:"_onDocumentKeyDown",value:function(a){var b=a.keyCode,c=keyCodeMap[b]||{},d=c.eventName,e=c.condition;if(83===b&&(a.metaKey||a.ctrlKey)&&a.preventDefault(),d&&(!e||e(a))){var f=!1;activeLayers.some(function(b){var c=b.name,e=b.events,g=b.overlayOnHandle,h=b.overlayAll,i=b.overlayActions,j=void 0===i?{}:i,k=forceListenersStorage[c]&&forceListenersStorage[c][d];if(e[d]||k){var l=e[d]?e[d].fire(a,d):!0,m=k?k.fire(a,d):!0;if(f=!0,l===!1||m===!1||g)return!0}return h||j[d]?!0:void 0}),!f&&needToBePrevented[d]&&a.preventDefault()}}},{key:"addLayer",value:function(a){var b=a.name;layersStorage[b]?layersStorage[b].applyConfig(a):layersStorage[b]=new HotKeyLayer(a),"__topLayer"===b?layersStorage[b].zIndex=topLayerZIndex:layersStorage[b].zIndex&&layersStorage[b].zIndex>=topLayerZIndex&&(topLayerZIndex++,layersStorage.__topLayer.zIndex=topLayerZIndex),a.activateOnCreate&&this.activateLayer(b)}},{key:"removeLayer",value:function(a){layersStorage[a]&&(this.deactivateLayer(a),layersStorage[a].destroy(),delete layersStorage[a])}},{key:"on",value:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"__topLayer",d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(layersStorage[c]||(d=_U2.Object.extend({},d),d.name=c,"__topLayer"===c&&(d.activateOnCreate=!0,d.overlayOnHandle=!0),this.addLayer(d)),_WA4.isArray(a)||(a=[a]),_WA4.isFunction(b))a.forEach(function(a){layersStorage[c].on(a,b)});else if(_WA4.isObject(b)&&_WA4.isFunction(b.handler)){var e=b.handler,f=b.scope,g=b.options;a.forEach(function(a){layersStorage[c].on(a,e,f,g)})}}},{key:"un",value:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"__topLayer";if(layersStorage[c])if(_WA4.isArray(a)||(a=[a]),_WA4.isFunction(b))a.forEach(function(a){layersStorage[c].un(a,b)});else if(_WA4.isObject(b)&&_WA4.isFunction(b.handler)){var d=b.handler,e=b.scope;a.forEach(function(a){layersStorage[c].un(a,d,e)})}}},{key:"forceOn",value:function(a,b,c){if(_WA4.isArray(a)||(a=[a]),forceListenersStorage[c]||(forceListenersStorage[c]={}),_WA4.isFunction(b))a.forEach(function(a){forceListenersStorage[c][a]||(forceListenersStorage[c][a]=new _U2.Event),forceListenersStorage[c][a].on(b)});else if(_WA4.isObject(b)&&_WA4.isFunction(b.handler)){var d=b.handler,e=b.scope,f=b.options;a.forEach(function(a){forceListenersStorage[c][a]||(forceListenersStorage[c][a]=new _U2.Event),forceListenersStorage[c][a].on(d,e,f)})}}},{key:"forceUn",value:function(a,b,c){if(_WA4.isArray(a)||(a=[a]),forceListenersStorage[c])if(_WA4.isFunction(b))a.forEach(function(a){forceListenersStorage[c][a]&&(forceListenersStorage[c][a].un(b),forceListenersStorage[c][a].listeners.length||delete forceListenersStorage[c][a])});else if(_WA4.isObject(b)&&_WA4.isFunction(b.handler)){var d=b.handler,e=b.scope;a.forEach(function(a){forceListenersStorage[c][a]&&(forceListenersStorage[c][a].un(d,e),forceListenersStorage[c][a].listeners.length||delete forceListenersStorage[c][a])})}}},{key:"clearForce",value:function(a){forceListenersStorage[a]&&(Object.keys(forceListenersStorage[a]).forEach(function(b){forceListenersStorage[a][b]&&forceListenersStorage[a][b].removeAll(),delete forceListenersStorage[a][b]}),delete forceListenersStorage[a])}},{key:"isLayerActive",value:function(a){var b=-1;return layersStorage[a]&&(b=activeLayers.indexOf(layersStorage[a])),-1!==b}},{key:"activateLayer",value:function(a){if(layersStorage[a]){var b=activeLayers.indexOf(layersStorage[a]),c=!0;b>-1&&(activeLayers.splice(b,1),c=!1),activeLayers.unshift(layersStorage[a]),activeLayers.sort(function(a,b){var c=a.zIndex,d=void 0===c?0:c,e=b.zIndex,f=void 0===e?0:e;return d>f?-1:d===f?0:1}),c&&this.activationLayerEvent.fire(a)}}},{key:"deactivateLayer",value:function(a){if(layersStorage[a]){var b=activeLayers.indexOf(layersStorage[a]);b>-1&&(activeLayers.splice(b,1),this.deactivationLayerEvent.fire(a))}}}]),b}(Activatable);_WA4.hotKeyManager=new HotKeyManager,function(a,b){var c=window.KEEP_LOCATION||a!==top;window.App=function(){function a(a){a&&la[a.t]&&la[a.t](a)}function d(a,b){return Array.prototype.slice.call(a,b)}function e(a){var b=d(arguments,1),c=this;pa.call(a,function(a){a.apply(c,b)})}function f(a,b,c,d,e,f){var g={bubbles:!0,cancelable:!0,view:window,detail:1,screenX:c,screenY:d,clientX:c,clientY:d};return e&&(e=h(g,e,!0)),e=g,g=document.createEvent("MouseEvents"),g.initMouseEvent(b,!0,!0,window,1,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey||!1,e.altKey||!1,e.shiftKey||!1,e.metaKey||!1,0,null),f&&h(g,f,!0),(a._dispatchEvent||a.dispatchEvent).call(a,g),g}function g(a){return function(){try{return a.apply(this,arguments)}catch(b){console.log(b.toString())}}}function h(a,b,c){for(var d in b)!b.hasOwnProperty(d)||!c&&d in a||(a[d]=b[d]);return a}function i(a,b,c,d){h(this,c);var e=h({},c);this.type=a,this.target=b,this.stoped=!1,this.prevented=!1,this.canStop||(this.canStop=!1),this._getData=function(){return e}}function j(a,b,c,d){"function"==typeof a&&(d=c,c=b,b=a,a="anyevent"),d instanceof Array||(d=null);var e=[b,c||null,d||[],!1];return(qa[a]||(qa[a]=[])).push(e),{type:a,handler:b,context:c,params:d,isUnbound:function(){return e[3]},call:function(a){return b.apply(c||null,[a].concat(d||[]))},unbind:function(){return e[3]||k(a,b,c,d)},bind:function(){return e[3]&&h(this,j(this.type,this.handler,this.context,this.params),!0)}}}function k(a,b,c,d){if(!a){var e=!0;for(var f in qa)k(f)||(e=!1);return e}for(var g=qa[a],h=(g||[]).length;h--;)if(!(b&&g[h][0]!==b||c&&g[h][1]!==c||d&&g[h][2]!==d)&&(g[h][3]=!0,g.splice(h,1),b))return!0;return!b&&g?!0:!1}function l(a,b,c){var d,e=!0,f="anyevent"===b;if(ra[b])return!1;if(f||(ra[b]=!0),qa[b]&&qa[b].length){d=!0,c=c instanceof i?c:new i(b,a,c),b=qa[b].slice(0);for(var g=0,h=b.length;h>g;g++)if(b[g][0].apply(b[g][1],[c].concat(b[g][2]))===!1&&(c.prevented=!(e=!1)),c.stoped)return e}return f||(l(a,"anyevent",d?c:new i(b,a,c))===!1&&(e=!1),delete ra[d?c.type:b]),e}function m(a){R||(R=a)}function n(a){U[a]&&!T[a]&&(S(a,U[a]),T[a]=!0)}function o(){if(!N){N=!0;for(var a,c,d=(R||b).getElementsByClassName("app-page"),e=d.length;e--;)a=d[e].getAttribute("data-page"),U[a]||(U[a]=d[e].cloneNode(!0),c=d[e].getAttribute("data-alias"),c&&pa.call(c.split(","),function(a){U[a]=d[e].cloneNode(!0)}),d[e].parentNode.removeChild(d[e]));b.body&&(s(b.body,"app-loaded"),j(function(a){var c,d=a._getData();return d._target=a.target,"clientX"in d?(c=b.createEvent("MouseEvent"),c.initMouseEvent(a.type,!0,!0,window,1,a.clientX||0,a.clientY||0,a.clientX||0,a.clientY||0,!1,!1,!1,!1,0,null)):(c=b.createEvent("Event"),c.initEvent(a.type,!0,!0,window)),h(c,d),c._args=d,(a.target instanceof Element?a.target:b.body).dispatchEvent(c)}))}}function p(a,b){a[1].style.display="none",b&&a[1].parentNode&&a[1].parentNode.removeChild(a[1]),l(a[1],"page:hide",{pageName:a[0],pageContext:a[2],pageData:a[3]})}function q(a){a[1].style.cssText="display:block;",b.body&&a[1].parentNode||b.body.appendChild(a[1]),l(a[1],"page:show",{pageName:a[0],pageContext:a[2],pageData:a[3]})}function r(a,c,d,e,f,g){c[1].style.cssText="display:none;position:absolute;top:0;left:0;",b.body&&(c[1].parentNode||b.body.appendChild(c[1])),f||l(c[1],"page:change",{isBack:d,oldPage:a&&B(a).name,newPage:B(c).name}),a&&!g?P(a,c,d,e):na["default"](a,c)}function s(a,b){b&&!u(a,b)&&(a.className+=" "+b)}function t(a,b){b&&(a.className=a.className.replace(new RegExp("(\\s|^)("+b.replace(/\s/g,"|")+")(\\s|$)","g")," ").replace(/(^\s+|\s+$)/g,""))}function u(a,b){return a.className.search(new RegExp("(\\s|^)"+b+"(\\s|$)"))>-1}function v(a,b){for(var c=a.matches||a.webkitMatchesSelector||a.msMatchesSelector||a.mozMatchesSelector||function(){};a;){if(c.call(a,b))return a;if((a=a.parentNode)===document)return!1}return!1}function w(a,b){for(;a;){if(b(a))return a;if(null===(a=a.parentNode))return!1}return!1}function x(a){var b=z(a,"height");return b?(0===b.scrollTop?b.scrollTop=1:b.scrollHeight===b.scrollTop+b.offsetHeight&&(b.scrollTop-=1),b):void 0}function y(a,b){if(a.currentStyle)var c=a.currentStyle[b];else window.getComputedStyle&&(c=document.defaultView.getComputedStyle(a,null).getPropertyValue(b));return c}function z(a,c){for(c="height"===c?function(a){return a.offsetHeight<a.scrollHeight}:"width"===c?function(b){return a.offsetWidth<a.scrollWidth}:function(b){return a.offsetHeight<a.scrollHeight||a.offsetWidth<a.scrollWidth};a;){if(a===b.body)return"hidden"===y(a,"overflow")?!1:a;if(c(a)&&(a.getAttribute("data-scrollable")||~"auto,scroll".indexOf(y(a,"overflow"))))return a;a=a.parentNode}}function A(){O||(O=!0,Ta(b),b.addEventListener("click",function(a){var b=v(a.target,"."+ba);if(b){var c=b.getAttribute("data-action"),d=[];pa.call(b.className.split(" "),function(a){ha[a]&&d.push(ha[a])});var f,g=b.getAttribute("data-back");g?F():(f=b.getAttribute("data-target"))?E(f):c&&ga[(c=c.split(":"))[0]]?ga[c[0]](c[1].split(",")):d.length&&e(d,b,c,a.target)}}))}function B(a){return{name:a[0],html:a[1],context:a[2],data:a[3]}}function C(a){return arguments.length||(a=Y.length-1),isNaN(a)||0>a&&(a=Y.length+a),Y[a]?B(Y[a]):!1}function D(a,b,c){var d;if(1==arguments.length)d=a,a=d[0],b=d[3];else{if(!U[a]||!V[a])return!1;b||(b={}),c=c||X[a]||{},"function"==typeof c&&(c=new c),n(a),d=[a,U[a].cloneNode(!0),c,b]}return V[a].call(d[2],d[1],b),K(),d}function E(a,c,d,e,f){if(Ua)return Va||(Va=arguments);Ua=!0;var g;if(U[a]&&V[a]&&(Z[0]!=a||d)){n(a);var h=Z[0]&&Z;e=e||X[a]||{},"function"==typeof e&&(e=new e);var i=[a,U[a].cloneNode(!0),e,c];if(!l(i[1],"page:load",{pageName:a,pageContext:i[2],pageData:c,canStop:!0}))return Ua=!1,Va&&(g=Va,Va=!1,E.apply(null,g)),!1;i[1].style.cssText="position:absolute;left:0;top:0;visibility:hidden;",b.body&&i[1].parentNode||b.body.appendChild(i[1]),Y.push(Z=i),D(i),l(Z[1],"page:loaded",{pageName:Z[0],pageData:c,pageContext:Z[2]}),r(h,Z,!1,d&&"boolean"==typeof d,!1,f)}Ua=!1,Va&&(g=Va,Va=!1,E.apply(null,g))}function F(a){var b=Y[Y.length-1];return b?a&&!l(b[1],"navigation:back",{root:Y.length<2,pageName:b[0],pageContext:b[2],pageData:b[3],canStop:!0})?!1:Y.length<2?!1:(b=Y.pop(),Z=Y[Y.length-1],r(b,Z,!0,!0),W[b[0]]&&(W[b[0]].call(b[2],b[1]),a||L()),Y.length<2&&l(Z[1],"page:root"),!0):!1}function G(a,b,c){Z[0]&&(Y.pop(),W[Z[0]]&&(W[Z[0]].call(Z[2],Z[1]),L()),E(Z[0],a||Z[3],!0,b||Z[2],c))}function H(a,b,c,d){V[a]="function"==typeof b?b:V[a]||function(){},"function"==typeof c&&(W[a]=c),("object"===_typeof2(d)||"function"==typeof d)&&(X[a]=d)}function I(){$a.length?setTimeout($a.shift(),1):Za=!1}function J(a){Za?$a.push(a):(Za=!0,a())}function K(){c||window.history.pushState({currentPage:Z[0]},document.title,location.pathname)}function L(){c||J(function(){Xa=!0,Wa=!0,window.history.back()})}function M(a){if(!Wa&&Za&&a)return J(M);Wa=!1;var b=Xa?!0:F(!0);(window.history.state&&window.history.state.stayWithUs||!b)&&(Ya=!0),Ya=Ya||cb,Ya?(Ya=!1,Xa=!1,c||window.history.pushState({currentPage:Z[0]},document.title,location.pathname),I()):(Ya=!0,Xa=!0,Wa=!0,window.history.back())}var N,O,P,Q="ontouchstart"in document,R=null,S=function(a,b){},T={},U={},V={},W={},X={},Y=[],Z=[],_="active",aa="default",ba="app-button",ca=30,da=-1===location.href.indexOf("anim=0"),ea=-1===location.href.indexOf("scroll=0"),fa=!0,ga={},ha={"app-tab-button":function(a,b,c){var e,f,g,h=(v(a,".app-tab-bar")||a.parentNode).querySelectorAll(".app-tab-button");if(h.length>1&&!u(a,"tab-active")){var i,j,k=[],m=[],n=(a.getAttribute("data-options")||"").split(":");if(!l(a,"tab:switch",{canStop:!0}))return;s(a,"tab-active"),(e=a.getAttribute("href"))&&(f=document.querySelectorAll(e)).length&&k.push.apply(k,d(f,0)),pa.call(h,function(b){b!==a?(i||j||(j=u(b,"tab-active")),t(b,"tab-active"),(e=b.getAttribute("href"))&&(f=document.querySelectorAll(e)).length&&m.push.apply(m,d(f,0))):i=!0}),g=n[0],n=(n||[]).slice(1),n={dir:j,rev:n[0],delay:n[1],type:n[2]},da||(g="default"),(ma[g]||ma["default"])(m,k,n),l(a,"tab:switched")}}},ia=["ease","ease-in","ease-out"],ja={},ka={},la={swipe:function(a){if(a){var b,c,d=a.h,e=a.s,f=a.r||function(){};for(c=d?d.length:0;c--;)b=d[c],b.__in_transition&&ka[b.__in_transition]&&(delete ka[b.__in_transition],clearTimeout(b.__in_transition),b.style.display="none",b.style.webkitTransform=b.style.transform=b.style.webkitTransition=b.style.transition="",delete b.__in_transition,f(!1,b));for(c=e?e.length:0;c--;)b=e[c],b.__in_transition&&ka[b.__in_transition]&&(delete ka[b.__in_transition],clearTimeout(b.__in_transition),b.style.webkitTransform=b.style.transform=b.style.webkitTransition=b.style.transition="",delete b.__in_transition,f(!0,b))}}},ma={"default":function(b,c,d,e){e||(e=function(){}),d||(d={}),"function"==typeof d&&(e=d,d={});for(var f=b?b.length:0;f--;)b[f].__in_transition&&a(ka[b[f].__in_transition]),b[f].style.display="none",e(!1,b[f]);for(f=c?c.length:0;f--;)c[f].__in_transition&&a(ka[c[f].__in_transition]),c[f].style.display="block",e(!0,c[f])},swipe:function(a,c,d,e){if(!a||!a.length)return ma["default"](a,c,d,e);e||(e=function(){}),d||(d={}),"function"==typeof d&&(e=d,d={});var f=d.rev,g=d.dir,h=d.type,i=d.delay;(i*=1)||(i=300),f="rev"==f;var j,k=a?a.length:0;g=g?1:-1,f&&(g*=-1);for(var l={t:"swipe",h:a,s:c,r:e};k--;)(a[k].offsetWidth||a[k].offsetHeight)&&(j=g*a[k].offsetWidth,a[k].__in_transition&&(clearTimeout(a[k].__in_transition),delete ka[a[k].__in_transition]),a[k].style.webkitTransition=a[k].style.transition=i+"ms "+(ja[h]||""),function(a){a.__in_transition=setTimeout(function(){delete ka[a.__in_transition],a.style.webkitTransform=a.style.transform="translateX("+-j+"px)",b.body.scrollLeft=0,a.__in_transition=setTimeout(function(){delete ka[a.__in_transition],a.style.display="none",a.style.webkitTransform=a.style.transform=a.style.webkitTransition=a.style.transition="",delete a.__in_transition,e(!1,a)},i+20),ka[a.__in_transition]=l},10),ka[a.__in_transition]=l}(a[k]));for(k=c?c.length:0;k--;)c[k].offsetWidth||(c[k].style.visibility="hidden",c[k].style.display="block"),j=g*c[k].offsetWidth,c[k].__in_transition?(clearTimeout(c[k].__in_transition),delete ka[c[k].__in_transition]):c[k].style.webkitTransform=c[k].style.transform="translateX("+j+"px)",
c[k].style.visibility="",function(a){a.__in_transition=setTimeout(function(){delete ka[a.__in_transition],a.style.webkitTransition=a.style.transition=i+"ms "+(ja[h]||""),a.style.webkitTransform=a.style.transform="translateX(0px)",b.body.scrollLeft=0,a.__in_transition=setTimeout(function(){delete ka[a.__in_transition],a.style.webkitTransform=a.style.transform=a.style.webkitTransition=a.style.transition="",delete a.__in_transition,e(!0,a)},i+20),ka[a.__in_transition]=l},10),ka[a.__in_transition]=l}(c[k])}},na={"default":function(a,b,c){ma["default"](a&&[a[1]],b&&[b[1]],function(d,e){d?b&&q(b):a&&p(a,c)})},swipe:function(a,b,c,d){return da?void ma.swipe(a&&[a[1]],b&&[b[1]],{dir:!c},function(c,e){c?b&&q(b):a&&p(a,d)}):na["default"](a,b,d)}},oa=function(){return"function"==typeof Array.prototype.indexOf?Array.prototype.indexOf:function(a){for(var b=this.length;b--;)if(a===this[b])return b;return-1}}(),pa=function(){return"function"==typeof Array.prototype.forEach?Array.prototype.forEach:function(a){for(var b=0,c=this.length;c>b;b++)a(this[b],b)}}();pa.call(ia,function(a){ja[a]=a});var qa={},ra={};i.prototype.stop=function(){this.stoped=!0};var sa={islongTapEventPrevented:function(){return sa.longTapEvent&&(sa.longTapEvent.defaultPrevented||sa.longTapEvent.returnValue===!1)},onFired:function(a){var b=sa.touchevent;b.target.removeEventListener("contextmenu",sa.onFired);var c=b.changedTouches&&b.changedTouches[0]||{},d=b.target;sa.longTapEvent=!1,setTimeout(g(function(){sa.longTapEvent=f(d,"longtap",c.clientX,c.clientY,{screenX:c.screenX,screenY:c.screenY,altKey:a.altKey,shiftKey:a.shiftKey,metaKey:a.metaKey},{_my_event:!0})}),1),sa.timer&&clearTimeout(sa.timer),sa.touchevent=sa.timer=!1},onTouchStart:function(a){if(!sa.timer){var b=sa.touchevent=a;b.target.addEventListener("contextmenu",sa.onFired),sa.timer=setTimeout(function(){var c=b.changedTouches&&b.changedTouches[0]||{};f(b.target,"contextmenu",c.clientX,c.clientY,{screenX:c.screenX,screenY:c.screenY,altKey:a.altKey,shiftKey:a.shiftKey,metaKey:a.metaKey},{_my_event:!0}),sa.timer=!1},700)}},onCancel:function(){sa.timer&&(clearTimeout(sa.timer),sa.touchevent.target.removeEventListener("contextmenu",sa.onFired),sa.touchevent=sa.timer=!1)}};if(Q&&!fa){var ta="function"==typeof EventTarget?EventTarget:Node;if(ta&&(ta=ta.prototype,!ta._addEventListener)){var ua,va,wa,xa,ya,za,Aa,Ba,Ca=function(a){return("true"===a.contentEditable||"function"==typeof a.select&&1!==Oa[a.type])&&!a.disabled},Da=function(a){var b=Ca(a);return b||(a=v(a,'[contenteditable="true"]'))&&(b=!a.disabled),b},Ea=function(a,b,c){f(a,b,c.clientX,c.clientY,{screenX:c.screenX,screenY:c.screenY},{__enable_event__:!0})},Fa=function(a){return Ma[a.type]&&0===a.detail?void 0:za&&!va||va&&va.trgt!==a.target?(a.stopImmediatePropagation(),a.preventDefault(),a.stopPropagation(),a.cancelBubble=!0,a.returnValue=!1,Na[a.type]||(za=!1,va=!1),!1):void 0},Ga=function(a){if(va&&(!Ma[a.type]||0!==a.detail)){if(a.cancelBubble||a.propagationStoped)var b=!0;else{var c=wa||w(this.parentNode,function(a){return a.__h__&&a.__h__.length});c||window.__h__&&window.__h__.length&&(c=window)}if(!c||c===this){b||(wa=this),Pa[a.type]&&Pa[a.type](a);var d=document.contains(a.target);if(Na[a.type]&&d){if(za=!1,va={type:Na[a.type],trgt:a.target},Da(a.target))return za=!1,!0;if(a.type){if("click"===Na[a.type]&&sa.islongTapEventPrevented())return sa.longTapEvent=!1,va=!1,!0;Ea(a.target,Na[a.type],"touchend"===a.type?a.changedTouches[0]:a)}sa.longTapEvent=!1}else za=!0,va=!1;return!0}}},Ha=function(a){1===a.changedTouches.length?(ua=!0,xa=getSelection().rangeCount&&getSelection().getRangeAt(0),sa.onTouchStart(a)):ua&&(ua=!1,sa.onCancel())},Ia=function(a){sa.onCancel(),ua&&(ua=!1)},Ja=function(a){ua&&(sa.onCancel(),va={type:"touchend",trgt:a.target},Ga.call(this,a)&&(ua=!1))},Ka=function(a){a._addEventListener("mousedown",Fa),a._addEventListener("mouseup",Fa),a._addEventListener("click",Fa),a._addEventListener("touchstart",Ha),a._addEventListener("touchmove",Ia),a._addEventListener("touchend",Ja),a._addEventListener("touchcancel",Ia),a._addEventListener("mousedown",Ga),a._addEventListener("mouseup",Ga),a._addEventListener("click",Ga)},La=function(a){a._removeEventListener("mousedown",Ga),a._removeEventListener("mouseup",Ga),a._removeEventListener("click",Ga),a._removeEventListener("mousedown",Fa),a._removeEventListener("mouseup",Fa),a._removeEventListener("click",Fa),a._removeEventListener("touchstart",Ha),a._removeEventListener("touchmove",Ia),a._removeEventListener("touchend",Ja),a._removeEventListener("touchcancel",Ia)},Ma={mouseover:1,mouseout:1,mousedown:1,mouseup:1,click:1},Na={touchend:"mousedown",mousedown:"mouseup",mouseup:"click"},Oa={button:1,checkbox:1,file:1,image:1,radio:1,submit:1},Pa={touchend:function(a){if(ua){var b=getSelection(),c=b.rangeCount&&b.getRangeAt(0);xa?(ya=!c||xa.startContainer!==c.startContainer||xa.startOffset!==c.startOffset||xa.endContainer!==c.endContainer||xa.endOffset!==c.endOffset,xa=null,c=null):c&&(ya=!0)}},mousedown:function(a){if(b.activeElement&&b.activeElement!==a.target&&(b.activeElement.blur(),!ya)){var c,d=getSelection();d.removeAllRanges(),document.caretPositionFromPoint?c=document.caretPositionFromPoint(a.clientX,a.clientY):document.caretRangeFromPoint&&(c=document.caretRangeFromPoint(a.clientX,a.clientY)),c&&d.addRange(c),c=null}Ca(a.target)&&b.activeElement!==a.target&&a.target.focus()}},Qa={touchend:1,mouseover:0,mouseout:0,mousedown:1,mouseup:1,click:1},Ra=Event.prototype.stopPropagation;Event.prototype.stopPropagation=function(){return this.propagationStoped=!0,Ra.apply(this,arguments)},Event.prototype.stopImmediatePropagation?(Aa=function(){this._addEventListener.apply(this,arguments)},Ba=function(){this._removeEventListener.apply(this,arguments)}):(Event.prototype.stopImmediatePropagation=function(){this.propagationStopped=!0},Aa=function(a,b,c){this._addEventListener(a,b.__hackf__||(b.__hackf__=function(a){a.propagationStopped||b(a)}),c)},Ba=function(a,b,c){this._removeEventListener(a,b.__hackf__||b,c)}),ta._addEventListener=ta.addEventListener,ta.addEventListener=function(a,b,c){1!==Qa[a]||"function"!=typeof b||~oa.call((this.__h__||(this.__h__={length:0}))[a]||(this.__h__[a]=[]),b)?this._addEventListener.apply(this,arguments):(this.__h__.length||Ka(this),this.__h__.length++,this.__h__[a].push(b),this._removeEventListener(a,Ga),Aa.apply(this,arguments),this._addEventListener(a,Ga))},ta._removeEventListener||(ta._removeEventListener=ta.removeEventListener,ta.removeEventListener=function(a,b,c){if(Qa[a]&&"function"==typeof b){var d=this.__h__&&this.__h__[a]&&oa.call(this.__h__[a],b);~d&&(this.__h__[a].splice(d,1),this.__h__.length--,this.__h__.length||La(this),Ba.apply(this,arguments))}else this._removeEventListener.apply(this,arguments)}),"undefined"!=typeof Element&&(ta=Element.prototype)&&"function"!=typeof ta.click&&(ta.click=function(){f(this,"click",0,0,{detail:0})}),"undefined"!=typeof HTMLElement&&(ta=HTMLElement.prototype)&&"function"!=typeof ta.click&&(ta.click=function(){f(this,"click",0,0,{detail:0})})}}else"function"==typeof Element&&(ta=Element.prototype)&&(ta.click||(ta.click=function(){f(this,"click",0,0)}));var Sa=function(){function a(a,e){c={dx:e.clientX-a.start.clientX,dy:e.clientY-a.start.clientY,clientX:e.clientX,clientY:e.clientY},d=!1,(Math.abs(c.dx)>f||Math.abs(c.dy)>f)&&(a.current=a.start={clientX:e.clientX,clientY:e.clientY},c.deltaX=c.dx,c.deltaY=c.dy,l(a.target,"swap:start",c),g=b,d=!0)}function b(a,b){c={dx:b.clientX-a.current.clientX,dy:b.clientY-a.current.clientY,deltaX:b.clientX-a.start.clientX,deltaY:b.clientY-a.start.clientY,clientX:b.clientX,clientY:b.clientY},a.current={clientX:b.clientX,clientY:b.clientY},l(a.target,"swap:move",c)}var c,d,e,f=5,g=a;return{onMove:function(a,b){return e?void(d&&(this.onEnd(a),e=!0)):void(a&&g(a,b))},onEnd:function(b,f){g=a,d=!1,e=!1,c=b.current?{deltaX:b.current.clientX-b.start.clientX,deltaY:b.current.clientY-b.start.clientY,clientX:b.current.clientX,clientY:b.current.clientY}:{deltaX:0,deltaY:0,clientX:b.start.clientX,clientY:b.start.clientY},l(b.target,"swap:end",c)},breakMove:function(){e=!0}}}(),Ta=Q?function(a){function b(){c=!1,k.onCancel(),d&&(f&&(f=clearTimeout(f)&&!1),d&&t(d,e),d=e=void 0)}var c,d,e,f,h,i,j,k=fa?sa:{onCancel:function(){},onTouchStart:function(){},islongTapEventPrevented:function(){}};a.addEventListener("touchstart",function(a){d&&b(),i&&(i=Sa.onEnd(i,a)),a.changedTouches.length>1||(d=v(a.target,"."+ba),j=a.changedTouches[0],i={start:{clientX:j.clientX,clientY:j.clientY},target:c=a.target},k.onCancel(),k.onTouchStart(a),d&&(e=d.getAttribute("data-clickable-class")||_,f=setTimeout(function(){f=!1,s(d,e)},ca)),h=x(a.target))}),a.addEventListener("touchmove",function(a){c&&b(),Sa.onMove(i,a.changedTouches[0]),h||a.preventDefault()}),a.addEventListener("touchcancel",function(a){b(),i&&(i=Sa.onEnd(i,a)),h=!1}),a.addEventListener("touchend",g(function(a){if(i&&(i=Sa.onEnd(i,a)),h=!1,k.onCancel(),i&&(i=Sa.onEnd(i,a)),c&&!k.islongTapEventPrevented())k.longTapEvent=!1,c=!1,d&&d===v(a.target,"."+ba)&&(f&&(clearTimeout(f),f=!1,s(d,e||_)),f=setTimeout(function(){f=!1,b()},50));else{k.longTapEvent=!1;for(var g=3,j=a.target,l=[],m=[],n=a.changedTouches[0].clientX+"x"+a.changedTouches[0].clientY,o=+new Date;g&&j;)l.push(j),j.addEventListener("click",m[m.push(function(a){for(var b=l.length;b--;)l[b].removeEventListener("click",m[b]);return n===a.clientX+"x"+a.clientY&&+new Date-o<500?(a.preventDefault(),a.stopPropagation(),!1):void 0})-1]),j=j.parentNode,g--}})),a.addEventListener("click",g(function(a){f||(f=setTimeout(function(){f=!1,b()},50))}))}:function(a){function b(){e=!1,m=!1,l&&(clearTimeout(l),l=!1),h&&(j&&(j=clearTimeout(j)&&!1),h&&t(h,i),h=i=void 0)}function c(a){m=f(a.target,"longtap",a.clientX,a.clientY,a.params,{_my_event:!0})}var d,e,h,i,j,k,l,m;a.addEventListener("mousedown",function(a){h&&b(),k&&(k=Sa.onEnd(k,a)),h=v(a.target,"."+ba),k={start:{clientX:a.clientX,clientY:a.clientY},target:e=a.target},d=a,l&&clearTimeout(l);var f={target:a.target,clientX:a.clientX,clientY:a.clientY,params:{screenX:a.screenX,screenY:a.screenY,altKey:a.altKey,shiftKey:a.shiftKey,metaKey:a.metaKey}};m=!1,l=setTimeout(g(function(){l=!1,c(f)}),700),h&&(i=h.getAttribute("data-clickable-class")||_,j=setTimeout(function(){j=!1,s(h,i)},ca))}),a.addEventListener("mousemove",function(a){d&&a.which?(e&&(!k||Math.abs(k.start.clientX-a.clientX)>30||Math.abs(k.start.clientY-a.clientY)>30)&&b(),Sa.onMove(k,a)):(d=!1,h&&b(),k&&(k=Sa.onEnd(k,a)))}),a.addEventListener("mouseup",g(function(a){if(d=!1,l&&clearTimeout(l),l=!1,k&&(k=Sa.onEnd(k,a)),!e||m&&(m.defaultPrevented||m.returnValue===!1)){m=!1;for(var c=3,f=a.target,g=[],n=[],o=a.clientX+"x"+a.clientY,p=+new Date;c&&f;)g.push(f),f.addEventListener("click",n[n.push(function(a){for(var b=g.length;b--;)g[b].removeEventListener("click",n[b]);return o===a.clientX+"x"+a.clientY&&+new Date-p<500?(a.preventDefault(),a.stopPropagation(),!1):void 0})-1]),f=f.parentNode,c--}else m=!1,e=!1,h&&h===v(a.target,"."+ba)&&(j&&(clearTimeout(j),j=!1,s(h,i||_)),j=setTimeout(function(){j=!1,b()},50))})),a.addEventListener("click",g(function(a){b()}))};ea&&s(document.body,"block_scroll__enabled");var Ua,Va,Wa,Xa,Ya,Za,$a=[];if(!c){var _a=location.search||"";window.history.pushState&&(_a&&window.history.replaceState({stayWithUs:1},document.title,location.pathname),window.history.pushState({stayWithUs:1},document.title,location.pathname),window.addEventListener("popstate",M,!1),cb&&setTimeout(function(){window.history.pushState({IOSChromeHack:1},document.title,location.pathname)},2e3))}var ab={};ab.device={},ab.device.os=function(){var a=navigator.userAgent.toLowerCase();return a=~a.indexOf("android")?"android":~a.indexOf("iphone")||~a.indexOf("ipad")?"ios":"default"}(),ab.device.version=function(){var a=ab.device.os+"\\s+([\\d\\.]+)";return a=new RegExp(a),(navigator.userAgent.toLowerCase().match(a,"i")||[null,null])[1]}(),ab.device.platform={},ab.device.platform.isApp=function(){return!!~navigator.userAgent.toLowerCase().indexOf("ICQ_WebApp")}();var bb=navigator.userAgent.toLowerCase(),cb="ios"===ab.device.os&&!/opera|opr\//.test(bb)&&/chrome|crios\//.test(bb),db={activeClass:function(a){return"undefined"==typeof a?_:_=a},buttonClass:function(a){return"undefined"==typeof a?ba:ba=a},transitionType:function(a){if("undefined"==typeof a)return aa;if("string"==typeof a&&a){if("function"==typeof na[a])return P=na[aa=a],a}else;}};return P=na[aa],b.body&&(s(b.body,"app-"+ab.device.os),da||s(b.body,"app-without_anim")),A(),"function"==typeof $&&($(document.body).addClass("app-"+ab.device.os),ab.device.version&&($(document.body).addClass("app-"+ab.device.os+"-"+parseInt(ab.device.version)),$(document.body).addClass("app-"+ab.device.os+"-"+ab.device.version.replace(".","-"))),$(window).on("online",function(){$(document.body).removeClass("app-offline")}),$(window).on("offline",function(){$(document.body).addClass("app-offline")}),"android"===ab.device.os&&$(".app-page-back-button .caption").text($(".app-page-title .caption").text())),{locationSearch:_a,util:ab,config:db,populator:H,populate:H,setPagesNode:m,setInitPageFunction:function(a){S=a||S},cutLocationSearch:function(){var a=location.search||_a||"";return c||location.search&&window.history.pushState&&window.history.replaceState(window.history.state,document.title,location.pathname),a},back:function(){return F.apply(this,arguments)},load:function(a,b,c,d){var e=arguments[arguments.length-1];(e===!0||e===!1)&&arguments.length<4&&(d=e,d===c?c=void 0:d===b&&(b=void 0)),o(),E(a,b,!1,c,d)},forceLoad:function(a,b,c,d){var e=arguments[arguments.length-1];(e===!0||e===!1)&&arguments.length<4&&(d=e,d===c?c=void 0:d===b&&(b=void 0)),o(),E(a,b,1,c,d)},retry:function(a,b,c){G(a,b,c)},getPage:function(){return C.apply(this,arguments)},getPageByName:function(a,b,c){return U[a]?(n(a),U[a].cloneNode(!0)):void 0},isCurrentPage:function(a){return(this.getPage()||{}).name===a},indexOfPage:function(a,b){for(var c=-1,d=Y.length;d--&&(Y[d][0]!==a||(c=d,!b)););return c},showPage:function(a){if(0>a&&(a=Y.length+a),a<Y.length-1){var b=Y[Y.length-1];Z=Y.splice(a,1)[0],Y.push(Z),r(b,Z)}},getPrevPage:function(){return C(-2)},getHistory:function(){for(var a=[],b=Y.length;b--;)a[b]={name:Y[b][0],data:Y[b][2]};return a},spliceHistory:function(a,b,c){if(!Y.length)return!1;c=c instanceof Array?d(c,0):d(arguments,2);var e,f=c.length,g=[];for(b=b||Y.length-1;f--;)(e=D(c[f].name,c[f].data,c[f].scope))&&g.push(e);for(e=Y.pop(),g=Y.splice.apply(Y,[a,b].concat(g)),Y.push(e),f=g.length;f--;)g[f][1].parentNode&&g[f][1].parentNode.removeChild(g[f][1]),W[g[f][0]]&&(W[g[f][0]].call(g[f][2],g[f][1]),L()),g[f]={name:g[f][0],data:g[f][3]};return Y.length<2&&l(Z[1],"page:root"),g},clearHistory:function(){for(var a=Y.pop();a=Y.pop();)a[1].parentNode&&a[1].parentNode.removeChild(a[1]),W[a[0]]&&(W[a[0]].call(a[2],a[1]),L());Y=a?[a]:[]},on:function(a,b,c,d){return j(a,b,c,d)},off:function(a,b,c,d){return k(a,b,c,d)},breakSwapEvent:function(){Sa.breakMove()},canScroll:x}}()}(window,document),function(){var a,b=WebIM,c=/tr\{\{([\w\.]+)(?:\(([^\}]*)\))?\}\}/g,d=document.createElement("div");d.innerHTML='<div class="app-page im-selfprofilepage" data-page="selfProfile">    <div class="app-topbar">        <div class="app-back-button appBack"></div>        <div class="im-connection-title">            <span class="im-connection-title__offline">tr{{network.offline}}</span>            <span class="im-connection-title__troubles">tr{{network.troubles}}</span>        </div>        <span class="app-topbar-title im-connection-title__online">tr{{profile.myProfile}}</span>    </div>    <div class="app-content">        <div class="imAvatarBox im-selfprofile-ava">            <div class="im-selfprofile-ava__wrap"><div class="im-selfprofile-ava__default"></div></div><input type="file" title=""/>        </div>        <div class="imProfileItem im-selfprofile-item" data-key="name" data-editable="1">            <span class="im-selfprofile-item__title">tr{{profile.name}}</span>            <span class="im-selfprofile-value imProfileValue"></span>        </div>        <div class="imProfileItem im-selfprofile-item" data-key="aboutMe" data-editable="1">            <span class="im-selfprofile-item__title">tr{{profile.aboutMe}}</span>            <span class="im-selfprofile-value imProfileValue"></span>        </div>        <div class="imProfileItem im-selfprofile-item" data-key="uNick" data-editable="1">            <span class="im-selfprofile-item__title">tr{{profile.nickname}}</span>            <span class="im-selfprofile-value imProfileValue"></span>        </div>        <div class="imProfileItem im-selfprofile-item" data-key="password" data-editable="1" style="display: none">            <span class="im-selfprofile-item__title">tr{{profile.password}}</span>            <span class="im-selfprofile-value imProfileValue">**************</span>        </div>        <div class="imProfileItem im-selfprofile-item" data-key="phone" data-editable="0">            <span class="im-selfprofile-item__title">tr{{profile.phoneNumber}}</span>            <span class="im-selfprofile-value imProfileValue"></span>        </div>        <div class="imProfileItem im-selfprofile-item" data-key="email" data-editable="0" style="display:none">            <span class="im-selfprofile-item__title">tr{{profile.email}}</span>            <span class="im-selfprofile-value imProfileValue"></span>        </div>        <div class="imPrivacyLinkButton im-selfprofile-button">            <a href="" target="_blank" class="imPrivacyLink im-linkbutton-green">tr{{profile.profilePrivacy}}</a>        </div>        <div class="im-selfprofile-button">            <span class="imButton im-linkbutton-red" data-action="signOut">tr{{signOut}}</span>        </div>    </div></div><div class="app-page im-dialogpage" data-page="dialog" data-alias="dialogDummy,widgetWelcome">    <div class="dialog-page-content">        <div class="app-topbar">            <div class="im-dialogpage__topbar">                <span class="im-ui-button" data-back="true">                <span class="app-topbar__icon"></span>                <div class="im-msg-counter__wrapper"><div class="im-msg-counter"></div></div>            </span>                <span class="app-topbar__title">                <div class="im-dialog__title-avatarbox imDialogTitleAvatar"></div>                <div class="im-connection-title">                    <span class="im-connection-title__offline">tr{{network.offline}}</span>                    <span class="im-connection-title__troubles">tr{{network.troubles}}</span>                </div>                <div class="im-dialog__title im-connection-title__online imDialogTitle">                    <span class="im-dialog__title-span"></span>                    <!--<div class="im-namebox__fadeout"></div>-->                </div>                <div class="im-dialog__subtitle im-connection-title__online imDialogSubTitle"></div>            </span>                <div class="imButton im-ui-button im-chat__header-voice-call" data-action="callVoice" style="display: none" title="tr{{calls.makeCall}}"></div>                <div class="imButton im-ui-button im-chat__header-video-call" data-action="callVideo" style="display: none" title="tr{{calls.videoCall}}"></div>                <div class="imButton im-ui-button im-chat__header-search-go imStartSearchChat" data-action="startSearchChat" title="tr{{search.dialogSearch}}"></div>                <div class="imButton im-ui-button im-chat__header-add imAddToChat" data-action="addToChat" title="tr{{group.addMember}}"></div>                <div class="imButton im-ui-button im-chat__header-pending" data-action="pendingMembers" title="tr{{chat.pending}}"><div class="im-pending-counter imPendingCounter"></div></div>                <div class="imButton im-ui-button im-chat__header-tools" data-action="openSidebar">                    <div></div><div></div><div></div>                </div>            </div>            <div class="im-dialogpage__ext-topbar extDialogTopbar"></div>        </div>        <div class="imChatContent app-content">            <!--<div class="im-auth-bar">-->                <!--<div class="im-ui-button" data-action="ignore">tr{{dialog.tools.ignore}}</div>&lt;!&ndash;-->                <!--&ndash;&gt;<div class="im-ui-button" data-action="profile">tr{{dialog.tools.profile}}</div>&lt;!&ndash;-->                <!--&ndash;&gt;<div class="im-ui-button im-addbutton" data-action="add">tr{{dialog.tools.add}}</div>-->            <!--</div>-->            <div class="im-stranger-bar"><!--                --><div class="imButton im-stranger-bar__ban" data-action="banUser">tr{{contextmenu.block}}</div>                <div class="imButton im-stranger-bar__close" data-action="addUser"></div>            </div>            <div class="im-pin-bar imPinBar"></div>            <div class="im-chat__shadow">                <div class="im-chat__history">                    <div class="im-history"><div class="im-chat__history-wrap"><div class="im-chat__messages-wrap imMessagesBlock"></div></div><div class="im-chat__typing-wrap">                        <div class="im-chat__typing"></div>                        <div class="im-chat__typing-indicator"><span></span></div>                    </div><div class="im-chat__smart-reply-wrapper">                        <div class="im-chat__smart-reply imSmartReply"></div>                    </div></div>                </div>            </div>        </div>        <div class="app-bottombar">            <div class="im-chat__input">                <div class="im-chat__input-inner">                    <div class="im-chat__input-wrap">                        <div class="im-textfield_rich im-chat__input-field" data-tabindex="2" contenteditable="true" maxlength="9000" placeholder="tr{{dialog.message}}"></div>                    </div>                    <div class="im-chat__input-ptt-wrap">                        <button class="imButton im-chat__input-ptt-control" data-tabindex="2"><span></span></button>                        <div class="im-chat__input-ptt-time"></div>                    </div>                    <button class="imButton im-chat__input-sub-action" data-tabindex="1">                        <span class="im-chat__input-sub-action__attach"></span>                        <span class="im-chat__input-sub-action__ptt-remove"></span>                    </button>                    <button class="imButton imButtonSmiles im-chat__input-smiles" title="tr{{dialog.smiles}}" data-tabindex="3"><span></span></button>                    <button class="imButton im-chat__input-action" data-tabindex="4">                        <span class="im-chat__input-action__send"></span>                        <span class="im-chat__input-action__confirm"></span>                        <span class="im-chat__input-action__ptt"></span>                    </button>                    <div class="im-circ-spinner active">                        <div class="im-circ-spinner__layer">                            <div class="im-circ-spinner__clipper">                                <div class="im-circ-spinner__circle"></div>                            </div>                            <div class="im-circ-spinner__gap-patch">                                <div class="im-circ-spinner__circle"></div>                            </div>                            <div class="im-circ-spinner__clipper">                                <div class="im-circ-spinner__circle"></div>                            </div>                        </div>                    </div>                </div>                <div class="im-attachmenu">                    <div class="imButton im-attachmenu__item im-attachmenu__item_media">                        <span></span>tr{{dialog.photoOrVideo}}<input title="" type="file" accept="video/*,image/*" multiple/>                    </div>                    <div class="imButton im-attachmenu__item im-attachmenu__item_file">                        <span></span>tr{{file.file}}<input title="" type="file" multiple/>                    </div>                    <button class="imButton im-attachmenu__item im-attachmenu__item_poll" data-action="poll" style="display: none"><span></span>tr{{polls.poll}}</button>                    <!--div class="imButton im-attachmenu__item im-attachmenu__item_camera" style="display:none;">                        <span></span>tr{{dialog.camera}}<input type="file" accept="video/*,image/*" capture/>                    </div-->                    <button class="imButton im-attachmenu__item im-attachmenu__item_contact" data-action="contact"><span></span>tr{{cl.contact}}</button>                    <button class="imButton im-attachmenu__item im-attachmenu__item_ptt"><span></span>tr{{cl.voiceMessage}}</button>                </div>                <div class="im-chat__input-file-bar imChatBottomFile"></div>                <!--div style="display: none" class=" im-smilebox im-smilebox_with-erase"></div-->            </div>            <div class="im-chat__no-input">                <button class="imButton im-chat__input-inner im-chat__no-input__button" data-tabindex="2">tr{{dialog.noinput.mute}}</button>                <button class="imButton im-chat__no-input__share" data-tabindex="3" data-action="shareChat"></button>                <div class="im-chat__input-inner im-chat__no-input__message">tr{{dialog.noinput.readonly}}</div>            </div>        </div>    </div></div><div class="app-page im-multi-search" data-page="multiSearch">    <div class="app-topbar">        <div class="im-search-exit imButton" data-action="exitSearch">tr{{box.cancel}}</div>        <div class="im-connection-title">            <span class="im-connection-title__offline">tr{{network.offline}}</span>            <span class="im-connection-title__troubles">tr{{network.troubles}}</span>        </div>        <span class="app-topbar__title im-connection-title__online">tr{{search.search}}</span>    </div>    <div class="app-content">        <div class="imTopSearchBar im-search-bar"></div>        <div class="imSearchTags im-search-tags"></div>        <div class="imButton im-search-tags-button_left" data-action="searchTagsLeft"></div>        <div class="imButton im-search-tags-button_right" data-action="searchTagsRight"></div>        <div class="im-search-results">            <div class="im-search-buttons">                <div class="imButton im-search-buttons__add" data-action="addContact">tr{{contextmenu.addContact}}</div>                <div class="imButton im-search-buttons__new" data-action="newGroup">tr{{contextmenu.createGroup}}</div>                <div class="imButton im-search-buttons__channel" data-action="newChannel">tr{{contextmenu.createChannel}}</div>            </div>        </div>    </div>    <div class="app-bottombar">    </div></div><div class="app-page im-mainpage" data-page="main">    <div class="app-topbar">        <span class="app-topbar__title">            <div class="im-connection-title">                <span class="im-connection-title__offline">tr{{network.offline}}</span>                <span class="im-connection-title__troubles">tr{{network.troubles}}</span>            </div>            <span class="im-tabs-title__clist im-connection-title__online">tr{{tabs.contacts}}</span>            <span class="im-tabs-title__recent im-connection-title__online">tr{{tabs.chats}}</span>            <span class="im-tabs-title__settings im-connection-title__online">tr{{tabs.settings}}</span>        </span>        <div class="im-topbar-buttons">            <!--div class="im-ui-button imButton im-readall-button" title="tr{{contextmenu.markAsReaded}}"></div-->            <div class="im-ui-button imButton im-menu-button"><div></div></div>            <div class="im-ui-button imButton im-unknown-button" data-target="unknowns" title="tr{{dialog.unknownContacts}}">                <div class="im-msg-counter"></div>            </div>            <!--div class="im-ui-button imButton im-add-button" style="display: none" title="tr{{cl.addContact}}"></div-->            <div class="im-ui-button imButton im-write-button" title="tr{{dialog.message}}"></div>        </div>        <button class="im-search-field-wrap imSearchFieldButton imSearchFieldBlock" data-tabindex="5">            <input type="text" class="im-search-field" placeholder="tr{{search.search}}">            <div class="im-search-icon"></div>        </button>    </div>    <div class="app-content">        <div class="im-recent" id="imRecent">            <div class="im-recent-list im-recent-list_loading im-recent-list_empty">                <div class="im-recent__placeholder"></div>                <div class="im-recent__placeholder"></div>                <div class="im-recent__placeholder"></div>                <div class="im-recent__placeholder"></div>                <div class="im-recent__default-screen"></div>            </div>        </div>        <div class="im-cl">            <div class="im-clist" id="imCList">                <div id="imCListWrap" class="im-clist__wrap"></div>                <div class="im-cl__default-screen">                    <div class="im-cl__default-screen__icon"></div>                    <span class="im-cl__default-screen__title">tr{{cl.noContacts}}</span>                </div>            </div>        </div>        <div class="im-settings">            <div class="imButton im-settings__widget" id="imSettingsWidget" data-action="settingsProfile">                <div></div>                <div class="im-settings__widget-namebox">                    <span class="im-settings__widget-friendly"></span>                    <span class="imButton im-settings__widget-nick"></span>                </div>            </div>            <div class="im-settings__menu">                <div class="imButton im-settings__menu-item" data-action="favoriteDialog">                    <span class="im-settings__option-icon im-settings__option-favorite"></span><span>tr{{dialog.favorite}}</span>                </div>                <div class="imButton im-settings__menu-item" data-action="settingsPaneCommon">                    <span class="im-settings__option-icon im-settings__option-common"></span><span>tr{{settings.general}}</span>                </div>                <div class="imButton im-settings__menu-item" data-action="settingsPaneNotify">                    <span class="im-settings__option-icon im-settings__option-sound"></span><span>tr{{dialog.tools.alerts}}</span>                </div>                <div class="imButton im-settings__menu-item" data-action="settingsPaneSecurity">                    <span class="im-settings__option-icon im-settings__option-security"></span><span>tr{{settings.privacy}}</span>                </div>                <div class="imButton im-settings__menu-item" data-action="settingsPaneTheme">                    <span class="im-settings__option-icon im-settings__option-theme"></span><span>tr{{settings.theme}}</span>                </div>                <div class="imButton im-settings__menu-item" data-action="settingsPaneMedia">                    <span class="im-settings__option-icon im-settings__option-media"></span><span>tr{{settings.media}}</span>                </div>            </div>            <div class="im-settings__menu">                <div class="imButton im-settings__menu-item" data-action="settingsPaneInfo">                    <span class="im-settings__option-icon im-settings__option-info"></span><span>tr{{settings.about}}</span>                </div>            </div>        </div>    </div>    <div class="app-bottombar">    </div>    <div class="im-main-start_overlay">        <div class="im-circ-spinner active">            <div class="im-circ-spinner__layer">                <div class="im-circ-spinner__clipper">                    <div class="im-circ-spinner__circle"></div>                </div>                <div class="im-circ-spinner__gap-patch">                    <div class="im-circ-spinner__circle"></div>                </div>                <div class="im-circ-spinner__clipper">                    <div class="im-circ-spinner__circle"></div>                </div>            </div>        </div>    </div></div><div class="app-page im-listpage" data-page="list" data-alias="memberlist,forwardlist,addmemberlist,createlivechat,ignorelist,groupList,shareContactList,groupCallList">    <div class="app-topbar">        <span class="imButton app-topbar__button" data-back="true"><span class="app-topbar__icon"></span></span>        <div class="im-connection-title">            <span class="im-connection-title__offline">tr{{network.offline}}</span>            <span class="im-connection-title__troubles">tr{{network.troubles}}</span>        </div>        <span class="app-topbar__title im-connection-title__online"></span>    </div>    <div class="app-content">        <div class="im-list">            <div class="im-list-wrapper"></div>        </div>        <div class="imListStack im-list-stack"></div>    </div>    <div class="app-bottombar">        <div class="imListBottom im-listpage__buttons"></div>    </div></div><div class="app-page imAuthPage im-authpage" data-page="authPage">    <div class="imAuthForm im-auth-formwrap"></div>    <div class="im-auth-sysinfo"></div>    <button data-action="switchForm" class="imButton imButtonSwitch im-auth-button-blank im-auth-switch-form" type="button"></button></div><div class="app-page im-dialoginfo" data-page="dialogInfo"></div><div class="app-page im-countrypage" data-page="countryPage">    <div class="app-topbar">        <span class="im-ui-button">            <span class="app-topbar__icon"></span><span class="app-topbar__title">tr{{auth.selectYourCountry}}</span>        </span>    </div>    <div class="app-content"></div></div><div class="app-page im-showcase" data-page="showcase">    <div class="app-content">        <div class="im-showcase-topbar">            <span class="im-showcase-topbar__back im-ui-button"><span class="app-topbar__icon"></span></span>            <div class="im-showcase__title"></div>            <div class="im-showcase__subtitle"></div>        </div>        <div class="im-showcase-content__wrapper">            <div class="im-showcase-content"></div>        </div>    </div></div><div class="app-page im-unknownspage" data-page="unknowns">    <div class="app-topbar">        <span class="im-ui-button app-topbar__back" data-back="1">            <span class="app-topbar__icon"></span>            <div class="im-connection-title">                <span class="im-connection-title__offline">tr{{network.offline}}</span>                <span class="im-connection-title__troubles">tr{{network.troubles}}</span>            </div>            <span class="app-topbar__title im-connection-title__online">tr{{dialog.unknownContacts}}</span>        </span>    </div>    <div class="app-content"></div></div><div class="app-page im-attachphone" data-page="attachPhone">    <div class="app-content" id="pageAttachPhone">        <span id="btnAttachLogout" class="im-attachphone-logout">tr{{signOut}}</span>        <div class="im-attachphone-wrap">            <form id="frmAttachPhone" style="display: none" method="post" >                <div class="im-attachphone-head">                    <div class="im-attachphone-logo"></div>                </div>                <span id="txtProtectionTitle" class="im-attachphone-title"></span>                <input type="submit" style="position: absolute; left: -1000px;" />                <div class="im-authpage-phone-country">                    <input type="tel" class="txtPhone im-authpage-input im-authpage-phone" placeholder="tr{{auth.typeNumber}}">                    <div id="btnAttachSelectCountry"></div>                </div>                <span id="txtProtectionText" class="im-attachphone-text"><span></span></span>                <div class="im-attachphone-bottom">                    <button type="submit" class="im-attachphone-button" disabled>tr{{auth.turnOnProtection}}</button>                    <span class="btnAttachCancel im-attachphone-cancel">tr{{box.cancel}}</span>                </div>            </form>            <form id="frmAttachPhoneCode" style="display: none" method="post">                <span class="im-attachphone-title">tr{{auth.typeCode}}</span>                <input type="submit" style="position: absolute; left: -1000px;" />                <div class="im-attachphone-wait">                    <span class="imAttachPhoneNumber"></span>                    <span class="btnGoBack1 im-attachphone-change">tr{{auth.change}}</span>                </div>                <input type="tel" class="txtSmsCode im-authpage-input im-attachphone-code" placeholder="tr{{auth.smsCode}}">                <button type="submit" class="im-attachphone-button" disabled>tr{{box.ok}}</button>                <button type="button" class="btnResendCode im-attachphone-resend">tr{{auth.resendCode}}</button>                <div class="im-attachphone-bottom">                    <button class="btnGoBack2 im-attachphone-button im-attachphone-button_white">tr{{search.back}}</button>                    <span class="btnAttachCancel im-attachphone-cancel">tr{{box.cancel}}</span>                </div>            </form>            <form id="frmAttachDone" style="display: none" action="" method="post">                <div class="im-attachphone-wait">                    <span class="im-attachphone-text">tr{{auth.msgPhoneAttached}}</span>                    <span class="imAttachPhoneNumber"></span>                </div>                <button class="btnAttachOK im-attachphone-button">tr{{box.ok}}</button>            </form>        </div>    </div></div><div class="app-page im-settingoptions" data-page="settingOptions">    <div class="app-topbar">        <div class="app-back-button appBack"></div>        <div class="im-connection-title">            <span class="im-connection-title__offline">tr{{network.offline}}</span>            <span class="im-connection-title__troubles">tr{{network.troubles}}</span>        </div>        <span class="imSettingOptionsTitle im-connection-title__online"></span>    </div>    <div class="app-content">        <div class="im-settings-options settingsPaneCommon" data-title="tr{{settings.generalSettings}}">            <!--label class="im-settings__i im-settings__option" data-key="useNewHistory">                <span class="im-settings__option-label">New History</span>                <div class="im-switch"><input type="checkbox"><span class="im-switch-lever"></span></div>            </label-->            <label class="im-settings__i im-settings__option" data-key="smartReply">                <span class="im-settings__option-label">tr{{settings.smartReply}}</span>                <div class="im-switch"><input type="checkbox"><span class="im-switch-lever"></span></div>            </label>            <label class="im-settings__i im-settings__option" data-key="stickerSuggest">                <span class="im-settings__option-label">tr{{settings.stickerSuggest}}</span>                <div class="im-switch"><input type="checkbox"><span class="im-switch-lever"></span></div>            </label>            <label class="im-settings__i im-settings__option" data-key="stickerSuggestByWords">                <span class="im-settings__option-label">tr{{settings.stickerSuggestByWords}}</span>                <div class="im-switch"><input type="checkbox"><span class="im-switch-lever"></span></div>            </label>            <label class="im-settings__i im-settings__option" data-key="enter">                <span class="im-settings__option-label">tr{{cl.optSendByEnter}}</span>                <div class="im-switch"><input type="checkbox"><span class="im-switch-lever"></span></div>            </label>            <div class="im-settings__option_dry" data-key="searchChat">                <span class="im-settings__option-label imSettingSearchHotkey">Ctrl+F:</span>            </div>            <div class="im-settings__option" data-key="searchChat">                <label class="im-settings__i im-field-radio">tr{{search.dialogSearch}}                    <input type="radio" checked="checked" name="imSearchChatRadioButton" value="1"><i class="im-settings__option-radio-info imSettingSearchSecondaryHotkey1"></i><span></span>                </label>                <label class="im-settings__i im-field-radio">tr{{cl.optCommonSearch}}                    <input type="radio" name="imSearchChatRadioButton" value="2"><i class="im-settings__option-radio-info imSettingSearchSecondaryHotkey2"></i><span></span>                </label>            </div>        </div>        <div class="im-settings-options settingsPaneNotify" data-title="tr{{dialog.tools.alerts}}">            <label class="im-settings__i im-settings__option" data-key="sound">                <span class="im-settings__option-label">tr{{cl.optSoundOn}}</span>                <div class="im-switch"><input type="checkbox"><span class="im-switch-lever"></span></div>            </label>            <label class="im-settings__i im-settings__option" data-key="showNotifications">                <span class="im-settings__option-label">tr{{cl.optShowNotifications}}</span>                <div class="im-switch"><input type="checkbox"><span class="im-switch-lever"></span></div>                <div class="im-settings__option-label_info">tr{{cl.optShowNotificationsSwitchOnInfo}}</div>            </label>            <label class="im-settings__i im-settings__option" data-key="hideNotificationsText">                <span class="im-settings__option-label">tr{{cl.optHideNotificationsText}}</span>                <div class="im-switch"><input type="checkbox"><span class="im-switch-lever"></span></div>            </label>        </div>        <div class="im-settings-options settingsPaneTheme" data-title="tr{{settings.theme}}">            <div class="im-settings__option" data-key="themeSelector"></div>        </div>        <div class="im-settings-options settingsPaneSecurity" data-title="tr{{settings.privacy}}">            <div class="im-settings__option" data-key="groupsSettings">                <div class="im-settings__topic">                    <span class="im-settings__option-label">tr{{settings.groupsPrivacySetting}}</span>                </div>                <label class="im-settings__i im-field-radio">tr{{settings.everybody}}                    <input type="radio" name="imGroupSettingsRadioButton" value="everybody"><span></span>                </label>                <label class="im-settings__i im-field-radio">tr{{settings.myContacts}}                    <input type="radio" name="imGroupSettingsRadioButton" value="myContacts"><span></span>                </label>                <label class="im-settings__i im-field-radio">tr{{settings.nobody}}                    <input type="radio" name="imGroupSettingsRadioButton" value="nobody"><span></span>                </label>            </div>            <div class="im-settings__option" data-key="callsSettings">                <div class="im-settings__topic">                    <span class="im-settings__option-label">tr{{settings.callsPrivacySetting}}</span>                </div>                <label class="im-settings__i im-field-radio">tr{{settings.everybody}}                    <input type="radio" name="imCallsSettingsRadioButton" value="everybody"><span></span>                </label>                <label class="im-settings__i im-field-radio">tr{{settings.myContacts}}                    <input type="radio" name="imCallsSettingsRadioButton" value="myContacts"><span></span>                </label>                <label class="im-settings__i im-field-radio">tr{{settings.nobody}}                    <input type="radio" name="imCallsSettingsRadioButton" value="nobody"><span></span>                </label>            </div>            <div class="im-settings__i im-settings__option" data-key="ignoreList">                <span class="im-settings__option-label im-settings__option-ignore_list">tr{{cl.ignoreList}}</span>            </div>            <div class="im-settings__topic">                <span class="im-settings__option-label">tr{{settings.accountSecurity}}</span>            </div>            <div class="im-settings__i im-settings__option">                <a class="im-settings__option-label im-settings__option-gdpr_get imGetGDPRLink" target="_blank" title="tr{{settings.myDataTitle}}">tr{{settings.myData}}</a>            </div>            <div class="im-settings__i im-settings__option" data-key="sessionList">                <span class="imSessionListCounter im-settings__option-label im-settings__option-sessions">tr{{settings.sessionList}}</span>            </div>            <div class="im-settings__i im-settings__option" data-key="deleteAccount">                <span class="im-settings__option-label im-settings__option_delete-account">tr{{settings.deleteMyAccount}}</span>            </div>        </div>        <div class="im-settings-options settingsPaneSessionList" data-title="tr{{settings.sessionList}}">            <div class="im-settings__topic">                <span class="im-settings__option-label">tr{{settings.currentSession}}</span>            </div>            <div class="imCurrentSession"></div>            <div class="imOtherSessions" style="display: none">                <div class="im-settings__i im-settings__option" data-key="closeSessions">                    <span class="im-settings__option-label im-settings__option_close-sessions">tr{{settings.closeOtherSessions}}</span>                </div>                <div class="im-settings__topic">                    <span class="im-settings__option-label">tr{{settings.activeSessions}}</span>                </div>                <div class="imActiveSessions"></div>            </div>        </div>        <div class="im-settings-options settingsPaneMedia" data-title="tr{{settings.media}}">            <div class="im-settings__option im-settings__option_dry" data-key="mediaAudioInput">tr{{settings.microphone}}:<br/>                <select class="imAudioInput" disabled="disabled"><option>[tr{{settings.notAvailable}}]</option></select>            </div>            <div class="im-settings__option im-settings__option_dry" data-key="mediaAudioOutput">tr{{settings.speakers}}:<br/>                <select class="imAudioOutput" disabled="disabled"><option>[tr{{settings.notAvailable}}]</option></select>            </div>            <div class="im-settings__option im-settings__option_dry" data-key="mediaVideoInput">tr{{settings.webcam}}:<br/>                <select class="imVideoInput" disabled="disabled"><option>[tr{{settings.notAvailable}}]</option></select>            </div>        </div>        <div class="im-settings-options settingsPaneInfo" data-title="tr{{settings.about}}">            <div class="im-settings-icq_version im-settings__option" data-key="buildInfo"></div>            <div class="im-settings-license_info">tr{{settings.openSSLLicenseInfo}}</div>            <div class="im-settings-license_info">tr{{settings.emojiLicenseInfo}}</div>            <div class="im-settings-license_info">© Mail.ru LLC, <span class="imSettingsYear">2020</span></div>            <div class="im-settings-license_info">tr{{settings.presentedInfo}}</div>        </div>    </div></div><div class="app-page im-switchphone" data-page="switchPhone">    <div class="app-content">        <div class="im-switchphone__sim-image"></div>        <div class="im-switchphone__hello">            <div class="im-switchphone__title">tr{{auth.switchNumber}}</div>            <ul class="im-switchphone__rules">                <li>tr{{auth.swithPhoneRule1}}</li>                <!--li>tr{{auth.swithPhoneRule2}}</li-->                <li>tr{{auth.swithPhoneRule3}}</li>            </ul>            <div class="im-switchphone__buttons">                <button class="btnPhoneCancel im-button">tr{{box.cancel}}</button>                <button class="btnPhoneOk im-button im-button_highlight">tr{{next}}</button>            </div>        </div>        <div class="imVerifyPhoneForm im-switchphone__verify-phone-form"></div>        <div class="im-switchphone__success">            <div class="im-switchphone__title">tr{{auth.numberIsSwitched}}</div>            <div class="imSwitchedOnPhone im-switchphone__success__message">tr{{auth.successSwitched}}</div>            <div class="im-switchphone__buttons">                <button class="btnPhoneOk im-button im-button_highlight">tr{{box.ok}}</button>            </div>        </div>    </div></div>',
App.setPagesNode(d),App.setInitPageFunction(function(d,e){e.innerHTML=e.innerHTML.replace(c,function(c,d,e){return a=e?e.split(","):{},a.defaultNull=!0,b.tr(d,a)||"["+d+"]"})})}(),WebIM.namespace("WebIM.ui");var _WA5=WebIM,UI=_WA5.ui,_U3=_WA5.util,_DomUtil3=_WA5.DomUtil,_lastShownModalComponent,_globalComponentsShown=0,stopEvent=function(a){_WA5.isIOS&&a.stopEvent()},stopPropagation=function(a){_WA5.isIOS&&a.stopPropagation()},ModalComponent=function(a){function b(a){var c;_classCallCheck2(this,b),a=a||{};var d={autoRender:!0,displayFlex:!0,hideOnClick:!0,hideOnEscape:!0,destroyOnHide:!0};return _WA5.applyIf(a,d),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a)),c.globalComponent=!1,c.hotKeyLayerConfig.overlayActions=c.hotKeyLayerConfig.overlayActions||{},c.hotKeyLayerConfig.overlayActions.tab=!0,c.hotKeyLayerConfig.handlers=c.hotKeyLayerConfig.handlers||{},c.hotKeyLayerConfig.handlers.tab=function(a){c.tabNavigator||(c.tabNavigator=new _WA5.TabNavigator({parent:c.el,className:!1,useNative:!0})),c.tabNavigator.switchElement(a.shiftKey),c._onTabHandler(a),a.preventDefault()},c.clickEvent=new _U3.Event,c}return _inherits2(b,a),_createClass2(b,[{key:"_getContentHtml",value:function(){return""}},{key:"_redrawContent",value:function(){this.block.updateHTML(this._getContentHtml())}},{key:"_onRender",value:function(a){this.el=a.createChild(_WA5.TD.getTMPL("overlayBox").replace(/\n+/g,"").replace(/(?:^\s+|\s+$)/g,"")),this.el.hide(),"BODY"===this.container.dom.nodeName&&(this.globalComponent=!0),this.block=this.el.first(),this.block.addClass("im-modal-box"),this.initialConfig.blockCls&&this.block.addClass(this.initialConfig.blockCls),this._redrawContent()}},{key:"_onContainerClick",value:function(a){if("mousedown"!==a.type||_WA5.isIOS){var b=a.getTarget(!0),c=this.block.contains(b);!c&&this.initialConfig.hideOnClick&&this.hide(),a.stopPropagation(),"mousedown"!==a.type&&c&&(this._onClick(b),this.clickEvent&&this.clickEvent.fire(a))}}},{key:"_onClick",value:function(a){}},{key:"_onTabHandler",value:function(){}},{key:"_onShow",value:function(){var a=this;_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),_DomUtil3.initOverlay(),this.container.addClass("im-overlay"),_WA5.hotKeyManager.addLayer(this.hotKeyLayerConfig),App.on("page:load",this.hide,this),App.on("page:back",this.hide,this),this.globalComponent&&_globalComponentsShown++,_lastShownModalComponent=this,_WA5.setTimeout(function(){a.el&&(a.container.on("click",a._onContainerClick,a),a.el.on(["scroll"],stopEvent).on("mousedown",a._onContainerClick,a),a.block&&a.block.on(["scroll"],stopPropagation),a.initialConfig.allowTouchEvents||(a.el.on(["touchmove"],stopEvent),a.block&&a.block.on(["touchmove"],stopPropagation)))},1)}},{key:"_onHide",value:function(){this.el&&(this.container.un("click",this._onContainerClick,this),this.el.un(["scroll","touchmove"],stopEvent).un("mousedown",this._onContainerClick,this),this.block&&this.block.un(["scroll","touchmove"],stopPropagation),App.off("page:load",this.hide,this),App.off("page:back",this.hide,this),this.tabNavigator&&this.tabNavigator.reset(),_lastShownModalComponent===this&&(_lastShownModalComponent=null),this.globalComponent&&_globalComponentsShown--,(!this.globalComponent||1>_globalComponentsShown)&&this.container.removeClass("im-overlay"),_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this),this.initialConfig.destroyOnHide&&this.destroy())}},{key:"destroy",value:function(){this.container&&this.container.un("click",this._onContainerClick,this),this.el&&this.el.un(["scroll","touchmove"],stopEvent).un("mousedown",this._onContainerClick,this),this.block&&this.block.un(["scroll","touchmove"],stopPropagation),this.clickEvent.removeAll(),this.clickEvent=null,_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}],[{key:"isShown",value:function(){return _globalComponentsShown>0}}]),b}(UI.ES6Component);UI.ModalComponent=ModalComponent,WebIM.namespace("WebIM.ui");var _WA6=WebIM,_UI=_WA6.ui,_U4=_WA6.util,TextField=function(a){function b(){return _classCallCheck2(this,b),_possibleConstructorReturn2(this,_getPrototypeOf2(b).apply(this,arguments))}return _inherits2(b,a),_createClass2(b,[{key:"initComponent",value:function(){this.hintText=this.initialConfig.hintText||"",this.hotKeyFocusedLayerConfig=_U4.Object.extend({handlers:{}},this.hotKeyLayerConfig),this.hotKeyFocusedLayerConfig.name=this.hotKeyFocusedLayerConfig.name+"_focused",this.clientValue="",this.focusEvent=new _U4.Event,this.blurEvent=new _U4.Event}},{key:"textVal",value:function(a){return this.val(a)}},{key:"_onRender",value:function(a){var b,c=this.initialConfig;b=c.multiline?{tag:"textarea",cls:""}:{tag:"input",type:"text",cls:""},c.hintText&&(b.placeholder=c.hintText),c.maxLength&&(b.maxlength=c.maxLength),this.el=a.createChild(b)}},{key:"val",value:function(a){return"undefined"==typeof a?this.rendered?this.el.dom.value:null:void(this.rendered&&!this.el.dom.disabled&&(this.el.dom.value=a||""))}},{key:"fix",value:function(a){this.el.dom.disabled=a!==!1}},{key:"_onAfterRender",value:function(){this.el.dom.value=this.initialConfig.value||"",this.el.on("focus",this._onFocus,this),this.el.on("blur",this._onBlur,this)}},{key:"getCursor",value:function(){var a=0;if(document.selection){this.focus();var b=document.selection.createRange();b.moveStart("character",-this.el.dom.value.length),a=b.text.length}else(this.el.dom.selectionStart||"0"==this.el.dom.selectionStart)&&(a=this.el.dom.selectionStart);return a}},{key:"delayedFocus",value:function(){_WA6.setTimeout(this.focus,100,this)}},{key:"focus",value:function(a){try{if(a>-1)if(this.el.dom.createTextRange){var b=this.el.dom.createTextRange();b.collapse(!0),b.moveEnd("character",a),b.moveStart("character",a),b.select()}else this.el.dom.setSelectionRange&&this.el.dom.setSelectionRange(a,a);else this.el.dom.focus()}catch(c){}}},{key:"blur",value:function(){try{this.el.dom.blur()}catch(a){}}},{key:"select",value:function(){this.el.dom.select()}},{key:"onHotKeyFocusedLayer",value:function(a,b,c){_WA6.hotKeyManager.forceOn(a,{handler:b,scope:c},this.hotKeyFocusedLayerConfig.name)}},{key:"unHotKeyFocusedLayer",value:function(a,b,c){_WA6.hotKeyManager.forceUn(a,{handler:b,scope:c},this.hotKeyFocusedLayerConfig.name)}},{key:"_onFocus",value:function(){this.focusEvent.fire(this),_WA6.hotKeyManager.addLayer(this.hotKeyFocusedLayerConfig)}},{key:"_onBlur",value:function(){this.blurEvent.fire(this),_WA6.hotKeyManager.removeLayer(this.hotKeyFocusedLayerConfig.name)}},{key:"destroy",value:function(){this.focusEvent.removeAll(),this.focusEvent=null,this.blurEvent.removeAll(),this.blurEvent=null,_WA6.hotKeyManager.clearForce(this.hotKeyFocusedLayerConfig.name),_WA6.hotKeyManager.removeLayer(this.hotKeyFocusedLayerConfig.name),this.el&&(this.el.un("focus",this._onFocus,this),this.el.un("blur",this._onBlur,this)),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI.ES6Component);_UI.TextField=TextField,WebIM.namespace("WebIM.ui");var MAX_SUGGEST_SEARCH_STRING=100,_WA7=WebIM,_UI2=_WA7.ui,_U5=_WA7.util,_DomUtil4=_WA7.DomUtil,LINK_START_RE=/(www\.|https?:\/\/)[\-\w\d_]+$/,REG_TAGS=/<[^>]+>/g,smartStripTags=function(a){return a.replace(REG_TAGS,function(a){return a.indexOf("data-immutable")>=0?a:a.indexOf("<mark")>-1||a.indexOf("</mark>")>-1?a:""})},getTextValue=function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,c=a.dom.innerHTML;return c=c.replace(/(\n|\r\n)/g,""),c=c.replace(/(?:<br[^>]*>)?\s*(?:<\/(?:div|p|h\d|td|table)[^>]*>)+/gi,"<br/>"),c=c.replace(/^<div[^>]*>/i,""),c=c.replace(/([^>]|[^/r]>|[^b]r\/?>)<div[^>]*>/gi,"$1<br/>"),c=c.replace(/([^>]|[^/r]>|[^b]r\/?>)<div[^>]*>/gi,"$1<br/>"),c=c.replace(/<br[^>]*>/gi,"\n"),c=c.replace(/<xml[^>]*>.+<\/xml>/g,""),c=c.replace(/<style[^>]*>.+<\/style>/g,""),c=smartStripTags(c),c=c.replace(/(\s*\n\s*)+$/g,""),c=_WA7.Emoji.recoilProccessedMessage(c),c=_U5.String.entityDecode(c),c=c.replace(/&(\w+|#\d+);?/g,function(a){return a.match(/&amp;?/)?"&":""}),b&&(c=c.substr(0,b)),c},checkElementIsSolid=function(a){return a&&a.getAttribute&&"true"===a.getAttribute("data-solid")},removeSolidElement=function(){if(!isCaretInsideSolidElement())return!1;var a=window.getSelection();if(0===a.rangeCount)return!1;var b=a.getRangeAt(0),c=b.startContainer;3===c.nodeType&&(c=c.parentNode),console.log("###removeSolidElement",c),b.setStartBefore(c),b.collapse(!0),a.removeAllRanges(),a.addRange(b),c.remove()},moveCaretOutOfSolidElement=function(a){if(a=a||!1,!isCaretInsideSolidElement())return!1;console.log("###moveCaretOutOfSolidElement",a);var b,c=window.getSelection();if(0===c.rangeCount)return!1;var d=c.getRangeAt(0),e=d.startContainer;if(3===e.nodeType&&(e=e.parentNode),isHostNode(e)){var f=d.startOffset;if(console.log("### FOCUSED ON HOSTNODE",f,e.childNodes.length),f===e.childNodes.length&&f--,e.childNodes.length&&f<e.childNodes.length&&e.childNodes[f]&&(e=e.childNodes[f],3===e.nodeType&&" "!==e.nodeValue))return console.log("###SOFT MOVE CARET TO TEXTNODE",e,e.length,'"'+e.nodeValue+'"'),d.setStart(e,e.length-1),d.collapse(!0),c.removeAllRanges(),void c.addRange(d)}a?(b=e.previousSibling,console.log("### Got <-",b,b&&b.firstChild),b||(b=_U5.DomHelper.elementFromHtml("<span>&nbsp;</span>"),d.setStartBefore(e),d.collapse(!0),d.insertNode(b)),b.firstChild&&(b=b.firstChild),3===b.nodeType&&(console.log("###move start before",b.length),b.length?d.setStartAfter(b):b.previousSibling||(console.log("###VERY START, insert empty node"),b=_U5.DomHelper.elementFromHtml("<span>&nbsp;</span>"),d.setStartBefore(e),d.collapse(!0),d.insertNode(b)),d.collapse(!0))):(b=e.nextSibling,console.log("###MOVE RIGHT",e,e.parentNode,b,b&&b.length,b&&b.firstChild),b&&b.firstChild&&(b=b.firstChild),(!b||!b.length||3===b.nodeType&&" "===b.nodeValue)&&(console.log("###creating SPAN to the right"),b=_U5.DomHelper.elementFromHtml("<span>&nbsp;</span>"),d.setStartAfter(e),d.collapse(!0),d.insertNode(b),b.firstChild&&(b=b.firstChild)),3===b.nodeType&&(console.log("###MOVE RIGHT to text",b,'"'+b.nodeValue+'"',b.length),b.length?d.setStart(b,1):d.setStart(b,0)),d.collapse(!1)),c.removeAllRanges(),c.addRange(d)},isHostNode=function(a){return(" "+a.className+" ").indexOf("im-textfield_rich")>-1},getSolidElementNextToCaret=function(){var a=_U5.Selection.getRange();if(a&&a.collapsed){var b=a.startContainer,c=a.startOffset;if(console.log("### DELETE getSolidElementNextToCaret0",b&&b.nodeType,c),b&&1===b.nodeType)console.log("### DELETING STOPPED!!!!",b,b.nextSibling),console.log("###",c,b.childNodes.length,b.childNodes[c]),b=b.childNodes[c+1],console.log("### ...BUT POSSIBLE TARGET TO DELETE:",b);else if(b&&3===b.nodeType&&(console.log("### DELETE getSolidElementNextToCaret!!!!!",b,b.length,c,b.nextSibling),c===b.length)){for(var d=b.nextSibling;!d&&(b=b.parentNode,b.parentNode&&!isHostNode(b.parentNode));)d=b.nextSibling;for(console.log("### DELETE 2:",d);d;){if(checkElementIsSolid(d))return d;d=d.firstChild}}}return null},isCaretInsideSolidElement=function(){var a=_U5.Selection.getCaretElement(),b=_U5.Selection.getSelection();if(0===b.rangeCount)return!1;var c=b.getRangeAt(0),d=c.startOffset;return a?1===a.nodeType&&isHostNode(a)&&a.childNodes.length>1&&3===a.lastChild.nodeType&&d>=a.childNodes.length-1&&(console.log("### BEFORE GOT IT!!",a.lastChild.nodeValue),checkElementIsSolid(a.lastChild.previousSibling)&&(d===a.childNodes.length-1||" "===a.lastChild.nodeValue))?(console.log("### GOT IT!!"),!0):(3===a.nodeType&&(a=a.parentNode),checkElementIsSolid(a)):!1},stopEventHandler=function(a){a.stopEvent()},SmilesTextField=function(){function a(b){_classCallCheck2(this,a),this.initialConfig=b||{},this.placeholder=this.initialConfig.placeholder||this.initialConfig.hintText||"",this.maxLength=this.initialConfig.strictMaxLength||this.initialConfig.maxLength,this.isEmpty=!0,this._lastKeyPressed=null,this.hotKeyFocusedLayerConfig={name:this.initialConfig.id||_DomUtil4.generateId(),handlers:{},overlayOnHandle:!0,activateOnCreate:!0},this.resizeEvent=new _U5.Event,this.focusEvent=new _U5.Event,this.blurEvent=new _U5.Event,this.toggleEvent=new _U5.Event,this.changeEvent=new _U5.Event,this.suggestsEvent=new _U5.Event,this.pasteFileEvent=new _U5.Event}return _createClass2(a,[{key:"renderBind",value:function(a){var b=this;this.el=_DomUtil4.get(a),this.el.innerHTML="",this.isEmpty=!0;var c=this.initialConfig;this.maxLength&&a.setAttribute("maxlength",this.maxLength),c.placeholder&&a.setAttribute("placeholder",c.placeholder),this.el.on("click",this._onClick,this),this.el.on("mousemove",this._onMousemove,this),this.el.on("focus",this._onFocus,this),this.el.on("blur",this._onBlur,this),this.el.on("contextmenu",this._onContextMenu,this),this.el.on("keyup",this.onKeyUp,this),this.el.on("keydown",this.onKeyDown,this),_DomUtil4.getBody().on("paste",this.onPaste,this),_WA7.isIE||(this.el.on("input",this.onInput,this),this.el.on("change",this.onInput,this)),this._stylesTimer&&this._stylesTimer.stop(),this._stylesTimer=new _U5.DelayedTask({fn:function(){return b.el?(b._removeInlineStyles(),b._checkCaretInsideSolidElement(),void b._stylesTimer.start()):b._stylesTimer.stop()},interval:300}),this._stylesTimer.start(),this._preventSmilesEditing(),c.expandHeight||(this.scrollBar=new _UI2.ScrollBar({source:this.el.parent(),expandOnHover:!1,trackVisible:!0})),this._height=this.el.dom.offsetHeight}},{key:"renderUnbind",value:function(){_WA7.hotKeyManager.removeLayer(this.hotKeyFocusedLayerConfig.name),this._stylesTimer&&this._stylesTimer.stop(),this._stylesTimer=null,this.scrollBar&&this.scrollBar.destroy(),this.el.un("click",this._onClick,this),this.el.un("mousemove",this._onMousemove,this),this.el.un("focus",this._onFocus,this),this.el.un("blur",this._onBlur,this),this.el.un("contextmenu",this._onContextMenu,this),this.el.un("keyup",this.onKeyUp,this),this.el.un("keydown",this.onKeyDown,this),_DomUtil4.getBody().un("paste",this.onPaste,this),_WA7.isIE||(this.el.un("input",this.onInput,this),this.el.un("change",this.onInput,this)),this._permitSmilesEditing(),this._changeTimer&&(clearTimeout(this._changeTimer),this._changeTimer=null),this.el=this._height=null}},{key:"onKeyUp",value:function(a){_WA7.isIE&&27!==this._lastKeyPressed&&this.onInput(a),this._checkCaretInsideSolidElement(),this.scrollBar&&this.scrollBar.sync()}},{key:"onKeyDown",value:function(a){var b=a.browserEvent;if(this._lastKeyPressed=b.keyCode?b.keyCode:b.which,46===this._lastKeyPressed){var c=getSolidElementNextToCaret();c&&(this._lastKeyPressed=null,c.remove())}}},{key:"onHotKeyFocusedLayer",value:function(a,b,c){_WA7.hotKeyManager.forceOn(a,{handler:b,scope:c},this.hotKeyFocusedLayerConfig.name)}},{key:"unHotKeyFocusedLayer",value:function(a,b,c){_WA7.hotKeyManager.forceUn(a,{handler:b,scope:c},this.hotKeyFocusedLayerConfig.name)}},{key:"onInput",value:function(a,b){this.el.dom.innerHTML.match(/^(?:<br\/?>|<div><br\/?><\/div>|<p><br\/?><\/p>)$/)?(this.el.dom.innerHTML="",this._setCaret()):a&&(this._afterPaste&&this._removeInlineStyles(),this._onKeyup(a)),this._afterPaste=!1,b!==!0&&this._onChange(),this._checkResize();var c=-1===this.el.dom.innerHTML.indexOf("im-emoji_inline")&&!/\S/.test(this.el.dom.innerText);c!==this.isEmpty&&(this.isEmpty=c,this.toggleEvent.fire(c)),this._checkSuggestTrigger()}},{key:"onPaste",value:function(a){var b,c=a.browserEvent.clipboardData||window.clipboardData,d=a.getTarget(!0);this._afterPaste=!0,c&&d&&d.up("im-dialogpage")&&(c.files&&c.files.length?b=c.files[0]:c.items&&c.items[0]&&(b=c.items[0].getAsFile()),b&&(a.preventDefault(),console.log("###FILE",b),this.pasteFileEvent.fire(b)))}},{key:"_getPositionFromIndex",value:function(a){var b=_U5.Selection.createRange(),c=_U5.Selection.getSelection();if(c){b.setStart(c.anchorNode,a),b.setEnd(c.anchorNode,a+1);var d=b.getBoundingClientRect();return d.x=d.x/_WA7.zoom,d.y=d.y/_WA7.zoom,d.width=d.width/_WA7.zoom,d.height=d.height/_WA7.zoom,d}}},{key:"_checkSuggestTrigger",value:function(){var a,b,c,d=!1,e="",f=_U5.Selection.getTextBeforeCaret();f.length&&(b=f.lastIndexOf("@"),b>-1&&(e=f.substr(b+1),a=0===b||f.charAt(b-1).match(/\s/),a&&e.length<=MAX_SUGGEST_SEARCH_STRING&&e.match(/\S|^$/)&&(d=!0,c=this._getPositionFromIndex(b)))),this.suggestsEvent.fire(d,e,c)}},{key:"_checkCaretInsideSolidElement",value:function(a){if(!isCaretInsideSolidElement())return!1;if(a||46===this._lastKeyPressed||8===this._lastKeyPressed)return this._lastKeyPressed=null,void removeSolidElement();var b=37===this._lastKeyPressed||36===this._lastKeyPressed;this._lastKeyPressed=null,moveCaretOutOfSolidElement(b)}},{key:"_checkResize",value:function(){var a=this.el.dom.offsetHeight;a&&a!==this._height&&(this._height=a,this.scrollBar&&this.scrollBar.sync(),this.resizeEvent.fire())}},{key:"_onChange",value:function(){this._needFireChange=!0,this._changeTimer||(this._fireChangeEvent(),this._changeTimer=_WA7.setTimeout(this._fireChangeEvent,300,this))}},{key:"_fireChangeEvent",value:function(){this._changeTimer=null,this._needFireChange&&(this._needFireChange=!1,this.changeEvent.fire(getTextValue(this.el),this.initialConfig.strictMaxLength))}},{key:"val",value:function(a,b){return this._lastAnchorNode=this._lastAnchorOffset=null,void 0===a?this.el?this.el.dom.innerHTML:null:void(this.el&&(this.el.dom.innerHTML=a||"",this.onInput(0,!!b)))}},{key:"textVal",value:function(a,b){if(void 0===a){var c=null;return this.el&&(c=getTextValue(this.el,this.initialConfig.strictMaxLength)),c}this.el&&(this.el.dom.textContent=a||"",this.el.dom.innerText=a||"",this.el.dom.innerHTML=_WA7.Emoji.parse(this.el.dom.innerHTML),this.onInput(0,!!b))}},{key:"focus",value:function(a){if(this.el){try{this.el.dom.focus()}catch(b){}(!_U5.Selection.isFocused(this.el.dom)||a)&&this._setCaret()}}},{key:"delayedFocus",value:function(a){var b=this;_WA7.setTimeout(function(){b.focus(a)},100)}},{key:"blur",value:function(){if(this.el)try{this.el.dom.blur();var a=_U5.Selection.getSelection();a&&a.focusNode===this.el.dom&&a.removeAllRanges()}catch(b){}}},{key:"_removeInlineStyles",value:function(){_U5.DomHelper.htmlTree(this.el.dom,function(a){a.getAttribute("style")&&a.setAttribute("style",null),!a.getAttribute("class")||a.getAttribute("data-immutable")||a.getAttribute("data-solid")||a.setAttribute("class","")}),this._checkResize()}},{key:"_setCaret",value:function(){var a=_U5.Selection.getSelection(),b=_U5.Selection.createRange();if(this._lastAnchorNode&&this._lastAnchorNode.parentNode)try{b.setStart(this._lastAnchorNode,this._lastAnchorOffset)}catch(c){b.setStart(this.el.dom,this.el.dom.childNodes.length)}else b.setStart(this.el.dom,this.el.dom.childNodes.length);b.collapse(!0),a.removeAllRanges(),a.addRange(b)}},{key:"_saveCaretPosition",value:function(){var a=_U5.Selection.getSelection();a?(this._lastAnchorNode=a.anchorNode,this._lastAnchorOffset=a.anchorOffset):this._lastAnchorNode=this._lastAnchorOffset=null}},{key:"_onFocus",value:function(){this.focusEvent.fire(this),_WA7.hotKeyManager.addLayer(this.hotKeyFocusedLayerConfig)}},{key:"_onBlur",value:function(){_WA7.hotKeyManager.removeLayer(this.hotKeyFocusedLayerConfig.name);var a=_U5.Selection.getSelection();a&&this.blurEvent.fire(this)}},{key:"_onContextMenu",value:function(a){this._mouseClickHandler(a)}},{key:"_onClick",value:function(a){this._mouseClickHandler(a),this._lastKeyPressed=null,this._checkCaretInsideSolidElement(),this._checkSuggestTrigger(),this._saveCaretPosition()}},{key:"_mouseClickHandler",value:function(a){var b=a.getTarget();if("img"===b.tagName.toLowerCase()){var c=_U5.Selection.getSelection(),d=_U5.Selection.createRange(),e=b.offsetX<b.width/2;e?b.previousSibling?d.setStartAfter(b.previousSibling):d.setStart(c.anchorNode,0):d.setStartAfter(b),d.collapse(!0),c.removeAllRanges(),c.addRange(d)}else _WA7.isIE||this.focus()}},{key:"_onMousemove",value:function(a){var b,c=a.browserEvent,d=a.getTarget(),e=d.className;e&&_WA7.isString(e)&&e.indexOf("im-emoji_inline")>=0&&(c.offsetX?b=c.offsetX:c.layerX&&(b=c.layerX),d.offsetX=b)}},{key:"_onKeyup",value:function(a){a.stopPropagation(),this._saveCaretPosition()}},{key:"_replaceEmojiToImage",value:function(){var a=_U5.Selection.getSelection();if(a){var b,c,d,e,f,g,h,i=a.anchorNode;this._replaceImgTags(this.el.dom),i&&i.data&&(b=i.data.substr(0,a.anchorOffset)),i&&i.data&&(!LINK_START_RE.test(i.data)&&(c=_WA7.Emoji.smileCodeLastRE.exec(b))||(d=_WA7.Emoji.smileLastRE.exec(b)))&&(h=d?b:b.replace(_WA7.Emoji.smileCodeLastRE,function(a,b){return g=b,_WA7.Emoji.shortcutToChar(b)}),h=_WA7.MessageFormatter.buildPlainHtmlMessage(h),e=(d||c).shift().length,f=_U5.DomHelper.elementFromHtml(h),g&&"img"===f.tagName.toLowerCase()&&(f.setAttribute("data-origin",g),f.setAttribute("data-immutable",!0)),f&&(1===f.nodeType?_U5.Selection.insertNodeAtCaret(f):_U5.Mnt.flog("smilenode",f),i.data=i.data.substr(0,i.data.length-e)))}}},{key:"_getSmileText",value:function(a){var b=a.getAttribute("data-origin");return b}},{key:"checkScroll",value:function(){if(this.el){var a=_U5.Selection.getSelection();if(0!==a.rangeCount){var b,c,d=a.getRangeAt(0),e=document.createElement("span"),f=this.el.dom;_WA7.apply(e.style,{height:"0",width:"0"}),d.insertNode(e),c=e.offsetTop,e.parentNode.removeChild(e),b=f.clientHeight+f.scrollTop>=c+15,b||(f.scrollTop=c)}}}},{key:"_replaceLinkTags",value:function(a){var b=a.getElementsByTagName("a");b.length&&_U5.Array.each(b,function(a){var b=document.createTextNode(a.href);a.parentNode.replaceChild(b,a)})}},{key:"_replaceImgTags",value:function(a){var b=a.getElementsByTagName("img");_U5.Array.each(b,function(a){if(!(a.className.indexOf("im-emoji_inline")>-1)){var b=document.createTextNode(" "+a.src);a.parentNode.replaceChild(b,a)}})}},{key:"_preventSmilesEditing",value:function(){if(this.el.on(["resizestart","drop","dragover","dragstart"],stopEventHandler),!_WA7.isIE&&document.execCommand)try{document.execCommand("enableObjectResizing",!1,!1)}catch(a){}}},{key:"_permitSmilesEditing",value:function(){this.el.un(["resizestart","drop","dragover","dragstart"],stopEventHandler)}},{key:"doBackspace",value:function(a){var b=this;_WA7.setTimeout(function(){var c=_U5.Selection.getSelection(),d=b.el;if(d){d.contains(c.anchorNode)&&d.contains(c.focusNode)||b.focus(!0);var e,f=c.getRangeAt(0);if(c.isCollapsed){var g;if(f.startOffset&&(f.setStart(f.startContainer,f.startOffset-1),g=f.startOffset<f.endOffset),!g&&f.startContainer!==d.dom){for(var h=f.startContainer;!h.previousSibling;)if(h=h.parentNode,g||-1!==_DomUtil4.get(h).getStyle("display").indexOf("inline")||(g=!0),h===d.dom){h=!1;break}if(!h)return void(a&&a());for(e=h;!g&&e.firstChild;)-1===_DomUtil4.get(e).getStyle("display").indexOf("inline")&&(g=!0),e=e.firstChild;for(h=h.previousSibling;h.lastChild;)g||-1!==_DomUtil4.get(h).getStyle("display").indexOf("inline")||(g=!0),h=h.lastChild;3===h.nodeType?f.setStart(h,h.length-(!g&&h.length?1:0)):f.setStartAfter(h)}}e=f.startContainer;var i,j=f.endContainer,k=e.parentNode,l=j.parentNode,m=f.commonAncestorContainer,n=m.parentNode;if(f.collapsed||f.deleteContents(),c.removeAllRanges(),c.addRange(f),f.detach(),3===m.nodeType&&(m=n),l!==k||j!==m&&3!==j.nodeType||e!==m&&3!==e.nodeType){var o,p;if(3===e.nodeType&&(e=k),3===j.nodeType&&(o=j,j=l),j!==m)for(;j.parentNode&&j.parentNode!==m;)if(-1===_DomUtil4.get(j).getStyle("display").indexOf("inline")){for(o=document.createDocumentFragment();j.firstChild;)o.appendChild(j.firstChild);l=j.parentNode,l.replaceChild(o,j),o=null,j=l}else j=j.parentNode;for(;e!==m;){if(-1===_DomUtil4.get(e).getStyle("display").indexOf("inline")){p=!0;break}e=e.parentNode}if(j!==m&&-1===_DomUtil4.get(j).getStyle("display").indexOf("inline"))if(j.innerHTML.match(/^\<br\/?\>$/))j.parentNode.removeChild(j);else{for(o=document.createDocumentFragment(),j.lastChild&&j.lastChild.tagName&&"br"===j.lastChild.tagName.toLowerCase()&&j.removeChild(j.lastChild);j.firstChild;)o.appendChild(j.firstChild);l=o.childNodes[0],p?(j.parentNode.removeChild(j),e.lastChild&&e.lastChild.tagName&&"br"===e.lastChild.tagName.toLowerCase()?e.insertBefore(o,e.lastChild):e.appendChild(o)):j.parentNode.replaceChild(o,j),f=c.getRangeAt(0),f.setEnd(l,0),f.collapse(),c.removeAllRanges(),c.addRange(f)}else p&&(o||j!==m)&&(j===m&&(j=o),e.lastChild&&e.lastChild.tagName&&"br"===e.lastChild.tagName.toLowerCase()?e.insertBefore(j,e.lastChild):e.appendChild(j))}if(d.dom.normalize(),f=c.getRangeAt(0),j=e=!1,m=3!==f.startContainer.nodeType&&(f.startOffset?f.startContainer.childNodes[f.startOffset-1]:f.startContainer)||m,m&&m!==d.dom&&""===m.innerHTML&&(-1===_DomUtil4.get(m).getStyle("display").indexOf("inline")?(m.appendChild(document.createElement("br")),e=m,i=0):m.tagName&&"img"!==m.tagName.toLowerCase()&&(m.parentNode.removeChild(m),d.dom.normalize())),!e&&3!==f.startContainer.nodeType)if(k=f.startContainer.childNodes[f.startOffset-1]){for(;k.lastChild;)k=k.lastChild,j=!0;3===k.nodeType?(e=k,i=e.length):j&&(e=k.parentNode,i=e.childNodes.length),k.tagName&&"br"===k.tagName.toLowerCase()&&(e=k.parentNode,i=e.childNodes.length-1)}else if(k=f.startContainer.childNodes[f.startOffset]){for(;k.firstChild;)k=k.firstChild,j=!0;3===k.nodeType?(e=k,i=0):j&&(e=k.parentNode,i=0)}if(k=e||f.startContainer,3===k.nodeType&&" "===k.nodeValue.charAt(k.nodeValue.length-1)){var q=document.createElement("div");q.innerHTML=k.nodeValue," "===q.innerHTML.charAt(q.innerHTML.length-1)&&(q.innerHTML=q.innerHTML.slice(0,-1)+"&nbsp;",e=q.firstChild,"number"!=typeof i&&(i=f.startOffset),i=i===e.length-1?e.length:i,k.parentNode.replaceChild(e,k))}e&&"number"==typeof i&&(f=_U5.Selection.createRange(),f.setStart(e,i),f.setEnd(e,i),c.removeAllRanges(),c.addRange(f),f.detach()),b._saveCaretPosition(),b.onInput(),a&&a()}},1)}}]),a}();_UI2.SmilesTextField=SmilesTextField,_UI2.SmilesTextField.getTextValue=getTextValue,WebIM.namespace("WebIM.ui");var _WA8=WebIM,_UI3=_WA8.ui,_DomUtil5=_WA8.DomUtil,Layer=function(a){function b(a){var c;return _classCallCheck2(this,b),a=a||{},c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a)),c.autoEl={tag:"div",style:"display: none"},c._controlEl=[],c.initialConfig.hideOnEscape=a.hideOnEscape!==!1,c}return _inherits2(b,a),_createClass2(b,[{key:"setControlElement",value:function(a){this._controlEl=a&&null==a.length&&[a]||a}},{key:"_onShow",value:function(){_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),this.initialConfig.autoHide!==!1&&_DomUtil5.getBody().on("mousedown",this._onMouseDown,this)}},{key:"_onHide",value:function(){_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this),this.initialConfig.autoHide!==!1&&_DomUtil5.getBody().un("mousedown",this._onMouseDown,this)}},{key:"_onAncestorDown",value:function(a,b,c){}},{key:"_onMouseDown",value:function(a){if(this.isVisible()&&0===a.button){var b=!1,c=!1,d=a.getTarget(!0);if(d)for(var e=0,f=this._controlEl.length;f>e;e++)if(this._controlEl[e].contains(d))return;d&&(c=this.el.equals(d),b=c||this.el.contains(d)),b?this._onAncestorDown(d,c,a):this.initialConfig.hideOnEscape&&this.hide()}}},{key:"destroy",value:function(){this.initialConfig.autoHide!==!1&&_DomUtil5.getBody().un("mousedown",this._onMouseDown,this),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI3.ES6Component);_UI3.Layer=Layer,WebIM.namespace("WebIM.ui");var _WA9=WebIM,_UI4=_WA9.ui,_U6=_WA9.util,_DomUtil6=_WA9.DomUtil,Menu=function(a){function b(a){var c;return _classCallCheck2(this,b),a=a||{},c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a)),c.hotKeyLayerConfig.overlayActions||(c.hotKeyLayerConfig.overlayActions={}),c.hotKeyLayerConfig.overlayActions.arrowLeft=c.hotKeyLayerConfig.overlayActions.arrowRight=c.hotKeyLayerConfig.overlayActions.tab=!0,c}return _inherits2(b,a),_createClass2(b,[{key:"selectItem",value:function(a){if(this.el&&this.el.dom){var b=this.initialConfig,c=b.itemClass,d=b.activeItemClass;if(c&&d){var e=this.el.dom.querySelectorAll("."+c);e[a]&&_DomUtil6.get(e[a]).addClass(d)}}}},{key:"_onClick",value:function(a){if(this.initialConfig.onItemClick){var b=a.getTarget(!0),c=b.up("imButton"),d=c&&c.getAttribute("data-action");this.initialConfig.onItemClick(d,b,a),this.initialConfig.hideOnClick&&this.hide()}}},{key:"_onShow",value:function(){var a=this.initialConfig,c=a.activeItemClass,d=a.showCls;_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),d&&this.el.addClass(d);var e=c&&this.el.getSelector("."+c);e&&e.removeClass(c),this.el.on("mouseover",this._onMouseOver,this),this.el.on("mouseleave",this._onMouseLeave,this),this.el.on("click",this._onClick,this),_WA9.hotKeyManager.on("arrowUp",{handler:this._onArrowUp,scope:this},this.hotKeyLayerConfig.name),_WA9.hotKeyManager.on("arrowDown",{handler:this._onArrowDown,scope:this},this.hotKeyLayerConfig.name),_WA9.hotKeyManager.on("enter",{handler:this._onEnter,scope:this},this.hotKeyLayerConfig.name)}},{key:"_onHide",value:function(){if(_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this),this.el){var a=this.initialConfig,c=a.activeItemClass,d=a.showCls;d&&this.el.removeClass(d),this.el.un("mouseover",this._onMouseOver,this),this.el.un("mouseleave",this._onMouseLeave,this),this.el.un("click",this._onClick,this);var e=c&&this.el.getSelector("."+c);e&&e.removeClass(c)}_WA9.hotKeyManager.un("arrowUp",{handler:this._onArrowUp,scope:this},this.hotKeyLayerConfig.name),_WA9.hotKeyManager.un("arrowDown",{handler:this._onArrowDown,scope:this},this.hotKeyLayerConfig.name),_WA9.hotKeyManager.un("enter",{handler:this._onEnter,scope:this},this.hotKeyLayerConfig.name)}},{key:"_onMouseOver",value:function(a){var b=this.initialConfig,c=b.itemClass,d=b.activeItemClass,e=c&&a.getTarget(!0).up(c);if(e&&d&&!e.hasClass(d)){var f=this.el.getSelector("."+d);f&&f.removeClass(d),e.addClass(d)}}},{key:"_onMouseLeave",value:function(){var a=this.initialConfig.activeItemClass,b=a&&this.el.getSelector("."+a);b&&b.removeClass(a)}},{key:"_onArrowUp",value:function(){var a=this.initialConfig,b=a.itemClass,c=a.activeItemClass,d=b&&this.el.getSelector("."+b).matchElement(function(a){return a.isVisible()},"next"),e=c&&this.el.getSelector("."+c);e&&(e.removeClass(c),d=e.matchElement(function(a){return a.isVisible()},"prev","prev")||this.el.matchElement(function(a){return a.isVisible()},"prev","last")),d&&c&&d.addClass(c)}},{key:"_onArrowDown",value:function(){var a=this.initialConfig,b=a.itemClass,c=a.activeItemClass,d=b&&this.el.getSelector("."+b).matchElement(function(a){return a.isVisible()},"next"),e=c&&this.el.getSelector("."+c);e&&(e.removeClass(c),d=e.matchElement(function(a){return a.isVisible()},"next","next")||d),d&&c&&d.addClass(c)}},{key:"_onEnter",value:function(a){var b=this.initialConfig.activeItemClass,c=b&&this.el.getSelector("."+b);if(c){var d=c.getSelector("input");d?d.dom.click():c.dom.click()}}},{key:"destroy",value:function(){this.el&&(this.el.un("mouseover",this._onMouseOver,this),this.el.un("mouseleave",this._onMouseLeave,this),this.el.un("click",this._onClick,this)),_WA9.hotKeyManager.un("arrowUp",{handler:this._onArrowUp,scope:this},this.hotKeyLayerConfig.name),_WA9.hotKeyManager.un("arrowDown",{handler:this._onArrowDown,scope:this},this.hotKeyLayerConfig.name),_WA9.hotKeyManager.un("enter",{handler:this._onEnter,scope:this},this.hotKeyLayerConfig.name),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI4.Layer);_UI4.Menu=Menu,WebIM.namespace("WebIM.ui");var _WA10=WebIM,_UI5=_WA10.ui,MIN_SLIDER_SIZE=50,WHEEL_STEP=40,hasNativeSupport=!!("getBoundingClientRect"in document.documentElement),_DomUtil7=_WA10.DomUtil,Scrollbar=function(a){function b(a){return _classCallCheck2(this,b),a=a||{},a.source&&!a.autoRender&&(a.autoRender=a.source.parent()),_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a))}return _inherits2(b,a),_createClass2(b,[{key:"initComponent",value:function(){this.enabled=_WA10.isDesktop&&hasNativeSupport&&!(_WA10.isMac&&_WA10.isTouchDevice),this.enabled&&(this.sourceEl=this.initialConfig.source||null,this.expandOnHover=this.initialConfig.expandOnHover!==!1,this.watchResize=this.initialConfig.watchResize!==!1,
this.trackVisible=this.initialConfig.trackVisible||!1,this.sliderSize=0,this.sliderStart=0,this.contentSpace=0,this.mouseStart=0,this.trackSize=0,this.sliderSpace=0,this.rate=1,this.deferredUpdate=!1,this.suspended=!1,this._syncTimer=null,this.sourceEl&&this.sourceEl.addClass("im-scrollbar__source"),this.watchResize&&_DomUtil7.fly(window).on("afterresize",this.sync,this))}},{key:"render",value:function(a){this.enabled&&_get2(_getPrototypeOf2(b.prototype),"render",this).call(this,a)}},{key:"_onRender",value:function(a){this.container=a,this.container.setAttribute("data-keep-element",1),this.el=a.createChild({tag:"div",style:"display:none",cls:"im-scrollbar"+(this.expandOnHover?" im-scrollbar_expandable":"")+(this.trackVisible?" im-scrollbar_always-visible":""),children:[{tag:"div",cls:"im-scrollbar__view","data-keep-element":1,children:{tag:"div",cls:"im-scrollbar__slider","data-keep-element":1,children:{tag:"div",cls:"im-scrollbar__slider-view"}}}]},!0),this.track=this.el.first(),this.slider=this.track.first(),this._initEvents()}},{key:"_initEvents",value:function(){this.slider.on("mousedown",this._start,this),this.track.on("mousedown",this._drag,this),this.container.on("DOMMouseScroll",this._wheel,this),this.container.on("mousewheel",this._wheel,this)}},{key:"_start",value:function(a){return a&&(a.preventDefault(),this.mouseStart=a.pageY),this.dragging=!0,this.el.addClass("im-scrollbar_captured"),this.sliderStart=parseInt(this.slider.dom.style.top),_DomUtil7.getDoc().on("mousemove",this._drag,this),_DomUtil7.getDoc().on("mouseup",this._end,this),this.slider.on("mouseup",this._end,this),!1}},{key:"_drag",value:function(a){if("mousedown"==a.type){if(this.dragging)return!1;this.sliderStart=-Math.floor(this.sliderSize/2),this.mouseStart=this.track.offset().top}else a.preventDefault();if(this.rate<1){var b=Math.min(this.sliderSpace,Math.max(0,this.sliderStart+a.pageY-this.mouseStart));this._scrollContent(b*this.scrollRatio),this._moveSlider(b)}return!1}},{key:"_end",value:function(a){return _DomUtil7.getDoc().un("mousemove",this._drag,this),_DomUtil7.getDoc().un("mouseup",this._end,this),this.slider.un("mouseup",this._end,this),this.el.removeClass("im-scrollbar_captured"),this.dragging=!1,this.deferredUpdate&&this._onSourceUpdate(),!1}},{key:"_wheel",value:function(a){if(!this.sourceEl||this.suspended)return!1;if(this.rate>=1)return!1;a.preventDefault(),a=a.browserEvent;var b=a.wheelDelta?a.wheelDelta/120:-a.detail/3,c=Math.min(this.contentSpace,Math.max(0,this.sourceEl.dom.scrollTop-b*WHEEL_STEP));this._scrollContent(c),this._onSourceUpdate()}},{key:"pauseDrag",value:function(){this.dragging&&(this._paused={mouseStart:this.mouseStart+parseInt(this.slider.dom.style.top)-this.sliderStart},this._end())}},{key:"resumeDrag",value:function(){this._paused&&(this.mouseStart=this._paused.mouseStart,this._paused=!1,this._start())}},{key:"sync",value:function(a){this.enabled&&(a&&this._sync(),this._syncTimer=_WA10.setTimeout(this._sync,10,this))}},{key:"suspend",value:function(){this.suspended=!0,this.hide()}},{key:"resume",value:function(){this.suspended=!1,this.sync(!0)}},{key:"_sync",value:function(){return this.dragging?void(this.deferredUpdate=!0):void this._onSourceUpdate()}},{key:"setSource",value:function(a){this.enabled&&(this.sourceEl&&this.sourceEl.removeClass("im-scrollbar__source"),this.sourceEl=a,this.sourceEl&&this.sourceEl.addClass("im-scrollbar__source"),this._onSourceUpdate())}},{key:"_onSourceUpdate",value:function(){if(this.deferredUpdate=!1,!this.sourceEl||this.suspended)return void this.hide();var a=this.sourceEl.dom.offsetHeight,c=this.sourceEl.dom.scrollHeight;if(this.rate=a/c,this.rate>=1||!this.sourceEl.isVisible())return void this.hide();if(_get2(_getPrototypeOf2(b.prototype),"show",this).call(this),this.trackSize=this.track.dom.clientHeight,this.trackSize<MIN_SLIDER_SIZE)return void this.hide();this.sliderSize=Math.max(MIN_SLIDER_SIZE,Math.floor(this.trackSize*this.rate)),this.sliderSpace=this.trackSize-this.sliderSize,this.contentSpace=c-a,this.scrollRatio=this.contentSpace/this.sliderSpace;var d=Math.min(Math.floor(this.sourceEl.dom.scrollTop*this.sliderSpace/this.contentSpace),this.sliderSpace);this.slider.setHeight(this.sliderSize),this._moveSlider(d)}},{key:"_moveSlider",value:function(a){this.slider.setStyle("top",a+"px")}},{key:"_scrollContent",value:function(a){this.sourceEl.dom.scrollTop=a}},{key:"scrollToBottom",value:function(){this.enabled&&(this._sync(),this._scrollContent(this.sourceEl.dom.scrollHeight))}},{key:"destroy",value:function(){this._syncTimer&&clearTimeout(this._syncTimer),this._syncTimer=null,_DomUtil7.fly(window).un("afterresize",this.sync,this),this.container&&(this.container.un("DOMMouseScroll",this._wheel,this),this.container.un("mousewheel",this._wheel,this)),this.sourceEl&&this.sourceEl.removeClass("im-scrollbar__source"),this.sourceEl=null,_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI5.ES6Component);_UI5.ScrollBar=Scrollbar,WebIM.namespace("WebIM.ui");var _WA11=WebIM,TD=_WA11.TemplateDriver,_UI6=_WA11.ui,_U7=_WA11.util,_DomUtil8=_WA11.DomUtil,AppTabBox=function(a){function b(a){var c;_classCallCheck2(this,b);var d=_WA11.uniq(),e=_WA11.applyIf(a||{},{clsSuffix:""+d,switchOptions:"",hideOnEscape:!1,dataSource:{}});return e.cls="im-tabbox im-tabbox_"+e.clsSuffix,c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,e)),c.uid=d,c.autoEl={tag:"div",style:"display: none"},c._activeId=null,c.tabClickEvent=new _U7.Event,c.itemClickEvent=new _U7.Event,c.dataSource=a.dataSource,c.dataSource.init(),c}return _inherits2(b,a),_createClass2(b,[{key:"_onAfterRender",value:function(a){this.el.updateHTML('<div class="im-multitabs im-multitabs_'+this.initialConfig.clsSuffix+' app-tab-bar"></div><div class="im-tabbox-content im-tabbox-content_'+this.initialConfig.clsSuffix+'"></div>'),this.tabsBlock=this.el.first(),this.tabsBlock.on("click",this._onTabClick,this),this.tabsBlock.on("scroll",this._onTabsScroll,this),this.tabsBlock.on("touchmove",function(a){a.browserEvent.stopPropagation()}),_WA11.isDesktop&&(this.tabsBlock.setStyle("overflow","hidden"),this.tabsBlock.on("wheel",this._onTabsWheel,this)),this.contentsBlock=this.el.last(),this.contentsBlock.on("click",this._onItemClick,this),this.initialConfig.swipeSwitch&&(this.contentsBlock.on("swap:move",function(a){a.stopPropagation()}),this.contentsBlock.on("swap:end",function(a){if(a=a.browserEvent,Math.abs(a.deltaX)>this.el.dom.offsetWidth/3){var b=this.dataSource.getSetIndexById(this._activeId),c=+b+(a.deltaX>0?-1:1),d=-1===c||!this.selectTab(c);if(d&&this.initialConfig.dontStopSwapOnEdge)return}a.stopPropagation()},this),this.contentsBlock.on(["resizestart","drop","dragover","dragstart"],function(a){a.stopEvent()})),this.scrollBar=new _UI6.ScrollBar({trackVisible:!0}),this.scrollBar.render(this.el),this.tabNavigator||(this.tabNavigator=new _WA11.TabNavigator({parent:this.tabsBlock,className:"tab-active",keepClassName:!0,attrName:"data-tab-index"}),this.tabNavigator.changeEvent.on(function(a,b){b&&b.dom.click()})),this.dataSource.dataChangeEvent.on(function(){this._renderTabs()},this),this._renderTabs(),this._enableScollButtons&&this.enableScrollButtons()}},{key:"_renderTabs",value:function(){for(var a=[],b=this.dataSource.getSetCount(),c=0;b>c;c++)a.push(this._createTabElement(c));this.tabsBlock.updateHTML(a.join("")),this._activeId&&this.selectTab(this._activeId,!0),_WA11.setTimeout(this._checkScrollButtons,100,this)}},{key:"_createTabElement",value:function(a){var b=this.dataSource.getSetId(a),c=this.dataSource.getSetDataById(b)||{},d="tabLayer"+this.uid+"_"+b,e="tabButton"+this.uid+"_"+a;return TD.parseSafe("tabBoxItem",[a,this.initialConfig.clsSuffix+(c.disabled?" im-multitabs__tab_disabled":""),b,e,c.icon?'<img src="'+_U7.String.encodeHref(c.icon)+'">':'<span class="im-multitabs__tabspan"></span>',d,this.initialConfig.switchOptions],{safeKeys:["4"]})}},{key:"setFocus",value:function(a,b,c){var d="",e="tabLayer"+this.uid+"_"+b,f=_DomUtil8.get(e),g=this.dataSource.checkTabUpdated(b);f&&g&&(f.remove(),f=null);var h=this.dataSource.getSetDataById(b)||{};f||(f=this.contentsBlock.createChild({tag:"div",id:e,cls:"im-tabbox__layer"+(h.disabled?" im-tabbox__layer_disabled":"")})),f&&(this._activeId=b,d=this.dataSource.buildTabContent(b),d&&f.updateHTML(d),setTimeout(function(){f.dom.scrollTop=0},1),this.scrollBar.setSource(f),this.scrollBar.sync()),this.tabClickEvent.fire(a,f,b)}},{key:"getActiveContentBlock",value:function(){return _DomUtil8.get("tabLayer"+this.uid+"_"+this._activeId)}},{key:"enableScrollButtons",value:function(a){a&&(this.disableScrollButtons(),this._scrollButtons=a,this._scrollButtons[0].on("click",this._onScrollButtonClick,this),this._scrollButtons[1].on("click",this._onScrollButtonClick,this)),this._enableScollButtons=!0,this.tabsBlock&&this._checkScrollButtons()}},{key:"disableScrollButtons",value:function(){this._enableScollButtons=!1,this._scrollButtons&&(this._scrollButtons[0].hide().un("click",this._onScrollButtonClick,this),this._scrollButtons[1].hide().un("click",this._onScrollButtonClick,this),this._scrollButtons=null)}},{key:"_checkScrollButtons",value:function(a){void 0===a&&(a=this.tabsBlock.dom.scrollLeft),this._scrollButtons&&(a+this.tabsBlock.dom.offsetWidth<this.tabsBlock.dom.scrollWidth?this._scrollButtons[1].show():this._scrollButtons[1].hide(),a>0?this._scrollButtons[0].show():this._scrollButtons[0].hide())}},{key:"_onScrollButtonClick",value:function(a){var b=a.getTarget(!0);if(this.tabsBlock.dom.offsetWidth<this.tabsBlock.dom.scrollWidth){for(var c=this.tabsBlock.first(),d=this.tabsBlock.dom.scrollLeft,e=d,f=d+Math.ceil(this.tabsBlock.dom.offsetWidth/2);c.dom.offsetLeft<f;)c=c.next();c=c.prev()||c,e=c.dom.offsetLeft+b.dom.offsetWidth,b.hasClass("im-multitabs__leftbtn")?(e=c.dom.offsetLeft+(c.dom.offsetWidth-this.tabsBlock.dom.offsetWidth-b.dom.offsetWidth),e<=this.tabsBlock.first().dom.offsetWidth&&(e=0)):e>=this.tabsBlock.dom.scrollWidth-(this.tabsBlock.last().dom.offsetWidth+this.tabsBlock.dom.offsetWidth)&&(e=this.tabsBlock.dom.scrollWidth-this.tabsBlock.dom.offsetWidth),this._checkScrollButtons(e),_U7.animation.start(d,e,Math.abs((e-d)/150),function(a,b){this.tabsBlock.dom.scrollLeft=Math.round(a)}.bind(this))}}},{key:"_onTabsScroll",value:function(a){this._checkScrollButtons()}},{key:"_onTabsWheel",value:function(a){var b=a.browserEvent,c=b.deltaY;b.deltaX&&Math.abs(b.deltaX)>Math.abs(c)&&(c=b.deltaX);var d=b.constructor;!d||b.deltaMode!==d.DOM_DELTA_LINE&&b.deltaMode!==d.WM_MOUSEWHEEL&&b.deltaMode!==d.WM_MOUSEHWHEEL||(c*=4),0!==c&&(this.tabsBlock.dom.scrollLeft=this.tabsBlock.dom.scrollLeft+c),a.stopEvent()}},{key:"_onTabClick",value:function(a){var b=a.getTarget(!0).up("im-ui-button");b&&(this._scrollIntoView(b),this.setFocus(b.getAttribute("data-tab-index"),b.getAttribute("data-tab"),b))}},{key:"selectTab",value:function(a,b){var c;if(b&&(c=a,a=this.dataSource.getSetIndexById(a)),0>a&&(a=0,c)){var d="tabLayer"+this.uid+"_"+c,e=_DomUtil8.get(d);e&&e.remove()}var f=this.tabsBlock.childAt(a);return f&&f.dom.click(),f}},{key:"_scrollIntoView",value:function(a){var b=this.tabsBlock.dom.scrollLeft,c=0,d=parseInt(a.dom.offsetLeft),e=parseInt(this.tabsBlock.dom.offsetWidth),f=parseInt(a.dom.offsetWidth),g=12;d>=b&&b>=d-e+f||(c=b>d?d>g?d-g:d:d-e+f+g,this._checkScrollButtons(c),_U7.animation.start(b,c,Math.abs((c-b)/150),function(a,b){this.tabsBlock.dom.scrollLeft=Math.round(a)}.bind(this)))}},{key:"_onItemClick",value:function(a){var b=a.getTarget(),c=b.getAttribute("data-code");return c&&this.dataSource.itemClicked(c)!==!1?(this.itemClickEvent.fire(c,"tabLayer"+this.uid+"_"+this._activeId),a.stopEvent(),!1):void 0}},{key:"destroy",value:function(){this.tabNavigator&&(this.tabNavigator.changeEvent.removeAll(),this.tabNavigator=null),this.itemClickEvent.removeAll(),this.itemClickEvent=null,this.scrollBar&&this.scrollBar.destroy(),this.tabsBlock&&this.tabsBlock.un("click",this._onTabClick,this),this.tabsBlock&&this.tabsBlock.un("scroll",this._onTabsScroll,this),this.contentsBlock&&this.contentsBlock.un("click",this._onItemClick,this),this.disableScrollButtons()}}]),b}(_UI6.ES6Component),DataSource=function(){function a(){_classCallCheck2(this,a),this._setIds=[],this._setData={},this._setContent={},this._recentItems=[],this._initialized=!1,this._storageName="",this._itemTemplate="",this.RECENT_LIMIT=25,this.dataChangeEvent=new _U7.Event}return _createClass2(a,[{key:"init",value:function(){this._initialized||(this._initialized=!0,this.dataChangeEvent.fire())}},{key:"getSetCount",value:function(){return this._setIds.length}},{key:"getSetId",value:function(a){return this._setIds[a]}},{key:"getSetDataById",value:function(a){return this._setData[a]}},{key:"getSetIndexById",value:function(a){for(var b=0,c=this._setIds.length;c>b;b++)if(this._setIds[b]==a)return b;return-1}},{key:"buildTabContent",value:function(a){for(var b="",c=("_recent"===a?this._recentItems.length:this._setContent[a]&&this._setContent[a].length)||0,d=0;c>d;d++)b+=this._buildItemHtml(a,d);return b}},{key:"_getRecent",value:function(){var a=[];return _WA11.AccountStorage.load(this._storageName,{success:function(b){b&&(a=b.split(","))}}),a}},{key:"_addRecentTab",value:function(){this._setIds[0]&&"_recent"!==this._setIds[0]&&this._setIds.unshift("_recent")}},{key:"_saveRecent",value:function(){var a={};this._recentItems.length>this.RECENT_LIMIT&&(this._recentItems.length=this.RECENT_LIMIT),a[this._storageName]=this._recentItems.join(","),_WA11.AccountStorage.save(a)}},{key:"_addRecentItem",value:function(a){var b=this._recentItems.indexOf(a);b>-1&&this._recentItems.splice(b,1),this._recentItems.unshift(a),this._saveRecent()}},{key:"checkTabUpdated",value:function(){return!1}},{key:"itemClicked",value:function(a){}},{key:"_buildItemHtml",value:function(){return""}}]),a}(),EmojiDataSource=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a._storageName="recentEmoji",a._itemTemplate='<div class="im-tabbox__layer-item im-emo-{0}" data-code="{0}"></div>',a}return _inherits2(b,a),_createClass2(b,[{key:"init",value:function(){this._initialized||(this._setIds=_U7.Array.clone(_WA11.Emoji.getESets()),this._setContent=_WA11.Emoji.getEData(),this._recentItems=this._getRecent(),this._recentItems.length&&this._addRecentTab(),_get2(_getPrototypeOf2(b.prototype),"init",this).call(this))}},{key:"itemClicked",value:function(a){var b=!this._recentItems.length;this._addRecentItem(a),b&&(this._addRecentTab(),this.dataChangeEvent.fire())}},{key:"_buildItemHtml",value:function(a,b){var c;return c="_recent"===a?this._recentItems[b]:this._setContent[a][b],TD.parseString(this._itemTemplate,[c])}}]),b}(DataSource),StickerDataSource=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a._storageName="recentSticker",a._itemTemplate='<img src="{2}" class="im-tabbox__layer-item" data-code="{0}#{1}" /><div src="{2}" class="im-tabbox__layer-item im-img__overlay" data-code="{0}#{1}"></div>',a}return _inherits2(b,a),_createClass2(b,[{key:"init",value:function(){this._initialized||(this._updatedTabs=[],this._recentItems=this._getRecent(),this._recentItems.length&&this._addRecentTab(),this._setIds.push("_emoji"),_WA11.Sticker.packDataReadyEvent.on(this._onContentReady,this),_WA11.Sticker.packChangedEvent.on(this._onPackChangeEvent,this),_WA11.Sticker.requestContent(),_get2(_getPrototypeOf2(b.prototype),"init",this).call(this))}},{key:"_onPackChangeEvent",value:function(a){-1===this._updatedTabs.indexOf(a)&&this._updatedTabs.push(a),_WA11.Sticker.requestContent()}},{key:"_onContentReady",value:function(){this._setIds=[],this._setData={},this._setContent={};var a=_WA11.Sticker.getAltPackList(),b=[];if(_U7.Array.each(a,function(a){a.id&&a.stickers&&a.stickers.length&&(this._setIds.push(a.id),this._setData[a.id]={icon:_WA11.Sticker.getStickerPickerIconUrl(a.id,32),disabled:!1})},this),this._setIds=b.concat(this._setIds),this._setIds.unshift("_emoji"),this._recentItems.length&&this._addRecentTab(),this._setContent=_WA11.Sticker.getAllPackContent(),this._recentItems.length&&this._setContent){var c=[];_U7.Array.each(this._recentItems,function(a,b){var d=a.split("#")[0];if(this._setContent[d]){if(_WA11.Sticker.isCustomPack(d)!==!1){var e=a.split("#")[1],f=!1;_U7.Array.each(this._setContent[d],function(a){return e===a?(f=!0,!1):void 0}),f||c.push(b)}}else c.push(b)},this),c.length&&(_U7.Array.eachReverse(c,function(a){this._recentItems.splice(a,1)},this),this._saveRecent())}this.dataChangeEvent.fire()}},{key:"checkTabUpdated",value:function(a){var b=this._updatedTabs.indexOf(a);return b>-1&&(this._updatedTabs=this._updatedTabs.splice(b,1)),b>-1}},{key:"itemClicked",value:function(a){if("showcase"===a.split("#")[0])return!0;var b=!this._recentItems.length;this._addRecentItem(a),b&&(this._addRecentTab(),this.dataChangeEvent.fire())}},{key:"_buildItemHtml",value:function(a,b){var c;return"_recent"===a?(c=this._recentItems[b].split("#"),a=c[0],c=c[1]):c=this._setContent[a][b],TD.parseString(this._itemTemplate,[a,c,_WA11.Sticker.getStickerPreviewUrl(a,c,60)],{safeKeys:["2"]})}},{key:"buildTabContent",value:function(a){var c=_get2(_getPrototypeOf2(b.prototype),"buildTabContent",this).call(this,a);return this._setData[a]&&this._setData[a].disabled&&(c+=TD.parseSafe("tabBoxDownloadButton",[a])),c}}]),b}(DataSource);_UI6.AppTabBox=AppTabBox,_UI6.AppTabBox.EmojiDataSource=new EmojiDataSource,_UI6.AppTabBox.StickerDataSource=new StickerDataSource,WebIM.namespace("WebIM.ui");var _WA12=WebIM,_TD=_WA12.TemplateDriver,_UI7=_WA12.ui,_U8=_WA12.util,_DomUtil9=_WA12.DomUtil,PlainList=function(){function a(b){_classCallCheck2(this,a),this.initialConfig=b,this.updateItemsEvent=new _U8.Event,b.items&&this.load(b.items),b.noIcon&&(this.noIcon=1),b.autoRender&&this.render(b.autoRender)}return _createClass2(a,[{key:"load",value:function(a){this._items=a||[]}},{key:"updateItems",value:function(a){a&&(this._items=a),this._updateList(a)}},{key:"_updateList",value:function(a){this.el&&(this.el.updateHTML(this._buildListHtml(a)),this.updateItemsEvent.fire(a.length),this.scrollBar.sync())}},{key:"render",value:function(a){var b=_DomUtil9.get(a);this.el=b.createChild({cls:"im-plainlist "+(this.initialConfig.cls?this.initialConfig.cls:"")}),this.el.updateHTML(this._buildListHtml(this._items)),this.el.on("click",this._onClick,this),this.scrollBar=new _UI7.ScrollBar({source:this.el}),this.scrollBar.sync()}},{key:"_buildListHtml",value:function(a){var b="";return this._viewItems=[],_U8.Array.each(a,function(a,c){var d="";a.buttonIconCls?d='<button class="im-plainlist-item-button '+_U8.String.htmlEntity(a.buttonIconCls)+'"></button>':a.subtext&&(d='<span class="im-plainlist-item-sublabel">'+_U8.String.htmlEntity(a.subtext)+"</span>"),this._viewItems.push(a),b+=_TD.parseSafe(this.noIcon?"plainListItem":"plainListIconItem",[a.key||c,a.iconCls||"",_WA12.Emoji.parse(_U8.String.htmlEntity(a.text)),d,c],{safeKeys:["2","3"]})},this),b}},{key:"_onClick",value:function(a){var b=a.getTarget(!0),c=b.hasClass("im-plainlist-item-button");if(b=b.up("im-plainlist-item"),b&&this.initialConfig.cb){var d=this._viewItems&&this._viewItems[b.getAttribute("data-ind")];this.initialConfig.cb.call(this.initialConfig.scope||window,b.getAttribute("data-key"),c,d)}}},{key:"destroy",value:function(){this.scrollBar.destroy(),this.el.un("click",this._onClick,this),this.updateItemsEvent.removeAll()}}]),a}(),SearchPlainList=function(a){function b(){return _classCallCheck2(this,b),_possibleConstructorReturn2(this,_getPrototypeOf2(b).apply(this,arguments))}return _inherits2(b,a),_createClass2(b,[{key:"render",value:function(a){var c=_DomUtil9.get(a);this.searchEl=c.createChild({cls:"im-search "+(this.initialConfig.searchCls?this.initialConfig.searchCls:""),html:""}),this.searchField=new _WA12.SearchFieldSimple({cls:"im-search-field",hintText:this.initialConfig.searchTitle||null}),this.searchField.render(this.searchEl),this.searchField.onChangeEvent.on(this._onSearchChange,this),this.searchField.onCancelEvent.on(this._onSearchCancel,this),_get2(_getPrototypeOf2(b.prototype),"render",this).call(this,c)}},{key:"focus",value:function(){this.searchField.focus()}},{key:"_filterList",value:function(a){var b=a.toLowerCase(),c=_U8.KeyMapping.translate(b),d=_U8.Array.filter(this._items,function(a){var d=a.text.toLowerCase();return!(0!==d.indexOf(b)&&0!==d.indexOf(c)&&(!a.subtext||0!==a.subtext.indexOf(b)&&1!==a.subtext.indexOf(b)))},this);this._updateList(d)}},{key:"_onSearchChange",value:function(a){this._filterList(a)}},{key:"_onSearchCancel",value:function(){this._updateList(this._items)}}]),b}(PlainList);_UI7.PlainList=PlainList,_UI7.SearchPlainList=SearchPlainList,WebIM.namespace("WebIM.ui");var _WA13=WebIM,_UI8=_WA13.ui,_U9=_WA13.util,PRECHECK_VIDEO_CANPLAY=!1,MAX_PLAY_ATTEMPTS=5,PhotoPreview=function(a){function b(){return _classCallCheck2(this,b),_possibleConstructorReturn2(this,_getPrototypeOf2(b).apply(this,arguments))}return _inherits2(b,a),_createClass2(b,[{key:"initComponent",value:function(){this.initialConfig.hideOnEscape=!0,this.forwardEvent=new _U9.Event,_get2(_getPrototypeOf2(b.prototype),"initComponent",this).call(this)}},{key:"_onRender",value:function(a){this.el=a.createChild({tag:"div",cls:"im-ppreview",children:[{tag:"div",cls:"im-ppreview-img "},{tag:"div",cls:"im-ppreview-playbutt"},{tag:"div",cls:"im-ppreview-controls"}]}),this.cont=this.el.first(),this.playButton=this.cont.next(),this.playButton.on("click",this._onPlayClick,this),this.controls=this.playButton.next(),this.controls.updateHTML(_WA13.TD.getTMPL("photoPreviewControls")),this.profile=this.controls.first(),this.progress=this.profile.next(),this.getLink=this.progress.next(),this.playcontrol=this.getLink.next(),this.resendcontrol=this.playcontrol.next(),this.el.appendChild(_WA13.TD.getTMPL("CircleSpinner",!0))}},{key:"_onHide",value:function(){_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this),this.visible=!1,this.destroyVideo(),_WA13.Api.postEventToParent("hidePreview",{}),this.el.un("click",this.onClick,this)}},{key:"_onShow",value:function(){_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),this.visible=!0,_WA13.Api.postEventToParent("showPreview",{}),this.el.on("click",this.onClick,this)}},{key:"_onPlayClick",value:function(a){this.el.hasClass("im-ppreview-playbutt__visible")&&(this._hidePlayButton(),this._videoReloadTry=0,this.video&&this.video.dom.play(),a.stopPropagation())}},{key:"_showSpinner",value:function(){this.el.addClass("im-ppreview-loading"),this.progress&&this.progress.hide(),this.playcontrol&&(this.playcontrol.removeClass("im-ppreview__playcontrol-playing"),this.playcontrol.hide())}},{key:"_hideSpinner",value:function(){this.el.removeClass("im-ppreview-loading")}},{key:"_showPlayButton",value:function(){this.el.removeClass("im-ppreview-loading"),this.el.addClass("im-ppreview-playbutt__visible"),this.progress&&this.progress.hide(),this.playcontrol&&(this.playcontrol.removeClass("im-ppreview__playcontrol-playing"),this.playcontrol.hide())}},{key:"_hidePlayButton",value:function(){this.el.removeClass("im-ppreview-playbutt__visible")}},{key:"_hideControls",value:function(a){this.el.removeClass("im-ppreview-controls__visible"),a&&(this.el.removeClass("im-ppreview-playbutt__visible"),this.el.removeClass("im-ppreview-loading"),this.getLink&&this.getLink.hide(),this.profile&&this.profile.hide(),this.progress&&this.progress.hide(),this.playcontrol&&this.playcontrol.hide(),this.resendcontrol&&this.resendcontrol.hide())}},{key:"_showControls",value:function(){this.el.addClass("im-ppreview-controls__visible")}},{key:"_progressCheck",value:function(){this._progressTimer&&(clearTimeout(this._progressTimer),delete this._progressTimer);var a=this.getProgress();isNaN(a)?this._progressTimer=_WA13.setTimeout(this._progressCheck,100,this):(this._updateProgress(a),100>a&&(this._progressTimer=_WA13.setTimeout(this._progressCheck,100,this)))}},{key:"_updateProgress",value:function(a){this.progress&&this.progress.first().setStyle("left",a+"%")}},{key:"open",value:function(a,b){this.show();var c=a.mime.indexOf("video")>-1,d="image/gif"===a.mime&&a.url||a.maxPreview||a.mediumPreview;if(this.url=d,this.originalUrl=a.url||a.orig_url||a.mediumPreview,this.destroyVideo(),this._hideControls(!0),this.controlsCfg=b,c?this._renderVideo(a):d&&this._renderPhoto(d),this.cont.toggleClass("im-ppreview-img__gif",d&&"image/gif"===a.mime&&!a.url),this.controlsCfg){if(this.profile){var e=this.controlsCfg.user;if(e){var f=_WA13.Emoji.parse(_U9.String.htmlEntity(e.friendly||_WA13.CLD.getFriendlyName(e.sn)||_WA13.uinAsName(e.sn||""))),g=[f];this.controlsCfg.time&&g.push(_U9.Date.formatDate(1e3*this.controlsCfg.time).replace(/(\d\d:\d\d)/,function(a,b){return _WA13.tr("dialog.atTime",{time:b})})),this.profile.updateHTML(g.join("<br/>")),this.profile.show()}}this.getLink&&this.originalUrl&&this.getLink.setAttribute("href",_U9.String.encodeHref(this.originalUrl)).show(),this.resendcontrol&&this.controlsCfg.msg&&this.resendcontrol.show(),this.controlsCfg.canHide||this._showControls()}return c||!!d}},{key:"onClick",value:function(a){if(this.el.hasClass("im-ppreview-playbutt__visible"))return this._hidePlayButton(),void(this.video&&this.video.dom.play());var b=a.getTarget(!0),c=b.up("im-ui-button")||b.up("imButton");if(c)return this._onAction(c.getAttribute("data-action")),void a.stopPropagation();if(this.controlsCfg&&this.controlsCfg.canHide)return void(this.el.hasClass("im-ppreview-controls__visible")?this._hideControls():this._showControls());if(b.up("im-ppreview__progressbar")&&this.video){var d=b.up("im-ppreview__progressbar"),e=100*a.pageX/d.dom.offsetWidth;return void(this.video.dom.currentTime=e*this.video.dom.duration/100)}this.hide()}},{key:"_onAction",value:function(a){switch(a){case"profile":if(_WA13.boardMode)return;if(this.controlsCfg&&this.controlsCfg.user){var b=this.controlsCfg.user.sn;this.hide(),_WA13.ma.openProfile({mail:b})}break;case"close":this.hide();break;case"resend":this.controlsCfg&&this.controlsCfg.msg&&this.forwardEvent.fire(this.controlsCfg.msg);break;case"playcontrol":this.playcontrol&&this.video&&this.video.dom&&(this.videoIsPlaying&&this.playcontrol.hasClass("im-ppreview__playcontrol-playing")?(this.playcontrol.removeClass("im-ppreview__playcontrol-playing"),this.video.dom.pause(),this.videoIsPlaying=!1):(this.videoIsEnded&&(this.videoIsEnded=!1,this.video.dom.currentTime=0),this.playcontrol.addClass("im-ppreview__playcontrol-playing"),this.video.dom.play()))}}},{key:"getProgress",value:function(){return this.video&&100*this.video.dom.currentTime/this.video.dom.duration}},{key:"onVideoEnded",value:function(a){this.video&&(this.videoIsEnded=!0,this.video.dom.currentTime=0)}},{key:"onVideoCanPlay",value:function(a){if(this.video)if(this.videoIsEnded)"playing"===a.type&&(this._hidePlayButton(),this._hideSpinner(),this.video.dom.pause(),this.video.dom.currentTime=0,this.videoIsPlaying=!1),this.playcontrol&&(this.playcontrol.removeClass("im-ppreview__playcontrol-playing"),this.playcontrol.show());else{if("canplay"===a.type)return this._waitingTimer&&clearTimeout(this._waitingTimer),void(this._waitingTimer=_WA13.setTimeout(function(){this._waitingTimer=null;var a=this.video.dom.play();a&&"function"==typeof a["catch"]?a["catch"](function(){this._showPlayButton()}.bind(this)):this._showPlayButton()},2e3,this));this._waitingTimer&&(clearTimeout(this._waitingTimer),this._waitingTimer=null),this._hidePlayButton(),this._hideSpinner(),this.videoIsPlaying&&"number"==typeof this.videoIsPlaying&&(this.video.dom.currentTime=this.videoIsPlaying),this.videoIsPlaying=!0,this._progressCheck(),this.progress&&this.progress.show(),this.playcontrol&&(this.playcontrol.addClass("im-ppreview__playcontrol-playing"),this.playcontrol.show())}}},{key:"onVideoIsWaiting",value:function(a){var b={error:1,waiting:1,stalled:1};this._waitingTimer&&clearTimeout(this._waitingTimer),this._waitingTimer=null,!this.video||!b[a.type]&&this.video.dom.readyState?"waiting"===a.type&&this._showSpinner():(this._showSpinner(),this._waitingTimer&&clearTimeout(this._waitingTimer),"error"===a.type?(this._waitingTimer=null,this._reloadVideo(!0)):this._waitingTimer=_WA13.setTimeout(this._reloadVideo,5e3,this))}},{key:"_reloadVideo",value:function(a){this._waitingTimer=null,this.video&&(this.videoIsPlaying&&(this.videoIsPlaying="number"==typeof this.videoIsPlaying&&this.videoIsPlaying||this.video.dom.currentTime),a&&this._videoReloadTry++,this._videoReloadTry>=MAX_PLAY_ATTEMPTS?(this.hide(),_WA13.showPopup(_WA13.tr("file.errorVideoCantPlay"),2e3)):this.video.dom.load())}},{key:"_renderPhoto",value:function(a){this.cont.updateText("").setStyle("background-image","none").setStyle("background-image","url("+a.replace(/(['"()])/g,"\\$1")+")")}},{key:"_renderVideo",value:function(a){var b=a.url,c=a.maxPreview;this.video=this.cont.setStyle("background-image","none").createChild({tag:"video",draggable:"false",unselectable:"on",poster:c,autoplay:"autoplay",children:[{tag:"source",src:b}]});var d=this.video.dom.canPlayType(a.mime).toLowerCase();return PRECHECK_VIDEO_CANPLAY&&"maybe"!=d&&"probably"!=d?(this.hide(),void _WA13.showPopup(_WA13.tr("file.errorVideoCantPlay"),2e3)):(this.videoIsEnded=!1,this.videoIsPlaying=!1,this._videoReloadTry=0,this.video.on(["canplay","playing"],this.onVideoCanPlay,this),this.video.on("ended",this.onVideoEnded,this),this.video.on(["error","waiting","suspend","stalled","loadeddata","loadedmetadata","loadstart","progress"],this.onVideoIsWaiting,this),void this.video.last().on("error",this.onVideoIsWaiting,this))}},{key:"destroyVideo",value:function(){this.video&&(this._progressTimer&&(clearTimeout(this._progressTimer),delete this._progressTimer),this.video.un(["canplay","playing"],this.onVideoCanPlay,this),this.video.un("ended",this.onVideoEnded,this),this.video.last().un("error",this.onVideoIsWaiting,this),this.video.un(["error","waiting","suspend","stalled","loadeddata","loadedmetadata","loadstart","progress"],this.onVideoIsWaiting,this),this._waitingTimer&&(clearTimeout(this._waitingTimer),this._waitingTimer=null),this.video.remove(),delete this.video)}},{key:"destroy",value:function(){this.rendered&&this.el.un("click",this.onClick,this),this.destroyVideo(),this.forwardEvent.removeAll(),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI8.ES6Component);_UI8.PhotoPreview=PhotoPreview,function(){var a=WebIM,b=(a.util,a.ui),c=function(b){function c(){var b,d;_classCallCheck2(this,c);for(var e=arguments.length,f=new Array(e),g=0;e>g;g++)f[g]=arguments[g];return d=_possibleConstructorReturn2(this,(b=_getPrototypeOf2(c)).call.apply(b,[this].concat(f))),d.currentIndexDiff=0,d.currentGalleryIndex=0,d._canPrev=d._canNext=!1,d._waitForFileInfo=!1,d._waitForGalleryInfo=!1,d.sn=!1,d.galleryData=null,d.galleryItems=null,a.gallery.updateEvent.on(d._onGalleryUpdate,_assertThisInitialized2(_assertThisInitialized2(d))),a.snippet.loadEvent.on(d._showFile,_assertThisInitialized2(_assertThisInitialized2(d))),a.fileTools.loadEvent.on(d._showFile,_assertThisInitialized2(_assertThisInitialized2(d))),d}return _inherits2(c,b),_createClass2(c,[{key:"open",value:function(b,d,e){if(this.currentIndexDiff=0,this.currentGalleryIndex=0,this._waitForFileInfo=!1,this._waitForGalleryInfo=!1,this.galleryData=null,this.sn=!1,d&&d.mid&&d.url&&d.sn){var f=d.mid,g=d.url,h=d.sn,i=d.typeKey,j=d.item;this.sn=h,this.galleryItems=[j||{url:g,id:{mid:f,seq:0}}],this._waitForGalleryInfo=d;var k=i&&i.split(",")||["image","video"];if(this.galleryData=a.gallery.getFromMessage(h,f,g,50,50,k),this.galleryData&&(this._waitForGalleryInfo=!1),j&&j.author){var l=j.author,m=l.friendly,n=l.firstName,o=l.lastName,p=l.sn;e.user={sn:p,friendly:m||"".concat(n," ").concat(o)},e.time=j.time}}var q=_get2(_getPrototypeOf2(c.prototype),"open",this).call(this,b,e);return this.galleryData&&this.updateControls(),
this.checkControls(),q}},{key:"updateControls",value:function(){if(this.galleryData&&this.galleryItems){var a=!this.galleryItems[this.currentGalleryIndex+this.currentIndexDiff];this.currentGalleryIndex=this.galleryData.currentIndex,this.galleryItems=this.galleryData.items,this.checkControls(),a&&(this._resetView(),this.galleryItems[this.currentGalleryIndex+this.currentIndexDiff]&&this.showFile(this.galleryItems[this.currentGalleryIndex+this.currentIndexDiff].url))}}},{key:"checkControls",value:function(){var a=this.galleryData;if(a&&this.currentGalleryIndex>-1){var b=this.currentGalleryIndex+this.currentIndexDiff;this.togglePrevControl(b>0||!a.endIsReached),this.toggleNextControl(b<a.items.length-1||!a.startIsReached)}else this.togglePrevControl(!1),this.toggleNextControl(!1)}},{key:"togglePrevControl",value:function(a){this._canPrev=a,a?this.prevControl.show():this.prevControl.hide()}},{key:"toggleNextControl",value:function(a){this._canNext=a,a?this.nextControl.show():this.nextControl.hide()}},{key:"switchToNextItem",value:function(){if(this._canNext){var a=this.galleryData;if(a){this.currentIndexDiff++,this._resetView(),this.checkControls();var b=this.currentGalleryIndex+this.currentIndexDiff;a.items[b]&&(this.showFile(a.items[b].url,!0),a.items[b+1]||a.startIsReached||this._requestNewPack(!0))}}}},{key:"switchToPrevItem",value:function(){if(this._canPrev){var a=this.galleryData;if(a){a.currentIndex,a.items;this.currentIndexDiff--,this._resetView(),this.checkControls();var b=this.currentGalleryIndex+this.currentIndexDiff;a.items[b]&&(this.showFile(a.items[b].url,!1),a.items[b-1]||a.endIsReached||this._requestNewPack())}}}},{key:"showFile",value:function(a,b){this._waitForFileInfo={url:a,isNext:b},this._showFile()}},{key:"_onRender",value:function(){for(var a,b=arguments.length,d=new Array(b),e=0;b>e;e++)d[e]=arguments[e];(a=_get2(_getPrototypeOf2(c.prototype),"_onRender",this)).call.apply(a,[this].concat(d)),this.prevControl=this.el.createChild({cls:"im-gpreview-prev imButton","data-action":"previous"}),this.nextControl=this.el.createChild({cls:"im-gpreview-next imButton","data-action":"next"})}},{key:"_onAction",value:function(a){switch(a){case"previous":this.switchToPrevItem();break;case"next":this.switchToNextItem();break;default:_get2(_getPrototypeOf2(c.prototype),"_onAction",this).call(this,a)}}},{key:"_onSwapEnd",value:function(a){var b=a.browserEvent;Math.abs(b.deltaX)>this.el.dom.offsetWidth/4&&(b.deltaX>0?this.switchToNextItem():this.switchToPrevItem())}},{key:"_onShow",value:function(){_get2(_getPrototypeOf2(c.prototype),"_onShow",this).call(this),this.el.on("swap:end",this._onSwapEnd,this)}},{key:"_onHide",value:function(){this.el.un("swap:end",this._onSwapEnd,this),_get2(_getPrototypeOf2(c.prototype),"_onHide",this).call(this)}},{key:"_skipCurrent",value:function(a){var b=this.currentGalleryIndex+this.currentIndexDiff;a?this._waitForGalleryInfo?this.switchToNextItem():(this.galleryItems.splice(b,1),this.currentGalleryIndex>=b?this.currentGalleryIndex--:this.currentIndexDiff--,this._canNext||this.currentIndexDiff--,this.switchToNextItem()):this._waitForGalleryInfo?this.switchToPrevItem():(this.galleryItems.splice(b,1),this.currentGalleryIndex>=b?(this.currentGalleryIndex--,this.currentIndexDiff+=2):this.currentIndexDiff++,this._canPrev||this.currentIndexDiff++,this.switchToPrevItem())}},{key:"_showFile",value:function(){var b=this._waitForFileInfo||{},d=b.url,e=b.isNext;if(d){var f,g=a.fileTools.resolveLinkAsFile(d);if(g)f=a.fileTools.requestFileInfo(g,d);else{var h=a.snippet.getContentType(d),i=a.snippet.getPreviewUrl(d);i&&(f=a.fileTools.emulateFileObjForPreview(i,"image/"+h,d))}if(f){if(this._waitForFileInfo=!1,this.galleryItems&&this.sn){var j=this.currentGalleryIndex+this.currentIndexDiff,k=this.galleryItems[j],l=k.author,m=l.friendly,n=l.firstName,o=l.lastName,p=l.sn;this.controlsCfg.user={sn:p,friendly:m||"".concat(n," ").concat(o)},this.controlsCfg.time=k.time}_get2(_getPrototypeOf2(c.prototype),"open",this).call(this,f,this.controlsCfg)||this._skipCurrent(e)}else this._resetView(),this._waitForFileInfo={url:d,isNext:e}}}},{key:"_onGalleryUpdate",value:function(b){if(this._waitForGalleryInfo&&this._waitForGalleryInfo.sn===b&&this.isVisible()){var c=this._waitForGalleryInfo,d=c.sn,e=c.mid,f=c.url,g=c.typeKey,h=g&&g.split(",")||["image","video"],i=a.gallery.getFromMessage(d,e,f,20,20,h);i&&(this.galleryData=i,this._waitForGalleryInfo=!1,this.updateControls())}}},{key:"_resetView",value:function(){this.el&&(this.destroyVideo(),this._hideControls(!0),this.cont.updateText("").setStyle("background-image","none"),this._showSpinner(),this._waitForFileInfo=!1)}},{key:"_requestNewPack",value:function(b){var c=this.currentGalleryIndex+this.currentIndexDiff;if(this.galleryData&&this.galleryData.items[c]&&this.sn){var d=this.galleryData.items[c],e={mid:d.id.mid,url:d.url,sn:this.sn},f=e.mid,g=e.url,h=e.sn,i=e.typeKey;this.currentGalleryIndex=c,this.currentIndexDiff=0,this._waitForGalleryInfo=e;var j=b?50:0,k=b?0:50,l=i&&i.split(",")||["image","video"],m=a.gallery.getFromMessage(h,f,g,j,k,l);m&&(this.galleryData=m,this._waitForGalleryInfo=!1,this.updateControls())}}},{key:"destroy",value:function(){this.rendered&&this.el.un("swap:end",this._onSwapEnd,this),_get2(_getPrototypeOf2(c.prototype),"destroy",this).call(this)}}]),c}(b.PhotoPreview);b.GalleryPreview=c}(),WebIM.namespace("WebIM.ui");var _WA14=WebIM,_UI9=_WA14.ui,_U10=_WA14.util,_TD2=_WA14.TemplateDriver,_DomUtil10=_WA14.DomUtil,FIELD_MIN_LENGTH=5,FIELD_MAX_LENGTH=30,CHECK_TIMEOUT=1e3,_stopEvent2=function(a){a.stopPropagation()},EditNickModule=function(a){function b(a){var c;_classCallCheck2(this,b);var d={defaultValue:"",takenNickMessage:_WA14.tr("nickBox.takenNick"),freeNickMessage:_WA14.tr("nickBox.freeNick"),focusFieldOnRender:!0,linkExplanation:_WA14.tr("nickBox.linkDescription",{product:_WA14.PRODUCT_TITLE}),buildLink:function(a){return _WA14.urlBuilder.profileLink(a)},changeStateCallback:function(){}};return a=_WA14.applyIf(a||{},d),a.template||(a.template=_WA14.TD.getTMPL("editProfileNick")),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a)),c._overMinChars=!1,c._currentSubtitle="",c._stateMap={applyRepeat:0,applyDisabled:1},c._state=[0,0],c._stateString="00",c}return _inherits2(b,a),_createClass2(b,[{key:"_getStateString",value:function(){return this._state.join("")}},{key:"_makeState",value:function(){var a=this,b={};return Object.keys(this._stateMap).forEach(function(c){b[c]=a._state[a._stateMap[c]]}),b}},{key:"setState",value:function(a){var b=this;Object.keys(this._stateMap).forEach(function(c){c in a&&(b._state[b._stateMap[c]]=a[c]?1:0)}),this._stateString=this._getStateString()}},{key:"_sendStateIfChanged",value:function(){var a=this._getStateString();this._stateString!==a&&(this._stateString=a,this.initialConfig.changeStateCallback(this._makeState()))}},{key:"_onRender",value:function(a,b){b?this.el=_DomUtil10.get(b):this.el=a.createChild({html:_TD2.parseString(this.initialConfig.template,{spinner:_WA14.TD.getTMPL("CircleSpinner"),linkExplanation:this.initialConfig.linkExplanation},{safeKeys:["spinner"]})}),this.field=this.el.getSelector(".imField"),this.subTitle=this.el.getSelector(".imFieldSubinfo"),this.counter=this.el.getSelector(".imFieldCounter"),this.example=this.el.getSelector(".imNickExample"),this.link=this.el.getSelector(".imNickLink"),this.linkExample=this.el.getSelector(".imNickLinkExample"),this.block=this.el,this.setDefaultValue(this.initialConfig.defaultValue),this.el.on("click",this._onClick,this),this.initialConfig.focusFieldOnRender&&this.field.dom.focus()}},{key:"_updateRemainingCharacters",value:function(){var a=FIELD_MAX_LENGTH-this.field.dom.value.length;this.counter.updateText(a).toggleClass("im-counter-error",0>a)}},{key:"_updateExample",value:function(a){var b=_U10.String.htmlEntity(this.field.dom.value||"");b?(this.example.updateHTML("@"+b),a?this.example.setAttribute("data-action","copyNick"):this.example.dom.hasAttribute("data-action")&&this.example.removeAttribute("data-action")):this.example.updateText("")}},{key:"_updateSubtitle",value:function(a){a!==this._currentSubtitle&&(this._currentSubtitle=a,this.subTitle.updateHTML(a))}},{key:"_updateLink",value:function(a,b){var c=this.field.dom.value;a&&c?(this.link.updateHTML(_U10.String.encodeHref(this.initialConfig.buildLink(c))),this.linkExample&&this.linkExample.show(),b?this.link.setAttribute("data-action","copyLink"):this.link.dom.hasAttribute("data-action")&&this.link.removeAttribute("data-action")):(this.link.updateText(""),this.linkExample&&this.linkExample.hide())}},{key:"_onClick",value:function(a){var b=a.getTarget(!0),c=b.up("imButton"),d=c&&c.getAttribute("data-action"),e=this.field.dom.value||"";switch(d){case"repeatCheck":this.checkValue(),a.stopEvent();break;case"copyNick":_U10.Selection.copy2clipboard("@"+e),_WA14.showPopup(_WA14.tr("msgNickCopied")),a.stopEvent();break;case"copyLink":_U10.Selection.copy2clipboard(this.initialConfig.buildLink(e)),_WA14.showPopup(_WA14.tr("msgLinkCopied")),a.stopEvent();break;case"closeLoadingScreen":this.block.removeClass("im-nick-box_loading"),a.stopEvent()}}},{key:"_onFieldInput",value:function(){var a=this.field.dom.value,b=!1,c=!1,d=_WA14.tr("nickBox.minLength",[FIELD_MIN_LENGTH]);clearTimeout(this._checkTimer),this._checkTimer=null,this._state[this._stateMap.applyRepeat]&&(this._state[this._stateMap.applyRepeat]=0,c=!0),""===a?(this._overMinChars=!1,this._state[this._stateMap.applyDisabled]=0,c=!0):a.match(/^[a-zA-Z0-9\._]+$/)?a.match(/^[^a-zA-Z]/)?(b=!0,d=_WA14.tr("nickBox.wrongFirstChar")):a.length<FIELD_MIN_LENGTH?this._overMinChars&&(b=!0):(this._overMinChars=!0,a.length>FIELD_MAX_LENGTH?(b=!0,d=_WA14.tr("nickBox.maxLength",[FIELD_MAX_LENGTH])):(d=_WA14.TD.getTMPL("CircleSpinner")+_WA14.tr("nickBox.check")+"...",this.checking||(this._checkTimer=_WA14.setTimeout(this.checkValue,CHECK_TIMEOUT,this)))):(b=!0,d=_WA14.tr("nickBox.wrongChar")),!this._state[this._stateMap.applyDisabled]&&a&&(this._state[this._stateMap.applyDisabled]=1,c=!0),this.block.toggleClass("im-nick-box_error",b),this._updateSubtitle(d),this._updateRemainingCharacters(),this._updateExample(),this._updateLink(!1),c&&(this._stateString=this._getStateString(),this.initialConfig.changeStateCallback(this._makeState()))}},{key:"getValue",value:function(){var a=this.field.dom.value||"";return{value:a,notChanged:a===this.initialConfig.defaultValue}}},{key:"showLoading",value:function(){this._state[this._stateMap.applyDisabled]=1,this.field.setAttribute("disabled",!0),this.block.addClass("im-nick-box_loading"),this._sendStateIfChanged()}},{key:"hideLoading",value:function(){this._state[this._stateMap.applyDisabled]=0,this.field.removeAttribute("disabled"),this.block.removeClass("im-nick-box_loading"),this._sendStateIfChanged()}},{key:"checkValue",value:function(){if(this._checkTimer=null,this.block&&this.field){var a=this.field.dom.value;a&&(this.checking=!0,this.block.removeClass("im-nick-box_error"),this._updateSubtitle(_WA14.TD.getTMPL("CircleSpinner")+_WA14.tr("nickBox.check")+"..."),this.initialConfig.checkValueCallback?this.initialConfig.checkValueCallback(a):this.onCheck(a,!0))}}},{key:"onCheck",value:function(a,b,c){this.checking=!1,this.el&&this.field&&this.block&&(a===this.field.dom.value?(this.field.removeAttribute("disabled"),b?(this._state[this._stateMap.applyDisabled]=0,this.block.removeClass("im-nick-box_error"),this._updateSubtitle(_TD2.parseSafe("nickBoxSuccessMessage",{message:this.initialConfig.freeNickMessage})),this._updateLink(!0)):(this._state[this._stateMap.applyDisabled]=1,this.block.addClass("im-nick-box_error"),c?this._updateSubtitle(_WA14.tr("nickBox.serverError")+"&nbsp;"+_WA14.TD.getTMPL("nickBoxRepeatCheck")):this._updateSubtitle(this.initialConfig.takenNickMessage)),this.block.removeClass("im-nick-box_loading"),this._sendStateIfChanged()):this._onFieldInput())}},{key:"showCheckErrorMessage",value:function(a){this.checking=!1,this.el&&this.field&&this.block&&(this.field.removeAttribute("disabled"),this._state[this._stateMap.applyDisabled]=1,this.block.addClass("im-nick-box_error"),this._updateSubtitle(_U10.String.htmlEntity(a)||this.initialConfig.takenNickMessage),this._updateLink(!1),this.block.removeClass("im-nick-box_loading"),this._sendStateIfChanged())}},{key:"showApplyError",value:function(){this.checking=!1,this.el&&this.field&&this.block&&(this.field.removeAttribute("disabled"),this.block.addClass("im-nick-box_error"),this._updateSubtitle(_WA14.tr("nickBox.serverError")),this.block.removeClass("im-nick-box_loading"),this._state[this._stateMap.applyRepeat]=1,this._state[this._stateMap.applyDisabled]=0,this._sendStateIfChanged())}},{key:"setDefaultValue",value:function(a){a=a||"",this.initialConfig.defaultValue=a,this.field.un("input",this._onFieldInput,this),this.field.un("change",_stopEvent2),this.field.dom.value=_U10.String.htmlEntity(a),this.field.on("input",this._onFieldInput,this),this.field.on("change",_stopEvent2),this.field.removeAttribute("disabled"),this._overMinChars=a.length>FIELD_MIN_LENGTH,this._state[this._stateMap.applyRepeat]=0,this._state[this._stateMap.applyDisabled]=a?0:1,this.checking=!1,this._updateSubtitle(a?"":_WA14.tr("nickBox.minLength",[FIELD_MIN_LENGTH])),this._updateRemainingCharacters(),this._updateExample(!0),this._updateLink(!0,!0),this.block.removeClass("im-nick-box_loading"),this.block.removeClass("im-nick-box_error"),this._sendStateIfChanged()}},{key:"destroy",value:function(){this.field.un("input",this._onFieldInput,this),this.field.un("change",_stopEvent2),this.el.un("click",this._onClick,this),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI9.ES6Component);_UI9.EditNickModule=EditNickModule,WebIM.namespace("WebIM.ui");var _WA15=WebIM,_TD3=_WA15.TemplateDriver,_UI10=_WA15.ui,_U11=_WA15.util,ConfirmModalBox=function(a){function b(){var a,c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck2(this,b);var d={blockCls:"im-box-confirm",buttons:[{action:"cancel",text:_WA15.tr("box.cancel")},{action:"ok",text:_WA15.tr("box.ok_yes"),cls:"im-button_highlight"}]};return _WA15.applyIf(c,d),c.cls&&(c.blockCls=c.cls,delete c.cls),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,c)),a.actionEvent=new _U11.Event,a}return _inherits2(b,a),_createClass2(b,[{key:"_getContentHtml",value:function(){var a="";return(this.initialConfig.buttons||[]).forEach(function(b){b&&(a+=_TD3.parseSafe("button",b))}),_TD3.parseSafe("confirmModalBox",{title:this.initialConfig.title||"",content:this.initialConfig.content||"",buttons:a},{safeKeys:["title","content","buttons"]})}},{key:"_updateTitle",value:function(a){this.block.getSelector(".im-modal-box__title").updateText(a)}},{key:"_onClick",value:function(a){var b=a.up("imButton"),c=b&&b.getAttribute("data-action");this.initialConfig.onOk&&"ok"===c&&this.initialConfig.onOk(),c&&(this.actionEvent&&this.actionEvent.fire(c),this.hide())}},{key:"_onShow",value:function(){this.el&&(this.block.dom.scrollTop=0,_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this))}},{key:"destroy",value:function(){this.actionEvent.removeAll(),this.actionEvent=null,_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI10.ModalComponent);_UI10.ConfirmModalBox=ConfirmModalBox,_UI10.confirmAction=function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise(function(c){var d=new _UI10.ConfirmModalBox({title:b.title||"",content:a,onOk:c,buttons:[{action:"cancel",text:_WA15.tr("box.cancel")},{action:"ok",text:b.okButton||_WA15.tr("box.ok_yes"),cls:"im-button_highlight "+(b.okButtonCls||"")}]});d.show()})},_UI10.showConfirmBox=function(){for(var a=arguments.length,b=new Array(a),c=0;a>c;c++)b[c]=arguments[c];2===b.length&&_WA15.isFunction(b[1])&&b.unshift(null);var d=b[0],e=b[1],f=b[2],g=new _UI10.ConfirmModalBox({title:d,content:e,onOk:f});return g.show(),g},_UI10.showAlertBox=function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:_WA15.tr("box.ok"),d=new _UI10.ConfirmModalBox({title:b,content:a,buttons:[{action:"ok",text:c,cls:"im-button_highlight"}]});return d.show(),d},WebIM.namespace("WebIM.ui");var _WA16=WebIM,_TD4=_WA16.TemplateDriver,_UI11=_WA16.ui,_U12=_WA16.util,FORM_TYPES=["text","gender"],GENDER_OPTIONS=[{value:"1",title:"sex.m"},{value:"2",title:"sex.f"},{value:"0",title:"notSpecified"}],EditModalBox=function(a){function b(a){_classCallCheck2(this,b);var c={formType:"text",defaultValue:"",denyEmptyValue:!1,blockCls:"im-box-editform",buttons:[{action:"cancel",text:_WA16.tr("box.cancel")},{action:"ok",text:a.okButton||_WA16.tr("box.save"),cls:"im-button_highlight"}]};if(a=_WA16.applyIf(a||{},c),-1===FORM_TYPES.indexOf(a.formType))throw new TypeError("Unknown form type: "+a.formType);return _possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a))}return _inherits2(b,a),_createClass2(b,[{key:"_getContentHtml",value:function(){var a="";switch(this.initialConfig.formType){case"text":a=_TD4.parseSafe("editFieldText",{defaultValue:this.initialConfig.defaultValue}),this.initialConfig.explain&&(a="<div>"+_U12.String.htmlEntity(this.initialConfig.explain)+"</div><br/>"+a);break;case"gender":GENDER_OPTIONS.forEach(function(b){a+=_TD4.parseSafe("editFieldRadio",{title:_WA16.tr(b.title),value:b.value})})}return this.initialConfig.content=a,_get2(_getPrototypeOf2(b.prototype),"_getContentHtml",this).call(this)}},{key:"_onClick",value:function(a){var c,d,e=a.up("imButton"),f=e&&e.getAttribute("data-action");if(this.initialConfig.onEditOk&&"ok"===f){if(c=this.block.getSelector("input:checked"),c||(c=this.block.getSelector("input")),d=_U12.String.trim(c.dom.value),!d&&this.initialConfig.denyEmptyValue&&"text"===this.initialConfig.formType)return void c.dom.focus();this.initialConfig.onEditOk(d)}_get2(_getPrototypeOf2(b.prototype),"_onClick",this).call(this,a)}},{key:"_onShow",value:function(){if(this.el){var a;"gender"===this.initialConfig.formType?(a=this.block.getSelector('input[value="'+(this.initialConfig.defaultValue||0)+'"]').dom,a.checked=!0,a.setAttribute("checked",!0)):(a=this.block.getSelector("input"),this.txtField=a,a.dom.select(),a.dom.focus(),a.on("input",this._checkEmptyValue,this),this._checkEmptyValue()),_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this)}}},{key:"_checkEmptyValue",value:function(){if(this.initialConfig.denyEmptyValue&&this.txtField){var a=_U12.String.trim(this.txtField.dom.value);this.block.getSelector("button[data-action=ok]").setDisabled(!a)}}},{key:"destroy",value:function(){this.txtField&&this.txtField.un("input",this._checkEmptyValue,this),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI11.ConfirmModalBox);_UI11.EditModalBox=EditModalBox,WebIM.namespace("WebIM.ui");var _WA17=WebIM,_UI12=_WA17.ui,_U13=_WA17.util,_TD5=_WA17.TemplateDriver,EditNamesBox=function(a){function b(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck2(this,b);var c=_TD5.parseSafe("editProfileField",{idx:0,val:"",placeholder:_WA17.tr("profile.firstname")})+_TD5.parseSafe("editProfileField",{idx:1,val:"",placeholder:_WA17.tr("profile.lastnameNotRequired")}),d={title:_WA17.tr("profile.editName"),content:c,blockCls:"im-box-names",buttons:[{action:"cancel",text:_WA17.tr("box.cancel")},{action:"ok",text:_WA17.tr("box.apply"),cls:"im-button_highlight"}],hideOnAction:!0};return _WA17.applyIf(a,d),_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a))}return _inherits2(b,a),_createClass2(b,[{key:"_setValues",value:function(a){this.rendered&&(this.block.getSelector(".imField1").dom.value=a.lastname||"",this.nameInput=this.block.getSelector(".imField0"),this.nameInput.dom.value=a.firstname||"",this.nameInput.dom.select(),this.nameInput.dom.focus(),this._validateField())}},{key:"_checkName",value:function(){return(this.nameInput.dom.value||"").match(/\S/)}},{key:"_validateField",value:function(){this.block.toggleClass("im-box-names_disabled",!this._checkName())}},{key:"show",value:function(a){_get2(_getPrototypeOf2(b.prototype),"show",this).call(this),a&&this._setValues(a)}},{key:"_onShow",value:function(){this.el&&(_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),this.nameInput=this.block.getSelector(".imField0"),this.nameInput.on("input",this._validateField,this))}},{key:"_onHide",value:function(){this.nameInput.un("input",this._validateField,this),_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this)}},{key:"_onClick",value:function(a){var b,c=a.up("imButton"),d=c&&c.getAttribute("data-action");if(d){if("ok"===d){if(!this._checkName())return void this.nameInput.dom.focus();b={firstname:_U13.String.trim(this.nameInput.dom.value),lastname:_U13.String.trim(this.block.getSelector(".imField1").dom.value)}}this.actionEvent.fire(d,b),this.isVisible()&&this.initialConfig.hideOnAction&&this.hide()}}}]),b}(_UI12.ConfirmModalBox);_UI12.EditNamesBox=EditNamesBox,WebIM.namespace("WebIM.ui");var _WA18=WebIM,_UI13=_WA18.ui,_U14=_WA18.util,_FIELD_MAX_LENGTH=120,EditAboutBox=function(a){function b(a){var c;_classCallCheck2(this,b);var d={title:_WA18.tr("profile.editAboutMe"),defaultValue:"",blockCls:"im-box-about",buttons:[{action:"cancel",text:_WA18.tr("box.cancel")},{action:"ok",text:_WA18.tr("box.apply"),cls:"im-button_highlight"}]};return a=_WA18.applyIf(a||{},d),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a)),c.field=new _UI13.SmilesTextField({placeholder:_WA18.tr("profile.aboutMe"),maxLength:_FIELD_MAX_LENGTH}),c}return _inherits2(b,a),_createClass2(b,[{key:"_getContentHtml",value:function(){return this.initialConfig.content=_WA18.TD.getTMPL("editProfileRichField"),_get2(_getPrototypeOf2(b.prototype),"_getContentHtml",this).call(this)}},{key:"_onClick",value:function(a){var c=a.up("imButton"),d=c&&c.getAttribute("data-action");if(this.initialConfig.onEditOk&&"ok"===d){if(!this._checkField())return void this.field.focus();this.initialConfig.onEditOk(_U14.String.trim(this.field.textVal()))}_get2(_getPrototypeOf2(b.prototype),"_onClick",this).call(this,a)}},{key:"_checkField",value:function(){return this.field.textVal().length<=_FIELD_MAX_LENGTH}},{key:"_onFieldInput",value:function(){this.block.toggleClass("im-box-about_disabled",!this._checkField()),this._updateSubtitle()}},{key:"_updateSubtitle",value:function(){var a=this._checkField()?_WA18.tr("profile.infoAboutMe"):_WA18.tr("profile.maxLengthInfo",{n:_FIELD_MAX_LENGTH}),b=_FIELD_MAX_LENGTH-this.field.textVal().length;this.block.getSelector(".imFieldSubinfo").updateHTML("<span>"+b+"</span><span>"+a+"</span>")}},{key:"_onShow",value:function(){this.el&&(_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),this.field.renderBind(this.block.getSelector(".imField")),this.field.textVal(this.initialConfig.defaultValue),this.field.changeEvent.on(this._onFieldInput,this),this.field.focus(!0),this._updateSubtitle())}},{key:"_onHide",value:function(){this.field.changeEvent.un(this._onFieldInput,this),this.field.renderUnbind(),_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this)}},{key:"destroy",value:function(){_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI13.ConfirmModalBox);_UI13.EditAboutBox=EditAboutBox,WebIM.namespace("WebIM.ui");var _WA19=WebIM,_TD6=_WA19.TemplateDriver,_UI14=_WA19.ui,EditNickBox=function(a){function b(){var a,c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck2(this,b);var d=_WA19.tr("box.apply"),e={title:_WA19.tr("profile.nickname"),defaultValue:"",blockCls:"im-box-nick",buttons:[{action:"cancel",text:_WA19.tr("box.cancel")},{action:"ok",text:d,cls:"im-button_highlight"}]};return _WA19.applyIf(c,e),c.content=_TD6.parseSafe("editProfileNick",{spinner:_WA19.TD.getTMPL("CircleSpinner"),linkExplanation:_WA19.tr("nickBox.linkDescription",{product:_WA19.PRODUCT_TITLE})},{safeKeys:["spinner"]}),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,c)),a._defaultButtonTitle=d,a}return _inherits2(b,a),_createClass2(b,[{key:"_onClick",value:function(a){var b=a.up("imButton"),c=b&&b.getAttribute("data-action"),d=this.nickEditor&&this.nickEditor.getValue(),e=d&&d.value;"ok"===c&&(!d||d.notChanged?c="cancel":(this.nickEditor&&this.nickEditor.showLoading(),this.initialConfig.onOk&&this.initialConfig.onOk(e))),c&&(this.actionEvent&&this.actionEvent.fire(c,e),"cancel"===c&&this.hide())}},{key:"onCheck",value:function(a,b,c){this.nickEditor&&this.nickEditor.onCheck(a,b,c)}},{key:"showCheckErrorMessage",value:function(a){this.nickEditor&&this.nickEditor.showCheckErrorMessage(a)}},{key:"showApplyError",value:function(){this.nickEditor&&this.nickEditor.showApplyError()}},{key:"_onShow",value:function(){var a=this;this.el&&(_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),this.applyButton=this.block.getSelector(".im-button_highlight"),this.nickEditor=new _UI14.EditNickModule({defaultValue:this.initialConfig.defaultValue,changeStateCallback:function(b){a.applyButton&&(a.applyButton.updateText(b.applyRepeat?_WA19.tr("nickBox.repeat"):a._defaultButtonTitle),a.applyButton.setDisabled(!!b.applyDisabled))},checkValueCallback:this.initialConfig.checkValueCallback}),this.nickEditor.render(this.block.parent(),this.block),this.nickEditor.setDefaultValue(this.initialConfig.defaultValue||""),this.nickEditor.field.dom.focus())}},{key:"_onHide",value:function(){this.nickEditor&&this.nickEditor.destroy(),this.nickEditor=null,_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this)}},{key:"destroy",value:function(){this.nickEditor&&this.nickEditor.destroy(),this.nickEditor=null,_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI14.ConfirmModalBox);_UI14.EditNickBox=EditNickBox,WebIM.namespace("WebIM.ui");var _WA20=WebIM,_TD7=_WA20.TemplateDriver,_UI15=_WA20.ui,_U15=_WA20.util,BAN_OPTIONS=[{value:"block",title:"contact.block.blockContact"},{value:"",title:"contact.block.reportSpamAndBlock"}],SPAM_OPTIONS=[{value:"spam",title:"contact.report.spam"},{value:"porno",title:"contact.report.porn"},{value:"violation",title:"contact.report.violation"},{value:"other",title:"contact.report.other"}],BanModalBox=function(a){function b(a){var c;return _classCallCheck2(this,b),a=_WA20.applyIf(a,{title:_WA20.tr("contact.block.block"),blockCls:"im-box-banuser",buttons:[{action:"cancel",text:_WA20.tr("box.cancel")},{action:"ok",text:_WA20.tr("box.ok_yes"),cls:"im-button_highlight"}]}),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a)),c.nick=a.nick,c.spamMode=!!a.spamOnly,c}return _inherits2(b,a),_createClass2(b,[{key:"_getContentHtml",value:function(){var a=_TD7.parseSafe("banUserSubtitle",{nick:this.nick});return(this.spamMode?SPAM_OPTIONS:BAN_OPTIONS).forEach(function(b,c){a+=_TD7.parseSafe("banUserOption",{title:_WA20.tr(b.title),value:b.value,checked:0===c?'checked="true"':""},{safeKeys:["checked"]})}),this.initialConfig.content=a,_get2(_getPrototypeOf2(b.prototype),"_getContentHtml",this).call(this)}},{key:"_onClick",value:function(a){var c,d,e=a.up("imButton"),f=e&&e.getAttribute("data-action");if(this.initialConfig.onEditOk&&"ok"===f){if(c=this.block.getSelector("input:checked").dom,d=_U15.String.trim(c.value),""===d)return this.spamMode=!0,this._updateTitle(_WA20.tr("contact.report.reportSpam")),this._redrawContent(),!1;this.initialConfig.onEditOk(d)}_get2(_getPrototypeOf2(b.prototype),"_onClick",this).call(this,a)}}]),b}(_UI15.ConfirmModalBox);_UI15.BanModalBox=BanModalBox,WebIM.namespace("WebIM.ui");var _WA21=WebIM,_UI16=_WA21.ui,_U16=_WA21.util,_TD8=_WA21.TemplateDriver,BlockModalBox=function(a){function b(a){var c;_classCallCheck2(this,b);var d="readonly"===(_WA21.chatController.getCachedChatInfo(a.chatSn)||{}).defaultRole,e=d?"box.removeSubscriber":"box.removeMember",f=e+"AndMessages";return _WA21.applyIf(a,{title:_WA21.tr("box.removeAndBlock",{friendly:_WA21.Emoji.parse(_U16.String.htmlEntity(a.friendly))}),content:d?_WA21.tr("box.fromChannelRemovingDesc"):_WA21.tr("box.fromGroupRemovingDesc"),blockCls:"im-block-and-remove-confirm",buttons:[{action:"cancel",text:_WA21.tr("box.cancel")}],linkButtons:[{action:"remove",text:_WA21.tr(e),cls:"im-button_as-link"},{action:"removeWithMessages",text:_WA21.tr(f),cls:"im-button_as-link"}]}),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a)),c.sn=a.sn,c.chatSn=a.chatSn,c}return _inherits2(b,a),_createClass2(b,[{key:"_getContentHtml",value:function(){var a=(this.initialConfig.buttons||[]).map(function(a){return a?_TD8.parseSafe("button",a):""}),b=(this.initialConfig.linkButtons||[]).map(function(a){return a?_TD8.parseSafe("button",a):""}),c=(this.initialConfig.content||"")+b.join('<div class="im-break-line"></div>');return _TD8.parseSafe("confirmModalBox",{title:this.initialConfig.title||"",content:c,buttons:a.join("")},{safeKeys:["title","content","buttons"]})}},{key:"_onClick",value:function(a){var b=a.up("imButton"),c=b&&b.getAttribute("data-action");!this.initialConfig.onOk||"remove"!==c&&"removeWithMessages"!==c||this.initialConfig.onOk(this.chatSn,this.sn,"removeWithMessages"===c),c&&(this.actionEvent&&this.actionEvent.fire(c),this.hide())}}]),b}(_UI16.ConfirmModalBox);_UI16.BlockModalBox=BlockModalBox,WebIM.namespace("WebIM.ui");var _WA22=WebIM,_TD9=_WA22.TemplateDriver,_UI17=_WA22.ui,_U17=_WA22.util,_DomUtil11=_WA22.DomUtil,LiveChatModalBox=function(a){function b(a){var c;return _classCallCheck2(this,b),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,{blockCls:"im-box-livechat"})),c.chatItem=a,c.actionEvent=new _U17.Event,c}return _inherits2(b,a),_createClass2(b,[{key:"_getContentHtml",value:function(){var a=this.chatItem;if(a){var b=a.location?[_U17.String.htmlEntity(a.location)]:[];a.friendsCount&&b.push(_WA22.tr("chat.friends",{count:_U17.String.htmlEntity(a.friendsCount)}));var c=[];_U17.Array.each(a.members||[],function(a){return c.push(_WA22.Ava.make(a.sn||a.email,"",36)),c.length>4?!1:void 0});var d=_WA22.Ava.make(a.sn,a.name,100),e=Math.max(0,a.membersCount-Math.min(3,c.length)),f=Math.max(0,a.membersCount-c.length);e>1e3&&(e=Math.min(10,Math.round(e/100)/10)+"k"),a.inList=a.you&&a.you.role&&!a.you.pending;var g=!a.inList&&a.joinModeration?"im-livechat-moderated":"";return this.block&&(this.block.toggleClass("im-livechat-inlist",!!a.inList),this.block.toggleClass("im-livechat-pending",!(!a.you||!a.you.pending))),_TD9.parseSafe("LiveChatItem",{className:g,name:_WA22.Emoji.parse(_U17.String.htmlEntity(a.name||a.stamp||a.sn)),about:_WA22.Emoji.parse(_U17.String.htmlEntity(a.about||"")),avatar:d,count:e?"+"+e:"",fullCount:f?"+&nbsp;"+f:"",usersAvatars:c.join(""),loc_friends:b.join(" &bull; ")},{safeKeys:["name","about","avatar","fullCount","usersAvatars","loc_friends"]})}}},{key:"_onResize",value:function(){this.block.removeClass("im-livechat-compact"),this.el.dom.scrollHeight-10>this.el.dom.offsetHeight&&this.block.addClass("im-livechat-compact")}},{key:"_onClick",value:function(a){var b=a.up("imButton"),c=b&&b.getAttribute("data-action");c&&this.actionEvent.fire(c,this.chatItem)}},{key:"updateItem",value:function(a){this.chatItem=a,this.isVisible()&&this._redrawContent()}},{key:"_onShow",value:function(){this.el&&(this.block.dom.scrollTop=0,this._onResize(),_DomUtil11.fly(window).on("resize",this._onResize,this),_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this))}},{key:"_onHide",value:function(){_DomUtil11.fly(window).un("resize",this._onResize,this),_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this)}},{key:"destroy",value:function(){this.actionEvent.removeAll(),this.actionEvent=null,_DomUtil11.fly(window).un("resize",this._onResize,this),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI17.ModalComponent);_UI17.LiveChatModalBox=LiveChatModalBox,WebIM.namespace("WebIM.ui");var _WA23=WebIM,_UI18=_WA23.ui,_U18=_WA23.util,_DomUtil12=_WA23.DomUtil,_WHEEL_STEP=40,DateSelector=function(a){function b(a){var c;return _classCallCheck2(this,b),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a)),
c.initialConfig.blockCls=(c.initialConfig.blockCls||"")+" im-bday-selector",c._mids={},c._timers={},c._animations={},c.current={},c._steps={},c._funcs={d:c._onDayScroll,m:c._onMonthScroll,y:c._onYearScroll},c}return _inherits2(b,a),_createClass2(b,[{key:"_getContentHtml",value:function(){return this.initialConfig.content=this._makeInner(),_get2(_getPrototypeOf2(b.prototype),"_getContentHtml",this).call(this)}},{key:"_onRender",value:function(a){_get2(_getPrototypeOf2(b.prototype),"_onRender",this).call(this,a),this.body=this.block.getSelector(".im-modal-box__body"),this.days=this.body.first().first(),this.months=this.body.first().next().first(),this.years=this.body.last().first()}},{key:"show",value:function(a){this.showDate=a,_get2(_getPrototypeOf2(b.prototype),"show",this).call(this),this.el&&this._showDate(a)}},{key:"_onShow",value:function(){_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),this.days.on("scroll",this._onDayScroll,this),this.months.on("scroll",this._onMonthScroll,this),this.years.on("scroll",this._onYearScroll,this),this.body.on("touchend",this._onTouchEnd,this),this.body.on("touchstart",this._onTouchStart,this),this.body.on(["mousewheel","DOMMouseScroll"],this._onWheel,this)}},{key:"_onHide",value:function(){this.el&&(this.body.removeClass("im-bday-leapyear"),this.el.removeClass("im-bday-selector"),this.days.un("scroll",this._onDayScroll,this),this.months.un("scroll",this._onMonthScroll,this),this.years.un("scroll",this._onYearScroll,this),this.body.un("touchend",this._onTouchEnd,this),this.body.un("touchstart",this._onTouchStart,this),this.body.un(["mousewheel","DOMMouseScroll"],this._onWheel,this),_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this))}},{key:"_onClick",value:function(a){var b=a.up("imButton"),c=b&&b.getAttribute("data-action"),d=a.up("im-bday-controls");if(d){if(d&&b){var e=d.prev().dom;this._stepAny(e,e.getAttribute("data-key"),b.hasClass("im-bday-controls__top")?1:-1)}}else this.initialConfig.onOk&&"ok"===c&&this.initialConfig.onOk(this.getDate()),c&&(this.actionEvent&&this.actionEvent.fire(c),this.hide())}},{key:"_showDate",value:function(a){a||(a=new Date(this._curYear-58+"-06-15").getTime());var b=new Date(a),c=b.getFullYear(),d=b.getMonth(),e=b.getDate();this.current={d:e,m:d,y:c},1===new Date(c+"-02-29").getMonth()?(this.body.addClass("im-bday-leapyear"),this.isLeapYear=!0):(this.body.removeClass("im-bday-leapyear"),this.isLeapYear=!1),this._updating={y:1,m:1,d:1},this._steps={y:0,m:0,d:0},this.years.updateHTML(this._yInner),this.months.updateHTML(this._mInner),this.days.updateHTML(this._dInner),this._mids={y:Math.floor(this.years.dom.childNodes.length/2),m:Math.floor(this.months.dom.childNodes.length/2),d:Math.floor(this.days.dom.childNodes.length/2)};var f=this.years.dom.childNodes[this._mids.y].childNodes[115-(this._curYear-c)];this.years.dom.scrollTop=this._mids.y*this.years.first().dom.offsetHeight+f.offsetTop-Math.round(this.years.dom.offsetHeight/2-f.offsetHeight/2);var g=this.months.dom.childNodes[this._mids.m].childNodes[d];this.months.dom.scrollTop=this._mids.m*this.months.first().dom.offsetHeight+g.offsetTop-Math.round(this.months.dom.offsetHeight/2-g.offsetHeight/2);var h=this.days.dom.childNodes[this._mids.d].childNodes[d].childNodes[e-1];this.days.dom.scrollTop=this._mids.d*this.days.first().dom.offsetHeight+h.offsetTop-Math.round(this.days.dom.offsetHeight/2-h.offsetHeight/2),this._showTimer&&clearTimeout(this._showTimer),this._showTimer=_WA23.setTimeout(function(){this._updating={},delete this._showTimer},100,this)}},{key:"_makeInner",value:function(){var a=(new Date).getFullYear();this._curYear=a;var b="<div>"+_U18.Array.each(new Array(116),function(b,c,d){b=a-c,d[c]=1===new Date(b+"-02-29").getMonth()?'<div class="imLeap">'+b+"</div>":b}).reverse().join("</div><div>")+"</div>",c=_U18.Array.each(new Array(12),function(a,b,c){c[b]=_WA23.tr("month_gen."+(b+1))}),d=[];_U18.Array.each(c,function(a,b){d.push('<div class="im-bday-cont__month mounth_num_'+b+'"><div>'+_U18.Array.each(new Array((7>b?b%2:!(b%2))?1===b?29:30:31),function(a,c,d){c++,d[c-1]=1===b&&29===c?'<div class="imBdayMonth29">'+c+"</div>":c}).join("</div><div>")+"</div></div>")});var e='<div class="im-bday-subcont">'+d.join("")+"</div>",f='<div class="im-bday-subcont"><div>'+c.join("</div><div>")+"</div></div>",g='<div class="im-bday-subcont">'+b+"</div>",h='<div class="im-bday-controls"><div class="im-bday-controls__top im-ui-button imButton"></div><div class="im-bday-controls__bottom im-ui-button imButton"></div></div>',i=['<div class="im-bday-wrap"><div class="im-bday-cont" data-key="d">',this._dInner=new Array(4).join(e),"</div>",h,"</div>",'<div class="im-bday-wrap"><div class="im-bday-cont" data-key="m">',this._mInner=new Array(20).join(f),"</div>",h,"</div>",'<div class="im-bday-wrap"><div class="im-bday-cont" data-key="y">',this._yInner=new Array(4).join(g),"</div>",h,"</div>"];return i.join("")}},{key:"_getScrolledNode",value:function(a,b){for(var c,d,e=a.childNodes||[],f=0,g=e.length;g>f&&(d=e[f],!(d.offsetTop<b&&(c=d,d.offsetTop+d.offsetHeight>b)));f++);return c}},{key:"getDate",value:function(){return new Date(this.current.y+"-"+(this.current.m+1)+"-"+this.current.d)}},{key:"_alignValue",value:function(a,b){var c=a.firstChild.firstChild;"d"===b&&(c=c.firstChild),c=c.offsetHeight;var d=a.scrollTop-a.childNodes[this._mids[b]].offsetTop,e=Math.round(d/c)*c,f=Math.round(d-e);delete this._timers[b],this._animations[b]&&(_U18.animation.clear(this._animations[b]),delete this._animations[b],this._steps[b]=0),this._animate(f,a,b,.1),_DomUtil12.get(a.parentNode).removeClass("im-bday-scrolled")}},{key:"_animate",value:function(a,b,c,d,e,f){if(a){e||(e=function(){});var g=[],h=[];_U18.Array.each(b.childNodes,function(a,b){h[b]=g[b]=parseInt(a.style.top||0)}),this._animations[c]&&_U18.animation.clear(this._animations[c]),this._animations[c]=_U18.animation.start(0,a,d,function(a,d){a=Math.round(a),_U18.Array.each(b.childNodes,function(b,c){b.style.top=parseInt(b.style.top||0)+(g[c]+a-h[c])+"px",h[c]=g[c]+a}),e.call(this),d&&(delete this._animations[c],f&&f.call(this))},this)}}},{key:"_getMiddleBlock",value:function(a,b){var c=a.childNodes[b];return c.offsetTop+c.offsetHeight-a.scrollTop<a.offsetHeight/2?c=c.nextSibling||a.firstChild:c.offsetTop-a.scrollTop>a.offsetHeight/2&&(c=c.previousSibling||a.lastChild),c}},{key:"_getOffsetByStep",value:function(a,b,c,d,e){var f="previousSibling",g="lastChild",h=-1;e>0&&(f="nextSibling",g="firstChild",h=1);var i=a[f],j=0;return i&&i.offsetHeight||("d"===d?(a.parentNode[f]?i=a.parentNode[f][g]:(b=b[f]||c[g],i=b[g][g],j=h*b.offsetHeight),i.offsetHeight||(i=i[f])):(b=b[f]||c[g],i=b[g],j=h*b.offsetHeight)),j+i.offsetTop}},{key:"_stepAny",value:function(a,b,c,d){c=c>0?1:-1;var e=d||!this._steps[b];if(d||(this._steps[b]+=c),e){var f,g=this._getMiddleBlock(a,this._mids[b]),h=a.scrollTop-g.offsetTop,i=h+a.offsetHeight/2,j=0,k=this._getScrolledNode(g,i);"d"===b&&(k=this._getScrolledNode(k,i)),f=k.offsetTop,j=this._getOffsetByStep(k,g,a,b,c);var l=k.offsetHeight,m=f-j-Math.round(h-Math.round(h/l)*l);this._animate(m,a,b,.3,function(){this._funcs[b].call(this,null,null,!0)},function(){this._steps[b]-=c,this._steps[b]&&this._stepAny(a,b,this._steps[b],!0)})}}},{key:"_onAnyScroll",value:function(a,b,c){var d,e,f,g=a.childNodes,h=g.length,i=this._mids[b];if(this._timers[b]&&clearTimeout(this._timers[b]),this._animations[b]&&!c&&(_U18.animation.clear(this._animations[b]),delete this._animations[b],this._steps[b]=0),(f=g[i].offsetTop-a.scrollTop-a.offsetHeight)>0)for(d=Math.ceil(f/g[i].offsetHeight);d--;)e=g[(i+Math.floor(h/2))%h],e.style.top=parseInt(e.style.top||0)-g[i].offsetHeight*h+"px",e.offsetTop<0?(e.style.top=parseInt(e.style.top||0)+g[i].offsetHeight*h+"px",a.scrollTop+=g[i].offsetHeight):i=(i||h)-1;else if((f=g[i].offsetTop+g[i].offsetHeight-a.scrollTop)<0)for(f*=-1,d=Math.ceil(f/g[i].offsetHeight);d--;)e=i-Math.floor(h/2),e=g[0>e?h+e:e],e.style.top=parseInt(e.style.top||0)+g[i].offsetHeight*h+"px",i=(i+1)%h;this._mids[b]!==i&&(this._mids[b]=i),this._timers[b]||c||_DomUtil12.get(a.parentNode).addClass("im-bday-scrolled"),this._toushStarted||c||(this._timers[b]=_WA23.setTimeout(function(){this._alignValue(a,b)},100,this))}},{key:"_onDayScroll",value:function(a,b,c){if(!this._updating.d){this._onAnyScroll(this.days.dom,"d",c);var d,e,f,g=this._getMiddleBlock(this.days.dom,this._mids.d),h=this.days.dom.scrollTop+this.days.dom.offsetHeight/2-g.offsetTop;if(_U18.Array.each(g.childNodes,function(a,b){return d=h-a.offsetTop,d>=0&&d<a.offsetHeight?(e=a,f=b,!1):void 0}),void 0!==f&&void 0!==e&&(this.current.d=Math.ceil((h-e.offsetTop)/e.firstChild.offsetHeight),this.current.m!=f)){var i=this.months.dom.childNodes[this._mids.m],j=i.childNodes[this.current.m],k=i.childNodes[f];d=this.months.dom.scrollTop+this.months.dom.offsetHeight/2-i.offsetTop;var l=k.offsetTop-j.offsetTop;_U18.Array.each(this.months.dom.childNodes,function(a){a.style.top=parseInt(a.style.top||0)-l+"px"}),this.current.m=f}}}},{key:"_onMonthScroll",value:function(a,b,c){if(!this._updating.m){this._onAnyScroll(this.months.dom,"m",c);var d=this._getMiddleBlock(this.months.dom,this._mids.m),e=this.months.dom.scrollTop-d.offsetTop,f=Math.floor((e+this.months.dom.offsetHeight/2)/d.firstChild.offsetHeight)%12;if(f!=this.current.m){var g=this.days.dom.childNodes[this._mids.d],h=g.querySelector(".mounth_num_"+this.current.m),i=g.querySelector(".mounth_num_"+f),j=this.days.dom.scrollTop+this.days.dom.offsetHeight/2-h.offsetTop-g.offsetTop,k=i.offsetTop-h.offsetTop;if(j>i.offsetHeight){var l=Math.ceil((j-i.offsetHeight)/i.firstChild.offsetHeight);k-=i.firstChild.offsetHeight*l,this.current.d-=l}_U18.Array.each(this.days.dom.childNodes,function(a){a.style.top=parseInt(a.style.top||0)-k+"px"}),this.current.m=f}}}},{key:"_onYearScroll",value:function(a,b,c){if(!this._updating.y){this._onAnyScroll(this.years.dom,"y",c);var d=this._getMiddleBlock(this.years.dom,this._mids.y),e=this.years.dom.scrollTop+this.years.dom.offsetHeight/2-d.offsetTop,f=d.childNodes[Math.floor(e/d.firstChild.offsetHeight)]||d.lastChild,g=parseInt(f.innerText||f.textContent);this.current.y!=g&&(this.current.y=g,"imLeap"!==f.firstChild.className||this.isLeapYear?this.isLeapYear&&(this.body.removeClass("im-bday-leapyear"),this.isLeapYear=!1,this._updateDays()):(this.body.addClass("im-bday-leapyear"),this.isLeapYear=!0,this._updateDays()))}}},{key:"_updateDays",value:function(){this._updating.d=1;var a=this.current.d,b=this.current.m;29!=a||1!=b||this.isLeapYear||(a=28),this.days.updateHTML(this._dInner),this._mids.d=Math.floor(this.days.dom.childNodes.length/2);var c=this.days.dom.childNodes[this._mids.d].childNodes[b].childNodes[a-1];this.days.dom.scrollTop=this._mids.d*this.days.first().dom.offsetHeight+c.offsetTop-Math.round(this.days.dom.offsetHeight/2-c.offsetHeight/2),this._daysUpTimer&&clearTimeout(this._daysUpTimer),this._daysUpTimer=_WA23.setTimeout(function(){delete this._updating.d,delete this._daysUpTimer},100,this)}},{key:"_onTouchEnd",value:function(a){this._toushStarted=!1;var b=a.getTarget(!0).up("im-bday-cont");if(b){b=b.dom;var c=b.getAttribute("data-key");this._timers[c]&&clearTimeout(this._timers[c]),this._timers[c]=_WA23.setTimeout(function(){this._alignValue(b,c)},50,this)}}},{key:"_onTouchStart",value:function(a){this._toushStarted=!0;var b=a.getTarget(!0).up("im-bday-cont");if(b){b=b.dom;var c=b.getAttribute("data-key");this._animations[c]&&(_U18.animation.clear(this._animations[c]),delete this._animations[c],this._steps[c]=0),this._timers[c]&&(clearTimeout(this._timers[c]),delete this._timers[c])}}},{key:"_onWheel",value:function(a){var b=a.getTarget(!0);if(b.hasClass("imButton")&&(b=b.up("im-bday-controls"),b&&(b=b.prev())),b=b.up("im-bday-cont"),b&&b.hasAttr("data-key")){var c,d,e=b.getAttribute("data-key");switch(e){case"d":b=this.days,d=b.first().first().first().dom.offsetHeight,c=this._onDayScroll;break;case"m":b=this.months,d=b.first().first().dom.offsetHeight,c=this._onMonthScroll;break;case"y":b=this.years,d=b.first().first().dom.offsetHeight,c=this._onYearScroll}if(b){var f=a.browserEvent;d=d+Math.ceil(d/2)+1;var g=-(f.wheelDelta?f.wheelDelta/120:-f.detail/3)*_WHEEL_STEP;Math.abs(g)<d&&!b.parent().hasClass("im-bday-scrolled")?this._stepAny(b.dom,e,g>0?1:-1):(this._animations[e]&&_U18.animation.clear(this._animations[e]),b.dom.scrollTop=b.dom.scrollTop+g),a.stopEvent()}}}}]),b}(_UI18.ConfirmModalBox);_UI18.DateSelector=DateSelector,WebIM.namespace("WebIM.ui");var _WA24=WebIM,_U19=_WA24.util,USE_OLD_NOTIFICATION_API=_WA24.isProblemStrictSafari,NOTIFICATION_TIMEOUT=1e4,BODY_MAX_LENGTH=50,_DomUtil13=_WA24.DomUtil,activeNtfs={},currentPermission,showEvent=new _U19.Event,clickEvent=new _U19.Event,hideEvent=new _U19.Event,permissionEvent=new _U19.Event,createNtfObject=function(a,b){var c=_WA24.uniq(),d=new Notification(a.title,a);return activeNtfs[c]=d,d.__uniq=c,d.onclose=function(){this.__uniq&&activeNtfs[this.__uniq]&&(hideEvent.fire(this.__uniq),delete activeNtfs[this.__uniq])},d.onclick=function(){window.focus(),b(c),clickEvent.fire(this.__uniq);try{if(this.cancel)this.cancel();else if(this.close)this.close();else{var a="";d.cancel?(d.cancel(),a="n_has_cancel"):d.close?(d.close(),a="n_has_close"):this.onclose&&(a="has_onclose",this.onclose()),_U19.Mnt.flog("notifications",[this.toString&&this.toString(),_typeof2(this),this instanceof Notification,this===d,a].join("|"))}}catch(e){_U19.Mnt.catchException(e)}},d.onshow=function(){showEvent.fire(this.__uniq)},d.onerror=function(a){this.__uniq&&activeNtfs[this.__uniq]&&delete activeNtfs[this.__uniq]},_WA24.setTimeout(function(){if(this.cancel)this.cancel();else if(this.close)this.close();else{var a="";this.onclose&&(a="has_onclose",this.onclose()),_U19.Mnt.flog("notifications",["from_timeout",this.toString&&this.toString(),_typeof2(this),this instanceof Notification,this===d,a].join("|"))}},NOTIFICATION_TIMEOUT,d),c},getNtfPermission=function(){return"Notification"in window?(Notification.permission?currentPermission=Notification.permission:Notification.permissionLevel&&(currentPermission=Notification.permissionLevel()),currentPermission):void 0},checkNotificationPromise=function(){return!USE_OLD_NOTIFICATION_API},requestNtfPermission=function(){"Notification"in window&&(currentPermission||getNtfPermission(),"granted"!==currentPermission&&"denied"!==currentPermission&&(checkNotificationPromise()?Notification.requestPermission().then(function(a){currentPermission=a,permissionEvent.fire("granted"===a)}):Notification.requestPermission(function(a){currentPermission=a,permissionEvent.fire("granted"===a)})))};_WA24.Notifier={showEvent:showEvent,clickEvent:clickEvent,hideEvent:hideEvent,permissionEvent:permissionEvent,requestPermission:function(){requestNtfPermission()},isGranted:function(){return"granted"===getNtfPermission()},show:function(a,b,c,d){var e=c;if(currentPermission||getNtfPermission(),"granted"===currentPermission){this._unloadHandler||(this._unloadHandler=_DomUtil13.fly(window).on("beforeunload",this.clear,this)),e.length>BODY_MAX_LENGTH&&(e=e.substr(0,BODY_MAX_LENGTH)+"...");var f=createNtfObject({title:b||"",body:e,icon:d||null},function(){});return this.showEvent.fire(f),f}},hide:function(a){var b=activeNtfs[a];b&&(b.cancel?b.cancel():b.close(),delete activeNtfs[a],this.hideEvent.fire(a))},clear:function(){Object.keys(activeNtfs).forEach(function(a){this.hide(a)},this)}},WebIM.namespace("WebIM.ui");var _WA25=WebIM,_UI19=_WA25.ui,_U20=_WA25.util,_DomUtil14=_WA25.DomUtil,_cache={},hideBubble=function(a){if(a.dom.parentNode){a.setStyle({visibility:"hidden",display:"block"});var b=document.querySelectorAll(".im-message-popup");_U20.Array.each(Array.prototype.slice.call(b,0,_U20.Array.indexOf(b,a.dom)),function(a){a=_DomUtil14.fly(a),a.removeClass("im-message-popup__moved"),a.setStyle("bottom",parseInt(a.getStyle("bottom"))-(a.dom.offsetHeight+parseInt(a.getStyle("margin-top"))+parseInt(a.getStyle("margin-bottom"))+1)+"px")}),a.remove()}},showBubble=function(a,b,c){var d=new InfoBubble(a,b,c),e=d.el.dom;return Object.keys(_cache).forEach(function(b){b!==d.uid&&_cache[b].text===a&&_cache[b].fadeHide()}),_U20.Array.each(document.querySelectorAll(".im-message-popup"),function(a){a!==e&&(a=_DomUtil14.fly(a),a.addClass("im-message-popup__moved"),a.setStyle("bottom",parseInt(a.getStyle("bottom"))+(e.offsetHeight+parseInt(a.getStyle("margin-top"))+parseInt(a.getStyle("margin-bottom")))+1+"px"))}),d},InfoBubble=function(){function a(b,c,d){_classCallCheck2(this,a),"undefined"==typeof c&&(c=3e3),this.uid=_WA25.uniq(),_cache[this.uid]=this,this.text=b,this.clickEvent=new _U20.Event;var e=d?b:_U20.String.htmlEntity(b);this.el=_U20.DomHelper.createDiv().addClass("im-message-popup").setStyle("visibility","hidden").updateHTML(e).appendTo(document.body),this.el.on("click",this._clickHandler,this,{single:!0}),this.el.setStyle("visibility","visible"),c>0&&(this.closeTimer=_WA25.setTimeout(this.fadeHide,c,this))}return _createClass2(a,[{key:"_clickHandler",value:function(a){this.clickEvent.fire(a)&&this.fadeHide()}},{key:"fadeHide",value:function(){this.closeTimer&&clearTimeout(this.closeTimer),this.el&&(this.el.addClass("im-message-popup__removing").removeClass("im-message-popup__moved").setStyle("opacity",0),this.fadeTimer=_WA25.setTimeout(this.destroy,100,this))}},{key:"remove",value:function(a){this.el&&(a?this.destroy():this.fadeHide())}},{key:"destroy",value:function(){this.clickEvent.removeAll(),this.fadeTimer&&(clearTimeout(this.fadeTimer),delete this.fadeTimer),this.el&&(this.el.un("click",this._clickHandler,this),hideBubble(this.el),this.el=null,delete _cache[this.uid])}}]),a}();_UI19.showInfoBubble=showBubble,WebIM.namespace("WebIM.ui");var _WA26=WebIM,_UI20=_WA26.ui,_U21=_WA26.util,_DomUtil15=_WA26.DomUtil,TemplateRenderer=function(){function a(b){_classCallCheck2(this,a),this.data={},this.dataKeys={},this._tempData=[],this.html="",b&&this.setTemplate(b)}return _createClass2(a,[{key:"setTemplate",value:function(a){this.template=a;for(var b=this.dataKeys={},c=this._tempData=a.split(/\${(\w+)}/),d=1,e=c.length;e>d;d+=2)(b[c[d]]||(b[c[d]]=[])).push(d),c[d]=this.data[c[d]]||""}},{key:"setData",value:function(a,b){if(this.dataKeys[a]){var c=this.dataKeys[a],d=c.length,e=this._tempData;this.data[a]=b;for(var f=b||0===b?b:"";d--;)e[c[d]]=f}}},{key:"updateData",value:function(a){this.data=a,_U21.Object.each(this.dataKeys,function(b,c){this.setData(c,a[c])},this)}},{key:"renderHTML",value:function(a){return a&&this.updateData(a),this.html=this._tempData.join(""),this.html}},{key:"renderElement",value:function(a,b){b&&this.renderHTML(b);var c=_U21.DomHelper.elementFromHtml(this.html),d=a&&_DomUtil15.get(a);return d&&d.parent()&&(_U21.Array.each(c.attributes,function(a){d.setAttribute(a.name,a.value)},this),d.updateHTML(c.innerHTML),c=d),_DomUtil15.get(c)}}]),a}();_UI20.TemplateRenderer=TemplateRenderer;var _WA27=WebIM,_U22=_WA27.util,_UI21=_WA27.ui,_DomUtil16=_WA27.DomUtil,STICKER_ID_REGEXP=/\/stickers\/(\d+)\/(\d+)/,IMAGE_CACHE_CHECK_PERIOD=2e4;_UI21.StickerPreview={_imageCaches:{},_imageCacheCheck:function(){var a=this,b=_WA27.now(),c=!1;Object.keys(this._imageCaches).forEach(function(d){var e=a._imageCaches[d];b-e.ts>2e4?delete a._imageCaches[d]:c=!0}),c?this._imageCachesChecker=_WA27.setTimeout(this._imageCacheCheck.bind(this),IMAGE_CACHE_CHECK_PERIOD):delete this._imageCachesChecker},hide:function(a){if(this._stickerPreviewConf){a&&a.stopEvent&&a.stopEvent();var b=_DomUtil16.getDoc(),c=this._stickerPreviewConf.stickersBlock,d=this._stickerPreviewConf.preview,e=this._stickerPreviewConf.block,f=this._stickerPreviewConf.stopEvent,g=this._stickerPreviewConf.onMove;delete this._stickerPreviewConf,b.un(["mouseup","touchend"],this.hide,this),b.un(["mousemove","touchmove"],g),c.dom&&c.un("swap:end",f),d&&d.remove(),e&&e.remove()}},show:function(a,b,c,d){function e(a,b){if(a=_DomUtil16.get(a),a&&(a.isAncestor(i)||b)){var c=_WA27.Sticker.getStickerIdFromUrl(a.getAttribute("src"));if(c&&c!==o){o=c;var d=_WA27.Sticker.getStickerUrl("",c,100);if(!p[d]){var e=new Image;e.src=d,p[d]={img:e,ts:_WA27.now()}}n.setStyle("background-image","url("+d+")")}}}function f(a){a.stopEvent()}function g(a){a.stopEvent();var b=a.browserEvent.changedTouches?a.browserEvent.changedTouches[0]:a.browserEvent;e(document.elementFromPoint(b.clientX,b.clientY))}var h=b.offsetBy(_DomUtil16.getBody()),i=_DomUtil16.fly(b.dom.cloneNode(!0)),j=_DomUtil16.getDoc();i.addClass("im-stickers-preview__handleblock "+(d||""));var k=a.offsetBy(b),l=a.offsetBy(b,!0),m=h.top-(k.top-l.top);i.setStyle({width:b.dom.offsetWidth-parseInt(b.getStyle("padding-left"))-parseInt(b.getStyle("padding-right"))+"px",left:h.left+"px",top:m+"px"}),_DomUtil16.getBody().appendChild(i);var n=c.createChild({tag:"div",cls:"im-stickers-preview"});this._imageCachesChecker||(this._imageCachesChecker=_WA27.setTimeout(this._imageCacheCheck,IMAGE_CACHE_CHECK_PERIOD,this));var o,p=this._imageCaches;this._stickerPreviewConf={stickersBlock:b,block:i,preview:n,stopEvent:f,onMove:g},e(a,!0),j.on(["mousemove","touchmove"],g),b.on("swap:end",f),j.on(["mouseup","touchend"],this.hide,this)}},WebIM.namespace("WebIM.ui");var _WA28=WebIM,_U23=_WA28.util,_UI22=_WA28.ui,_DomUtil17=_WA28.DomUtil,_Activatable3=_WA28.Activatable,DragDropArea=function(a){function b(a){var c;return _classCallCheck2(this,b),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),c.initialConfig=a||{},c.title=c.initialConfig.title||_WA28.tr("dialog.sendFileQuick"),c.dropEvent=new _U23.Event,c.dragEvent=new _U23.Event,c._count=0,c}return _inherits2(b,a),_createClass2(b,[{key:"_onActivate",value:function(a){this.target=this.initialConfig.affectWholePage?_DomUtil17.getBody():_DomUtil17.get(a),this.target.on("dragenter",this._onDragEnter,this),this.target.on("dragover",this._onDragOver,this),this.target.on("dragleave",this._onDragLeave,this),this.target.on("drop",this._onDrop,this),this.setDropElement(a)}},{key:"_onDeactivate",value:function(){this.target.un("dragover",this._onDragOver,this),this.target.un("dragleave",this._onDragLeave,this),this.target.un("drop",this._onDrop,this),this.el&&(this.el.remove(),this.el=null)}},{key:"_onDragEnter",value:function(a){a.stopEvent(),this._count++}},{key:"_onDragOver",value:function(a){a.stopEvent();var b=a.getTarget(!0),c=a.browserEvent.dataTransfer&&a.browserEvent.dataTransfer.types&&Array.prototype.join.call(a.browserEvent.dataTransfer.types," ").toLowerCase().indexOf("files")>-1;this.el&&(b.up("imDragDropAdv")?this.el.first().addClass("im-dragdrop_hover"):b.up("imDragDropQuick")&&this.el.last().addClass("im-dragdrop_hover")),c&&(b.up("imDragDropArea")||this.dragEvent.fire(b))&&this.enableDragDropMode()}},{key:"_onDragLeave",value:function(a){this._count--;var b=a.browserEvent.relatedTarget;if(!((_WA28.isIE||_WA28.isEdge)&&this._count>0)){if(this.el){var c=a.getTarget(!0);c.up("imDragDropAdv")?this.el.first().removeClass("im-dragdrop_hover"):c.up("imDragDropQuick")&&this.el.last().removeClass("im-dragdrop_hover")}b?this.target.contains(b)||this.disableDragDropMode():this._count<1&&this.disableDragDropMode()}}},{key:"_onDrop",value:function(a){if(this._count=0,a.stopEvent(),this.initialConfig.affectWholePage||a.getTarget(!0).up("imDragDropArea")){var b=!a.getTarget(!0).up("imDragDropAdv");a=a.browserEvent;var c=a.dataTransfer,d=c.files;this.dropEvent.fire(d,b)}this.disableDragDropMode()}},{key:"setDropElement",value:function(a){this.el=_DomUtil17.get(a).createChild({cls:"imDragDropArea im-dragdrop-area "+(this.initialConfig.dualMode?"im-dragdrop_dual":""),style:"display:none",html:'<div class="im-dragdrop__advanced imDragDropAdv">'+_WA28.tr("dialog.sendFileAdvanced")+'</div><div class="im-dragdrop__standard imDragDropQuick">'+_U23.String.htmlEntity(this.title)+"</div>"})}},{key:"resetDropElement",value:function(){this.el&&(this.el.remove(),this.el=null)}},{key:"isDragDropModeEnabled",value:function(){return this._dragDropModeEnabled}},{key:"enableDragDropMode",value:function(){this._dragDropModeEnabled||(this._dragDropModeEnabled=!0,this.el&&this.el.show())}},{key:"disableDragDropMode",value:function(){this._dragDropModeEnabled&&(this._dragDropModeEnabled=!1,this.el&&(this.el.first().removeClass("im-dragdrop_hover"),this.el.last().removeClass("im-dragdrop_hover"),this.el.hide()))}}]),b}(_Activatable3);_UI22.DragDropArea=DragDropArea,WebIM.namespace("WebIM.ui");var _WA29=WebIM,_U24=_WA29.util,_UI23=_WA29.ui,_DomUtil18=_WA29.DomUtil,InfoPanelBox=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.swipeStartEvent=new _U24.Event,a.active=!1,a._wasShowed=!1,a.visible=!1,a.render(_DomUtil18.getBody()),a}return _inherits2(b,a),_createClass2(b,[{key:"show",value:function(a){this.setVisible(!0,!0),this.el.toggleClass("im-infopane_back-not-available",!a)}},{key:"hide",value:function(a){return this.setVisible(!1,a)}},{key:"setVisible",value:function(a,b){if(this.winEl&&("boolean"!=typeof a||a!==this.visible)){var c={transition:""};if(this._timer&&(this.winEl.setStyle(c),clearTimeout(this._timer)),this.visible)b||this.winEl.toggleClass("im-infopanel_hiding");else if(b){var d={transition:"none"};this.winEl.setStyle(d)}this._setVisibility(!this.visible),this._timer=_WA29.setTimeout(function(){this._timer=!1,this.winEl.setStyle(c),this.winEl.removeClass("im-infopanel_hiding")},b?10:500,this);var e=this.visible?"show":"hide";this[e+"Event"].fire(this)}}},{key:"_setVisibility",value:function(a){this.visible=!!a;var b=_DomUtil18.fly(document.body);b.toggleClass("im-layout-infopanel",this.visible),this.winEl.toggleClass("im-infopanel_shown",this.visible)}},{key:"_onSwapMove",value:function(a){if(this.swipeStartEvent.fire(this.active)&&this.active){a=a.browserEvent;var b,c,d,e=window.innerWidth,f=e-52,g=f,h=this.visible,i=h;h=h||this._wasShowed,(e-(a.clientX-a.deltaX)<52||h)&&(d={transition:""},h&&(g=0,i&&(this._setVisibility(!1),this._wasShowed=!0,b={opacity:1,"z-index":1},c={transform:"translateX(0%)"},this.winEl.setStyle(d),this.winEl.setStyle(c))),g=Math.min(Math.max(g+a.deltaX,0),f),b={opacity:(f-g)/f,"z-index":1},c={transform:"translateX("+100*(g/f)+"%)"},this.winEl.setStyle(d),this.winEl.setStyle(c))}}},{key:"_onSwapEnd",value:function(a){if(this.active){if(a=a.browserEvent,(window.innerWidth-(a.clientX-a.deltaX)<52||this._wasShowed)&&a.deltaX){var b=Math.round(300*(window.innerWidth-52-Math.abs(a.deltaX))/(window.innerWidth-52))+"ms",c={transform:"","z-index":"",opacity:"",transition:b};(this._wasShowed?a.deltaX>(window.innerWidth-52)/2:a.deltaX<-(window.innerWidth-52)/2)?(this._wasShowed&&this._setVisibility(!0),this.setVisible()):(this._wasShowed||this._setVisibility(!this.visible),this.setVisible()),this.winEl.setStyle(c)}this._wasShowed=!1}}},{key:"detachElement",value:function(){var a=this.el.first();a&&this.el.dom.removeChild(a.dom),this.active=!1}},{key:"attachElement",value:function(a){this.detachElement(),this.el.appendChild(a),this.active=!0}},{key:"onClick",value:function(a){a.getTarget(!0).hasClass("im-infopane-overlay")&&this.toggle(!1)}},{key:"_onRender",value:function(a){var b=_U24.DomHelper.elementFromHtml(_WA29.TD.getTMPL("infoPaneLayout"));a.appendChild(b),this.winEl=_DomUtil18.get("infoPane"),this.el=this.winEl.getSelector(".im-infopane"),_WA29.isDesktop||(_DomUtil18.getBody().on("swap:move",this._onSwapMove,this),_DomUtil18.getBody().on("swap:end",this._onSwapEnd,this)),this.winEl.on("click",this.onClick,this)}},{key:"destroy",value:function(){this.rendered&&(_WA29.isDesktop||(_DomUtil18.getBody().un("swap:move",this._onSwapMove,this),_DomUtil18.getBody().un("swap:end",this._onSwapEnd,this)),this.winEl.un("click",this.onClick,this),this._timer&&clearTimeout(this._timer),this._wasShowed=!1,this._timer=this.winEl=this.el=null,_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this))}}]),b}(_UI23.ES6Component);_UI23.InfoPanelBox=InfoPanelBox;var _WA30=WebIM,_U25=_WA30.util,_UI24=_WA30.ui,_Activatable5=_WA30.Activatable,InfiniteListView=function(a){function b(){var a,c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.__isActive=!1,a.requestNextPageEvent=new _U25.Event,a.applyItemEvent=new _U25.Event,a.checkpointEvent=new _U25.Event,a.bound=!1,a.itemTemplates={},a.watchNextPageCondition=!1,a._checkpointPassed=!1,a._prevCheckpointPassed=!0,a._checkpointAnchors={},a._checkpointList=[],a._nextCheckpointNum=0,a._passedCheckpoints={},a.initConfig=c,a.selectable=!!c.selectable&&_WA30.isDesktop,a.loopNavigation=!!c.loopNavigation&&a.selectable,a._buildEntryBundle=c.buildEntryBundle||function(){},a._templates=c.templates,a.offsetChecker=new _U25.DelayedTask({interval:150,fn:function(){this._checkOffset(),this.offsetChecker.start()},scope:_assertThisInitialized2(_assertThisInitialized2(a))}),a}return _inherits2(b,a),_createClass2(b,[{key:"activate",value:function(a){return this._toggle(a,!0)}},{key:"deactivate",value:function(a){return this._toggle(a,!1)}},{key:"isActive",value:function(){return this.__isActive===!0}},{key:"_toggle",value:function(a,b){var c=!1;return this.__isActive!==b&&(this.__isActive=b,c=this[b?"_onActivate":"_onDeactivate"](a)!==!1),c}},{key:"bindListView",value:function(a,b,c){this.el=a,this.contentEl=b,this.scrollBar=c,this.selectable&&this.contentEl.on("mousemove",this._onMouseMove,this),this.bound=!0}},{key:"unbindListView",value:function(){this.deactivate(),this.contentEl&&this.contentEl.un("mousemove",this._onMouseMove,this),this.scrollBar=this.contentEl=this.el=null,this.bound=!1}},{key:"_onUserScroll",value:function(a){}},{key:"setCheckpoint",value:function(a){var b=this;if(a){var c=this.el.getSelector("."+a);c&&(this._checkpointAnchors[a]||this._checkpointList.push(a),this._checkpointAnchors[a]=c,this._checkpointList.sort(function(a,c){return b._checkpointAnchors[a].dom.offsetTop>b._checkpointAnchors[c].dom.offsetTop?1:-1})),this._checkpoint(this.el&&this.el.dom.scrollTop||0)}}},{key:"resetCheckpoint",value:function(a){if(a){if(this._checkpointAnchors[a]){var b=this._checkpointList.indexOf(a);b>-1&&(this._nextCheckpointNum>b&&this._nextCheckpointNum--,this._checkpointList.splice(b,1)),delete this._checkpointAnchors[a],delete this._passedCheckpoints[a]}}else this._checkpointAnchors={},this._passedCheckpoints={},this._checkpointList=[],this._nextCheckpointNum=0}},{key:"_getNextPassedPoints",value:function(a){var b=this,c=[];return this._checkpointList.slice(this._nextCheckpointNum).some(function(d){if(d&&b._checkpointAnchors[d]){var e=b._checkpointAnchors[d].dom.offsetTop,f=a>=e;if(!f)return!0;c.push(d),b._passedCheckpoints[d]=f,b._nextCheckpointNum++}}),c}},{key:"_getPrevPassedPoints",value:function(a){var b=this,c=[];return this._checkpointList.slice(0,this._nextCheckpointNum).reverse().some(function(d){if(d&&b._checkpointAnchors[d]){var e=b._checkpointAnchors[d].dom.offsetTop,f=e>a;if(!f)return!0;c.push(d),delete b._passedCheckpoints[d],b._nextCheckpointNum--}}),c}},{key:"_checkpoint",value:function(a){var b=this._getNextPassedPoints(a);if(b.length)this.checkpointEvent.fire(!0,b,this._checkpointList[this._nextCheckpointNum-1],Object.keys(this._passedCheckpoints));else{var c=this._getPrevPassedPoints(a);c.length&&this.checkpointEvent.fire(!1,c,this._checkpointList[this._nextCheckpointNum-1],Object.keys(this._passedCheckpoints))}}},{key:"_checkOffset",value:function(){var a=this.el&&this.el.dom.scrollTop;if(this._checkpoint(a),this.watchNextPageCondition){var b=this.el.dom.scrollHeight-(a+this.el.dom.offsetHeight),c=this.el.dom.scrollHeight===this.el.dom.offsetHeight||200>b;c&&(this.watchNextPageCondition=!1,this.requestNextPageEvent.fire())}}},{key:"renderNextDataBundle",value:function(a,b){if(a){var c=0,d=this._selectedItem&&this._selectedItem.dom;if(d)for(;null!=(d=d.previousSibling);)c++;_U25.Array.each(a,function(a,b){var c=this._buildEntryHTML(a.entryType,a.entryData,b,this._currentEntryOffset);
_U25.DomHelper.append(this.contentEl.dom,c)},this),this.scrollBar.sync(),this.watchNextPageCondition=!b}}},{key:"_buildEntryHTML",value:function(a,b,c,d,e){var f,g,h,i="";return h=this._templates[a],h&&!this.itemTemplates[a]&&(this.itemTemplates[a]=new _UI24.TemplateRenderer,this.itemTemplates[a].setTemplate(h)),g=this.itemTemplates[a],f=this._buildEntryBundle(a,b,c,d,this,e),i="string"==typeof f?f:g.renderHTML(f)}},{key:"reset",value:function(){this.scrollUp(),this.deselect(),this.contentEl&&this.contentEl.updateText(""),this.watchNextPageCondition=!1,this.show()}},{key:"scrollUp",value:function(a){if(a){if(this.el){var b=this.el.getSelector("."+a);b&&(this.el.dom.scrollTop=b.dom.offsetTop+1)}}else this.el?this.el.dom.scrollTop=0:this.contentEl&&(this.contentEl.dom.scrollTop=0);this._checkpoint(this.el.dom.scrollTop),this.scrollBar&&this.scrollBar.sync()}},{key:"isVisible",value:function(){if((this.rendered||this.bound)&&this.el){var a=this.el.createChild({tag:"div",style:"visibility:hidden;width:1px;height:0px;"}),b=a.dom.offsetWidth;return a.remove(),!!b}}},{key:"show",value:function(){this.contentEl?this.contentEl.show():this.setVisible(!0),this.scrollBar.sync()}},{key:"hide",value:function(){this.contentEl?this.contentEl.hide():this.setVisible(!1),this.scrollBar.sync()}},{key:"deselect",value:function(){this._selectedItem&&(this._selectedItem.removeClass("im-list-entry_selected"),this._selectedItem=null)}},{key:"_findNextSelectableNode",value:function(a,b){for(;a;){if(a.getAttribute("data-selectable"))return a;a=b?a.prev():a.next()}return!1}},{key:"selectFirstItem",value:function(a){var b=this._findNextSelectableNode(this.contentEl&&this.contentEl.childAt(0));b&&this._selectItem(b,a)}},{key:"_selectItem",value:function(a,b){if(this.selectable&&!(this._selectedItem&&this._selectedItem.dom===a.dom||(this.deselect(),this._selectedItem=a,a.addClass("im-list-entry_selected"),b))){var c=this.contentEl.dom.offsetTop+a.dom.offsetTop+a.dom.offsetHeight-this.el.dom.offsetHeight;c>=0&&this.el.dom.scrollTop<c?this.el.dom.scrollTop=c:a.dom.offsetTop<this.el.dom.scrollTop&&(this.el.dom.scrollTop=a.dom.offsetTop+this.contentEl.dom.offsetTop),this.scrollBar.sync()}}},{key:"_applyItem",value:function(){if(this._selectedItem){var a=this.applyItemEvent.fire(this._selectedItem);return a&&this.deselect(),!0}return!1}},{key:"navigate",value:function(a){if(this.selectable){var b;switch(a){case"arrowUp":return this._selectedItem&&(b=this._findNextSelectableNode(this._selectedItem.prev(),!0),b&&this._selectItem(b,!1)),!0;case"arrowDown":return this._selectedItem?(b=this._findNextSelectableNode(this._selectedItem.next()),b?this._selectItem(b,!1):this.loopNavigation&&this.deselect()):this.selectFirstItem(),!0;case"enter":return this._applyItem()}return!1}}},{key:"_onMouseMove",value:function(a){var b=a.getTarget(!0).up("imSearchEntry");b&&b.getAttribute("data-selectable")&&this._selectItem(b,!0)}},{key:"_onActivate",value:function(a){this.bound&&(this._checkOffset(),this.selectable?this.selectFirstItem():this.scrollUp(),this.el.on("scroll",this._onUserScroll,this),this.contentEl&&this.offsetChecker.start())}},{key:"_onDeactivate",value:function(){this.watchNextPageCondition=!1,this.el.un("scroll",this._onUserScroll,this),this.bound&&this.offsetChecker.stop()}}]),b}(_UI24.ES6Component);_UI24.InfiniteListView=InfiniteListView,WebIM.namespace("WebIM.ui");var _WA31=WebIM,_UI25=_WA31.ui,_U26=_WA31.util,MyProfileBox=function(a){function b(){var a,c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck2(this,b),_WA31.applyIf(c,{title:_WA31.tr("profile.myProfile"),buttons:[{action:"signout",text:_WA31.tr("signOut")},{action:"ok",text:_WA31.tr("box.ok"),cls:"im-button_highlight"}],content:_WA31.TD.getTMPL("myProfileBox"),hideOnAction:!1,hideOnClick:!1,hideOnEscape:!1}),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,c)),a.changeAvatarEvent=new _U26.Event,a}return _inherits2(b,a),_createClass2(b,[{key:"_onShow",value:function(){_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),this.block.on("change",this._onChange,this),this._drawAvatar()}},{key:"_onHide",value:function(){this.changeAvatarEvent.removeAll(),this.block.un("change",this._onChange,this),this.block.getSelector(".imAvatarBox input").dom.value=null,_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this)}},{key:"_drawAvatar",value:function(){if(this.block){var a=_WA31.Ava.make(_WA31.ACTIVE_MAIL,null,100,this._drawAvatar.bind(this));if(a.remoteLoaded){var b=this.block.getSelector(".imAvatarBox");b.addClass("im-avatar-uploader_loaded"),b.first().updateHTML(a.html)}}}},{key:"_onChange",value:function(a){var b=a.getTarget(!0);b.up("imAvatarBox")&&b.dom.files&&this.changeAvatarEvent.fire(b.dom)}}]),b}(_UI25.EditNamesBox);_UI25.MyProfileBox=MyProfileBox,WebIM.namespace("WebIM.ui");var _WA32=WebIM,_UI26=_WA32.ui,_U27=_WA32.util,DEBUG_EMPTY_AVATAR=!1,StartProfile=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,{hideOnClick:!1,hideOnEscape:!1,blockCls:"im-start-profile"})),a.actionEvent=new _U27.Event,a.changeAvatarEvent=new _U27.Event,a}return _inherits2(b,a),_createClass2(b,[{key:"_getContentHtml",value:function(){return _WA32.TD.getTMPL("startProfileBox")}},{key:"_setValues",value:function(a){this.rendered&&(this.block.getSelector(".imField1").dom.value=a.lastname||"",this.nameInput=this.block.getSelector(".imField0"),this.nameInput.dom.value=a.firstname||"",this.nameInput.dom.select(),this.nameInput.dom.focus(),this._validateField())}},{key:"_checkName",value:function(){return(this.nameInput.dom.value||"").match(/\S/)}},{key:"_validateField",value:function(){this.block.getSelector(".imButton").setDisabled(!this._checkName())}},{key:"show",value:function(a){_get2(_getPrototypeOf2(b.prototype),"show",this).call(this),a&&this._setValues(a)}},{key:"_onShow",value:function(){this.el&&(this.block.dom.scrollTop=0,_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),this.el.setStyle({left:0,top:0,right:0,bottom:0}),this.nameInput=this.block.getSelector(".imField0"),this.nameInput.on("input",this._validateField,this),this.block.on("change",this._onChange,this),this.renderAvatar(),this.scrollBar=new _UI26.ScrollBar({source:this.block}),this.scrollBar.sync())}},{key:"_onHide",value:function(){this.scrollBar.destroy(),this.changeAvatarEvent.removeAll(),this.block.un("change",this._onChange,this),this.block.getSelector(".imAvatarBox input").dom.value=null,this.nameInput.un("input",this._validateField,this),_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this)}},{key:"renderAvatar",value:function(){if(this.block&&!DEBUG_EMPTY_AVATAR){var a=_WA32.Ava.make(_WA32.ACTIVE_MAIL,null,100,this.renderAvatar.bind(this));if(a.remoteLoaded){var b=this.block.getSelector(".imAvatarBox");b.addClass("im-avatar-uploader_loaded"),b.first().updateHTML(a.html)}}}},{key:"_onChange",value:function(a){var b=a.getTarget(!0);b.up("imAvatarBox")&&b.dom.files&&this.changeAvatarEvent.fire(b.dom)}},{key:"_onClick",value:function(a){var b,c=a.up("imButton"),d=c&&c.getAttribute("data-action");if("ok"===d){if(!this._checkName())return void this.nameInput.dom.focus();b={firstname:_U27.String.trim(this.nameInput.dom.value),lastname:_U27.String.trim(this.block.getSelector(".imField1").dom.value)}}this.actionEvent.fire(d,b)}},{key:"destroy",value:function(){this.changeAvatarEvent.removeAll(),this.actionEvent.removeAll(),this.actionEvent=null,_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI26.ModalComponent);_UI26.StartProfile=StartProfile,WebIM.namespace("WebIM.ui");var _WA33=WebIM,_UI27=_WA33.ui,_U28=_WA33.util,AudioHistogram=function(a){function b(a){return _classCallCheck2(this,b),_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a))}return _inherits2(b,a),_createClass2(b,[{key:"_onRender",value:function(a,b){this.el=a.createChild({tag:"canvas"}),this.ctx=this.el.dom.getContext("2d")}},{key:"draw",value:function(a,b,c){if(this.ctx&&this.el){var d=this.ctx,e=this.el.dom.offsetWidth,f=this.el.dom.offsetHeight;if(a){var g=this.initialConfig.barSize||2,h=this.initialConfig.barStep||2,i=g,j=g+1,k=Math.floor(e/(g+h));e=k*(g+h),this.el.dom.width=e,this.el.dom.height=f;var l=this.el.getStyle("color");d.clearRect(0,0,e,f);var m=0;b=_WA33.isNumber(b)?Math.max(0,b):e,a.length<k&&(a=new Array(k-a.length).fill(i/f).concat(a)),d.strokeStyle=l,d.lineCap="round",d.lineWidth=g,this.currentDrawData=a,this.currentPlayPos=b;for(var n,o,p=0;k>p;p++)o=Math.min(f*a[p]||j,f),n&&.5>o/n&&(o=.5*n),n=o,d.moveTo(m+g/2,f-g/2),d.lineTo(m+g/2,f-(o-g/2)),d.stroke(),m+=g+h;e>b&&(d.globalCompositeOperation="source-atop",d.fillStyle=this.el.getStyle("border-bottom-color"),d.fillRect(b,0,e-b,f),d.globalCompositeOperation="source-over")}else if(c){this.el.dom.width=e,this.el.dom.height=f;var q=this.el.getStyle("color");b=_WA33.isNumber(b)?Math.max(0,b):e,d.clearRect(0,0,e,f),d.fillStyle=q,d.fillRect(0,0,b,f)}this.currentDrawData=a,this.currentPlayPos=b,this.currentSimple=c}}},{key:"clear",value:function(){this.ctx&&this.el&&this.ctx.clearRect(0,0,this.el.dom.width,this.el.dom.height),this.currentDrawData=null,this.currentPlayPos=null,this.currentSimple=null}},{key:"redraw",value:function(){this.ctx&&this.el&&this.draw(this.currentDrawData,this.currentPlayPos,this.currentSimple)}},{key:"destroy",value:function(){delete this.ctx,_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI27.ES6Component);_UI27.AudioHistogram=AudioHistogram,WebIM.namespace("WebIM.ui");var _WA34=WebIM,_TD10=_WA34.TemplateDriver,_UI28=_WA34.ui,_U29=_WA34.util,IncomingCallBox=function(a){function b(a){var c;return _classCallCheck2(this,b),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,{autoRender:!0})),c.data=a,c.actionEvent=new _U29.Event,c}return _inherits2(b,a),_createClass2(b,[{key:"_onRender",value:function(a){this.el=a.createChild({tag:"div",cls:"im-box-incomingcall",style:"display:none"});var b=_TD10.parseSafe("incomingCallBox",{avatarHtml:_WA34.Ava.make(this.data.sn,this.data.friendly,300),friendly:_WA34.Emoji.parse(_U29.String.htmlEntity(this.data.friendly||this.data.sn))},{safeKeys:["avatarHtml","friendly"]});this.el.updateHTML(b)}},{key:"_onClick",value:function(a){var b=a.getTarget(!0).up("imButton"),c=b&&b.getAttribute("data-action");c&&(this.actionEvent&&this.actionEvent.fire(c),this.hide())}},{key:"_onShow",value:function(){this.el&&(this.el&&this.el.on("click",this._onClick,this),_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this))}},{key:"_onHide",value:function(){this.el&&this.el.un("click",this._onClick,this)}},{key:"destroy",value:function(){this.actionEvent.removeAll(),this.actionEvent=null,_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI28.ES6Component);_UI28.IncomingCallBox=IncomingCallBox,WebIM.namespace("WebIM.ui");var _WA35=WebIM,_TD11=_WA35.TemplateDriver,_UI29=_WA35.ui,OfflineBox=function(a){function b(a){var c;_classCallCheck2(this,b);var d=_TD11.parseSafe("offlineBox",{avatar:_WA35.Ava.make(_WA35.ACTIVE_MAIL,_WA35.DialogsAbstraction.nick,80)},{safeKeys:["avatar"]});return c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,{hideOnClick:!1,hideOnEscape:!1,blockCls:"im-offline-box",content:d,buttons:[{action:"signout",text:_WA35.tr("signOut"),cls:"im-auth-button-blank"}]})),c.actionEvent.on(a),c}return _inherits2(b,a),b}(_UI29.ConfirmModalBox);_UI29.OfflineBox=OfflineBox,WebIM.namespace("WebIM.ui");var _WA36=WebIM,_UI30=_WA36.ui,_TD12=_WA36.TemplateDriver,_U30=_WA36.util,_DomUtil19=_WA36.DomUtil,DEBUG_UI=!1,CONTROLS_AUTOHIDE_TIMEOUT=2500,CALL_ENDED_HIDE_TIMEOUT=1500,SCREEN_TRANSITION_TIMEOUT=200,STREAM_AVATAR_SIZE={split:400,master:178,slave:92},SCREEN_MODE={split:"split",full:"full",mini:"mini"},SCREEN_LAYOUT={SPLIT:"split",FULL:"full"},_stopEvent3=function(a){_WA36.isIOS&&a.stopEvent()},_stopPropagation2=function(a){_WA36.isIOS&&a.stopPropagation()},formatDuration=function(a){var b=Math.floor(a/60),c=a%60;return(b>9?b:"0"+b)+":"+(c>9?c:"0"+c)},StreamBox=function(){function a(b){_classCallCheck2(this,a);var c=b.sn;this.state={sn:c,friendly:b.friendly,local:c===_WA36.ACTIVE_MAIL,rendered:!1}}return _createClass2(a,[{key:"render",value:function(a){this.el=a.insertFirst(this.createDom())}},{key:"getEl",value:function(){return this.el||(this.el=_DomUtil19.get(this.createDom())),this.el}},{key:"createDom",value:function(){var a=this.state.sn,b=_WA36.Emoji.parse(_U30.String.htmlEntity(this.state.friendly||a)),c=_TD12.parseSafe("voipStreamBox",{sn:a,sid:"",avatarHtml:_WA36.Ava.make(a,this.state.friendly,400),cls:this.state.local?"im-stream_me":"",muted:!!this.state.local,friendly:this.state.local?_WA36.tr("me"):b,status:""},{safeKeys:["avatarHtml","friendly"]});return _U30.DomHelper.elementFromHtml(c)}},{key:"addStream",value:function(a,b){var c=this.el.getSelector("video").dom,d=this.el.getSelector("audio").dom;c.muted=!0,c.srcObject=a,d.muted=this.state.local||!b,this.state.local||(d.srcObject=a)}},{key:"toggleVideo",value:function(a){this.el.getSelector("video").setVisible(a),this.toggleLive(a)}},{key:"toggleLive",value:function(a){this.el.toggleClass("im-stream_live",a)}},{key:"toggleMaster",value:function(a){this.el.toggleClass("im-stream_master",a)}},{key:"updateStateTitle",value:function(a){this.el.getSelector(".imStreamStatus").updateText(a)}},{key:"updateSpeakerState",value:function(a){var b=this.el.getSelector("video").dom,c=this.el.getSelector("audio").dom;b.muted=!0,c.muted=!a}},{key:"updateAvatar",value:function(a){var b=_WA36.Ava.make(this.state.sn,this.state.friendly,STREAM_AVATAR_SIZE[a]);this.el.getSelector(".im-stream__avatar").updateHTML(b)}},{key:"remove",value:function(){this.el&&(this.el.remove(),this.el=null)}}]),a}(),Carousel=function(){function a(b){_classCallCheck2(this,a),this.MAX_VISIBLE_ITEMS=4,this.ITEM_HEIGHT=66,this.ITEM_HEIGHT_WITH_MARGIN=this.ITEM_HEIGHT+8,this.ITEM_WIDTH=58,this.el=b.getSelector(".imBoxCarousel"),this.scrollBox=this.el.getSelector(".imBoxCarouselItems"),this.slideUp=this.el.getSelector(".imButton[data-action=slideUp]"),this.slideDown=this.el.getSelector(".imButton[data-action=slideDown]"),this.el.on("click",this._onCarouselClick,this),this.scrollBox.on("wheel",this._onCarouselWheel,this)}return _createClass2(a,[{key:"_onCarouselClick",value:function(a){var b=a.getTarget(!0),c=b.up("imButton"),d=c&&c.getAttribute("data-action");b.up("imStream");("slideUp"===d||"slideDown"===d)&&(this._slide("slideDown"===d),a.stopPropagation())}},{key:"_onCarouselWheel",value:function(a){var b=a.browserEvent,c=(a.getTarget(),b.deltaY);b.deltaX&&Math.abs(b.deltaX)>Math.abs(c)&&(c=b.deltaX),0!==c&&(console.log("###_onCarouselWheel",this.scrollBox.dom.scrollTop,(c>0?1:-1)*this.ITEM_HEIGHT_WITH_MARGIN),this._slideBy((c>0?1:-1)*this.ITEM_HEIGHT_WITH_MARGIN,!0)),a.stopEvent()}},{key:"_slide",value:function(a){var b=this.MAX_VISIBLE_ITEMS*this.ITEM_HEIGHT_WITH_MARGIN*(a?1:-1);this._slideBy(b)}},{key:"_slideBy",value:function(a,b){var c=this;if(this.scrollBox.dom.offsetHeight<this.scrollBox.dom.scrollHeight){var d=this.scrollBox.dom.scrollTop,e=Math.min(Math.max(d+a,0),this.scrollBox.dom.scrollHeight-this.scrollBox.dom.offsetHeight);console.log("###_slife",d,e),b?(this.scrollBox.dom.scrollTop=e,this._updateButtonState()):_U30.animation.start(d,e,Math.abs((e-d)/(b?50:200)),function(a){c.scrollBox.dom.scrollTop=Math.round(a),console.log("###animate",c.scrollBox.dom.scrollTop,a),c._updateButtonState()})}}},{key:"_updateButtonState",value:function(){var a=this.scrollBox.dom.scrollTop,b=this.scrollBox.dom.childNodes.length;console.log("###_updateButtonState",b,0===a,a+this.scrollBox.dom.offsetHeight>=this.scrollBox.dom.scrollHeight),this.slideUp.setVisible(b>this.MAX_VISIBLE_ITEMS),this.slideUp.setDisabled(0===a),this.slideDown.setVisible(b>this.MAX_VISIBLE_ITEMS),this.slideDown.setDisabled(a+this.scrollBox.dom.offsetHeight>=this.scrollBox.dom.scrollHeight)}},{key:"addItem",value:function(a){this._setItemDimensions(a),this.scrollBox.insertBefore(a,this.scrollBox.first().next()),this._updateButtonState()}},{key:"_setItemDimensions",value:function(a){a.setStyle({width:this.ITEM_WIDTH+"px",height:this.ITEM_HEIGHT+"px"})}},{key:"rearrange",value:function(){this._updateButtonState()}},{key:"destroy",value:function(){this.el.un("click",this._onCarouselClick,this),this.scrollBox.un("wheel",this._onCarouselWheel,this),this.scrollBox=null,this.el=null}}]),a}(),SplitLayout=function(){function a(b){_classCallCheck2(this,a),this.el=b.getSelector(".imVoipLayout"),this.singleItemMode=!0,this.itemCount=0,this.itemWidth=200,this.itemHeight=112,this.ITEM_MARGIN=6,this.SPACE_WIDTH=780,this.SPACE_PADDING=20,this.ITEM_RATIO=16/9,this.COMPACT_ITEM_WIDTH=240}return _createClass2(a,[{key:"addItem",value:function(a){this.el.appendChild(a),this.rearrange(),this._setItemDimensions(a)}},{key:"rearrange",value:function(a){var b=!1,c=this.el.dom.childNodes,d=c.length;if((this.itemCount!==d||a)&&(b=!0,this.itemCount=d,d>1)){var e=Math.round(Math.sqrt(d)),f=Math.ceil(d/e),g=this.el.getWidth()-this.SPACE_PADDING,h=this.el.getHeight()-this.SPACE_PADDING,i=Math.floor(g/f),j=i-2*this.ITEM_MARGIN,k=Math.round(j/this.ITEM_RATIO);e*(k+2*this.ITEM_MARGIN)>h&&(k=Math.floor(h/e)-2*this.ITEM_MARGIN,j=Math.round(k*this.ITEM_RATIO)),this.itemWidth=j,this.itemHeight=k,this.el.toggleClass("im-voip__compact-items",j<this.COMPACT_ITEM_WIDTH)}if(this.singleItemMode=1===d,this.el.toggleClass("im-voip__layout_single",this.singleItemMode),b)for(var l=0;d>l;l++)this._setItemDimensions(_DomUtil19.get(c[l]))}},{key:"_setItemDimensions",value:function(a){this.itemCount<2?a.setStyle({width:"",height:""}):a.setStyle({width:this.itemWidth+"px",height:this.itemHeight+"px"})}},{key:"destroy",value:function(){this.el=null}}]),a}(),LayoutManager=function(){function a(){_classCallCheck2(this,a),this.state={layout:null,masterSn:null},this.items=[],this.boxes={},this.toggleEvent=new _U30.Event}return _createClass2(a,[{key:"init",value:function(a){this.el=a,this.carousel=new Carousel(a),this.splitLayout=new SplitLayout(a)}},{key:"onResize",value:function(){this.el&&this.splitLayout.rearrange(!0)}},{key:"_transitionStreams",value:function(a){var b=this,c=this.state.masterSn;this.state.masterSn=a,this.boxes[a].el.addClass("im-stream_fadeout"),this.el.addClass("im-voip_mode-transition"),_WA36.setTimeout(function(){c&&(b.boxes[c].toggleMaster(!1),b.carousel.addItem(b.boxes[c].getEl()),b.boxes[c].updateAvatar("slave")),b.boxes[a].el.removeClass("im-stream_fadeout"),b.boxes[a].toggleMaster(!0),b.splitLayout.addItem(b.boxes[a].getEl()),b.boxes[a].updateAvatar("master"),b._updateAvatars(),b.el.removeClass("im-voip_mode-transition")},SCREEN_TRANSITION_TIMEOUT)}},{key:"toggle",value:function(a,b){var c=this;return a===SCREEN_LAYOUT.FULL&&this.state.layout===a?this._transitionStreams(b):(this.state.masterSn&&this.boxes[this.state.masterSn].toggleMaster(!1),a===SCREEN_LAYOUT.FULL?(this.state.masterSn=b,this.boxes[b].toggleMaster(!0),this.items.forEach(function(a){a!==b&&c.carousel.addItem(c.boxes[a].getEl())}),this.splitLayout.rearrange()):a===SCREEN_LAYOUT.SPLIT&&(this.items.forEach(function(a){c.splitLayout.addItem(c.boxes[a].getEl())}),this.splitLayout.rearrange(),this.state.masterSn=null),this.el.removeClass("im-voip_layout-"+this.state.layout).addClass("im-voip_layout-"+a),this.state.layout=a,this._updateAvatars(),void this.toggleEvent.fire(a))}},{key:"isMaster",value:function(){return this.state.layout===SCREEN_LAYOUT.FULL}},{key:"_updateAvatars",value:function(){var a=this,b=null,c="split";this.state.layout===SCREEN_LAYOUT.FULL&&(b=this.state.masterSn,c="slave"),this.items.forEach(function(d){var e=d===b?"master":c;a.boxes[d].updateAvatar(e)})}},{key:"addBox",value:function(a){console.log("###LM.addBox",a),this.items.push(a.state.sn),this.boxes[a.state.sn]=a,this.state.layout===SCREEN_LAYOUT.FULL?this.carousel.addItem(a.getEl()):this.splitLayout.addItem(a.getEl())}},{key:"removeBox",value:function(a){a===this.state.masterSn,_U30.Array.remove(this.items,a),delete this.boxes[a],this.splitLayout.rearrange(),this.carousel.rearrange()}},{key:"destroy",value:function(){this.carousel.destroy()}}]),a}(),VoipCallBox=function(a){function b(){var a;_classCallCheck2(this,b);var c={autoRender:!0,displayFlex:!0,hideOnEscape:!1};return a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,c)),a.state={streamSn:[],fullscreen:!1,masterStream:0,masterSn:null,minimized:!1,micMuted:!1,speakerOn:!0,speakerVolume:0,video:!1,talkTs:0,sleep:!1},a.layoutManager=new LayoutManager,a.layoutManager.toggleEvent.on(a._onLayoutToggle,_assertThisInitialized2(_assertThisInitialized2(a))),a.localSn=_WA36.ACTIVE_MAIL,a.callState=null,a.streamBox={},a.userData={},a.autohideTimer=0,a.actionEvent=new _U30.Event,a.durationUpdate=new _U30.DelayedTask({interval:1e3,fn:a._updateDuration,scope:_assertThisInitialized2(_assertThisInitialized2(a))}),a}return _inherits2(b,a),_createClass2(b,[{key:"_onRender",value:function(a){this.el=a.createChild(_WA36.TD.getTMPL("voipCallBox").replace(/\n+/g,"").replace(/(?:^\s+|\s+$)/g,""))}},{key:"_onShow",value:function(){var a=this;if(this.rendered){if(this.container.addClass("im-overlay"),this.videoWrap=this.el.getSelector(".imVoipBox"),this.layoutManager.init(this.videoWrap),this.state.streamSn.forEach(function(b,c){a.layoutManager.addBox(a.streamBox[b])}),this._isP2PCall()){var b=this.state.streamSn[1],c=_U30.String.htmlEntity(this.userData[b].friendly||b);this.videoWrap.getSelector(".imVoipName").updateHTML(c)}this._updateStateText(null),_WA36.setTimeout(this._setHandlers,1,this),this.layoutManager.toggle("full",this.localSn)}}},{key:"_isP2PCall",value:function(){return 2===this.state.streamSn.length}},{key:"_updateStateText",value:function(a){var b=a?_WA36.tr(a):"";this._isP2PCall()&&this.streamBox[this.state.streamSn[1]].updateStateTitle(b),this.videoWrap.getSelector(".imVoipStatus").updateText(b)}},{key:"_onUserGesture",value:function(){this.state.sleep&&this._wakeUp(),clearTimeout(this.autohideTimer),this.autohideTimer=_WA36.setTimeout(this._wakeDown,CONTROLS_AUTOHIDE_TIMEOUT,this)}},{key:"_wakeUp",value:function(){this.state.sleep=!1,this.videoWrap.removeClass("im-voip-autohide")}},{key:"_wakeDown",value:function(){DEBUG_UI||this.state.minimized||(this.state.sleep=!0,this.videoWrap.addClass("im-voip-autohide"))}},{key:"_updateDuration",value:function(){var a=_WA36.now(),b=a-this.state.talkTs,c=this.videoWrap.getSelector(".imVoipDuration").setStyle("display","block");c.updateText(formatDuration(b)),this.durationUpdate.start()}},{key:"removeUser",value:function(a){var b=this.state.streamSn.indexOf(a);b>-1&&(this.state.streamSn.splice(b,1),this.layoutManager.removeBox(a),this.streamBox[a]&&(this.streamBox[a].remove(),delete this.streamBox[a]))}},{key:"addUser",value:function(a,b){console.log("...Adding user ",a,-1===this.state.streamSn.indexOf(a)),-1===this.state.streamSn.indexOf(a)&&(this.state.streamSn.push(a),this.streamBox[a]=new StreamBox({sn:a,friendly:b.friendly}),this.rendered&&this.layoutManager.addBox(this.streamBox[a]),this.userData[a]={friendly:b.friendly})}},{key:"addStream",value:function(a,b){this.streamBox[a].addStream(b,this.state.speakerOn)}},{key:"onCallStateUpdated",value:function(a){var b=this;if(this.callState||(this.callState=_U30.Object.clone(a)),this.el&&this.rendered){var c=null,d=a.p2p_peer().ringing_received;a.is_outgoing&&(a.inviting_state===_WA36.Voip.InvitingState.INIT||a.inviting_state===_WA36.Voip.InvitingState.ALLOCATING||a.inviting_state===_WA36.Voip.InvitingState.CALLING&&!d)&&(c="calls.connecting"),a.is_outgoing&&a.inviting_state===_WA36.Voip.InvitingState.CALLING&&d&&(c="calls.calling"),this._updateStateText(c),this.callState.inviting_state!==_WA36.Voip.InvitingState.ACCEPTED&&a.inviting_state===_WA36.Voip.InvitingState.ACCEPTED&&(this.state.talkTs=_WA36.now(),this.toggleLayoutOnConnected(),this._updateDuration());var e=!!a.local_media_status.sender_state.sending_video;this.streamBox[this.localSn].toggleVideo(e);var f=!a.local_media_status.sender_state.sending_audio;this.videoWrap.getSelector(".imButton[data-action=muteMic]").toggleClass("im-voip-button_activated",f);var g=!!a.local_media_status.sender_state.sending_video;this.videoWrap.getSelector(".imButton[data-action=toggleVideo]").toggleClass("im-voip-button_activated",g),this.state.streamSn.forEach(function(c,d){var e=a.find_peer(c);if(e){var f=e.media_status.connected&&e.media_status.sender_state.sending_video;b.streamBox[c].toggleLive(f)}}),this.callState=_U30.Object.clone(a)}}},{key:"toggleLayoutOnConnected",value:function(){this._isP2PCall()?this.layoutManager.toggle("full",this.state.streamSn[1]):this.layoutManager.toggle("split")}},{key:"_onLayoutToggle",value:function(a){var b=this;a===SCREEN_LAYOUT.SPLIT?_WA36.setTimeout(function(){b.videoWrap.on("dblclick",b._onDblClick,b)},SCREEN_TRANSITION_TIMEOUT):this.videoWrap.un("dblclick",this._onDblClick,this)}},{key:"toggleMinimized",value:function(a){this.state.minimized=a,a?(this.toggleFullscreen(!1),_UI30.dragObject.makeFly(this.el,{restrictedSpace:!0,cleanPositionOnExit:!0,checkDragAvailable:function(a){return!a.up("imButton")}})):_UI30.dragObject.stopFly(this.el),this.container.toggleClass("im-overlay",!a),this.el.toggleClass("im-voip_minimized",a)}},{key:"toggleFullscreen",value:function(a){_WA36.RTCTools.toggleFullscreenMode(this.videoWrap.dom,a)}},{key:"updateAllSpeakerMuteState",value:function(){var a=this;this.state.streamSn.forEach(function(b,c){b!==a.localSn&&a.streamBox[b].updateSpeakerState(a.state.speakerOn)})}},{key:"_onStreamClick",value:function(a,b){var c=a.getAttribute("data-sn");console.log("###_on Stream Click",this.state.masterSn,c),this.layoutManager.isMaster()&&!b?this.layoutManager.toggle(this.state.masterSn===c?"split":"full",c):b&&this.layoutManager.toggle("full",c)}},{key:"_onDblClick",value:function(a){var b=a.getTarget(!0),c=b.up("imStream");c&&this._onStreamClick(c,!0)}},{key:"_onContainerClick",value:function(a){if(!this.state.minimized){if("mousedown"===a.type)return;a.stopPropagation()}var b=a.getTarget(!0),c=b.up("imButton"),d=b.up("imStream"),e=c&&c.getAttribute("data-action"),f=c&&c.hasClass("im-voip-button_activated"),g=!0;if(console.log("###_onContainerClick",this.videoWrap.contains(b),d),!this.videoWrap.contains(b)){if(console.log("###OUTER CLICK:",!!b.up("imVoipBoxWrap")),!b.up("imVoipBoxWrap"))return;e="minimize"}switch(e){case"addUser":break;case"goFull":this.layoutManager.toggle("full",d.getAttribute("data-sn"));break;case"exitFull":this.layoutManager.toggle("split");break;case"fullscreen":this.toggleFullscreen();break;case"muteSpeaker":c.toggleClass("im-voip-button_activated"),this.state.speakerOn=!f,this.updateAllSpeakerMuteState();break;case"hangup":case"muteMic":break;case"volume":break;case"maximize":this.toggleMinimized(!1);break;case"settings":this.toggleMinimized(!0),_WA36.ma.openSettingsPanel("settingsPaneMedia");break;case"minimize":this.toggleMinimized(!0);break;case"security":console.log("###security click");break;case"menu":g=!1,this.videoWrap.getSelector(".imButtonMenu").toggle();break;default:d?this._onStreamClick(d):!e&&this.layoutManager.isMaster()&&this.layoutManager.toggle("split")}g&&this.videoWrap.getSelector(".imButtonMenu").hide(),e&&this.actionEvent.fire(e,f)}},{key:"_onResize",value:function(){this.layoutManager.onResize()}},{key:"_setHandlers",value:function(){this.container&&this.container.on("click",this._onContainerClick,this),this.el&&this.el.on(["scroll","touchmove"],_stopEvent3).on("mousedown",_stopPropagation2),this.videoWrap.on(["scroll","touchmove"],_stopPropagation2),this.videoWrap.on(["click","mousemove"],this._onUserGesture,this),_DomUtil19.fly(window).on("resize",this._onResize,this)}},{key:"_removeAllHandlers",value:function(){_DomUtil19.fly(window).un("resize",this._onResize,this),this.videoWrap.un(["click","mousemove"],this._onUserGesture,this),this.videoWrap.un("dblclick",this._onDblClick,this),this.container&&this.container.un("click",this._onContainerClick,this),this.videoWrap.un(["scroll","touchmove"],_stopPropagation2),this.el&&this.el.un(["scroll","touchmove"],_stopEvent3).un("mousedown",_stopPropagation2)}},{key:"hide",value:function(){DEBUG_UI||_get2(_getPrototypeOf2(b.prototype),"hide",this).call(this)}},{key:"_onHide",value:function(){this.el&&(this._removeAllHandlers(),this.container.removeClass("im-overlay"),this.destroy())}},{key:"delayedHide",value:function(){this._hideTimer||(this._hideTimer=_WA36.setTimeout(this.hide,CALL_ENDED_HIDE_TIMEOUT,this))}},{key:"freeze",value:function(){if(!DEBUG_UI){for(var a=this.videoWrap.dom.querySelectorAll("video"),b=0,c=a.length;c>b;b++)a[b].pause();this._removeAllHandlers(),this.durationUpdate.stop(),this.videoWrap.addClass("im-voip_finished"),this.delayedHide()}}},{key:"destroy",value:function(){this.layoutManager.destroy(),this._removeAllHandlers(),this.durationUpdate.stop(),this.actionEvent.removeAll(),this.actionEvent=null,_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI30.ES6Component);_UI30.VoipCallBox=VoipCallBox,WebIM.namespace("WebIM.ui");var _WA37=WebIM,_UI31=_WA37.ui,_DomUtil20=_WA37.DomUtil,DragObject=function(){function a(){_classCallCheck2(this,a),this.state={}}return _createClass2(a,[{key:"makeFly",value:function(a,b){this.state.el=a,this.state.restrictedSpace=!!b.restrictedSpace,this.state.cleanPositionOnExit=!!b.cleanPositionOnExit,this.state.checkDragAvailable=b.checkDragAvailable||function(){return!0},a.on(["mousedown"],this._onMouseDown,this)}},{key:"stopFly",value:function(a){a===this.state.el&&(this.state.el.un(["mousedown"],this._onMouseDown,this),this._release(),this.state.cleanPositionOnExit&&this.state.el.setStyle({top:"",left:"",right:"",bottom:""}),delete this.state.el)}},{key:"_onMouseDown",value:function(a){var b=a.getTarget(!0);this.state.checkDragAvailable(b)&&(a.stopEvent(),this._capture(a.pageX,a.pageY))}},{key:"_onMouseMove",value:function(a){var b=this.state.offsetPos[0]+a.pageX,c=this.state.offsetPos[1]+a.pageY,d=this.state.offsetLimits;d&&(b=Math.min(Math.max(b,d.min[0]),d.max[0]),c=Math.min(Math.max(c,d.min[1]),d.max[1])),this.state.el.setStyle({top:c+"px",left:b+"px"})}},{key:"_capture",value:function(a,b){var c=this.state.el,d=c.offset(),e=d.left,f=d.top,g=c.getSize(),h=c.parent().getSize(),i=5;this._release(),c.setStyle({top:f+"px",left:e+"px",right:"auto",bottom:"auto"}),this.state.captured=!0,this.state.offsetPos=[e-a,f-b],this.state.restrictedSpace&&(this.state.offsetLimits={min:[i,i],max:[h.width-g.width-i,h.height-g.height-i]}),_DomUtil20.getBody().addClass("im-grab-cursor"),_DomUtil20.getDoc().on(["mouseup"],this._release,this),_DomUtil20.getDoc().on(["mousemove"],this._onMouseMove,this)}},{key:"_release",value:function(){_DomUtil20.getBody().removeClass("im-grab-cursor"),_DomUtil20.getDoc().un(["mouseup"],this._release,this),_DomUtil20.getDoc().un(["mousemove"],this._onMouseMove,this),this.state.captured&&(this.state.captured=!1)}}]),a}();_UI31.dragObject=new DragObject,WebIM.namespace("WebIM.ui");var _WA38=WebIM,_UI32=_WA38.ui,_DomUtil21=_WA38.DomUtil,DragItems=function(){function a(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck2(this,a),this.container=b.container,this.dragButtonClass=b.dragButtonClass,this.dragItemClass=b.dragItemClass,this.capturedItem=null,this.container.addClass("im-grab-item-container"),this.container.on("mousedown",this._onMouseDown,this).on("touchstart",this._onMouseDown,this)}return _createClass2(a,[{key:"_onMouseDown",value:function(a){var b=a.getTarget(!0),c=a.browserEvent,d=b.up(this.dragButtonClass)&&b.up(this.dragItemClass),e=c.changedTouches&&c.changedTouches[0]&&parseInt(c.changedTouches[0].pageY);d&&(a.stopEvent(),this._captureItem(d,a.pageY||e))}},{key:"_onMouseMove",value:function(a){var b=a.browserEvent,c=b.changedTouches&&b.changedTouches[0]&&parseInt(b.changedTouches[0].pageY),d=(a.pageY||c)-this.mouseStartY,e=this.itemStartY+d;
this.grabbingItem.setStyle("top",e+"px"),this.upperTrigger&&d<this.upperTrigger?this._swapItems(!0):this.lowerTrigger&&d>this.lowerTrigger&&this._swapItems(!1)}},{key:"_updateTriggers",value:function(){var a=this.capturedItem.prev(),b=this.capturedItem.next();this.upperTrigger=a?-Math.ceil(a.dom.offsetHeight/2):null,this.lowerTrigger=b&&!b.hasClass("imOptionGrabbing")?Math.ceil(b.dom.offsetHeight/2):null}},{key:"_captureItem",value:function(a,b){var c=a&&a.dom;this._releaseItem(),this.capturedItem=a,this.parentContainerScroll=this.container.parent().dom.scrollTop,this.mouseStartY=b,this.itemStartY=c.offsetTop,this.itemHeight=c.offsetHeight,this.grabbingItem=_DomUtil21.fly(c.cloneNode(!0)),this._updateTriggers(),this.capturedItem.addClass("im-grab-item-original"),this.grabbingItem.addClass("imOptionGrabbing").addClass("im-grab-item-grabbing").setStyle("top",this.itemStartY+"px").appendTo(this.container),_DomUtil21.getBody().addClass("im-grab-cursor"),_DomUtil21.getDoc().on("mouseup",this._releaseItem,this).on("touchend",this._releaseItem,this),_DomUtil21.getDoc().on("mousemove",this._onMouseMove,this).on("touchmove",this._onMouseMove,this)}},{key:"_swapItems",value:function(a){var b=a?this.capturedItem.prev():this.capturedItem.next().next();b&&this.container.insertBefore(this.capturedItem,b);var c=this.capturedItem.dom.offsetTop-this.itemStartY;this.itemStartY+=c,this.mouseStartY+=c,this.container.parent().dom.scrollTop=this.parentContainerScroll,this._updateTriggers()}},{key:"_releaseItem",value:function(){_DomUtil21.getBody().removeClass("im-grab-cursor"),_DomUtil21.getDoc().un("mousemove",this._onMouseMove,this).un("touchmove",this._onMouseMove,this),_DomUtil21.getDoc().un("mouseup",this._releaseItem,this).un("touchend",this._releaseItem,this),this.capturedItem&&(this.capturedItem.removeClass("im-grab-item-original"),this.grabbingItem.remove(),this.grabbingItem=null,this.capturedItem=null)}},{key:"destroy",value:function(){this.container.un("mousedown",this._onMouseDown,this),this._releaseItem(),delete this.container}}]),a}();_UI32.DragItems=DragItems;var _WA39=WebIM,_U31=_WA39.util,FORCE_HEAP_STORAGE=_WA39.boardMode,AbstractStorage=function(){function a(){_classCallCheck2(this,a),this._prefix="_AIM_",this.brokenEvent=new _U31.Event}return _createClass2(a,[{key:"load",value:function(a){}},{key:"save",value:function(a,b){}},{key:"remove",value:function(a){}},{key:"clear",value:function(){}}]),a}(),LocalStorage=function(a){function b(){var a;_classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this));try{var c=Math.random(),d="lcVerify"+c;localStorage.setItem(d,c);var e=localStorage.getItem(d);e!=c&&_U31.Mnt.flog("lcVerify2","local value: "+c+" storage value: "+e),localStorage.removeItem(d),localStorage.removeItem("lcVerify")}catch(f){a.broken=!0,_U31.Mnt.flog("lcVerify2","error: "+f)}return a._preventiveCleanup=3,a}return _inherits2(b,a),_createClass2(b,[{key:"load",value:function(a){try{return localStorage[this._prefix+a]||""}catch(b){return""}}},{key:"save",value:function(a,b){a=this._prefix+a;var c;try{c=localStorage[a]}catch(d){}try{this._preventiveCleanup||localStorage.removeItem(a),localStorage[a]=b}catch(e){try{localStorage.removeItem(a),localStorage[a]=b,this._preventiveCleanup&&this._preventiveCleanup--}catch(e){c&&(localStorage[a]=c)}throw this.brokenEvent.fire("localStorage",a,b),"Writing failed"}}},{key:"remove",value:function(a,b){a=this._prefix+a;try{localStorage.removeItem(a)}catch(c){try{localStorage[a]=""}catch(d){}throw c}}},{key:"clear",value:function(a){try{localStorage.clear()}catch(b){}a()}}]),b}(AbstractStorage),Cookie=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a._localData={},a._expires=0,a}return _inherits2(b,a),_createClass2(b,[{key:"_getKey",value:function(a){return encodeURIComponent(this._prefix+a)}},{key:"_setCookie",value:function(a,b,c,d,e,f){b=encodeURIComponent(b),document.cookie=a+"="+b+(c?"; expires="+new Date(c).toUTCString():"")+(d?"; path="+d:"")+(e?"; domain="+e:"")+(f?"; secure":""),this._localData[a]=b}},{key:"load",value:function(a){var b=(""+document.cookie).match(new RegExp(this._getKey(a)+"=([^;]+)"));return decodeURIComponent((b||[0,""])[1]||this._localData[this._getKey(a)]||"")}},{key:"save",value:function(a,b){this._setCookie(this._getKey(a),b,this._expires)}},{key:"remove",value:function(a){this._setCookie(this._getKey(a),"",+new Date-31536e3)}},{key:"each",value:function(a,b){var c=this;(""+document.cookie).replace(new RegExp(this._prefix+"([^=]+)=([^;]*)","g"),function(c,d,e){a.call(b||window,decodeURIComponent(e),d)}),Object.keys(this._localData).forEach(function(d){a.call(b||window,decodeURIComponent(c._localData[d]),d)})}},{key:"clear",value:function(a){var b=this;this.each(function(a,c){b.remove(c)})}}]),b}(AbstractStorage),Heap=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a._store={},a}return _inherits2(b,a),_createClass2(b,[{key:"load",value:function(a){return this._store[a]||""}},{key:"save",value:function(a,b){this._store[a]=b,this._unCookie(a)}},{key:"remove",value:function(a){this._store[a]=null,delete this._store[a]}},{key:"clear",value:function(a){this._store={},a()}},{key:"_unCookie",value:function(a){document.cookie=encodeURIComponent(this._prefix+a)+"=; expires=Thu, 01 Jan 1970 00:00:01 GMT"}}]),b}(AbstractStorage),instances={},engineList={localStorage:LocalStorage,cookie:Cookie,heap:Heap},getStorageProvider=function(a){return instances[a]||(instances[a]=new engineList[a]),instances[a]},isStorageProviderType=function(a,b){return instances[b]===a},brokenStorageEvent=new _U31.Event,Storage=function(){function a(){_classCallCheck2(this,a),this.brokenStorages={},FORCE_HEAP_STORAGE?this.storage=getStorageProvider("heap"):(this.storage=getStorageProvider("localStorage"),this.storage.broken&&(this.storage=getStorageProvider("cookie"),this.brokenStorages.localStorage=!0)),this.storage.brokenEvent.on(this._onBrokenStorage.bind(this))}return _createClass2(a,[{key:"init",value:function(){}},{key:"forceHeapStorage",value:function(){this.storage=getStorageProvider("heap")}},{key:"_onBrokenStorage",value:function(a,b,c){"localStorage"===a&&brokenStorageEvent.fire(b,c)}},{key:"_processLoadSuccess",value:function(a,b,c){return _WA39.isFunction(a)&&a(b,c),{success:!0,result:b}}},{key:"_processLoadError",value:function(a,b){return _WA39.isFunction(a)&&a(b),{success:!1,error:b}}},{key:"_onError",value:function(a){_WA39.error(a||{})}},{key:"_createDelegatedCallbacks",value:function(a){var b,c=a||{},d=this._onError.bind(this);b=_WA39.isFunction(c)?{success:c,failure:d}:{success:c.success||_WA39.emptyFn,failure:c.failure||d,scope:c.scope};var e=c.scope||window,f=b.success.bind(e),g=b.failure.bind(e);return{successFn:f,errorFn:g}}},{key:"save",value:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},d=this._createDelegatedCallbacks(b),e=d.successFn,f=d.errorFn,g=c.forceInstant&&getStorageProvider("localStorage"),h=g||this.storage,i=c.useCookieAsWell&&!isStorageProviderType(h,"cookie");try{_WA39.util.Object.each(a,function(a,b){h.save(b,a),i&&getStorageProvider("cookie").save(b,a)})}catch(j){if(_WA39.isFunction(f)){try{"string"!=typeof j&&(j="STRGFFERROR"+j),j=j+""||j}catch(k){j="Parse Error"+k}f(j)}return!1}return _WA39.isFunction(e)&&e(),!0}},{key:"load",value:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},d=this._createDelegatedCallbacks(b),e=d.successFn,f=d.errorFn,g=null,h={params:a},i=c.forceInstant&&getStorageProvider("localStorage"),j=i||this.storage,k=c.useCookieAsWell&&!isStorageProviderType(j,"cookie");if(_WA39.isArray(a)){try{g={},_WA39.each(a,function(a){g[a]=j.load(a),!g[a]&&k&&(g[a]=getStorageProvider("cookie").load(a))},this)}catch(l){return this._processLoadError(f,l)}return this._processLoadSuccess(e,g,h)}try{g=j.load(a),!g&&k&&(g=getStorageProvider("cookie").load(a))}catch(l){return this._processLoadError(f,l)}return this._processLoadSuccess(e,g,h)}},{key:"remove",value:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},d=this._createDelegatedCallbacks(b),e=d.successFn,f=d.errorFn,g=c.forceInstant&&getStorageProvider("localStorage"),h=g||this.storage,i=c.useCookieAsWell&&!isStorageProviderType(h,"cookie");if(_WA39.isArray(a)){try{_WA39.each(a,function(a){h.remove(a),i&&getStorageProvider("cookie").remove(a)},this)}catch(j){return void f(j)}e()}else{try{h.remove(a),i&&getStorageProvider("cookie").remove(a)}catch(j){return void f(j)}e()}}},{key:"clear",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};try{this.storage.clear(),a.useCookieAsWell&&!isStorageProviderType(storage,"cookie")&&getStorageProvider("cookie").clear()}catch(b){}}},{key:"destroy",value:function(){}},{key:"modify",value:function(a,b,c,d){this.load(a,{success:function(a){var e={};_WA39.apply(e,a),b.call(c||window,a);var f=_U31.Object.diff(e,a);f&&this.save(f,null,d)},scope:this},d)}},{key:"modifyObject",value:function(a,b,c,d){this.modify(a,function(a){a||(a={}),_U31.Object.each(a,function(b,c){"undefined"===b&&(b="{}"),a[c]=JSON.parse(b||"{}")},this),b.call(c||window,a),_U31.Object.each(a,function(b,c){a[c]=JSON.stringify(b)},this)},null,d)}}]),a}(),InstantStorage=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.storage=getStorageProvider("localStorage"),a.storage.broken&&(a.storage=getStorageProvider("cookie"),a.brokenStorages.localStorage=!0),a}return _inherits2(b,a),b}(Storage),CookieStorage=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.brokenStorages={},a.storage=getStorageProvider("cookie"),a}return _inherits2(b,a),b}(Storage),SessionStorage=function(a){function b(){return _classCallCheck2(this,b),_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this))}return _inherits2(b,a),_createClass2(b,[{key:"_ifSessionExist",value:function(a,b,c){_WA39.ConnectionFacade&&_WA39.ConnectionFacade.getSessionId(function(d){null===d||""===d?b.call(c||window):a.call(c||window,d)},this)}},{key:"save",value:function(a,c){var d=this,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};_get2(_getPrototypeOf2(b.prototype),"save",this);this._ifSessionExist(function(f){var g={};_WA39.util.Object.each(a,function(a,b){a=f+";"+a,g[b]=a}),_get2(_getPrototypeOf2(b.prototype),"save",d).call(d,g,c,e)},function(){var a=d._createDelegatedCallbacks(c);a.errorFn()})}},{key:"load",value:function(a,c){var d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},e=_get2(_getPrototypeOf2(b.prototype),"load",this);this._ifSessionExist(function(b){var f=this._createDelegatedCallbacks(c);e.call(this,a,{success:function(a){if(_WA39.isObject(a)){var c={};_WA39.util.Object.each(a,function(a,d){a=a||"";var e=_WA39.isString(a)?a.indexOf(";"):-1;e>-1&&a.substr(0,e)===b?c[d]=a.substr(e+1):c[d]=""}),f.successFn(c)}else{var d=a.indexOf(";");a.substr(0,d)===b?f.successFn(a.substr(d+1)):f.successFn("")}},failure:f.errorFn,scope:this},d)},function(){var b=this._createDelegatedCallbacks(c);if(_WA39.isObject(a)){var d={};_WA39.util.Object.each(a,function(a){d[a]=""}),b.successFn(d)}else b.successFn("")},this)}}]),b}(Storage),AccountStorage=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.storage=getStorageProvider("localStorage"),a.storage.broken&&(a.storage=getStorageProvider("cookie"),a.brokenStorages.localStorage=!0),a}return _inherits2(b,a),_createClass2(b,[{key:"save",value:function(a,c){var d=_WA39.ACTIVE_MAIL;if(d){var e={};_WA39.util.Object.each(a,function(a,b){e[d+"_"+b]=a}),_get2(_getPrototypeOf2(b.prototype),"save",this).call(this,e,c)}else{var f=this._createDelegatedCallbacks(c);_WA39.boardMode||f.errorFn()}}},{key:"load",value:function(a,c){var d=_WA39.ACTIVE_MAIL,e=this._createDelegatedCallbacks(c);if(d){if(_WA39.isArray(a)){var f=[];_WA39.each(a,function(a){f.push(d+"_"+a)},this),a=f}else a=d+"_"+a;_get2(_getPrototypeOf2(b.prototype),"load",this).call(this,a,{success:function(a){if(_WA39.isObject(a)){var b={};_WA39.util.Object.each(a,function(a,c){a=a||"";var e=d.length;b[c.substr(e+1)]=a}),e.successFn(b)}else e.successFn(a)},failure:e.errorFn,scope:this})}else if(_WA39.isArray(a)){var g={};_WA39.util.Object.each(a,function(a){g[a]=""}),e.successFn(g)}else e.successFn("")}},{key:"remove",value:function(a,c){var d=_WA39.ACTIVE_MAIL;if(d){if(_WA39.isArray(a)){var e=[];_WA39.each(a,function(a){e.push(d+"_"+a)},this),a=e}else a=d+"_"+a;_get2(_getPrototypeOf2(b.prototype),"remove",this).call(this,a,c)}else{var f=this._createDelegatedCallbacks(c);f.successFn()}}}]),b}(Storage);_WA39.Storage=new Storage,_WA39.InstantStorage=new InstantStorage,_WA39.SessionStorage=new SessionStorage,_WA39.AccountStorage=new AccountStorage,_WA39.CookieStorage=new CookieStorage,_WA39.Storage.brokenStorageEvent=brokenStorageEvent;var _optionsCache,_stringOptionsCache={},_readLocalOptions=function(){"undefined"==typeof _optionsCache&&_WA39.AccountStorage.load(["option_flags","option_theme","option_media","option_privacyGroups","option_privacyCalls"],{success:function(a){_optionsCache=a&&a.option_flags||0;var b=a&&a.option_theme;parseInt(b)>=0&&("1"===b&&"dark_green"===_WA39.THEME_SCHEMA[1]&&(b="3"),b=_WA39.THEME_SCHEMA[b]),_stringOptionsCache.theme=b||null,_stringOptionsCache.media=a.option_media||"",_stringOptionsCache.privacyGroups=a.option_privacyGroups||"",_stringOptionsCache.privacyCalls=a.option_privacyCalls||"",_optionsCache||_WA39.Storage.load("option_flags",{success:function(a){_optionsCache=a||_WA39.AccountSettings.DEFAULT_VALUE,_WA39.AccountStorage.save({option_flags:_optionsCache})},scope:this})},scope:_this4})},_getOptionBit=function(a){return!!(_optionsCache&1<<a-1)},_setStringOption=function(a,b){if(a===_WA39.AccountSettings.OPTION_THEME&&(a="theme"),_stringOptionsCache[a]!==b){_stringOptionsCache[a]=b;var c={};return c["option_"+a]=b,_WA39.AccountStorage.save(c),!0}return!1};_WA39.AccountSettings={OPTION__DEPRECATED:1,OPTION_MUTE_SOUND:2,OPTION_HIDE_PREVIEWS:3,OPTION_HIDE_AVATARS:4,OPTION_SHOW_ONLY_ALIVE:5,OPTION_SEND_BY_ENTER:6,OPTION_HIDE_MSG_TIME:7,OPTION_BLOCK_DESKTOP_NOTIFICATIONS:8,OPTION_HIDE_TEXT_IN_NOTIFICATIONS:9,OPTION_SEARCH_CHAT_HOTKEY:10,OPTION_FORWARD_AUTHOR_IS_HIDDEN:11,OPTION_THEME:12,OPTION_HIDE_SMART_REPLY:13,OPTION_HIDE_STICKER_SUGGEST_BY_EMOJI:14,OPTION_HIDE_STICKER_SUGGEST_BY_WORDS:15,DEFAULT_VALUE:32,STRING_THEME:"theme",STRING_MEDIA:"media",STRING_PRIVACY_GROUPS:"privacyGroups",STRING_PRIVACY_CALLS:"privacyCalls",optionChange:new _U31.Event,getOption:function(a){return _readLocalOptions(),a===_WA39.AccountSettings.OPTION_THEME?_stringOptionsCache.theme||0:a===_WA39.AccountSettings.STRING_MEDIA?_stringOptionsCache.media||"":a===_WA39.AccountSettings.STRING_PRIVACY_GROUPS?_stringOptionsCache.privacyGroups||"":a===_WA39.AccountSettings.STRING_PRIVACY_CALLS?_stringOptionsCache.privacyCalls||"":_getOptionBit(a)},setOption:function(a,b){if(_readLocalOptions(),a===_WA39.AccountSettings.OPTION_THEME||a===_WA39.AccountSettings.STRING_MEDIA||a===_WA39.AccountSettings.STRING_PRIVACY_GROUPS||a===_WA39.AccountSettings.STRING_PRIVACY_CALLS)return void(_setStringOption(a,b)&&this.optionChange.fire(a,b));var c=_getOptionBit(a);b!==c&&this.invertOption(a)},invertOption:function(a){_readLocalOptions(),_optionsCache^=1<<a-1;var b=_getOptionBit(a);return _WA39.AccountStorage.save({option_flags:_optionsCache}),this.optionChange.fire(a,b),b}};var _WA40=WebIM,_U32=_WA40.util,_DomUtil22=_WA40.DomUtil,stopEventOnCountryPage=function(a){a.getTarget(!0).up("im-countrypage")&&a.stopEvent()},PhoneField=function(){function a(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck2(this,a),this.params=b,this.bound=!1,this.errorModeEnabled=!1,b.parent&&this.bind(b.parent,b.countryBlock),this.inputEvent=new _U32.Event,this.keyDownEvent=new _U32.Event}return _createClass2(a,[{key:"bind",value:function(a,b){this.bound&&this.unbind(),this.block=_DomUtil22.get(a),this.countryBlock=b?_DomUtil22.get(b):this.block,this.block.updateHTML(_WA40.TD.getTMPL("phoneInput")),this.input=this.block.getSelector(".im-phone__input"),this.block.on("click",this._onClick,this),this.input.on("input",this._onInput,this),this.input.on("keydown",this._onKeyDown,this),this.bound=!0,this.reset()}},{key:"presetPhone",value:function(a,b){var c=this;this._presetData=null,a&&(this._presetData={phone:a},_WA40.CountryPage.getCountryData(function(a){if(a&&c._presetData){var d=c._presetData.phone.replace(/^\+/,"");a.some(function(a){var b=_slicedToArray(a,1),e=b[0];return 0===d.indexOf(e)?(e=e.toString(),c._presetData.code=e,c._presetData.number=d.slice(e.length),!0):void 0}),c.bound&&c.input&&c._applyPresetData(),b()}}))}},{key:"_applyPresetData",value:function(){this._presetData&&(this._presetData.code&&this._presetData.number?(this.input.dom.value=this._presetData.number,this.input.prev().updateText("+"+this._presetData.code)):(this.input.prev().hide(),this.input.setStyle("width","100%"),this.input.dom.value=this._presetData.phone.replace(/^([^\+])/,"+$1")),this._presetData=null,this._onInput())}},{key:"_onInput",value:function(){this.input.dom.value=this.input.dom.value.replace(/\D+/g,""),this.inputEvent.fire(this.input.dom.value)}},{key:"_onKeyDown",value:function(a){this.keyDownEvent.fire(a)}},{key:"_onClick",value:function(a){var b=this,c=a.getTarget(!0);if(c.up("im-phone__code")){var d={onClick:function(a){var c=b.block.getSelector(".im-phone__code");c&&c.updateText("+"+a)}};this.countryPage||(this.countryPage=new _WA40.CountryPage,this.countryBlock.on("click",stopEventOnCountryPage)),this.countryPage.openInBlock(this.countryBlock,d)}}},{key:"unbind",value:function(){this.bound&&(this.block.un("click",this._onClick,this),this.input.un("input",this._onInput,this),this.input.un("keydown",this._onKeyDown,this),this.countryPage&&(this.countryPage.onBackClick&&this.countryPage.onBackClick(),this.countryPage=null,this.countryBlock.un("click",stopEventOnCountryPage)),this.block=this.input=null,this.bound=!1)}},{key:"reset",value:function(){this.bound&&(this.input.dom.value="",this.input.removeAttribute("style"),this.errorMode(!1),this._applyPresetData())}},{key:"focus",value:function(){this.bound&&this.input.dom.focus()}},{key:"isValid",value:function(){return(this.input.dom.value||"").match(/\d{3,}/)}},{key:"getPhone",value:function(){return this.input.prev().dom.innerHTML+this.input.dom.value}},{key:"errorMode",value:function(a){this.errorModeEnabled!==!!a&&(this.errorModeEnabled=!!a,this.block.toggleClass("im-phone_error",this.errorModeEnabled))}},{key:"destroy",value:function(){this.unbind(),this.inputEvent.removeAll(),this.keyDownEvent.removeAll()}}]),a}();_WA40.PhoneField=PhoneField;var _WA41=WebIM,_TD13=_WA41.TemplateDriver,_U33=_WA41.util,_DomUtil23=_WA41.DomUtil,SMS_SOURCE_MODE={title:"auth.typeCode",note:"",placeholder:"auth.smsCode",numberNote:"auth.waitForCode",missedCode:"auth.missedCode",resendCode:"auth.resendCode"},PHONE_SOURCE_MODE={title:"auth.typeCallCode",note:"auth.typeCallCode",placeholder:"auth.numberCallCode",numberNote:"auth.waitForCall",missedCode:"auth.recall",resendCode:"auth.recall"},switchDisabledAttr=function(a,b){a?b.dom.hasAttribute("disabled")||b.setAttribute("disabled",1):b.dom.hasAttribute("disabled")&&b.removeAttribute("disabled")},formatRemainingTime=function(a){return"".concat(Math.floor(a/60),":").concat((a%60).toString().replace(/^(\d)$/,"0$1"))},VerifyPhoneBySMS=function(){function a(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck2(this,a),this.resendCodeTime=b.resendTime||60,this.safeContent=_TD13.parseSafe("verifyPhoneBySMS",{phoneTitle:b.phoneTitle||_WA41.tr("auth.yourPhone"),codeTitle:b.codeTitle||_WA41.tr("auth.typeCode"),phoneOk:b.phoneOk||_WA41.tr("next"),resendTime:formatRemainingTime(this.resendCodeTime)}),this.action=b.action,this.codeScreenClass="im-verify-phone_code",this.overlayClass="icq_verify-phone_with-overlay",this.codeFieldErrorClass="im-verify-phone__code_error",this.autoSubmitCodeClass="im-verify-phone_auto-submit",this.params=b,this.bound=!1,this.verifyByCall=!1,this._resendTimer=null,this.phoneField=new _WA41.PhoneField,this.phoneField.inputEvent.on(this._onPhoneInput,this),this.phoneField.keyDownEvent.on(this._onKeyDown,this),b.parent&&this.bind(b.parent,b.countryBlock),this.cancelEvent=new _U33.Event,this.codeSendEvent=new _U33.Event,this.phoneErrorEvent=new _U33.Event,this.codeErrorEvent=new _U33.Event}return _createClass2(a,[{key:"bind",value:function(a,b,c){this.bound&&this.unbind(),this.block=_DomUtil23.get(a),this.block.updateHTML(this.safeContent),this.classesBlock=c?_DomUtil23.get(c):this.block,this.phoneFieldBlock=this.block.getSelector(".imPhoneField"),this.phoneField.bind(this.phoneFieldBlock,b),this.codeField=this.block.getSelector(".txtSmsCode"),this.errorMsg=this.block.getSelector(".imVerifyPhoneErrorMsg"),this.phoneSubmessage=this.block.getSelector(".icVerifyPhoneSubmessage"),this.phoneNumber=this.block.getSelector(".imVerifyPhoneNumber"),this.phoneOkBtn=this.block.getSelector(".btnVerifyPhone"),this.submitCodeBtn=this.block.getSelector(".btnSubmitCode"),this.resendCodeBtn=this.block.getSelector(".btnResendCode"),this.dictateCodeBtn=this.block.getSelector(".btnVoiceCode"),this.block.on("click",this._onClick,this),this.codeField.on("input",this._onCodeInput,this),this.codeField.on("keydown",this._onKeyDown,this),this.bound=!0,this.reset()}},{key:"focus",value:function(){this.bound&&(this.classesBlock.hasClass(this.codeScreenClass)?this.codeField.dom.focus():this.phoneField.focus())}},{key:"_onKeyDown",value:function(a){13===a.keyCode&&(this.classesBlock.hasClass(this.codeScreenClass)?this._submitCode():this._verifyPhone())}},{key:"_onPhoneInput",value:function(){switchDisabledAttr(!this.phoneField.isValid(),this.phoneOkBtn),this.phoneField.errorModeEnabled&&this.phoneSubmessage.updateText(this.params.subMessage||""),this.phoneField.errorMode(!1),this._phoneData=null}},{key:"_isCodeValid",value:function(){var a=this.codeField.dom.value;if(this._phoneData){var b=this._phoneData,c=b.code_length,d=b.key_regex,e=new RegExp(d);return!c||c===a.length&&e.test(a)}return 6===a.length}},{key:"_onCodeInput",value:function(){this.codeField.dom.value=this.codeField.dom.value.replace(/\D+/g,"");var a=this._isCodeValid();this.codeField.removeClass(this.codeFieldErrorClass),switchDisabledAttr(!a,this.submitCodeBtn),a&&this.autoSubmitCode&&(this.sendCode(),this.autoSubmitCode=!1)}},{key:"_verifyPhone",value:function(){this._phoneData?this.switchToCodeInput():this.phoneField.isValid()?this.sendPhone():this.showPhoneError(_WA41.tr("auth.msgWrongPhone"))}},{key:"_submitCode",value:function(){this._isCodeValid()?this.sendCode():this.showCodeError(_WA41.tr("auth.msgWrongCode"))}},{key:"_onClick",value:function(a){var b=a.getTarget(!0),c=b.up("imVerifyPhoneBtn");c&&!c.dom.hasAttribute("disabled")&&(c.hasClass("btnVerifyCancel")?this.cancelEvent.fire():c.hasClass("btnGoBack")?this.switchToPhoneInput():c.hasClass("btnVerifyPhone")?this._verifyPhone():c.hasClass("btnResendCode")?this.phoneField.isValid()?this.sendPhone():this.showPhoneError(_WA41.tr("auth.msgWrongPhone")):c.hasClass("btnSubmitCode")?this._submitCode():c.hasClass("btnVoiceCode")&&this.sendPhone(!0))}},{key:"_startResendTimer",value:function(){var a=this;this._resendTimer=_WA41.setTimeout(function(){if(a.bound){var b=a.resendCodeTime-(_WA41.now()-a._currentRequestTS);0>=b?(a._resendTimer=null,a.updateResendCountdown(0),switchDisabledAttr(!1,a.resendCodeBtn),switchDisabledAttr(!1,a.dictateCodeBtn)):(a.updateResendCountdown(b),a._startResendTimer())}else a._stopResendTimer()},1e3)}},{key:"_stopResendTimer",value:function(){this._resendTimer&&clearTimeout(this._resendTimer),this._resendTimer=null}},{key:"switchToPhoneInput",value:function(){this.bound&&(this.classesBlock.removeClass(this.overlayClass),this.phoneSubmessage.updateText(this.params.subMessage||""),this.phoneField.errorMode(!1),this.classesBlock.removeClass(this.codeScreenClass),this.phoneField.focus())}},{key:"getCodePhrase",value:function(b){return a.getSmsCodePhrase(b,this.verifyByCall)}},{key:"switchToCodeInput",value:function(){if(this.bound){this.codeField.dom.value="",this.classesBlock.removeClass(this.overlayClass),this.codeField.removeClass(this.codeFieldErrorClass),this.errorMsg.updateText(""),this.autoSubmitCode||this.classesBlock.removeClass(this.autoSubmitCodeClass),this.classesBlock.addClass(this.codeScreenClass),switchDisabledAttr(!this._isCodeValid(),this.submitCodeBtn),this.codeField.dom.focus();var a=_DomUtil23.getSelector(".im-verify-phone__sms");a.getSelector(".im-verify-phone__title").updateHTML(this.getCodePhrase("title")),a.getSelector(".txtSmsCode").setAttribute("placeholder",this.getCodePhrase("placeholder"))}}},{key:"updateResendCountdown",value:function(a){var b=a>0?" "+formatRemainingTime(a):"";this.resendCodeBtn.updateText(this.getCodePhrase("resendCode")+b)}},{key:"showPhoneError",value:function(a){this.bound&&a&&(this.classesBlock.removeClass(this.overlayClass),this.phoneField.errorMode(!0),this.phoneSubmessage.updateText(a),switchDisabledAttr(!0,this.phoneOkBtn),this.phoneErrorEvent.fire(a))}},{key:"showCodeError",value:function(a){this.bound&&a&&(this.classesBlock.removeClass(this.overlayClass),this.errorMsg.updateText(a),this.codeField.addClass(this.codeFieldErrorClass),switchDisabledAttr(!0,this.submitCodeBtn),this.codeErrorEvent.fire(a),this.classesBlock.toggleClass(this.autoSubmitCodeClass,this.autoSubmitCode))}},{key:"sendPhone",value:function(a){var b=this;if(this.bound&&this.phoneField.isValid()){this._stopResendTimer();var c=this.phoneField.getPhone();this._request_sent||(this._request_sent=!0,this.classesBlock.addClass(this.overlayClass),_WA41.comApi.requestPhoneCode(c,a,function(a){b._request_sent=!1,b.bound&&(b._phoneData=a,b.verifyByCall="callui"===a.checks,b.verifyByCall&&_U33.Mnt.countRB(41343664),b.dictateCodeBtn.setVisible(!b.verifyByCall),b.classesBlock.removeClass(b.overlayClass),b.switchToCodeInput(),b._currentRequestTS=_WA41.now(),b._startResendTimer())},function(a,c,d){b._request_sent=!1,b.classesBlock.removeClass(b.overlayClass);var e,f=c||a;e=462===f||469===f?_WA41.tr("auth.msgWrongPhone"):465===f||"smsapi/verify limit"===d?_WA41.tr("auth.msgRequestRateLimit"):f?_WA41.tr("auth.msgCommonError")+" ("+f+")":_WA41.tr("auth.msgNetworkUnavailable"),b.showPhoneError(e)})),this.phoneNumber.updateHTML(_U33.String.formatPhoneNumber(c)),this.updateResendCountdown(this.resendCodeTime),switchDisabledAttr(!0,this.resendCodeBtn),switchDisabledAttr(!0,this.dictateCodeBtn),switchDisabledAttr(!0,this.submitCodeBtn)}}},{key:"sendCode",value:function(){if(this.bound&&!this.block.hasClass(this.overlayClass)&&this._isCodeValid()&&this._phoneData){this.classesBlock.addClass(this.overlayClass);var a=this.codeField.dom.value,b=this._phoneData,c=b.msisdn,d=b.trans_id;this._isCodeValid()&&this.codeSendEvent.fire(a,c,d)}}},{key:"unbind",value:function(){this.bound&&(this.block.un("click",this._onClick,this),this.codeField.un("input",this._onCodeInput,this),this.codeField.un("keydown",this._onKeyDown,this),this.phoneField.unbind(),this.block=this.phoneFieldBlock=this.codeField=this.errorMsg=this.phoneOkBtn=this.submitCodeBtn=this.resendCodeBtn=this.classesBlock=this.phoneSubmessage=this.dictateCodeBtn=this.phoneNumber=null,this.bound=!1)}},{key:"reset",value:function(){this.bound&&(this.phoneField.reset(),this.phoneSubmessage.updateText(this.params.subMessage||""),this.errorMsg.updateText(""),this.codeField.dom.value="",this._phoneData=null,this.autoSubmitCode=!!this.params.autoSubmitCode,this.classesBlock.toggleClass(this.autoSubmitCodeClass,this.autoSubmitCode),this.classesBlock.removeClass(this.codeScreenClass),this.classesBlock.removeClass(this.overlayClass),this.updateResendCountdown(this.resendCodeTime),[this.phoneOkBtn,this.submitCodeBtn,this.resendCodeBtn,this.dictateCodeBtn].forEach(function(a){a.setAttribute("disabled",1)}))}},{key:"destroy",value:function(){this.unbind(),this.cancelEvent.removeAll(),this.codeSendEvent.removeAll(),this.phoneErrorEvent.removeAll(),this.codeErrorEvent.removeAll(),this.phoneField.destroy()}}],[{key:"getSmsCodePhrase",value:function(a,b){var c=b?PHONE_SOURCE_MODE[a]:SMS_SOURCE_MODE[a];return c?_WA41.tr(c):""}}]),a}();_WA41.VerifyPhoneBySMS=VerifyPhoneBySMS;var _WA42=WebIM,_UI33=_WA42.ui,_TD14=_WA42.TemplateDriver,_U34=_WA42.util,ContactModalBox=function(a){function b(a,c){var d;_classCallCheck2(this,b);var e=a||{},f=e.phone,g=e.name,h=e.sn,i=e.lastseen,j=e.userState,k=e.bot,l=_TD14.parseSafe("contactBoxContent",{title:_WA42.Emoji.parse(_U34.String.htmlEntity(g)),avatar:_WA42.Ava.make(h||f,g,150),subtitle:_WA42.CLD.getLastseenMessage(i,{userState:j,bot:k}),contactPhone:f&&_U34.String.formatPhoneNumber(f)},{safeKeys:["title","avatar","subtitle"]});return d=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,{title:_WA42.tr("dialog.aboutContact"),content:l,blockCls:"im-contact-box"+(h?"":" im-contact-box_non-icq"),buttons:[{action:"cancel",text:_WA42.tr("box.cancel")}]})),d.contact=a||{},d.from=c||{sn:h,name:g},d}return _inherits2(b,a),_createClass2(b,[{key:"_onClick",value:function(a){var b=a.up("imButton"),c=b&&b.getAttribute("data-action");if(c){var d=!1;if(this.actionEvent.fire(c)){var e=this.contact,f=e.sn,g=e.phone,h=e.name;switch(c){case"openProfile":f?(_WA42.contactAbstraction.openDialog(f,h),_WA42.contactAbstraction.openProfile(f,h)):d=!0;break;case"openDialog":f&&_WA42.contactAbstraction.openDialog(f,h);break;case"copyPhoneNumber":_U34.Selection.copy2clipboard(_U34.String.formatPhoneNumber(g)),_WA42.showPopup(_WA42.tr("msgPhoneCopied")),d=!0;break;case"shareContact":_WA42.ma.dialogsWindow.forwardMessage(this.from.sn,this.from.name,{contact:f?{sn:f,phone:g,name:h}:{phone:g,name:h},text:"".concat(h||_WA42.uinAsName(f)," ").concat(g)},!0);break;case"saveContact":var i=new _WA42.AddContactDialog(_WA42.contactAbstraction);i.show({phone:g,name:h})}}d||this.hide()}}},{key:"_onContextMenu",value:function(a){var b=a.getTarget(!0);if(b.up("imPhoneNumber")){var c={copyPhoneNumber:_WA42.clipboardSupported&&this.contact.phone,shareContact:this.contact.phone};_WA42.contextMenu.show(a,c,{sn:this.contact.sn,friendly:this.contact.name,phone:this.contact.phone},this._onContextMenuAction.bind(this)),a.stopEvent()}}},{key:"_onContextMenuAction",value:function(a,b){var c=this.contact,d=c.sn,e=c.phone,f=c.name;switch(b){case"shareContact":_WA42.ma.dialogsWindow.forwardMessage(this.from.sn,this.from.name,{contact:d?{sn:d,phone:e,name:f}:{phone:e,name:f},text:"".concat(f||_WA42.uinAsName(d)," ").concat(e)}),this.hide();break;case"copyPhoneNumber":_U34.Selection.copy2clipboard(e),_WA42.showPopup(_WA42.tr("msgPhoneCopied"))}}},{key:"_onShow",value:function(){_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),this.container.getSelector(".im-contact-box__save-wrap").setVisible(!_WA42.configurator.getOption("disable_add_contact_by_phone")),this.container.on("contextmenu",this._onContextMenu,this)}},{key:"_onHide",value:function(){this.container.un("contextmenu",this._onContextMenu,this),_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this)}},{key:"destroy",value:function(){this.container&&this.container.un("contextmenu",this._onContextMenu,this),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI33.ConfirmModalBox);_WA42.ContactModalBox=ContactModalBox;var _WA43=WebIM,_UI34=_WA43.ui,_TD15=_WA43.TemplateDriver,_U35=_WA43.util,ContactShareModalBox=function(a){function b(a,c){var d;_classCallCheck2(this,b);var e=c||{},f=e.onOk,g=a||{},h=g.phone,i=g.name,j=g.sn,k=g.uNick,l=_WA43.Emoji.parse(_U35.String.htmlEntity(k?"@"+k:_WA43.isEmail(j)&&j||"")),m=_TD15.parseSafe("contactBoxContent",{
title:_WA43.Emoji.parse(_U35.String.htmlEntity(i)),avatar:_WA43.Ava.make(j||h,i,150),subtitle:l,contactPhone:h&&_U35.String.formatPhoneNumber(h)},{safeKeys:["title","avatar","subtitle"]}),n=["im-contact-box im-contact-box_share"],o=!(!l&&!h);return j||n.push("im-contact-box_non-icq"),h||n.push("im-contact-box_without-phone"),l||n.push("im-contact-box_without-nickname"),d=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,{title:_WA43.tr("contextmenu.shareContact"),content:m,blockCls:n.join(" "),onOk:f,buttons:[{action:"cancel",text:_WA43.tr("search.back")},{action:"ok",text:_WA43.tr(o?"dialog.send":"calls.openChatPage"),cls:"im-button_highlight"}]})),d.canShare=o,d.contact=a||{},d}return _inherits2(b,a),_createClass2(b,[{key:"_onClick",value:function(a){var b=a.up("imButton"),c=b&&b.getAttribute("data-action"),d=!0;switch(a.up("imPhoneNumber")&&(c="phone"),c){case"phone":var e=a.up("imPhoneNumber");e.getSelector(".im-tickbox").toggleClass("im-tickbox_checked");break;case"ok":if(this.initialConfig.onOk){var f=this.container.getSelector(".imPhoneNumber .im-tickbox_checked"),g=f&&f.up("imPhoneNumber").getSelector(".imPhoneNumberValue"),h=g&&g.dom.innerText,i=this.contact,j=i.uNick,k=i.sn;this.initialConfig.onOk({phone:h,uNick:j,mail:_WA43.isEmail(k)&&k,canShare:this.canShare})}break;case"cancel":d=!1}d||this.hide()}}]),b}(_UI34.ConfirmModalBox);_WA43.ContactShareModalBox=ContactShareModalBox;var _WA44=WebIM,_UI35=_WA44.ui,_U36=_WA44.util,S=_WA44.AccountStorage,_DomUtil24=_WA44.DomUtil,RESIZE_DEBOUNCE_DELAY=100,LAYOUT_SINGLE="single",LAYOUT_SPLIT="split",LAYOUT_SPLIT_COMPACT="compact",LAYOUT_SPLIT_FULL="full",LAYOUT_SPLIT_CENTER="center",CSS_LAYOUT_PREFIX="im-layout-",SPLIT_LAYOUT_MIN_DIMENSION=768,FULL_LAYOUT_MIN_WIDTH=990,_minorLayout=null,_timer,_delayedCall=!1,AppLayout={init:function(){var a=_WA44.splitView?LAYOUT_SPLIT:LAYOUT_SINGLE,b=this._getMinorLayout(),c=CSS_LAYOUT_PREFIX+a+(b?" "+CSS_LAYOUT_PREFIX+b:"");_minorLayout=b,_DomUtil24.getBody().addClass(c),_WA44.splitView&&_DomUtil24.fly(window).on("resize",this._onResize,this)},_onResize:function(){_timer?_delayedCall=!0:(this._checkChange(),_timer=_WA44.setTimeout(function(){_delayedCall&&this._checkChange(),_timer=null},RESIZE_DEBOUNCE_DELAY,this))},_checkChange:function(){_delayedCall=!1;var a=this._getMinorLayout();a!==_minorLayout&&this._onLayoutChange(a)},_getMinorLayout:function(){return _WA44.splitView?_U36.DomHelper.getWindowSize().width<FULL_LAYOUT_MIN_WIDTH?LAYOUT_SPLIT_COMPACT:LAYOUT_SPLIT_FULL:void 0},_onLayoutChange:function(a){if(a){var b=_DomUtil24.getBody();_minorLayout&&b.removeClass(CSS_LAYOUT_PREFIX+_minorLayout),b.addClass(CSS_LAYOUT_PREFIX+a),_minorLayout=a,AppLayout.switchEvent.fire(a)}},switchEvent:new _U36.Event};_WA44.AppLayout=AppLayout;var _WA45=WebIM,_U37=_WA45.util,SHOW_DELAY=200,_stopEvent=function(a){a.stopPropagation&&a.stopPropagation()},OverlayScreen=function(){function a(){_classCallCheck2(this,a)}return _createClass2(a,[{key:"init",value:function(){if(!this.el){this.el=_U37.DomHelper.createDiv(),this.className="im-overlay-screen",this.el.addClass(this.className);var a=_WA45.TD.getTMPL("CircleSpinner")+'<div class="im-overlay-screen__text"></div>';this.el.updateHTML(_WA45.TD.getTMPL("UIDialogBlock").replace("${content}",a)),this.messageCont=this.el.getSelector(".im-overlay-screen__text"),this.spinner=this.el.getSelector(".im-circ-spinner"),this.spinner.removeClass("active"),this.hideOnClick=!1,this.hideEvent=new _U37.Event,App.on("page:load",this.hide,this),App.on("page:back",this.hide,this)}}},{key:"show",value:function(a,b,c){var d=this;this.clearTimeout(),2===arguments.length&&"string"!=typeof b&&(c=b,b=void 0),this.el&&this.el.isVisible()&&this.hide(),this.init();var e=b?[this.className,b]:[this.className];this.hideOnClick=!!c,a?("string"==typeof a&&(this.messageCont.updateText(a),e.push("im-overlay-screen__msg")),this.spinner.addClass("active")):this.spinner.removeClass("active"),this.el.dom.className=e.join(" "),this.el.appendTo(document.body),this.el.on("touchstart",_stopEvent).on("touchend",_stopEvent).on("touchmove",_stopEvent).on("mousedown",_stopEvent).on("mouseup",_stopEvent).on("click",this.hide,this),this.timerId=_WA45.setTimeout(function(){return d.el.show()},SHOW_DELAY,this)}},{key:"showAndStay",value:function(){this.show.apply(this,arguments)}},{key:"hide",value:function(a){this.clearTimeout(),(!a||"click"!==a.type||(_stopEvent(a),this.hideOnClick))&&this.el&&(this.el.hide(),this.el.un("touchstart",_stopEvent).un("touchend",_stopEvent).un("touchmove",_stopEvent).un("mousedown",_stopEvent).un("mouseup",_stopEvent).un("click",this.hide,this),this.el.dom.parentNode&&this.el.dom.parentNode.removeChild(this.el.dom),this.hideEvent.fire())}},{key:"clearTimeout",value:function(a){function b(){return a.apply(this,arguments)}return b.toString=function(){return a.toString()},b}(function(){clearTimeout(this.timerId),this.timerId=null})}]),a}();_WA45.overlayScreen=new OverlayScreen;var _WA46=WebIM,_U38=_WA46.util,_TD16=_WA46.TemplateDriver,_DomUtil25=_WA46.DomUtil,ACTION_TITLES={excludeMember:"contextmenu.exclude",blockMember:"contextmenu.removeAndBlock"},menuItemsOrder=["goToMessage","mention","removeAdminRights","giveAdminRights","profile","allowWriting","forbidWriting","removeAndBlock","blockMember","ignore","remove","exclude","excludeMember","spam","copyGroupLink","shareGroup","shareChannel","copyNick","copyNickname","copyEmail","copyProfileLink","shareProfile","shareNick","copyPhoneNumber","shareContact","reply","pollRecall","pollStop","copyLink","copyText","copyObject","resend","pinMessage","unpinMessage","edit","goToProfile","saveAs","openInBrowser","delForMe","delForAll","delMessage","toFavorite"],correctActionsList={message:"openDialog",profile:"openProfile",spam:"spamReport"},CHOOSE_FILE_KEY="changeAvatar",fadeOutBackground=!_WA46.isDesktop,itemsToArray=function(a){return _U38.Array.filter(menuItemsOrder,function(b){return a[b]})},_stopEvent4=function(a){a.stopPropagation&&a.stopPropagation()},_killEvent=function(a){a.stopEvent&&a.stopEvent()},_correctDefaultAction=function(a){return correctActionsList[a]||a+"Contact"},_getDefaultAction=function(a){return a=_correctDefaultAction(a),_WA46.ma&&"function"==typeof _WA46.ma[a]?function(b){_WA46.ma[a](b)}:void 0},_getActionTitle=function(a){var b=ACTION_TITLES[a]||"contextmenu."+a;return _WA46.tr(b)},ContextMenu=function(){function a(){_classCallCheck2(this,a)}return _createClass2(a,[{key:"init",value:function(){this.el||(this.handlers={},this.el=_U38.DomHelper.createDiv(),this.el.addClass("im-context-menu"),App.on("page:show",this.hide,this),App.on("navigation:back",this._onBack,this))}},{key:"show",value:function(a,b,c,d){var e=this;b instanceof Array||(b=itemsToArray(b)),this.init();var f=[];if(_U38.Array.each(b,function(a){f.push(_TD16.parseSafe(a===CHOOSE_FILE_KEY?"contextMenuFileItem":"contextMenuItem",[a,_getActionTitle(a)]))}),f.length){this.data=c,this.handlers="function"==typeof d?{any:d}:d||{},this.el.updateHTML(f.join("\n")),this.el.appendTo(document.body),this.el.on("touchmove",_killEvent).on("mousemove",_stopEvent4).on("contextmenu",_killEvent).on("click",this._onClick,this).on("change",this._onChange,this),_WA46.hotKeyManager.on("esc",{handler:this.hide,scope:this}),[_DomUtil25.getOverlay(),_DomUtil25.getBody()].forEach(function(a){return a.on(["mousedown","wheel"],e._onMouseAction,e)}),this.el.show(),this._touchStarted=!1,_DomUtil25.getBody().on("touchstart",this._onTouchStart,this);var g,h,i=this.el.parent().getSize(),j=this.el.getSize();!fadeOutBackground&&a&&_WA46.isNumber(a.pageX)&&_WA46.isNumber(a.pageY)?(g=Math.min(Math.max(0,a.pageX),i.width),h=Math.min(Math.max(0,a.pageY),i.height)):(g=Math.floor(i.width/2-j.width/2),h=Math.floor(i.height/2-j.height/2)),g+j.width>i.width&&(g-=j.width),h+j.height>i.height&&(h-=j.height),0>h&&(h=0),0>g&&(g=0),fadeOutBackground&&_DomUtil25.getBody().addClass("im-overlay"),this.el.setStyle({left:g+"px",top:h+"px"})}}},{key:"hide",value:function(){var a=this;this.el&&(this.el.hide(),this.el.un("touchmove",_killEvent).un("mousemove",_stopEvent4).un("contextmenu",_killEvent).un("click",this._onClick,this).un("change",this._onChange,this),_WA46.hotKeyManager.un("esc",{handler:this.hide,scope:this}),fadeOutBackground&&_DomUtil25.getBody().removeClass("im-overlay"),[_DomUtil25.getOverlay(),_DomUtil25.getBody()].forEach(function(b){return b.un(["mousedown","wheel"],a._onMouseAction,a)}),_DomUtil25.getBody().un("touchstart",this._onTouchStart,this),this.el.dom.parentNode&&this.el.dom.parentNode.removeChild(this.el.dom))}},{key:"isVisible",value:function(){return this.el&&this.el.isVisible()}},{key:"_onBack",value:function(a){var b=this.isVisible();return this.hide(),b&&a&&a.canStop?!1:void 0}},{key:"_onMouseAction",value:function(a){var b=a.getTarget(!0);this.el.contains(b)||this.hide()}},{key:"_onChange",value:function(a){var b=a.getTarget();if(b.files){var c=this.handlers[CHOOSE_FILE_KEY]||this.handlers.any;c&&c.call(this,b,CHOOSE_FILE_KEY)}this.hide()}},{key:"_onTouchStart",value:function(a){this._touchStarted=!0}},{key:"_onClick",value:function(a){var b=a.getTarget(!0).up("imButton"),c=b&&b.getAttribute("data-action"),d=_WA46.isIOS?this._touchStarted:!0;if(this._touchStarted=!1,d&&c&&c!==CHOOSE_FILE_KEY){this.hide();var e=this.handlers["before_"+c]||this.handlers.before_any,f=this.handlers[c]||_getDefaultAction(c)||this.handlers.any,g=this.handlers["after_"+c]||this.handlers.after_any;e&&e.call(this,this.data,c),f&&f.call(this,this.data,c),g&&g.call(this,this.data,c)}a.stopPropagation()}}]),a}();_WA46.contextMenu=new ContextMenu;var _WA47=WebIM,_UI36=_WA47.ui,CreateChannelBox=function(a){function b(a){var c;_classCallCheck2(this,b);var d=a||{},e=d.onCreated;return c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,{title:_WA47.tr("channel.createChannel"),content:"",blockCls:"im-create-channel-box",onOk:e,buttons:[{action:"cancel",text:_WA47.tr("box.cancel")},{action:"ok",text:_WA47.tr("done"),cls:"im-button_highlight"}]})),c.groupNameBlock=new _UI36.GroupNameBlock({placeHolder:_WA47.tr("channel.name")}),c.groupNameBlock.changeEvent.on(c._onNameChange,_assertThisInitialized2(_assertThisInitialized2(c))),c}return _inherits2(b,a),_createClass2(b,[{key:"createChannel",value:function(){return this.groupNameBlock.getName()?this.groupNameBlock.uploadAvatar().then(function(a){var b=a.name,c=a.avatarId,d={"public":!0,live:!0,defaultRole:"readonly"};return c&&(d.avatarId=c),_WA47.chatController.createGroupChat([],b,d).then(function(a){return a&&{sn:a,name:b}})}):Promise.resolve()}},{key:"destroy",value:function(){this.groupNameBlock.destroy(),this.groupNameBlock=null,_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}},{key:"_onShow",value:function(){_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),this.groupNameBlock.focus()}},{key:"_onNameChange",value:function(a){a?this.okButton.removeAttribute("disabled"):this.okButton.setAttribute("disabled",!0)}},{key:"_onAfterRender",value:function(){this.body=this.el.getSelector(".im-modal-box__body"),this.groupNameBlock.render(this.body),this.body.createChild({cls:"im-create-channel-box__desc",html:_WA47.tr("box.channelsArePublicByDefault")}),this.okButton=this.el.getSelector('.imButton[data-action="ok"]'),this.okButton.setAttribute("disabled",!0)}},{key:"_onClick",value:function(a){var b=this,c=a.up("imButton"),d=!1,e=c&&!c.getAttribute("disabled")&&c.getAttribute("data-action");this.initialConfig.onOk&&"ok"===e&&(d=!0,this.createChannel().then(function(a){b.initialConfig.onOk(a),b.hide()},function(){})),e&&(this.actionEvent&&this.actionEvent.fire(e),d||this.hide())}}]),b}(_UI36.ConfirmModalBox);_WA47.CreateChannelBox=CreateChannelBox;var _WA48=WebIM,_U39=_WA48.util,DEV_ID=_WA48.configurator.getOption("akes_dev_id"),SECURE_MPOP_COOKIE=!0,_DomUtil26=_WA48.DomUtil,DEBUG_PROMO_CHAT={name:"Путешествия",stamp:"travel",messages:[{time:1585147551,previews:[],sender:{name:"КЭП",avatar:"https://hb.bizmrg.com/chat_history_server/3d22ba20a885792badf36b9ac9743d37"},text:"чО, правда?"},{time:1585147544,previews:[],sender:{name:"Mari",avatar:"https://hb.bizmrg.com/chat_history_server/1658a0dd9ab95492c1c039b52d0c7ce1"},text:">749871128 (03/25/2020, 14:43 GMT):\n>https://files.icq.net/get/0FineSibCEB5CPQWHHzKEg5d0becd71aj\n\nКрасотища 😍"}],avatar:"https://hb.bizmrg.com/chat_history_server/18d9f1c809f896749cb6e8d8e936afb0"},GENERAL_CAPABILITIES=["094613584C7F11D18222444553540000","0946135C4C7F11D18222444553540000","0946135b4c7f11d18222444553540000","0946135E4C7F11D18222444553540000","AABC2A1AF270424598B36993C6231952","1f99494e76cbc880215d6aeab8e42268"],WEBRTC_CAPABILITIES=["094613504c7f11d18222444553540000","094613514c7f11d18222444553540000","094613564c7f11d18222444553540000","094613503c7f11d18222444553540000"],INTEREST_CAPABILITIES=["8eec67ce70d041009409a7c1602a5c84","094613504c7f11d18222444553540000","094613514c7f11d18222444553540000","094613564c7f11d18222444553540000"],SESSION_TIMEOUT=30*_WA48.DAY,LANG_MAP={ru:"ru-RU",en:"en-US",de:"de-DE",pt:"pt-BR"},API_SCHEMA_CLASSIC=1,API_SCHEMA_RAPI=2,API_SCHEMA_V1_1=3,CLIENT_VERSION=VERSION_JS.split(":")[0],CLIENT_NAME=_WA48.configurator.getOption("api_client"),WEB_CLIENT_NAME="web"+CLIENT_NAME,SENDIM_METHOD_POST=!0,FETCH_EVENTS_TIMEOUT=3e4,locale=_WA48.resLanguage||"en",extLocale=LANG_MAP[locale],mrimKey,dialogEventsList=["bday","addedToBuddyList","buddyReg","buddyFound","voip"],WIM_VERSION_API_HOST,WIM_API_HOST,RAPI_HOST,BINARY_API_HOST,COMAPI_BASE_URL,STORE_BASE_URL,FILES_BASE_URL,SECURE_FILES_BASE_URL,FETCH_PHONE_STATUS_URL,FETCH_PHONE_CLOSE_URL,CLIENT_LOGIN_URL,STORE_GET_SHOWCASE,STORE_GET_CONTENT,STORE_GET_PACK_INFO,STORE_GET_SUGGEST,STORE_INSTALL_PACK,STORE_REMOVE_PACK,STORE_GET_MY,FILES_UPLOAD_INIT,FILES_GETINFO,FILES_GETSPEECH,FILES_INFO,FILES_GDPR_CHECK,FILES_GDPR_GET,SECURE_AVATAR_API,getSDCCookie=function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",c=_WA48.urlBuilder.getUrl("sdcCookieAuth");console.log("###getSDCCookie",c),makeJsonpRequest(c,{from:b},"JSONP_call",function(b){console.log("### Get SDC OK:",b),a&&a(!0)},null,function(b){console.log("### Get SDC Failed:",b),a&&a(!1)})},initApiUrls=function(){var a=_WA48.urlBuilder.getUrl("mainApi"),b=_WA48.urlBuilder.getUrl("binaryApiHost");WIM_API_HOST=a+"/wim/",WIM_VERSION_API_HOST=a+"/wim/",RAPI_HOST=a+"/rapi",COMAPI_BASE_URL=a+"/misc/www",FILES_BASE_URL=a+"/files",SECURE_FILES_BASE_URL=a+"/files/"+(a.indexOf("/api/v")>-1?"":"api/v1.1/"),STORE_BASE_URL=a+"/store",BINARY_API_HOST=b,FETCH_PHONE_STATUS_URL=COMAPI_BASE_URL+"/waphone/popup.php",FETCH_PHONE_CLOSE_URL=COMAPI_BASE_URL+"/waphone/close.php",CLIENT_LOGIN_URL=WIM_API_HOST+"auth/clientLogin",STORE_GET_SHOWCASE=STORE_BASE_URL+"/store/showcase",STORE_GET_CONTENT=STORE_BASE_URL+"/openstore/contentlist",STORE_GET_PACK_INFO=STORE_BASE_URL+"/openstore/filespackinfowithmeta",STORE_GET_SUGGEST=STORE_BASE_URL+"/openstore/tags",STORE_INSTALL_PACK=STORE_BASE_URL+"/store/buy/free",STORE_REMOVE_PACK=STORE_BASE_URL+"/store/deletepurchase",STORE_GET_MY=STORE_BASE_URL+"/store/my",FILES_UPLOAD_INIT=FILES_BASE_URL+"/init",FILES_GETINFO=FILES_BASE_URL+"/getinfo",FILES_GETSPEECH=FILES_BASE_URL+"/speechtotext/",FILES_GDPR_CHECK=FILES_BASE_URL+"/gdpr/check/",FILES_GDPR_GET=BINARY_API_HOST+"/files/gdpr/get/",FILES_INFO=SECURE_FILES_BASE_URL+"info/",SECURE_AVATAR_API=BINARY_API_HOST+"/files/"+(a.indexOf("/api/v")>-1?"":"api/v1.1/")},getXhr=function(){return new XMLHttpRequest},getAimsid=function(){var a=null;return _WA48.wimApi.beforeSendEvent.fire(function(b){a=b}),a},makeXhr=function(a,b){return _WA48.Sys.makeXhr(a,b).then(function(a){var c=b.responseSchema||API_SCHEMA_CLASSIC,d=a.status,e=a.data||{},f=d;return b.fetchHeaders||(c===API_SCHEMA_CLASSIC?(e=e.response,f=e&&e.statusCode,e=e&&e.data):c===API_SCHEMA_RAPI||c===API_SCHEMA_V1_1&&(f=e&&e.status&&e.status.code,e=e.result)),200!==d||200!==f&&!b.allowEmptyBody?Promise.reject([d,f]):e})},createReqId=function(){return _WA48.uniq()+"-"+_WA48.now()},makeJsonpRequest=function(a,b,c,d,e,f){var g,h="c"+_WA48.uniq(),i="jscb_tmp_"+h,j="",k=a.indexOf("fetchEvents")>-1&&b.timeout;b=b||{},b[c||"callback"]=i,_WA48.onlineManager.onNetworkRequestStart(h,b.timeout),b.timeout&&(g=_WA48.setTimeout(function(){_WA48.onlineManager.onNetworkRequest("timeout",h),f&&f.call(e||window,{message:"js timeout"}),f=null,window[i]=function(c){_U39.Mnt.log({reason:"jsonpTimeout",text:"call_removed_callback:email="+_WA48.ACTIVE_MAIL,url:a,events:c&&c.events&&c.events.length,params:JSON.stringify(b)}),delete window[i];var d=document.querySelector('script[src="'+j+'"]');d&&document.body.removeChild(d)}},b.timeout+1e4)),window[i]=function(a){g&&clearTimeout(g),delete window[i],_WA48.onlineManager.onNetworkRequest("success",h,k&&a),_U39.Mnt.wrapTryCatch(function(){d&&d.call(e||window,a)});var b=document.querySelector('script[src="'+j+'"]');b&&document.body.removeChild(b)};var l=_DomUtil26.getBody().dom.appendChild(document.createElement("script"));_DomUtil26.get(l).on("error",function(a){g&&clearTimeout(g),delete window[i],_WA48.onlineManager.onNetworkRequest("error",h),f&&f.call(e||window,a),_WA48.isProduction&&_U39.Mnt.catchException(a.error||a,"jsonp");var b=document.querySelector('script[src="'+j+'"]');b&&document.body.removeChild(b)},_WA48),l.type="text/javascript";for(var m=Object.keys(b).sort(),n=[],o=0;o<m.length;o++){var p=m[o];n[n.length]=p+"="+_WA48.urlBuilder.encodeURIComponentFull(b[p])}n=n.join("&");var q=a.indexOf("?")>0?"&":"?";return j=a+q+n,l.src=j,h},clearJsonpRequest=function(a){var b="jscb_tmp_"+a;return window[b]?void console.log("TRY TO CLEAR ACTIVE REQUEST: "+a):delete window[b]},transformIcqUin=function(a){return-1!==a.indexOf("@uin.icq")&&(a=a.replace("@uin.icq","")),a},trimFriendlyName=function(a){return(a||"").trim()},parseHistoryMessage=function(a,b,c,d,e,f,g){a.time=_WA48.getFixedTS(a.time),a.chat&&a.chat.sender&&(a.chat.sender=transformIcqUin(a.chat.sender));var h,i,j=a.outgoing||a.originator===_WA48.ACTIVE_MAIL?_WA48.ACTIVE_MAIL:b,k=a.chat&&!a.outgoing?a.chat.sender||j:j,l=a.text||"",m=3,n=a.msgId,o=a.time,p="event"===a["class"],q=c[k]||{aimId:k};if(g&&(n<=g.lastRead?m=5:n<=g.lastDelivered&&(m=4)),a.chat)if(a.chat.mail=b,a.chat.timestamp=o,a.chat.msgId=n,a.chat.persons=c,a.chat.eventTypeId=a.eventTypeId,l&&p&&a.eventTypeId&&(a.chat.modifiedInfo=a.chat.modifiedInfo||{}),a.chat.memberEvent){if(a.chat.memberEvent.members){p=!0,i=a.chat.memberEvent.type,e.push(["chatMember",a.chat]);var r=[];_U39.Array.each(a.chat.memberEvent.members,function(b,d){a.chat.memberEvent.members[d]=b=transformIcqUin(b),r.push(c[b]||{aimId:b})});var s=(a.chat.memberEvent.members.join(",").replace(/@uin\.icq/g,"")+",").indexOf(k.replace("@uin.icq","")+",")>-1;h={members:r,self:s,type:a.chat.type,sender:q}}}else a.chat.modifiedInfo&&(a.chat.mail=b,a.chat.senderInfo=q,d.push(["chatModified",a.chat]),"27:58000"===a.eventTypeId?(i="pinMessage",h={type:a.chat.type,sender:q}):a.chat.modifiedInfo.name||_WA48.isString(a.chat.modifiedInfo.about)||_WA48.isString(a.chat.modifiedInfo.rules)?(p=!0,i=_WA48.isString(a.chat.modifiedInfo.rules)?"modifiedRules":a.chat.modifiedInfo.name?"rename":"modify",h={name:a.chat.modifiedInfo.name,about:a.chat.modifiedInfo.about,rules:a.chat.modifiedInfo.rules,type:a.chat.type,sender:q}):a.chat.modifiedInfo.avatarLastModified&&(p=!0,i="changeIcon",h={type:a.chat.type,sender:q}));if(p&&!h&&_U39.Array.each(dialogEventsList,function(d){return a[d]?(i=d,h={sender:a.outgoing?c[b]||{aimId:b}:q},h[d]=a[d],!1):void 0},_this4),a.parts){var t=[],u=[];_U39.Array.each(a.parts,function(a){a.sn&&(a.sn=transformIcqUin(a.sn),a.friendly=trimFriendlyName(a.friendly),a.friendly=a.friendly||c[a.sn]&&c[a.sn].friendly,a.uNick=a.uNick||a.nick||c[a.sn]&&c[a.sn].nick),a.contact&&(a.contact.name&&a.contact.phone?a.text=a.contact.name+" "+a.contact.phone:delete a.contact),a.captionedContent&&(a.captionedContent.url?a.text=" ".concat(a.captionedContent.url," ").concat(a.captionedContent.caption||""):delete a.captionedContent),(a.text||a.stickerId||a.contact||a.captionedContent||a.poll)&&(a.sn&&"text"!==a.mediaType&&"sticker"!==a.mediaType?u.push(a):t=a)}),a.parts=u.concat(t),u.length||t.captionedContent||!(t.text||t.stickerId||t.contact)||(delete a.parts,t.contact&&(a.contact=t.contact),t.poll&&(a.poll=t.poll),t.text?l=t.text:t.stickerId&&(a.sticker={id:t.stickerId}))}a.snippets&&a.snippets.forEach(function(a){Object.keys(a).forEach(function(b){_WA48.snippet.cacheSnippetInfo(b,a[b])})}),"voip"===i&&"accept"===h.voip.type&&(a.hidden=!0);var v={dialogSn:b,dialogName:a.chat&&a.chat.name||q.friendly,from:j,sender:k,senderFriendly:q.friendly,timestamp:o,arch_id:n,state:m,event:i||p,info:h,hidden:!!a.hidden,parts:a.parts,parse:a.parse,snippets:a.snippets||null,mentions:a.mentions,mid:a.msgId,updated:a.updatePatchVersion,text:l};return a.chat&&a.chat.modifiedInfo&&(v.modifiedInfo=a.chat.modifiedInfo),a.contact&&(v.contact=a.contact),a.poll&&(v.poll=a.poll),a.inlineKeyboardMarkup&&(v.inlineKeyboardMarkup=a.inlineKeyboardMarkup),a.hideEdit&&(v.hideEdit=a.hideEdit),a.sticker&&(v.sticker=a.sticker.id),v},EventGuide=function(){function a(){_classCallCheck2(this,a),this._buddyInfo={},this.translateEvent=new _U39.Event}return _createClass2(a,[{key:"eachEvent",value:function(a,b,c){var d=[];return _U39.Array.each(a,function(a){d=d.concat(this._translateEvent(a,b,c)||[])},this),d}},{key:"translateResponse",value:function(a,b){var c=this,d=[],e=b.uniq||0,f=b.requestParams,g={},h=[];switch(a){case"preference/getPermitDeny":b.persons&&b.persons.forEach(function(a){g[a.sn]=a,c._buddyInfo[a.sn]||(c._buddyInfo[a.sn]={aimId:a.sn,friendly:a.friendly,uNick:a.nick})}),b.ignores&&(h=b.ignores.map(function(a){return g[a]||(c._buddyInfo[a]?{sn:a,friendly:c._buddyInfo[a].friendly,uNick:c._buddyInfo[a].uNick}:{sn:a})})),d.push(["ignoreList",h]);break;case"im/sendIM":if(b.msgId&&b.uniq){var i={message_id:b.uniq,wimId:b.msgId,timestamp:b.ts};"string"==typeof b.histMsgId&&(i.arch_id=b.histMsgId),d.push(["messageSent",i])}break;case"im/sendSticker":if(b.msgId&&b.uniq){var j={message_id:b.uniq,wimId:b.msgId,timestamp:b.ts};"string"==typeof b.histMsgId&&(j.arch_id=b.histMsgId),d.push(["messageSent",j])}break;case"aim/endSession":d.push(["logout",{}]);break;case"mrim/getKey":mrimKey=b.mrimkey;break;case"webrtc/alloc":d.push(["webrtcAlloc",b]);break;case"getChatHome":d.push(["liveChats",b]);break;case"findChat":case"search":d.push([a,b]);break;case"getChatInfo":var k=[];_U39.Array.each(b.members,function(a){a.sn=transformIcqUin(a.sn),a.friendly=trimFriendlyName(a.friendly),k.push(a.sn),a.email=a.sn,a.aimId=a.sn,a.role||(a.role="member"),_U39.Object.extend(a,a.anketa||{}),a.uNick=a.nick,delete a.anketa,a.friendly&&_WA48.CLD.saveFriendly(a.sn,a.friendly)}),b.membersList=k,d.push(["chatInfo",b]);break;case"getRecentWriters":d.push(["recentWriters",b]);break;case"getChatAdmins":var l=[];_U39.Array.each(b.members,function(a){!a.sn||"moder"!==a.role&&"admin"!==a.role||(a.sn=transformIcqUin(a.sn),l.push(_U39.Object.extend({email:a.sn,aimId:a.sn,role:a.role,creator:a.creator},a.anketa||{})))}),b.list=l,b.sn=b.requestParams.sn,d.push(["adminList",b]);break;case"getChatBlocked":case"getPendingList":var m=[];_U39.Array.each(b.list,function(a){a.sn&&(a.sn=transformIcqUin(a.sn),m.push(_U39.Object.extend({email:a.sn,aimId:a.sn},a.anketa||{})))}),b.list=m,b.sn=b.requestParams.sn,d.push(["getChatBlocked"===a?"blockedMembers":"pendingList",b]);break;case"createChat":break;case"searchOneDialog":case"searchAllDialogs":var n="searchOneDialog"===a?b.entryCount:b.totalEntryCount,o="searchOneDialog"===a?b.cursorOne:b.cursorAll,p={keyword:f.filter&&f.filter.keyword,entryCount:n,exhausted:b.exhausted,cursorOne:o,history:[],persons:b.persons,requestParams:f};g={},_U39.Array.each(b.persons||[],function(a){a.sn=transformIcqUin(a.sn),a.friendly=trimFriendlyName(a.friendly),g[a.sn]={aimId:a.sn,friendly:a.friendly,nick:a.nick}});var q=function(a,b){_U39.Array.each(b||[],function(b){var c=parseHistoryMessage(b.message,a,g,[],[],this._buddyInfo);c.event&&_WA48.Feature.getModeParameter("skipEventMessages")&&(c.hidden=!0),c.highlight=b.highlight,p.history.push(c)},this)},r="searchOneDialog"===a?[{sn:f.sn,entries:b.entries}]:b.dialogs;_U39.Array.each(r,function(a){q(a.sn,a.entries)},this),d.push([a,p]);break;case"getHistory":if(b.messages){var s=b.requestParams.sn,t=-20==b.requestParams.count,u={email:s,reqId:b.requestParams.reqId,lastRead:b.yours&&b.yours.lastRead||null,historyBack:t,history:[],intro:[],patchVersion:b.patchVersion,patch:b.patch,persons:b.persons,pinned:b.pinned,olderMsgId:b.olderMsgId,newerMsgId:b.newerMsgId,patchRequested:1==b.requestParams.count||-1==b.requestParams.count&&-1==b.requestParams.fromMsgId,getModifiedMsg:b.requestParams.tillMsgId,requestParams:b.requestParams};b.theirs&&(u.theirs=b.theirs);var v,w=[],x=[];_U39.Array.each(b.persons||[],function(a){a.sn=transformIcqUin(a.sn),a.friendly=trimFriendlyName(a.friendly),g[a.sn]={aimId:a.sn,friendly:a.friendly,nick:a.nick}}),_U39.Array.each(b.messages,function(a){v=parseHistoryMessage(a,s,g,x,w,this._buddyInfo,b.theirs),v.event&&_WA48.Feature.getModeParameter("skipEventMessages")&&(v.hidden=!0),u.history.push(["message",v])},this),b.intro&&_U39.Array.eachReverse(b.intro.messages,function(a){v=parseHistoryMessage(a,s,g,x,w,this._buddyInfo),v.event&&_WA48.Feature.getModeParameter("skipEventMessages")&&(v.hidden=!0),u.intro.push(["message",v])},this),w.length&&(b.chatMemberEvents=w),x.length&&(b.chatModifiedEvents=x),d.push(["contactHistory",u])}break;case"getUserInfo":b&&d.push(["wp",{uniq:e||f.reqId,result:Object.keys(b).length>1?[this._fetchUserInfo(f.sn,b)]:[]}]);break;case"getEntryGallery":var y=!1,z=!1,A={},B={};h={sn:f.sn,galleryState:b.galleryState,patch:b.patch,delUpto:b.delUpto},_U39.Array.each(b.persons||[],function(a){a.sn=transformIcqUin(a.sn),a.friendly=trimFriendlyName(a.friendly),a.uNick=a.nick,g[a.sn]=a}),h.persons=g,_U39.Array.each(b.subreqs||[],function(a){A[a.subreqId]||(A[a.subreqId]=[]),a.entries&&a.entries.length&&(y=a.includeStart||y,z=a.includeEnd||z,_U39.Array.each(a.entries,function(b){var c=b.id.mid+"_"+b.id.seq;B[c]||(B[c]=!0,A[a.subreqId].push(b))}))}),A.older&&A.older[0]&&A.older[0].time<A.older[A.older.length-1].time&&A.older.reverse(),A.newer&&A.newer[0]&&A.newer[0].time<A.newer[A.newer.length-1].time&&A.newer.reverse(),h.startIsReached=y,h.endIsReached=z,h.items=(A.newer||[]).concat(A.older||[]),h.requestParams=b.requestParams,d.push(["getGallery",h])}return d}},{key:"_translateEvent",value:function(b){var c,d=[],e=b.eventData;switch(e.persons&&_WA48.CLD&&_U39.Array.each(e.persons,function(a){a.friendly=trimFriendlyName(a.friendly),a.friendly&&_WA48.CLD.saveFriendly(a.sn,a.friendly)}),b.type){case"buddylist":e.groups&&(this._cacheBuddies(e.groups),d.push(["contactList",this._makeClist()]));break;case"permitDeny":d.push(this.translateResponse("preference/getPermitDeny",e)[0]);break;case"diff":if(e.length){var f=this._updateBuddiesCache(e);console.log("@!@! form api contactListDiff",f),d.push(["contactListDiff",f]),d.push(["contactList",this._makeClist()])}break;case"typing":if("typing"!==e.typingStatus)break;e.aimId=transformIcqUin(e.aimId);var g;e.MChat_Attrs&&e.MChat_Attrs.sender&&(g=e.MChat_Attrs.options&&e.MChat_Attrs.options.senderName?e.MChat_Attrs.options&&e.MChat_Attrs.options.senderName:transformIcqUin(e.MChat_Attrs.sender)),d.push(["typingNotify",{from:e.aimId,sender:g,timestamp:_WA48.now(),composing:!0,message_id:_WA48.uniq()}]);break;case"mchat":d.push(["chatEvent",e.mchats||[]]);break;case"galleryNotify":case"hiddenChat":case"mentionMeMessage":case"webrtcMsg":case"pollUpdate":case"asyncResponse":d.push([b.type,e]);break;case"chatHeadsUpdate":case"suggest":d.push([b.type,e]);break;case"histDlgState":if(e.sn=transformIcqUin(e.sn),a.fixedSn&&a.fixedSn!==e.sn)break;if(e.messages||e.tail){if(e.messages&&1===e.messages.length&&e.messages[0].event&&"statusReply"===e.messages[0].event.type)break;c={messages:e.messages||e.tail.messages,intro:e.intro||null,suspicious:e.suspicious,stranger:!!e.stranger,persons:e.persons,requestParams:{sn:e.sn},olderMsgId:e.olderMsgId,yours:e.yours,theirs:e.theirs},e.historyPart=this.translateResponse("getHistory",c)[0][1]}e.mchatState&&d.push(["mchatState",_U39.Object.extend({sn:e.sn},e.mchatState)]),e.yours&&e.yours.lastRead&&e.lastMsgId&&e.lastMsgId<=e.yours.lastRead&&(e.unreadCnt=0),d.push(["historyState",e]),d.push(["archSync",{"with":e.sn,count:e.unreadCnt,unreadCount:e.unreadCnt,attention:e.attention,mentionCount:e.unreadMentionMeCount,lastReadMention:e.lastReadMention,lastRead:e.yours&&e.yours.lastRead,lastMsgId:e.lastMsgId,starting:e.starting}]),c&&(c.chatMemberEvents&&d.push.apply(d,c.chatMemberEvents),c.chatModifiedEvents&&d.push.apply(d,c.chatModifiedEvents));break;case"presence":d.push(["contactStatus",this._fetchBuddyContactStatus(e,!0)]);break;case"myInfo":d.push(["myInfo",this.fetchMyInfo(e)]);break;case"sessionEnded":d.push(["logout",{endCode:e.endCode,offReason:e.offReason}]);break;case"userAddedToBuddyList":e.requester=transformIcqUin(e.requester);var h={from:e.requester,authRequested:e.authRequested,timestamp:_WA48.now(),nickname:e.displayAIMid||e.requester,text:e.msg||_WA48.tr("msgAddMePlease"),request:{authorize:!!e.authRequested,delivery:!0}};d.push(["authRequest",h]);break;case"sentIM":break;case"apps":e.appsData&&e.appsData.store&&d.push(["storeCommand",e.appsData.store]);break;case"lifestream":break;default:console.log("icq origin",b.type,b.eventData)}return d}},{key:"fetchMyInfo",value:function(a){return a.aimId=transformIcqUin(a.aimId),{aimId:a.aimId,email:a.aimId,status:"online",statusTitle:null,attachedPhoneNumber:a.attachedPhoneNumber,official:!!a.official,friendly:a.friendly,nickname:a.friendly,uNick:a.nick,largeIconId:a.largeIconId||"",userAgreement:a.userAgreement}}},{key:"_fetchBuddyContactStatus",value:function(a,b){var c=transformIcqUin(a.aimId),d={sn:c,email:c,uNick:a.nick,onlineTime:a.onlineTime,status:{type:"",title:""},nickname:trimFriendlyName(a.friendly),abContactName:a.abContactName,abPhoneNumber:a.abPhoneNumber,mute:a.mute&&1,official:a.official||0,largeIconId:a.largeIconId||"",change:!!b};return _WA48.isObject(a.userState)?(d.userState=a.userState.state,d.lastseen=a.userState.lastseen):("userState"in a&&(d.userState=a.userState),"lastseen"in a&&(d.lastseen=a.lastseen)),a.bot&&(d.bot=!0),d}},{key:"_fetchUserInfo",value:function(a,b){var c=_WA48.isObject(b.userState)&&b.userState||{state:b.userState,lastseen:b.lastseen};return{email:a,nickname:b.friendly,uNick:b.nick,friendly:b.friendly,avatarId:b.avatarId,lastseen:c.lastseen,userState:c.state,phone:b.phone,firstname:b.firstName,lastname:b.lastName,aboutMe:b.about,official:!!b.official,mute:!!b.mute,hasPassword:b.hasPassword,commonChats:b.commonChats,bot:b.bot}}},{key:"_makeClist",value:function(){return this.__cacheCL}},{key:"_updateBuddiesCache",value:function(a){var b,c,d=this.__cacheCL||[],e={},f=[],g={},h={},i=this._buddyInfo||{};return _U39.Array.each(a,function(a){a&&a.data&&("deleted"===a.type?_U39.Array.each(a.data,function(c){c&&c.id&&c.buddies&&c.buddies.length&&(b=e[c.id]||{},_U39.Array.each(c.buddies,function(d){d.aimId=transformIcqUin(d.aimId),b[d.aimId]=d,f.push({groupId:c.id,groupName:c.name,patchType:a.type,buddy:d})}),e[c.id]=b)}):("created"===a.type||"updated"===a.type)&&_U39.Array.each(a.data,function(d){d&&d.id&&d.buddies&&d.buddies.length&&(c=d.id,b=g[c]||{id:c,name:d.name,buddies:[]},_U39.Array.each(d.buddies,function(g){g.aimId=transformIcqUin(g.aimId),g.status="",e[c]&&e[c][g.aimId]||(b.buddies.push(g),f.push({groupId:d.id,groupName:d.name,patchType:a.type,buddy:g}))},this),g[c]=b)},this))},this),_U39.Array.each(d,function(a){c=a.id,b=a.buddies,a.buddies=[],_U39.Array.each(b,function(b){e[c]&&e[c][b.aimId]||(h[b.aimId]=b,a.buddies.push(b),0!==b.aimId.indexOf("+")&&(i[b.aimId]=b))}),g[c]&&(_U39.Array.each(g[c].buddies,function(b){if(h[b.aimId]){var c=b.aimId;_U39.Object.each(h[c],function(a,d){
h[c][d]=b[d],delete b[d]}),_U39.Object.extend(h[c],b,!0)}else h[b.aimId]=b,a.buddies.push(b),0!==b.aimId.indexOf("+")&&(i[b.aimId]=b)}),delete g[c])}),_U39.Object.each(g,function(a){d.push(a)}),f}},{key:"_cacheBuddies",value:function(a){return this.__cacheCL=a,_U39.Array.each(a,function(a){_U39.Array.each(a.buddies,function(a){a.aimId=transformIcqUin(a.aimId),a.status="",0!==a.aimId.indexOf("+")&&(this._buddyInfo[a.aimId]=a)},this)},this),this.__cacheCL}}],[{key:"setFixedChatSn",value:function(b){a.fixedSn=b}}]),a}(),ServiceApi=function(){function a(){_classCallCheck2(this,a)}return _createClass2(a,[{key:"getPromoChatData",value:function(a){if(!a)return Promise.reject();var b=_WA48.urlBuilder.getPromoChatUrl(a);return _WA48.Sys.makeXhr(b).then(function(a){return a.data})}},{key:"getUserMpopData",value:function(){var a=_WA48.getUserCookieLogin();if(SECURE_MPOP_COOKIE){var b=_WA48.urlBuilder.getUrlWithQuery("authMailPage",{mac:1,rnd:99999*Math.random()});return _WA48.Sys.makeXhr(b,{withCredentials:!0}).then(function(a){var b=a.data&&a.data.data;return console.log("IM:Api:getUserMpopData:GOT ACCOUNTS:active email=",b&&b.email),b})}return a?Promise.resolve({email:a}):Promise.reject()}},{key:"setUserMpopCookie",value:function(a){var b=_WA48.urlBuilder.getUrlWithQuery("authMailPage",{mac:1,Login:a,rnd:99999*Math.random()});return console.log("IM:Api:setUserMpopCookie"),_WA48.Sys.makeXhr(b,{method:"POST",withCredentials:!0}).then(function(b){var c=b.data&&b.data.data;return console.log("IM:Api:setUserMpopCookie:result=",c&&c.email),c.email===a?c:!1})}},{key:"loginByMpopCookie",value:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise(function(c,d){console.log("IM:Api:loginByMpopCookie:try="+b);var e=_WA48.urlBuilder.getUrl("mrimLoginAuth");return e?void a._requestMrimLogin(e).then(function(a){c(a)},function(f){462===f&&2>b?(console.log("### NO SDC DETECTED!!!!"),getSDCCookie(function(e){e?a.loginByMpopCookie(b+1).then(c,d):d(f)},e)):d(f)}):d(0)})}},{key:"_requestMrimLogin",value:function(a){return new Promise(function(b,c){var d={clientName:WEB_CLIENT_NAME,clientVersion:CLIENT_VERSION,devId:DEV_ID,r:createReqId(),f:"json"},e=getXhr();e.open("POST",a,!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),e.withCredentials=!0,e.onreadystatechange=function(){if(4===e.readyState){var a=e.status,d=e.responseText;if(d=d.replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"),d=d?JSON.parse(d):{error:"request blocked"},200===a&&d&&d.response&&d.response.statusCode){var f=d.response.statusCode;200===f?(_U39.Mnt.err("mpopLoginOk",d.response.data),b(d.response.data)):c(f)}else c(a)}}.bind(this),e.send(_WA48.urlBuilder.chainParams(d))})}}]),a}(),API=function(){function a(){_classCallCheck2(this,a),this.triggerEvent=new _U39.Event,this.beforeTriggerEvent=new _U39.Event,this.afterTriggerEvent=new _U39.Event,this.beforeSendEvent=new _U39.Event,this.afterSendEvent=new _U39.Event,this._lastMethodCall="",this._eGuide=new EventGuide,this.triggerEvent.relay(this._eGuide.translateEvent)}return _createClass2(a,[{key:"fetchMyInfo",value:function(a){return this._eGuide.fetchMyInfo(a)}},{key:"_send",value:function(a,b,c,d,e,f){var g=null,h=b.r||createReqId();if(this.beforeSendEvent.fire(function(a){g=a},a),_U39.Object.extend(b,{f:"json",aimsid:g,r:h}),this._lastMethodCall=a,f){var i=(+new Date,getXhr());_WA48.onlineManager.onNetworkRequestStart(h),i.open("POST",WIM_VERSION_API_HOST+a,!0),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),i.onreadystatechange=function(){if(4===i.readyState){var b,f=i.status,g=i.responseText,j=!1;200===f&&(g=g.replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"),"im/sendIMim/sendSticker".indexOf(a)>-1&&(g=g.replace(/(histMsgId|beforeHistMsgId)":\s*(\d{15,})\s*(?=[,}\]])/g,'$1": "$2"')),g=JSON.parse(g||"{}"),j=this._handleResponse(a,g,e||0),b=g.response&&g.response.statusCode),this.afterSendEvent.fire(a,j),200===f?(_WA48.onlineManager.onNetworkRequest("success",h),c&&c.call(d||window,!!j,b)):(_WA48.onlineManager.onNetworkRequest("error",h),c&&c.call(d||window,!1,f))}}.bind(this),i.send(_WA48.urlBuilder.chainParams(b))}else makeJsonpRequest(WIM_VERSION_API_HOST+a,b,"c",function(b){var f=this._handleResponse(a,b,e||0);this.afterSendEvent.fire(a,f);var g=b.response&&b.response.statusCode;c&&c.call(d||window,!!f,g)},this,function(a){c&&c.call(d||window,!1)});return h}},{key:"_fireEvents",value:function(a){a.length&&(this.beforeTriggerEvent.fire(),_U39.Array.each(a,function(a){this.triggerEvent.fire(a[0],a[1])},this),this.afterTriggerEvent.fire())}},{key:"_handleResponse",value:function(a,b,c){if(b&&b.response){var d,e=b.response.data;if(200===b.response.statusCode||2e4===b.response.statusCode)return e&&(e.uniq=c,d=this._eGuide.translateResponse(a,e),this._fireEvents(d)),!0;401===b.response.statusCode?(console.log("401: Authentication Required"),this.triggerEvent.fire("logout",{endCode:410,offReason:b.response.statusText})):602===b.response.statusCode?(console.log("602: Target not available",e),e&&(e.uniq=c,d=this._eGuide.translateResponse(a,e),this._fireEvents(d))):console.log("##########  WE HAVE RESPONSE ERROR:",b)}}},{key:"fetchEvents",value:function(a,b){var c={timeout:b.quickResponse?500:FETCH_EVENTS_TIMEOUT};return _WA48.configurator.getOption("enable_smart_reply_text")&&!_WA48.Feature.getModeParameter("disableSmartReply")&&(c.supportedSuggestTypes="text-smartreply",_WA48.configurator.getOption("enable_smart_reply_stickers")&&(c.supportedSuggestTypes+=",sticker-smartreply")),b.hiddenMode&&(c.bg=1,c.hidden=1),makeXhr(a,{method:"GET",params:c,responseSchema:API_SCHEMA_CLASSIC})}},{key:"eachEvent",value:function(a){var b=this._eGuide.eachEvent(a);this._fireEvents(b)}},{key:"translateEvents",value:function(a){return this._eGuide.eachEvent(a)}},{key:"setTimezone",value:function(){var a=(new Date).getTimezoneOffset();return this._send("timezone/set",{TimeZoneOffset:60*-a})}},{key:"sendMessage",value:function(a,b,c){var d={t:a.to,r:a.r||null};return a.parse&&(d.parse=JSON.stringify(a.parse)),a.mentions&&(d.mentions=a.mentions.join(",")),a.smartReplyMeta&&(d.smartReplyMeta=JSON.stringify(a.smartReplyMeta)),a.text?(d.message=a.text,a.updateMsgId&&(d.updateMsgId=a.updateMsgId)):a.parts instanceof Array&&(d.parts=JSON.stringify(a.parts),a.updateMsgId&&(d.updateMsgId=a.updateMsgId)),this._send("im/sendIM",d,b,c,a.message_id,SENDIM_METHOD_POST)}},{key:"sendSticker",value:function(a,b,c){var d={t:a.to,stickerId:a.code,offlineIM:1,r:a.r||null};return this._send("im/sendSticker",d,b,c,a.message_id)}},{key:"sendTyping",value:function(a,b,c){return this._send("im/setTyping",a,b,c)}},{key:"sendLooking",value:function(a,b,c){var d={t:a.to,typingStatus:"looking"};return this._send("im/setTyping",d,b,c)}},{key:"setUnreadFlag",value:function(a,b,c){var d={sn:a.sn,value:a.unread?1:0};d.sn&&this._send("recently/setAttentionAttribute",d,b,c)}},{key:"updateProfile",value:function(a,b,c,d){var e={firstname:"firstName",lastname:"lastName",aboutMe:"aboutMe"},f=e[a]+"="+b;return this._send("memberDir/update",{set:f},c,d)}},{key:"removeContact",value:function(a,b,c){var d={allGroups:!0,buddy:a.email};return this._send("buddylist/removeBuddy",d,b,c)}},{key:"addChatMembers",value:function(a,b,c){if(!a.members||!a.members.length)return void(b&&b.call(c||window,400));var d=[];_U39.Array.each(a.members,function(a){d.push(a[0])});var e={chat_id:a.email,members:d.join(";")};return this._send("mchat/AddChat",e,b,c)}},{key:"delChatMembers",value:function(a,b,c){if(!a.members||!a.members.length)return void(b&&b.call(c||window,400));var d=[];_U39.Array.each(a.members,function(a){d.push(a[0])});var e={chat_id:a.email,members:d.join(";")};return this._send("mchat/DelMembers",e,b,c)}},{key:"hideActiveDialog",value:function(a,b,c){var d={buddy:a.email,lastMsgId:a.lastMsgId};return this._send("buddylist/hideChat",d,b,c)}},{key:"muteContact",value:function(a,b,c){var d={buddy:a.sn,eternal:a.mute};return this._send("buddylist/Mute",d,b,c)}},{key:"getIgnoreList",value:function(a,b,c){var d={friendly:!0};return this._send("preference/getPermitDeny",d,b,c)}},{key:"ignoreContact",value:function(a,b,c){var d={};return d[a.unignore?"pdIgnoreRemove":"pdIgnore"]=a.email,this._send("preference/setPermitDeny",d,b,c)}},{key:"modifyContact",value:function(a,b,c){var d={allGroups:!0,t:a.email,friendly:a.nickname,serviceName:"aim"};return this._send("buddylist/setBuddyAttribute",d,b,c)}},{key:"setSessionParam",value:function(a,b,c){var d={includePresenceFields:""};return this._send("aim/setSessionParam",d,b,c)}},{key:"validateSid",value:function(a,b){this._send("aim/validateSid",{k:DEV_ID},a,b)}},{key:"startSessionP",value:function(a,b){_U39.Mnt.radar("startSession");var c=_WA48.RTCTools.isEnabled(),d=c?INTEREST_CAPABILITIES.join(","):"",e=GENERAL_CAPABILITIES.concat(c?WEBRTC_CAPABILITIES:[]).join(",");return _WA48.Sys.getDeviceId().then(function(c){var f={a:decodeURIComponent(a),ts:b,k:DEV_ID,view:"online",clientName:WEB_CLIENT_NAME,language:extLocale,deviceId:c,sessionTimeout:SESSION_TIMEOUT,assertCaps:e,interestCaps:d,events:"myInfo,presence,buddylist,typing,hiddenChat,hist,mchat,sentIM,imState,dataIM,offlineIM,userAddedToBuddyList,service,lifestream,apps,permitDeny,diff,webrtcMsg",includePresenceFields:"aimId,displayId,friendly,friendlyName,state,userType,statusMsg,statusTime,lastseen,ssl,mute,abContactName,abPhoneNumber,abPhones,official,quiet,autoAddition,largeIconId,nick,userState"};return _WA48.Sys.makeXhr(WIM_VERSION_API_HOST+"aim/startSession",{method:"POST",params:f}).then(function(a){return a&&a.data&&a.data.response})})}},{key:"webrtcAlloc",value:function(a,b){var c={t:a,type:"voip",ts:_WA48.now(),k:DEV_ID};console.log("### send webrtcAlloc"),this._send("webrtc/alloc",c,b)}},{key:"webrtcMsg",value:function(a,b){this._send("voip/webrtcMsg",a,b,null,null,!0)}},{key:"endSession",value:function(a,b,c){this._send("aim/endSession",{invalidateToken:1},b,c)}},{key:"requestMrimKey",value:function(a){this._send("mrim/getKey",{email:_WA48.ACTIVE_MAIL},a)}}]),a}(),ComAPI=function(){function a(){_classCallCheck2(this,a)}return _createClass2(a,[{key:"redirectToBindPhonePage",value:function(a){_WA48.wimApi.requestMrimKey(function(b){if(b&&mrimKey){var c={client_code:"myteam",back_url:_WA48.urlBuilder.getUrl("bindPhoneReturnPage"),utm_campaign:"security",utm_source:"webim",utm_medium:"bind"};a||(c.nocancel=1);var d=_WA48.urlBuilder.getUrlWithQuery("accountMailBindPhonePage",c),e={Login:_WA48.ACTIVE_MAIL,agent:mrimKey,ver:CLIENT_VERSION,Page:d,agentlang:"ru"};window.location=_WA48.urlBuilder.getUrlWithQuery("authMailPage",e)}})}},{key:"fetchPhonePopupStatus",value:function(a,b,c){var d={client:CLIENT_NAME,platform:"web",lang:locale,login:_WA48.ACTIVE_MAIL};makeJsonpRequest(FETCH_PHONE_STATUS_URL,d,"callback",function(c){a&&a.call(b||window,c)},b,c)}},{key:"sendPhonePopupClose",value:function(){return _WA48.Sys.makeXhr(FETCH_PHONE_CLOSE_URL,{params:{login:_WA48.ACTIVE_MAIL}})}},{key:"requestPhoneCode",value:function(a,b,c,d){var e={msisdn:a,locale:locale,countryCode:"ru",k:DEV_ID,version:CLIENT_VERSION,platform:"web",client:CLIENT_NAME,checks:b?"ivr":"sms",r:_WA48.uniq()},f=_WA48.urlBuilder.getUrl("phoneValidation"),g=getXhr();g.open("POST",f,!0),g.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),g.onreadystatechange=function(){if(4===g.readyState){var a=g.status,b=g.responseText;b=b.replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"),b=JSON.parse(b||"{}"),b&&(b=b.response),200===a&&200===b.statusCode?c&&c(b.data):d&&d(a,b&&b.statusCode,b&&b.statusDetailCode)}}.bind(this),g.send(_WA48.urlBuilder.chainParams(e))}},{key:"getTokenByPhoneCode",value:function(a,b,c){var d={msisdn:a,trans_id:b,sms_code:c,locale:locale,k:DEV_ID,platform:"web",create_account:1,client:CLIENT_NAME,r:_WA48.uniq()},e=_WA48.urlBuilder.getUrl("loginWithPhone");return _U39.Mnt.radar("tokenBySms"),makeXhr(e,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:_WA48.urlBuilder.chainParams(d)})}},{key:"requestOTP",value:function(a){var b={tokenType:"otp_via_email",clientName:WEB_CLIENT_NAME,clientVersion:CLIENT_VERSION,idType:"ICQ",s:a,k:DEV_ID};return makeXhr(CLIENT_LOGIN_URL+"?"+_WA48.makeGet(b),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:"pwd=1"})}},{key:"requestClientLogin",value:function(a,b){var c={tokenType:"longTerm",clientName:WEB_CLIENT_NAME,clientVersion:CLIENT_VERSION,idType:"ICQ",s:a,k:DEV_ID},d="pwd="+encodeURIComponent(b);return makeXhr(CLIENT_LOGIN_URL+"?"+_WA48.makeGet(c),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},data:d}).then(function(a){return a.sessionKey=_WA48.Sys.hma(b,a.sessionSecret),a})}},{key:"requestAttachPhoneCode",value:function(a,b,c,d){var e=_WA48.Sys.getCredentials(),f={msisdn:a,trans_id:b,locale:locale,sms_code:c,a:e.a,k:DEV_ID,ts:_WA48.nowFixed(),r:createReqId()},g=_WA48.urlBuilder.getUrlWithQuery("attachPhone",f);return _WA48.Sys.makeXhr(g,{method:"POST",withCredentials:!0}).then(function(a){d(a.status,a.data&&a.data.response)},function(a){var b=_slicedToArray(a,1),c=b[0];d(c,null)})}},{key:"sendAcceptGDPR",value:function(a){var b=_WA48.Sys.getCredentials(),c={gdpr_pp:a,a:b.a,k:DEV_ID,ts:_WA48.nowFixed(),r:createReqId()};"ignore"===a&&(c.reset=1);var d=_WA48.urlBuilder.getUrlWithQuery("gdprSave",c);return makeXhr(d,{method:"POST",withCredentials:!0})}}]),a}(),RAPI=function(){function a(){_classCallCheck2(this,a),this.triggerEvent=new _U39.Event,this.beforeTriggerEvent=new _U39.Event,this.afterTriggerEvent=new _U39.Event,this.beforeSendEvent=new _U39.Event,this._sendingTries={},this._eGuide=new EventGuide}return _createClass2(a,[{key:"_fireEvents",value:function(a){a.length&&(this.beforeTriggerEvent.fire(),_U39.Array.each(a,function(a){this.triggerEvent.fire(a[0],a[1])},this),this.afterTriggerEvent.fire())}},{key:"_handleRapiResponse",value:function(a,b,c,d){if(200!==a.status)return 0;var e=a.responseText;e=e.replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"),("getHistory"===c||"searchOneDialog"===c||"searchAllDialogs"===c||"getEntryGallery"===c)&&(e=e.replace(/(delUpto|msgId|"mid)":\s*(\d{15,})\s*(?=[,}\]])/g,'$1": "$2"')),e=JSON.parse(e||"{}");var f,g=5e4,h=null;if(e&&e.status)if(g=e.status.code,f=Math.floor(g/100),200===f&&e.results){e.results.requestParams=b||{},e.results.requestParams.reqId=d,h=e.results;var i=this._eGuide.translateResponse(e.method,e.results);this._fireEvents(i)}else 405===f&&(this._rateLimitReached=_WA48.now());return{fullCode:g,resultData:h}}},{key:"_sendRequest",value:function(a,b,c,d,e){var f={reqId:a,aimsid:d};d||delete f.aimsid,c&&(f.params=c);var g=RAPI_HOST+"/"+b,h=getXhr();_WA48.onlineManager.onNetworkRequestStart(a);var i=JSON.stringify(f);"getEntryGallery"===b?i=i.replace(/("mid)":\s*"(\d{15,})"\s*(?=[,}\]])/g,'$1": $2'):"delMsgBatch"===b&&(i=i.replace(/"msgIds":\s*\[([\d",]+)]/,function(a,b){return'"msgIds":['+b.replace(/"(\d{5,})"/g,"$1")+"]"})),h.open("POST",g,!0),h.setRequestHeader("Content-Type","application/json"),h.onreadystatechange=function(){4===h.readyState&&_U39.Mnt.wrapTryCatch(function(){_WA48.onlineManager.onNetworkRequest(200===h.status?"success":"error",a);var d=this._handleRapiResponse(h,c,b,a)||0,f=d.fullCode,g=d.resultData;e.call(this,f,g)},this)}.bind(this),h.send(i)}},{key:"send",value:function(a,b,c,d){var e=createReqId();this._sendingTries[e]=0;var f=null;this.beforeSendEvent.fire(function(a){f=a},a);var g=function(h,i){var j=Math.floor(h/100);this._sendingTries[e]<3&&200!==j&&401!==j&&404!==j&&405!==j&&400!==j?this._trySend(e,a,b,f,g):(delete this._sendingTries[e],c&&c.call(d||window,j,e,h,i))}.bind(this);return this._trySend(e,a,b,f,g),e}},{key:"sendP",value:function(a,b){var c=this,d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new Promise(function(e,f){var g=createReqId();c._sendingTries[g]=0,d.instantResolve&&e({reqId:g});var h=null;c.beforeSendEvent.fire(function(a){h=a},a);var i=function j(i,k){var l=Math.floor(i/100),m=200===l||401===l||404===l||405===l||400===l;c._sendingTries[g]<3&&!m?d.retryOnOnline?_WA48.onlineManager.waitForOnline().then(function(){c._trySend(g,a,b,h,j)}):c._trySend(g,a,b,h,j):(delete c._sendingTries[g],m?e({resultCode:l,reqId:g,fullCode:i,data:k}):f({resultCode:l,reqId:g,fullCode:i,data:k}))};c._trySend(g,a,b,h,i)})}},{key:"_isRateLimitTriggered",value:function(){return!!this._rateLimitReached&&_WA48.now()-this._rateLimitReached<3600}},{key:"_trySend",value:function(a,b,c,d,e){this._sendingTries[a]&&this._isRateLimitTriggered()||(this._sendingTries[a]++,this._sendRequest(a,b,c,d,e))}},{key:"getHistory",value:function(a,b,c){if(a.msgId&&-1!=a.msgId&&!/^[0-9]+$/.test(""+a.msgId))return void console.log("**TRY TO GET HISTORY WITH WRONG ID",a.msgId);var d={sn:a.email,fromMsgId:""+(a.msgId||-1),count:a.count||-20,lang:locale,mentions:{resolve:!1},patchVersion:a.patchVersion||"init"};return a.tillMsgId&&(d.tillMsgId=a.tillMsgId),this.send("getHistory",d,b,c)}},{key:"delHistory",value:function(a,b,c){if(a.msgId&&-1!=a.msgId&&!/^[0-9]+$/.test(""+a.msgId))return void console.log("**TRY TO GET HISTORY WITH WRONG ID",a.msgId);var d={sn:a.email,uptoMsgId:""+(a.msgId||-1)};this.send("delHistory",d,b,c)}},{key:"delMessage",value:function(a,b,c){if(a.msgId&&a.email){var d={sn:a.email,msgIds:[a.msgId]};a.shared&&(d.shared=!0),this.send("delMsgBatch",d,b,c)}}},{key:"pinMessage",value:function(a,b,c){var d={sn:a.sn,msgId:""+a.msgId,unpin:a.unpin};this.send("pinMessage",d,b,c)}},{key:"getLiveChats",value:function(a,b,c){a=a||{};var d={memberLimit:a.memberLimit||5};a.tag&&(d.tag=a.tag),this.send("getChatHome",d,b,c)}},{key:"joinChat",value:function(a,b,c){a=a||{};var d={stamp:a.stamp};d.stamp&&this.send("joinChat",d,b,c)}},{key:"findChat",value:function(a,b,c){if(a=a||{},a.query){var d={query:a.query};a.tag&&(d.tag=a.tag),this.send("findChat",d,b,c)}}},{key:"search",value:function(a,b,c){if(a=a||{},a.keyword||a.phonenum||a.tag){var d=a.keyword?{keyword:a.keyword}:{tag:a.tag};return a.phonenum&&(d={phonenum:a.phonenum}),this.send("search",d,b,c)}}},{key:"searchDialog",value:function(a,b,c){return a.mentions={resolve:!1},this.send("searchOneDialog",a,b,c)}},{key:"searchAllDialogs",value:function(a,b,c){return a.mentions={resolve:!1},this.send("searchAllDialogs",a,b,c)}},{key:"getChatInfo",value:function(a,b,c){var d={sn:a.email};a.stamp&&(delete d.sn,d.stamp=a.stamp),a.limit&&(d.memberLimit=a.limit),this.send("getChatInfo",d,b,c)}},{key:"getCommonChats",value:function(a,b,c){this.send("getCommonChats",a,b,c)}},{key:"getChatWriters",value:function(a,b,c){this.send("getRecentWriters",a,b,c)}},{key:"getBlockedMembers",value:function(a,b,c){var d={sn:a};this.send("getChatBlocked",d,b,c)}},{key:"getChatAdmins",value:function(a,b,c){this.send("getChatAdmins",{sn:a},b,c)}},{key:"getPendingList",value:function(a,b,c){var d={sn:a};this.send("getPendingList",d,b,c)}},{key:"getAvatarUrl",value:function(a,b){var c=null;return this.beforeSendEvent.fire(function(a){c=a}),SECURE_AVATAR_API+"avatar/get?targetSn="+a+"&aimsid="+c+"&size="+b}},{key:"uploadAvatar",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c={};return this.beforeSendEvent.fire(function(a){c.aimsid=a}),b.sn&&(c.targetSn=b.sn),b.creating&&(c.beforehandUpload=1),makeXhr(SECURE_AVATAR_API+"avatar/set",{method:"POST",params:c,headers:{"X-Requested-With":"XMLHttpRequest"},data:a,allowEmptyBody:!0,fetchHeaders:!0}).then(function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return Promise.resolve({id:a["x-avatar-hash"]})})}},{key:"addChatMembers",value:function(a,b,c){if(!a.members||!a.members.length)return void(b&&b.call(c||window,400));var d=[];_U39.Array.each(a.members,function(a){d.push({sn:a[0]})});var e={sn:a.email,members:d};this.send("addChatMembersAlpha",e,b,c)}},{key:"modifyChat",value:function(a,b,c){a.sn=a.email,delete a.email,this.send("modChat",a,b,c)}},{key:"modifyChatMember",value:function(a,b,c){var d={sn:a.email,memberSn:a.member,role:a.role||"member"};this.send("modChatMember",d,b,c)}},{key:"resolvePending",value:function(a,b,c){var d=[];if(a.email){a.member?d=[{sn:a.member,approve:!!a.approve}]:a.members&&(d=a.members);var e={sn:a.email,members:d};d.length&&this.send("chatResolvePending",e,b,c)}}},{key:"blockChatMembers",value:function(a,b,c){var d=[];a.member?d=[{sn:a.member}]:a.members&&(d=a.members);var e={sn:a.email,members:d,deleteLastMessages:!!a.withMessages};d.length&&this.send("blockChatMembers",e,b,c)}},{key:"unblockChatMembers",value:function(a,b,c){var d=[];a.member?d=[{sn:a.member}]:a.members&&(d=a.members);var e={sn:a.email,members:d};d.length&&this.send("unblockChatMembers",e,b,c)}},{key:"createChat",value:function(a,b,c){var d=a||{},e=[];_U39.Array.each(a.members||[],function(a){e.push({sn:a[0]})}),d.name=d.name||e.length>1&&a.members[0][1]+", "+a.members[1][1],d.members=e,d.name&&this.send("createChat",d,b,c)}},{key:"createGroupChat",value:function(a){var b=a||{},c=[];return _U39.Array.each(a.members||[],function(a){c.push({sn:a[0]})}),b.name=b.name||c.length>1&&a.members[0][1]+", "+a.members[1][1],b.members=c,this.sendP("createChat",b)}},{key:"setDialogState",value:function(a,b,c){if(a.msgId){var d={sn:a.email,lastRead:a.msgId,exclude:a.exclude||[]};this.send("setDlgState",d,b,c)}}},{key:"approveDialog",value:function(a){this.send("setDlgState",{sn:a,stranger:!1})}},{key:"reportAbuse",value:function(a,b,c){var d={sn:a.sn,context:a.context,reason:a.reason};this.send("reportAbuse",d,b,c)}},{key:"delChatMembers",value:function(a,b,c){if(!a.members||!a.members.length)return void(b&&b.call(c||window,400));var d=[];_U39.Array.each(a.members,function(a){d.push({sn:a[0]})});var e={sn:a.email,members:d};this.send("delChatMembersAlpha",e,b,c)}},{key:"getUserInfo",value:function(a,b,c){var d={sn:a.sn};return this.send("getUserInfo",d,b,c)}},{key:"getGallery",value:function(a,b,c){var d={sn:a.sn,entriesInPatch:!0};a.patchVersion&&(d.galleryPatchVersion=a.patchVersion);var e,f,g=[],h=a.from;a.patchVersion&&(d.galleryPatchVersion=a.patchVersion),a.till?(e={subreqId:"older",fromEntryId:h||"max",tillEntryId:a.till,entryCount:a.count||100},a.type&&(e.urlType=a.type),(!h||h.mid>a.till.mid||h.mid===a.till.mid&&h.seq>a.till.seq)&&(e.entryCount=-e.entryCount),g.push(e)):a.count&&(e={subreqId:"older",fromEntryId:h||"max",entryCount:-a.count-1},a.type&&(e.urlType=a.type),g.push(e)),a.countNewer&&a.from&&(f={subreqId:"newer",fromEntryId:h,entryCount:a.countNewer},a.type&&(f.urlType=a.type),g.push(f)),d.subreqs=g,this.send("getEntryGallery",d,b,c)}},{key:"addContactByPhone",value:function(a,b,c){if(a.name&&a.phone){var d={update:[{name:a.name,phoneList:[a.phone]}]};this.send("addressBookSync",d,b,c)}}},{key:"getIdInfo",value:function(a,b,c){var d={id:a};this.send("getIdInfo",d,b,c)}},{key:"checkNick",value:function(a,b,c){var d={nick:a};this.send("checkNick",d,b,c)}},{key:"setNick",value:function(a,b,c){var d={nick:a};this.send("setNick",d,b,c)}},{key:"getSuggests",value:function(a,b,c){var d={sn:a.sn,suggestTypes:[]};return a.withSmartReply&&d.suggestTypes.push({type:"sticker-smartreply"}),a.text&&d.suggestTypes.push({type:"sticker-by-text",text:a.text}),d.suggestTypes.length&&d.sn?this.send("getSuggests",d,b,c):void 0}},{key:"getPoll",value:function(a,b){this.send("poll/get",{id:a,subscribe:!0},b)}},{key:"votePoll",value:function(a,b,c){this.send("poll/vote",{id:a,answerId:b},c)}},{key:"revokePoll",value:function(a,b){this.send("poll/revoke",{id:a},b)}},{key:"stopPoll",value:function(a,b){this.send("poll/stop",{id:a},b)}},{key:"groupSubscribe",value:function(a,b,c){var d={stamp:a};this.send("group/subscribe",d,b,c)}},{key:"generatePrivateGroupStamp",value:function(a,b,c){var d={sn:a};this.send("suggestPrivateGroupStamp",d,b,c)}},{key:"generatePublicGroupStamp",value:function(a,b,c){var d={sn:a};this.send("suggestPublicGroupStamp",d,b,c)}},{key:"checkGroupStamp",value:function(a,b,c){var d={stamp:a};this.send("checkGroupStamp",d,b,c)}},{key:"sessionList",value:function(a,b){this.send("session/list",null,a,b)}},{key:"sessionReset",value:function(a,b,c){this.send("session/reset",{hash:a},b,c)}},{key:"sessionResetAll",value:function(a,b){this.send("session/resetAll",null,a,b)}},{key:"checkPassword",value:function(a,b,c){this.send("auth/isStrongPassword",{password:a},b,c)}},{key:"resetPassword",value:function(a,b,c,d){this.send("auth/resetPassword",{newPassword:b},c,d)}},{key:"sendCode",value:function(a,b,c){var d={phone:a,language:extLocale,route:b?"ivr":"sms",devId:DEV_ID,application:CLIENT_NAME};this.send("auth/sendCode",d,c)}},{key:"deleteAccount",value:function(a,b,c){this.send("auth/deleteAccount",a,b,c)}},{key:"getPrivacySettings",value:function(a){return this.sendP("getPrivacySettings",null,a)}},{key:"updatePrivacySettings",value:function(a,b){return this.sendP("updatePrivacySettings",a,b)}},{key:"botAction",value:function(a){return this.sendP("getBotCallbackAnswer",a,{instantResolve:!0})}}]),a}(),StoreAPI=function(){function a(){_classCallCheck2(this,a),this.commonParams={lang:extLocale.replace("-","_"),client:CLIENT_NAME,platform:"web"}}return _createClass2(a,[{key:"_send",value:function(a,b,c,d,e){var f=_WA48.Sys.getCredentials();return _WA48.apply(b,{a:f.a,k:DEV_ID,ts:_WA48.nowFixed()},this.commonParams),_WA48.Sys.makeXhr(a,{method:e?"POST":"GET",params:b}).then(function(a){c&&c(a&&a.data)},function(a){var b=_slicedToArray(a,1),c=b[0];d&&d(c)})}},{key:"getShowcase",value:function(a,b){this._send(STORE_GET_SHOWCASE,{},a,b)}},{key:"getContent",value:function(a,b){this._send(STORE_GET_CONTENT,{},a,b)}},{key:"getMyStore",value:function(a,b,c){this._send(STORE_GET_MY,c?{suggest:1}:{},a,b)}},{key:"getSuggest",value:function(a,b){this._send(STORE_GET_SUGGEST,{suggest:1},a,b)}},{key:"getPackInfo",value:function(a,b,c){this._send(STORE_GET_PACK_INFO,a,b,c)}},{key:"installPack",value:function(a,b){this._send(STORE_INSTALL_PACK,{product:a},b)}},{key:"removePack",value:function(a,b){this._send(STORE_REMOVE_PACK,{product_id:a},b,null,!0)}}]),a}(),FileAPI=function(){function a(){_classCallCheck2(this,a),this.progressEvent=new _U39.Event}return _createClass2(a,[{key:"getFileInfoSecure",value:function(a){var b=getAimsid();return makeXhr(FILES_INFO+a+"/?"+_WA48.makeGet({aimsid:b,previews:"192,600,800,xlarge"}),{method:"GET",responseSchema:API_SCHEMA_V1_1})}},{key:"initUploadUrl",value:function(a,b,c){var d={aimsid:getAimsid(),ts:_WA48.nowFixed(),size:b,filename:a,client:CLIENT_NAME};return c&&_WA48.apply(d,{type:"ptt",duration:c.duration,language:extLocale.replace("-","_")}),_WA48.Sys.makeXhr(FILES_UPLOAD_INIT,{method:"GET",params:d})}},{key:"uploadBytes",value:function(a,b,c,d,e,f){var g=this,h={"Content-Type":"application/octet-stream","X-Requested-With":"XMLHttpRequest","Content-Disposition":'attachment; filename="'+_WA48.urlBuilder.encodeURIComponentFull(b)+'"',"Content-Range":"bytes "+d+"-"+e+"/"+f};return _WA48.Sys.makeXhr(a+"?aimsid="+getAimsid(),{method:"POST",withCredentials:!0,headers:h,progress:function(a){a.lengthComputable&&g.progressEvent.fire(a.loaded,a.total)},data:c}).then(function(a){return 206===a.status||200===a.status?a:Promise.reject({errorId:5,status:a.status})},function(a){var b=_slicedToArray(a,1),c=b[0];return Promise.reject({errorId:4,status:c})})}},{key:"checkGDPRData",value:function(){var a=getAimsid();return makeXhr(FILES_GDPR_CHECK+"?"+_WA48.makeGet({aimsid:a,uid:_WA48.ACTIVE_MAIL}),{method:"GET",withCredentials:!0,responseSchema:API_SCHEMA_V1_1})}},{key:"getDownloadGDPRDataLink",value:function(){var a=getAimsid();return FILES_GDPR_GET+"?"+_WA48.makeGet({aimsid:a,uid:_WA48.ACTIVE_MAIL})}},{key:"getSpeechById",value:function(a){return _WA48.Sys.makeXhr(FILES_GETSPEECH+a,{method:"GET",params:{aimsid:getAimsid()}}).then(function(a){var b=a.data;return 200===b.status?b.text:Promise.reject([b.status])})}}]),a}(),MiscApi=function(){function a(){_classCallCheck2(this,a)}return _createClass2(a,[{key:"getUrlInfo",value:function(a){var b=_WA48.Sys.getCredentials(),c={url:a,v:1,domain:1,a:b.a,k:DEV_ID,ts:_WA48.nowFixed()},d=_WA48.urlBuilder.getUrlWithQuery("snippetInfo",c);return _WA48.Sys.makeXhr(d).then(function(a){var b=a.data,c={error:2};return b&&"OK"===b.status&&(c=b.doc),b&&"ERROR"===b.status&&(c={error:1}),c})}},{key:"sendStatistics",value:function(a){if(!_WA48.configurator.getOption("disable_tracking")){var b=-(new Date).getTimezoneOffset()/60,c=(navigator.language||navigator.browserLanguage||navigator.userLanguage||"").substr(0,5);_WA48.Sys.getDeviceId().then(function(d){var e={app:CLIENT_NAME,version:CLIENT_VERSION,branch:_WA48.Feature.getModeParameter("projectName")||"",platform:"web",osVersion:"",timezone:(b>=0?"+":"-")+Math.floor(Math.abs(b)),language:c,region:"",network:"",uin:a||"",ua:navigator.userAgent,devId:DEV_ID,deviceId:d,r:_WA48.uniq()};(new Image).src=_WA48.urlBuilder.getUrlWithQuery("statistics",e)})}}}]),a}();_WA48.urlBuilder.isConfigReady()&&initApiUrls(),_WA48.serviceApi=new ServiceApi,_WA48.wimApi=new API,_WA48.comApi=new ComAPI,_WA48.rapi=new RAPI,_WA48.StoreApi=new StoreAPI,_WA48.FileApi=new FileAPI,_WA48.miscApi=new MiscApi,_WA48.Api={setFixedChatSn:function(a){EventGuide.setFixedChatSn(a)},initApiUrls:initApiUrls,postEventToParent:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(_WA48.boardMode)try{var c=JSON.stringify({eventName:a,eventData:b});window.parent.postMessage(c,"*")}catch(d){}}};var _WA49=WebIM,_U40=_WA49.util,_S=_WA49.AccountStorage,SESSION_EXPIRE_DELAY=12e4,MAX_IDLE_TIME=12e5,MAX_RESTORE_INT=6e4,MAX_START_FETCHES_NUM=5,DAY=86400,AUTH_ERROR_CODES={NO_MPOP_COOKIE_FOUND:900,MPOP_COOKIE_WRONG_EMAIL:901,MPOP_COOKIE_SET_FAILED:902},getNotifierPermission=function(){_WA49.isDesktop&&!_WA49.boardMode&&_WA49.setTimeout(_WA49.Notifier.requestPermission,900,_WA49.Notifier)},LongPoller=function(){function a(){_classCallCheck2(this,a),this.triggerEvent=new _U40.Event,this.errorEvent=new _U40.Event,this.beforeConnectEvent=new _U40.Event,this._restore_int=1e3,this._delay=0,this._startFetchesNum=0,this._sequenceNum=0,this._url="",this._offlineMode=!1,this.connected=!1,this.forceQuickResponse=!0,this._fetchDelayTask=new _U40.DelayedTask({fn:this._fetchEvents,scope:this})}return _createClass2(a,[{key:"connect",value:function(a,b){if(this.connected)console.log("IM:Conn:Poller:connect: already connected");else{var c=a.replace("http://","//");this.beforeConnectEvent.fire(c),this._sequenceNum=0,delete this._startEventsReceived,this._delay=b||0,this._url=c,window.__T2=+new Date,console.log("IM:Conn:Poller:connect:starting"),this._fetchDelayTask.start(this._delay),this.connected=!0}}},{key:"disconnect",value:function(){this.connected=!1}},{key:"_fetchEvents",value:function(){var a=this;_WA49.wimApi.fetchEvents(this._url,{quickResponse:!!this.forceQuickResponse,hiddenMode:!!this.hiddenMode}).then(this._onResponse.bind(this),function(b){var c,d=_slicedToArray(b,2),e=d[0],f=d[1],g=f||e;f?c="http":200===e&&(c="connectTimeout"),a._onError(c||"interrupted",g)})}},{key:"_onResponse",value:function(a){if(this._offlineMode=!1,!this.connected||!a)return void console.log("Response ignored (disconnected)");if(!a||a.fetchBaseURL||a.events){this._sequenceNum++;var b=a.events&&!a.events.length;this._startEventsReceived||(b||this._sequenceNum>=MAX_START_FETCHES_NUM)&&(this._startEventsReceived=!0),this.forceQuickResponse=!this._startEventsReceived,this._url=a.fetchBaseURL,this._delay=a.timeToNextFetch,this._restore_int=1e3,this.triggerEvent.fire(a,this._startEventsReceived),this._url&&this._fetchDelayTask.start(a.timeToNextFetch)}}},{key:"_onError",value:function(a,b){switch(console.log("FETCH EVENTS ERROR",a,b),a){case"interrupted":case"connectTimeout":_U40.Mnt.err("timeout"),this._onHttpError(1);break;case"http":this._onHttpError(b);break;default:this._fetchDelayTask.start(this._delay)}}},{key:"_onHttpError",value:function(a,b){if(this.forceQuickResponse=!0,this.errorEvent.fire(a),
460!==a){var c=b&&b.reconnect_timeout||(2*this._restore_int<MAX_RESTORE_INT?this._restore_int*=2:MAX_RESTORE_INT);this._offlineMode||"offline"!==_WA49.onlineManager.getStatus()||(this._offlineMode=!0,_WA49.onlineManager.toggleEvent.on(function(a){"offline"!==a&&(this._offlineMode=!1,this._fetchDelayTask.stop(),this._fetchDelayTask.start(1e3))},this,{single:!0})),this._fetchDelayTask.start(1e3+c)}}}]),a}(),Connection=function(){function a(){var b=this;_classCallCheck2(this,a),this.triggerEvent=new _U40.Event,this.requestReadyEvent=new _U40.Event,this.requestableEvent=new _U40.Event,this.beforeReadyEvent=new _U40.Event,this.readyEvent=new _U40.Event,this.beforeResponseEvent=new _U40.Event,this.afterResponseEvent=new _U40.Event,this.preloadStartedEvent=new _U40.Event,this.preloadCompletedEvent=new _U40.Event,this.errorEvent=new _U40.Event,this.requestable=!1,this.stateEvent=new _U40.Event,this.statusChangedEvent=new _U40.Event,this.hotSessionRestartEvent=new _U40.Event,this.offlineModeEvent=new _U40.Event,this._poller=new LongPoller,this._poller.triggerEvent.on(this._onPollerEvent,this),this._poller.errorEvent.on(this._onPollerError,this),this._poller.beforeConnectEvent.on(this._onPollerBeforeConnectEvent,this),this.triggerEvent.relay(_WA49.wimApi.triggerEvent).on(this._onServerEvent,this),this.beforeResponseEvent.relay(_WA49.wimApi.beforeTriggerEvent),this.afterResponseEvent.relay(_WA49.wimApi.afterTriggerEvent),_WA49.wimApi.beforeSendEvent.on(function(a){a&&a.call(window,this.aimsid)},this),this.triggerEvent.relay(_WA49.rapi.triggerEvent),this.beforeResponseEvent.relay(_WA49.rapi.beforeTriggerEvent),this.afterResponseEvent.relay(_WA49.rapi.afterTriggerEvent),_WA49.rapi.beforeSendEvent.on(function(a){a&&a.call(window,this.aimsid)},this),_WA49.Storage.brokenStorageEvent.on(function(a){var c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";_WA49.Storage.load(["icqConnect","restartSessionKey"],function(d){var e="";try{e=Object.keys(localStorage).map(function(a){return a+"="+localStorage[a].length}).join(",")}catch(f){}_U40.Mnt.log({reason:"brokenLocalStorage",sn:_WA49.ACTIVE_MAIL,key:a,valueSize:c.length,storageKeysSize:e});var g;_WA49.AccountStorage.load(["option_flags","option_theme","option_media"],function(a){g=a});try{localStorage.clear()}catch(f){}_WA49.Storage.save(d),_WA49.AccountStorage.save(g),b._relogin()})}),this.aimsid=null}return _createClass2(a,[{key:"_onPollerBeforeConnectEvent",value:function(a){this.preloadStartedEvent.fire(),this.denyRemoteResourceLoading()}},{key:"_onPollerError",value:function(a){this.requestable=!1,460===a?(this.disconnect(),this.offlineModeEvent.fire(),console.log("IM:Conn:_onPollerError:RESTORE AFTER 460 ###"),this._restoringAfterInvalidAimsid||(this._restoringAfterInvalidAimsid=!0,this.forceRestore())):(this.allowRemoteResourceLoading(),this.errorEvent.fire(a))}},{key:"_onPollerEvent",value:function(a,b){var c=this;if(!this.requestable&&this.connected()&&(_WA49.Sys.getSessionData(["socket.date"],function(a,b){if(a){var d=+new Date;d-(b["socket.date"]||0)>MAX_IDLE_TIME&&c._poller.disconnect()}}),!this.connected())){var d;return-1!==_WA49.ACTIVE_MAIL.indexOf("@corp.mail.ru")&&_U40.Mnt.wrapTryCatch(function(){d=_WA49.wimApi.eachEvent(a.events)}),this.hotSessionRestartEvent.fire(d),void this.forceRestore()}_WA49.Sys.saveSessionData({"socket.date":+new Date}),this.requestable||(this.requestable=!0,delete this._restoringAfterInvalidAimsid,this.requestReadyEvent.fire(),this.fireRequestableEvent(),this._onSocketRequestable()),_WA49.Sys.modifyCredentials(function(b){b.respTs=_WA49.ts(),b.fetchUrl=a.fetchBaseURL,b.delay=a.timeToNextFetch;var d=a.fetchBaseURL&&a.fetchBaseURL.match(/aimsid=([0-9.:]+:([^@:]+@[0-9a-zA-Zа-яА-Я\-.]+|[0-9]+))/)||null,e=a.fetchBaseURL&&a.fetchBaseURL.match(/&rnd=([0-9]{10,})\.[0-9]+/)||null;d&&d[1]!==c.aimsid&&(console.log("IM:Conn:_onPollerEvent: AIMSID CHANGED! ###### from "+c.aimsid+" to "+d[1],e),b.aimsid=c.aimsid=d[1],e&&(b.ts=e[1]))}),_U40.Mnt.wrapTryCatch(function(){_WA49.wimApi.eachEvent(a.events)}),b&&!this._preloadCompleted&&(this._preloadCompleted=!0,this.allowRemoteResourceLoading(),this.preloadCompletedEvent.fire(),_WA49.Feature.getModeParameter("disableUserRequiredDataChecking")||this.checkUserRequiredData())}},{key:"tryStartSession2020",value:function(a){var b=this,c=a.a,d=a.ts,e=a.sessionKey,f=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!1;return new Promise(function(a,g){_WA49.wimApi.startSessionP(c,d).then(function(d){console.log("IM:Conn:tryStartSession:statusCode:",d&&d.statusCode),d&&200===d.statusCode?(d.data.a=c,d.data.sessionKey=e,_WA49.ACTIVE_MAIL=d.data.myInfo.aimId,_WA49.ACTIVE_IS_UIN=_WA49.isUIN(_WA49.ACTIVE_MAIL),a(d.data)):d&&400===d.statusCode&&d.data&&!f?b.tryStartSession2020({a:c,ts:d.data.ts,sessionKey:e},!0).then(a,g):d&&440===d.statusCode?(g([0,null]),location.reload(!0)):g(d&&d.statusCode?[d.statusCode]:[2,null])},function(a){var b=_slicedToArray(a,1),c=b[0];g([c,null])})})}},{key:"_relogin",value:function(a){var b=this;if(this.logginIn)return console.log("IM:Conn:_relogin:[TRYING TO REPEAT LOGIN]"),Promise.reject();this.logginIn=!0,this._successCookieLogin&&(a=this._successCookieLogin,delete this._successCookieLogin);var c;return a?c={a:a.token.a,ts:a.hostTime,sessionKey:a.sessionKey}:_WA49.Sys.modifyCredentials(function(a){a.ts=_WA49.nowFixed(),c=a}),_U40.Mnt.countRB(32744042),console.log("IM:Conn:_relogin:loginId=",a&&a.loginId),_WA49.ConnectionFacade.tryStartSession2020(c).then(function(a){b.logginIn=!1,_U40.Mnt.countRB(32744045),b._onStartSessionSuccess(a)},function(a){var c=_slicedToArray(a,1),d=c[0];if(b.logginIn=!1,d>0){console.log("*** "+d+" ***");var e=d>=440&&452>=d;return void b.logout(e)}b.fireStatusChange("offline")})}},{key:"checkUserAbleToLogin",value:function(a){return console.log("IM:Conn:checkUserAbleToLogin: forced=",a),a?_WA49.serviceApi.getUserMpopData().then(function(){var b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},c=b.email;if(c===a)return Promise.resolve();if(c){var d=b.list||[];return console.log("IM:Conn:checkUserAbleToLogin:account list:",d),d.indexOf(a)>-1?_WA49.serviceApi.setUserMpopCookie(a).then(function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return a?Promise.resolve():Promise.reject(AUTH_ERROR_CODES.MPOP_COOKIE_SET_FAILED)}):(console.log("IM:Conn:checkUserAbleToLogin:unable to login "+a+", mpop="+c),Promise.reject(AUTH_ERROR_CODES.MPOP_COOKIE_WRONG_EMAIL))}return console.log("IM:Conn:checkUserAbleToLogin: no cookie found"),Promise.reject(AUTH_ERROR_CODES.NO_MPOP_COOKIE_FOUND)}):Promise.resolve()}},{key:"loginByMailCookie",value:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return this.checkUserAbleToLogin(b).then(function(){return _WA49.Sys.removeSessionData(["socket.date","socket.restoreDate","socket.session"]),_S.remove(["selfnick","self_unick"]),_WA49.ACTIVE_MAIL=!1,_WA49.Sys.removeCredentials(),_WA49.serviceApi.loginByMpopCookie().then(function(b){return _WA49.serverTimeDiff=_WA49.now()-b.hostTime,_U40.Mnt.countRB(50271788),_WA49.ACTIVE_MAIL=b.loginId,_WA49.ACTIVE_IS_UIN=_WA49.isUIN(_WA49.ACTIVE_MAIL),a._successCookieLogin=b,Promise.resolve(b)},function(a){return"object"===_typeof2(a)&&(a=JSON.stringify(a)),console.log("###loginByMpopCookie failed: code=",a),Promise.reject(a)})})}},{key:"startNewSession",value:function(a,b){var c=a.myInfo,d=_WA49.now()-a.ts,e=Math.round(1e5*Math.random());_WA49.serverTimeDiff=d;var f=(navigator.language||navigator.browserLanguage||navigator.userLanguage).substr(0,5).toLowerCase(),g=_WA49.orientation.indexOf("landscape")>-1?"h":_WA49.orientation.indexOf("portrait")>-1?"v":_WA49.orientation;this.aimsid=a.aimsid,_U40.Mnt.log({loginInfo:3,sn:_WA49.ACTIVE_MAIL,lang:_WA49.resLanguage,olang:f,tdiff:d,touch:+_WA49.isTouchDevice,orien:g,embed:+(top!==window),ratio:window.devicePixelRatio||0,scr:screen.width+"_"+screen.height}),_WA49.Sys.saveSessionData({"socket.date":+new Date,"socket.session":e}),_S.save({"status.forced":"","status.requested":"online",server_time_diff:d,firstload:b?1:0}),c.official&&_S.save({"status.official":1}),console.log("IM:Conn:startNewSession: saving aimsid "+a.aimsid),_WA49.Sys.modifyCredentials(function(b){_WA49.apply(b,{aimsid:a.aimsid,fetchUrl:a.fetchBaseURL,sessionKey:a.sessionKey,ts:a.ts,respTs:_WA49.ts(),phone:c.attachedPhoneNumber||"",a:a.a})})}},{key:"_onStartSessionSuccess",value:function(a){console.log("IM:Conn:startSession:success:",a&&a.myInfo),this.aimsid=a.aimsid,this.requestable=!0,this.fireRequestableEvent();var b=_WA49.wimApi.fetchMyInfo(a.myInfo);b.skipAttachedNumberCheck=!0,getNotifierPermission(),_WA49.wimApi.setTimezone(),this.startNewSession(a),this.triggerEvent.fire("myInfo",b),delete this._preloadCompleted,this._poller.connect(a.fetchBaseURL),this.connecting=!1,this._setStatusOnline()}},{key:"logout",value:function(a){var b=this,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};App.clearHistory(),this.disconnect(),_WA49.wimApi.endSession({},function(){b.aimsid=null}),_S.save({"status.forced":"","status.requested":"offline"}),_WA49.Sys.removeSessionData(["socket.date","socket.restoreDate","socket.session"]).then(function(){_S.remove(["selfnick","self_unick"]),_WA49.ACTIVE_MAIL=!1,_WA49.Sys.removeCredentials(),_WA49.Storage.remove(["clist_list","clist_list_length","dialogs_data","avatar_hash","autoaway"],function(){a?location.reload():_WA49.boardMode?_WA49.Feature.getModeParameter("disableManualAuthorization")||(_WA49.Feature.getModeParameter("loginWithoutReload")?setTimeout(function(){location.reload()},50):_WA49.redirectToAuthPage(c)):_WA49.redirectToAuthPage(c)})})}},{key:"connected",value:function(){return this._poller.connected}},{key:"isValidP",value:function(){return new Promise(function(a,b){_S.brokenStorages.localStorage?a(!1):_WA49.Sys.getSessionData(["socket.date"],function(c,d){if(c){var e=+new Date;a(e-(d["socket.date"]||0)<SESSION_EXPIRE_DELAY?!0:!1)}else b()})})}},{key:"restore",value:function(){if(this.connected())return void console.log("IM:Conn:restore:ALREADY CONNECTED");_WA49.boardMode&&_WA49.Feature.getModeParameter("tryUseMainAuthData")&&(_WA49.ACTIVE_MAIL||_WA49.Sys.useDefaultStorage());var a=this.getStatus();"offline"===a?(this._commitForcedStatus(),this.fireStatusChange("offline",null,3)):(_WA49.Sys.checkRestartSessionKey(),this.forceRestore())}},{key:"forceRestore",value:function(){var a=this;if(this.connected()){console.log("IM:Conn:forceRestore:ALREADY CONNECTED");var b=this.getStatus();if("offline"!==b)return;this.forceOnline()}console.log("IM:Conn:forceRestore:start"),this.isValidP().then(function(b){a.connecting=!0,b?(console.log("IM:Conn:forceRestore:session valid"),_WA49.Sys.getSessionData(["socket.restoreDate"],function(b,c){if(b){var d=+new Date,e=d-(c["socket.restoreDate"]||0);0>e?(_WA49.Sys.saveSessionData({"socket.restoreDate":0}),a.fireStatusChange("offline")):e>=5e3?a._restoreValidConnection():_WA49.setTimeout(a._restoreValidConnection,5e3-e,a)}})):(console.log("IM:Conn:forceRestore:session NOT valid"),a._relogin())},function(b){console.log("IM:Conn:forceRestore:session NOT valid",b),a.connecting=!0,a._relogin()})}},{key:"getSessionId",value:function(a,b){_WA49.Sys.getSessionData(["socket.session"],function(c,d){c&&a.call(b||window,d["socket.session"])})}},{key:"fireStatusChange",value:function(a){"offline"===a&&this.allowRemoteResourceLoading(),a!==this._lastStatusChanged&&(this._lastStatusChanged=a,console.log("IM:Conn:fireStatusChange:statusChangedEvent.fire() st="+a),this.statusChangedEvent.fire(a))}},{key:"getStatus",value:function(){return _WA49.boardMode?"online":(_S.load(["status.requested","status.forced"],{success:function(a){this.currentStatus=a["status.forced"]||a["status.requested"]||"online"},scope:this}),this.currentStatus)}},{key:"_setStatusOnline",value:function(){this.currentStatus="online",console.log("IM:Conn:_setStatusOnline:this.connected="+this.connected()),this.connected()?this.fireStatusChange("online"):this.offlineModeEvent.fire()}},{key:"forceOnline",value:function(){_S.save({"status.forced":"online","status.requested":""}),this.currentStatus="online",this.fireStatusChange("online")}},{key:"forceOffline",value:function(){_S.save({"status.forced":"offline"}),this.currentStatus="offline",this.disconnect(),_S.save({"status.forced":"","status.requested":"offline"})}},{key:"goAway",value:function(a){delete this._poller.hiddenMode,a!==!1&&(this._poller.hiddenMode=!0)}},{key:"_onSocketRequestable",value:function(){_S.load(["status.forced"],{success:function(a){console.log("IM:Conn:_onSocketRequestable:status.forced="+a["status.forced"]),a["status.forced"]&&("offline"===a["status.forced"]?this.forceOffline():this._setStatusOnline())},scope:this})}},{key:"_commitForcedStatus",value:function(){_S.load(["status.requested","status.forced"],{success:function(a){a["status.forced"]&&_S.save({"status.forced":"","status.requested":a["status.forced"]})}})}},{key:"_onServerEvent",value:function(a,b){switch(a){case"myInfo":if(_S.save({"status.forced":"","status.requested":"online"}),this.currentStatus="online",this.fireStatusChange("online",null,1),!_WA49.configurator.getOption("disable_phone_attach")&&!_WA49.Feature.getModeParameter("disableUserRequiredDataChecking"))if(b.attachedPhoneNumber||b.skipAttachedNumberCheck){if(b.attachedPhoneNumber){var c=this.getAttachedPhone();c&&c===b.attachedPhoneNumber||this.setAttachedPhone(b.attachedPhoneNumber)}}else _WA49.configurator.getOption("phone_attach_options")?this.checkAttachPhoneWithConfig():this.checkAttachPhonePopupWithStatusRequest();break;case"logout":return!b||142!==b.endCode&&143!==b.endCode?(this.disconnect(),!1):this.logout()}}},{key:"_checkProfileComplete",value:function(){var a=!1;return _S.load(["profileIncomplete"],function(b){a="1"===b.profileIncomplete}),a?WebIM.SelfProfilePage.showStartProfileDialog().then(function(){_S.remove(["profileIncomplete"])}):Promise.resolve()}},{key:"checkUserRequiredData",value:function(){var a=this;this._checkProfileComplete().then(function(){return _WA49.configurator.getOption("disable_phone_attach")?void 0:_WA49.configurator.getOption("phone_attach_options")?a.checkAttachPhoneWithConfig():void a.checkAttachPhonePopupOnLoad(function(){})},function(){a.logout()})}},{key:"onReturnFromBindPhonePage",value:function(a){a&&a.indexOf("success=1")>-1?(this.__phoneBoundSuccessfully=!0,_WA49.AccountStorage.modifyObject(["attach_phone"],function(a){a.attach_phone=_WA49.apply(a.attach_phone||{},{successul:_WA49.now()})}),_U40.Mnt.countRB(50271323)):_U40.Mnt.countRB(50271324)}},{key:"checkAttachPhoneWithConfig",value:function(){if(!this.__phoneBoundSuccessfully){var a=_WA49.configurator.getOption("phone_attach_options");a&&a.enabled&&!this.getAttachedPhone()&&_WA49.AccountStorage.modifyObject(["attach_phone"],function(b){var c=_WA49.now(),d=b.attach_phone||{},e=d.lastShown||0,f=d.successul||0;f+_WA49.DAY>c||(e+a.showTimeout<c||!a.allowBypass)&&(d.lastShown=c,b.attach_phone=d,_U40.Mnt.countRB(50271289),_WA49.setTimeout(function(){_WA49.comApi.redirectToBindPhonePage(a.allowBypass)},10))})}}},{key:"checkAttachPhonePopupOnLoad",value:function(a){return this.getAttachedPhone()||this._attachPhoneInfo?void a(!(this._attachPhoneInfo&&this._attachPhoneInfo.show)):void _WA49.AccountStorage.modifyObject(["attach_phone"],function(b){var c=_WA49.now();b=b.attach_phone,console.log("### @@@@ loaded data via modifyObj:",b),b&&b.lastRequest?b.lastRequest+DAY<c?(this._attachPhoneInfo=null,this.checkAttachPhonePopupWithStatusRequest(a)):!b.close_btn||b.lastShown+b.show_timeout<c?(b.lastShown=c,_WA49.AccountStorage.save({attach_phone:JSON.stringify(b)}),this.showAttachForm(b),a(!1)):a(!0):this.checkAttachPhonePopupWithStatusRequest(a)},this)}},{key:"checkAttachPhonePopupWithStatusRequest",value:function(a){this._attachPhoneInfo||this._attachPhoneInfoRequested?a&&a(!0):(this._attachPhoneInfoRequested=!0,_WA49.comApi.fetchPhonePopupStatus(function(b){if(this._attachPhoneInfoRequested=!1,this._attachPhoneInfo=b,!b.show)return void(a&&a(!0));var c={},d=!0,e=_WA49.now();_S.modifyObject(["attach_phone"],function(a){a=a.attach_phone,c=a,console.log("### @@@@ loaded data via modifyObj2:",a)},this),b.close_btn&&c&&c.lastRequest&&e-c.lastShown<b.show_timeout&&(d=!1);var f={lastShown:d?e:c.lastShown,lastRequest:e,show_timeout:b.show_timeout,close_btn:b.close_btn,title:b.title,text:b.text};_S.save({attach_phone:JSON.stringify(f)}),d?(this.showAttachForm(b),a&&a(!1)):a&&a(!0)},this,function(){this._attachPhoneInfoRequested=!1}))}},{key:"showAttachForm",value:function(a){_WA49.isDebug||App.isCurrentPage("attachPhone")||App.load("attachPhone",a)}},{key:"getAttachedPhone",value:function(){return _WA49.Sys.getAttachedPhone()}},{key:"setAttachedPhone",value:function(a){_WA49.Sys.modifyCredentials(function(b){b.phone=a})}},{key:"denyRemoteResourceLoading",value:function(){_WA49.snippet.denyRemoteLoading(),_WA49.Ava.denyRemoteLoading()}},{key:"allowRemoteResourceLoading",value:function(){console.log("~~~~~~~~~~ allowRemoteResourceLoading ~~~~~~~~~~~~"),_WA49.snippet.allowRemoteLoading(),_WA49.Ava.allowRemoteLoading()}},{key:"disconnect",value:function(a){_WA49.Notifier.clear(),this.fireStatusChange("offline"),this.connected()!==!1&&(this.requestable=!1,this._poller.disconnect(),a||_WA49.Sys.saveSessionData({"socket.date":0}))}},{key:"fireRequestableEvent",value:function(){console.log("IM:Conn:fireRequestableEvent: ACTIVE_MAIL="+_WA49.ACTIVE_MAIL),this.requestableEvent.fire(this.aimsid)}},{key:"onRequestable",value:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new Promise(function(c,d){a.aimsid?c():(b&&(a._requestableTimer=_WA49.setTimeout(function(){console.log("### sorry, rejecting your onRequestable promise"),d()},b)),a.requestableEvent.on(function(){a._requestableTimer&&clearTimeout(a._requestableTimer),c()},null,{single:!0}))})}},{key:"_restoreValidConnection",value:function(){_WA49.Sys.saveSessionData({"socket.restoreDate":+new Date});var a=this.getStatus();"offline"===a&&(a="online",_S.save({"status.forced":"","status.requested":a}));var b=_WA49.Sys.getCredentials(),c=_WA49.ts(),d=c-(b.respTs||0),e=b.delay-d;0>e&&(e=0),this.aimsid=b.aimsid,this.requestable=!0,this.fireRequestableEvent(),this.fireStatusChange(a),delete this._preloadCompleted,this._poller.connect(b.fetchUrl,e),this.connecting=!1,_S.load(["firstload"],function(a){1==a.firstload&&(getNotifierPermission(),_WA49.wimApi.setTimezone()),_S.remove(["firstload"])})}}]),a}();_WA49.ConnectionFacade=new Connection,WebIM.namespace("WebIM.conn");var _WA50=WebIM,ConnectionRoster=function(){function a(){_classCallCheck2(this,a),_WA50.ConnectionFacade.triggerEvent.on(this._onConnectionTriggerEvent,this),_WA50.ConnectionFacade.beforeResponseEvent.on(this._onBeforeConnectionResponse,this),_WA50.ConnectionFacade.afterResponseEvent.on(this._onAfterConnectionResponse,this)}return _createClass2(a,[{key:"_onBeforeConnectionResponse",value:function(){}},{key:"_onAfterConnectionResponse",value:function(){}},{key:"_onConnectionTriggerEvent",value:function(a,b){var c="_onConnection"+a.substr(0,1).toUpperCase()+a.substr(1);this[c]&&this[c].call(this,b)}},{key:"destroy",value:function(){_WA50.ConnectionFacade.triggerEvent.un(this._onConnectionTriggerEvent,this),_WA50.ConnectionFacade.beforeResponseEvent.un(this._onBeforeConnectionResponse,this),_WA50.ConnectionFacade.afterResponseEvent.un(this._onAfterConnectionResponse,this)}}]),a}();_WA50.conn.ES6ConnectionRoster=ConnectionRoster;var _WA51=WebIM,_U41=_WA51.util,AUTO_AWAY_ENABLED=!0,AUTO_AWAY_TIMEOUT=3e4,_DomUtil27=_WA51.DomUtil,_isAway=!1,activityTs=+new Date,_onAway=function(){_isAway=!0,_WA51.SessionStorage.save({autoaway:"1"}),_WA51.ConnectionFacade.goAway(!0)},_onUserEvents=function(){activityTs=+new Date,_isAway&&(_isAway=!1,_WA51.SessionStorage.save({autoaway:""}),_WA51.ConnectionFacade.goAway(!1))},awayChecker=new _U41.DelayedTask({interval:1e3,fn:function(){!_isAway&&+new Date-activityTs>AUTO_AWAY_TIMEOUT&&_onAway(),awayChecker.start()}}),activate=function(){AUTO_AWAY_ENABLED&&_WA51.isDesktop&&(_DomUtil27.getBody().on("mousemove",_onUserEvents).on("mousedown",_onUserEvents).on("keydown",_onUserEvents),_onUserEvents(),awayChecker.start())},deactivate=function(){AUTO_AWAY_ENABLED&&_WA51.isDesktop&&(awayChecker.stop(),_DomUtil27.getBody().un("mousemove",_onUserEvents).un("mousedown",_onUserEvents).un("keydown",_onUserEvents))};_WA51.autoAway={activate:activate,deactivate:deactivate,isAway:function(){return _isAway}};var _WA52=WebIM,_U42=_WA52.util,_TD17=_WA52.TemplateDriver,COLORS=["FF9E5C","FF5C60","F2334C","37B05F","A75AD3","DC4DA2","E645C4","8160DE","1AB1D1","27BCC8","5BBD25"],SUB_COLORS=["FFEA90","FFEAA6","FFBEAE","D8EFAB","D5C8FD","EBA6F8","FFCA94","88E3FF","B6EEFF","70F290","E4F598"],NAME_COLORS=["FF9B20","FF8260","FE514A","26B44A","A354DB","E14EC8","FF627B","567DF8","0AB6E3","00BC95","53CA07"],AVATAR_TYPE_SCHEMA={64:64,128:128,256:256,1024:1024},SIZE_TYPES=Object.keys(AVATAR_TYPE_SCHEMA),SIZE_VALUES=SIZE_TYPES.map(function(a){return AVATAR_TYPE_SCHEMA[a]});MAX_SIZE_TYPE=SIZE_TYPES[SIZE_TYPES.length-1];var _allowRemoteLoading=!1,_letterCache={},_imageCache={},_loadingCache={},_remoteLoadingQueue=[],_requestHash,_requestHashSelf,_chatIconIds={},AvatarUtils={getAvatarUid:function(a,b){return a.replace(/[@.]/g,"_")+"_"+b},getHashCode:function(a){return _U42.String.crc32(a)},getCSSColor:function(a){var b=AvatarUtils.getHashCode(a)%11;return"background-color:#"+COLORS[b]+";background:linear-gradient(-45deg,#"+COLORS[b]+",#"+SUB_COLORS[b]+");"},getColors:function(a){var b=AvatarUtils.getHashCode(a)%11;return["#"+COLORS[b],"#"+SUB_COLORS[b]]},getNameColor:function(a){return"#"+NAME_COLORS[AvatarUtils.getHashCode(a)%11]},getSizeType:function(a){var b=null;return SIZE_VALUES.some(function(c,d){return c>=a?(b=SIZE_TYPES[d],!0):void 0}),b||MAX_SIZE_TYPE},createSymbolAvatar:function(a,b,c){var d,e=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"#FFFFFF",f=document.createElement("canvas"),g=4*c;try{if(f.style.cssText="position:absolute;left:-1000px;top:-1000px;width:"+c+"px;height:"+c+"px;",f.width=f.height=g,document.body.appendChild(f),f=f.getContext("2d",{alpha:!b}),f.font=g/2+"px RoundedMplus1c, Arial",b){if(b.length>1){var h=f.createLinearGradient(g,g,0,0);h.addColorStop(0,b[0]),h.addColorStop(1,b[1]),f.fillStyle=h}else f.fillStyle=b[0];f.fillRect(0,0,g,g)}f.textAlign="center",f.textBaseline="alphabetic",f.fillStyle=e,f.fillText(a,g/2,g/2+35*g/2/100),d=f.canvas.toDataURL(),f.canvas.parentNode.removeChild(f.canvas)}catch(i){d=""}return d},getSymbolUrl:function(a,b,c){var d=(b||"").substr(0,4)+a+c;if(!_letterCache[d]){var e=d.replace(/\s/g,"").charAt(0).toUpperCase(),f=_WA52.Emoji.shift(d,!0);_letterCache[d]=AvatarUtils.createSymbolAvatar(f||e,AvatarUtils.getColors(a),c||90)}return _letterCache[d]},buildModifier:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c="",d=16;return 40>a?d=12:a>120&&(d=24),b.mute?c="im-avatarmark_mute im-avatarmark_mute"+d:b.official?c="im-avatarmark_official im-avatarmark_official"+d:b.online&&(c="im-avatarmark_online im-avatarmark_online"+d),c?'<div class="im-avatarmark '+c+'"></div>':""},buildAvatarHtml:function(a,b,c,d){var e=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"",f=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"";return _TD17.parseSafe("avatarBoxFull",{avaStyle:a,cls:b||"",sn:c||"",title:d||c||"",modifiers:f,content:e},{reusable:!0,safeKeys:["modifiers","content"]})},generateRequestHash:function(a,b){var c=_WA52.now();a===_WA52.ACTIVE_MAIL?_requestHashSelf=b||c:_WA52.MainAgent.isChat(a)&&(_requestHash=c,_chatIconIds[a]=b||_requestHash,_WA52.SessionStorage.save({avatar_hash:_requestHash}))},_createAvatarHtml:function(a,b,c,d){var e=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"";return _TD17.parseSafe("avatar",[a,b,c||"",d||c||"",e],{safeKeys:["4"]})},flyLetter:function(a,b,c){var d,e=_WA52.Emoji.shift(a),f="",g=[],h=[];if(e){_WA52.isRetina&&(b*=2);var i=b>400?200:Math.ceil(b/2);_WA52.isRetina&&(i=Math.floor(i/2)),f='<span style="'+_WA52.Emoji.getAvatarStyle(e,i)+'"></span>',g.push("im-avatarbox_emoji")}else{var j=a.charAt(0).toUpperCase();e=_WA52.Emoji.shift(a,!0),d=AvatarUtils.createSymbolAvatar(e||j,!1,b||90,c),h.push("background-image:url("+d+")"),g.push("im-avatarbox_symbol")}return{html:AvatarUtils._createAvatarHtml(h.join(";"),g.join(" "),"",a,f),url:d,toString:function(){return this.html}}},getRequestHash:function(a){return a===_WA52.ACTIVE_MAIL?(_requestHashSelf||AvatarUtils.generateRequestHash(a),_requestHashSelf):_WA52.MainAgent.isChat(a)?(_requestHash||(_WA52.SessionStorage.load(["avatar_hash"],{success:function(a){a&&(_requestHash=a.avatar_hash)}}),_requestHash||AvatarUtils.generateRequestHash(a)),_WA52.MainAgent.isChat(a)?(_chatIconIds[a]||(_chatIconIds[a]=_requestHash),_chatIconIds[a]):_requestHash):_WA52.CLD.getIconId(a)||"0"},loadRemoteAvatar:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(!_allowRemoteLoading&&a!==_WA52.ACTIVE_MAIL)return void _remoteLoadingQueue.push([a,b,c,d]);var e=a+"_"+b,f=AvatarUtils.getAvatarUid(a,b),g=""+_WA52.uniq();if(_loadingCache[e])return _loadingCache[e];_loadingCache[e]=g;var h=_WA52.rapi.getAvatarUrl(a,b)+"&r="+AvatarUtils.getRequestHash(a);return _U42.DomHelper.testUrlAsImage(h,function(b,h){if(_loadingCache[e]===g&&h){c.remoteLoaded=!0,c.url=b,c.html=AvatarUtils.buildAvatarHtml("background-image:url("+b+")","",a),c.size={width:h.width,height:h.height},_imageCache[e]={url:b,size:c.size};for(var i=document.querySelectorAll(".imAva_"+f),j=0,k=i.length;k>j;j++)i[j].style.cssText="background-image:url("+b+")",i[j].className="imAva_"+f+" im-avatarbox";delete _loadingCache[e],d&&d(c)}}),f}};_WA52.Ava={MAX_FILE_SIZE:5e6,make:function(a,b,c,d){var e=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,f=a.replace("@uin.icq",""),g=null,h={html:"",toString:function(){return this.html}},i="",j="",k="",l=[],m=null,n=!1,o=[],p=_WA52.isRetina?2*c:c,q=AvatarUtils.getSizeType(p),r=_WA52.rapi.getAvatarUrl(f,q),s=f+"_"+q;if(a===_WA52.ACTIVE_MAIL&&e&&e.isFavorite){var t=(p>400?200:Math.ceil(p/2),c/52),u=["transform:scale("+t+")","-webki-transform:scale("+t+")","-moz-transform:scale("+t+")","-o-transform:scale("+t+")","-ms-transform:scale("+t+")"].join(";");l.push("im-favorite-avatar"),j='<span style="'+u+';"></span>'}else if(e&&(k=AvatarUtils.buildModifier(c,e)),_imageCache[s])n=!0,g=_imageCache[s].size,m=_imageCache[s].url,i=AvatarUtils.getAvatarUid(f,q),o.push("background-image:url("+m+")");else{i=AvatarUtils.getAvatarUid(f,q),AvatarUtils.loadRemoteAvatar(f,q,h,d);var v=_WA52.Emoji.shift(b);if(v){var w=p>400?200:Math.ceil(p/2);_WA52.isRetina&&(w=Math.floor(w/2));var x=AvatarUtils.getCSSColor(f);j='<span style="'+_WA52.Emoji.getAvatarStyle(v,w)+'"></span>',o.push(x),l.push("im-avatarbox_emoji")}else r=AvatarUtils.getSymbolUrl(f,b,p),o.push("background-image:url("+r+")"),l.push("im-avatarbox_symbol")}return i&&l.push("imAva_"+i),h={size:g,html:AvatarUtils.buildAvatarHtml(o.join(";"),l.join(" "),f,b,j,k),url:m||r||null,remoteLoaded:n,toString:function(){return this.html}}},drop:function(a){for(var b=a.replace("@uin.icq",""),c=SIZE_TYPES.length;c--;){var d=b+"_"+SIZE_TYPES[c];(_imageCache[d]||_loadingCache[d])&&(delete _imageCache[d],delete _loadingCache[d])}},updateGroupChatModified:function(a,b){var c=a.replace("@uin.icq","");_chatIconIds[c]&&_chatIconIds[c]===b||_WA52.Ava.updateLastModified(c,b)},update:function(a,b){_WA52.Ava.updateLastModified(a,b)},updateLastModified:function(a,b){var c=a.replace("@uin.icq",""),d=SIZE_TYPES.length;for(AvatarUtils.generateRequestHash(c,b);d--;){var e=c+"_"+SIZE_TYPES[d],f=AvatarUtils.getAvatarUid(c,SIZE_TYPES[d]);(_imageCache[e]||_loadingCache[e])&&(delete _imageCache[e],delete _loadingCache[e]),document.querySelector(".imAva_"+f)&&AvatarUtils.loadRemoteAvatar(c,SIZE_TYPES[d])}},flyLetter:AvatarUtils.flyLetter,getColor:AvatarUtils.getNameColor,buildAvatarHtml:AvatarUtils.buildAvatarHtml,allowRemoteLoading:function(){_allowRemoteLoading=!0,_remoteLoadingQueue.forEach(function(a){AvatarUtils.loadRemoteAvatar.apply(this,a)}),_remoteLoadingQueue=[]},denyRemoteLoading:function(){_allowRemoteLoading=!1},debug:function(){console.log({_allowRemoteLoading:_allowRemoteLoading,_requestHashSelf:_requestHashSelf,_requestHash:_requestHash,_remoteLoadingQueue:_remoteLoadingQueue,_chatIconIds:_chatIconIds})}};var _WA53=WebIM,_U43=_WA53.util,LOADING_STATE_DELAY=200,RESPONSE_WAIT_TIMEOUT=15e3,Bots=function(){function a(){_classCallCheck2(this,a),this._loadingState={},this._updatedMessages={},this._cache={},this._requested={},this.stateUpdateEvent=new _U43.Event}return _createClass2(a,[{key:"saveMarkup",value:function(a,b){this._cache[a]=b}},{key:"getMarkup",value:function(a){return this._cache[a]}},{key:"executeAction",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",c=a.url||"",d=a.text;if(b&&this._requested[b]&&(clearTimeout(this._requested[b].timer),this.toggleButtonState(this._requested[b].archId,this._requested[b].index,!1)),_WA53.urlBuilder.validUrlMatch(c)){var e=_WA53.snippet.resolveLinkAsContact(c);if(e)_WA53.contactAbstraction.openProfileById(e.id||e.sn);else{var f=_WA53.util.String.htmlEntity(d||"")||_WA53.tr("bots.openLinkConfirmation",{url:_WA53.util.String.encodeHref(c)});_WA53.ui.confirmAction(f).then(function(){return window.open(c)})}}else d&&(a.showAlert?_WA53.ui.showAlertBox(_WA53.util.String.htmlEntity(d)):_WA53.showPopup(d))}},{key:"clickButton",value:function(a){var b=this,c=a.url,d=a.dialogSn,e=a.archId,f=a.data,g=a.index;if(c)this.executeAction({url:c});else{this.toggleButtonState(e,g,!0);var h=setTimeout(function(){b.toggleButtonState(e,g,!1)},RESPONSE_WAIT_TIMEOUT);_WA53.rapi.botAction({chatId:d,msgId:e,callbackData:f}).then(function(a){var c=a.reqId;b._requested[c]={timer:h,archId:e,index:g}})}}},{key:"toggleButtonState",value:function(a,b,c){var d=this._loadingState[a]||[];this._updatedMessages[a]=1,c?(-1===d.indexOf(b)&&d.push(b),this._loadingState[a]=d,setTimeout(this.fireUpdateEvent.bind(this),LOADING_STATE_DELAY)):(d.indexOf(b)>-1&&d.splice(d.indexOf(b),1),0===d.length&&delete this._loadingState[a],this.fireUpdateEvent())}},{key:"fireUpdateEvent",value:function(){var a=Object.keys(this._updatedMessages);this._updatedMessages={},this.stateUpdateEvent.fire(a)}},{key:"getState",value:function(a){return this._loadingState[a]}}]),a}();_WA53.bots=new Bots;for(var _WA54=WebIM,_U44=_WA54.util,_TD18=_WA54.TemplateDriver,EMOJI_SETS=["people","nature","objects","places","symbols"],EMOJI_DATA={people:["1f604","1f603","1f600","1f60a","263a","1f609","1f60d","1f618","1f61a","1f617","1f619","1f61c","1f61d","1f61b","1f633","1f601","1f614","1f60c","1f612","1f61e","1f623","1f622","1f602","1f62d","1f62a","1f625","1f630","1f605","1f613","1f629","1f62b","1f628","1f631","1f620","1f621","1f624","1f616","1f606","1f60b","1f637","1f60e","1f634","1f635","1f632","1f61f","1f626","1f627","1f608","1f47f","1f62e","1f62c","1f610","1f615","1f62f","1f636","1f607","1f60f","1f611","1f472","1f473","1f46e","1f477","1f482","1f476","1f466","1f467","1f468","1f469","1f474","1f475","1f471","1f47c","1f478","1f63a","1f638","1f63b","1f63d","1f63c","1f640","1f63f","1f639","1f63e","1f479","1f47a","1f648","1f649","1f64a","1f480","1f47d","1f4a9","1f525","2728","1f31f","1f4ab","1f4a5","1f4a2","1f4a6","1f4a7","1f4a4","1f4a8","1f442","1f440","1f443","1f445","1f444","1f44d","1f44e","1f44c","1f44a","270a","270c","1f44b","270b","1f450","1f446","1f447","1f449","1f448","1f64c","1f64f","261d","1f44f","1f4aa","1f6b6","1f3c3","1f483","1f46b","1f46a","1f46c","1f46d","1f48f","1f491","1f46f","1f646","1f645","1f481","1f64b","1f486","1f487","1f485","1f470","1f64e","1f64d","1f647","1f3a9","1f451","1f452","1f45f","1f45e","1f461","1f460","1f462","1f455","1f454","1f45a","1f457","1f3bd","1f456","1f458","1f459","1f4bc","1f45c","1f45d","1f45b","1f453","1f380","1f302","1f484","1f49b","1f499","1f49c","1f49a","2764","1f494","1f497","1f493","1f495","1f496","1f49e","1f498","1f48c","1f48b","1f48d","1f48e","1f464","1f465","1f4ac","1f463","1f4ad"],
nature:["1f436","1f43a","1f431","1f42d","1f439","1f430","1f438","1f42f","1f428","1f43b","1f437","1f43d","1f42e","1f417","1f435","1f412","1f434","1f411","1f418","1f43c","1f427","1f426","1f424","1f425","1f423","1f414","1f40d","1f422","1f41b","1f41d","1f41c","1f41e","1f40c","1f419","1f41a","1f420","1f41f","1f42c","1f433","1f40b","1f404","1f40f","1f400","1f403","1f405","1f407","1f409","1f40e","1f410","1f413","1f415","1f416","1f401","1f402","1f432","1f421","1f40a","1f42b","1f42a","1f406","1f408","1f429","1f43e","1f490","1f338","1f337","1f340","1f339","1f33b","1f33a","1f341","1f343","1f342","1f33f","1f33e","1f344","1f335","1f334","1f332","1f333","1f330","1f331","1f33c","1f310","1f31e","1f31d","1f31a","1f311","1f312","1f313","1f314","1f315","1f316","1f317","1f318","1f31c","1f31b","1f319","1f30d","1f30e","1f30f","1f30b","1f30c","1f320","2b50","2600","26c5","2601","26a1","2614","2744","26c4","1f300","1f301","1f308","1f30a"],objects:["1f38d","1f49d","1f38e","1f392","1f393","1f38f","1f386","1f387","1f390","1f391","1f383","1f47b","1f385","1f384","1f381","1f38b","1f389","1f38a","1f388","1f38c","1f52e","1f3a5","1f4f7","1f4f9","1f4fc","1f4bf","1f4c0","1f4bd","1f4be","1f4bb","1f4f1","260e","1f4de","1f4df","1f4e0","1f4e1","1f4fa","1f4fb","1f50a","1f509","1f508","1f507","1f514","1f515","1f4e2","1f4e3","23f3","231b","23f0","231a","1f513","1f512","1f50f","1f510","1f511","1f50e","1f4a1","1f526","1f506","1f505","1f50c","1f50b","1f50d","1f6c1","1f6c0","1f6bf","1f6bd","1f527","1f529","1f528","1f6aa","1f6ac","1f4a3","1f52b","1f52a","1f48a","1f489","1f4b0","1f4b4","1f4b5","1f4b7","1f4b6","1f4b3","1f4b8","1f4f2","1f4e7","1f4e5","1f4e4","2709","1f4e9","1f4e8","1f4ef","1f4eb","1f4ea","1f4ec","1f4ed","1f4ee","1f4e6","1f4dd","1f4c4","1f4c3","1f4d1","1f4ca","1f4c8","1f4c9","1f4dc","1f4cb","1f4c5","1f4c6","1f4c7","1f4c1","1f4c2","2702","1f4cc","1f4ce","2712","270f","1f4cf","1f4d0","1f4d5","1f4d7","1f4d8","1f4d9","1f4d3","1f4d4","1f4d2","1f4da","1f4d6","1f516","1f4db","1f52c","1f52d","1f4f0","1f3a8","1f3ac","1f3a4","1f3a7","1f3bc","1f3b5","1f3b6","1f3b9","1f3bb","1f3ba","1f3b7","1f3b8","1f47e","1f3ae","1f0cf","1f3b4","1f004","1f3b2","1f3af","1f3c8","1f3c0","26bd","26be","1f3be","1f3b1","1f3c9","1f3b3","26f3","1f6b5","1f6b4","1f3c1","1f3c7","1f3c6","1f3bf","1f3c2","1f3ca","1f3c4","1f3a3","2615","1f375","1f376","1f37c","1f37a","1f37b","1f378","1f379","1f377","1f374","1f355","1f354","1f35f","1f357","1f356","1f35d","1f35b","1f364","1f371","1f363","1f365","1f359","1f358","1f35a","1f35c","1f372","1f362","1f361","1f373","1f35e","1f369","1f36e","1f366","1f368","1f367","1f382","1f370","1f36a","1f36b","1f36c","1f36d","1f36f","1f34e","1f34f","1f34a","1f34b","1f352","1f347","1f349","1f353","1f351","1f348","1f34c","1f350","1f34d","1f360","1f346","1f345","1f33d"],places:["1f3e0","1f3e1","1f3eb","1f3e2","1f3e3","1f3e5","1f3e6","1f3ea","1f3e9","1f3e8","1f492","26ea","1f3ec","1f3e4","1f307","1f306","1f3ef","1f3f0","26fa","1f3ed","1f5fc","1f5fe","1f5fb","1f304","1f305","1f303","1f5fd","1f309","1f3a0","1f3a1","26f2","1f3a2","1f6a2","26f5","1f6a4","1f6a3","2693","1f680","2708","1f4ba","1f681","1f682","1f68a","1f689","1f69e","1f686","1f684","1f685","1f688","1f687","1f69d","1f68b","1f683","1f68e","1f68c","1f68d","1f699","1f698","1f697","1f695","1f696","1f69b","1f69a","1f6a8","1f693","1f694","1f692","1f691","1f690","1f6b2","1f6a1","1f69f","1f6a0","1f69c","1f488","1f68f","1f3ab","1f6a6","1f6a5","26a0","1f6a7","1f530","26fd","1f3ee","1f3b0","2668","1f5ff","1f3aa","1f3ad","1f4cd","1f6a9","1f1ef-1f1f5","1f1f0-1f1f7","1f1e9-1f1ea","1f1e8-1f1f3","1f1fa-1f1f8","1f1eb-1f1f7","1f1ea-1f1f8","1f1ee-1f1f9","1f1f7-1f1fa","1f1ec-1f1e7"],symbols:["30-20e3","31-20e3","32-20e3","33-20e3","34-20e3","35-20e3","36-20e3","37-20e3","38-20e3","39-20e3","1f51f","1f522","1f523","2b06","2b07","2b05","27a1","1f520","1f521","1f524","2197","2196","2198","2199","2194","2195","1f504","25c0","25b6","1f53c","1f53d","21a9","21aa","2139","23ea","23e9","23eb","23ec","2935","2934","1f197","1f500","1f501","1f502","1f195","1f199","1f192","1f193","1f196","1f4f6","1f3a6","1f201","1f22f","1f233","1f235","1f234","1f232","1f250","1f239","1f23a","1f236","1f21a","1f6bb","1f6b9","1f6ba","1f6bc","1f6be","1f6b0","1f6ae","1f17f","267f","1f6ad","1f237","1f238","1f202","24c2","1f6c2","1f6c4","1f6c5","1f6c3","1f251","3299","3297","1f191","1f198","1f194","1f6ab","1f51e","1f4f5","1f6af","1f6b1","1f6b3","1f6b7","1f6b8","26d4","2733","2747","274e","2705","2734","1f49f","1f19a","1f4f3","1f4f4","1f170","1f171","1f18e","1f17e","1f4a0","27bf","267b","2648","2649","264a","264b","264c","264d","264e","264f","2650","2651","2652","2653","26ce","1f52f","1f3e7","1f4b9","1f4b2","1f4b1","a9","ae","2122","274c","203c","2049","2757","2753","2755","2754","2b55","1f51d","1f51a","1f519","1f51b","1f51c","1f503","1f55b","1f567","1f550","1f55c","1f551","1f55d","1f552","1f55e","1f553","1f55f","1f554","1f560","1f555","1f556","1f557","1f558","1f559","1f55a","1f561","1f562","1f563","1f564","1f565","1f566","2716","2795","2796","2797","2660","2665","2663","2666","1f4ae","1f4af","2714","2611","1f518","1f517","27b0","3030","303d","1f531","25fc","25fb","25fe","25fd","25aa","25ab","1f53a","1f532","1f533","26ab","26aa","1f534","1f535","1f53b","2b1c","2b1b","1f536","1f537","1f538","1f539"]},EMOJI_BIG_DATA={"1f604":[0,0,1],"1f603":[1,0,1],"1f600":[2,0,1],"1f60a":[3,0,1],"263a":[4,0,1],"1f609":[5,0,1],"1f60d":[6,0,1],"1f618":[0,1,1],"1f61a":[1,1,1],"1f617":[2,1,1],"1f619":[3,1,1],"1f61c":[4,1,1],"1f61d":[5,1,1],"1f61b":[6,1,1],"1f633":[0,2,1],"1f601":[1,2,1],"1f614":[2,2,1],"1f60c":[3,2,1],"1f612":[4,2,1],"1f61e":[5,2,1],"1f623":[6,2,1],"1f622":[0,3,1],"1f602":[1,3,1],"1f62d":[2,3,1],"1f62a":[3,3,1],"1f625":[4,3,1],"1f630":[5,3,1],"1f605":[6,3,1],"1f613":[0,4,1],"1f629":[1,4,1],"1f62b":[2,4,1],"1f628":[3,4,1],"1f631":[4,4,1],"1f620":[5,4,1],"1f621":[6,4,1],"1f624":[0,5,1],"1f616":[1,5,1],"1f606":[2,5,1],"1f60b":[3,5,1],"1f637":[4,5,1],"1f60e":[5,5,1],"1f634":[6,5,1],"1f635":[0,6,1],"1f632":[1,6,1],"1f61f":[2,6,1],"1f626":[3,6,1],"1f627":[4,6,1],"1f608":[5,6,1],"1f47f":[6,6,1],"1f62e":[0,0,2],"1f62c":[1,0,2],"1f610":[2,0,2],"1f615":[3,0,2],"1f62f":[4,0,2],"1f636":[5,0,2],"1f607":[6,0,2],"1f60f":[0,1,2],"1f611":[1,1,2],"1f472":[2,1,2],"1f473":[3,1,2],"1f46e":[4,1,2],"1f477":[5,1,2],"1f482":[6,1,2],"1f476":[0,2,2],"1f466":[1,2,2],"1f467":[2,2,2],"1f468":[3,2,2],"1f469":[4,2,2],"1f474":[5,2,2],"1f475":[6,2,2],"1f471":[0,3,2],"1f47c":[1,3,2],"1f478":[2,3,2],"1f63a":[3,3,2],"1f638":[4,3,2],"1f63b":[5,3,2],"1f63d":[6,3,2],"1f63c":[0,4,2],"1f640":[1,4,2],"1f63f":[2,4,2],"1f639":[3,4,2],"1f63e":[4,4,2],"1f479":[5,4,2],"1f47a":[6,4,2],"1f648":[0,5,2],"1f649":[1,5,2],"1f64a":[2,5,2],"1f480":[3,5,2],"1f47d":[4,5,2],"1f4a9":[5,5,2],"1f525":[6,5,2],2728:[0,6,2],"1f31f":[1,6,2],"1f4ab":[2,6,2],"1f4a5":[3,6,2],"1f4a2":[4,6,2],"1f4a6":[5,6,2],"1f4a7":[6,6,2],"1f4a4":[0,0,3],"1f4a8":[1,0,3],"1f442":[2,0,3],"1f440":[3,0,3],"1f443":[4,0,3],"1f445":[5,0,3],"1f444":[6,0,3],"1f44d":[0,1,3],"1f44e":[1,1,3],"1f44c":[2,1,3],"1f44a":[3,1,3],"270a":[4,1,3],"270c":[5,1,3],"1f44b":[6,1,3],"270b":[0,2,3],"1f450":[1,2,3],"1f446":[2,2,3],"1f447":[3,2,3],"1f449":[4,2,3],"1f448":[5,2,3],"1f64c":[6,2,3],"1f64f":[0,3,3],"261d":[1,3,3],"1f44f":[2,3,3],"1f4aa":[3,3,3],"1f6b6":[4,3,3],"1f3c3":[5,3,3],"1f483":[6,3,3],"1f46b":[0,4,3],"1f46a":[1,4,3],"1f46c":[2,4,3],"1f46d":[3,4,3],"1f48f":[4,4,3],"1f491":[5,4,3],"1f46f":[6,4,3],"1f646":[0,5,3],"1f645":[1,5,3],"1f481":[2,5,3],"1f64b":[3,5,3],"1f486":[4,5,3],"1f487":[5,5,3],"1f485":[6,5,3],"1f470":[0,6,3],"1f64e":[1,6,3],"1f64d":[2,6,3],"1f647":[3,6,3],"1f3a9":[4,6,3],"1f451":[5,6,3],"1f452":[6,6,3],"1f45f":[0,0,4],"1f45e":[1,0,4],"1f461":[2,0,4],"1f460":[3,0,4],"1f462":[4,0,4],"1f455":[5,0,4],"1f454":[6,0,4],"1f45a":[0,1,4],"1f457":[1,1,4],"1f3bd":[2,1,4],"1f456":[3,1,4],"1f458":[4,1,4],"1f459":[5,1,4],"1f4bc":[6,1,4],"1f45c":[0,2,4],"1f45d":[1,2,4],"1f45b":[2,2,4],"1f453":[3,2,4],"1f380":[4,2,4],"1f302":[5,2,4],"1f484":[6,2,4],"1f49b":[0,3,4],"1f499":[1,3,4],"1f49c":[2,3,4],"1f49a":[3,3,4],2764:[4,3,4],"1f494":[5,3,4],"1f497":[6,3,4],"1f493":[0,4,4],"1f495":[1,4,4],"1f496":[2,4,4],"1f49e":[3,4,4],"1f498":[4,4,4],"1f48c":[5,4,4],"1f48b":[6,4,4],"1f48d":[0,5,4],"1f48e":[1,5,4],"1f464":[2,5,4],"1f465":[3,5,4],"1f4ac":[4,5,4],"1f463":[5,5,4],"1f4ad":[6,5,4],"1f436":[0,6,4],"1f43a":[1,6,4],"1f431":[2,6,4],"1f42d":[3,6,4],"1f439":[4,6,4],"1f430":[5,6,4],"1f438":[6,6,4],"1f42f":[0,0,5],"1f428":[1,0,5],"1f43b":[2,0,5],"1f437":[3,0,5],"1f43d":[4,0,5],"1f42e":[5,0,5],"1f417":[6,0,5],"1f435":[0,1,5],"1f412":[1,1,5],"1f434":[2,1,5],"1f411":[3,1,5],"1f418":[4,1,5],"1f43c":[5,1,5],"1f427":[6,1,5],"1f426":[0,2,5],"1f424":[1,2,5],"1f425":[2,2,5],"1f423":[3,2,5],"1f414":[4,2,5],"1f40d":[5,2,5],"1f422":[6,2,5],"1f41b":[0,3,5],"1f41d":[1,3,5],"1f41c":[2,3,5],"1f41e":[3,3,5],"1f40c":[4,3,5],"1f419":[5,3,5],"1f41a":[6,3,5],"1f420":[0,4,5],"1f41f":[1,4,5],"1f42c":[2,4,5],"1f433":[3,4,5],"1f40b":[4,4,5],"1f404":[5,4,5],"1f40f":[6,4,5],"1f400":[0,5,5],"1f403":[1,5,5],"1f405":[2,5,5],"1f407":[3,5,5],"1f409":[4,5,5],"1f40e":[5,5,5],"1f410":[6,5,5],"1f413":[0,6,5],"1f415":[1,6,5],"1f416":[2,6,5],"1f401":[3,6,5],"1f402":[4,6,5],"1f432":[5,6,5],"1f421":[6,6,5],"1f40a":[0,0,6],"1f42b":[1,0,6],"1f42a":[2,0,6],"1f406":[3,0,6],"1f408":[4,0,6],"1f429":[5,0,6],"1f43e":[6,0,6],"1f490":[0,1,6],"1f338":[1,1,6],"1f337":[2,1,6],"1f340":[3,1,6],"1f339":[4,1,6],"1f33b":[5,1,6],"1f33a":[6,1,6],"1f341":[0,2,6],"1f343":[1,2,6],"1f342":[2,2,6],"1f33f":[3,2,6],"1f33e":[4,2,6],"1f344":[5,2,6],"1f335":[6,2,6],"1f334":[0,3,6],"1f332":[1,3,6],"1f333":[2,3,6],"1f330":[3,3,6],"1f331":[4,3,6],"1f33c":[5,3,6],"1f310":[6,3,6],"1f31e":[0,4,6],"1f31d":[1,4,6],"1f31a":[2,4,6],"1f311":[3,4,6],"1f312":[4,4,6],"1f313":[5,4,6],"1f314":[6,4,6],"1f315":[0,5,6],"1f316":[1,5,6],"1f317":[2,5,6],"1f318":[3,5,6],"1f31c":[4,5,6],"1f31b":[5,5,6],"1f319":[6,5,6],"1f30d":[0,6,6],"1f30e":[1,6,6],"1f30f":[2,6,6],"1f30b":[3,6,6],"1f30c":[4,6,6],"1f320":[5,6,6],"2b50":[6,6,6],2600:[0,0,7],"26c5":[1,0,7],2601:[2,0,7],"26a1":[3,0,7],2614:[4,0,7],2744:[5,0,7],"26c4":[6,0,7],"1f300":[0,1,7],"1f301":[1,1,7],"1f308":[2,1,7],"1f30a":[3,1,7],"1f38d":[0,2,7],"1f49d":[1,2,7],"1f38e":[2,2,7],"1f392":[3,2,7],"1f393":[4,2,7],"1f38f":[5,2,7],"1f386":[6,2,7],"1f387":[0,3,7],"1f390":[1,3,7],"1f391":[2,3,7],"1f383":[3,3,7],"1f47b":[4,3,7],"1f385":[5,3,7],"1f384":[6,3,7],"1f381":[0,4,7],"1f38b":[1,4,7],"1f389":[2,4,7],"1f38a":[3,4,7],"1f388":[4,4,7],"1f38c":[5,4,7],"1f52e":[6,4,7],"1f3a5":[0,5,7],"1f4f7":[1,5,7],"1f4f9":[2,5,7],"1f4fc":[3,5,7],"1f4bf":[4,5,7],"1f4c0":[5,5,7],"1f4bd":[6,5,7],"1f4be":[0,6,7],"1f4bb":[1,6,7],"1f4f1":[2,6,7],"260e":[3,6,7],"1f4de":[4,6,7],"1f4df":[5,6,7],"1f4e0":[6,6,7],"1f4e1":[0,0,8],"1f4fa":[1,0,8],"1f4fb":[2,0,8],"1f50a":[3,0,8],"1f509":[4,0,8],"1f508":[5,0,8],"1f507":[6,0,8],"1f514":[0,1,8],"1f515":[1,1,8],"1f4e2":[2,1,8],"1f4e3":[3,1,8],"23f3":[4,1,8],"231b":[5,1,8],"23f0":[6,1,8],"231a":[0,2,8],"1f513":[1,2,8],"1f512":[2,2,8],"1f50f":[3,2,8],"1f510":[4,2,8],"1f511":[5,2,8],"1f50e":[6,2,8],"1f4a1":[0,3,8],"1f526":[1,3,8],"1f506":[2,3,8],"1f505":[3,3,8],"1f50c":[4,3,8],"1f50b":[5,3,8],"1f50d":[6,3,8],"1f6c1":[0,4,8],"1f6c0":[1,4,8],"1f6bf":[2,4,8],"1f6bd":[3,4,8],"1f527":[4,4,8],"1f529":[5,4,8],"1f528":[6,4,8],"1f6aa":[0,5,8],"1f6ac":[1,5,8],"1f4a3":[2,5,8],"1f52b":[3,5,8],"1f52a":[4,5,8],"1f48a":[5,5,8],"1f489":[6,5,8],"1f4b0":[0,6,8],"1f4b4":[1,6,8],"1f4b5":[2,6,8],"1f4b7":[3,6,8],"1f4b6":[4,6,8],"1f4b3":[5,6,8],"1f4b8":[6,6,8],"1f4f2":[0,0,9],"1f4e7":[1,0,9],"1f4e5":[2,0,9],"1f4e4":[3,0,9],2709:[4,0,9],"1f4e9":[5,0,9],"1f4e8":[6,0,9],"1f4ef":[0,1,9],"1f4eb":[1,1,9],"1f4ea":[2,1,9],"1f4ec":[3,1,9],"1f4ed":[4,1,9],"1f4ee":[5,1,9],"1f4e6":[6,1,9],"1f4dd":[0,2,9],"1f4c4":[1,2,9],"1f4c3":[2,2,9],"1f4d1":[3,2,9],"1f4ca":[4,2,9],"1f4c8":[5,2,9],"1f4c9":[6,2,9],"1f4dc":[0,3,9],"1f4cb":[1,3,9],"1f4c5":[2,3,9],"1f4c6":[3,3,9],"1f4c7":[4,3,9],"1f4c1":[5,3,9],"1f4c2":[6,3,9],2702:[0,4,9],"1f4cc":[1,4,9],"1f4ce":[2,4,9],2712:[3,4,9],"270f":[4,4,9],"1f4cf":[5,4,9],"1f4d0":[6,4,9],"1f4d5":[0,5,9],"1f4d7":[1,5,9],"1f4d8":[2,5,9],"1f4d9":[3,5,9],"1f4d3":[4,5,9],"1f4d4":[5,5,9],"1f4d2":[6,5,9],"1f4da":[0,6,9],"1f4d6":[1,6,9],"1f516":[2,6,9],"1f4db":[3,6,9],"1f52c":[4,6,9],"1f52d":[5,6,9],"1f4f0":[6,6,9],"1f3a8":[0,0,10],"1f3ac":[1,0,10],"1f3a4":[2,0,10],"1f3a7":[3,0,10],"1f3bc":[4,0,10],"1f3b5":[5,0,10],"1f3b6":[6,0,10],"1f3b9":[0,1,10],"1f3bb":[1,1,10],"1f3ba":[2,1,10],"1f3b7":[3,1,10],"1f3b8":[4,1,10],"1f47e":[5,1,10],"1f3ae":[6,1,10],"1f0cf":[0,2,10],"1f3b4":[1,2,10],"1f004":[2,2,10],"1f3b2":[3,2,10],"1f3af":[4,2,10],"1f3c8":[5,2,10],"1f3c0":[6,2,10],"26bd":[0,3,10],"26be":[1,3,10],"1f3be":[2,3,10],"1f3b1":[3,3,10],"1f3c9":[4,3,10],"1f3b3":[5,3,10],"26f3":[6,3,10],"1f6b5":[0,4,10],"1f6b4":[1,4,10],"1f3c1":[2,4,10],"1f3c7":[3,4,10],"1f3c6":[4,4,10],"1f3bf":[5,4,10],"1f3c2":[6,4,10],"1f3ca":[0,5,10],"1f3c4":[1,5,10],"1f3a3":[2,5,10],2615:[3,5,10],"1f375":[4,5,10],"1f376":[5,5,10],"1f37c":[6,5,10],"1f37a":[0,6,10],"1f37b":[1,6,10],"1f378":[2,6,10],"1f379":[3,6,10],"1f377":[4,6,10],"1f374":[5,6,10],"1f355":[6,6,10],"1f354":[0,0,11],"1f35f":[1,0,11],"1f357":[2,0,11],"1f356":[3,0,11],"1f35d":[4,0,11],"1f35b":[5,0,11],"1f364":[6,0,11],"1f371":[0,1,11],"1f363":[1,1,11],"1f365":[2,1,11],"1f359":[3,1,11],"1f358":[4,1,11],"1f35a":[5,1,11],"1f35c":[6,1,11],"1f372":[0,2,11],"1f362":[1,2,11],"1f361":[2,2,11],"1f373":[3,2,11],"1f35e":[4,2,11],"1f369":[5,2,11],"1f36e":[6,2,11],"1f366":[0,3,11],"1f368":[1,3,11],"1f367":[2,3,11],"1f382":[3,3,11],"1f370":[4,3,11],"1f36a":[5,3,11],"1f36b":[6,3,11],"1f36c":[0,4,11],"1f36d":[1,4,11],"1f36f":[2,4,11],"1f34e":[3,4,11],"1f34f":[4,4,11],"1f34a":[5,4,11],"1f34b":[6,4,11],"1f352":[0,5,11],"1f347":[1,5,11],"1f349":[2,5,11],"1f353":[3,5,11],"1f351":[4,5,11],"1f348":[5,5,11],"1f34c":[6,5,11],"1f350":[0,6,11],"1f34d":[1,6,11],"1f360":[2,6,11],"1f346":[3,6,11],"1f345":[4,6,11],"1f33d":[5,6,11],"1f3e0":[0,0,12],"1f3e1":[1,0,12],"1f3eb":[2,0,12],"1f3e2":[3,0,12],"1f3e3":[4,0,12],"1f3e5":[5,0,12],"1f3e6":[6,0,12],"1f3ea":[0,1,12],"1f3e9":[1,1,12],"1f3e8":[2,1,12],"1f492":[3,1,12],"26ea":[4,1,12],"1f3ec":[5,1,12],"1f3e4":[6,1,12],"1f307":[0,2,12],"1f306":[1,2,12],"1f3ef":[2,2,12],"1f3f0":[3,2,12],"26fa":[4,2,12],"1f3ed":[5,2,12],"1f5fc":[6,2,12],"1f5fe":[0,3,12],"1f5fb":[1,3,12],"1f304":[2,3,12],"1f305":[3,3,12],"1f303":[4,3,12],"1f5fd":[5,3,12],"1f309":[6,3,12],"1f3a0":[0,4,12],"1f3a1":[1,4,12],"26f2":[2,4,12],"1f3a2":[3,4,12],"1f6a2":[4,4,12],"26f5":[5,4,12],"1f6a4":[6,4,12],"1f6a3":[0,5,12],2693:[1,5,12],"1f680":[2,5,12],2708:[3,5,12],"1f4ba":[4,5,12],"1f681":[5,5,12],"1f682":[6,5,12],"1f68a":[0,6,12],"1f689":[1,6,12],"1f69e":[2,6,12],"1f686":[3,6,12],"1f684":[4,6,12],"1f685":[5,6,12],"1f688":[6,6,12],"1f687":[0,0,13],"1f69d":[1,0,13],"1f68b":[2,0,13],"1f683":[3,0,13],"1f68e":[4,0,13],"1f68c":[5,0,13],"1f68d":[6,0,13],"1f699":[0,1,13],"1f698":[1,1,13],"1f697":[2,1,13],"1f695":[3,1,13],"1f696":[4,1,13],"1f69b":[5,1,13],"1f69a":[6,1,13],"1f6a8":[0,2,13],"1f693":[1,2,13],"1f694":[2,2,13],"1f692":[3,2,13],"1f691":[4,2,13],"1f690":[5,2,13],"1f6b2":[6,2,13],"1f6a1":[0,3,13],"1f69f":[1,3,13],"1f6a0":[2,3,13],"1f69c":[3,3,13],"1f488":[4,3,13],"1f68f":[5,3,13],"1f3ab":[6,3,13],"1f6a6":[0,4,13],"1f6a5":[1,4,13],"26a0":[2,4,13],"1f6a7":[3,4,13],"1f530":[4,4,13],"26fd":[5,4,13],"1f3ee":[6,4,13],"1f3b0":[0,5,13],2668:[1,5,13],"1f5ff":[2,5,13],"1f3aa":[3,5,13],"1f3ad":[4,5,13],"1f4cd":[5,5,13],"1f6a9":[6,5,13],"1f1ef-1f1f5":[0,6,13],"1f1f0-1f1f7":[1,6,13],"1f1e9-1f1ea":[2,6,13],"1f1e8-1f1f3":[3,6,13],"1f1fa-1f1f8":[4,6,13],"1f1eb-1f1f7":[5,6,13],"1f1ea-1f1f8":[6,6,13],"1f1ee-1f1f9":[0,0,14],"1f1f7-1f1fa":[1,0,14],"1f1ec-1f1e7":[2,0,14],"30-20e3":[0,1,14],"31-20e3":[1,1,14],"32-20e3":[2,1,14],"33-20e3":[3,1,14],"34-20e3":[4,1,14],"35-20e3":[5,1,14],"36-20e3":[6,1,14],"37-20e3":[0,2,14],"38-20e3":[1,2,14],"39-20e3":[2,2,14],"1f51f":[3,2,14],"1f522":[4,2,14],"1f523":[6,2,14],"2b06":[0,3,14],"2b07":[1,3,14],"2b05":[2,3,14],"27a1":[3,3,14],"1f520":[4,3,14],"1f521":[5,3,14],"1f524":[6,3,14],2197:[0,4,14],2196:[1,4,14],2198:[2,4,14],2199:[3,4,14],2194:[4,4,14],2195:[5,4,14],"1f504":[6,4,14],"25c0":[0,5,14],"25b6":[1,5,14],"1f53c":[2,5,14],"1f53d":[3,5,14],"21a9":[4,5,14],"21aa":[5,5,14],2139:[6,5,14],"23ea":[0,6,14],"23e9":[1,6,14],"23eb":[2,6,14],"23ec":[3,6,14],2935:[4,6,14],2934:[5,6,14],"1f197":[6,6,14],"1f500":[0,0,15],"1f501":[1,0,15],"1f502":[2,0,15],"1f195":[3,0,15],"1f199":[4,0,15],"1f192":[5,0,15],"1f193":[6,0,15],"1f196":[0,1,15],"1f4f6":[1,1,15],"1f3a6":[2,1,15],"1f201":[3,1,15],"1f22f":[4,1,15],"1f233":[5,1,15],"1f235":[6,1,15],"1f234":[0,2,15],"1f232":[1,2,15],"1f250":[2,2,15],"1f239":[3,2,15],"1f23a":[4,2,15],"1f236":[5,2,15],"1f21a":[6,2,15],"1f6bb":[0,3,15],"1f6b9":[1,3,15],"1f6ba":[2,3,15],"1f6bc":[3,3,15],"1f6be":[4,3,15],"1f6b0":[5,3,15],"1f6ae":[6,3,15],"1f17f":[0,4,15],"267f":[1,4,15],"1f6ad":[2,4,15],"1f237":[3,4,15],"1f238":[4,4,15],"1f202":[5,4,15],"24c2":[6,4,15],"1f6c2":[0,5,15],"1f6c4":[1,5,15],"1f6c5":[2,5,15],"1f6c3":[3,5,15],"1f251":[4,5,15],3299:[5,5,15],3297:[6,5,15],"1f191":[0,6,15],"1f198":[1,6,15],"1f194":[2,6,15],"1f6ab":[3,6,15],"1f51e":[4,6,15],"1f4f5":[5,6,15],"1f6af":[6,6,15],"1f6b1":[0,0,16],"1f6b3":[1,0,16],"1f6b7":[2,0,16],"1f6b8":[3,0,16],"26d4":[4,0,16],2733:[5,0,16],2747:[6,0,16],"274e":[0,1,16],2705:[1,1,16],2734:[2,1,16],"1f49f":[3,1,16],"1f19a":[4,1,16],"1f4f3":[5,1,16],"1f4f4":[6,1,16],"1f170":[0,2,16],"1f171":[1,2,16],"1f18e":[2,2,16],"1f17e":[3,2,16],"1f4a0":[4,2,16],"27bf":[5,2,16],"267b":[6,2,16],2648:[0,3,16],2649:[1,3,16],"264a":[2,3,16],"264b":[3,3,16],"264c":[4,3,16],"264d":[5,3,16],"264e":[6,3,16],"264f":[0,4,16],2650:[1,4,16],2651:[2,4,16],2652:[3,4,16],2653:[4,4,16],"26ce":[5,4,16],"1f52f":[6,4,16],"1f3e7":[0,5,16],"1f4b9":[1,5,16],"1f4b2":[2,5,16],"1f4b1":[3,5,16],a9:[4,5,16],ae:[5,5,16],2122:[6,5,16],"274c":[0,6,16],"203c":[1,6,16],2049:[2,6,16],2757:[3,6,16],2753:[4,6,16],2755:[5,6,16],2754:[6,6,16],"2b55":[0,0,17],"1f51d":[1,0,17],"1f51a":[2,0,17],"1f519":[3,0,17],"1f51b":[4,0,17],"1f51c":[5,0,17],"1f503":[6,0,17],"1f55b":[0,1,17],"1f567":[1,1,17],"1f550":[2,1,17],"1f55c":[3,1,17],"1f551":[4,1,17],"1f55d":[5,1,17],"1f552":[6,1,17],"1f55e":[0,2,17],"1f553":[1,2,17],"1f55f":[2,2,17],"1f554":[3,2,17],"1f560":[4,2,17],"1f555":[5,2,17],"1f556":[6,2,17],"1f557":[0,3,17],"1f558":[1,3,17],"1f559":[2,3,17],"1f55a":[3,3,17],"1f561":[4,3,17],"1f562":[5,3,17],"1f563":[6,3,17],"1f564":[0,4,17],"1f565":[1,4,17],"1f566":[2,4,17],2716:[3,4,17],2795:[4,4,17],2796:[5,4,17],2797:[6,4,17],2660:[0,5,17],2665:[1,5,17],2663:[2,5,17],2666:[3,5,17],"1f4ae":[4,5,17],"1f4af":[5,5,17],2714:[6,5,17],2611:[0,6,17],"1f518":[1,6,17],"1f517":[2,6,17],"27b0":[3,6,17],3030:[4,6,17],"303d":[5,6,17],"1f531":[6,6,17],"25fc":[0,0,18],"25fb":[1,0,18],"25fe":[2,0,18],"25fd":[3,0,18],"25aa":[4,0,18],"25ab":[5,0,18],"1f53a":[6,0,18],"1f532":[0,1,18],"1f533":[1,1,18],"26ab":[2,1,18],"26aa":[3,1,18],"1f534":[4,1,18],"1f535":[5,1,18],"1f53b":[6,1,18],"2b1c":[0,2,18],"2b1b":[1,2,18],"1f536":[2,2,18],"1f537":[3,2,18],"1f538":[4,2,18],"1f539":[5,2,18]},EMOJI_SHORTCUTS={"*+*":"1f469",":-)":"1f600",":)":"1f600",":-D":"1f604",":D":"1f604",";-)":"1f609",";)":"1f609","8-)":"1f60e",":-*":"1f618",":*":"1f618",":P":"1f61b",":-P":"1f61b","%-)":"1f61c",":-(":"1f61f",":(":"1f61f",o_O:"1f633"},SKINTONE_MODIFIER_REG=/\ud83c[\udffb-\udfff]/g,EMOJI_REG_ALL=/\ud83c[\udde8-\uddfa]\ud83c[\udde7-\uddfa]|\ud83c[\udc04-\ude51]|\ud83c[\udf00-\udfff]|\ud83d[\udc00-\ude4f]|\ud83d[\ude80-\udeff]|[0-9]\u20e3|[\u203c-\u3299\ue50a\uf8ff\u00a9\u00ae]/g,EMOJI_REG_FIRST=new RegExp("^("+EMOJI_REG_ALL.source+")"),EMOJI_FORMAT='<img class="im-emoji_inline im-emo-{0}" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" unselectable="on" data-immutable="true">',BIG_EMOJI_SPRITE_URL=_WA54.imagePath+"emoji/s",BIG_EMOJI_NUMBER=7,MAX_PARSED_EMOJI_IN_STRING=30,escapeChars,chars="(){}[]|+:*$?",tmp=[],i=0;i<chars.length;)tmp.push("\\"+chars.charAt(i)),i++;var re=new RegExp("("+tmp.join("|")+")","g");escapeChars=function(a){return a.replace(re,"\\$1")};var smileShortcuts=[],shortcutCodes={},smilesLoaded=!1;_U44.Object.each(EMOJI_SHORTCUTS,function(a,b){b=escapeChars(b),shortcutCodes[b]=a,smileShortcuts.push(b)});var Emoji={smileCodeLastRE:new RegExp("("+smileShortcuts.join("|")+")$"),smileAliasCheckRE:new RegExp("("+smileShortcuts.join("|")+")","g"),smileLastRE:new RegExp("("+EMOJI_REG_ALL.source+")$"),initSmiles:function(){if(!smilesLoaded){smilesLoaded=!0;var a=document.getElementsByTagName("head")[0];if(a){var b=a.getElementsByTagName("*")[0];if(b){var c=document.createElement("link"),d=_WA54.isRetina?"emoji@2x.css":"emoji.css";c.type="text/css",c.rel="stylesheet",c.href=_WA54.resPath+d,a.insertBefore(c,b)}}}},isEmojiSupported:function(a){if(!Emoji.index){Emoji.index={};for(var b=0;b<EMOJI_SETS.length;b++)for(var c=0,d=EMOJI_DATA[EMOJI_SETS[b]].length;d>c;c++)Emoji.index[EMOJI_DATA[EMOJI_SETS[b]][c]]=1}return!!Emoji.index[a]},discover:function(a){return a=(a||"").replace(Emoji.smileAliasCheckRE,function(a,b){return Emoji.shortcutToChar(b)}),Emoji.parse(a)},parse:function(a){a=a||"",a=a.replace(SKINTONE_MODIFIER_REG,"");var b=MAX_PARSED_EMOJI_IN_STRING;return a=a.replace(EMOJI_REG_ALL,function(a){if(!b)return a;b--;var c=Emoji.getNameByCode(a);return c?Emoji.nameToHTML(c):a})},shift:function(a,b){var c=null,d=EMOJI_REG_FIRST.exec(a||"");return d&&(c=b?d[0]:Emoji.getNameByCode(d[0])),c},getAvatarStyle:function(a,b){var c=EMOJI_BIG_DATA[a],d=BIG_EMOJI_NUMBER*b;return["width:"+b+"px","height:"+b+"px","margin-top:-"+b/2+"px","margin-left:-"+b/2+"px","background-size:"+d+"px "+d+"px","background-image:url("+BIG_EMOJI_SPRITE_URL+c[2]+".png)","background-position:-"+(c[0]*b+d)+"px -"+c[1]*b+"px"].join(";")+";"},getNameByCode:function(a){var b;return b=4===a.length?_U44.String.getCodePointAt(a)+"-"+_U44.String.getCodePointAt(a,2):2===a.length&&"⃣"===a[1]?a.charCodeAt(0).toString(16)+"-20e3":_U44.String.getCodePointAt(a),b&&Emoji.isEmojiSupported(b)?(Emoji.initSmiles(),b):void 0},nameToHTML:function(a){return _TD18.parseString(EMOJI_FORMAT,[a])},getRegExp:function(a,b){return new RegExp((a||"")+EMOJI_FORMAT.replace("{0}","[0-9a-f]+").replace(">",'(?: data-origin="[^"]+")?>')+(b||""))},codeToClass:function(a){return"im-emo-"+a},shortcutToChar:function(a){return Emoji.nameToChar(EMOJI_SHORTCUTS[a])},nameToChar:function(a){var b,c=parseInt(a,16);return b=2===a.indexOf("-20e3")?_U44.String.fromCharCode(parseInt(a.substr(0,2),16))+"⃣":11===a.length?_U44.String.fromCharCode(parseInt(a.substr(0,5),16))+_U44.String.fromCharCode(parseInt(a.substr(6,5),16)):_U44.String.fromCharCode(c),b=b.replace(new RegExp("\x00","g"),"")},getESets:function(){return EMOJI_SETS},getEData:function(){return EMOJI_DATA},getSnapNameString:function(a){var b=a?(""+a).substr(-2)%EMOJI_SETS.length:Math.round(Math.random()*(EMOJI_SETS.length-1)),c=EMOJI_DATA[EMOJI_SETS[b]];return b=a?(""+a).substr(-4,2)%c.length:Math.round(Math.random()*(c-1)),Emoji.nameToHTML(c[b])}};Emoji.codeToHTML=Emoji.nameToHTML;var emojiCb=function(a,b){return Emoji.nameToChar(b)},emojiRegExp=/<img[^>]*class="[-_\w\d\s]*im-emo-([\-_\w\d]+)[^>]*>/gi;Emoji.recoilProccessedMessage=function(a){return a=a.replace(emojiRegExp,emojiCb)},_WA54.Emoji=Emoji;var _WA55=WebIM,_U45=_WA55.util,_TD19=_WA55.TemplateDriver,_DomUtil28=_WA55.DomUtil,USE_CHUNKS=!0,MEGABYTE=1048576,MAX_FILE_SIZE=4096*MEGABYTE,MAX_CHUNK_SIZE=MEGABYTE,CHUNK_SIZE=MEGABYTE-1,MAX_FILE_SIZE_FOR_SLOW_PREVIEW=MEGABYTE,MAX_FILE_SIZE_FOR_PREVIEW=10*MEGABYTE,MAX_FILE_SIZE_FOR_VIDEO_PREVIEW=200*MEGABYTE,PREVIEW_MIN_SIZE=68,PREVIEW_BUBBLE_SIZE=122,PREVIEW_MAX_SIZE=_WA55.splitView?320:194,MESSAGE_PADDING=24,FILE_OBJ_LIVE_TIME=1800,OFFLINE_REQUEST_REPEAT_TIMEOUT=5e3,_uploadedFileInfo={},_log2=function(a){_U45.Mnt.flog("uploader",a)},_dig=function(a){var b="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";return b.indexOf(a)},checkFileRequirementsForPreview=function(a,b){return a.match("image")?b<(_WA55.isIE||!_WA55.isDesktop?MAX_FILE_SIZE_FOR_SLOW_PREVIEW:MAX_FILE_SIZE_FOR_PREVIEW):a.match("video")?MAX_FILE_SIZE_FOR_VIDEO_PREVIEW>b:!1},UploaderProgress=function(){function a(){_classCallCheck2(this,a),this.STEP_DELAY=50,this.STEPS_VALUE=15,this.drawEvent=new _U45.Event,this.startPoint=this.currentPoint=this.endPoint=this.timer=0}return _createClass2(a,[{key:"moveTo",value:function(a,b){0>a||a>100||a<=this.endPoint||(this.endPoint=a,this.total=b,this.startPoint=this.currentPoint,this._nextStep())}},{key:"_nextStep",value:function(){this.timer&&clearTimeout(this.timer),this.currentPoint+=Math.floor((this.endPoint-this.startPoint)/this.STEPS_VALUE)+1,this.currentPoint>=this.endPoint?this.startPoint=this.currentPoint=this.endPoint:this.timer=_WA55.setTimeout(this._nextStep,this.STEP_DELAY,this),this.drawEvent.fire(this.currentPoint,this.total)}},{key:"destroy",value:function(){this.timer&&clearTimeout(this.timer),this.drawEvent.removeAll()}}]),a}(),FileUploader=function(){function a(b){_classCallCheck2(this,a),this.uid=Math.round(999999*Math.random()),this.email=b,this.info={},this._chunkInfo={},this._loaded=0,this._dom=null,this.progressDomNode=null,this.progressHandler=new UploaderProgress,this.readyToUploadEvent=new _U45.Event,this.initSuccessEvent=new _U45.Event,this.initFailedEvent=new _U45.Event,this.completedEvent=new _U45.Event,this.progressEvent=new _U45.Event,this.errorEvent=new _U45.Event,_WA55.FileApi.progressEvent.on(this._updateProgress,this)}return _createClass2(a,[{key:"start",value:function(a,b){var c=this;if(this.timestamp=_WA55.now(),window.FileReader){var d=new FileReader;d.onload=function(){c._start(a,_U45.Exif.cutDataFromJpeg(d.result)||a,b)},d.readAsArrayBuffer(a)}else this._start(a,a,b)}},{key:"_start",value:function(a,b,c){this.file=b,a&&a.size?(this.info={id:this.uid,name:a.name,type:_WA55.fileTools.getFileType(a.name),bytes:b.size,size:_WA55.fileTools.formatFileSize(b.size),attachedInfo:c||null,ptt:c&&c.ptt,progress:0},_WA55.fileTools.startUploadEvent.fire(this.email,this.info),this._init()):this._onError(3)}},{key:"_init",value:function(){var a=this,b=this.file;if(b){if(b.size>MAX_FILE_SIZE)return void this._onError(6,b.size);var c=function(a){a.result&&a.result.host?(this.uploadUrl="https://"+a.result.host+a.result.url,this.uploadCompleteUrl="https://"+a.result.host+a.result.complete_url,this.initSuccessEvent.fire(this.uploadUrl),this._dom&&(this._dom.value=null),this.readyToUploadEvent.fire(),this._upload()):this._onError(2,"nohost")}.bind(this),d=this.info.ptt?{duration:Math.ceil(this.info.ptt.duration)}:null;_WA55.FileApi.initUploadUrl(this.info&&this.info.name,b.size,d).then(function(b){200===b.status?c(b.data):a._onError(2)},function(){a._onError(2)})}}},{key:"_upload",value:function(){this.file&&(this.progressHandler.drawEvent.on(this.drawProgress,this),_WA55.fileTools.progressUploadEvent.fire(this.email,this.uid,0),this.retryTimeout&&("number"==typeof this.retryTimeout&&clearTimeout(this.retryTimeout),delete this.retryTimeout),this._chunkInfo={items:[],count:1,current:0,currentSize:0},USE_CHUNKS&&window.Blob&&(this._chunkInfo.count=Math.ceil(this.file.size/CHUNK_SIZE)),this._uploadNextChunk())}},{key:"_uploadNextChunk",value:function(){if(this.file&&!(this._chunkInfo.current>=this._chunkInfo.count)){var a,b=this.file,c=this._chunkInfo.current*CHUNK_SIZE,d=c+CHUNK_SIZE;this._loaded+=this._chunkInfo.currentSize,(d>=b.size||1===this._chunkInfo.count)&&(d=b.size-1);try{a=b.slice(c,d+1)}catch(e){if(_log2("error=slice_exception"),a=b,b.size>MAX_CHUNK_SIZE)return void this._onError(6,b.size);c=0,d=b.size-1,this._chunkInfo.count=1}this._chunkInfo.currentSize=d-c+1,this._chunkInfo.current++,this._uploadItem(a,c,d,b.size)}}},{key:"_uploadItem__OLD",value:function(a,b,c,d){_WA55.FileApi.uploadBytes(this.uploadUrl,this.info.name,a,b,c,d,function(a,b){206===a?this._uploadNextChunk():b&&b.result?this._onUploadCompleted(b.result):this._onError(5,200)}.bind(this),this._onError.bind(this))}},{key:"_uploadItem",value:function(a,b,c,d){var e=this;_WA55.FileApi.uploadBytes(this.uploadUrl,this.info.name,a,b,c,d).then(function(a){if(console.log("....uploadItem",a.status),206===a.status)e._uploadNextChunk();else{var b=a.data;b&&b.result?e._onUploadCompleted(b.result):e._onError(5,200)}},function(a){var b=a.errorId,c=a.status;console.log("....uploadItem error ",b,c),e._onError(b,c)})}},{key:"_updateProgress",value:function(a){var b=this.info.bytes,c=this._loaded+a,d=Math.round(100*c/b);this.progressHandler.moveTo(d,b)}},{key:"updateProgressNode",value:function(a){a&&(this.progressDomNode=a),this.drawProgress()}},{key:"drawProgress",value:function(a,b){var c=a||this.progressHandler.currentPoint,d=b||this.progressHandler.total;if(this.info.progress=1.8*c,this.progressDomNode&&this.progressDomNode.parent()){var e,f="rotate("+1.8*(c||1)+"deg)";c>0&&d&&this.info.name&&(e=_WA55.tr("file.progressText",[_WA55.fileTools.formatFileSize(c*d/100),this.info.size]),e="<span>"+_U45.String.htmlEntity(this.info.name)+"</span>"+e),this.progressDomNode.first().setStyle({transform:f,"-webkit-transform":f}),this.progressDomNode.last().first().setStyle({transform:f,"-webkit-transform":f}),e&&this.progressDomNode.parent().getSelector(".imFileDrop").prev().updateHTML(e)}}},{key:"abort",value:function(){this._onError(0)}},{key:"_onError",value:function(a){var b=this,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";if(this.file)if(a>0&&_log2("errid="+a+" msg="+c),5===a||4===a||(0!==a||c)&&this.retryTimeout)if(_WA55.ConnectionFacade.requestable)this.retryTimeout&&"number"!=typeof this.retryTimeout||(this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=_WA55.setTimeout(function(){b.file&&(b._chunkInfo.count?(b._chunkInfo.current--,b._uploadNextChunk()):b._init())},5e3));else{if(this.retryTimeout===!0)return;"number"==typeof this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=!0,_WA55.ConnectionFacade.requestReadyEvent.on(function(){"number"==typeof this.retryTimeout&&clearTimeout(this.retryTimeout),delete this.retryTimeout,this.file&&(this._chunkInfo.count?(this._chunkInfo.current--,this._uploadNextChunk()):this._init())},this,{single:!0})}else(2===a||3===a)&&this._dom&&(this._dom.value=null),_WA55.fileTools.createErrorObject(this.info,a),this.completedEvent.fire(),_WA55.fileTools.endUploadEvent.fire(this.email,this.info),this.destroy()}},{key:"_onUploadCompleted",value:function(a){_uploadedFileInfo[a.fileid]=this.info,_WA55.fileTools.destroyUploader(this.uid),this.completedEvent.fire(a),_WA55.fileTools.endUploadEvent.fire(this.email,this.info,a),this.destroy()}},{key:"destroy",value:function(){delete this.file,_WA55.fileTools.destroyUploader(this.uid),this.progressHandler.destroy(),this.readyToUploadEvent.removeAll(),this.initSuccessEvent.removeAll(),this.initFailedEvent.removeAll(),this.completedEvent.removeAll(),this.progressEvent.removeAll(),this.errorEvent.removeAll()}}]),a}();_WA55.mediaFileStateManager={_cacheNodes:{},_getMediaBoxNode:function(a,b){return this._cacheNodes[b]&&a.contains(this._cacheNodes[b])||(this._cacheNodes[b]=a.getSelector('[data-id="imPtt_'+b+'"]')),this._cacheNodes[b]},updateMediaFileState:function(a,b,c){if(!c||!_DomUtil28.getBody().contains(c))return void(this.tPlay&&clearTimeout(this.tPlay));var d=this._getMediaBoxNode(c,a);d&&(d.toggleClass("im-file_error",!!b.error),d.toggleClass("im-file_playing",!b.paused&&!b.error),this.tPlay&&clearTimeout(this.tPlay),b.error||b.duration&&this._updateTrackPosition(c,a,b.duration,b.currentTime,null,b.paused||0===b.currentTime))},_updateTrackPosition:function(a,b,c,d,e,f){if(!a||!_DomUtil28.getBody().contains(a))return void(this.tPlay&&clearTimeout(this.tPlay));var g=+new Date;e=e||g,d+=(g-e)/1e3,d>c&&(d=c,f=!0);var h=d>0?Math.floor(c-d):Math.round(c),i=this._getMediaBoxNode(a,b);if(i){var j=i.first().first();j.setStyle("width",Math.floor(100*d/c)+"%"),j.next().next().updateText(_WA55.fileTools.formatDuration(h)),f||(this.tPlay=_WA55.setTimeout(function(){this._updateTrackPosition(a,b,c,d,g)},100,this));
}}};var _speechCache={},_loadingCache2={};_WA55.fileTools={FILE_DOMAINS:["files\\.mail\\.ru","files\\.icq\\.net","files\\.icq\\.com","icq\\.com","chat\\.my\\.com/files","files\\.chat\\.my\\.com"],OBJECT_TAG:"sub",UPLOAD_PREFIX:"upload",FILE_PREFIX:"fileobj",loadEvent:new _U45.Event,startUploadEvent:new _U45.Event,endUploadEvent:new _U45.Event,progressUploadEvent:new _U45.Event,_index:{},_fileUploaders:{},sendFiles:function(a,b,c){_WA55.isDesktop?_U45.Mnt.countRB(33783240):_U45.Mnt.countRB(35348703);for(var d=0;d<b.length;d++)_WA55.setTimeout(this.sendFile.bind(this,a,b[d],0===d?c:{}),1)},sendFile:function(a,b,c){var d=new FileUploader(a);return this._fileUploaders[d.uid]=d,this._index[a]=this._index[a]||[],this._index[a].push(d.uid),d.start(b,c),d},emulateFileObjForPreview:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"image",c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return{is_previewable:!0,mime:b,mediumPreview:a,orig_url:c}},fetchSecureFileObj:function(a,b,c){var d=b.info,e=d.file_name,f=d.file_size,g=b.previews,h=b.extra;return{id:a,name:e,bytes:f,size:_WA55.fileTools.formatFileSize(f),mime:d.mime,type:this.getFileType(e,d.mime),url:d.dlink,orig_url:c,expiredTime:_WA55.now()+FILE_OBJ_LIVE_TIME,is_previewable:!!g&&d.has_previews,smallPreview:g[192],mediumPreview:g[600],maxPreview:g.xlarge||g[800]||g[600]||g[192],duration:h.video&&h.video.duration||h.audio&&h.audio.duration,ready:!0}},fetchFileObj:function(a,b,c){var d={id:a,orig_url:c,duration:b.duration,name:b.filename,is_previewable:b.is_previewable,maxPreview:b.xlarge||b.static800||b.static600||b["static"],smallpreview:b["static"],mediumPreview:b.static600,bytes:b.filesize,size:_WA55.fileTools.formatFileSize(b.filesize),mime:b.mime,type:this.getFileType(b.filename,b.mime),url:b.dlink,expiredTime:_WA55.now()+FILE_OBJ_LIVE_TIME,ready:!0};return d.mediumPreview||(d.is_previewable=0),"author_uin"in b&&_U45.Array.each(["author_uin","expire","create_date","snap_id","author_name"],function(a){d[a]=b[a]}),d},fetchLocalFileObj:function(a){return{id:"",name:a.name,bytes:a.size,size:this.formatFileSize(a.size),mime:a.type,type:this.getFileType(a.name)}},createErrorObject:function(a,b){var c="";switch(b){case 0:c=_WA55.tr("file.errorAbort");break;case 1:c=_WA55.tr("file.errorNotFound");break;case 2:c=_WA55.tr("file.errorInit");break;case 3:c=_WA55.tr("file.errorReadFile");break;case 4:c=_WA55.tr("file.errorUpload");break;case 5:c=_WA55.tr("file.errorSending");break;case 6:c=_WA55.tr("file.errorFileTooLarge");break;case 7:c=_WA55.tr("file.errorReadFile");break;case 8:c=_WA55.tr("file.snapIsExpired")}a.errorCode=b,a.errorMsg=c,delete a.progress,this._fileInfoCache[a.id]=a},fileNotFound:function(a,b){this.createErrorObject({id:a,name:a,url:b},this._isSnapId(a)?8:1)},resolveLinkAsFile:function(a,b,c){var d=_WA55.urlBuilder.parseLeadingFileLink(a);return!c&&d&&d[3]&&(d=null),d&&d[2]?b?{leadingText:"",text:d[3],id:d[2],url:d[1]}:d[2]:!1},resolveFileInText:function(a){var b=null,c=_WA55.urlBuilder.parseFileLink(a);return c&&c[3]&&(b={leadingText:c[1]+" ",text:c[4],id:c[3],url:c[2]}),b},resolveLinkAsFileText:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=b.withIcon,d=b.forceRequest,e=b.asPlainText,f=b.allowLeadingText,g=f?this.resolveFileInText(a):this.resolveLinkAsFile(a,!0,!0);if(g){var h=g.id,i="file",j=_WA55.tr("file.file");if(this.isPttFile(h))j=_WA55.tr("cl.voiceMessage"),i="voice";else if(this.isStickerFile(h))j=_WA55.tr("sticker.sticker"),i="sticker";else if(this.isImageFile(h))j=_WA55.tr("cl.photo"),i="photo";else if(this.isVideoFile(h))j=_WA55.tr("cl.video"),i="video";else{var k=this.getLocalFileInfo(h);k?j=k.name:d&&this.requestFileInfo(h,g.url)}var l=c&&!e?_TD19.parseSafe("mediaAsText",{type:i,text:j}):_U45.String.htmlEntity(j);return g.text&&(l=e?_U45.String.htmlEntity(g.leadingText)+l+" "+_U45.String.htmlEntity(g.text):_WA55.MessageFormatter.buildPlainHtmlMessage(g.leadingText)+l+" "+_WA55.MessageFormatter.buildPlainHtmlMessage(g.text)),l}},getPreviewCode:function(a,b,c,d,e,f,g){var h=this.requestFileInfo(a,b);return'<div class="im-file-wrapper">'+this.generateHTML(h||a,{url:b,speechVisible:g},c,d,e,f)+"</div>"},getPreviewUrl:function(a,b,c){var d=b?this.getLocalFileInfo(a):this.requestFileInfo(a,c);return d&&d.is_previewable&&d.smallPreview},_fileInfoCache:{},isImageFile:function(a){var b=this._isImageId(a);return b||(b=32===a.length&&this._fileInfoCache[a]&&this._fileInfoCache[a].is_previewable&&this._fileInfoCache[a].mediumPreview),b},isVideoFile:function(a){return this._isVideoId(a)},isPttFile:function(a){return this._isPttId(a)},isStickerFile:function(a){return this._isStickerPackId(a)},isMediaFileId:function(a){return _WA55.isString(a)&&a.length>32},_isImageId:function(a){if(!_WA55.isString(a))return!1;var b=a.charCodeAt(0);return this.isMediaFileId(a)&&b>=48&&55>=b},_isVideoId:function(a){if(!_WA55.isString(a))return!1;var b=a.charCodeAt(0);return this.isMediaFileId(a)&&(56===b||57===b)},_isSnapId:function(a){if(!_WA55.isString(a))return!1;var b=a.charCodeAt(0);return a.length>50&&(b>=48&&55>=b||57===b)},_isPttId:function(a){if(!_WA55.isString(a))return!1;var b=a.charCodeAt(0);return this.isMediaFileId(a)&&(73===b||74===b)},_isStickerPackId:function(a){if(!_WA55.isString(a))return!1;var b=a.charAt(0);return this.isMediaFileId(a)&&("2"===b||"5"===b||"D"===b)},getLocalFileInfo:function(a){return this._fileInfoCache[a]},getUploadedFileInfo:function(a){return this._fileUploaders[a]&&this._fileUploaders[a].info||_uploadedFileInfo[a]||null},requestFileInfo:function(a,b,c){var d=this;if(this._fileInfoCache[a]){if(!(this._fileInfoCache[a].expiredTime&&this._fileInfoCache[a].expiredTime<_WA55.now()))return c&&c(this._fileInfoCache[a]),this._fileInfoCache[a];delete this._fileInfoCache[a]}_loadingCache2[a]||(_loadingCache2[a]=!0,_WA55.FileApi.getFileInfoSecure(a).then(function(e){if(delete _loadingCache2[a],e)d._fileInfoCache[a]=d.fetchSecureFileObj(a,e,b);else{if("offline"===_WA55.onlineManager.getStatus())return void _WA55.setTimeout(function(){d.requestFileInfo(a,b,c)},OFFLINE_REQUEST_REPEAT_TIMEOUT);d.fileNotFound(a,b)}c&&c(d._fileInfoCache[a]),d.loadEvent.fire(a,d._fileInfoCache[a])},function(a){var b=_slicedToArray(a,2);b[0],b[1]}))},generateUploaderHTML:function(a){return this._fileInfoCache[a]?this.generateHTML(this._fileInfoCache[a],{}):this._fileUploaders[a]?this.generateHTML(this._fileUploaders[a].info,{}):""},generateIconHTML:function(a,b){var c=(a?"font-size:"+(14-a.length)+"px;":"")+(b?"background-image:url("+_U45.String.encodeHref(b)+");":"");return _TD19.parseSafe("fileIcon",{fileExtension:a||"",iconStyle:c},{safeKeys:["iconStyle"]})},generateHTML:function(a,b,c,d,e,f){var g,h=b.url,i=_WA55.isString(a),j=void 0!==a.progress,k=_WA55.DialogsAgent.getMediaBlockMaxSize()-MESSAGE_PADDING,l=k,m=!1,n="",o="",p=!1,q="",r="width:"+k+"px",s=[],t="",u="",v="",w="",x=!b.galleryType;if(i){var y=this.getUploadedFileInfo(a);a={id:a,name:y&&y.name||a,url:h}}else!a.url&&h&&(a.url=h);null!=a.errorCode&&(a.type="",s.push("im-file_error")),(i||j)&&(t=_TD19.parseSafe("fileObject",{id:a.id,text:c||"",mid:d,single:e?"1":"",name:j?this.UPLOAD_PREFIX:this.FILE_PREFIX}));var z='href="'+_U45.String.encodeHref(a.url||"")+'"',A=this._isPttId(a.id)&&(!b.galleryType||"ptt"===b.galleryType),B=this._isVideoId(a.id),C=this.getSizeById(a.id),D=!1,E=this._isStickerPackId(a.id);if(!C&&a.is_previewable&&a.mediumPreview&&(C=_WA55.splitView?[320,320]:[194,194],E&&(C=[170,170]),p=!0),o=a.name,n=a.name.length>15?"<span>"+_U45.String.htmlEntity(a.name.slice(0,-8)).replace(/\s$/,"&nbsp;")+"</span><span>"+_U45.String.htmlEntity(a.name.substr(-8)).replace(/^\s/,"&nbsp;")+"</span>":_U45.String.htmlEntity(o),c&&(s.push("im-file-with__text"),w=_WA55.Emoji.parse(_U45.String.htmlEntity(c))),C){l=Math.round(280/300*(k+MESSAGE_PADDING)),!c&&a.mediumPreview&&e&&(k+=MESSAGE_PADDING),E&&a.mediumPreview&&(k=l=170);var F=C[0]/C[1],G=C[0],H=C[1];D?G>PREVIEW_MAX_SIZE&&(G=PREVIEW_MAX_SIZE,H=Math.round(G/F)):(F>=1&&G>k&&(G=k,H=Math.round(G/F),PREVIEW_MIN_SIZE>H&&(G=Math.round(PREVIEW_MIN_SIZE*G/H),H=PREVIEW_MIN_SIZE)),H>l&&(G=Math.round(l*G/H),H=l,PREVIEW_MIN_SIZE>G&&(H=Math.round(PREVIEW_MIN_SIZE/(G/H)),G=PREVIEW_MIN_SIZE))),G>4&&H>4&&(a.mediumPreview||i)&&(m=x,v='data-action="file-preview"');var I,J;if(m){var K=a.mediumPreview,L=G>k?k:G,M=H>l?l:H;PREVIEW_BUBBLE_SIZE>G&&PREVIEW_BUBBLE_SIZE>H&&(L=M=PREVIEW_BUBBLE_SIZE),D&&(L>PREVIEW_MAX_SIZE||M>PREVIEW_MAX_SIZE)?(L=Math.min(L,PREVIEW_MAX_SIZE),M=Math.min(M,PREVIEW_MAX_SIZE),r="width:"+L+"px;height:"+M+"px;line-height:"+M+"px;",p=!0,K=a.mediumPreview):(I=G!==L?Math.floor((L-G)/2):0,J=M>H?Math.floor((M-H)/2):0,r="width:"+L+"px;height:"+M+"px;",p&&(r+=_WA55.splitView?"line-height:320px;":"line-height:194px;")),K&&("gif"===a.type&&a.url&&(K=a.url),q=_TD19.parseSafe("fileImagePreview",{url:_U45.String.encodeHref(h||a.orig_url||""),url_style:p?"position:relative;display:inline-block;vertical-align:middle;line-height:normal;":D?"":(F>=1?"height:"+H+"px;max-height:100%;":"width:"+G+"px;max-width:100%;")+"left:"+I+"px;top:"+J+"px;",img_src:'src="'+_U45.String.encodeHref(K)+'"',img_style:p?"":(F>=1?"height":"width")+":100%;"},{safeKeys:["url","img_src"]}),B&&s.push("im-file_play")),s.push("im-file_preview")}}if(j&&(u=_TD19.parseSafe("fileProgressBar",{progress:a.progress||1.8,id:a.id}),s.push("im-file_uploading"),g=" ",a.progress&&(g=_WA55.tr("file.progressText",[_WA55.fileTools.formatFileSize(a.progress*a.bytes/100/1.8),a.size]))),A){s.push("im-file_ptt");var N=this.getDurationById(a.id)||1,O=188,P=Math.floor(O+(k-O)*Math.log(N)/Math.log(300));r="width:auto;max-width:"+k+"px;";var Q=_WA55.mediaPlayer.getState(d+"_"+a.id),R=Q&&Q.currentTime||0;N=Q&&Q.duration||N,R>N&&(R=N);var S=R>0?Math.floor(N-R):Math.round(N),T=b.speechVisible;z="";var U=[];a.speech&&T&&U.push("im-file__ptt-speech_opened"),_WA55.configurator.getOption("disable_ptt_speech")||U.push("im-file__ptt-box_translatable"),q=_TD19.parseSafe("filePttBox",{domId:d+"_"+a.id,fileId:a.id,url:_U45.String.encodeHref(a.url||""),duration:this.formatDuration(S),progressBarStyle:"width:"+P+"px;",progressStyle:"width:"+Math.floor(100*R/N)+"%",boxClass:U.join(" "),speech_text:a.speech||""},{safeKeys:["url"]})}b.cleanVersion&&a.mediumPreview&&s.push("im-file_media"),b.wrapClass&&s.push(b.wrapClass);var V=this.generateIconHTML(a.type,b.cleanVersion&&a.mediumPreview),W="fileBox";return b.galleryType?W="galleryFileBox":b.cleanVersion&&(W="fileBoxClean"),_TD19.parseSafe(W,{object:t,fileIconHtml:V,url:_U45.String.encodeHref(a.url||""),href_attr:z,data_url:encodeURIComponent(a.orig_url||""),name:n,title:o,wrap_cls:s.join(" "),wrap_style:r,wrap_attrs:v,contextId:d||"",file_id:a.id||"",file_info:a.errorMsg||g||a.size||"",file_preview:q,progressbar:u,ready:a.ready||"",message:w,additional_html:b.additionalHtml||"",additional_info:b.additionalInfo||""},{safeKeys:["object","fileIconHtml","url","href_attr","data_url","name","wrap_attrs","file_preview","progressbar","message","additional_html","additional_info"]})+(f||"")},getSizeById:function(a){if(!_WA55.isString(a)||!this._isImageId(a)&&!this._isVideoId(a))return null;var b=62*_dig(a.charAt(1))+_dig(a.charAt(2)),c=62*_dig(a.charAt(3))+_dig(a.charAt(4));return[b,c]},getDurationById:function(a){return this._isPttId(a)?62*_dig(a.charAt(3))+_dig(a.charAt(4)):null},formatDuration:function(a){return("00"+Math.floor(a/60)).slice(-2)+":"+("00"+Math.floor(a%60)).slice(-2)},formatFileSize:function(a){var b;return b=a>=MEGABYTE?(Math.round(10*a/MEGABYTE)/10).toString().replace(/\./,",")+" "+_WA55.tr("file.mBytes").toUpperCase():a>=1024?(Math.round(10*a/1024)/10).toString().replace(/\./,",")+" "+_WA55.tr("file.kBytes").toUpperCase():(Math.round(10*a)/10).toString().replace(/\./,",")+" "+_WA55.tr("file.bytes").toUpperCase()},updateUploaderProgress:function(a,b){this._fileUploaders[a]&&this._fileUploaders[a].updateProgressNode(_DomUtil28.get(b).next().last())},destroyUploader:function(a){if(this._fileUploaders[a]){var b=this._fileUploaders[a].email;if(this._index[b]){var c=this._index[b].indexOf(a);c>-1&&this._index[b].splice(c,1)}delete this._fileUploaders[a]}},abort:function(a){a&&this._fileUploaders[a]&&this._fileUploaders[a].abort()},getFileType:function(a,b){var c=a.indexOf(".")>-1?a.split(".").pop().toLowerCase():"";return c.length>7&&(c=""),c},loadFileLocalPreview:function(a,b){if(window.FileReader&&checkFileRequirementsForPreview(a.type,a.size)){var c=new FileReader;a.type.match("image")&&(c.onload=function(a){b(c.result)},c.readAsDataURL(a)),a.type.match("video")&&(c.onload=function(){var d=new Blob([c.result],{type:a.type}),e=URL.createObjectURL(d),f=document.createElement("video"),g=function(){var a=document.createElement("canvas");a.width=f.videoWidth,a.height=f.videoHeight,a.getContext("2d").drawImage(f,0,0,a.width,a.height);var c=a.toDataURL(),d=c.length>1e5;if(d){var e=document.createElement("img");e.src=c,b(c)}return h(),d},h=function i(){URL.revokeObjectURL(e),f&&(f.removeEventListener("loadeddata",g),f.removeEventListener("timeupdate",g),f.removeEventListener("error",i),f.pause(),f=null)};f.addEventListener("loadeddata",g),f.addEventListener("timeupdate",g),f.addEventListener("error",h),f.preload="metadata",f.src=e,f.muted=!0,f.playsInline=!0,f.play()},c.readAsArrayBuffer(a))}},makeFileLocalPreview:function(a,b){var c=this;this.loadFileLocalPreview(a,function(a){_U45.DomHelper.testUrlAsImage(a,function(c,d){b&&b(d?{url:a,width:d.width,height:d.height}:null)},c)})},getSpeech:function(a,b){var c=this;return _speechCache[a]?void("#406#"===_speechCache[a]?b(null,406):b(_speechCache[a])):void _WA55.FileApi.getSpeechById(a).then(function(d){_speechCache[a]=d||"#406#",c._fileInfoCache[a]&&(c._fileInfoCache[a].speech=d||""),b(d,200)},function(c){var d=_slicedToArray(c,1),e=d[0];406===e&&(_speechCache[a]="#406#"),b(null,e)})}};var _WA56=WebIM,_U46=_WA56.util,GALLERY_COUNTERS_SCHEMA=[{type:"media",action:"media",keys:["video","image"],title:_WA56.tr("gallery.media")},{type:"video",action:"video",keys:["video"],title:_WA56.tr("gallery.video")},{type:"ptt",action:"ptt",keys:["ptt"],title:_WA56.tr("gallery.ptt")},{type:"files",action:"files",keys:["file","audio"],title:_WA56.tr("gallery.files")},{type:"links",action:"links",keys:["link"],title:_WA56.tr("gallery.links")}],concatItems=function(a,b,c,d){var e,f;return a.firstId.mid<c.mid||a.firstId.mid===c.mid&&a.firstId.seq<c.seq?(f=_U46.Array.indexOfBy(a.items,function(a){var b=a.id;return b.mid===d.mid&&b.seq===d.seq}),e=f>-1?a.items.slice(f+1):[],e=b.concat(e)):(f=_U46.Array.indexOfBy(a.items,function(a){var b=a.id;return b.mid===c.mid&&b.seq===c.seq}),e=a.items.slice(0,f),e=e.concat(b)),c=e[0].id,d=e[e.length-1].id,{items:e,firstId:c,lastId:d}},checkPrevIsLessOrEqual=function(a,b){return a.mid<b.mid||a.mid===b.mid&&a.seq<=b.seq},checkPrevIsExactlyLess=function(a,b){return a.mid<b.mid||a.mid===b.mid&&a.seq<b.seq},regroupTypeSets=function(a,b){var c={};return Object.keys(a).forEach(function(d){(!b||a[d].endIsReached)&&d.split(",").forEach(function(b){c[b]||(c[b]=[]),c[b].push(a[d])})}),c},forEachGroupWithCurrentMessage=function(a,b,c){var d=b.typeSets,e=b.itemsByMid,f=regroupTypeSets(d);e[a]&&e[a].forEach(function(b){var d=b.type;f[d]&&f[d].forEach(function(b){var d=b.groups,e=b.typeKey,f=_U46.Array.indexOfBy(d,function(b){var c=b.lastId;return c.mid<=a}),g=d[f];if(g&&g.firstId.mid>=a){var h={};e.split(",").forEach(function(a){h[a]=!0}),c(g,h),g.items.length||d.splice(f,1)}})})},forEachGroupContainsCurrentIds=function(a,b,c,d){var e=a.typeSets;Object.keys(e).forEach(function(a){var f={};a.split(",").forEach(function(a){f[a]=!0});var g=_U46.Array.findBy(e[a].groups,function(a){var c=a.lastId;return checkPrevIsLessOrEqual(c,b)});g&&checkPrevIsLessOrEqual(b,g.firstId)?d(g,f,b):(g=_U46.Array.findBy(e[a].groups,function(a){var b=a.lastId;return checkPrevIsLessOrEqual(b,c)}),g&&checkPrevIsLessOrEqual(c,g.firstId)&&d(g,f,c))})},galleryData={},requested={};_WA56.gallery={GALLERY_COUNTERS_SCHEMA:GALLERY_COUNTERS_SCHEMA,_data:galleryData,updateEvent:new _U46.Event,getLastItems:function(a,b,c){var d=c&&_toConsumableArray2(c).sort().join(",")||"full",e=galleryData[a]&&galleryData[a].typeSets[d];if(e){var f=e.groups&&e.groups[0]&&e.groups[0].items||[];if(e.endIsReached&&(f.length>=b||e.startIsReached))return{sn:a,counters:galleryData[a].galleryState.itemsCount,items:_toConsumableArray2(f),endIsReached:!0,startIsReached:e.startIsReached}}var g="".concat(a,"_").concat(b);requested[g]||(requested[g]=!0,_WA56.rapi.getGallery({sn:a,count:b,type:c,patchVersion:galleryData[a]&&galleryData[a].galleryState.galleryPatchVersion},function(){delete requested[g]}))},getItemsFromData:function(a,b,c,d,e,f){return b>-1&&(c.endIsReached||b>=f-1)&&(c.startIsReached||d.items.length-b>=e+1)?{sn:a,counters:galleryData[a].galleryState.itemsCount,items:_toConsumableArray2(d.items),startIsReached:d===c.groups[c.groups.length-1]||c.startIsReached,endIsReached:d===c.groups[0]||c.endIsReached,currentIndex:b}:void 0},getFromItem:function(a,b,c,d,e){var f=e&&_toConsumableArray2(e).sort().join(",")||"full",g=galleryData[a]&&galleryData[a].typeSets[f],h=b.mid,i=b.seq;if(g){var j=_U46.Array.findBy(g.groups,function(a){return a.firstId.mid>=h&&a.lastId.mid<=h})||{items:[]},k=_U46.Array.indexOfBy(j.items,function(a){return a.id.mid===h&&a.id.seq===i}),l=this.getItemsFromData(a,k,g,j,c,d);if(l)return l}var m="".concat(a,"_").concat(c,"_").concat(d,"_").concat(h,"_").concat(i);requested[m]||(requested[m]=!0,_WA56.rapi.getGallery({sn:a,count:c,countNewer:d,from:{mid:h,seq:"max"},type:e,patchVersion:galleryData[a]&&galleryData[a].galleryState.galleryPatchVersion},function(){delete requested[m]}))},getFromMessage:function(a,b,c,d,e,f){var g=f&&_toConsumableArray2(f).sort().join(",")||"full",h=galleryData[a]&&galleryData[a].typeSets[g];if(h){var i=_U46.Array.findBy(h.groups,function(a){return a.firstId.mid>=b&&a.lastId.mid<=b})||{items:[]},j=_U46.Array.indexOfBy(i.items,function(a){return a.id.mid===b&&a.url.indexOf(c)>-1}),k=this.getItemsFromData(a,j,h,i,d,e);if(k)return k}var l="".concat(a,"_").concat(d,"_").concat(e,"_").concat(b);requested[l]||(requested[l]=!0,_WA56.rapi.getGallery({sn:a,count:d,countNewer:e,from:{mid:b,seq:"max"},type:f,patchVersion:galleryData[a]&&galleryData[a].galleryState.galleryPatchVersion},function(){delete requested[l]}))},getItem:function(a,b,c){var d=galleryData[a]&&galleryData[a].itemsByMid[b];return d&&_U46.Array.findBy(d,function(a){return a.url.indexOf(c)>-1})},executePatch:function(a,b,c){var d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(galleryData[a]){if(b){var e=!1,f=galleryData[a],g=f.typeSets,h=f.itemsByMid;if(Object.keys(g).forEach(function(a){var c=[];g[a].groups.length&&g[a].groups[g[a].groups.length-1].lastId.mid<=b&&(e=!0,g[a].groups.some(function(a){var d=[];return a.items.some(function(a){return a.id.mid>b?void d.push(a):!0}),d.length?(a.items=d,a.firstId=d[0].id,a.lastId=d[d.length-1].id,c.push(a),void 0):!0}),g[a].groups=c,g[a].startIsReached=!0)}),e){var i={};Object.keys(h).forEach(function(a){a>b&&(i[a]=h[a])}),galleryData[a].itemsByMid=i}}var j=galleryData[a].itemsByMid;c&&c.forEach(function(b){var c=b.action,e=b.bodies,f=b.newerEntryId,g=b.olderEntryId;switch(e&&e.reverse(),c.type){case"del":forEachGroupWithCurrentMessage(c.msgId,galleryData[a],function(a){a.items=a.items.filter(function(a){return a.id.mid===c.msgId?(delete j[a.id.mid],!1):!0}),a.items[0]&&(a.firstId=a.items[0].id,a.lastId=a.items[a.items.length-1].id)});break;case"edit":forEachGroupWithCurrentMessage(c.msgId,galleryData[a],function(a,b){var f=_U46.Array.indexOfBy(a.items,function(a){return a.id.mid===c.msgId});if(f>-1){var g=a.items.slice(f).filter(function(a){return a.id.mid!==c.msgId}),h=e.filter(function(a){return b[a.type]});h.forEach(function(a){j[a.id.mid]||(j[a.id.mid]=[]),j[a.id.mid].push(a),a.author=d[a.sender]}),a.items=a.items.slice(0,f).concat(h,g),a.firstId=a.items[0].id,a.lastId=a.items[a.items.length-1].id}});break;case"insert":forEachGroupContainsCurrentIds(galleryData[a],f,g,function(a,b,c){var g=_U46.Array.indexOfBy(a.items,function(a){return checkPrevIsLessOrEqual(a.id,c)});if(g>-1){var h;c===f&&g++;var i=e.filter(function(a){return b[a.type]});i.forEach(function(a){j[a.id.mid]||(j[a.id.mid]=[]),j[a.id.mid].push(a),a.author=d[a.sender]}),(h=a.items).splice.apply(h,[g,0].concat(_toConsumableArray2(i))),a.firstId=a.items[0].id,a.lastId=a.items[a.items.length-1].id}})}})}},_onConnectionTriggerEvent:function(a,b){if("galleryNotify"===a&&b){var c=b.galleryState,d=b.sn;if(c&&d&&galleryData[d]){var e,f=galleryData[d].typeSets;if(Object.keys(f).forEach(function(a){var b=f[a],c=b.endIsReached,d=b.groups,g=d[0]&&d[0].firstId;c&&(!e||g&&checkPrevIsLessOrEqual(g,e))&&(e=g)}),e&&b.tail&&b.tail.entries&&b.tail.entries.length||c.galleryPatchVersion!==galleryData[d].galleryState.galleryPatchVersion){var g={sn:d,patchVersion:galleryData[d].galleryState.galleryPatchVersion,count:10};e&&(g.till=e,g.count=100);var h=e?"".concat(d,"_").concat(e.mid,"_").concat(e.seq):"".concat(d,"_1");if(requested[h])return;requested[h]=!0,_WA56.rapi.getGallery(g,function(){delete requested[h]})}}}else if("getGallery"===a&&b){var i=b.patch,j=b.delUpto,k=b.galleryState,l=b.endIsReached,m=b.startIsReached,n=b.items,o=b.sn,p=b.persons,q=void 0===p?{}:p,r=!galleryData[o];galleryData[o]=galleryData[o]||{typeSets:{},itemsByMid:{}};var s=galleryData[o],t=s.typeSets,u=s.itemsByMid,v="full";b.requestParams&&b.requestParams.subreqs&&b.requestParams.subreqs[0]&&b.requestParams.subreqs[0].urlType&&(v=_toConsumableArray2(b.requestParams.subreqs[0].urlType).sort().join(",")),t[v]||(t[v]={typeKey:v,groups:[]});var w=t[v],x=w.groups;if(n&&n.length){var y,z=n[0].id,A=n[n.length-1].id,B=!1,C=_U46.Array.indexOfBy(x,function(a){return checkPrevIsLessOrEqual(a.lastId,z)?(B=a.firstId.mid<A.mid||a.firstId.mid===A.mid&&a.firstId.seq<A.seq,!0):void 0});if(-1===C?x.push({items:n,firstId:z,lastId:A}):B?x.splice(C,0,{items:n,firstId:z,lastId:A}):(y=concatItems(x[C],n,z,A),z=y.firstId,A=y.lastId,x[C]=y,x[C-1]&&checkPrevIsLessOrEqual(x[C-1].lastId,z)?(y=concatItems(x[C-1],y.items,z,A),x.splice(C-1,2,y)):x[C+1]&&checkPrevIsLessOrEqual(A,x[C+1].firstId)&&(y=concatItems(x[C+1],y.items,z,A),x.splice(C,2,y))),l&&"full"===v){var D=regroupTypeSets(t,!0);n.reverse().forEach(function(a){u[a.id.mid]||(u[a.id.mid]=[]),u[a.id.mid].push(a),a.author=q[a.sender],D[a.type]&&D[a.type].forEach(function(b){var c=b.groups[0];c||(c={items:[]},b.groups.push(c)),(!c.firstId||checkPrevIsExactlyLess(c.firstId,a.id))&&(c.items.unshift(a),c.firstId=a.id,c.lastId||(c.lastId=a.id))})})}else n.forEach(function(a){u[a.id.mid]||(u[a.id.mid]=[]),u[a.id.mid].push(a),a.author=q[a.sender]})}if(k&&k.itemsCount){var E=v.split(",").filter(function(a){return!!k.itemsCount[a]});E.length||(w.endIsReached=w.startIsReached=!0)}w.endIsReached=l||w.endIsReached,w.startIsReached=m||w.startIsReached;var F=!galleryData[o].galleryState||b.requestParams&&!b.requestParams.galleryPatchVersion&&r;galleryData[o].galleryState=k,!F&&(i&&i.length||j)&&this.executePatch(o,j,i,q),this.updateEvent.fire(o)}}},_WA56.ConnectionFacade.triggerEvent.on(_WA56.gallery._onConnectionTriggerEvent,_WA56.gallery);var _WA57=WebIM,_U47=_WA57.util,SOUND_FOLDER=_WA57.imagePath+"rings/",WebAudioContext=window.AudioContext||window.webkitAudioContext,USE_WEB_AUDIO_API=!!WebAudioContext,AUTO_ACTIVATE_IOS_AUDIO=_WA57.isIOS||_WA57.isProblemStrictSafari||_WA57.isChrome,DEFAULT_AUDIO_EXTENSION=".mp3",INCOMING_MESSAGE_SOUND=_WA57.configurator.getOption("alternative_incoming_sound")?"incoming_message_alt":"incoming_message_1",RING_SCHEMA={incoming:{scope:"message",name:INCOMING_MESSAGE_SOUND},sent:{scope:"message",name:"message_sent_1"},typing:{scope:"message",name:"typing_1"},call_start:{scope:"call",name:"call_start",loop:!0},call_incoming:{scope:"call",name:"call_incoming_data",loop:!0},call_dial:{scope:"call",name:"call_dial_data",loop:!0},call_hold:{scope:"call",name:"call_hold_data",loop:!0},call_end:{scope:"call",name:"call_end_data"},call_connected:{scope:"call",name:"call_connected_data"},call_busy:{scope:"call",name:"call_busy_data"}},_iosAudioReady=!1,context,createAudioContext=function(){var a;return _U47.Mnt.wrapTryCatch(function(){a=new WebAudioContext}),a},activateOnTouch=window.test1=function(a){try{var b=new Audio;b.volume=0;var c=b.play();c&&c["catch"]&&c["catch"](function(a){})}catch(d){}!context&&USE_WEB_AUDIO_API&&(context=createAudioContext());var e=context;if(!e||!_WA57.isFunction(e.createGain)&&!_WA57.isFunction(e.createGainNode))return void _WA57.setTimeout(function(){window.removeEventListener("touchend",activateOnTouch,!1),window.removeEventListener("mousedown",activateOnTouch,!1),e&&a&&activateOnTouch()},0);!e.createGain&&e.createGainNode&&(e.createGain=e.createGainNode);var f=e.createGain(),g=e.createBuffer(1,1,22050),h=e.createBufferSource();h.buffer=g,h.connect(f),f.connect(e.destination),f.gain.value=0,h.start||(h.start=h.noteOn),h.start(0),_WA57.setTimeout(function(){h.playbackState===h.PLAYING_STATE||h.playbackState===h.FINISHED_STATE,_iosAudioReady=!0,window.removeEventListener("touchend",activateOnTouch,!1),window.removeEventListener("mousedown",activateOnTouch,!1)},0)},activateIosAudio=function(){window.addEventListener("touchend",activateOnTouch,!1),window.addEventListener("mousedown",activateOnTouch,!1)},AudioTrack=function(){function a(b,c){var d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!0;_classCallCheck2(this,a),this.id=b,this.url=c,this.looping=d,this.stateChangeEvent=new _U47.Event,this.currentState={paused:!0},this.onCanPlayHandler=this._onCanPlay.bind(this),this.onStateChangeHandler=this._onStateChange.bind(this);var e=this.audio=new Audio;e.src=c,e.preload="auto",e.volume=1,e.addEventListener("canplaythrough",this.onCanPlayHandler,!1),e.addEventListener("error",this.onStateChangeHandler,!1),e.load()}return _createClass2(a,[{key:"play",value:function(){if(!this._loaded)return void(this._autoplay=!0);if(this.audio.paused){var a=this.audio.play();a&&a["catch"]&&_U47.Mnt.wrapTryCatch(function(){a["catch"](function(){activateIosAudio()})})}}},{key:"pause",value:function(){this._autoplay=!1,this.audio.paused||this.audio.pause()}},{key:"stop",value:function(){this.pause(),4==this.audio.readyState&&this.audio.currentTime>0&&(this.audio.currentTime=0)}},{key:"isPaused",value:function(){return this.currentState.paused}},{key:"_onCanPlay",value:function(a){this._loaded||(this._loaded=!0);var b=this.audio;b.addEventListener("play",this.onStateChangeHandler,!1),b.addEventListener("pause",this.onStateChangeHandler,!1),b.addEventListener("ended",this.onStateChangeHandler,!1),b.addEventListener("stalled",this.onStateChangeHandler,!1),b.addEventListener("suspend",this.onStateChangeHandler,!1),b.addEventListener("timeupdate",this.onStateChangeHandler,!1),b.removeEventListener("canplaythrough",this.onCanPlayHandler,!1),this._autoplay&&this.play()}},{key:"_onStateChange",value:function(a){this.currentState={paused:this.audio.paused,currentTime:this.audio.currentTime,duration:this.audio.duration,error:a&&"error"===a.type,readyState:this.audio.readyState},"error"===a.type&&console.log("###MEDIAERROR",a),"ended"===a.type&&(this.pause(),this.audio.currentTime=0),this.stateChangeEvent.fire(this.id,this.currentState)}},{key:"destroy",value:function(){this.stateChangeEvent.removeAll(),this._loaded&&(this.audio.removeEventListener("play",this.onStateChangeHandler,!1),this.audio.removeEventListener("pause",this.onStateChangeHandler,!1),this.audio.removeEventListener("timeupdate",this.onStateChangeHandler,!1),this.audio.pause()),this.audio.removeEventListener("error",this.onStateChangeHandler,!1),delete this.audio}}]),a}(),WebAudioTrack=function(){function a(b,c){var d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1;_classCallCheck2(this,a),this.id=b,this.looping=d,this.buffer=null,this.playing=!1,"suspended"===context.state&&context.resume(),this._loadUrl(c)}return _createClass2(a,[{key:"_loadUrl",value:function(a){var b=this,c=new XMLHttpRequest;c.open("GET",a,!0),c.responseType="arraybuffer",c.onload=function(){context.decodeAudioData(c.response,function(c){c?b._onCanPlay(c):console.log("error decoding file data: "+a)},function(a){console.log("decodeAudioData error",a)})},c.onerror=function(){console.log("BufferLoader: XHR error")},c.send()}},{key:"_onCanPlay",value:function(a){this._loaded=!0,this.buffer=a,this._autoplay&&this.play()}},{key:"isPaused",value:function(){return!0}},{key:"pause",value:function(){}},{key:"stop",value:function(){this.source1&&this.source1.stop()}},{key:"play",value:function(){var a=this;return this._loaded?(context&&context.close&&!_WA57.isDesktop&&!_WA57.isIOS?("running"===context.state&&context.close(),context=createAudioContext()):context&&context.close,void(!this.playing&&context&&(this.source1=context.createBufferSource(),this.source1.buffer=this.buffer,this.source1.onended=function(){a.playing=!1},this.source1.connect(context.destination),this.looping&&(this.source1.loop=!0),this.source1.start||(this.source1.start=this.source1.noteOn),this.playing=!0,this.source1.start(0)))):void(this._autoplay=!0)}}]),a}(),_audioCache={},destroyTrack=function(a){_audioCache[a]&&(_audioCache[a].destroy(),delete _audioCache[a])};_WA57.mediaPlayer={stateEvent:new _U47.Event,_currentTrackId:null,_onTrackStateChange:function(a,b){_WA57.mediaPlayer.stateEvent.fire(a,b),b.error&&(_WA57.showPopup(_WA57.tr("dialog.msgFailedToPlayRecord")),0==b.readyState&&(_WA57.mediaPlayer._currentTrackId===a&&(_WA57.mediaPlayer._currentTrackId=null),destroyTrack(a)))},getState:function(a){return _audioCache[a]&&_audioCache[a].currentState},play:function(a,b){console.log("@!@!@!play"),this._currentTrackId&&this._currentTrackId!==a&&_audioCache[this._currentTrackId].stop();var c=_audioCache[a];c||(this.stateEvent.fire(a,{paused:!1}),_audioCache[a]=c=new AudioTrack(a,b),c.stateChangeEvent.on(this._onTrackStateChange)),this._currentTrackId=a,c.currentState.paused?c.play():c.pause()},pause:function(){var a=this._currentTrackId&&_audioCache[this._currentTrackId];a&&!a.currentState.paused&&a.pause()},readState:function(a){var b=this._currentTrackId&&_audioCache[this._currentTrackId];b&&a(b.id,b.currentState)},free:function(){this.stateEvent.removeAll(),this._currentTrackId=null,Object.keys(_audioCache).forEach(destroyTrack),_audioCache={}}};var SoundManager={_trackCache:{},_lastPlayed:{},ring:function(a){var b=RING_SCHEMA[a].scope,c=RING_SCHEMA[a].name,d=RING_SCHEMA[a].loop||!1;if(this._lastPlayed[b]!==a&&this.stop(b),!_WA57.Feature.getModeParameter("disableNotificationSounds")){var e=_WA57.boardModeParams?_WA57.boardModeParams.mute:_WA57.AccountSettings.getOption(_WA57.AccountSettings.OPTION_MUTE_SOUND);window.Audio&&!e&&(USE_WEB_AUDIO_API&&AUTO_ACTIVATE_IOS_AUDIO&&!_iosAudioReady||(this._lastPlayed[b]=a,this._playLocalAudioFile(c,!!d)))}},stopRing:function(a){this.stop(RING_SCHEMA[a].scope)},stop:function(a){var b=this._lastPlayed[a];b&&this._stopLocalAudioFile(RING_SCHEMA[b].name),delete this._lastPlayed[a]},_playLocalAudioFile:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:!1,c=this._trackCache[a];if(!c){var d=SOUND_FOLDER+a+DEFAULT_AUDIO_EXTENSION;try{USE_WEB_AUDIO_API&&context?this._trackCache[a]=c=new WebAudioTrack(a,d,b):this._trackCache[a]=c=new AudioTrack(a,d,b)}catch(e){activateIosAudio()}}c&&c.play()},_stopLocalAudioFile:function(a){var b=this._trackCache[a];b&&b.looping&&b.stop()}};_WA57.ring=SoundManager.ring.bind(SoundManager),_WA57.stopRing=SoundManager.stop.bind(SoundManager),USE_WEB_AUDIO_API&&(AUTO_ACTIVATE_IOS_AUDIO?activateIosAudio():context=createAudioContext());var _WA58=WebIM,AS=_WA58.AccountSettings,Notifier=_WA58.Notifier,_U48=_WA58.util,NOTIFICATIONS_MAX_VISIBLE=3,ntfsQueue=[],ntfsHash={},lastMsgIds=[],MessageNotifier={clickEvent:new _U48.Event,_init:function(){this._inited||(this._inited=!0,_WA58.focusEvent.on(MessageNotifier.clear,MessageNotifier),
Notifier.showEvent.on(function(){}),Notifier.clickEvent.on(function(a){ntfsQueue.forEach(function(b){ntfsHash[b]==a&&MessageNotifier.clickEvent.fire(b)})}),Notifier.hideEvent.on(function(a){ntfsQueue.forEach(function(b){ntfsHash[b]==a&&(_U48.Array.remove(ntfsQueue,b),delete ntfsHash[b])})}))},show:function(a,b,c){if(_WA58.Api.postEventToParent("notification",b),_WA58.isDesktop&&!(_WA58.Feature.getModeParameter("disableNotifications")||lastMsgIds.indexOf(c)>-1)){lastMsgIds.unshift(c)>10&&lastMsgIds.pop(),this._init();var d;if(this.hide(a),!AS.getOption(AS.OPTION_BLOCK_DESKTOP_NOTIFICATIONS)&&!_WA58.inFocus()){if("call"===b.type)b.text=_WA58.tr("dialog.incomingCall");else if(AS.getOption(AS.OPTION_HIDE_TEXT_IN_NOTIFICATIONS)||_WA58.configurator.getOption("disable_notification_text")){if(!b.newCounter)return;b.text=_WA58.tr("notify.newMessages",{count:b.newCounter>999?"1k":b.newCounter})}ntfsQueue.length>=NOTIFICATIONS_MAX_VISIBLE&&this.hide(ntfsQueue[0]),d=Notifier.show(a,b.title,(b.textPrefix||"")+(b.text||""),b.icon||null),ntfsQueue.push(a),ntfsHash[a]=d}}},hide:function(a){ntfsHash[a]&&(_U48.Array.remove(ntfsQueue,a),Notifier.hide(ntfsHash[a]),delete ntfsHash[a])},clear:function(){ntfsQueue=[],ntfsHash={},Notifier.clear()}};_WA58.MessageNotifier=MessageNotifier;var _WA59=WebIM,_U49=_WA59.util,_UI37=_WA59.ui,_TD20=_WA59.TemplateDriver,TEMPORARY_POLL_ID_PREFIX="newpoll_",SUBSCRIBE_TIMEOUT=40,CHECK_SUBSCRIBE_INTERVAL=1e4,POLL_DEFAULT_ANSWERS=[{answerId:"",text:""},{answerId:"",text:""}],Polls=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a._cache={},a._loading={},a._subscribeTs={},a._requestedTs={},a.updatePollEvent=new _U49.Event,a._subscribingTimeout=new _U49.DelayedTask({interval:CHECK_SUBSCRIBE_INTERVAL,fn:a._checkSubscribedPolls.bind(_assertThisInitialized2(_assertThisInitialized2(a)))}),a._subscribingTimeout.start(),a}return _inherits2(b,a),_createClass2(b,[{key:"_onConnectionPollUpdate",value:function(a){this._cache[a.id]=a,this.updatePollEvent.fire(a.id)}},{key:"_checkSubscribedPolls",value:function(){var a=this;Object.keys(this._subscribeTs).forEach(function(b){(!a._requestedTs[b]||a._subscribeTs[b]-a._requestedTs[b]>SUBSCRIBE_TIMEOUT)&&(a._requestPollInfo(b),delete a._subscribeTs[b])}),this._subscribingTimeout.start()}},{key:"allocate",value:function(){var a=TEMPORARY_POLL_ID_PREFIX+_WA59.uniq();return a}},{key:"subscribe",value:function(a){a&&!a.startsWith(TEMPORARY_POLL_ID_PREFIX)&&(this._subscribeTs[a]=_WA59.now())}},{key:"_getPollInfo",value:function(a){return!a||a.startsWith(TEMPORARY_POLL_ID_PREFIX)?null:this._cache[a]?this._cache[a]:(this._requestPollInfo(a),null)}},{key:"isStoppable",value:function(a){return this._cache[a]?this._cache[a].canStop&&!this._cache[a].closed:void 0}},{key:"isRecallable",value:function(a){return this._cache[a]?this._cache[a].myAnswerId&&!this._cache[a].closed:void 0}},{key:"revoke",value:function(a){_U49.Mnt.countRB(52121153),_WA59.rapi.revokePoll(a)}},{key:"stop",value:function(a){_UI37.confirmAction(_WA59.tr("polls.stopPollExplanation"),{title:_WA59.tr("polls.stopPoll"),okButton:_WA59.tr("stop")}).then(function(){_WA59.rapi.stopPoll(a)})}},{key:"_requestPollInfo",value:function(a){var b=this;this._loading[a]||(this._loading[a]=!0,this._requestedTs[a]=_WA59.now(),_WA59.rapi.getPoll(a,function(c,d,e,f){delete b._loading[a],f&&b._onGetPollInfo(a,f)}))}},{key:"_onGetPollInfo",value:function(a,b){this._cache[a]=b,this.updatePollEvent.fire(a)}},{key:"_buildSubtitle",value:function(a){var b="",c=0;return"public"===a.type&&(b=_WA59.tr("polls.publicPoll")),"anon"===a.type&&(b=_WA59.tr("polls.anonymousPoll")),a.answers&&a.answers.forEach(function(a){a.votes>0&&(c+=a.votes)}),b&&c>0&&(b+=" — "+_WA59.tr("polls.nVotes",{count:c})),b}},{key:"generateShortSnippet",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return _TD20.parseSafe("pollShortSnippet",{title:a},{safeKeys:["title"]})}},{key:"generateSnippet",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return _TD20.parseSafe("pollCardWrap",{id:a,content:this._generateSafeSnippetContent(a,b)},{safeKeys:["content"]})}},{key:"_generateSafeSnippetContent",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",c=this._getPollInfo(a)||{},d="",e=!!c.answers,f=e&&c.closed,g=e&&!f&&!c.myAnswerId,h=e&&!g,i=this._buildSubtitle(c),j=0,k=[],l=c.answers||POLL_DEFAULT_ANSWERS;return e||k.push("im-poll-card_default"),h&&k.push("im-poll-card_finished"),g&&k.push("im-poll-card_active"),l.forEach(function(a){j+=a.votes||0}),l.forEach(function(a){var b=j>0?Math.floor(100*a.votes/j):0;d+=_TD20.parseSafe("pollCardItem",{title:a.text,id:a.answerId,votes:h?a.votes:"",percent:h?b+"%":"",cls:c.myAnswerId===a.answerId?"im-poll-card__item_checked":"",bubbleStyle:h?"width:"+(b>0&&4>b?4:b)+"%":""})}),_TD20.parseSafe("pollCard",{cls:k.join(" "),title:b,subtitle:i,items:d},{safeKeys:["title","items"]})}},{key:"updatePollNode",value:function(a,b){var c=b.getSelector(".imPollTitle").dom.innerHTML;b.updateHTML(this._generateSafeSnippetContent(a,c))}},{key:"pollClick",value:function(a){var b=a.up("imPollCard"),c=b.getAttribute("data-id"),d=a.up("imButton"),e=d&&d.getAttribute("data-id"),f=this._cache[c];return e&&f&&!f.myAnswerId&&!f.closed?(this.vote(c,e),!0):!1}},{key:"vote",value:function(a,b){_U49.Mnt.countRB(52121136),_WA59.rapi.votePoll(a,b)}},{key:"destroy",value:function(){this._subscribingTimeout.stop(),this.updatePollEvent.removeAll(),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_WA59.conn.ES6ConnectionRoster);_WA59.Polls=new Polls;var _WA60=WebIM,_U50=_WA60.util,MAX_PTT_DURATION=3e4,_DomUtil29=_WA60.DomUtil,soundRecorder,USE_FREQUENCY=!0,_debugCnvCont,_debugDraw=function(){var a=2e3,b=200;_debugCnvCont||(_debugCnvCont=_DomUtil29.getBody().createChild({style:"white-space:nowrap;overflow:auto;position:absolute;width:"+a/2+"px;height:"+2*b+"px;left:300px;top:50px;z-index:99999;"}));var c=_debugCnvCont.createChild({tag:"canvas",style:"width:"+a+"px;height:"+2*b+"px;border-right:1px solid #1111ff;",width:a,height:2*b}),d=c.dom.getContext("2d");d.fillStyle="rgb(200,200,200)",d.fillRect(0,0,a,2*b);var e=soundRecorder.analyser.frequencyBinCount,f=new Uint8Array(e);soundRecorder.analyser.getByteFrequencyData(f);for(var g,h=a/e,i=0,j=0;e>j;j++)g=b/255*f[j],d.fillStyle="rgb("+(g+100)+",50,50)",d.fillRect(i,2*b-g,h,g),i+=h;e=soundRecorder.analyser.fftSize,f=new Uint8Array(e),soundRecorder.analyser.getByteTimeDomainData(f),d.beginPath(),d.lineWidth=.5,d.strokeStyle="rgb(0, 0, 0)",d.moveTo(0,b/2),d.lineTo(a,b/2),d.moveTo(0,b),d.lineTo(a,b),d.stroke(),d.lineWidth=2,d.strokeStyle="rgb(50, 0, 0)",d.beginPath();var k=1*a/e;i=0;for(var l=0;e>l;l++){var m=f[l]/128,n=m*b/2;0===l?d.moveTo(i,n):d.lineTo(i,n),i+=k}d.stroke()};if(window.Recorder){if(!_WA60.isEdge&&!_WA60.isIE){var _oldInitAudioGraph=Recorder.prototype.initAudioGraph;Recorder.prototype.initAudioGraph=function(){_oldInitAudioGraph.call(this),this.analyser=this.audioContext.createAnalyser(),this.analyser.minDecibels=-70,this.analyser.maxDecibels=-30,this.analyser.smoothingTimeConstant=0,USE_FREQUENCY?this.analyser.fftSize=256:this.analyser.fftSize=4096,this.recordingGainNode.connect(this.analyser)}}Recorder.prototype.start=function(a){var b=this;return"inactive"===this.state?(this.initAudioContext(a),this.initAudioGraph(),this.initSourceNode(a).then(function(a){b.encoder.postMessage(Object.assign({command:"init",originalSampleRate:b.audioContext.sampleRate,wavSampleRate:b.audioContext.sampleRate},b.config)),b.sourceNode=a,b.sourceNode.connect(b.monitorGainNode),b.sourceNode.connect(b.recordingGainNode),setTimeout(function(){b.state="recording",b.onstart()},_WA60.isProblemStrictSafari?1500:100)})):void 0},Recorder.prototype.storePage=function(a){if(null===a||a.blob){var b;this.totalLength&&(b=new Uint8Array(this.totalLength),this.recordedPages.reduce(function(a,c){return b.set(c,a),a+c.length},0)),this.ondataavailable(b,a&&a.blob),this.initWorker(),this.onstop()}else this.recordedPages.push(a),this.totalLength+=a.length};var _oldIStop=Recorder.prototype.stop;Recorder.prototype.stop=function(){_oldIStop.call(this),this.onstoping()},Recorder.prototype.switchEncoder=function(a){var b=this;this.initWorker(),this.encoder.postMessage(Object.assign({command:"init",originalSampleRate:this.audioContext.sampleRate,wavSampleRate:this.audioContext.sampleRate},this.config)),a.forEach(function(a){b.encoder.postMessage(a)})},Recorder.prototype.clip=function(){this.encoder._postMessage=this.encoder.postMessage,this.encoder.postMessage=function(b){"encode"===b.command&&(a.push(b),1===a.length&&(this._postMessage(b),this._postMessage({command:"done"})))};var a=[];this.storePage=function(b){if(null===b||b.blob){var c;if(this.totalLength){var d=new Uint8Array(this.totalLength);this.recordedPages.reduce(function(a,b){return d.set(b,a),a+b.length},0)}this.ondataavailable(c,b&&b.blob),delete this.storePage,delete this.streamPage,this.onclip(),this.switchEncoder(a)}else this.recordedPages.push(b),this.totalLength+=b.length},this.streamPage=function(b){null===b?(delete this.storePage,delete this.streamPage,this.onclip(),this.switchEncoder(a)):this.ondataavailable(b)}},Recorder.prototype.onclip=function(){},Recorder.prototype.onstoping=function(){}}_WA60.pttRecorder={stateEvent:new _U50.Event,analyserEvent:new _U50.Event,playbackEvent:new _U50.Event,_started:!1,recordedData:null,analyserData:null,isSupported:function(){return(window.AudioContext||window.webkitAudioContext)&&window.navigator&&window.navigator.mediaDevices&&window.navigator.mediaDevices.getUserMedia&&window.WebAssembly},_startOnStoped:function(a){"stop"===a&&(this.stateEvent.un(this._startOnStoped,this),this.start(this.maxPttDuration))},_startAnalyser:function(){this._analyserTimer&&(clearTimeout(this._analyserTimer),this._analyserTimer=null),this._analyserTimer=_WA60.setTimeout(this._analyserGrab.bind(this),20)},_stopAnalyser:function(a){this._analyserTimer&&(clearTimeout(this._analyserTimer),this._analyserTimer=null),a&&this._analyserGrab()},_analyserGrab:function(){var a,b,c=(new Date).getTime();if(this.analyserData||(this.analyserData={duration:0}),soundRecorder.analyser)if(USE_FREQUENCY?(a=soundRecorder.analyser.frequencyBinCount,b=new Uint8Array(a),soundRecorder.analyser.getByteFrequencyData(b)):(a=soundRecorder.analyser.fftSize,b=new Uint8Array(a),soundRecorder.analyser.getByteTimeDomainData(b)),this._cachedAnalyserData.push(b),this.analyserData.bars||(this.analyserData.bars=[],this._analyserMaxBar=0),USE_FREQUENCY){for(var d,e=this._analyserMaxBar,f=0;a>f;f++)d=b[f]/255,d>e&&(e=d);this._analyserMaxBar=e}else{for(var g,h=this._analyserMaxBar,i=0;a>i;i++)g=Math.abs(b[i]/127-1),g>h&&(h=g);this._analyserMaxBar=h}if(this.__recorderStartedTS){var j=(c-this.__recorderStartedTS)/1e3;this.analyserData.duration=j,this.analyserEvent.fire(j)}this._analyserTimer&&(this._analyserTimer=_WA60.setTimeout(this._analyserGrab,20,this))},_initRecorder:function(){soundRecorder||(this.soundRecorder=soundRecorder=new Recorder({monitorGain:0,bufferLength:4096,recordingGain:1,numberOfChannels:2,encodeAfterRecord:!0,encoderBitRate:64e3,encoderSampleRate:48e3,metaType:"audio/mpeg",extension:"mp3",encoderPath:_WA60.resPath+"encoderWorkerMp3.js"}),soundRecorder.ondataavailable=function(a,b){var c=this._recordedDuration;delete this.__recorderStartedTS,console.log("Recorder ondataavailable",soundRecorder," DURATION:",c);var d=b||new Blob([a],{type:soundRecorder.config.metaType}),e=(new Date).toISOString()+"."+soundRecorder.config.extension;d.lastModifiedDate=new Date,d.name=e;var f=URL.createObjectURL(d);this.recordedData={blob:d,duration:c,url:f}}.bind(this),soundRecorder.onclip=function(){var a=this;this.__recorderStartedTS=(new Date).getTime(),console.log("Recorder is switched"),this.maxPttDuration&&(this._recTimer=_WA60.setTimeout(function(){a._recTimer=null,soundRecorder.clip()},this.maxPttDuration)),this.stateEvent.fire("clip",this.recordedData)}.bind(this),soundRecorder.onstart=function(a){var b=this;delete this.__recorderWaitingForPermissions,this.__recorderStartedTS=(new Date).getTime(),this._startAnalyser(),console.log("Recorder is started"),this.maxPttDuration&&(this._recTimer=_WA60.setTimeout(function(){b._recTimer=null,b.stateEvent.fire("overtime")},this.maxPttDuration)),this.stateEvent.fire("start")}.bind(this),soundRecorder.onstoping=function(a){console.log("Recorder is stoping"),this._recTimer&&(clearTimeout(this._recTimer),this._recTimer=null),this._recordedDuration=((new Date).getTime()-this.__recorderStartedTS)/1e3,this.analyserData||(this.analyserData={duration:0}),this.analyserData.duration=this._recordedDuration,this._stopAnalyser(!0),this.buildCurrentAnalyserData(),this.stateEvent.fire("stop")}.bind(this),soundRecorder.onstop=function(a){console.log("Recorder is stopped"),this.stateEvent.fire("ready",this.recordedData)}.bind(this))},start:function(a){if(!this.isSupported())return this.stateEvent.fire("error",new Error("Recorder is not supported")),!1;if(this.recordedData=null,this.analyserData=null,this._cachedAnalyserData=[],this.maxPttDuration=0,a&&(this.maxPttDuration=Math.max(0,a-1e3)),this._started=!0,this._initRecorder(),this.__recorderWaitingForPermissions)console.log("### ignore click");else if(this.__recorderStartedTS)console.log("###this._soundRecorder.stop()"),this.stateEvent.un(this._startOnStoped,this),this.stateEvent.on(this._startOnStoped,this),soundRecorder.stop();else{var b=soundRecorder.start();b?(this.__recorderWaitingForPermissions=!0,console.log("### setting catch"),b["catch"](function(a){delete this.__recorderWaitingForPermissions,console.log("Error encountered:",a.message,a),this.stateEvent.fire("error",a)}.bind(this))):(console.log("### CANT START RECORDER YET..."),this.stateEvent.fire("error",new Error("CANT START RECORDER YET")))}},stop:function(){this.isStarted()?(this._started=!1,soundRecorder&&soundRecorder.stop()):this.playMode&&this.audio&&(this.audio.pause(),this.audio.currentTime=0,this.playMode=!1)},pause:function(){this.playMode&&this.audio&&(this.audio.pause(),this.playMode=!1,this._firePlaybackEvent())},_firePlaybackEvent:function(a){if(this._playbackTimer&&(clearTimeout(this._playbackTimer),this._playbackTimer=null),this.recordedData){var b=(new Date).getTime();void 0!==a?(this._lastTimeupdateTS=b,this._lastCurrentTime=a):a=this._lastCurrentTime+(b-this._lastTimeupdateTS)/1e3,this.playbackEvent.fire(a,this.recordedData.duration),this.playMode&&(this._playbackTimer=_WA60.setTimeout(this._firePlaybackEvent.bind(this),50))}},play:function(){var a=this;!this.isStarted()&&this.recordedData&&(this.playMode=!0,this.audio||(this.audio=new Audio,this.audio.ontimeupdate=function(){if(a.playMode){var b=a.audio.duration>a.recordedData.duration?a.recordedData.duration:a.audio.duration;a.audio.currentTime>=b?(a.audio.pause(),a.playMode=!1,a.audio.currentTime=0,a._firePlaybackEvent(a.recordedData.duration)):a._firePlaybackEvent(a.audio.currentTime)}},this.fileReader=new FileReader,this.fileReader.onload=function(b){var c=b.target.result;a.audio.src=c,a.audio.onloadedmetadata=function(){a.audio.onloadedmetadata=null,console.log("IM:PttRec:play:onloadedmetadata: audio.duration=",a.audio.duration,"recordedData.duration=",a.recordedData.duration),a.audio.duration!==1/0&&(a.recordedData.duration=a.analyserData.duration=a.audio.duration),a.audio.play()}}),this._currentPlayedData===this.recordedData?this.audio.play():(this._currentPlayedData=this.recordedData,this.fileReader.readAsDataURL(this.recordedData.blob)))},setCurrentProgress:function(a){if(this.audio&&this.recordedData&&this.recordedData.duration){var b=this.recordedData.duration,c=b*a.toFixed(2),d=this.playMode;this.audio.pause(),this.audio.currentTime=b-c>.1?c:0,d&&(this.playMode=!0,this.audio.play()),this._firePlaybackEvent(this.audio.currentTime)}},hasRecord:function(){return!!this.recordedData},isStarted:function(){return this._started},buildCurrentAnalyserData:function(){return this.analyserData&&this.analyserData.bars&&this.analyserData.bars.push(this._analyserMaxBar||0),this._analyserMaxBar=0,this.analyserData},resetAnalyserCustomBars:function(){this.analyserData&&delete this.analyserData.customBars},calculateAnalyserCustomBars:function(a){if(this.analyserData&&this._cachedAnalyserData&&this._cachedAnalyserData.length){var b=this._cachedAnalyserData,c=b[0].length,d=b[b.length-1].length,e=(b.length-1)*c+d,f=Math.floor(e/a)||1,g=[],h=[];return b.forEach(function(a,c){for(var d=0,e=a.length;e>d;d+=f){if(g.length<f){var i;d=-g.length,(i=g).push.apply(i,_toConsumableArray2(a.slice(0,d+f)))}else{var j;g=[],(j=g).push.apply(j,_toConsumableArray2(a.slice(d,d+f)))}(g.length===f||c===b.length-1)&&!function(){var a=0;g.forEach(function(b){b=USE_FREQUENCY?b/255:Math.abs(b/127-1),b>a&&(a=b)}),h.push(a)}()}}),this.analyserData.customBars=h,this.analyserData}}};var _WA61=WebIM,RTC_SUPPORTED=!(!navigator.mediaDevices||!window.RTCPeerConnection),WEBRTC_ALLOWED_USER_DOMAINS=_WA61.configurator.getOption("restricted_webrtc_domains"),WEBRTC_ENABLED=RTC_SUPPORTED&&_WA61.isDesktop&&!_WA61.isEdge&&!_WA61.configurator.getOption("disable_webrtc_calls");log=function(){console.log.apply(console,arguments)};var RTCTools={isEnabled:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:_WA61.ACTIVE_MAIL;if(WEBRTC_ALLOWED_USER_DOMAINS){var b=a&&a.substr(a.indexOf("@")+1);if(!b||-1===WEBRTC_ALLOWED_USER_DOMAINS.indexOf(b))return!1}return WEBRTC_ENABLED},mediaConstraints:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},getDeviceList:function(){if(!RTC_SUPPORTED)return Promise.reject("Media denied!");var a=navigator.mediaDevices.enumerateDevices();return a["catch"](function(a){console.log("###err:",a)}),a},accessMedia:function(a,b){var c=this,d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(this.requestingPermissions)return Promise.reject("Already requested!");if(!RTC_SUPPORTED)return Promise.reject("Media denied!");this.requestingPermissions=!0;var e=b&&d.audioInput?{deviceId:{exact:d.audioInput}}:!!b,f=a&&d.videoInput?{deviceId:{exact:d.videoInput}}:!!a,g={audio:e,video:f};console.log("###CONSTRAINTS",g);var h=navigator.mediaDevices.getUserMedia(g);return h.then(function(a){log("### accessMedia OK",a,a.getTracks())})["catch"](function(a){log("accessMedia failure:"+a.name+": "+a.message)})["finally"](function(){log("###_clearUserMediaCb"),c.requestingPermissions=!1}),h},createIceConfig:function(a,b,c,d){var e=[],f="mail.ru",g=[],h=[],i=[];return b.split(";").forEach(function(a){g.push("stun:"+a)}),e.push({urls:g}),c.split(";").forEach(function(a){h.push("turn:"+a+"?transport=udp")}),e.push({urls:h,credentialType:"password",username:a,credential:f}),d.split(";").forEach(function(a){i.push("turn:"+a+"?transport=tcp")}),e.push({urls:i,credentialType:"password",username:a,credential:f}),log("###createIceConfig",e),e},createRTCPeerConnection:function(a){var b={iceServers:a,bundlePolicy:"max-bundle"};return log("Create RTCPeerConnection with icq_config: ",a),new RTCPeerConnection(b)},createRTCSessionDescription:function(a){return log("Create createRTCSessionDescription for message: ",a),new RTCSessionDescription(a)},createIceCandidate:function(a){log("Create IceCandidate with candidate=",a);var b=a.substr(0,1);return new RTCIceCandidate({candidate:a.substr(2),sdpMid:b,sdpMLineIndex:parseInt(b)})},createOffer:function(a){return log("Create Promise-Offer with constraints: ",this.mediaConstraints),a.createOffer(this.mediaConstraints)},createAnswer:function(a){return log("Create Promise-Answer with constraints: ",this.mediaConstraints),a.createAnswer(this.mediaConstraints)},mediaStreamHaveAudioTrack:function(a){return a&&a.getAudioTracks().length>0&&"live"==a.getAudioTracks()[0].readyState},mediaStreamHaveVideoTrack:function(a){return a&&a.getVideoTracks().length>0&&"live"==a.getVideoTracks()[0].readyState},isFullscreenSupported:!!(document.cancelFullScreen&&document.fullScreenEnabled===!0||document.webkitCancelFullScreen&&document.webkitFullscreenEnabled===!0||document.mozCancelFullScreen&&document.mozFullScreenEnabled===!0),isFullscreenMode:function(){return this.isFullscreenSupported&&(document.fullScreen===!0||document.webkitIsFullScreen===!0||document.mozFullScreen===!0)},toggleFullscreenMode:function(a,b){return log("toggleFullscreenMode",this.isFullscreenSupported),this.isFullscreenSupported?b!==this.isFullscreenMode()?(this.isFullscreenMode()?document.cancelFullScreen?document.cancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.mozCancelFullScreen&&document.mozCancelFullScreen():a.requestFullScreen?a.requestFullScreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen&&a.webkitRequestFullscreen(),!0):void 0:!1},addStream:function(a,b){if(a.addTrack){var c=b.getTracks()||[];c.forEach(function(c){return a.addTrack(c,b)})}else a.addStream?a.addStream(b):log("SORRY, CANNOT ADD STREAM TO CONNECTION")},stopStream:function(a){if(a){var b=a.getTracks();b.forEach(function(a){a.stop()})}},muteAudio:function(a,b){for(var c=a.getAudioTracks(),d=0;d<c.length;d++)c[d].enabled=b===!1}};_WA61.RTCTools=RTCTools;var _WA62=WebIM,_U51=_WA62.util,_TD21=_WA62.TemplateDriver,Us=_U51.String,ALLOW_SNIPPET_PREVIEW_SERVICE=!_WA62.configurator.getOption("disable_snippet_preview_service"),_OFFLINE_REQUEST_REPEAT_TIMEOUT=5e3,PREVIEW_MIN_HEIGHT=68,PREVIEW_MAX_HEIGHT=1e3,PREVIEW_MIN_WIDTH=68,PREVIEW_ARTICLE_MIN_HEIGHT=80,DIRECT_ARTICLE_MAX_WIDTH=220,DIRECT_ARTICLE_MIN_WIDTH=200,PREVIEW_ARTICLE_MIN_WIDTH=220,CACHE_LIVE_TIME=1200,_loadingCache3={},_fullRequested={},_linksWithoutSnippetCache={},_infoCache={},__lastRequestedTitle,_allowRemoteLoading2=!1,_remoteLoadingQueue2=[],_makeSnippetInfo=function(a,b){var c={content_type:"contact",title:b.name||" ",subtitle:b.sub,favicon:null,snippet:b.about||"",fetch_ts:+(1/0),contactId:b.id,contactSn:b.sn,contactPhone:b.phone};if(b.sn||b.phone){var d=_WA62.Ava.make(b.sn||b.phone,b.name,44,function(b){_infoCache[a]&&(_infoCache[a].preview={preview_url:b.url,preview_width:b.size&&b.size.width,preview_height:b.size&&b.size.height,avatar:b},_WA62.snippet.loadEvent.fire(a))});d.remoteLoaded?c.images=[{preview_url:d.url,preview_width:d.size&&d.size.width,preview_height:d.size&&d.size.height,avatar:d}]:c.images=[{avatar:d}]}return delete _infoCache[a],c},_makeSnippetInfoFromIdInfo=function(a,b){var c={};if(b.chat)c.name=b.chat.name,c.sub=_WA62.tr("chat.countMembers",{count:b.chat.memberCount}),c.about=b.chat.about,c.id=b.chat.stamp,c.sn=b.chat.sn;else{if(!b.user)return null;c.name=b.user.friendly,c.sub=(b.user.nick||"").replace(/^([^@])/,"@$1"),c.about=b.user.about,c.id=b.user.nick,c.sn=b.user.sn,c.phone=b.user.phone}return _makeSnippetInfo(a,c)},_makeSnippetInfoFromProfile=function(a,b){var c={name:b.nickname,sub:_WA62.uinAsName(b.email),about:b.aboutMe,sn:b.email};return b.uNick&&(c.id=b.uNick),_makeSnippetInfo(a,c)},_parseSnippetObject=function(a,b,c,d){var e=b.images?b.images[0]:null;_fullRequested[a]=c;var f=d||{};return c||(f={}),{reqUrl:a,contentType:f.content_type||b.content_type||"error",domain:f.domain||b.domain||_U51.String.parseHostname(a),title:f.title||b.title||"",favicon:b.favicon&&Us.ensureHttpsUrl(b.favicon[0].preview_url)||null,snippet:f.snippet||b.snippet,subtitle:b.subtitle,contactSn:b.contactSn,contactId:b.contactId,contactPhone:b.contactPhone,preview:e,expiredTime:+(b.fetch_ts||_WA62.now())+CACHE_LIVE_TIME}},Snippet={FLAG_TEXT_MIX:1,FLAG_TEXT_BEFORE:2,FLAG_NOT_SINGLE_LINK:4,FLAG_DONT_REPLACE_LINK:8,loadEvent:new _U51.Event,denyRemoteLoading:function(){_allowRemoteLoading2=!1},allowRemoteLoading:function(){var a=this;_allowRemoteLoading2=!0,_remoteLoadingQueue2.forEach(function(b){a._requestSnippetInfo.apply(a,b)}),_remoteLoadingQueue2=[]},urlHasSnippet:function(a){var b=_fullRequested[a]&&_infoCache[a];return!(!b||"file"!==b.contentType&&!b.preview&&!b.title)},cacheSnippetInfo:function(a,b,c,d){b?_infoCache[a]=_parseSnippetObject(a,b,c,d):(_linksWithoutSnippetCache[a]=!0,_infoCache[a]={contentType:"error",reqUrl:a,title:a,expiredTime:_WA62.now()+CACHE_LIVE_TIME})},resolveLinkAsContact:function(a){var b=_WA62.urlBuilder.idLinkMatch(a);return b||(b=_WA62.urlBuilder.liveChatMatch(a)),b&&b[1]?{id:b[1]}:(b=_WA62.urlBuilder.profileMatch(a),b&&b[1]&&!_WA62.isUIN(b[1])?{sn:b[1]}:void 0)},resolveLinkAsContactText:function(a,b){var c=this.resolveLinkAsContact(a);return c?this.getContactTextSafeHtml(b):void 0},getContactTextSafeHtml:function(a){var b=_WA62.tr("cl.contact");return a?_TD21.parseSafe("mediaAsText",{type:"contact",text:b}):b},_onGetUrlInfo:function(a,b,c,d){var e=this;if(delete _loadingCache3[a],!b&&"offline"===_WA62.onlineManager.getStatus())return void _WA62.setTimeout(function(){e._requestSnippetInfo(a,c,d)},_OFFLINE_REQUEST_REPEAT_TIMEOUT);this.cacheSnippetInfo(a,b,!0,_infoCache[a]),c&&c(_infoCache[a]);var f=__lastRequestedTitle===a;__lastRequestedTitle&&(__lastRequestedTitle=null),this.loadEvent.fire(a,f)},_requestSnippetInfo:function(a,b,c){var d=this;if(_WA62.promoMode)return _infoCache[a];if(_infoCache[a]&&(!c||_fullRequested[a])){if(!(_infoCache[a].expiredTime&&_infoCache[a].expiredTime<_WA62.now()))return b&&b(_infoCache[a]),_infoCache[a];delete _infoCache[a].preview,delete _fullRequested[a]}if(!_allowRemoteLoading2)return void _remoteLoadingQueue2.push([a,b,c]);if(!_loadingCache3[a]){_loadingCache3[a]=1;var e=this.resolveLinkAsContact(a);e?e.id?_WA62.rapi.getIdInfo(e.id,function(e,f,g,h){h&&h.chat&&_WA62.chatController.saveChatStamp(h.chat.sn,h.chat.stamp);var i=h&&_makeSnippetInfoFromIdInfo(a,h);d._onGetUrlInfo(a,i,b,c)}):e.sn&&_WA62.contactAbstraction.getUserProfile(e.sn,function(e){var f=e&&_makeSnippetInfoFromProfile(a,e);d._onGetUrlInfo(a,f,b,c)}):ALLOW_SNIPPET_PREVIEW_SERVICE&&_WA62.miscApi.getUrlInfo(a).then(function(e){_U51.Mnt.wrapTryCatch(function(){d._onGetUrlInfo(a,e,b,c)},function(){d._onGetUrlInfo(a,null,b,c)})})}},getPreviewCode:function(a,b,c,d){var e=this._requestSnippetInfo(a,b,!0);return e?this.generateHTML(a,c,d)||"":void 0},getTitle:function(a,b){var c=this._requestSnippetInfo(a,b);return c||(__lastRequestedTitle=a),c&&c.title||""},getContentType:function(a,b){var c=this._requestSnippetInfo(a,b);return c&&c.contentType||""},getPreviewUrl:function(a,b){var c=this._requestSnippetInfo(a,b,!0);return c&&c.preview&&c.preview.preview_url||""},generateContactCardHTMLFromPart:function(a){var b=a.name,c=a.phone,d=a.sn;if(d=_WA62.safeSn(d),_WA62.boardMode)return'<div class="im-message__textblock" style="padding-right: 42px">'+_U51.String.htmlEntity(c||b||d)+"</div>";var e={contentType:"contact",contactSn:d,title:b,contactPhone:c,preview:(d||c)&&{avatar:_WA62.Ava.make(d||c,b,44)}};return this._generateContactCardSafeHTML(e)},_generateContactCardSafeHTML:function(a){if(!a||a.error)return"";var b=a.contactSn||"",c=a.contactId||"",d=a.title||"",e=a.preview&&a.preview.avatar&&a.preview.avatar.html||"",f=_WA62.Emoji.parse(Us.htmlEntity(a.snippet||"")),g=a.contactSn&&_WA62.MainAgent.isChat(a.contactSn),h=!g&&!_WA62.isUIN(b),i=a.contactPhone||"",j=i?Us.formatPhoneNumber(i):_WA62.Emoji.parse(Us.htmlEntity(a.subtitle||""));return c||h||i?_TD21.parseSafe("contactCard",{content_type:a.contentType,data_url:encodeURIComponent(a.reqUrl||""),action_title:_WA62.tr("dialog.clCard."+(g||!b?"view":"message")),title:_WA62.Emoji.parse(Us.htmlEntity(d)),name:d,sn:b,stamp:c,phone:i,subtitle:j,avatar:e,snippetBody:f},{safeKeys:["data_url","title","subtitle","avatar","snippetBody"]}):""},generateHTML:function(a,b,c){var d=_infoCache[a];if(!d||d.error)return"";if(b=b||0,b&Snippet.FLAG_NOT_SINGLE_LINK)return"";var e=_WA62.DialogsAgent.getMediaBlockMaxSize()-24,f=PREVIEW_MIN_WIDTH,g=PREVIEW_MAX_HEIGHT,h=PREVIEW_MIN_HEIGHT,i="image"===d.contentType||"gif"===d.contentType||"video"===d.contentType,j="article"===d.contentType&&a.match(/^https?:\/\/[\w.-]+\/?$/i),k=d.preview&&d.preview.preview_url;if(i?d.title="":"file"===d.contentType&&(d.title=d.title||a),!k&&!d.title)return"";var l=b&Snippet.FLAG_TEXT_MIX;if("contact"===d.contentType)return _WA62.boardMode?"":l?"":this._generateContactCardSafeHTML(d);var m="",n="display:none;",o=e;if(k){l?d.title&&(f=g=e):(d.title||(e+=24),j&&e>DIRECT_ARTICLE_MAX_WIDTH&&(e=DIRECT_ARTICLE_MAX_WIDTH),i||(f=j?DIRECT_ARTICLE_MIN_WIDTH:PREVIEW_ARTICLE_MIN_WIDTH),f>e&&(f=e),i||(h=PREVIEW_ARTICLE_MIN_HEIGHT,g=e));var p,q,r=d.preview.preview_width,s=d.preview.preview_height,t=s/r,u=r,v=s;u>e&&(u=e,v=Math.floor(t*u)),(v>g||h>v)&&(v=v>g?g:h,u=Math.floor(v/t)),f>u&&(u=f,v=Math.floor(t*u)),p=u>e?e:u,q=v>g?g:v,d.contentType.indexOf("video")>-1?m=" im-snippet__play":"gif"===d.contentType&&(m=" im-snippet__gif"),m="im-snippet__image"+m,n="background-image: url("+Us.ensureHttpsUrl(d.preview.preview_url)+");background-size: "+u+"px auto;width:"+p+"px;height:"+q+"px",o=p}else"file"===d.contentType&&(m="im-snippet__file",n="width:"+o+"px");var w="";w+=k?" im-snippet_image":"",w+=d.title?" im-snippet_title":"",w+=d.domain?" im-snippet_domain":"",w+=d.favicon?" im-snippet_favicon":"",w+=b&Snippet.FLAG_TEXT_BEFORE&&!k?" im-snippet_aboveline":"";var x=Us.htmlEntity(d.title||""),y=Us.htmlEntity(d.domain||""),z=c||"";return z&&x&&(y?y+=z:x+=z,z=""),_TD21.parseSafe("snippetBox",{url:_U51.String.encodeHref(d.reqUrl),content_type:d.contentType,data_url:encodeURIComponent(d.reqUrl),preview_cls:m,preview_style:n,title:x||"",domain:y||"",domain_style:d.favicon?"background-image:url("+d.favicon+");":"",wrap_cls:w,wrap_style:"width: "+o+"px;"},{safeKeys:["url","data_url","title","domain"]})+z},generateGalleryItemHTML:function(a,b,c,d){var e=this._requestSnippetInfo(a);(!e||e.error||"error"===e.contentType)&&(e=e||{},e.reqUrl=e.reqUrl||a,e.title=e.title||a,e.domain=e.domain||a);var f=e.preview&&(e.preview.preview_url||e.preview.avatar);"file"===e.contentType&&(e.title=e.title||a);var g="",h="",i="";f?e.preview.preview_url?i="background-image: url("+Us.ensureHttpsUrl(e.preview.preview_url)+");":e.contactSn&&e.title?(i="",h=_WA62.Ava.make(e.contactSn,e.title,38)):(i="",g="im-gallery-snippet__without-preview"):e.favicon?i="background-image: url("+Us.ensureHttpsUrl(e.favicon)+");background-size: contain;background-position: center;":g="im-gallery-snippet__without-preview";var j=b||"";j+=f?" im-gallery-snippet_image":"",j+=e.title?" im-gallery-snippet_title":"",j+=e.domain?" im-gallery-snippet_domain":"";var k=a.match(/^([a-z]+:)?\/\//i)?a:"http://"+a;return _TD21.parseSafe("gallerySnippetBox",{url:_U51.String.encodeHref(k),content_type:e.contentType,data_url:encodeURIComponent(e.reqUrl),preview_cls:g,preview_avatar:h,preview_style:i,title:e.title||"",snippetBody:e.snippet||"",domain:e.domain||e.reqUrl||"",wrap_cls:j,additionalInfo:c,additionalHtml:d},{safeKeys:["url","data_url","preview_avatar","additionalInfo","additionalHtml"]})}};_WA62.snippet=Snippet;var _WA63=WebIM,_U52=_WA63.util,updateEvent=new _U52.Event,STATUS_REFRESH_RATE=1e4,statusUpdater=new _U52.DelayedTask({interval:STATUS_REFRESH_RATE,fn:function(){updateEvent.fire(),statusUpdater.start()}});statusUpdater.start(),_WA63.Statuses={updateEvent:updateEvent};var _WA64=WebIM,_U53=_WA64.util,_TD22=_WA64.TemplateDriver,REMOVED_HTML='<div class="im-sticker-wrap"></div>',REGEX_STICKER_CODE=/^ext:(\d+):sticker:(\d+)/,REGEX_STICKER_ID=/\/([0-9a-zA-Z_\\-]{32,}|[0-9a-zA-Z_\\-]{50,})$/,keepIconsUrl=function(a,b){var c=_WA64.isString(a.list_icons)?a.list_icons:a.list_icons&&a.list_icons.large;a.list_icons=b&&b.list_icons||c;var d=_WA64.isString(a.icons)?a.icons:a.icons&&a.icons.large;a.icons=b&&b.icons||d,a.sticker_picker_icon=b&&b.sticker_picker_icon||_WA64.isString(a.sticker_picker_icon)&&a.sticker_picker_icon};_WA64.Sticker={_showcaseData:null,_contentData:null,_packs:{},_content:{},_requestedPacks:{},_altPackList:null,_removedStickers:{},showcaseDataReadyEvent:new _U53.Event,packDataReadyEvent:new _U53.Event,packInstalledEvent:new _U53.Event,
packChangedEvent:new _U53.Event,loadErrorEvent:new _U53.Event,getShowcaseList:function(){return this._showcaseList},getShowcasePreview:function(a){return this._packs[a]},getPackName:function(a){var b="";return this._packs[a]?b=this._packs[a].name:this._altPackList&&_U53.Array.each(this._altPackList,function(c){return c.id==a?(b=c.title,!1):void 0},this),b},isCustomPack:function(a){var b=null;return b},getAllPackContent:function(){return this._content},getAltPackList:function(){return this._altPackList||[]},getStickerSendUrl:function(a){return a?this.getBaseSendUrl()+a:void 0},getStickerPreviewUrl:function(a,b,c){var d=_U53.String.htmlEntity(a),e=_U53.String.htmlEntity(b);d=""+d;var f=d.match(REGEX_STICKER_CODE);f&&(c=e,d=f[1],e=f[2]),_WA64.isRetina&&(c*=2);var g="small";c>60&&(g="medium"),c>90&&(g="large"),e=""+e;var h;return e.match(/^\d{1,5}$/)?this._content[d]&&this._content[d][e-1]&&(h=this._content[d][e-1]):h=e,h?(g=this._contentData&&this._contentData.preview_sizes&&this._contentData.preview_sizes[g]?this._contentData.preview_sizes[g]:"preview_"+g,this.getBasePreviewUrl()+g+"/"+h):_WA64.urlBuilder.getUrl("storePreview")+"/stickers/"+d+"/"+e+"/preview/"+g},getStickerUrl:function(a,b,c){var d,e;c?(_WA64.isRetina&&(c*=2),d="small",c>60&&(d="medium"),c>90&&(d="large")):(d="medium",_WA64.isRetina&&(d="large")),b=""+b;var f;return b.match(/^\d{1,5}$/)?this._content[a]&&this._content[a][b-1]&&(f=this._content[a][b-1]):f=b,f?(d=this._contentData&&this._contentData.sticker_sizes&&this._contentData.sticker_sizes[d]?this._contentData.sticker_sizes[d]:"sticker_"+d,e=this.getBasePreviewUrl()+d+"/"+f):e=_WA64.urlBuilder.getUrl("storePreview")+"/stickers/"+a+"/"+b+"/"+d,_U53.String.encodeHref(e)},getPackIconUrl:function(a,b){var c=this._packs[a];return c?b&&100>b?c.list_icons:c.icons:void 0},getStickerPickerIconUrl:function(a){var b=this._packs[a];return b?b.sticker_picker_icon||b.list_icons:(b=_U53.Array.findBy(this._altPackList,function(b){return b.id===a}))?b["stiker-picker"]:void 0},getStickerIdFromUrl:function(a){var b=a&&a.match(REGEX_STICKER_ID);return b&&b[1]&&_WA64.fileTools.isStickerFile(b[1])?b[1]:void 0},getStickerCode:function(a,b){return"ext:"+a+":sticker:"+b},getStickerHTML:function(a){var b=a.split(":");return this._removedStickers[a]?REMOVED_HTML:(this._checkStickerIsAvailable(a),_TD22.parseSafe("stickerMessage",[b[1],this.getStickerUrl(b[1],b[3]),a],{safeKeys:["1"]}))},_checkStickerIsAvailable:function(a){var b=a.split(":"),c=this.getStickerUrl(b[1],b[3]);_U53.DomHelper.testUrlAsImage(c,function(b,c){c===!1&&(this._removedStickers[a]=1,this.loadErrorEvent.fire(a,b))},this)},getBasePreviewUrl:function(){return this._basePreviewUrl||_WA64.urlBuilder.getUrl("storePreview")},getBaseSendUrl:function(){return this._baseSendUrl||_WA64.urlBuilder.getUrl("fileParsing")+"/"},_cbQueue:[],resetShowcaseData:function(){this._showcaseRequesting||(this._forceShowcaseRequest=!0)},resetContentData:function(){this._forceContentRequest=!0,this.requestContent()},requestShowcase:function(a,b){if(b=b||this._forceShowcaseRequest||!1,this._showcaseData&&!b)return void(a&&a());if(a&&this._cbQueue.push(a),!this._showcaseRequesting){this._forceShowcaseRequest=!1,this._showcaseRequesting=!0;var c=function(a){for(this._showcaseRequesting=!1,this._showcaseData=a.data,this._showcaseList=this._showcaseData.top||[],this._packs=this._packs||{},_U53.Array.each(this._showcaseList,function(a){keepIconsUrl(a,this._packs[a.id]),this._packs[a.id]=a},this);this._cbQueue.length;){var b=this._cbQueue.shift();b.call()}}.bind(this);_WA64.StoreApi.getShowcase(c)}},requestPackInfo:function(a,b,c,d){if(!d&&this._packs[a]&&this._content&&this._content[a])return void(c&&c(!0));if(!this._requestedPacks[a]){this._requestedPacks[a]=!0;var e={id:a};"storeId"===b?e={store_id:a}:"fileId"===b&&(e={file_id:a}),e.size||(e.size="large"),_WA64.StoreApi.getPackInfo(e,function(b){delete this._requestedPacks[a],b&&b.data&&(b=b.data,keepIconsUrl(b,this._packs[b.id]),this._packs[b.id]=b,this._basePreviewUrl=this._basePreviewUrl||b.template_url_preview,this._baseSendUrl=this._baseSendUrl||b.template_url_send,this._content=this._content||{},this._content[b.id]=b.content.map(function(a){var b=a.fileId;return b})),c&&c(!0,b.id)}.bind(this),function(){delete this._requestedPacks[a],c&&c(!1)}.bind(this))}},requestContent:function(a,b,c){return b&&(this._forceContentRequest=!0),this._contentData&&!this._forceContentRequest?(this.packDataReadyEvent.fire(),void(a&&a())):(this._forceContentRequest=!1,void _WA64.StoreApi.getMyStore(function(b){var c=b&&b.data;if(c){var d=c.packs||[];this._basePreviewUrl=c.template_url_preview,this._baseSendUrl=c.template_url_send,this._altPackList=d,this._contentData=c,this._content={},_U53.Array.each(d,function(a){this._content[a.id]=a.stickers},this)}this.packDataReadyEvent.fire(),a&&a()}.bind(this),function(){this.packDataReadyEvent.fire(),a&&a()}.bind(this),c))},getSuggest:function(a){var b=this;this.requestContent(function(){var c=b._contentData||{};a&&a(c.emoji,c.words)},!0,!0)},isPackInstalled:function(a,b){this.requestShowcase(function(){var c=!1;this._showcaseList&&_U53.Array.each(this._showcaseList,function(b){return b.id===a?(c=b.purchased,!1):void 0},this),b&&b(c)}.bind(this))},requestInstallPack:function(a,b,c){_WA64.StoreApi.installPack(b,function(b){200===b.status&&(this._forceShowcaseRequest=!0,this._forceContentRequest=!0,this.packInstalledEvent.fire(a),this.packChangedEvent.fire(a,!1)),c&&c(b)}.bind(this))},requestRemovePack:function(a,b){_WA64.StoreApi.removePack(a,function(c){200===c.status&&(this._forceShowcaseRequest=!0,this._forceContentRequest=!0,this.packInstalledEvent.fire(a),this.packChangedEvent.fire(a,!1)),b&&b(c)}.bind(this))}};var _WA65=WebIM,_S2=_WA65.Storage,STORAGE_CONNECT_KEY="icqConnect",storagePrefix="",useCookieAsWell=!1,forceInstantStorage=!1;WebIM.boardMode&&(storagePrefix=_WA65.Feature.getModeParameter("prefixAuthData"),forceInstantStorage=!0);var deviceId,Sys={useDefaultStorage:function(){if(_WA65.Feature.getModeParameter("useMainStorageForIdenticalUser"))storagePrefix="";else{var a=Sys.getCredentials(!0);_WA65.Feature.getModeParameter("copyMainSessionData")&&Sys.getSessionData(["socket.date","socket.restoreDate","socket.session"],function(a,b){a&&Sys.saveSessionData(b)},!0),Sys.modifyCredentials(function(b){_WA65.apply(b,a)})}},getUserLogin:function(a){var b=a?"":storagePrefix,c="_AIM_"+b+STORAGE_CONNECT_KEY,d=null;try{d=localStorage[c]||""}catch(e){}return d||(d=(""+document.cookie).match(new RegExp(c+"=([^;]+)")),d=decodeURIComponent((d||[0,""])[1])),(/"aimsid":"[0-9.]+:([0-9]+|[^@:]+@[0-9a-zA-Zа-яА-Я\-.]+)"/.exec(d)||[0,!1])[1]},getCredentials:function(a){var b=null,c=forceInstantStorage?_WA65.InstantStorage:_WA65.Storage,d=a?"":storagePrefix,e=d+STORAGE_CONNECT_KEY;return c.modifyObject([e],function(a){b=a[e]},null,{useCookieAsWell:useCookieAsWell}),b},getAttachedPhone:function(){var a=Sys.getCredentials();return a.phone},modifyCredentials:function(a){var b=forceInstantStorage?_WA65.InstantStorage:_WA65.Storage,c=storagePrefix+STORAGE_CONNECT_KEY;b.modifyObject([c],function(b){a(b[c])},null,{useCookieAsWell:useCookieAsWell})},removeCredentials:function(){var a=forceInstantStorage?_WA65.InstantStorage:_WA65.Storage,b=storagePrefix+STORAGE_CONNECT_KEY;a.remove(b,null,{useCookieAsWell:useCookieAsWell})},checkRestartSessionKey:function(){var a=storagePrefix+"restartSessionKey";_WA65.InstantStorage.load(a,function(b){var c=""+_WA65.configurator.getOption("restart_session_index");if(b!==c){var d={};d[a]=c,_WA65.InstantStorage.save(d,null,{useCookieAsWell:useCookieAsWell}),b&&Sys.saveSessionData({"socket.date":0})}},{useCookieAsWell:!0})},getSessionData:function(a,b,c){var d=forceInstantStorage?_WA65.InstantStorage:_WA65.Storage,e=c?"":storagePrefix,f=a.map(function(a){return e+a});d.load(f,{success:function(c){var d={};f.forEach(function(b,e){d[a[e]]=c[b]}),b(!0,d)},failure:function(a){b(!1,a)}},{useCookieAsWell:useCookieAsWell})},saveSessionData:function(a){var b=forceInstantStorage?_WA65.InstantStorage:_WA65.Storage,c=storagePrefix,d={};Object.keys(a).forEach(function(b){d[c+b]=a[b]}),b.save(d,null,{useCookieAsWell:useCookieAsWell})},removeSessionData:function(a){return new Promise(function(b,c){var d=forceInstantStorage?_WA65.InstantStorage:_WA65.Storage,e=storagePrefix,f=a.map(function(a){return e+a});d.remove(f,{success:b,failure:c},{useCookieAsWell:useCookieAsWell})})},loadContactList:function(a,b){var c={},d="";_WA65.Feature.getModeParameter("useInstantStorageForCL")&&(c.forceInstant=!0,d=b?"":storagePrefix);var e=[d+"clist_list",d+"clist_list_length"],f={};return _WA65.SessionStorage.load(e,{success:function(b){var c=b[d+"clist_list"],e=b[d+"clist_list_length"];f={list:c,length:e},a&&a(c?JSON.parse(c):null,parseInt(e))},failure:function(a){}},c),f},saveContactList:function(a,b,c){var d={},e="";_WA65.Feature.getModeParameter("useInstantStorageForCL")&&(d.forceInstant=!0,e=storagePrefix);var f=JSON.stringify(a),g={};g[e+"clist_list"]=f,g[e+"clist_list_length"]=b,_WA65.SessionStorage.save(g,{success:function(){_WA65.isFunction(c)&&c&&c()}},d)},getDeviceId:function(){return new Promise(function(a){deviceId?a(deviceId):_S2.modify(["icqDeviceId"],function(b){deviceId=b.icqDeviceId,deviceId||(deviceId=[Math.random().toString(16).substring(2,8),Math.random().toString(16).substring(2,14).replace(/(.{4})(?=.)/g,"$1-"),Math.random().toString(16).substring(2,14)].join("-"),b.icqDeviceId=deviceId),a(deviceId)})})},hma:function(a,b){var c=new jsSHA(b,"TEXT");return c.getHMAC(a,"TEXT","SHA-256","B64")},makeSignedUrl:function(a,b){for(var c,d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"GET",e=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,f=Object.keys(b).sort(),g="?",h=[],i=0;i<f.length;i++)c=f[i],h.push(c+"="+encodeURIComponent(b[c]));if(h=h.join("&"),e){var j=d+"&"+encodeURIComponent(a)+"&"+encodeURIComponent(h),k=new jsSHA(j,"TEXT");h=h+"&sig_sha256="+encodeURIComponent(k.getHMAC(e,"TEXT","SHA-256","B64"))}return a.indexOf("?")>0&&(g="&"),a+g+h},fetchResponseHeaders:function(a){var b={};return a.getAllResponseHeaders().trim().split(/[\r\n]+/).forEach(function(a){var c=a.split(": "),d=c.shift().toLowerCase();b[d]=c.join(": ")}),b},fetchUserHost:function(a){var b=(a||"").indexOf("@");return b>0?a.substr(b+1):null},fetchUserConfigHost:function(a){var b=(a||"").indexOf("#");return b>0?a.substr(b+1):null},makeXhr:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise(function(c,d){var e=new XMLHttpRequest,f=a,g=(f.indexOf("?")>-1?"&":"?")+_WA65.urlBuilder.chainParams(b.params);b.params&&(f+=g),e.open(b.method||"GET",f),b.withCredentials&&(e.withCredentials=!0),Object.keys(b.headers||{}).forEach(function(a){e.setRequestHeader(a,b.headers[a])}),e.onload=function(){var a;if(b.fetchHeaders)a=Sys.fetchResponseHeaders(e);else{a=(e.responseText||"").replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029");try{a=JSON.parse(a||"null")}catch(d){console.error(d),a=null}}c({status:e.status,data:a})},e.onerror=function(){return d([e.status])},e.onabort=function(){return d([e.status])},b.progress&&e.upload.addEventListener("progress",b.progress,!1),e.send(b.data||"")})},preRequestSystemConfig:function(a,b){return a?Sys.makeXhr(_WA65.urlBuilder.externalConfigUrl(a,b)).then(function(a){return a&&a.data}):Promise.reject()},getSystemConfig:function(a,b){return new Promise(function(c,d){var e,f=[],g=_WA65.configurator.getOption("external_url_config"),h=g.fixed_host,i=g.last_chance_host,j=!1;if(!i&&g.last_chance_self_host){var k=location.hostname;k.startsWith("webim.")&&(i=k.replace(/^webim/,"u"))}_S2.load("lastConfigHost",function(a){e=a});var l=Sys.fetchUserHost(b||_WA65.ACTIVE_MAIL);h?f.push(h):a?f.push("u."+a,a):i?f.push(i):(e&&f.push(e),l&&f.push("u."+l,l));var m=function n(){f.length&&l?Sys.preRequestSystemConfig(f.shift(),l).then(function(a){j=!0,c(a)},n):d()};m()})},checkSystemConfig:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return new Promise(function(b,c){var d=_WA65.configurator.getOption("external_url_config"),e=a.userLogin||"",f=e.replace(/#.+/,""),g=a.forceHost||Sys.fetchUserConfigHost(e),h=!!f;return!d||_WA65.urlBuilder.isConfigReady()&&!h?b():((g||f)&&_S2.remove("lastConfigHost"),void Sys.getSystemConfig(g,f).then(function(a){a?_WA65.urlBuilder.applyConfig(a)?(g&&_S2.save({lastConfigHost:g}),b()):c({reason:"ERROR_CONFIG_MISSING_FIELD",msg:_WA65.tr("onpremise.errorServerConfigMissingField")}):c({reason:"ERROR_CONFIG_INCORRECT",msg:_WA65.tr("onpremise.errorServerConfigIncorrect")})},function(){c({reason:"ERROR_CONFIG_NOT_FOUND",msg:_WA65.tr("onpremise.errorInputServerHost")})}))})}};_WA65.Sys=Sys;var _WA66=WebIM,_U54=_WA66.util,ChangeLog=function(){function a(){_classCallCheck2(this,a),this.data=[],this.updateEvent=new _U54.Event,_WA66.ConnectionFacade.triggerEvent.on(this._onConnectionTriggerEvent,this)}return _createClass2(a,[{key:"_onConnectionTriggerEvent",value:function(a,b){"contactStatus"===a&&this.data&&this._log(b)}},{key:"_logIndexOf",value:function(a){return _U54.Array.indexOfBy(this.data,function(b){return b.email===a})}},{key:"logAction",value:function(a,b){var c=_WA66.applyIf({action:a},b);_WA66.applyIf(c,{status:{type:null}}),this._log(c)}},{key:"_log",value:function(a){var b=this._logIndexOf(a.email);-1!==b?(this.data[b].nick=_WA66.CLD.getFriendlyName(a.email)||a.nickname,this.data[b].status="",this.data[b].statusTitle=""):(b=this.data.length,this.data.push({email:a.email,status:"",statusTitle:null,nick:a.nickname,action:a.action})),a.tel&&(this.data[b].tel=a.tel),this.data[b].lastseen=a.lastseen,this.data[b].userState=a.userState,void 0!==a.onlineTime&&(this.data[b].onlineTime=a.onlineTime),this.updateEvent.fire(this.data),this.data=[]}}]),a}();_WA66.ChangeLog=new ChangeLog;var _WA67=WebIM,_U55=_WA67.util,_UI38=_WA67.ui,_DomUtil30=_WA67.DomUtil,Pane={boxCloseEvent:new _U55.Event,boxOpenEvent:new _U55.Event,render:function(){var a=this;if(_WA67.splitView){var b=_U55.DomHelper.elementFromHtml('<div id="rightPane"></div>');_DomUtil30.getBody().appendChild(b);var c=function(b){var c=a._paneCurrentBox?_DomUtil30.get("rightPaneBox"):_DomUtil30.get("rightPaneBoxExpanded");return c?(a.tabNavigator?a.tabNavigator.parent.dom&&a.tabNavigator.parent.dom===c.dom||(a.tabNavigator.parent=c,a.tabNavigator.reset()):a.tabNavigator=new _WA67.TabNavigator({parent:c,className:!1,useNative:!0}),a.tabNavigator.switchElement(b.shiftKey),b.preventDefault(),!1):void 0};_WA67.hotKeyManager.addLayer({name:"rightPaneBox",handlers:{tab:c}}),_WA67.hotKeyManager.addLayer({name:"rightPaneBoxExpanded",handlers:{tab:c}}),this.clear()}},clear:function(){return _WA67.splitView?(this.closeBox(!0),this.unloadChat(),void _DomUtil30.get("rightPane").updateHTML(_WA67.TD.getTMPL("rightPaneDefault"))):!1},overlay:function(a){var b;return _WA67.splitView?void(a?(b=_U55.DomHelper.elementFromHtml('<div id="rightPaneOverlay"></div>'),_DomUtil30.get("rightPane").appendChild(b)):(b=_DomUtil30.get("rightPaneOverlay"),b&&b.remove())):!1},loadChat:function(a,b){this.closeBox(!0),this.unloadChat(),this._paneCurrentChat=a;var c=App.getPageByName("dialog");return c.style.display="block",c.className="im-pane "+c.className,_DomUtil30.get("rightPane").appendChild(c),a.onPageLoad(c,b),!0},unloadChat:function(){var a=_DomUtil30.getSelector("#rightPane .im-pane");this._paneCurrentChat&&(this._paneCurrentChat.onPageUnload(a&&a.dom),this._paneCurrentChat=null),a&&a.remove()},hasOpenedBox:function(){return!(!this._paneCurrentBox&&!this._paneCurrentBoxExpanded)},_createBox:function(a){var b=a?"rightPaneBoxExpanded":"rightPaneBox",c=_DomUtil30.get(b);if(!c){a?c=_DomUtil30.get("rightPane").createChild({tag:"div",id:b,cls:"im-pane-box im-pane-box_expanded"}):(c=_DomUtil30.getBody().createChild({tag:"div",id:b,cls:"im-pane-box im-pane-box_modal"}),c.updateHTML('<div class="im-pane-overlay"></div>'),c.first().on("click",function(a){this.closeBox()},this))}return c},openPageBox:function(a,b,c){this.closeBox(c);var d=this._createBox(c),e=a.appPageName;c?(_WA67.InfoPanel.closeAll(),this._paneCurrentBoxExpanded=a,_WA67.hotKeyManager.activateLayer("rightPaneBoxExpanded")):(this._paneCurrentBox=a,_WA67.hotKeyManager.activateLayer("rightPaneBox")),a.__splitView=!0;var f=App.getPageByName(e);return f.style.display="block",d.setStyle("display","flex"),d.appendChild(f),this.boxOpenEvent.fire(c),a.onPageLoad&&a.onPageLoad(f,b),!0},closeBox:function(a){var b,c=!1;this._paneCurrentBox&&(_WA67.hotKeyManager.deactivateLayer("rightPaneBox"),b=this._paneCurrentBox.appPageName,this._paneCurrentBox.onPageUnload&&this._paneCurrentBox.onPageUnload(),delete this._paneCurrentBox.__splitView,this._paneCurrentBox=null,_DomUtil30.get("rightPaneBox").remove(),c=!0),a&&this._paneCurrentBoxExpanded&&(_WA67.hotKeyManager.deactivateLayer("rightPaneBoxExpanded"),b=this._paneCurrentBoxExpanded.appPageName,this._paneCurrentBoxExpanded.onPageUnload&&this._paneCurrentBoxExpanded.onPageUnload(),delete this._paneCurrentBoxExpanded.__splitView,this._paneCurrentBoxExpanded=null,_DomUtil30.get("rightPaneBoxExpanded").remove(),c=!0),c&&this.boxCloseEvent.fire(b)},isCurrentBox:function(a){return!(!_WA67.splitView||!(this._paneCurrentBox&&this._paneCurrentBox.appPageName==a||this._paneCurrentBoxExpanded&&this._paneCurrentBoxExpanded.appPageName==a))},isCurrentPage:function(a){return!(!App.isCurrentPage(a)&&!this.isCurrentBox(a))},back:function(a){var b=!_WA67.splitView||a&&!a.__splitView||!this._paneCurrentBox&&!this._paneCurrentBoxExpanded;b?App.back():this.closeBox(!this._paneCurrentBox)},eoc:null};_WA67.Pane=Pane;var _WA68=WebIM,_U56=_WA68.util,_UI39=_WA68.ui,USE_PAGE_NAVIGATION=!_WA68.splitView&&!0,InfoPanelBoxItem=function(){function a(b){_classCallCheck2(this,a);var c="dialogInfo";this.viewController=new _WA68.DialogsInfo,this.actionEvent=(new _U56.Event).relay(this.viewController.actionEvent),this._infoPaneName=c||_WA68.uniq();var d=null;d?d.style.display="block":d=this.viewController.getElement(),this.node=d,this.data=null}return _createClass2(a,[{key:"updateBoxData",value:function(a){this.data=a,this.viewController.updateDialogInfoData(a)}},{key:"getElement",value:function(){return this.node}},{key:"getName",value:function(){return this._infoPaneName}},{key:"activate",value:function(a){this.viewController.activate(this.node,a),this.active=!0}},{key:"deactivate",value:function(){this.viewController&&this.viewController.deactivate(),delete this.active}},{key:"isActive",value:function(){return!!this.active}},{key:"destroy",value:function(){this.viewController.destroy(),this.viewController=null,this._infoPaneName=null,this.node=null}}]),a}(),InfoPanel={_active:!1,_defaultView:null,_extraView:null,toggleEvent:new _U56.Event,actionEvent:new _U56.Event,_attachView:function(a){this._panelBox||(this._panelBox=new _UI39.InfoPanelBox,this._panelBox.hideEvent.on(this.closeAll,this),this._panelBox.swipeStartEvent.on(this._onSwipeStart,this)),this._panelBox.attachElement(a.getElement())},_showBox:function(a){this._panelBox.show(a),this._active||this.toggleEvent.fire(!0),this._active=!0},_hideBox:function(a){this._panelBox&&(this._panelBox.hide(a),this._panelBox.detachElement(),this._active&&this.toggleEvent.fire(!1)),this._active=!1},isShown:function(){return this._active},_onSwipeStart:function(a){return App.isCurrentPage("dialog")?(!a&&this._defaultView&&this.open({sn:this._defaultViewSn},!0),!0):!1},removeDefault:function(){this.actionEvent.removeAll(),delete this._defaultView},open:function(a,b,c){this._attachView(this._defaultView),this._defaultView.activate(a),b||this._showBox()},openOnce:function(a){return USE_PAGE_NAVIGATION?(this._infoPage||(this._infoPage=new _WA68.DialogsInfo),void App.load("dialogInfo",a)):a.sn&&this._defaultView&&a.sn===this._defaultViewSn?(this._closeExtraView(),void(this._defaultView.isActive()||(this._attachView(this._defaultView),this._defaultView.activate(a),this._showBox()))):(this._closeExtraView(),this._extraView=this._createViewObject(a),this._attachView(this._extraView),this._extraView.updateBoxData(a),this._extraView.activate(a),void this._showBox(this._defaultView&&this._defaultView.isActive()))},toggle:function(a,b,c){var d=this._active;this.closeAll(c),(a===!0||!d&&a!==!1)&&this.open(b,null,c)},_createViewObject:function(a){return new InfoPanelBoxItem(a)},updateData:function(a){this._defaultView||(this._defaultView=this._createViewObject(a),this.actionEvent.relay(this._defaultView.actionEvent)),this._defaultView.updateBoxData(a),this._defaultViewSn=a.sn},_closeExtraView:function(){return this._extraView?(this._extraView.deactivate(),this._extraView.destroy(),this._extraView=null,!0):!1},close:function(){this._closeExtraView()?this._defaultView&&this._defaultView.isActive()?(this._attachView(this._defaultView),this._defaultView.activate(),this._showBox()):this._hideBox(!0):(this._defaultView&&this._defaultView.deactivate(),this._hideBox(!0))},closeAll:function(a){this._closeExtraView(),this._defaultView&&this._defaultView.deactivate(),this._hideBox(a)}};_WA68.InfoPanel=InfoPanel;var _WA69=WebIM,_U57=_WA69.util,_UI40=_WA69.ui,_DomUtil31=_WA69.DomUtil,UUID_CAPS_VIDEO="094613514c7f11d18222444553540000",instance_id="web"+_WA69.uniq(),VOIP_DEBUG=!0,DEBUG_UI_DRY_CALLS=!1,kAllocateTimeout=15e3,kIceGatherCutoffTimeout=500,kRemoteAcceptTimeoutBeforeRinging=35e3,kRemoteAcceptTimeoutAfterRinging=35e3,kLocalAcceptTimeout=72e3,kInitialConnectTimeout=15e3,kReconnectTimeout=2e4,kSendStateUpdateTimeout=100,TerminateReasonToSignalingReason=Object.freeze({TR_HANGUP:"hangup",TR_REJECT:"reject",TR_BUSY:"busy",TR_HANDLED_BY_ANOTHER_INSTANCE:"handled_by_another_instance",TR_ANSWER_TIMEOUT:"answer_timeout",TR_CONNECT_TIMEOUT:"disconnected"}),SignalingReasonToTerminateReason=Object.keys(TerminateReasonToSignalingReason).reduce(function(a,b){return a[TerminateReasonToSignalingReason[b]]=b,a},{}),_log3=function(){VOIP_DEBUG&&console.log.apply(console,arguments)},loge=function(){VOIP_DEBUG&&console.error.apply(console,arguments)};_WA69.Voip&&(_WA69.Voip._onIncomingCallRequest=function(){}),_WA69.Voip&&(_WA69.Voip._onConnectionWebrtcMsg=function(){});var g_silenceTrack=null,getSilenceAudioTrack=function(){if(g_silenceTrack)return g_silenceTrack;var a=window.AudioContext||window.webkitAudioContext||!1;if(a){var b=new a;_log3("getSilenceAudioTrack: ctx",b,a);var c=b.createOscillator(),d=c.connect(b.createMediaStreamDestination());c.start();var e=Object.assign(d.stream.getAudioTracks()[0],{enabled:!1});return g_silenceTrack=e,e}return null},getBlackVideoTrack=function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},b=a.width,c=void 0===b?320:b,d=a.height,e=void 0===d?280:d,f=Object.assign(document.createElement("canvas"),{width:c,height:e}),g=f.getContext("2d");g.fillStyle="blue",g.fillRect(0,0,c,e);var h=f.captureStream();return Object.assign(h.getVideoTracks()[0],{enabled:!1})},MediaSenderState=function(){function a(){_classCallCheck2(this,a),this.sending_audio=!1,this.sending_video=!1}return _createClass2(a,[{key:"ToPackedString",value:function(){return(this.sending_audio?"A":"a")+(this.sending_video?"V":"v")}},{key:"FromPackedString",value:function(a){this.sending_audio=a.indexOf("A")>-1,this.sending_video=a.indexOf("V")>-1}}]),a}(),CallStatePeerStatus=function b(){_classCallCheck2(this,b),this.peer_id="",this.friendly="",this.instance_id="",this.media_status={connected:!1,sender_state:new MediaSenderState},this.room_state="P2P_ONLY",this.hangup_reason="",this.ringing_received=!1},InvitingState=Object.freeze({INIT:0,ALLOCATING:1,CALLING:2,ACCEPTED:3,TERMINATED:4}),CallState=function(){function a(b){_classCallCheck2(this,a),this.call_id=b,this.call_guid="",this.is_outgoing=!1,this.inviting_state=InvitingState.INIT,this.terminate_reason="",this.terminated_locally=!0,this.ice_config="",this.local_media_status={connected:!1,sender_state:new MediaSenderState},this.is_conference=!1,this.room_peer_id="",this.joined_to_room=!1,this.peers=[new CallStatePeerStatus]}return _createClass2(a,[{key:"p2p_peer",value:function(){return this.peers[0]}},{key:"find_peer",value:function(a){var b=!0,c=!1,d=void 0;try{for(var e,f=this.peers[Symbol.iterator]();!(b=(e=f.next()).done);b=!0){var g=e.value;if(g.peer_id==a)return g}}catch(h){c=!0,d=h}finally{try{b||null==f["return"]||f["return"]()}finally{if(c)throw d}}return loge("peer_id not found:"+a),null}}]),a}(),PCSession=function(){function a(b){_classCallCheck2(this,a),this.call_id=b,this.onSdpOfferAnswerReady=new _U57.Event,this.onIceCandidatesReady=new _U57.Event,this.onIceConnectionChanged=new _U57.Event,this.onRemoteStreamAdded=new _U57.Event,this.pc=null,this.streams_config=null,this.local_stream=null,this.rtc_local_stream=new MediaStream,this.audio_tx_enabled=!0,this.video_tx_enabled=!0,this.queued_local_sdp=null,this.queued_local_candidates=[],this.queued_remote_candidates=[],this.ready_to_accept_remote_candidates=!1,this.ice_gather_cutoff_timer=0}return _createClass2(a,[{key:"destroy",value:function(){this.onSdpOfferAnswerReady.removeAll(),this.onIceCandidatesReady.removeAll(),this.onIceConnectionChanged.removeAll(),this.onRemoteStreamAdded.removeAll(),clearTimeout(this.ice_gather_cutoff_timer),this.pc&&this.pc.close&&this.pc.close(),this.pc=null,this.local_stream=null,_WA69.RTCTools.stopStream(this.rtc_local_stream),this.rtc_local_stream=null}},{key:"StartCreateOffer",value:function(a,b){return this.pc?void loge("unexpected"):(this.steams_config=b,this._initPeerConnection(a),void this._createRemoteSdp("offer"))}},{key:"RemoteSdpReceived",value:function(a,b,c){"offer"==b?(this._initPeerConnection(a),this._setRemoteSdp(b,c)):"answer"==b&&this._setRemoteSdp(b,c)}},{key:"RemoteCandidatesReceived",value:function(a){var b=this;this.pc&&this.ready_to_accept_remote_candidates?a.forEach(function(a){var c=_WA69.RTCTools.createIceCandidate(a);_log3("c: "+JSON.stringify(c)),b.pc.addIceCandidate(c)}):this.queued_remote_candidates.push.apply(this.queued_remote_candidates,a)}},{key:"_replaceOrAddTrack",value:function(a,b){var c=a.getSenders().find(function(a){return a.track&&a.track.kind==b.kind});c?(_log3("Replacing "+b.kind+"track for sender:",c,b),c.replaceTrack(b)):(_log3("Adding "+b.kind+"track"),this.pc.addTrack(b,this.rtc_local_stream))}},{key:"AttachLocalStream",value:function(a){this.local_stream=a,this.SetAudioTxEnabled(this.audio_tx_enabled),this.SetVideoTxEnabled(this.video_tx_enabled)}},{key:"SetAudioTxEnabled",value:function(a){this.pc&&this._replaceOrAddTrack(this.pc,a&&this.local_stream&&this.local_stream.getAudioTracks().length>0?this.local_stream.getAudioTracks()[0]:getSilenceAudioTrack()),this.audio_tx_enabled=a}},{key:"SetVideoTxEnabled",value:function(a){this.pc&&this._replaceOrAddTrack(this.pc,a&&this.local_stream&&this.local_stream.getVideoTracks().length>0?this.local_stream.getVideoTracks()[0]:getBlackVideoTrack()),this.video_tx_enabled=a}},{key:"_initPeerConnection",value:function(a){var b={iceServers:this._preprocessIceConfig(a),bundlePolicy:"max-bundle"};this.pc=new RTCPeerConnection(b),this.pc.onicecandidate=this._PC_onIceCandidate.bind(this),this.pc.oniceconnectionstatechange=this._PC_onIceStateChange.bind(this),this.pc.ontrack=this._PC_onRemoteTrack.bind(this),this.pc.onicegatheringstatechange=this._PC_onIceGatheringStateChange.bind(this),this.pc.onsignalingstatechange=this._PC_onSignalingStateChange.bind(this),this.pc.onnegotiationneeded=function(a){_log3("PC:onnegotiationneeded")},this.AttachLocalStream(this.local_stream)}},{key:"_preprocessIceConfig",value:function(a){var b=JSON.parse(JSON.stringify(a))||[];return _log3("Incoming ice config:",JSON.stringify(b)),b.hasOwnProperty("ice_servers")&&(b=b.ice_servers),Array.isArray(b)&&(b.forEach(function(a){Array.isArray(a.urls)&&a.urls.length>1&&(a.urls=[a.urls[0]])}),b=b.filter(function(a){var b=Array.isArray(a.urls)&&a.urls.length>0&&a.urls[0].indexOf("?transport=tcp")>0;return!b})),_log3("Result ice config:",JSON.stringify(b)),b||[]}},{key:"_createRemoteSdp",value:function(a){var b=this,c="offer"==a?_WA69.RTCTools.createOffer(this.pc):_WA69.RTCTools.createAnswer(this.pc);c.then(function(c){_log3("_createRemoteSdp: "+a+" created successfully:",c.sdp),c.type=a,c=_WA69.RTCTools.createRTCSessionDescription(c),b.queued_local_sdp=c,b.pc.setLocalDescription(c),b.ice_gather_cutoff_timer=_WA69.setTimeout(b._onIceGatherCutoffTimeout,kIceGatherCutoffTimeout,b)},function(a){loge("Сореньки, _createRemoteSdp failed:",a)})}},{key:"_setRemoteSdp",value:function(a,b){var c=this;this.ready_to_accept_remote_candidates=!1;var d={sdp:b,type:a};d=_WA69.RTCTools.createRTCSessionDescription(d),this.pc.setRemoteDescription(d).then(function(){_log3("_setRemoteSdp: "+a+" set successfully",d),"offer"==a&&c._createRemoteSdp("answer")},function(a){loge("Сореньки, setRemoteDescription failed:",a)})}},{key:"_onIceGatherCutoffTimeout",value:function(){clearTimeout(this.ice_gather_cutoff_timer),this.queued_local_sdp?this.onSdpOfferAnswerReady.fire(this,this.queued_local_sdp,this.queued_local_candidates):this.queued_local_candidates.length&&this.onIceCandidatesReady.fire(this,this.queued_local_candidates),this.queued_local_sdp=null,this.queued_local_candidates=[]}},{key:"_PC_onIceCandidate",value:function(a){if(_log3("_PC_onIceCandidate",a),this.pc){if(!a.candidate)return clearTimeout(this.ice_gather_cutoff_timer),void this._onIceGatherCutoffTimeout();0==this.queued_local_candidates.length&&(clearTimeout(this.ice_gather_cutoff_timer),this.ice_gather_cutoff_timer=_WA69.setTimeout(this._onIceGatherCutoffTimeout,kIceGatherCutoffTimeout,this));var b=""+a.candidate.sdpMLineIndex+" "+a.candidate.candidate;this.queued_local_candidates.push(b)}}},{key:"_PC_onIceGatheringStateChange",value:function(a){_log3("_PC_onIceGatheringStateChange")}},{key:"_PC_onSignalingStateChange",value:function(a){this.pc&&(this.ready_to_accept_remote_candidates="stable"==this.pc.signalingState,this.ready_to_accept_remote_candidates&&this.queued_remote_candidates.length>0&&(this.RemoteCandidatesReceived(this.queued_remote_candidates),this.queued_remote_candidates=[]))}},{key:"_PC_onIceStateChange",value:function(a){if(this.pc){_log3("_PC_onIceStateChange: "+this.pc.iceConnectionState,a);var b="connected"==this.pc.iceConnectionState||"completed"==this.pc.iceConnectionState;this.onIceConnectionChanged.fire(this,b)}}},{key:"_PC_onRemoteTrack",value:function(a){this.pc&&(_log3("_PC_onRemoteTrack",a),_log3("Remote stream:",a.streams),_log3("Remote tracks:",a.streams[0].getTracks()),this.fired||(this.fired=!0,a.streams[0].getTracks().forEach(function(a){a.onended=function(b){loge(""+a.kind+": onended()",b)},a.onunmute=function(b){loge(""+a.kind+": onunmute() muted:"+a.muted,b)},a.onmute=function(b){loge(""+a.kind+": onmute(): muted:"+a.muted,b)}}),this.onRemoteStreamAdded.fire(this,a.streams[0])))}}]),a}(),P2PCallSession=function(a){function b(a){var c;return _classCallCheck2(this,b),_log3("P2PCallSession::P2PCallSession:"),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),c.onAllocateRequested=new _U57.Event,c.onSendSignalingMsg=new _U57.Event,c.onStateUpdated=new _U57.Event,c.onRemoteMediaStreamUpdated=new _U57.Event,c.onIncomingCall=new _U57.Event,c.state=new CallState,c.state.call_id=a,c.state.local_media_status.sender_state.sending_audio=!0,c.state.local_media_status.sender_state.sending_video=!1,c.local_app_data="",c.ready_answer_sdp=null,c.ready_local_candidates=[],c.queued_invite_msg=null,c.accept_timeout_timer=0,c.connect_timeout_timer=0,c.send_state_update_timer=0,c.pc_session=new PCSession(c.call_id),c.pc_session.onSdpOfferAnswerReady.on(c._PCSession_onSdpOfferAnswerReady,_assertThisInitialized2(_assertThisInitialized2(c))),c.pc_session.onIceCandidatesReady.on(c._PCSession_onIceCandidatesReady,_assertThisInitialized2(_assertThisInitialized2(c))),c.pc_session.onIceConnectionChanged.on(c._PCSession_onIceConnectionChanged,_assertThisInitialized2(_assertThisInitialized2(c))),c.pc_session.onRemoteStreamAdded.on(function(a,b){
c.onRemoteMediaStreamUpdated.fire(c.state.call_id,c.state.p2p_peer().peer_id,b)}),c}return _inherits2(b,a),_createClass2(b,[{key:"destroy",value:function(){_log3("P2PCallSession::~P2PCallSession:"),this.onAllocateRequested.removeAll(),this.onSendSignalingMsg.removeAll(),this.onStateUpdated.removeAll(),this.onRemoteMediaStreamUpdated.removeAll(),this.onIncomingCall.removeAll(),clearTimeout(this.accept_timeout_timer),clearTimeout(this.connect_timeout_timer),clearTimeout(this.send_state_update_timer),this.pc_session&&(this.pc_session.destroy(),this.pc_session=null),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}},{key:"StartOutgoing",value:function(a,b,c){this.state.is_outgoing=!0,this.state.p2p_peer().peer_id=a[0].sn,this.state.p2p_peer().friendly=a[0].friendly,this.local_app_data=c,this._doAllocateOutgoingCall()}},{key:"StartIncoming",value:function(a){this.state.is_outgoing=!1,this.state.call_guid=a.guidSession,this.state.p2p_peer().peer_id=a.source.aimId,this.state.p2p_peer().friendly=a.source.friendly,this.SignalingMessageReceived(a)}},{key:"Accept",value:function(){this.state.inviting_state!=InvitingState.TERMINATED&&(this.state.inviting_state!=InvitingState.CALLING||this.state.is_outgoing||(clearTimeout(this.accept_timeout_timer),this._setInvitingState(InvitingState.ACCEPTED),this.pc_session.RemoteSdpReceived(this.state.ice_config,this.queued_invite_msg.sdp_type,this.queued_invite_msg.sdp),this.pc_session.RemoteCandidatesReceived(this.queued_invite_msg.candidates||[]),this._startActiveCall()))}},{key:"Terminate",value:function(a,b){return this.state.inviting_state==InvitingState.TERMINATED?void loge("already terminated"):((a&&this.state.inviting_state>=InvitingState.CALLING||this.state.is_outgoing&&this.state.inviting_state==InvitingState.CALLING&&"TR_ANSWER_TIMEOUT"==b)&&this._sendBye(b),this.state.inviting_state=InvitingState.TERMINATED,this.state.terminated_locally=a,this.state.terminate_reason=b,this.pc_session&&(this.pc_session.destroy(),this.pc_session=null),void this.onStateUpdated.fire(this.state))}},{key:"CallAllocated",value:function(a){this.state.inviting_state==InvitingState.ALLOCATING&&(this.state.call_guid=a.guid,this.state.ice_config=a.ice_config,this._setInvitingState(InvitingState.INIT),this._doStartOutgoingCall())}},{key:"AttachLocalStream",value:function(a){this.pc_session&&this.pc_session.AttachLocalStream(a)}},{key:"SignalingMessageReceived",value:function(a){var b=a.source.aimId,c=a.signalling_json?JSON.parse(a.signalling_json):{};if(Array.isArray(c))return void loge("TODO");if(this.state.inviting_state!=InvitingState.INIT&&b!=this.state.p2p_peer().peer_id)return void loge("Message received from invalid peer",a);switch(a.subtype){case"INVITE":this._onInviteReceived(c);break;case"RINGING":this._onRingingReceived(c);break;case"ACCEPT":this._onAcceptReceived(c);break;case"SIGNALLING_DATA":var d=c.subtype;switch(d){case"SDPUPDATE":this._onSdpUpdateReceived(c);break;case"STATE":this._onStateUpdateReceived(c);break;default:loge("Invalid subtype!",a)}break;case"BUSY":c||(c={reason:"busy"});case"HANDLED_BY_ANOTHER_INSTANCE":c||(c={reason:"handled_by_another_instance"});case"DECLINE":this._onDeclineReceived(c);break;default:return void loge("Invalid message:",a)}}},{key:"EnableAudioTx",value:function(a){this.state.inviting_state!=InvitingState.TERMINATED&&(a!=this.state.local_media_status.sender_state.sending_audio&&(this.state.local_media_status.sender_state.sending_audio=a,this._scheduleSendStateUpdate(),this.onStateUpdated.fire(this.state)),this._updateRTCMediaSending())}},{key:"EnableVideoTx",value:function(a){this.state.inviting_state!=InvitingState.TERMINATED&&(a!=this.state.local_media_status.sender_state.sending_video&&(this.state.local_media_status.sender_state.sending_video=a,this._scheduleSendStateUpdate(),this.onStateUpdated.fire(this.state)),this._updateRTCMediaSending())}},{key:"_setInvitingState",value:function(a){this.inviting_state!=a&&(_log3("new state:"+Object.keys(InvitingState).find(function(b){return InvitingState[b]===a})),this.state.inviting_state=a,this._updateRTCMediaSending(),this._notifyCallParticipantsState())}},{key:"_doAllocateOutgoingCall",value:function(){var a=this;DEBUG_UI_DRY_CALLS||(this._setInvitingState(InvitingState.ALLOCATING),this.onAllocateRequested.fire(this.state),this.onStateUpdated.fire(this.state),setTimeout(function(){a.state.inviting_state==InvitingState.ALLOCATING&&a.Terminate(!0,"TR_ALLOCATE_FAILED")},kAllocateTimeout))}},{key:"_doStartOutgoingCall",value:function(){this.pc_session.StartCreateOffer(this.state.ice_config,null)}},{key:"_startActiveCall",value:function(){this.state.inviting_state!=InvitingState.TERMINATED&&(this.onStateUpdated.fire(this.state),this.state.local_media_status.connected||(this.connect_timeout_timer=_WA69.setTimeout(this._onConnectTimeout,kInitialConnectTimeout,this)))}},{key:"_onInviteReceived",value:function(a){if(this.state.inviting_state!=InvitingState.INIT)return void loge("duplicated INVITE received");loge("msg:",a),this.state.ice_config=JSON.parse(a.ice_config)||"",this.state.p2p_peer().instance_id=a.instance||"",this.state.p2p_peer().media_status.sender_state.FromPackedString(a.mss||"Av"),this.state.inviting_state=InvitingState.CALLING;var b=this.state.p2p_peer().media_status.sender_state.sending_video;return this.onIncomingCall.fire(this.state,this.state.p2p_peer().instance_id,b,""),this.onStateUpdated.fire(this.state),this.accept_timeout_timer=_WA69.setTimeout(this._onAcceptTimeout,kLocalAcceptTimeout,this),a.sdp?(this.queued_invite_msg=a,void this._sendRinging()):void loge("no sdp")}},{key:"_onRingingReceived",value:function(a){this.state.is_outgoing&&this.state.inviting_state==InvitingState.CALLING&&!this.state.p2p_peer().ringing_received&&(_log3("Ringing received"),this.state.p2p_peer().ringing_received=!0,clearTimeout(this.accept_timeout_timer),this.accept_timeout_timer=_WA69.setTimeout(this._onAcceptTimeout,kRemoteAcceptTimeoutAfterRinging,this),this.onStateUpdated.fire(this.state))}},{key:"_onAcceptReceived",value:function(a){return a&&this.state.is_outgoing&&this.state.inviting_state!=InvitingState.TERMINATED?a.sdp?void(this.state.inviting_state==InvitingState.CALLING&&(this.state.p2p_peer().instance_id=a.instance,this.pc_session.RemoteSdpReceived(null,a.sdp_type,a.sdp),this.pc_session.RemoteCandidatesReceived(a.candidates?a.candidates:[]),clearTimeout(this.accept_timeout_timer),this.state.p2p_peer().media_status.sender_state.FromPackedString(a.mss?a.mss:"Av"),this._setInvitingState(InvitingState.ACCEPTED),this._startActiveCall())):void loge("no sdp"):void 0}},{key:"_onDeclineReceived",value:function(a){if(this.state.inviting_state!=InvitingState.TERMINATED){if(this.state.inviting_state==InvitingState.ACCEPTED&&a.instance&&this.state.p2p_peer().instance_id&&a.instance!=this.state.p2p_peer().instance_id)return void loge("Ignoring DECLINE received from invalid instance. Our peer:"+this.state.p2p_peer().instance_id+" received from:"+a.instance);var b=a.reason&&a.reason in SignalingReasonToTerminateReason?SignalingReasonToTerminateReason[a.reason]:"TR_HANGUP";this.state.is_outgoing&&this.state.inviting_state!=InvitingState.ACCEPTED&&"TR_HANGUP"==b&&(b="TR_REJECT");var c=!1;this.Terminate(c,b)}}},{key:"_onSdpUpdateReceived",value:function(a){return this.state.inviting_state!=InvitingState.TERMINATED?a.instance&&this.state.p2p_peer().instance_id&&a.instance!=this.state.p2p_peer().instance_id?void loge("Ignoring SdpUpdate from unknown instance. Our peer:"+this.state.p2p_peer().instance_id+" received from:"+a.instance):void(Array.isArray(a.candidates)&&this.pc_session.RemoteCandidatesReceived(a.candidates)):void 0}},{key:"_onStateUpdateReceived",value:function(a){return this.state.inviting_state!=InvitingState.TERMINATED?a.instance&&this.state.p2p_peer().instance_id&&a.instance!=this.state.p2p_peer().instance_id?void loge("Ignoring StateUpdate from unknown instance. Our peer:"+this.state.p2p_peer().instance_id+" received from:"+a.instance):void(a.mss&&(this.state.p2p_peer().media_status.sender_state.FromPackedString(a.mss),this._notifyCallParticipantsState())):void 0}},{key:"_notifyCallParticipantsState",value:function(){this.state.inviting_state!=InvitingState.TERMINATED&&this.onStateUpdated.fire(this.state)}},{key:"_updateRTCMediaSending",value:function(){var a=this.state.inviting_state==InvitingState.ACCEPTED,b=a&&this.state.local_media_status.sender_state.sending_audio&&this.state.local_media_status.connected,c=a&&this.state.local_media_status.sender_state.sending_video&&this.state.local_media_status.connected;this.pc_session&&(this.pc_session.SetAudioTxEnabled(b),this.pc_session.SetVideoTxEnabled(c))}},{key:"_PCSession_onSdpOfferAnswerReady",value:function(a,b,c){_log3("_PCSession_onSdpOfferAnswerReady"),this.state.inviting_state!=InvitingState.TERMINATED&&(this.state.is_outgoing?this._sendInvite(b,c):this.state.inviting_state==InvitingState.CALLING?(this.ready_answer_sdp=b,this.ready_candidates=c):this.state.inviting_state==InvitingState.ACCEPTED&&this._sendAccept(b,c))}},{key:"_PCSession_onIceCandidatesReady",value:function(a,b){_log3("_PCSession_onIceCandidatesReady"),this.state.inviting_state!=InvitingState.TERMINATED&&(this.state.is_outgoing||this.state.inviting_state==InvitingState.ACCEPTED?this._sendIceCandidates(b):this.state.inviting_state==InvitingState.CALLING?this.ready_local_candidates.push.apply(this.ready_local_candidates,b):loge("should not be here"))}},{key:"_PCSession_onIceConnectionChanged",value:function(a,b){if(_log3("_PCSession_onIceConnectionChanged: is_connected="+b),this.state.inviting_state!=InvitingState.TERMINATED){if(this.state.inviting_state==InvitingState.ACCEPTED){var c=this.state.local_media_status.connected;!c&&b?clearTimeout(this.connect_timeout_timer):c&&!b&&(this.connect_timeout_timer=_WA69.setTimeout(this._onConnectTimeout,kReconnectTimeout,this))}this.state.local_media_status.connected=b,this.state.p2p_peer().media_status.connected=b,this._updateRTCMediaSending(),this._notifyCallParticipantsState()}}},{key:"_sendInvite",value:function(a,b){this.onSendSignalingMsg.fire(this.state,this.state.p2p_peer().peer_id,"INVITE",{ice_config:JSON.stringify(this.state.ice_config),sdp:a.sdp,sdp_type:a.type,candidates:b,mss:this.state.local_media_status.sender_state.ToPackedString()}),this._setInvitingState(InvitingState.CALLING),this.accept_timeout_timer=_WA69.setTimeout(this._onAcceptTimeout,kRemoteAcceptTimeoutBeforeRinging,this)}},{key:"_sendAccept",value:function(a,b){this.onSendSignalingMsg.fire(this.state,this.state.p2p_peer().peer_id,"ACCEPT",{sdp:a.sdp,sdp_type:a.type,candidates:b,mss:this.state.local_media_status.sender_state.ToPackedString()})}},{key:"_sendRinging",value:function(){this.onSendSignalingMsg.fire(this.state,this.state.p2p_peer().peer_id,"RINGING",{})}},{key:"_sendBye",value:function(a){var b="TR_BUSY"==a?"BUSY":"DECLINE",c=a in TerminateReasonToSignalingReason?TerminateReasonToSignalingReason[a]:a;this.onSendSignalingMsg.fire(this.state,this.state.p2p_peer().peer_id,b,{reason:c})}},{key:"_scheduleSendStateUpdate",value:function(){var a=this;clearTimeout(this.send_state_update_timer),this.send_state_update_timer=_WA69.setTimeout(function(){(a.state.inviting_state==InvitingState.ACCEPTED||a.state.is_outgoing&&a.state.inviting_state==InvitingState.CALLING)&&a.onSendSignalingMsg.fire(a.state,a.state.p2p_peer().peer_id,"SIGNALLING_DATA",{subtype:"STATE",mss:a.state.local_media_status.sender_state.ToPackedString()})},kSendStateUpdateTimeout)}},{key:"_onAcceptTimeout",value:function(){loge("_onAcceptTimeout"),this.Terminate(!0,"TR_ANSWER_TIMEOUT")}},{key:"_onConnectTimeout",value:function(){loge("_onConnectTimeout"),this.Terminate(!0,"TR_CONNECT_TIMEOUT")}}]),b}(_WA69.conn.ES6ConnectionRoster),VoipController=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.VOIP_DEBUG=VOIP_DEBUG,a.next_call_id=1,a.call_sessions={},a.current_call_id=-1,a.current_callView=null,a.local_stream=null,window.onbeforeunload=a._onWindowBeforeUnload.bind(_assertThisInitialized2(_assertThisInitialized2(a))),_DomUtil31.fly(window).on("unload",a._onWindowUnload,_assertThisInitialized2(_assertThisInitialized2(a))),a}return _inherits2(b,a),_createClass2(b,[{key:"startOutgoinCall",value:function(a,b,c){var d=this;return _log3("startOutgoinCall() sn:"+a+" friendly:"+b," is_video:"+c),this.current_call_id>0?void alert("TODO: Уже есть активный звонок"):void this._maybeRequestUserMedia(c,!0,function(){var e=d._createNewCallId();d.current_call_id=e,d._Call_StartOutgoing(e,c,[{sn:a,friendly:b}],""),d.current_callView=new _UI40.VoipCallBox,d.current_callView.actionEvent.on(d.onUIAction,d),d.current_callView.addUser(_WA69.ACTIVE_MAIL,{friendly:_WA69.DialogsAbstraction.nick}),d.current_callView.addUser(a,{friendly:b}),d.current_callView.show(),d.current_callView.addStream(_WA69.ACTIVE_MAIL,d.local_stream)},function(a){alert("Не могу позвонить, нет доступа к камере/микрофону: "+a)})}},{key:"onUIAction",value:function(a,b){switch(a){case"hangup":this.current_call_id in this.call_sessions&&this.call_sessions[this.current_call_id].Terminate(!0,"TR_HANGUP");break;case"muteMic":loge("muteMic:"+b),b?this._maybeRequestUserMedia(_WA69.RTCTools.mediaStreamHaveVideoTrack(this.local_stream),!0,function(){},function(){}):this.local_stream&&(this.local_stream.getAudioTracks().forEach(function(a){return a.stop()}),this._onLocalStreamChanged());break;case"toggleVideo":loge("toggleVideo:"+b),b?this.local_stream&&(this.local_stream.getVideoTracks().forEach(function(a){return a.stop()}),this._onLocalStreamChanged()):this._maybeRequestUserMedia(!0,_WA69.RTCTools.mediaStreamHaveAudioTrack(this.local_stream),function(){},function(){});break;case"addUser":}}},{key:"_maybeRequestUserMedia",value:function(a,b,c,d){var e=this,f=_WA69.AccountSettings.getOption(_WA69.AccountSettings.STRING_MEDIA),g=f?f.split(";"):[],h={audioInput:g[0],videoInput:g[2]};_WA69.RTCTools.accessMedia(a,b,h).then(function(a){e.local_stream&&e.local_stream.getTracks().forEach(function(a){return a.stop()}),e.local_stream=a,e._onLocalStreamChanged(),c()},function(a){d(a)})}},{key:"_haveAudioLocalTrack",value:function(){return this.local_stream&&this.local_stream.getAudioTracks().length>0&&"live"==this.local_stream.getAudioTracks()[0].readyState}},{key:"_haveVideoLocalTrack",value:function(){return this.local_stream&&this.local_stream.getVideoTracks().length>0&&"live"==this.local_stream.getVideoTracks()[0].readyState}},{key:"_onLocalStreamChanged",value:function(){var a=this;loge("_onLocalStreamChanged: ",this.local_stream?this.local_stream.getAudioTracks():[],this.local_stream?this.local_stream.getVideoTracks():[]);var b=_WA69.RTCTools.mediaStreamHaveAudioTrack(this.local_stream),c=_WA69.RTCTools.mediaStreamHaveVideoTrack(this.local_stream);for(var d in this.call_sessions)this.call_sessions.hasOwnProperty(d)&&this.call_sessions[d].state.inviting_state!=InvitingState.TERMINATED&&(this.call_sessions[d].EnableAudioTx(b),this.call_sessions[d].EnableVideoTx(c),this.call_sessions[d].AttachLocalStream(this.local_stream));this.local_stream&&(this.local_stream.getAudioTracks().forEach(function(b){b.onended=function(c){_log3("onended(): "+b.kind,c),a._onLocalStreamChanged()}}),this.local_stream.getVideoTracks().forEach(function(b){b.onended=function(c){_log3("onended(): "+b.kind,c),a._onLocalStreamChanged()}})),this.current_callView&&this.current_callView.addStream(_WA69.ACTIVE_MAIL,this.local_stream)}},{key:"_createNewCallId",value:function(){return this.next_call_id++}},{key:"_Call_StartOutgoing",value:function(a,b,c,d){var e=this._createCallSession(a);this._onLocalStreamChanged(),e.StartOutgoing(c,b,d)}},{key:"_createCallSession",value:function(a){var b=new P2PCallSession(a,this);return b.onAllocateRequested.on(this._CallSession_onAllocateRequested,this),b.onSendSignalingMsg.on(this._CallSession_onSendSignalingMsg,this),b.onStateUpdated.on(this._CallSession_onStateUpdated,this),b.onRemoteMediaStreamUpdated.on(this._CallSession_onRemoteMediaStreamUpdated,this),b.onIncomingCall.on(this._CallSession_onIncomingCall,this),this.call_sessions[a]=b,b}},{key:"_CallSession_onAllocateRequested",value:function(a){_log3("_CallSession_onAllocateRequested",a),_WA69.wimApi.webrtcAlloc(this.sn,function(b,c){_log3("_CallSession_onAllocateRequested (allocated):",b,c,a)})}},{key:"_CallSession_onSendSignalingMsg",value:function(a,b,c,d){null==d&&(d={});var e=Array.isArray(d)&&d.length>0?d[0]:d;e.instance=instance_id,("INVITE"==c||"ACCEPT"==c)&&(e.useragent={voip_ver:"webicq version:"+window.VERSION_JS});var f={subtype:c,version:1,guidSession:a.call_guid,uuidCapability:UUID_CAPS_VIDEO,t:b,signalling_json:JSON.stringify(d)};_WA69.wimApi.webrtcMsg(f,function(a){})}},{key:"_CallSession_onStateUpdated",value:function(a){if(_log3("_CallSession_onStateUpdated:",a),a.call_id===this.current_call_id){this.current_callView&&this.current_callView.onCallStateUpdated&&this.current_callView.onCallStateUpdated(a);var b=null,c=this._prevState||{},d=a.p2p_peer().ringing_received;a.is_outgoing&&(a.inviting_state===InvitingState.INIT||a.inviting_state===InvitingState.ALLOCATING||a.inviting_state===InvitingState.CALLING&&!d)&&(b="call_start"),a.is_outgoing&&a.inviting_state===InvitingState.CALLING&&d&&(b="call_dial"),a.is_outgoing&&a.inviting_state===InvitingState.ACCEPTED&&c.inviting_state!==InvitingState.ACCEPTED&&(b="call_connected"),a.is_outgoing||a.inviting_state!==InvitingState.CALLING||(b="call_incoming"),a.inviting_state===InvitingState.TERMINATED&&c.inviting_state!==InvitingState.TERMINATED&&("TR_HANDLED_BY_ANOTHER_INSTANCE"===a.terminate_reason||("TR_BUSY"===a.terminate_reason?a.is_outgoing&&(b="call_busy"):b="call_end")),b?_WA69.ring(b):_WA69.stopRing("call"),this._prevState=JSON.parse(JSON.stringify(a))}a.inviting_state==InvitingState.TERMINATED&&this._OnCallTerminated(a.call_id,a.terminated_locally,a.terminate_reason)}},{key:"_CallSession_onRemoteMediaStreamUpdated",value:function(a,b,c){a==this.current_call_id&&this.current_callView&&this.current_callView.addStream(b,c)}},{key:"_OnCallTerminated",value:function(a,b,c){_log3("_OnCallTerminated: id:"+a+" local:"+b+" reason:"+c),this.current_call_id==a&&(this.current_callView.freeze(),this.current_callView.delayedHide(),this.current_callView=null,this.current_call_id=-1,this._prevState={},_WA69.RTCTools.stopStream(this.local_stream),this.local_stream=null),a in this.call_sessions&&(this.call_sessions[a].destroy(),delete this.call_sessions[a])}},{key:"_CallSession_onIncomingCall",value:function(a,b,c,d){var e=this,f=this.call_sessions[a.call_id];if(this.current_call_id>0)return void f.Terminate(!0,"TR_BUSY");var g=a.p2p_peer();this.current_call_id=a.call_id,this.current_callView=new _UI40.IncomingCallBox({sn:g.peer_id,friendly:g.friendly}),this.current_callView.freeze=function(){},this.current_callView.delayedHide=this.current_callView.hide,this.current_callView.show();var h=_WA69.Ava.make(g.peer_id,g.friendly,80);_WA69.MessageNotifier.show(g.peer_id,{icon:h.url,title:g.friendly,type:"call"},_WA69.uniq()),this.current_callView.actionEvent.on(function(b){"answerAudio"===b||"answerVideo"===b?(e.current_callView.hide(),e.current_callView=null,e._maybeRequestUserMedia("answerVideo"===b,!0,function(){},function(){}),e.current_callView=new _UI40.VoipCallBox,e.current_callView.actionEvent.on(e.onUIAction,e),e.current_callView.addUser(_WA69.ACTIVE_MAIL,{friendly:_WA69.DialogsAbstraction.nick}),e.current_callView.addUser(g.peer_id,{friendly:g.friendly}),e.current_callView.show(),e.current_callView.addStream(_WA69.ACTIVE_MAIL,e.local_stream),e.current_callView.onCallStateUpdated(a),f.Accept()):f.Terminate(!0,"TR_REJECT")})}},{key:"_onNewInviteReceived",value:function(a){var b=this._createNewCallId(),c=this._createCallSession(b);this._onLocalStreamChanged(),c.StartIncoming(a)}},{key:"_onConnectionWebrtcAlloc",value:function(a){if(_log3("_onConnectionWebrtcAlloc:",a),this.current_call_id>0&&this.current_call_id in this.call_sessions){var b={};b.guid=a.guid,b.ice_config=_WA69.RTCTools.createIceConfig(a.guid,a.stun_addresses,a.relay_udp_addresses,a.relay_tcp_addresses),this.call_sessions[this.current_call_id].CallAllocated(b)}}},{key:"_onConnectionWebrtcMsg",value:function(a){var b=a.guidSession;_log3("_onConnectionWebrtcMsg:"+a.subtype,a);for(var c in this.call_sessions)if(this.call_sessions.hasOwnProperty(c)&&this.call_sessions[c].state.call_guid==b)return void this.call_sessions[c].SignalingMessageReceived(a);"INVITE"==a.subtype&&(_log3("NEW INVITE!"),this._onNewInviteReceived(a))}},{key:"_onWindowBeforeUnload",value:function(a){if(this.current_call_id>0){var b=_WA69.tr("calls.youAreCalling");return a&&(a.returnValue=b),b}}},{key:"_onWindowUnload",value:function(){this.current_call_id>0&&this.current_call_id in this.call_sessions&&this._prevState&&(this._prevState.inviting_state===InvitingState.ACCEPTED||this._prevState.is_outgoing&&this._prevState.inviting_state===InvitingState.CALLING)&&this.call_sessions[this.current_call_id].Terminate(!0,"TR_HANGUP")}},{key:"destroy",value:function(){}}]),b}(_WA69.conn.ES6ConnectionRoster);_WA69.Voip=new VoipController,_WA69.Voip.InvitingState=InvitingState;var _WA70=WebIM,_DomUtil32=_WA70.DomUtil,Page=function(){function a(b,c){_classCallCheck2(this,a),_WA70.populateList.push(this),this.loadEvent=new WebIM.util.Event,this.unloadEvent=new WebIM.util.Event,b&&(this.appPageName=b,App.populate(b,this.onPageLoad,this.onPageUnload,c||this))}return _createClass2(a,[{key:"open",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_WA70.splitView&&!b.forceApp?_WA70.Pane.openPageBox(this,a,b.expanded):App.load(this.appPageName,a,this)}},{key:"openInBlock",value:function(a,b){if(!a||this.isCurrentPane()||App.indexOfPage(this.appPageName)>-1||this.isOpenedInBlock())return!1;var c=App.getPageByName(this.appPageName);return c.style.display="block",a.appendChild(c),this.__pageElement=_DomUtil32.get(c),this.onPageLoad(c,b),this.__pageElement}},{key:"isCurrentApp",value:function(){return App.isCurrentPage(this.appPageName)}},{key:"isCurrentPane",value:function(){return _WA70.Pane.isCurrentBox(this.appPageName)}},{key:"isOpenedInBlock",value:function(){return!!this.__pageElement}},{key:"isCurrentPage",value:function(){return _WA70.Pane.isCurrentPage(this.appPageName)||this.isOpenedInBlock()}},{key:"close",value:function(a){if(this.isOpenedInBlock())this.onPageUnload(this.__pageElement),this.__pageElement.remove(),this.__pageElement=null;else if(this.isCurrentApp())App.back();else if(this.isCurrentPane())_WA70.Pane.back();else if(a){var b=App.indexOfPage(this.appPageName);b>-1&&App.spliceHistory(b,1)}}},{key:"onPageLoad",value:function(){this.loadEvent.fire()}},{key:"onPageUnload",value:function(){this.unloadEvent.fire()}},{key:"destroy",value:function(){this.loadEvent.removeAll(),this.unloadEvent.removeAll()}}]),a}();_WA70.Page=Page;var _WA71=WebIM,_U58=_WA71.util,_DomUtil33=_WA71.DomUtil,countryCodes=null,primaryCountries=[],defaultCountries=[[7,_WA71.tr("auth.russia"),"ru"]],countryScript=null,countryLoadedEvent=new _U58.Event,loadCountryCodes=function(){countryCodes||countryScript||(countryScript=_DomUtil33.getBody().dom.appendChild(document.createElement("script")),countryScript.addEventListener("error",function(){countryScript=null}),countryScript.src=_WA71.resPath+"countries."+(_WA71.resLanguage||"en")+".js")},countryLoader=_WA71.countryLoader={},buildListItem=function(a){return{key:a[0],subtext:"+"+a[0],text:a[1],code:a[2]}},cloneCountryCodes=function(){return countryCodes.map(function(a){return _toConsumableArray2(a)})},CountryPage=function(a){function b(){return _classCallCheck2(this,b),_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"countryPage"))}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a,b){var c=App.indexOfPage("countryPage");c>-1&&c<App.getHistory().length-1&&App.spliceHistory(c,1),this.el=_DomUtil33.get(a),this.onClickCB=b.onClick,this.buildItemFn=b.buildItemFn||buildListItem,this.emptyField=b.emptyField,this.list=new _WA71.ui.SearchPlainList({items:this._buildCountryList(),autoRender:this.el.getSelector(".im-countrypage .app-content"),cls:"im-countrypage__list",cb:this._onCountryItemClick,searchTitle:_WA71.tr("auth.searchCode"),noIcon:1,scope:this}),_WA71.setTimeout(this.focus,10,this),this.el.getSelector(".app-topbar .im-ui-button").on("click",this.onBackClick,this),countryCodes||(countryLoadedEvent.on(this.updateCountries,this),loadCountryCodes())}},{key:"onPageUnload",value:function(){this.el.getSelector(".app-topbar .im-ui-button").un("click",this.onBackClick,this),this.el=null}},{key:"focus",value:function(a){this.list&&this.list.focus()}},{key:"onBackClick",value:function(a){this.close()}},{key:"updateCountries",value:function(){this.isCurrentPage()&&this.list&&this.list.updateItems(this._buildCountryList())}},{key:"_onCountryItemClick",value:function(a,b,c){this.close(),this.onClickCB&&this.onClickCB(a,c)}},{key:"_buildCountryList",value:function(){var a=[];return this._items=[],_U58.Array.each(countryCodes||defaultCountries,function(b){primaryCountries.indexOf(b[2])>-1?a.push(this.buildItemFn(b)):this._items.push(this.buildItemFn(b))},this),a.length&&(a.sort(function(a,b){return primaryCountries.indexOf(a.code)<primaryCountries.indexOf(b.code)?-1:1}),this._items=a.concat(this._items)),this.emptyField&&this._items.unshift(this.buildItemFn(["",this.emptyField,""])),this._items}}],[{key:"getCountryData",value:function(a){countryCodes?a&&a(cloneCountryCodes()):(a&&countryLoadedEvent.on(function(){return a(cloneCountryCodes())}),loadCountryCodes())}}]),b}(_WA71.Page);_WA71.updateCountryCodes=function(a){if(!countryCodes){countryCodes=a;var b=_WA71.tr("favoriteCountries",{defaultNull:!0});b&&(primaryCountries=b.split(",")),countryLoadedEvent.fire(),countryLoadedEvent.removeAll()}},_WA71.CountryPage=CountryPage,new CountryPage;var _WA72=WebIM,_UI41=_WA72.ui,_U59=_WA72.util,_TD23=_WA72.TemplateDriver,_S3=_WA72.AccountStorage,_DomUtil34=_WA72.DomUtil,DEBUG_FORMS=!1,DEBUG_PROFILE_DIALOG=!1,USE_OTP_AUTH=_WA72.configurator.getOption("enable_otp_auth"),REGEX_EMAIL=/^([\w-.+]+)@(((?:[\w]+-?[\w]*)+[.])+)([a-zA-Z]{1,61})(#[\w-.]+)?$/,REGEX_USERNAME_OR_UIN=/^[A-Za-z0-9._]+$/,DEFAULT_COUNTRY_CODE=7,ACCEPTED_STORAGE_KEY="GDPRAccepted",GDPR_DISABLED=_WA72.configurator.getOption("disable_gdpr"),SMSCODE_PAGE_TEXT_MAP={sms_source:{title:"auth.smsCode",codeSent:"auth.codeWasSentTo",resendCode:"auth.resendCode"},phone_source:{title:"auth.typeCallCode",codeSent:"auth.weCalledYou",resendCode:"auth.recall"}},validateUserLogin=function(a){return REGEX_EMAIL.test(a)||REGEX_USERNAME_OR_UIN.test(a)},gPhoneNumber,gTransId,gCodeLength,gCodeRegex,gCountryCode=DEFAULT_COUNTRY_CODE,gCodeFromPhone=!1,gLogginIn=!1,gCodeRequestedTS=0,gUserAccepted=!1,focusField=function(a){a&&setTimeout(function(){a.dom.focus(),a.dom.selectionStart=a.dom.selectionEnd=100},50)},AuthForm=function(){function a(b,c){var d=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};_classCallCheck2(this,a),this.page=_DomUtil34.getSelector(".imAuthPage"),this.switchFormEvent=new _U59.Event,this.name=b,this.templateId=c,this.initialParams=d,this.el=null,this.state={}}return _createClass2(a,[{key:"load",value:function(){var a=_WA72.urlBuilder.getUrl("passwordRemind"),b=this.page.getSelector(".imAuthForm");b.updateHTML(_TD23.parseSafe(this.templateId,{spinner:_WA72.TD.getTMPL("CircleSpinner"),title:_WA72.tr("auth.loginByPassword"),subtitle:_WA72.tr("auth.inputLoginPassword"),buttonTitle:_WA72.tr("auth.login"),passwordRemindLink:_WA72.configurator.getOption("disable_password_recovery")?"#":a,passwordRecovery:_WA72.configurator.getOption("disable_password_recovery")?"":_WA72.tr("auth.lostPassword")},{safeKeys:["spinner","subtitle"]})),this.el=b.first(),this.page.on("click",this._onClick,this),this.formSwitcher=this.page.getSelector(".imButtonSwitch"),this.formSwitcher.updateText(""),this.formSwitcher.setAttribute("data-form",this.name)}},{key:"unload",value:function(){this.switchFormEvent.removeAll(),this.page.un("click",this._onClick,this),this.el.remove(),this.el=null}},{key:"_onClick",value:function(a){var b=a.getTarget(!0).up("imButton");this.onButtonClick(b&&b.getAttribute("data-action"))}},{key:"validate",value:function(){}},{key:"_switchForm",value:function(a,b){this.switchFormEvent.fire(a,b)}},{key:"onButtonClick",value:function(a){}},{key:"_buildServerErrorMessage",value:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",d=b||a,e=_WA72.tr("auth.msgCommonError")+" ("+d+")";return"DB_VALIDATION_LIMIT_REACHED"===c?e=_WA72.tr("auth.msgValidationLimit"):330===d?e=_WA72.tr("auth.msgWrongLoginOrPassword"):40010===d||462===d?e=_WA72.tr("auth.msgWrongPhone"):40500===d||465===d||"smsapi/verify limit"===c?e=_WA72.tr("auth.msgRequestRateLimit"):40020===d?e=_WA72.tr("auth.msgTwoFactorAuth"):40011===d?e=_WA72.tr("auth.msgPhoneBlocked"):401===d||"CODE_MISMATCH"===c?e=_WA72.tr("auth.msgWrongCode"):d||(e=_WA72.tr("auth.msgNetworkUnavailable")),e}},{key:"clearError",value:function(){var a=this.el.getSelector(".imAuthError");a&&a.updateText("")}},{key:"showError",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",c=this.el.getSelector(".imAuthError");c&&c.updateHTML(b),a&&focusField(a)}}]),a}(),AuthFormPassword=function(a){function b(a){var c;return _classCallCheck2(this,b),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"frmPassword","authFormPassword",a)),c.OTP_STEP_LOGIN=1,c.OTP_STEP_PASSWORD=2,c}return _inherits2(b,a),_createClass2(b,[{key:"load",value:function(){_get2(_getPrototypeOf2(b.prototype),"load",this).call(this),this.formSwitcher.updateText(_WA72.tr("auth.loginByPhone")),this.formSwitcher.setVisible(!_WA72.configurator.getOption("disable_phone_signin")),this.txtLogin=this.el.getSelector(".imAuthLogin"),this.txtPswd=this.el.getSelector(".imAuthPassword"),this.submitButton=this.el.getSelector("button[data-action=submit]"),this.txtLogin.on(["keydown","keyup","change","input"],this.validate,this),this.txtPswd.on(["keydown","keyup","change","input"],this.validate,this),this.submitButton.on("click",this.submit,this),USE_OTP_AUTH?this._switchStep(this.OTP_STEP_LOGIN):(this.txtLogin.dom.value="",this.txtPswd.dom.value="",focusField(this.txtLogin))}},{key:"unload",value:function(){this.txtLogin.un(["keydown","keyup","change","input"],this.validate,this),this.txtPswd.un(["keydown","keyup","change","input"],this.validate,this),this.submitButton.un("click",this.submit,this),_get2(_getPrototypeOf2(b.prototype),"unload",this).call(this)}},{key:"validate",value:function(a){if(a&&"keydown"===a.type)this._keyDownCode=a.keyCode;else{var b=this._keyDownCode;if(a&&"keyup"===a.type&&delete this._keyDownCode,a&&"keyup"===a.type&&13===a.keyCode)b===a.keyCode&&this.submit();else{var c,d=this.txtLogin.dom.value.trim().length,e=this.txtPswd.dom.value.trim().length;c=USE_OTP_AUTH?1===this.state.step?d>0:e>0:d>0&&e>0,this.submitButton.setDisabled(!c)}}}},{key:"onButtonClick",value:function(a){"switchForm"===a&&(USE_OTP_AUTH?this.state.step===this.OTP_STEP_PASSWORD&&this._switchStep(this.OTP_STEP_LOGIN):this._switchForm("frmPhone"))}},{key:"_switchStep",value:function(a){this.state.step=a,this.clearError(),a===this.OTP_STEP_LOGIN?(this.formSwitcher.setVisible(!1),this.formSwitcher.removeAttribute("data-back"),this.txtPswd.hide(),this.txtLogin.show(),this.el.getSelector(".imAuthTitle").updateText(_WA72.tr("auth.enterEmail")),this.el.getSelector(".imAuthSubtitle").updateText(_WA72.tr("auth.businessOTPAuthEmail")),this.submitButton.updateText(_WA72.tr("next")),focusField(this.txtLogin)):a===this.OTP_STEP_PASSWORD&&(this.formSwitcher.updateText(""),this.formSwitcher.setAttribute("data-back","1"),this.formSwitcher.setVisible(!0),this.txtLogin.hide(),this.txtPswd.dom.value="",this.txtPswd.show(),this.el.getSelector(".imAuthTitle").updateText(_WA72.tr("auth.enterPassword")),
this.el.getSelector(".imAuthSubtitle").updateHTML(_WA72.tr("auth.businessOTPAuthPassword",{email:_U59.String.htmlEntity(this.state.otpEmail)})),this.el.getSelector(".imAuthSubtitle span").addClass("im-marker"),this.submitButton.updateText(_WA72.tr("auth.login")),focusField(this.txtPswd))}},{key:"_onConfigError",value:function(){var a=this,b=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("ERROR_CONFIG_NOT_FOUND"===b.reason){var c=new _UI41.EditModalBox({title:b.msg,explain:_WA72.tr("onpremise.errorContactAdmin"),denyEmptyValue:!0,okButton:_WA72.tr("box.ok"),onEditOk:function(b){_WA72.Sys.checkSystemConfig({forceHost:b}).then(function(){a.submit()},a._onConfigError.bind(a))}});c.show()}else _WA72.showPopup(b.msg||_WA72.tr("auth.msgCommonError"),0)}},{key:"submit",value:function(){var a=this;if(!gLogginIn){this.clearError();var b=this.txtLogin.dom.value.trim(),c=(b||"").replace(/(#[\w-.]+)$/,""),d=this.txtPswd.dom.value,e=0===b.length||!validateUserLogin(b),f=0===d.trim().length;if(USE_OTP_AUTH)if(1===this.state.step)if(e)this.showError(this.txtLogin,_WA72.tr("auth.msgWrongLogin"));else{if(this.state.otpEmail=c,DEBUG_FORMS)return this._switchStep(this.OTP_STEP_PASSWORD);_WA72.Sys.checkSystemConfig({userLogin:b}).then(function(){AuthAbstraction.submitUsernameForOTP(c).then(function(){a._switchStep(a.OTP_STEP_PASSWORD)},function(){a.showError(a.txtLogin,_WA72.tr("auth.msgWrongLogin"))})},this._onConfigError.bind(this))}else 2===this.state.step&&(f?this.showError(this.txtPswd,_WA72.tr("auth.msgWrongPassword")):AuthAbstraction.submitUsernamePassword(c,d).then(function(){},function(b){var c=_slicedToArray(b,2),d=c[0],e=c[1],f=330===e?_WA72.tr("auth.msgWrongPassword"):a._buildServerErrorMessage(d,e);a.showError(a.txtPswd,f)}));else e?this.showError(this.txtLogin,_WA72.tr("auth.msgWrongLoginOrPassword")):f?this.showError(this.txtPswd,_WA72.tr("auth.msgWrongLoginOrPassword")):_WA72.Sys.checkSystemConfig({userLogin:b}).then(function(){AuthAbstraction.submitUsernamePassword(c,d).then(function(){},function(b){var c=_slicedToArray(b,2),d=c[0],e=c[1];a.showError(a.txtPswd,a._buildServerErrorMessage(d,e))})},this._onConfigError.bind(this))}}}]),b}(AuthForm),AuthFormPhone=function(a){function b(a){return _classCallCheck2(this,b),_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"frmPhone","authFormPhone",a))}return _inherits2(b,a),_createClass2(b,[{key:"load",value:function(){_get2(_getPrototypeOf2(b.prototype),"load",this).call(this),this.formSwitcher.updateText(_WA72.tr("auth.loginByPassword"));var a=_WA72.Feature.getModeParameter("disableLoginByPassword");this.formSwitcher.setVisible(!a),this.txtPhone=this.el.getSelector(".imAuthPhone"),this.submitButton=this.el.getSelector("button[data-action=submit]"),this.countryButton=this.el.getSelector(".imSelectCountryCode"),this.txtPhone.on(["keydown","keyup","change","input"],this.validate,this),this.submitButton.on("click",this.submit,this),this.countryButton.on("click",this._chooseCountry,this),this.txtPhone.dom.value=this.initialParams.phone?this.initialParams.phone:"+"+gCountryCode,focusField(this.txtPhone)}},{key:"unload",value:function(){this.txtPhone.un(["keydown","keyup","change","input"],this.validate,this),this.submitButton.un("click",this.submit,this),this.countryButton.un("click",this._chooseCountry,this),_get2(_getPrototypeOf2(b.prototype),"unload",this).call(this)}},{key:"_chooseCountry",value:function(){_WA72.splitView?(this._countryPage||(this._countryPage=new _WA72.CountryPage),_WA72.Pane.openPageBox(this._countryPage,{onClick:this.changeCountryCode.bind(this)})):App.load("countryPage",{onClick:this.changeCountryCode.bind(this)})}},{key:"changeCountryCode",value:function(a){var b=this.txtPhone.dom.value;gCountryCode&&b.startsWith("+"+gCountryCode)?b=b.replace("+"+gCountryCode,"+"+a):(b=b.replace(/^(\+)/,""),b="+"+a+b),gCountryCode=a,this.txtPhone.dom.value=b,this.validate(),focusField(this.txtPhone)}},{key:"validate",value:function(a){if(a&&"keydown"===a.type)this._keyDownCode=a.keyCode;else{var b=this._keyDownCode;if(a&&"keyup"===a.type&&delete this._keyDownCode,a&&"keyup"===a.type&&13===a.keyCode)a.keyCode===b&&this.submit();else{var c=this.txtPhone.dom.value.trim(),d=c.length>0;c=c.replace(/^(\+)/,""),d=d&&/^\d+$/.test(c),this.submitButton.setDisabled(!d)}}}},{key:"onButtonClick",value:function(a){"switchForm"===a&&this._switchForm("frmPassword")}},{key:"submit",value:function(){var a=this;if(DEBUG_FORMS)return gCodeFromPhone=!1,gCodeLength=6,gPhoneNumber="75394058391",gCodeRequestedTS=_WA72.now(),gCodeRegex=new RegExp("\\d+"),this._switchForm("frmSmsCode");this.clearError();var b=this.txtPhone.dom.value.trim();b=b.replace(/^(\+)/,""),0===b.length?this.showError(this.txtPhone,_WA72.tr("auth.msgWrongPhone")):/^\d+$/.test(b)?(gPhoneNumber=b,AuthAbstraction.getCodeByPhone(gPhoneNumber).then(function(){a._switchForm("frmSmsCode")},function(b){a.showError(a.txtPhone,a._buildServerErrorMessage(b))})):this.showError(this.txtPhone,_WA72.tr("auth.msgWrongPhone"))}}]),b}(AuthForm),AuthFormSmsCode=function(a){function b(a){var c;return _classCallCheck2(this,b),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"frmSmsCode","authFormSmsCode",a)),c._submitted=!1,c}return _inherits2(b,a),_createClass2(b,[{key:"load",value:function(){_get2(_getPrototypeOf2(b.prototype),"load",this).call(this),this.formSwitcher.updateText(""),this.formSwitcher.show(),this.txtCode=this.el.getSelector(".imAuthCode"),this.txtCode.dom.value="",this.txtCode.on(["keyup","change","input"],this.validate,this),this.el.getSelector(".imAuthTitle").updateHTML(this._getMappedPhrase("title")),this.el.getSelector(".imAuthCodeSentPhrase").updateHTML(this._getMappedPhrase("codeSent",{tel:_U59.String.formatPhone("+"+gPhoneNumber)})),gCodeLength&&this.el.getSelector(".imAuthCode").setAttribute("placeholder",_U59.String.multiply("_",gCodeLength)),this._updateResendButton(),focusField(this.txtCode)}},{key:"unload",value:function(){this.txtCode.un(["keyup","change","input"],this.validate,this),_get2(_getPrototypeOf2(b.prototype),"unload",this).call(this)}},{key:"validate",value:function(a){var b=!1,c=this.txtCode.dom.value;c.length>0&&(gCodeLength&&gCodeLength!==c.length||(b=!0)),b&&!this._submitted&&this.submit()}},{key:"onButtonClick",value:function(a){"switchForm"===a?this._switchForm("frmPhone",{phone:"+"+gPhoneNumber}):"resendCode"===a&&this._resendCode()}},{key:"_resendCode",value:function(){var a=this;_WA72.now()-gCodeRequestedTS<60||AuthAbstraction.getCodeByPhone(gPhoneNumber).then(function(){a.txtCode.dom.value="",a._updateResendButton(),focusField(a.txtCode)},function(){a._switchForm("frmPhone")})}},{key:"submit",value:function(){var a=this;if(!gLogginIn){this.clearError();var b=this.txtCode.dom.value;if(0===b.trim().length)this.showError(this.txtCode,_WA72.tr("auth.msgWrongCode"));else if(/^\d+$/.test(b)){if(this._submitted=!0,this.el.getSelector(".imSpinner").show(),DEBUG_FORMS)return this.el.getSelector(".imSpinner").hide(),this._submitted=!1,void this.showError(this.txtCode,_WA72.tr("auth.msgWrongCode"));AuthAbstraction.tryLoginByCode(b).then(function(){},function(b){var c=_slicedToArray(b,3),d=c[0],e=c[1],f=c[2];a.el.getSelector(".imSpinner").hide(),a._submitted=!1,a.showError(a.txtCode,a._buildServerErrorMessage(d,e,f))})}else this.showError(this.txtCode,_WA72.tr("auth.msgWrongCode"));return!1}}},{key:"_updateResendButton",value:function(){if(this.el){var a=60-_WA72.now()+gCodeRequestedTS,b=this.el.getSelector('.imButton[data-action="resendCode"]'),c=this._getMappedPhrase("resendCode");b.setDisabled(a>0),a>0?(b.updateHTML(c+" (0:"+a+")"),_WA72.setTimeout(this._updateResendButton,1e3,this)):b.updateHTML(c)}}},{key:"_getMappedPhrase",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=SMSCODE_PAGE_TEXT_MAP[gCodeFromPhone?"phone_source":"sms_source"][a];return c?_WA72.tr(c,b):""}}]),b}(AuthForm),AuthAbstraction={submitUsernameForOTP:function(a){return new Promise(function(b,c){gLogginIn||(gLogginIn=!0,_WA72.comApi.requestOTP(a).then(function(){gLogginIn=!1,b()},function(a){var b=_slicedToArray(a,2),d=b[0],e=b[1];gLogginIn=!1,c(d,e)}))})},submitUsernamePassword:function(a,b){return _WA72.comApi.requestClientLogin(a,b).then(function(b){return gLogginIn=!1,b.ts||(b.ts=_WA72.now()),_U59.Mnt.countRB(41352514),AuthAbstraction.onLoginSuccess(b,"failSessionPswd_"+a),Promise.resolve()},function(a){var b=_slicedToArray(a,2),c=b[0],d=b[1];return gLogginIn=!1,_U59.Mnt.err("tokenByPswd"),Promise.reject([c,d])})},getCodeByPhone:function(a){return new Promise(function(b,c){return gLogginIn?c():(gLogginIn=!0,void _WA72.rapi.sendCode(a,!1,function(){gLogginIn=!1;for(var d=arguments.length,e=new Array(d),f=0;d>f;f++)e[f]=arguments[f];200===e[0]&&e[3]?(gCodeRequestedTS=_WA72.now(),gPhoneNumber=a,gTransId=e[3].sessionId,gCodeLength=e[3].codeLength,gCodeFromPhone="callui"===e[3].route,gCodeFromPhone&&_U59.Mnt.countRB(41342291),b()):(gLogginIn=!1,c(e[2]||e[0]))}))})},tryLoginByCode:function(a){return gLogginIn=!0,_WA72.comApi.getTokenByPhoneCode(gPhoneNumber,gTransId,a).then(function(a){return gLogginIn=!1,_U59.Mnt.countRB(41352518),AuthAbstraction.onLoginSuccess(a,"failSessionPhone_"+gPhoneNumber),Promise.resolve()},function(a){var b=_slicedToArray(a,3),c=b[0],d=b[1],e=b[2];return gLogginIn=!1,_U59.Mnt.err("tokenBySms"),Promise.reject([c,d,e])})},checkProfileComplete:function(a){return DEBUG_PROFILE_DIALOG||a.settings&&a.settings.needFillProfile?(_S3.save({profileIncomplete:1}),WebIM.SelfProfilePage.showStartProfileDialog().then(function(){_S3.remove(["profileIncomplete"])})):Promise.resolve()},tryLoginByMailCookie:function(a){gLogginIn||_WA72.ConnectionFacade.loginByMailCookie(a).then(function(a){gLogginIn=!1,AuthAbstraction.onLoginSuccess(a,"failSessionMpop_"+a.loginId)},function(b){gLogginIn=!1,a&&AuthAbstraction.authError(b)})},onLoginSuccess:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;_U59.Mnt.countRB(32744046);var c=a.token.a,d=a.hostTime,e=a.sessionKey;_WA72.ConnectionFacade.tryStartSession2020({a:c,ts:d,sessionKey:e}).then(function(b){_U59.Mnt.countRB(32744050),_WA72.ConnectionFacade.startNewSession(b,!0),AuthAbstraction.sendPolicyAccept()["finally"](function(){AuthAbstraction.checkProfileComplete(a).then(function(){if(!DEBUG_PROFILE_DIALOG){var a=_WA72.authPage.loginWithoutReload;_WA72.authPage.loginWithoutReload=!1,_WA72.authPage.successEvent.fire(),a||setTimeout(function(){location.href=location.href+(location.href.indexOf("?")>-1?"&":"?")+"afterauth=1"},50)}},function(){_WA72.ConnectionFacade.logout(),_WA72.authPage.initialForm()})})},function(a){var c=_slicedToArray(a,1),d=c[0];AuthAbstraction.authError(d),b&&_U59.Mnt.log({reason:"auth",method:b,code:d})})},sendPolicyAccept:function(){return new Promise(function(a){if(GDPR_DISABLED)return a();var b="accept";_S3.modify([ACCEPTED_STORAGE_KEY],function(c){return c[ACCEPTED_STORAGE_KEY]?void a():(c[ACCEPTED_STORAGE_KEY]=b,void _WA72.comApi.sendAcceptGDPR(b)["finally"](a))})})},authError:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;_WA72.showPopup(_WA72.tr("auth.msgCommonError")+" ["+a+"]")}},AUTH_FORMS={frmPassword:AuthFormPassword,frmPhone:AuthFormPhone,frmSmsCode:AuthFormSmsCode},INITIAL_FORM=_WA72.configurator.getOption("disable_phone_signin")||_WA72.configurator.getOption("enable_email_mpop_auth")?"frmPassword":"frmPhone",AuthPage=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"authPage")),a.successEvent=new _U59.Event,a}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a){arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.el=_DomUtil34.get(a),this.scrollBar||(this.scrollBar=new _WA72.ui.ScrollBar({source:this.el,autoRender:_DomUtil34.getBody()})),_WA72.Pane.boxCloseEvent.on(this._onPaneBoxClose,this),_WA72.Pane.boxOpenEvent.on(this._onPaneBoxOpen,this),_U59.Mnt.countRB(41352497);var b=App.cutLocationSearch();_U59.String.parseQueryString(b);b?_WA72.Storage.save({locationQueryParams:b}):_WA72.Storage.remove("locationQueryParams"),_DomUtil34.getBody().removeClass("im-splitview"),this.el.getSelector(".im-auth-sysinfo").updateText("b"+VERSION_JS.split(":")[0]),this.initialForm()}},{key:"onPageUnload",value:function(){this.scrollBar&&this.scrollBar.destroy(),_WA72.Pane.boxCloseEvent.un(this._onPaneBoxClose,this),_WA72.Pane.boxOpenEvent.un(this._onPaneBoxOpen,this),this._currentForm&&this._currentForm.unload()}},{key:"_onPaneBoxClose",value:function(){_WA72.Pane.hasOpenedBox()||this.scrollBar.resume()}},{key:"_onPaneBoxOpen",value:function(){this.scrollBar.suspend()}},{key:"showWelcomeScreen",value:function(a){var b=_WA72.configurator.getOption("icq_specific")?"auth.welcomeToIcq":"auth.welcomeTo",c=_WA72.urlBuilder.getUrl("termsOfUse"),d=_WA72.urlBuilder.getUrl("privacyPolicy"),e=_WA72.urlBuilder.getUrl("cookiePolicy");return new Promise(function(f){var g=a.createChild(_TD23.parseSafe("welcomeScreen",{welcomeTo:_WA72.tr(b,{product:_WA72.PRODUCT_TITLE}),welcomeAgreement:_WA72.tr("auth.welcomeAgreement",{termsLink:c,policyLink:d,cookiePolicyLink:e})},{safeKeys:["welcomeAgreement"]}));g.getSelector(".imButton").on("click",function(){g.remove(),f()})})}},{key:"initialForm",value:function(){var a=this,b=_WA72.Feature.getModeParameter("disabledGdprWhileAuth"),c=_WA72.Feature.getModeParameter("disableLoginByPassword");GDPR_DISABLED||b||gUserAccepted?this.loadForm(c?"frmPhone":INITIAL_FORM):this.showWelcomeScreen(this.el).then(function(){gUserAccepted=!0,document.cookie="cookie-policy-accepted=1; expires="+new Date(+new Date+1e11).toUTCString()+"; path=/",a.loadForm(c?"frmPhone":INITIAL_FORM)})}},{key:"loadForm",value:function(a,b){var c=this;this._currentForm&&this._currentForm.unload();var d=new AUTH_FORMS[a](b);d.load(),d.switchFormEvent.on(function(a,b){c.loadForm(a,b)}),this._currentForm=d,this.scrollBar.sync()}}]),b}(_WA72.Page);_WA72.authPage=new AuthPage;var _WA73=WebIM,_U60=_WA73.util,_TD24=_WA73.TemplateDriver,_AS=_WA73.AccountSettings,_DomUtil35=_WA73.DomUtil,CTRL_KEY=_WA73.isMac?"Cmd":"Ctrl",SEARCH_KEY_TITLE=CTRL_KEY+"+F",ALTER_SEARCH_KEY_TITLE=CTRL_KEY+"+Shift+F",THEME_NAME_SCHEMA={green:"settings.greenTheme",dark_green:"settings.darkGreenTheme",blue:"settings.blueTheme",dark_blue:"settings.darkBlueTheme",dit_blue:"settings.defaultTheme",myteam_green:"settings.defaultTheme",dark_calls:"settings.darkCallTheme"},getLocalOption=function(a){return _AS.getOption(a)},setLocalOption=function(a,b){return _AS.setOption(a,b)},invertLocalOption=function(a){return _AS.invertOption(a)},SettingOptionsPage=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"settingOptions",b)),a.activePane=null,a._privacySettingsRequested=!1,a.backClick=new _U60.Event,a}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=_DomUtil35.get(a),d=b.pane||"settingsPaneCommon";this.el=c,c.on(["change","click"],this._onPageClick,this),_WA73.isDesktop&&_WA73.Notifier.permissionEvent.on(this._onPermissionUpdate,this),this.activePane&&c.getSelector("."+this.activePane).hide(),this.activePane=d;var e=c.getSelector("."+d);c.getSelector(".imSettingOptionsTitle").updateHTML(e.getAttribute("data-title")),e.show();var f="";_WA73.THEME_SCHEMA.forEach(function(a,b){f+=_TD24.parseSafe("themeRadioButton",{themeName:_WA73.tr(THEME_NAME_SCHEMA[a]),themeId:a,themeIndex:b})}),_DomUtil35.getSelector(".im-settings__option[data-key=themeSelector]").updateHTML(f),this.scrollBar=new _WA73.ui.ScrollBar({source:this.el.getSelector(".app-content")}),this.updatePane(),this.loadEvent.fire(this.activePane),App.on("page:show",this._onPageShow,this)}},{key:"onPageUnload",value:function(){this.el.un(["change","click"],this._onPageClick,this),_WA73.Notifier.permissionEvent.un(this._onPermissionUpdate,this),this.unloadEvent.fire(this.activePane),App.off("page:show",this._onPageShow,this)}},{key:"_onPageShow",value:function(a){"settingOptions"===a.pageName&&a.pageData&&"settingsPaneSecurity"===a.pageData.pane&&a.pageContext===this&&this._refreshSessionCounter()}},{key:"_onPageClick",value:function(a){var b=a.getTarget(!0),c=b.up("imButton");if(b.up("appBack"))return void(_WA73.splitView?this.backClick.fire():App.back());if(c)this._onButtonClick(c.getAttribute("data-action"),c);else if(b=b.up("im-settings__option"),b&&!b.hasClass("im-settings__option-disabled")){if("click"===a.type&&(b.getSelector("input")||b.getSelector("select")))return;this._onOptionClick(b.getAttribute("data-key"))}}},{key:"_onButtonClick",value:function(a,b){var c=this;"closeSession"===a&&_WA73.ui.confirmAction(_WA73.tr("settings.sessionWillBeClosed",{name:b.getAttribute("data-client")}),{title:_WA73.tr("settings.closeSession"),okButton:_WA73.tr("box.close"),okButtonCls:"im-button_attention"}).then(function(){_WA73.rapi.sessionReset(b.getAttribute("data-hash"),function(){_WA73.showPopup(_WA73.tr("settings.sessionClosed")),c._refreshSessionList(!0).then(function(){c._refreshSessionCounter()})})})}},{key:"_onOptionClick",value:function(a){var b,c=this;switch(a){case"smartReply":invertLocalOption(_AS.OPTION_HIDE_SMART_REPLY);break;case"stickerSuggest":invertLocalOption(_AS.OPTION_HIDE_STICKER_SUGGEST_BY_EMOJI);break;case"stickerSuggestByWords":invertLocalOption(_AS.OPTION_HIDE_STICKER_SUGGEST_BY_WORDS);break;case"sound":invertLocalOption(_AS.OPTION_MUTE_SOUND);break;case"enter":invertLocalOption(_AS.OPTION_SEND_BY_ENTER);break;case"searchChat":b=_DomUtil35.getSelector(".im-settings__option[data-key=searchChat] input:checked"),b&&setLocalOption(_AS.OPTION_SEARCH_CHAT_HOTKEY,"2"===b.dom.value);break;case"showNotifications":var d=invertLocalOption(_AS.OPTION_BLOCK_DESKTOP_NOTIFICATIONS);d?_WA73.MessageNotifier.clear():d||_WA73.Notifier.isGranted()||_WA73.Notifier.requestPermission();break;case"hideNotificationsText":invertLocalOption(_AS.OPTION_HIDE_TEXT_IN_NOTIFICATIONS);break;case"groupsSettings":case"callsSettings":var e=_DomUtil35.getSelector(".im-settings__option[data-key="+a+"]");return void(e&&(b=e.getSelector("input:checked"),b&&this._updatePrivacyOption(a,e,b.getAttribute("value"))));case"themeSelector":b=_DomUtil35.getSelector(".im-settings__option[data-key=themeSelector] input:checked"),b&&(setLocalOption(_AS.OPTION_THEME,b.getAttribute("data-id")),this.__themeStatSent||(this.__themeStatSent=!0,_U60.Mnt.countRB(37874877)));break;case"ignoreList":this._ignoreList||(this._ignoreList=new _WA73.IgnoreListPage),_WA73.splitView?_WA73.Pane.openPageBox(this._ignoreList,{}):App.load("ignorelist",{},this._ignoreList);break;case"sessionList":return void _WA73.ma.settingsPage.openPane("settingsPaneSessionList");case"closeSessions":return void _WA73.ui.confirmAction(_WA73.tr("settings.sessionsWillBeClosed"),{title:_WA73.tr("settings.closeSessions"),okButton:_WA73.tr("box.close"),okButtonCls:"im-button_attention"}).then(function(){_WA73.rapi.sessionResetAll(function(){_WA73.showPopup(_WA73.tr("settings.sessionsClosed")),c._refreshSessionList(!0),c._refreshSessionCounter()})});case"deleteAccount":var f=new _WA73.DeleteAccountBox;return void f.show();case"mediaAudioInput":case"mediaAudioOutput":case"mediaVideoInput":var g=[];return this._getDeviceElements().forEach(function(a){g.push(a.options[a.selectedIndex].value)}),void setLocalOption(_AS.STRING_MEDIA,g.join(";"));case"buildInfo":return void _WA73.showPopup(VERSION_JS.split(":")[1],5e3)}this.updatePane()}},{key:"_getDeviceElements",value:function(){var a=this.el.getSelector("select.imAudioInput"),b=this.el.getSelector("select.imAudioOutput"),c=this.el.getSelector("select.imVideoInput");return[a.dom,b.dom,c.dom]}},{key:"_fetchDevices",value:function(a){var b=getLocalOption(_AS.STRING_MEDIA),c=b?b.split(";"):[],d=this._getDeviceElements();d.forEach(function(a){for(a.removeAttribute("disabled");a.firstChild;)a.removeChild(a.firstChild)});for(var e=0;e!==a.length;++e){var f=a[e],g=document.createElement("option");g.value=f.deviceId,g.text=f.label||f.deviceId,"audioinput"===f.kind?(c[0]&&c[0]===g.value&&(g.selected=!0),d[0].appendChild(g)):"audiooutput"===f.kind?(c[1]&&c[1]===g.value&&(g.selected=!0),d[1].appendChild(g)):"videoinput"===f.kind&&(c[2]&&c[2]===g.value&&(g.selected=!0),d[2].appendChild(g))}}},{key:"_refreshGetGDPRLink",value:function(){var a=this;_WA73.configurator.getOption("disable_gdpr")||_WA73.FileApi.checkGDPRData().then(function(b){var c=a.el.getSelector(".imGetGDPRLink");c&&(b&&b.gdpr_status&&"ready"===b.gdpr_status?(c.setAttribute("href",_WA73.FileApi.getDownloadGDPRDataLink()),c.show()):c.hide())})}},{key:"_refreshSessionCounter",value:function(){var a=this;_WA73.configurator.getOption("disable_session_list")||_WA73.SelfProfilePage.getSessionList().then(function(b){var c=a.el.getSelector(".imSessionListCounter");c&&b.length&&c.updateText(_WA73.tr("settings.sessionList")+" ("+b.length+")")})}},{key:"_setPrivacyOption",value:function(a,b,c){var d=_DomUtil35.getSelector(".settingsPaneSecurity"),e=d&&d.getSelector(".im-settings__option[data-key="+a+"]");if(e&&(e.toggleClass("im-settings__option_local",b),c)){b||setLocalOption("groupsSettings"===a?_AS.STRING_PRIVACY_GROUPS:_AS.STRING_PRIVACY_CALLS,c);var f=e.getSelector("input[value="+c+"]");f&&(f.dom.checked=!0)}}},{key:"_requestPrivacyFromServer",value:function(){this._privacySettingsRequested||(this._privacySettingsRequested=!0,_WA73.rapi.getPrivacySettings({retryOnOnline:!0}).then(this._onRequestPrivacySettings.bind(this)))}},{key:"_updatePrivacyOption",value:function(a,b,c){var d=a.replace("Settings",""),e={};e[d]={allowTo:c},b.addClass("im-settings__option_local"),setLocalOption("groupsSettings"===a?_AS.STRING_PRIVACY_GROUPS:_AS.STRING_PRIVACY_CALLS,e[d].allowTo),_WA73.rapi.updatePrivacySettings(e,{retryOnOnline:!0}).then(this._onUpdatePrivacySettings.bind(this,a,d,e))}},{key:"_onRequestPrivacySettings",value:function(a){var b=a.fullCode,c=a.data;this._privacySettingsRequested=!1,2e4===b&&c&&(c.groups&&c.groups.allowTo&&this._setPrivacyOption("groupsSettings",!1,c.groups.allowTo),c.calls&&c.calls.allowTo&&this._setPrivacyOption("callsSettings",!1,c.calls.allowTo))}},{key:"_onUpdatePrivacySettings",value:function(a,b,c,d){var e=d.fullCode;2e4===e&&this._setPrivacyOption(a,!1,c[b].allowTo)}},{key:"_refreshSessionList",value:function(a){var b=this;return _WA73.SelfProfilePage.getSessionList(a).then(function(a){var c="",d="";b.el.getSelector(".imOtherSessions").setVisible(a.length>1),a.forEach(function(a){var b=a.current===!0,e=_TD24.parseSafe("sessionItem",{client:"SiteIM"===a.client?"Web IM":a.os+" "+a.client,started:b?_WA73.tr("settings.activeSession"):_U60.Date.formatDateTime(a.startedTime,_U60.Date.OUT_DAY_OR_TIME),location:a.location,ip:a.ip,hash:b?"":a.hash,cls:b?"im-settings__session_current":""});b?c=e:d+=e}),b.el.getSelector(".imCurrentSession").updateHTML(c),b.el.getSelector(".imActiveSessions").updateHTML(d),b.scrollBar.sync()})}},{key:"_onPermissionUpdate",value:function(a){a?_DomUtil35.getSelector(".im-settings__option[data-key=showNotifications] .im-settings__option-label_info").hide():getLocalOption(_AS.OPTION_BLOCK_DESKTOP_NOTIFICATIONS)||_DomUtil35.getSelector(".im-settings__option[data-key=showNotifications] .im-settings__option-label_info").show()}},{key:"updatePane",value:function(){var a,b,c,d,e=this.activePane;switch(d=_DomUtil35.getSelector("."+e),e){case"settingsPaneCommon":d.getSelector(".imSettingSearchHotkey").updateText(_WA73.tr("cl.optHotkeys",[SEARCH_KEY_TITLE+":"])),d.getSelector(".imSettingSearchSecondaryHotkey1").updateText("("+ALTER_SEARCH_KEY_TITLE+")"),d.getSelector(".imSettingSearchSecondaryHotkey2").updateText("("+ALTER_SEARCH_KEY_TITLE+")");var f=_WA73.configurator.getOption("enable_smart_reply_text")||_WA73.configurator.getOption("enable_smart_reply_stickers");a=getLocalOption(_AS.OPTION_SEND_BY_ENTER),d.getSelector(".im-settings__option[data-key=enter] input").dom.checked=a,f?(a=!getLocalOption(_AS.OPTION_HIDE_SMART_REPLY),d.getSelector(".im-settings__option[data-key=smartReply] input").dom.checked=a):d.getSelector(".im-settings__option[data-key=smartReply]").hide(),a=!getLocalOption(_AS.OPTION_HIDE_STICKER_SUGGEST_BY_EMOJI),d.getSelector(".im-settings__option[data-key=stickerSuggest] input").dom.checked=a,a=!getLocalOption(_AS.OPTION_HIDE_STICKER_SUGGEST_BY_WORDS),d.getSelector(".im-settings__option[data-key=stickerSuggestByWords] input").dom.checked=a,a=getLocalOption(_AS.OPTION_SEARCH_CHAT_HOTKEY),d.getSelector('.im-settings__option[data-key=searchChat] input[value="'+(a?1:2)+'"]').removeAttribute("checked"),d.getSelector('.im-settings__option[data-key=searchChat] input[value="'+(a?2:1)+'"]').setAttribute("checked","checked");break;case"settingsPaneNotify":a=getLocalOption(_AS.OPTION_MUTE_SOUND),d.getSelector(".im-settings__option[data-key=sound] input").dom.checked=!a,_WA73.isDesktop&&(d.getSelector(".im-settings__option[data-key=showNotifications]").show(),_WA73.configurator.getOption("disable_notification_text")||d.getSelector(".im-settings__option[data-key=hideNotificationsText]").show()),a=getLocalOption(_AS.OPTION_BLOCK_DESKTOP_NOTIFICATIONS),d.getSelector(".im-settings__option[data-key=showNotifications] input").dom.checked=!a,d.getSelector(".im-settings__option[data-key=showNotifications] .im-settings__option-label_info")[_WA73.Notifier.isGranted()||a?"hide":"show"](),b=a,a=getLocalOption(_AS.OPTION_HIDE_TEXT_IN_NOTIFICATIONS),c=d.getSelector(".im-settings__option[data-key=hideNotificationsText]").toggleClass("im-settings__option-disabled",b).last().first(),c.dom.checked=a,c.dom.disabled=b;break;case"settingsPaneSessionList":this._refreshSessionList(!0);break;case"settingsPaneSecurity":a=getLocalOption(_AS.STRING_PRIVACY_GROUPS),a&&this._setPrivacyOption("groupsSettings",!0,a),a=getLocalOption(_AS.STRING_PRIVACY_CALLS),a&&this._setPrivacyOption("callsSettings",!0,a),this._requestPrivacyFromServer();var g=_WA73.ACTIVE_IS_UIN&&_WA73.ConnectionFacade.getAttachedPhone();_WA73.configurator.getOption("enable_account_delete_button")&&g&&d.getSelector(".im-settings__option[data-key=deleteAccount]").show(),_WA73.configurator.getOption("disable_session_list")||d.getSelector(".im-settings__option[data-key=sessionList]").show(),this._refreshSessionCounter(),this._refreshGetGDPRLink();break;case"settingsPaneMedia":_WA73.RTCTools.getDeviceList().then(this._fetchDevices.bind(this));break;case"settingsPaneTheme":a=getLocalOption(_AS.OPTION_THEME)||_WA73.THEME_SCHEMA[0],c=d.getSelector('.im-settings__option[data-key=themeSelector] input[data-id="'+a+'"]'),c&&(c.dom.checked=!0);break;case"settingsPaneInfo":var h=VERSION_JS.split(":");_WA73.isProduction||(h[0]+=" Stage"),_WA73.isDebug&&(h[0]+=" Debug"),d.getSelector(".im-settings-icq_version").updateText("Web "+_WA73.PRODUCT_TITLE+" "+h[0]),d.getSelector(".imSettingsYear").updateText((new Date).getFullYear())}this.scrollBar.sync()}}]),b}(_WA73.Page);_WA73.SettingOptionsPage=SettingOptionsPage;var _WA74=WebIM,_U61=_WA74.util,ACTIVE_MENU_ITEM_CLS="im-settings__menu-item_active",_Activatable6=_WA74.Activatable,_DomUtil36=_WA74.DomUtil,SettingsPage=function(a){function b(){return _classCallCheck2(this,b),_possibleConstructorReturn2(this,_getPrototypeOf2(b).apply(this,arguments))}return _inherits2(b,a),_createClass2(b,[{key:"_onActivate",value:function(){this._initOnce(),this.scrollBar=new _WA74.ui.ScrollBar({source:_DomUtil36.getSelector(".im-settings")}),this.scrollBar.sync(),this.switchPane("settingsPaneCommon")}},{key:"_onDeactivate",value:function(){this.closePane(),this.scrollBar.destroy(),this.scrollBar=null}},{key:"_initOnce",value:function(){if(!this.__inited){this.__inited=!0;var a=this.pageEl=_DomUtil36.getSelector(".im-settings");this.updateWidget(),_WA74.RTCTools.isEnabled()||a.getSelector(".imButton[data-action=settingsPaneMedia]").hide(),this._selfProfile=new _WA74.SelfProfilePage,this._selfProfile.backClick.on(this._onPaneBack,this),this._pane=new _WA74.SettingOptionsPage,this._pane.backClick.on(this._onPaneBack,this),a.on("click",this._onMenuClick,this),a.on("contextmenu",this._onContextmenu,this)}}},{key:"openPane",value:function(a){_WA74.splitView?this.switchPane(a):App.forceLoad("settingOptions",{pane:a})}},{key:"switchPane",value:function(a){_WA74.splitView&&(a&&(this._activePane=a,"settingsProfile"===a?_WA74.Pane.openPageBox(this._selfProfile,null,!0):_WA74.Pane.openPageBox(this._pane,{pane:a},!0)),this._updateMenu())}},{key:"closePane",value:function(){_WA74.splitView&&this._activePane&&(delete this._activePane,_WA74.Pane.closeBox(!0))}},{key:"_updateMenu",value:function(){var a;do a=this.pageEl.getSelector("."+ACTIVE_MENU_ITEM_CLS),a&&a.removeClass(ACTIVE_MENU_ITEM_CLS);while(a);if(this._activePane){var b=this._activePane;"settingsPaneSessionList"===b&&(b="settingsPaneSecurity"),this.pageEl.getSelector(".imButton[data-action="+b+"]").addClass(ACTIVE_MENU_ITEM_CLS)}}},{key:"_onPaneBack",value:function(){"settingsPaneSessionList"===this._activePane?this.switchPane("settingsPaneSecurity"):(this.closePane(),_WA74.ma.switchTab("recent"))}},{key:"_onContextmenu",value:function(a){var b=a.getTarget(!0).up("imButton"),c=b&&b.getAttribute("data-action");if(c&&"copyNick"===c){var d={shareProfile:!0};_WA74.clipboardSupported&&(d.copyProfileLink=!0,d.copyNickname=_WA74.ACTIVE_IS_UIN,d.copyEmail=!d.copyNickname),_WA74.contextMenu.show(a,d,{uNick:_WA74.DialogsAbstraction.uNick},function(a,b){var c=_WA74.ACTIVE_IS_UIN?_WA74.urlBuilder.profileLink(_WA74.DialogsAbstraction.uNick):_WA74.urlBuilder.emailLink(_WA74.ACTIVE_MAIL);switch(b){case"copyNickname":_U61.Selection.copy2clipboard("@"+_WA74.DialogsAbstraction.uNick),_WA74.showPopup(_WA74.tr("msgNickCopied"));break;case"copyEmail":_U61.Selection.copy2clipboard(_WA74.ACTIVE_MAIL),_WA74.showPopup(_WA74.tr("msgEmailCopied"));break;case"copyProfileLink":_U61.Selection.copy2clipboard(c),_WA74.showPopup(_WA74.tr("msgLinkCopied"));break;case"shareProfile":_WA74.ma.dialogsWindow.forwardMessage(_WA74.ACTIVE_MAIL,_WA74.DialogsAbstraction.nick,c,!0)}}),a.stopEvent()}}},{key:"_onMenuClick",value:function(a){var b=a.getTarget(!0).up("imButton"),c=b&&b.getAttribute("data-action");switch(c){case"copyNick":_U61.Selection.copy2clipboard(_WA74.ACTIVE_IS_UIN?"@"+_WA74.DialogsAbstraction.uNick:_WA74.ACTIVE_MAIL),_WA74.showPopup(_WA74.ACTIVE_IS_UIN?_WA74.tr("msgNickCopied"):_WA74.tr("msgEmailCopied"));break;case"addNick":this._selfProfile.editField("uNick");break;case"settingsProfile":_WA74.splitView?this.switchPane(c):App.load("selfProfile");break;case"favoriteDialog":_WA74.ma.openDialog([_WA74.ACTIVE_MAIL]),_WA74.splitView&&_WA74.ma.switchTab("recent");break;case"settingsPaneCommon":case"settingsPaneNotify":case"settingsPaneTheme":case"settingsPaneSecurity":case"settingsPaneMedia":case"settingsPaneInfo":this.openPane(c)}}},{key:"updateWidget",value:function(){var a=_DomUtil36.get("imSettingsWidget"),b=_WA74.Ava.make(_WA74.ACTIVE_MAIL,_WA74.DialogsAbstraction.nick,52,null,{official:_WA74.DialogsAbstraction.official}),c=_WA74.Emoji.parse(_U61.String.htmlEntity(_WA74.DialogsAbstraction.nick||_WA74.ACTIVE_MAIL)),d=_WA74.DialogsAbstraction.uNick?"@"+_U61.String.htmlEntity(_WA74.DialogsAbstraction.uNick):"";_WA74.ACTIVE_IS_UIN||(d=_U61.String.htmlEntity(_WA74.ACTIVE_MAIL)),a.first().updateHTML(b);var e=a.first().next();e.first().updateHTML(c),e.last().updateHTML(d||_WA74.tr("profile.inputNickname")).setAttribute("data-action",d?"copyNick":"addNick")}}]),b}(_Activatable6);_WA74.SettingsPage=SettingsPage;var _WA75=WebIM,_UI42=_WA75.ui;_WA75.LiveChats={showChatProfileDialog:function(a,b,c){this.chatProfileDialog&&this.chatProfileDialog.hide(),this.chatProfileDialog=new _UI42.LiveChatModalBox(a),this.chatProfileDialog.actionEvent.on(this.onActionEvent,this),c&&this.chatProfileDialog.showEvent.on(c),b&&this.chatProfileDialog.hideEvent.on(b),this.chatProfileDialog.show()},joinChat:function(a,b){console.log("IM:LiveChats:joinChat:stamp="+a),
_WA75.overlayScreen.show(_WA75.tr("chat.pleaseWait"),!0);var c=!0;_WA75.overlayScreen.hideEvent.on(function(){c=!1},null,{single:!0}),_WA75.rapi.joinChat({stamp:a},function(a,d,e){c&&_WA75.overlayScreen.hide(),b&&b(e)}.bind(this))},showMemberList:function(a,b){var c={email:a,type:b};this._memberList||(this._memberList=new _WA75.MemberListPage),_WA75.splitView?_WA75.Pane.openPageBox(this._memberList,c):App.load("memberlist",c,this._memberList)},showChatProfile:function(a,b){var c=this,d=a.sn,e=a.stamp,f=function g(a,b,f,h){(a===d||h&&0===h.indexOf(e))&&(_WA75.overlayScreen.hide(),_WA75.chatController.infoReadyEvent.un(g),b?c.chatProfileDialog&&c.chatProfileDialog.isVisible()?(c.chatProfileDialog.updateItem(f),_WA75.chatController.infoReadyEvent.on(g)):c.showChatProfileDialog(f,function(){_WA75.chatController.infoReadyEvent.un(g)},function(){_WA75.chatController.infoReadyEvent.on(g)}):4e4===f?_WA75.showPopup(_WA75.tr("msgNoProfileWithThisNick")):40002===f&&_WA75.showPopup(_WA75.tr("group.youAreBannedInGroup")))};_WA75.overlayScreen.show(_WA75.tr("chat.pleaseWait"),!0),_WA75.chatController.infoReadyEvent.on(f),e?_WA75.chatController.getChatInfoByStamp(e,5,!b):_WA75.chatController.getChatInfo(d,5,!b)},onContactListUpdate:function(){if(this.chatProfileDialog&&this.chatProfileDialog.isVisible()){var a=this.chatProfileDialog.chatItem,b=_WA75.CLD.inList(a.sn)||a.you&&a.you.role&&!a.you.pending;this.chatProfileDialog.block.toggleClass("im-livechat-inlist",!!b)}},onActionEvent:function(a,b){var c=this;if(b)if(_WA75.CLD.inList(b.sn)&&b.you&&b.you.role&&!b.you.pending)this.chatProfileDialog.hide(),_WA75.ma.openDialog(_WA75.makeContactArray(b.sn,b.name));else if(b.stamp)return this.joinChat(b.stamp,function(a){c.chatProfileDialog&&(20001===a?c.chatProfileDialog.block.addClass("im-livechat-pending"):(c.chatProfileDialog.hide(),_WA75.ma.openDialog(_WA75.makeContactArray(b.sn,b.name))))}),!1}};var _WA76=WebIM,_UI43=_WA76.ui,_U62=_WA76.util,ContactAbstraction=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.updateEvent=new _U62.Event,a.addSuccessEvent=new _U62.Event,a.myInfoEvent=new _U62.Event,a._profiles={},a._uniqs={},a._waiting={},a._waitingId={},a._addHistory={},a._abCache={},a.muteEvent=new _U62.Event,a.removeEvent=new _U62.Event,a.spamEvent=new _U62.Event,a.blockEvent=new _U62.Event,a.unblockEvent=new _U62.Event,a.messageEvent=new _U62.Event,a.renameEvent=new _U62.Event,a._contactListDiffEvent=new _U62.Event,a}return _inherits2(b,a),_createClass2(b,[{key:"_requestUserProfile",value:function(a){this.__search={sn:a};var b=this.__search._uniq=_WA76.rapi.getUserInfo({sn:a},function(a,c,d,e){e||this._onConnectionWp({error:a?"server":"network",uniq:b})},this);return this._uniqs[b]=!0,b}},{key:"openReadableGroup",value:function(a){return new Promise(function(b,c){var d=_WA76.chatController.getChatSnByStamp(a);console.log("IM:CA:openReadableGroup: stamp="+a+" sn="+d+" inCL="+_WA76.CLD.inList(d)),d&&_WA76.CLD.inList(d)?(_WA76.Api.postEventToParent("chatInfoLoaded"),_WA76.ma.openDialog(_WA76.CLD.getInfoArray(d)),b()):_WA76.chatController.getChatInfoByStamp(a,5,!0,function(a,d,e,f){e&&(f["public"]||f.live)?(console.log("IM:CA:openReadableGroup: got chatInfo: sn="+f.sn+" inCL="+_WA76.CLD.inList(f.sn)),_WA76.Api.postEventToParent("chatInfoLoaded"),_WA76.Api.setFixedChatSn(f.sn),_WA76.Feature.getModeParameter("boardAutoJoin")&&_WA76.LiveChats.joinChat(d),_WA76.ma.openDialog([f.sn,f.name]),b()):(console.log("IM:CA:openReadableGroup: failed getChatInfo"),_WA76.Api.postEventToParent("chatInfoLoadingError"),c())})})}},{key:"openDialogById",value:function(a){return new Promise(function(b,c){if(_WA76.CLD.inList(a)){var d=_WA76.CLD.getInfoArray(a);_WA76.ma.openDialog(d),b({contact:d})}else _WA76.rapi.getIdInfo(a,function(d,e,f){var g=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(g&&g.user&&g.user.sn){var h=_WA76.CLD.getInfoArray(g.user.sn)||[g.user.sn,g.user.friendly];_WA76.ma.openDialog(h),b({contact:h})}else if(g&&g.chat)if(g.chat.stamp&&_WA76.chatController.saveChatStamp(g.chat.sn,g.chat.stamp),_WA76.CLD.inList(g.chat.sn)){var i=_WA76.CLD.getInfoArray(g.chat.sn);_WA76.ma.openDialog(i),b({contact:i})}else g.chat.stamp?(_WA76.overlayScreen.show(_WA76.tr("chat.pleaseWait"),!0),_WA76.chatController.getChatInfoByStamp(g.chat.stamp,1,!0,function(a,c,d,e){_WA76.overlayScreen.hide(),d&&e&&(e.you&&e.you.role||!e.joinModeration&&e["public"]?(_WA76.ma.openDialog([e.sn,e.name]),b({contact:[e.sn,e.name],info:e})):(_WA76.LiveChats.showChatProfile(e,!0),b({info:e})))})):(_WA76.LiveChats.showChatProfile({sn:a}),b({info:g.chat}));else _WA76.showPopup(_WA76.tr("msgNoProfileWithThisNick")),c()})})}},{key:"openProfileById",value:function(a){var b=this;_WA76.rapi.getIdInfo(a,function(a,c,d,e){var f=e||{};f.user&&f.user.sn?b.openProfile(f.user.sn,f.user.friendly):f.chat&&(f.chat.stamp&&_WA76.chatController.saveChatStamp(f.chat.sn,f.chat.stamp),_WA76.LiveChats.showChatProfile({stamp:f.chat.stamp}))})}},{key:"getContactInfoById",value:function(a){var b=this;return new Promise(function(c,d){b._waitingId[a]?b._waitingId[a].push({resolve:c,reject:d}):(b._waitingId[a]=[{resolve:c,reject:d}],_WA76.rapi.getIdInfo(a,function(c,d,e,f){var g=f.chat||f.user||null;b._waitingId[a].forEach(function(a){g?a.resolve(f.chat):a.reject[1]()}),delete b._waitingId[a]}))})}},{key:"getUserProfile",value:function(a,b,c){if(this._profiles[a]&&!c)b(this._profiles[a]);else{if(!this._waiting[a]){var d=this._requestUserProfile(a);this._waiting[a]={uniq:d,callbacks:[]}}this._waiting[a].callbacks.push(b)}}},{key:"updateProfile",value:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;_WA76.wimApi.updateProfile(a,b,c)}},{key:"getAbData",value:function(a,b){var c=this;return this._abCache[a]?void(b&&b(a,this._abCache[a])):void _WA76.CLD.getAbInfo(a,function(d){d&&(c._abCache[a]=d,b&&b(a,d))})}},{key:"searchByPhone",value:function(a,b){this._searchCallback=b,this._searchPhone!==a&&(this._searchReqId=_WA76.rapi.search({phonenum:a},function(a){200!==a&&this._searchCallback===b&&(this._searchCallback(!1),this._searchPhone=this._searchCallback=null)},this),this._searchPhone=a)}},{key:"_prepareDataItem",value:function(a){var b=a.anketa||{},c=b.firstName?[b.firstName]:[];return c=c.concat(b.lastName?[b.lastName]:[]).join(" "),b.friendly=(b.friendly||"").trim(),[a.sn,c||b.friendly]}},{key:"_invokeWaitings",value:function(a){var b=this;Object.keys(this._waiting).forEach(function(c){a===b._waiting[c].uniq&&(b._waiting[c].callbacks.forEach(function(a){a(b._profiles[c])}),delete b._waiting[c])})}},{key:"_addSuccess",value:function(a){var b=this.__getNick(a);this.addSuccessEvent.fire(a,b),delete this._addHistory[a]}},{key:"_collectProfiles",value:function(a){var b=this;a.forEach(function(a){b._profiles[a.email]?_U62.Object.extend(b._profiles[a.email],a,!0):b._profiles[a.email]=a,a.bot&&_WA76.CLD.saveBot(a.email)})}},{key:"_onConnectionMyInfo",value:function(a){this.myInfoEvent.fire(a)}},{key:"_onConnectionContactAddFail",value:function(a){if(this._addHistory[a.email])switch(a.message){case"exists":this._addSuccess(a.email);break;case"ignored":_WA76.wimApi.ignoreContact({email:a.email,unignore:1}),this._addSuccess(a.email)}}},{key:"_onConnectionContactAddSuccess",value:function(a){_WA76.MainAgent.isChat(a.email)||this._addSuccess(a.email)}},{key:"_onConnectionSearch",value:function(a){if(this._searchReqId===a.requestParams.reqId&&(delete this._searchReqId,delete this._searchPhone,this._searchCallback)){var b=this._searchCallback;delete this._searchCallback,b(a.data&&a.data.length?this._prepareDataItem(a.data[0]):!1)}}},{key:"_onConnectionWp",value:function(a){var b=this;this._collectProfiles(a&&a.result||[]),a&&a.uniq&&this._uniqs[a.uniq]&&(delete this._uniqs[a.uniq],a.result?this._invokeWaitings(a.uniq):"network"===a.error?_WA76.setTimeout(function(){b._requestUserProfile(b.__search.sn)},5e3):this._invokeWaitings(a.uniq))}},{key:"_onConnectionContactListDiff",value:function(a){console.log("@!@!_onConnectionContactListDiff",a),this._contactListDiffEvent.fire(a)}},{key:"__getNick",value:function(a){return this._addHistory[a]?this._addHistory[a].nick:""}},{key:"getContactArrayFromProfiles",value:function(a,b){if(this._profiles[a]){var c=_U62.Object.extend({email:a,nick:b},this._profiles[a],!0);return c.nick=c.nick||c.friendly,_WA76.contactToArray(c)}return null}},{key:"addNewContactByPhone",value:function(a,b,c){var d,e,f=this,g=function(){f._contactListDiffEvent.un(h);var g=!1,i=_WA76.tr("auth.msgCommonError");!e||d&&d.buddy.aimId===a?i=_WA76.tr("cl.contactIsNotExist",{name:_U62.String.htmlEntity(b),phone:_U62.String.htmlEntity(a),product:_WA76.PRODUCT_TITLE}):d&&"updated"===d.patchType||e&&_WA76.CLD.inList(e)?(i=_WA76.tr("dialog.youAddToCL",[_U62.String.htmlEntity(b)]),g=!0):d&&"created"===d.patchType&&(i=_WA76.tr("dialog.youAddToCL",[_U62.String.htmlEntity(b)]),g=!0),c&&c(g,i,b,e)},h=function i(c){f._contactListDiffEvent.un(i),d=_U62.Array.findBy(c,function(c){var d=c.patchType,e=c.buddy,f=e.abPhones,g=e.friendly;return("created"===d||"updated"===d)&&g===b&&_U62.Array.indexOfBy(f,function(b){var c=b.number;return c===a})>-1?!0:void 0}),e&&g()};this.searchByPhone(a,function(a){e=a&&a[_WA76.contactMapKeys.email],(d||!e||_WA76.CLD.inList(e))&&g()}),this._contactListDiffEvent.on(h),_WA76.rapi.addContactByPhone({phone:a,name:b},function(a,b,d){c&&2e4!==d&&c(!1)},this)}},{key:"mute",value:function(a,b){_WA76.wimApi.muteContact({sn:a,mute:+b}),this.muteEvent.fire(a,+b)}},{key:"openProfile",value:function(a,b){var c={sn:a,friendly:b};_WA76.InfoPanel.openOnce(c)}},{key:"openDialog",value:function(a,b){if(!_WA76.splitView){var c=App.indexOfPage("dialog",!0);if(c>-1){var d=App.getPage(c);d&&d.context&&d.context.mail===a&&App.showPage(c)}}var e=_WA76.CLD.getInfoArray(a)||this.getContactArrayFromProfiles(a,b);_WA76.ma.openDialog(e||[a,b])}},{key:"doAction",value:function(a,b,c,d){var e=this;if("reportSpam"===a){var f=new _UI43.BanModalBox({nick:c,spamOnly:!0,onEditOk:function(c){e._onActionConfirmed(a,b,c,d)}});f.show()}else if("banContact"===a)new _UI43.BanModalBox({nick:c,spamOnly:!1,onEditOk:function(a){"block"===a?e._onActionConfirmed("blockContact",b,null,d):e._onActionConfirmed("reportSpam",b,a,d)}}).show();else if("blockContact"===a){var g=new _UI43.ConfirmModalBox({content:_WA76.tr("box.ignoreContact"),buttons:[{action:"cancel",text:_WA76.tr("box.cancel")},{action:"ok",text:_WA76.tr("box.ignore"),cls:"im-button_highlight"}],onOk:function(){e._onActionConfirmed(a,b,null,d)}});g.show()}else if("unblockContact"===a)_UI43.showConfirmBox(_WA76.tr("box.unignoreContact"),function(){e._onActionConfirmed(a,b,null,d)});else if("removeContact"===a){var h=new _UI43.ConfirmModalBox({content:_WA76.tr("box.removeUser",{nick:_WA76.Emoji.parse(_U62.String.htmlEntity(c||b))}),buttons:[{action:"cancel",text:_WA76.tr("box.cancel")},{action:"ok",text:_WA76.tr("box.remove"),cls:"im-button_highlight"}],onOk:function(){e._onActionConfirmed(a,b,null,d)}});h.show()}}},{key:"_onActionConfirmed",value:function(a,b,c,d){var e=this;switch(a){case"blockContact":_WA76.wimApi.ignoreContact({email:b}),this.blockEvent.fire(b);break;case"unblockContact":_WA76.wimApi.ignoreContact({email:b,unignore:1},function(a){a&&e.unblockEvent.fire(b)});break;case"reportSpam":_WA76.rapi.reportAbuse({sn:b,context:_WA76.MainAgent.isChat(b)?"groupChat":"profile",reason:c||"spam",msgId:"",msgText:""}),this.spamEvent.fire(b,c);break;case"removeContact":this.removeEvent.fire(b)}d&&d()}}]),b}(_WA76.conn.ES6ConnectionRoster);_WA76.contactAbstraction=new ContactAbstraction;var _WA77=WebIM,_U63=_WA77.util,_stopEventOnCountryPage=function(a){a.getTarget(!0).up("im-countrypage")&&a.stopEvent()},AddContactDialog=function(a){function b(a){var c;_classCallCheck2(this,b);var d={blockCls:"im-add-contact",title:_WA77.tr("cl.newContact"),buttons:[{action:"cancel",text:_WA77.tr("dialog.tools.cancel")},{action:"ok",text:_WA77.tr("dialog.tools.add"),cls:"im-button_highlight"}],content:_WA77.TD.getTMPL("addContactForm"),destroyOnHide:!1};return c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,d)),c._doNotDestroyOnHide=!1,c.renameEvent=new _U63.Event,c.contactAbstraction=a,c.phoneField=new _WA77.PhoneField,c.phoneField.inputEvent.on(c._checkSubmit,_assertThisInitialized2(_assertThisInitialized2(c))),c}return _inherits2(b,a),_createClass2(b,[{key:"show",value:function(a){var c=this;return this._presetData=null,a&&(this._presetData=a,this._presetData.phone)?void this.phoneField.presetPhone(this._presetData.phone,function(){_get2(_getPrototypeOf2(b.prototype),"show",c).call(c)}):void _get2(_getPrototypeOf2(b.prototype),"show",this).call(this)}},{key:"hide",value:function(){this._presetData=null,_get2(_getPrototypeOf2(b.prototype),"hide",this).call(this)}},{key:"_onShow",value:function(){_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),this.block.updateHTML(this._getContentHtml()),this.body=this.el.getSelector(".im-modal-box__body"),this.nameInput=this.body.getSelector("input"),this.block.addClass("im-new-contact__disabled"),this._presetData&&(this.nameInput.dom.value=this._presetData.name,this._presetData=null),this.phoneField.bind(this.block.getSelector(".im-new-contact__phone-block"),this.block),this.nameInput.on("input",this._onNameInput,this),this.nameInput.dom.focus()}},{key:"_onHide",value:function(){this.phoneField.unbind(),this.nameInput.un("input",this._onNameInput,this),_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this),this._doNotDestroyOnHide||this.destroy(),this._doNotDestroyOnHide=!1}},{key:"_checkName",value:function(){return(this.nameInput.dom.value||"").match(/\S/)}},{key:"_checkSubmit",value:function(){this.block.toggleClass("im-new-contact__disabled",!this._checkName()||!this.phoneField.isValid())}},{key:"_onNameInput",value:function(){this._checkName()&&this.nameInput.removeClass("im-new-contact__name-empty"),this._checkSubmit()}},{key:"_getDataOnOkPressed",value:function(){var a=!this.phoneField.isValid();if(this._checkName()||(this.nameInput.addClass("im-new-contact__name-empty"),a=!0),a)return!1;var b=this.phoneField.getPhone(),c=((this.nameInput.dom.value||"")+" "+(this.nameInput.next().dom.value||"")).replace(/^\s+|\s+$/g,"");return{name:c,phone:b}}},{key:"_onOk",value:function(a){var b=this;a&&this.contactAbstraction.addNewContactByPhone(a.phone,a.name,function(a,c){if(b.isVisible())if(b._doNotDestroyOnHide=!a,b.hide(),a)_WA77.showPopup(c);else{var d=!1,e=new _WA77.ui.ConfirmModalBox({content:c,cls:"im-contact-not-found",buttons:[{action:"cancel",text:_WA77.tr("box.close")},{action:"ok",text:_WA77.tr("cl.addAnother"),cls:"im-button_highlight"}],onOk:function(){d=!0}});e.hideEvent.on(function(){d?b.show():b.destroy()}),e.show()}})}},{key:"_onClick",value:function(a){var b=this;if(a.up("im-new-contact__code")){var c={onClick:function(a){var c=b.body.getSelector(".im-new-contact__code");c&&c.updateText("+"+a)}};this.countryPage||(this.countryPage=new _WA77.CountryPage,this.block.on("click",_stopEventOnCountryPage)),this.countryPage.openInBlock(this.block,c)}else{var d=a.up("imButton"),e=d&&d.getAttribute("data-action");if("ok"===e){var f=this._getDataOnOkPressed();return this._onOk(f),!1}e&&(this.actionEvent.fire(e),this.hide())}}},{key:"destroy",value:function(){this._presetData=null,this.renameEvent.removeAll(),this.phoneField.destroy(),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_WA77.ui.ConfirmModalBox);_WA77.AddContactDialog=AddContactDialog;var _WA78=WebIM,_U64=_WA78.util,FAVORITE_KEY_WORDS=["избранное","сохраненное","сохранить","favorite","storage"],CONTACT_PRIVATE_FIELDS_MAP={sortKey:1},CONTACT_FIELDS=["email","nick","needAuth","status","statusTitle","lastseen","onlineTime","mute","sortKey","official","iconId","autoadded","blocked","uNick","stranger","userState","bot"],CONTACT_FIELDS_MAP={},_Activatable8=_WA78.Activatable,approximateWeekAgoTs=_WA78.now()-_WA78.WEEK;_U64.Array.each(CONTACT_FIELDS,function(a,b){CONTACT_FIELDS_MAP[a]=b}),_WA78.contactMap=CONTACT_FIELDS,_WA78.contactMapKeys=CONTACT_FIELDS_MAP,_WA78.contactPrivateKeys=CONTACT_PRIVATE_FIELDS_MAP,_WA78.makeContactArray=function(a,b,c){return[a,b,!!c,""]},_WA78.contactToArray=function(a,b){return b||(b=[]),_U64.Array.each(CONTACT_FIELDS,function(c,d){a.hasOwnProperty(c)&&(b[d]=a[c])}),b.length=Math.max(CONTACT_FIELDS.length,b.length),b},_WA78.contactToHash=function(a,b){return b||(b={}),_U64.Array.each(a,function(a,c){CONTACT_FIELDS[c]&&!CONTACT_PRIVATE_FIELDS_MAP[CONTACT_FIELDS[c]]&&void 0!==a&&(b[CONTACT_FIELDS[c]]=a)}),b};var limitRate=function(a,b,c){c=c||this;var d,e,f,g,h=0;return function(){f=+new Date,e=f-h,e>b?(a.apply(c,arguments),h=f):(d&&d.stop(),g=b-e,d=new _U64.DelayedTask({fn:function(){a.apply(c,arguments),h=+new Date},scope:c,interval:g}),d.start())}},buddyToContact=function(a,b){var c=a.aimId;return{email:c,nick:a.friendly||a.abContactName,needAuth:!1,status:"",statusTitle:"",lastseen:a.lastseen,onlineTime:a.onlineTime,userState:a.userState,bot:a.bot,mute:a.mute&&1,official:a.official||0,iconId:a.largeIconId||0,autoadded:!!a.autoAddition,blocked:b[c],stranger:CLData.getStranger(c),uNick:a.nick}},_transformGroupsToContactList=function(a,b){var c={},d=[];return _WA78.CLD.dropMutes(),_U64.Array.each(a,function(a){_U64.Array.each(a.buddies,function(e){if(!c[e.aimId]&&(c[e.aimId]=1,0!==e.aimId.indexOf("+")))if("Temporarily"!==a.name||e.autoAddition){var f=buddyToContact(e,b||{}),g=_WA78.contactToArray(f);d.push(g)}else _WA78.CLD.saveMute(e.aimId,e.mute)})}),d},ContactListData=function(){function a(){_classCallCheck2(this,a),this._data={},this._blockedUsers={},this._blockedIsReady=!1,this._mutes={},this._friendlyNames={},this._strangers={},_WA78.ConnectionFacade.triggerEvent.on(this._onConnectionTriggerEvent,this)}return _createClass2(a,[{key:"_onConnectionTriggerEvent",value:function(a,b){"contactStatus"===a&&(this.abData||(this.abData={}),this.abData[b.email]={abName:b.abContactName,abPhone:b.abPhoneNumber})}},{key:"updateAllData",value:function(a){var b,c=a.length;for(b=0;c>b;b++)CLData.setData(a[b][0],a[b])}},{key:"blockedIsReady",value:function(){return this._blockedIsReady}},{key:"updateBlocked",value:function(a){this._blockedUsers=a||{},this._blockedIsReady=!0}},{key:"updateData",value:function(a,b){var c=this._data[a];c&&b.forEach(function(a,b){c[b]=a})}},{key:"removeItem",value:function(a){delete this._data[a]}},{key:"setData",value:function(a,b){var c=this._friendlyNames[a];this._data[a]=b,this._mutes[a]=b[CONTACT_FIELDS_MAP.mute],b[CONTACT_FIELDS_MAP.stranger]&&(this._strangers[a]=1),!b[CONTACT_FIELDS_MAP.nick]&&c&&(b[CONTACT_FIELDS_MAP.nick]=c),b[CONTACT_FIELDS_MAP.nick]&&(this._friendlyNames[a]=b[CONTACT_FIELDS_MAP.nick])}},{key:"inList",value:function(a){return!!this._data[a]}},{key:"isAutoadded",value:function(a){return this._data[a]&&this._data[a][CONTACT_FIELDS_MAP.autoadded]}},{key:"isBlocked",value:function(a){return this._data[a]&&this._data[a][CONTACT_FIELDS_MAP.blocked]||this._blockedUsers[a]}},{key:"dropData",value:function(){this._data={}}},{key:"getInfo",value:function(a){var b=this._data[a];return b&&(b=_WA78.contactToHash(b),b.status=""),b||{}}},{key:"getInfoArray",value:function(a){var b=this._data[a]||null;return b&&(b=[b[0],b[1],b[2],""].concat(b.slice(4))),b}},{key:"getAbInfo",value:function(a,b){return this.abData&&this.abData[a]?(b&&b(this.abData[a]),this.abData[a]):void 0}},{key:"dropMutes",value:function(){this._mutes={}}},{key:"saveMute",value:function(a,b){b?this._mutes[a]=1:delete this._mutes[a]}},{key:"getMute",value:function(a){return this._data[a]?this._data[a][CONTACT_FIELDS_MAP.mute]:this._mutes[a]}},{key:"getFriendlyName",value:function(a){return this._data[a]&&this._data[a][CONTACT_FIELDS_MAP.nick]||this._friendlyNames[a]||""}},{key:"getUNick",value:function(a){return this._data[a]&&this._data[a][CONTACT_FIELDS_MAP.uNick]}},{key:"getLastseen",value:function(a){var b=this._data[a]&&this._data[a][CONTACT_FIELDS_MAP.lastseen];return 0===b||b>0?b:null}},{key:"getUserState",value:function(a){return this._data[a]&&this._data[a][CONTACT_FIELDS_MAP.userState]}},{key:"getAuthStatus",value:function(a){return this._data[a]&&{needAuth:this._data[a][CONTACT_FIELDS_MAP.needAuth],status:this._data[a][CONTACT_FIELDS_MAP.status]}}},{key:"saveFriendly",value:function(a,b){return this._friendlyNames[a]=b,this._data[a]&&this._data[a][CONTACT_FIELDS_MAP.nick]!==b?(this._data[a][CONTACT_FIELDS_MAP.nick]=b,!0):void 0}},{key:"saveStranger",value:function(a,b){return!!this._strangers[a]!=!!b?(b?this._strangers[a]=1:delete this._strangers[a],!0):!1}},{key:"getStranger",value:function(a){return this._strangers[a]?1:0}},{key:"getIconId",value:function(a){return this._data[a]&&this._data[a][CONTACT_FIELDS_MAP.iconId]}},{key:"setIconId",value:function(a,b){return this._data[a]&&this._data[a][CONTACT_FIELDS_MAP.iconId]!==b?(this._data[a][CONTACT_FIELDS_MAP.iconId]=b,!0):!1}},{key:"getLastseenMessage",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c={blocked:!0,absent:!0},d=b.userState,e="";return b.bot?e=_WA78.tr("status.bot"):c[d]?e=_WA78.tr("status."+d):a>0?e=_U64.Date.formatLastSeenData(a):0===a&&(e='<span class="im-online-status">'+_WA78.tr("status.online")+"</span>"),e}},{key:"isOfficial",value:function(a){return this._data[a]&&this._data[a][CONTACT_FIELDS_MAP.official]}},{key:"isBot",value:function(a){return this._data[a]&&this._data[a][CONTACT_FIELDS_MAP.bot]}},{key:"saveBot",value:function(a){this._data[a]&&(this._data[a][CONTACT_FIELDS_MAP.bot]=1)}}]),a}(),CONTACT_SORT_REGEX="ru"===_WA78.resLanguage?[/[а-яА-Я]/,/[a-zA-Z]/]:[/[a-zA-Z]/,/[а-яА-Я]/],CompareManager={_data:{},getKey:function(a){var b=a[0],c=this._data[b],d=a[1]||b;return b===_WA78.ACTIVE_MAIL&&(c||(d=_WA78.tr("dialog.favorite"),c=this._getContactIndex([a[0],d])+d.toLowerCase()+"_"+d+"_"+b,c=c+"_"+a[1]+"_"+FAVORITE_KEY_WORDS.join("_"),this._data[b]=c)),c||(c=""+this._getContactIndex(a)+d.toLowerCase()+"_"+d+"_"+b,this._data[b]=c),c},resetKey:function(a){delete this._data[a]},_getContactIndex:function(a){var b=(a[CONTACT_FIELDS_MAP.nick]||a[CONTACT_FIELDS_MAP.email]).charAt(0),c=3;return CONTACT_SORT_REGEX.some(function(a,d){return a.test(b)?(c=d+1,!0):void 0}),c}},AbstractData=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.data=null,a.loadEvent=(new _U64.Event).globalize("cListLoaded"),a.updateActivityEvent=new _U64.Event,_WA78.ChangeLog.updateEvent.on(a._onChangeLogUpdate,_assertThisInitialized2(_assertThisInitialized2(a))),a}return _inherits2(b,a),_createClass2(b,[{key:"_onUpdateActivity",value:function(){this.updateActivityEvent.fire()}},{key:"_onActivate",value:function(){this.loadEvent.resume()}},{key:"_onDeactivate",value:function(){this.data=null,this.loadEvent.suspend()}},{key:"getRange",value:function(a,b){this.requestParams={from:a,to:b},this.isActive()&&_WA78.isNumber(a)&&_WA78.isNumber(b)&&this._onGetRange()}},{key:"_onGetRange",value:function(){_WA78.abstractError()}},{key:"_sortContactList",value:function(a){var b,c,d,e,f=(+new Date,a.length),g=[];for(a=a.sort(),d=0;f>d;d++)e=a[d][0],b=1,c=a[d][1]||e,g[d]=b+c.toLowerCase()+"_"+d;g=g.sort();var h=[];return _U64.Array.each(g,function(b){var c=b.split("_"),d=c[c.length-1];h.push(a[d])}),h}},{key:"_applyChangeLogTo",value:function(a,b){var c=!1,d=[];return b.length>0&&(_U64.Array.each(b,function(b){if(CompareManager.resetKey(b.email),"remove"===b.action){var d=_U64.Array.indexOfBy(a,function(a){return a[0]===b.email});-1!==d&&(a.splice(d,1),c=!0)}}),this.data=a,_U64.Array.each(a,function(a){var e=a[0],f=_U64.Array.indexOfBy(b,function(b){var d=b.email===e;return d&&b.action?("rename"===b.action&&(a[1]=b.nick||b.email,c=!0),"add"===b.action&&(b.action=null),!1):d});-1!==f&&(b[f].needAuth=0,a[2]&&(d.push(a),c=!0),a=_WA78.contactToArray(b[f],a))},this),_U64.Array.each(b,function(b){"add"===b.action&&(b.needAuth=1,a.push(_WA78.contactToArray(b)),c=!0)})),c&&d.length&&(this._needUpdateCList=d),c}},{key:"_fireLoadEvent",value:function(a,b,c){return this.loadEvent.fire(this,a,b,c)}},{key:"_onChangeLogUpdate",value:function(a){this.data&&(this._applyChangeLogTo(this.data,a)&&(this.data=this._sortContactList(this.data)),this._initVisibleData(this.data,this.data.length))}},{key:"_sliceListData",value:function(a,b,c){var d=Math.min(c,a.length),e=_U64.Array.filter(a,function(a){return!_WA78.CLD.getStranger(a[0])});return e.slice(b,d)}},{key:"_initVisibleData",value:function(a,b,c){var d=this.requestParams;if(d){var e=this._sliceListData(a,d.from,d.to);if(b>this.visibleLength&&(b=this.visibleLength),c){var f=!1;if(_U64.Array.each(e,function(a){return _U64.Array.indexOf(c,a[0])>-1?(f=!0,!1):void 0}),!f)return}this._fireLoadEvent(e,b,this.visibleLength)}}},{key:"destroy",value:function(){this.loadEvent.removeAll(),this.loadEvent=null,_WA78.ChangeLog.updateEvent.un(this._onChangeLogUpdate,this)}}]),b}(_Activatable8),RemoteData=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a._prefix="clist_",a._clistReceivedEvent=new _U64.Event,a.data=null,a.fullLength=null,a.visibleLength=null,a.chatInfo={},a.selfContactData={},a._requestedMails={},a._requestedUniqs={},_WA78.ConnectionFacade.triggerEvent.on(a._onConnectionTriggerEvent,_assertThisInitialized2(_assertThisInitialized2(a))),_WA78.ConnectionFacade.afterResponseEvent.on(a._onAfterConnectionResponse,_assertThisInitialized2(_assertThisInitialized2(a))),a}return _inherits2(b,a),_createClass2(b,[{key:"_sortContactList",value:function(a,b){var c,d,e=[],f={},g=-1;for(a=a.slice(0),c=a.length,d=0;c>d;d++)e[d]=CompareManager.getKey(a[d]),f[e[d]]=d,a[d][CONTACT_FIELDS_MAP.email]===_WA78.ACTIVE_MAIL&&(g=d);if(!b&&-1===g){var h=_WA78.contactToArray({email:_WA78.ACTIVE_MAIL,nick:_WA78.DialogsAbstraction.nick,uNick:_WA78.DialogsAbstraction.uNick});g=a.length,e[g]=CompareManager.getKey(h),f[e[g]]=g,a[g]=h,CLData.setData(h[0],h)}e.sort();var i=[];if(_U64.Array.each(e,function(b){var c=a[f[b]];c[CONTACT_FIELDS_MAP.sortKey]=b,i.push(c)}),this._needUpdateCList){var j=this._needUpdateCList;this._needUpdateCList=null,_WA78.setTimeout(function(){_U64.Array.each(j,function(a){_WA78.ChangeLog.logAction("auth",{email:a[0]})})},1,this)}return i}},{key:"_onDeactivate",value:function(){this.fullLength=null,this.visibleLength=null,_get2(_getPrototypeOf2(b.prototype),"_onDeactivate",this).call(this)}},{key:"isReady",value:function(){return _WA78.isArray(this.data)&&_WA78.isNumber(this.fullLength)}},{key:"_onAfterConnectionResponse",value:function(){var a=this;if(this._newContactList){var b=_transformGroupsToContactList(this._newContactList,this._ignored),c=this._sortContactList(b);this._saveListToStorage(c,c.length,function(){this._saveLocalListData(c,c.length),this._clistReceivedEvent.fire(c)})}else if(this._contactListDiff){if(this.buddyList){var d={},e=[];this._contactListDiff.forEach(function(b){var c=b.patchType,f=b.buddy;if("deleted"===c)d[f.aimId]=!0,CLData.removeItem(f.aimId);else{var g=a._ignored||{};if(!a._ignored){var h=CLData.getInfoArray(f.aimId)||[];h&&h[CONTACT_FIELDS_MAP.blocked]&&(g[f.aimId]=!0)}var i=_WA78.contactToArray(buddyToContact(f,g));CLData.inList(f.aimId)?CLData.updateData(f.aimId,i):e.push(i)}});var f=this.buddyList.filter(function(a){return!d[a[0]]}).concat(e),g=this._sortContactList(f);this._saveListToStorage(g,g.length,function(){this._saveLocalListData(g,g.length),this._clistReceivedEvent.fire(g)})}}else if(this.__strangerUpdated&&this.buddyList){this.buddyList.forEach(function(a){!a[CONTACT_FIELDS_MAP.stranger]!=!_WA78.CLD.getStranger(a[0])&&(a[CONTACT_FIELDS_MAP.stranger]=_WA78.CLD.getStranger(a[0]))});var h=this._sortContactList(this.buddyList);this._saveListToStorage(h,h.length,function(){a._saveLocalListData(h,h.length),a._clistReceivedEvent.fire(h)})}this._newContactList=null,this._contactListDiff=null,delete this.__strangerUpdated}},{key:"_updateIgnored",value:function(a){this.buddyList.forEach(function(b){b[CONTACT_FIELDS_MAP.blocked]=a[b[CONTACT_FIELDS_MAP.email]]});var b=this._sortContactList(this.buddyList);this._saveListToStorage(b,b.length,function(){this._saveLocalListData(b,b.length),this._clistReceivedEvent.fire(b)})}},{key:"_onConnectionTriggerEvent",value:function(a,b){var c=this;if("contactListDiff"===a)this._contactListDiff=b;else if("contactList"===a)this._newContactList=b;else if("ignoreList"===a)this._ignored={},b.forEach(function(a){var b=a.sn;c._ignored[b]=!0}),_WA78.CLD.updateBlocked(this._ignored),this._newContactList||(this.buddyList?this._updateIgnored(this._ignored||{}):this._clistReceivedEvent.fire(null));else if("contactStatus"===a){if(b.sn&&b.largeIconId){var d=CLData.getIconId(b.sn)||"0";b.largeIconId!==d&&b.sn!==_WA78.ACTIVE_MAIL&&CLData.setIconId(b.sn,b.largeIconId)&&(_WA78.Ava.updateLastModified(b.email,b.largeIconId),this.isReady()&&(this._initVisibleData(this.data,this.fullLength),this._trySaveCurrentListToStorage()))}}else if("historyState"===a&&(_WA78.CLD.saveStranger(b.sn,b.stranger)&&(this.__strangerUpdated=!0),b.persons)){var e;_U64.Array.each(b.persons,function(a){a.friendly&&CLData.saveFriendly(a.sn,a.friendly)&&(e=!0)}),e&&this.isReady()&&(this._initVisibleData(this.data,this.fullLength),this._trySaveCurrentListToStorage())}}},{key:"_getListFromStorage",value:function(a){var b=this;_WA78.Sys.loadContactList(function(c,d){a.call(b,c,d)})}},{key:"_saveListToStorage",value:function(a,b,c){var d=this;_WA78.Sys.saveContactList(a,b,function(){c&&c.call(d)})}},{key:"_setFilterFunction",value:function(a){var b=0,c=a.length;return function(d){for(b=0;c>b;b++)if(!a[b](d))return!1;return!0}}},{key:"_initVisibleData",value:function(a,c,d){a=this._sortContactList(a,!0),c=a.length;var e=[];if(e.length){var f=[],g=this._setFilterFunction(e);_U64.Array.indexOfBy(a,function(a){g(a)&&f.push(a)}),f.length>0?_get2(_getPrototypeOf2(b.prototype),"_initVisibleData",this).call(this,f,f.length):_get2(_getPrototypeOf2(b.prototype),"_initVisibleData",this).call(this,a,c)}else _get2(_getPrototypeOf2(b.prototype),"_initVisibleData",this).call(this,a,c,d)}},{key:"_saveLocalListData",value:function(a){this.buddyList=a,this.data=a.filter(function(a){return!a[CONTACT_FIELDS_MAP.blocked]}),this.fullLength=this.data.length,CLData.updateAllData(this.buddyList);var b=this.data.length;this.data.forEach(function(a){_WA78.CLD.getStranger(a[0])&&b--}),this.visibleLength=b,this._initVisibleData(this.data,this.fullLength)}},{key:"_onGetRange",value:function(){this.isReady()?this._initVisibleData(this.data,this.data.length):this._getListFromStorage(function(a,b){this.isReady()||a&&_WA78.isNumber(a.length)&&this._saveLocalListData(a,b)})}},{key:"_trySaveCurrentListToStorage",value:function(){var a=this._sortContactList(this.buddyList||[]);this._saveListToStorage(a,this.buddyList&&this.buddyList.length||0)}},{key:"_onChangeLogUpdate",value:function(a){if(this.isReady()&&a.length>0){var b=[];if(this._applyChangeLogTo(this.data,a)){var c=this._sortContactList(this.data);this.data=c,b=_U64.Array.transform(a,function(a){return a.email})}_U64.Array.each(a,function(a){"remove"===a.action?this.fullLength--:"add"===a.action&&this.fullLength++},this),CLData.updateAllData(this.buddyList),this._initVisibleData(this.data,this.fullLength,b),this._trySaveCurrentListToStorage()}else a.length&&_U64.Array.each(a,function(a){CompareManager.resetKey(a.email)})}},{key:"getContactsInfo",value:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(this.isReady()||c.instantly){var d=[],e=CLData._data;_U64.Array.each(a,function(a){if(e[a])if(c.raw)d.push(a);else{var b=e[a].slice(0);b[3]="",d.push(b)}}),b(d)}else this.loadEvent.on(function(){this.getContactsInfo(a,b,c)},this,{single:!0})}},{key:"reloadList",value:function(){this.isReady()&&this._initVisibleData(this.data,this.fullLength);
}},{key:"getFullData",value:function(a,b){if(this.isReady()){var c=[];return b?c=this._sortContactList(this.data):"function"==typeof a?_U64.Array.each(this.data,function(b){a(b)&&c.push(b)}):_U64.Array.each(this.data,function(a){c.push(a)}),c}}},{key:"destroy",value:function(){}}]),b}(AbstractData),CLData=_WA78.CLD=new ContactListData,ContactListAbstraction=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.loadEvent=new _U64.Event,a.countEvent=new _U64.Event,a.remoteData=new RemoteData,a.remoteData.loadEvent.on(a._onRemoteDataLoad,_assertThisInitialized2(_assertThisInitialized2(a))),a.contactDataReceivedEvent=(new _U64.Event).relay(a.remoteData._clistReceivedEvent),a.remoteData.updateActivityEvent.on(a._onUpdateActivity,_assertThisInitialized2(_assertThisInitialized2(a))),_WA78.ConnectionFacade.triggerEvent.on(a._onConnectionTriggerEvent,_assertThisInitialized2(_assertThisInitialized2(a))),a.limitRateReloadList=limitRate(function(){this.reloadList()},1500,_assertThisInitialized2(_assertThisInitialized2(a))),a}return _inherits2(b,a),_createClass2(b,[{key:"_onActivate",value:function(){this.loadEvent.resume(),this.countEvent.resume(),"undefined"!=typeof this.__onlineCount__&&(this.countEvent.fire(this.__onlineCount__,this.__totalCount__),delete this.__onlineCount__,delete this.__totalCount__),this.remoteData.activate()}},{key:"_onDeactivate",value:function(){this.loadEvent.suspend(),this.countEvent.suspend(),this.remoteData.deactivate()}},{key:"_onUpdateActivity",value:function(){this.limitRateReloadList()}},{key:"_onRemoteDataLoad",value:function(a,b,c){this.loadEvent.fire(b,c,this.remoteData.visibleLength)}},{key:"_onConnectionTriggerEvent",value:function(a,b){return this.isActive()?("contactListState"===a&&this.countEvent.fire(parseInt(b.onlineCount),parseInt(b.totalCount)),void("contactAddSuccess"===a&&_WA78.MainAgent.isChat(b.email)&&this.addContact(b.email,b.nickname))):void("contactListState"===a&&(this.__onlineCount__=parseInt(b.onlineCount),this.__totalCount__=parseInt(b.totalCount)))}},{key:"getList",value:function(a,b){this.remoteData.getRange(a,b)}},{key:"getFullData",value:function(a,b){return this.remoteData.getFullData(a,b)}},{key:"reloadList",value:function(){this.remoteData.reloadList()}},{key:"removeContact",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=function(c,d){c?(_WA78.ChangeLog.logAction("remove",{email:a}),_WA78.isFunction(b.success)&&b.success.call(b.scope||this,a,d)):_WA78.isFunction(b.failure)&&b.failure.call(b.scope||this,a,d)};_WA78.wimApi.removeContact({email:a},c,this)}},{key:"renameContact",value:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},d=function(d,e){d?(_WA78.ChangeLog.logAction("rename",{email:a,nickname:b}),_WA78.isFunction(c.success)&&c.success.call(c.scope||this,a,e)):_WA78.isFunction(c.failure)&&c.failure.call(c.scope||this,a,e)};_WA78.wimApi.modifyContact({email:a,nickname:b},d,this)}},{key:"updateSelfContactData",value:function(a){this.remoteData.selfContactData=_U64.Object.extend(this.remoteData.selfContactData,a),a.nick&&CLData.saveFriendly(_WA78.ACTIVE_MAIL,a.nick)}},{key:"addContact",value:function(a,b,c,d){var e={email:a,nickname:b};c&&(e.tel=c),d&&(this.remoteData.chatInfo[a]=d),_WA78.ChangeLog.logAction("add",e)}},{key:"getContactsInfo",value:function(a,b,c){this.remoteData.getContactsInfo(a,b,c)}},{key:"waitForReady",value:function(){var a=this;return new Promise(function(b){a.remoteData.isReady()?b():a.loadEvent.on(function(){b()},a,{single:!0})})}}]),b}(_Activatable8);_WA78.ContactListAbstraction=ContactListAbstraction;var _WA79=WebIM,_U65=_WA79.util,_UI44=_WA79.ui,_TD25=_WA79.TemplateDriver,DEFAULT_ITEM_HEIGHT=60,PRERENDER_SCREENS_COUNT=7,TOP_LIST_SEPARATE_ITEM=["_TOP_",_WA79.tr("search.restContacts")],_Activatable11=_WA79.Activatable,_DomUtil37=_WA79.DomUtil,prepareArrayContactItem=function(a,b,c,d){var e=a[_WA79.contactMapKeys.email],f=!1,g="",h=_WA79.CLD.getLastseenMessage(a[_WA79.contactMapKeys.lastseen],{userState:a[_WA79.contactMapKeys.userState],bot:a[_WA79.contactMapKeys.bot]});0!==a[_WA79.contactMapKeys.lastseen]||a[_WA79.contactMapKeys.userState]||a[_WA79.contactMapKeys.bot]||(f=!0);var i=e===_WA79.ACTIVE_MAIL,j=a[_WA79.contactMapKeys.nick]||_WA79.CLD.getFriendlyName(e);a[_WA79.contactMapKeys.nick]=j;var k=_U65.String.htmlEntity(a[_WA79.contactMapKeys.uNick]||""),l=[];i&&d&&(l.push("im-cl-contact_self"),j=_WA79.tr("dialog.favorite"));var m=_WA79.Ava.make(e,j,32,null,{isFavorite:d,official:!!a[_WA79.contactMapKeys.official],mute:!!a[_WA79.contactMapKeys.mute],online:f});return j=_U65.String.htmlEntity(j||e),f&&l.push("im-cl-contact_online"),a[_WA79.contactMapKeys.official]&&l.push("im-cl-contact_official"),{email:_U65.String.htmlEntity(e),nick:j,vNick:_WA79.Emoji.parse(j),uNick:k,status:g,subTitle:h,time:(a[_WA79.contactMapKeys.lastseen]||0)+","+(a[_WA79.contactMapKeys.onlineTime]||0),mute:a[_WA79.contactMapKeys.mute]||"",classes:l.join(" "),avatarHtml:m,idx:b,offset:c}},ContactListView=function(a){function b(a){var c;return _classCallCheck2(this,b),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),c.__isActive=!1,c.uid=a.uid||"",c.applyItemEvent=new _U65.Event,c.renderedData={},c.bound=!1,c._canDestroyScrollBar=!1,c._updateItemData=function(){},c._itemHeight=DEFAULT_ITEM_HEIGHT,c.itemTemplates={},c.itemTemplate=new _UI44.TemplateRenderer,c.configure(a),c.offsetChecker=new _U65.DelayedTask({interval:100,fn:function(){c._checkOffset(),c.offsetChecker.start()}}),c}return _inherits2(b,a),_createClass2(b,[{key:"activate",value:function(a){return this._toggle(a,!0)}},{key:"deactivate",value:function(a){return this._toggle(a,!1)}},{key:"isActive",value:function(){return this.__isActive===!0}},{key:"_toggle",value:function(a,b){var c=!1;return this.__isActive!==b&&(this.__isActive=b,c=this[b?"_onActivate":"_onDeactivate"](a)!==!1),c}},{key:"configure",value:function(a){a=this.initConfig=a||{},this._getList=a.getList,this.dynamicListLength=a.dynamicListLength||this.dynamicListLength||null,this._getListScope=a.getListScope||this._getListScope,this.selectable=!!a.selectable&&_WA79.isDesktop,this.loopNavigation=!!a.loopNavigation&&this.selectable,this._itemHeight=a.itemHeight||this._itemHeight||DEFAULT_ITEM_HEIGHT,this._buildItemData=a.buildItem||prepareArrayContactItem,this._updateSearchItem=a.updateSearchItem||b.updateSearchItem,this._updateItemData=a.prepareItem||this._updateItemData,this._buildEntryBundle=a.buildEntryBundle||function(){},this._separatorTpl=a.separatorTpl||this._separatorTpl||"",this.__updateItemDataScope=a.prepareItemScope||this.__updateItemDataScope,this._templates=a.templates,this._prerenderScreens=a.prerenderScreens||PRERENDER_SCREENS_COUNT,this.showFavorite=a.showFavorite,a.itemTmpl&&this.itemTemplate.setTemplate(a.itemTmpl)}},{key:"bindListView",value:function(a,b,c){this.el=a,this.contentEl=b,this.scrollBar=c,this.scrollBar||(this.scrollBar=new _UI44.ScrollBar({source:this.el}),this._canDestroyScrollBar=!0),this.selectable&&this.contentEl.on("mousemove",this._onMouseMove,this),this.bound=!0}},{key:"unbindListView",value:function(){this.deactivate(),this._canDestroyScrollBar&&this.scrollBar.destroy(),this._canDestroyScrollBar=!1,this.contentEl&&this.contentEl.un("mousemove",this._onMouseMove,this),this.scrollBar=this.contentEl=this.el=null,this.bound=!1}},{key:"_checkOffset",value:function(){if(this._getList&&this.contentEl&&this._itemHeight&&this.contentEl.dom.offsetWidth){var a,b,c=this.el.dom.scrollTop,d=this.el.dom.offsetHeight,e=c+d,f=c!==this._top,g=this._top>-1&&f,h=!1;if(this._scrolling!==g&&(f=!0),d!==this._height||f){_WA79.resizeableLayout&&d!==this._height&&(this._height=d,this._blockSize=Math.ceil(d/this._itemHeight),this._blockHeight=this._blockSize*this._itemHeight,h=!0),this._scrolling=g;var i=Math.ceil(e/this._blockHeight)-1;a=i-this._prerenderScreens,b=i+this._prerenderScreens+1,0>a&&(a=0);var j=Math.abs((this._from||0)-a),k=Math.abs((this._to||0)-b),l=Math.floor(this._prerenderScreens/2);(j>=l||k>=l)&&(h=!0),this._top=c,h&&(this._from=a,this._to=b,this._contactsOffset=a*this._blockHeight,this._getList.call(this._getListScope||this,a*this._blockSize,b*this._blockSize,this.renderList,this))}}}},{key:"_prepareItem",value:function(a,b,c){var d=this._buildItemData(a,b,c,this.showFavorite);return this.searchQuery&&this._updateSearchItem(d,this.searchQuery,this.initConfig.highlightQuery!==!1),d}},{key:"renderList",value:function(a,b,c){if(a){var d=[];b||(b=a.length),this.renderedData={visibleArea:a,listLength:b,options:c},this._currentEntryOffset=this._contactsOffset;var e=0;if(_U65.Array.each(a,function(a,b){if(a.entryType){d[d.length]=this._buildEntryHTML(a.entryType,a.entryData,b,this._currentEntryOffset,c);var f=this._itemHeight;this._currentEntryOffset+=f,e+=f}else if("_TOP_"===a[0]){var g=this.searchQuery?0:this._contactsOffset+b*this._itemHeight,h=this.searchQuery?"im-search-results__item":"";d[d.length]=_TD25.parseString(this._separatorTpl,[g,a[1],h])}else{var i=this._prepareItem(a,b,this._contactsOffset+b*this._itemHeight);i=this._updateItemData.call(this.__updateItemDataScope||this,i,a,b,this)||i,"string"==typeof i?d[d.length]=i:d[d.length]=this.itemTemplate.renderHTML(i)}},this),d=d.join(""),this._clistLength!==b||this.dynamicListLength){this._clistLength=b;var f=this.dynamicListLength?this.dynamicListLength():0;this.contentEl&&this._itemHeight&&(this.contentEl.dom.style.height=this._itemHeight*this._clistLength+"px"),f&&this.el&&this._itemHeight&&(!this.contentEl||this._clistLength>f?this.el.parent().dom.style.height=this._itemHeight*f+"px":this.el.parent().dom.style.height=this.contentEl.dom.offsetHeight+"px")}var g=this.contentEl||this.el;if(g.dom.innerHTML!==d){var h=this._selectedItem&&this._selectedItem.getAttribute("data-idx")||-1,i=this._selectedItem&&this._selectedItem.getAttribute("data-abs-idx")||-1;if(g.updateHTML(d),this.selectable){var j;i>-1&&(j=g.getSelector('div[data-abs-idx="'+i+'"]')),j||(j=h>-1?g.dom.childNodes[h]:null),j?this._selectItem(_DomUtil37.get(j),!0):c&&c.from||this.selectFirstItem(!0)}this.scrollBar.sync()}}}},{key:"_buildEntryHTML",value:function(a,b,c,d,e){var f,g,h,i="";return h=this._templates[a],h&&!this.itemTemplates[a]&&(this.itemTemplates[a]=new _UI44.TemplateRenderer,this.itemTemplates[a].setTemplate(h)),g=this.itemTemplates[a],f=this._buildEntryBundle(a,b,c,d,this,e),i="string"==typeof f?f:g.renderHTML(f)}},{key:"refresh",value:function(){this.bound&&this.renderedData.visibleArea&&this.renderedData.listLength&&this.contentEl&&this.contentEl.isVisible()&&this.renderList(this.renderedData.visibleArea,this.renderedData.listLength,this.renderedData.options)}},{key:"_resetScroll",value:function(){this.el.dom.scrollTop=0}},{key:"scrollUp",value:function(){this.el?this.el.dom.scrollTop=0:this.contentEl&&(this.contentEl.dom.scrollTop=0),this.scrollBar&&this.scrollBar.sync()}},{key:"isVisible",value:function(){if((this.rendered||this.bound)&&this.el){var a=this.el.createChild({tag:"div",style:"visibility:hidden;width:1px;height:0px;"}),b=a.dom.offsetWidth;return a.remove(),!!b}}},{key:"show",value:function(){this.contentEl?this.contentEl.show():this.setVisible(!0),this.scrollBar.sync()}},{key:"hide",value:function(){this.contentEl?this.contentEl.hide():this.setVisible(!1),this.scrollBar.sync()}},{key:"redraw",value:function(a){this.bound&&(this._height=-1,this.offsetChecker.stop(),this._checkOffset(),this.contentEl&&this._getList&&this._itemHeight?this.offsetChecker.start():a&&this.renderList(a))}},{key:"deselect",value:function(){this._selectedItem&&(this._selectedItem.removeClass("im-list-entry_selected"),this._selectedItem=null)}},{key:"_findNextSelectableNode",value:function(a,b){for(;a;){if(a.getAttribute("data-selectable"))return a;a=b?a.prev():a.next()}return!1}},{key:"selectFirstItem",value:function(a){var b=this._findNextSelectableNode(this.contentEl&&this.contentEl.childAt(0));b&&this._selectItem(b,a)}},{key:"_selectItem",value:function(a,b){if(this.selectable&&!(this._selectedItem&&this._selectedItem.dom===a.dom||(this.deselect(),this._selectedItem=a,a.addClass("im-list-entry_selected"),b))){var c=this.contentEl.dom.offsetTop+a.dom.offsetTop+a.dom.offsetHeight-this.el.dom.offsetHeight;c>=0&&this.el.dom.scrollTop<c?this.el.dom.scrollTop=c:a.dom.offsetTop<this.el.dom.scrollTop&&(this.el.dom.scrollTop=a.dom.offsetTop+this.contentEl.dom.offsetTop),this.scrollBar.sync()}}},{key:"_applyItem",value:function(){if(this._selectedItem){var a=this.applyItemEvent.fire(this._selectedItem);return a&&this.deselect(),!0}return!1}},{key:"navigate",value:function(a){if(this.selectable){var b;switch(a){case"arrowUp":return this._selectedItem&&(b=this._findNextSelectableNode(this._selectedItem.prev(),!0),b&&this._selectItem(b,!1)),!0;case"arrowDown":return this._selectedItem?(b=this._findNextSelectableNode(this._selectedItem.next()),b?this._selectItem(b,!1):this.loopNavigation&&this.deselect()):this.selectFirstItem(),!0;case"enter":return this._applyItem()}return!1}}},{key:"_onItemHover",value:function(a){a=a.up("imSearchEntry"),a&&a.getAttribute("data-selectable")&&this._selectItem(a,!0)}},{key:"_onMouseMove",value:function(a){var b=a.getTarget(!0);(b.hasClass("im-ui-button")>-1||b.parent().hasClass("im-ui-button")>-1)&&this._onItemHover(b)}},{key:"_onUserScroll",value:function(a){}},{key:"_onActivate",value:function(a){this.bound&&(this._checkOffset(),this.selectable?(this.selectFirstItem(),this.el.on("scroll",this._onUserScroll,this)):this.scrollUp(),this.contentEl&&this._getList&&this._itemHeight?this.offsetChecker.start():a&&this.renderList(a))}},{key:"_onDeactivate",value:function(){this.bound&&(this._onScroll&&this.el.un("scroll",this._onScroll),this.el.un("scroll",this._onUserScroll,this),this.offsetChecker.stop(),this._clistLength=-1,this._height=-1,this._top=-1)}}]),b}(_UI44.ES6Component);ContactListView.highlightFoundContact=function(a,b,c,d){var e;return b&&b!==a?d.some(function(a){if(a){var c=b.toLowerCase().indexOf(a.toLowerCase());if(-1!==c)return e=b.substr(0,c)+"<mark>"+b.substr(c,a.length)+"</mark>"+b.substr(c+a.length),!0}}):b=!1,e||(c&&d.some(function(a){if(a){a=a.replace(/^@(.)/,"$1");var b=c.toLowerCase().indexOf(a.toLowerCase());if(-1!==b)return e=c.substr(0,b)+"<mark>"+c.substr(b,a.length)+"</mark>"+c.substr(b+a.length),!0}}),e?e=b?b+' <span class="im-search-sub-result">@'+e+"</span>":"@"+e:_WA79.MainAgent.isChat(a)||(d.some(function(b){if(b){var c=a.toLowerCase().indexOf(b.toLowerCase());if(c>-1)return e=a.substr(0,c)+"<mark>"+a.substr(c,b.length)+"</mark>"+a.substr(c+b.length),!0}}),e&&(e=b?b+' <span class="im-search-sub-result">'+e+"</span>":e))),e||b},ContactListView.updateSearchItem=function(a,b,c){if(a&&a.email){_WA79.isArray(b)||(b=[b]);var d=a.uNick||(_WA79.isUIN(a.email)?a.email:""),e=c?ContactListView.highlightFoundContact(a.email,a.nick,d,b):a.nick;a.vNick=_WA79.Emoji.parse(e),a.classes+=" im-search-results__item"}},ContactListView.prepareArrayContactItem=prepareArrayContactItem,ContactListView.TOP_LIST_SEPARATE_ITEM=TOP_LIST_SEPARATE_ITEM,_WA79.ContactListView=ContactListView;var _WA80=WebIM,_U66=_WA80.util,LINE_HEIGHT=44,_Activatable12=_WA80.Activatable,_DomUtil38=_WA80.DomUtil,nodeToContactArray=function(a){var b=a.getAttribute("status"),c=(a.getAttribute("time")||"").split(",");return _WA80.contactToArray({email:a.getAttribute("mail"),nick:a.getAttribute("nick"),needAuth:0,status:b,statusTitle:"",lastseen:+c[0],onlineTime:+c[1],mute:a.getAttribute("mute")})},ContactListAgent=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.contactSelectEvent=new _U66.Event,a.abstraction=new _WA80.ContactListAbstraction,a.abstraction.loadEvent.on(a._renderList,_assertThisInitialized2(_assertThisInitialized2(a))),a.view=new _WA80.ContactListView({uid:"clist",itemTmpl:_WA80.TD.getTMPL("contactListItem"),itemHeight:LINE_HEIGHT,getList:a.abstraction.getList,getListScope:a.abstraction,showFavorite:!0}),_WA80.ContactListAgent.addContactEvent.on(a.abstraction.addContact,a.abstraction),a.abstraction.contactDataReceivedEvent.on(function(a){_WA80.ContactListAgent.updateEvent.fire(a)},_assertThisInitialized2(_assertThisInitialized2(a))),a}return _inherits2(b,a),_createClass2(b,[{key:"getContactsInfo",value:function(a,b,c){this.abstraction.getContactsInfo(a,b,c)}},{key:"render",value:function(){var a=_DomUtil38.get("imCList");a.on("click",this._onContactClick,this),a.on("contextmenu",this._onContextmenu,this),this.view.bindListView(a,a.first())}},{key:"setSelfNick",value:function(a,b){this.abstraction.updateSelfContactData({nick:a,uNick:b})}},{key:"_onContactClick",value:function(a){if(_WA80.contextMenu.isVisible())return!!a.stopEvent();var b=a.getTarget(!0).up("im-cl-contact");b&&b.getAttribute("mail")&&this._openContact(nodeToContactArray(b))}},{key:"_onContextmenu",value:function(a){var b=a.getTarget(!0),c=b&&b.up("im-cl-contact");if(c){var d=c.getAttribute("mail"),e=_WA80.MainAgent.isChat(d),f={ignore:!0,remove:!_WA80.configurator.getOption("disable_remove_user_button")||e,profile:!e,spam:!e&&!_WA80.configurator.getOption("disable_remove_user_button")};d!==_WA80.ACTIVE_MAIL&&_WA80.contextMenu.show(a,f,{mail:d,nick:c.getAttribute("nick"),contact:nodeToContactArray(c)}),a.stopEvent()}}},{key:"_openContact",value:function(a){this.contactSelectEvent.fire(a)}},{key:"_renderList",value:function(a,b,c){this.view.isActive()&&this.view.renderList(a,b,{fullLength:c})}},{key:"toggleView",value:function(a){a!==this.view.isActive()&&(a?(this.view.activate(),_WA80.Statuses.updateEvent.on(this.view.refresh,this.view)):(this.view.deactivate(),_WA80.Statuses.updateEvent.un(this.view.refresh,this.view)))}},{key:"_onActivate",value:function(){this.abstraction.activate(),this.abstraction.remoteData.isReady()||this.abstraction.getList(0,20)}},{key:"_onDeactivate",value:function(){this.abstraction.deactivate(),this.view.deactivate(),_WA80.Statuses.updateEvent.un(this.view.refresh,this.view)}}]),b}(_Activatable12);_WA80.ContactListAgent=ContactListAgent,_WA80.ContactListAgent.addContactEvent=new _U66.Event,_WA80.ContactListAgent.updateEvent=new _U66.Event,_WA80.ContactListAgent.nodeToContactArray=nodeToContactArray;var _WA81=WebIM,_U67=_WA81.util,MAX=100,SearchDataAbstraction=function(){function a(b,c){_classCallCheck2(this,a),this.data=c,this.requested=!1,this._searchParams=null,this.searchReadyEvent=new _U67.Event,this.searchRequestEvent=new _U67.Event,this.config=_U67.Object.extend({fields:[_WA81.contactMapKeys.nick,_WA81.contactMapKeys.uNick,_WA81.contactMapKeys.email,_WA81.contactMapKeys.sortKey],limit:MAX},b,!0)}return _createClass2(a,[{key:"onDataReceived",value:function(a){if(this.requested=!1,this.data=a,this._searchParams){var b=this._searchParams.query,c=this._searchParams.cb,d=this._searchParams.scope;this._searchParams=null,this.search(b,c,d)}}},{key:"sendDataRequest",value:function(){this.requested=!0}},{key:"checkItem",value:function(a,b){var c=this.config.fields,d=!1;return c.some(function(c){var e=a[c];if(e){if(c===_WA81.contactMapKeys.email)if(_WA81.isUIN(e)){if(a[_WA81.contactMapKeys.uNick])return}else if(e.indexOf("@chat.agent")>0)return;if(e=e.toLowerCase(),b.some(function(a){return-1!==e.indexOf(a)?(d=!0,!0):void 0}),d)return!0}}),d}},{key:"search",value:function(a,b,c){var d=this;if(a)if(this.data){_WA81.isArray(a)&&(a=a[0]);var e,f=a.toLowerCase(),g=_U67.KeyMapping.translate(f),h=_U67.KeyMapping.transliterate(f),i=this.data,j={},k=[],l=[],m=0,n=this.config.fields,o=this.config.limit===!1?-1:this.config.limit||MAX;_U67.Array.each(i,function(a){return m===o?!1:void _U67.Array.each(n,function(b){if(e=a[b]){if(b===_WA81.contactMapKeys.email){if(_WA81.isUIN(e)){if(a[_WA81.contactMapKeys.uNick])return;f.length>1&&0===f.indexOf("@")&&(e="@"+e)}else if(e.indexOf("@chat.agent")>0)return}else b===_WA81.contactMapKeys.uNick&&f.length>1&&0===f.indexOf("@")&&(e="@"+e);if(e=e.toLowerCase(),-1!==e.indexOf(f)||-1!==e.indexOf(h))return k.push(a),j[a[_WA81.contactMapKeys.email]]=!0,m++,!1;if(-1!==e.indexOf(g))return l.push(a),j[a[_WA81.contactMapKeys.email]]=!0,m++,!1}})}),k=k.concat(l);var p,q,r=!1;this.config.remoteSearch||this.config.remoteSearchAsync?(q=_WA81.MultiSearch.remoteSearch(a).then(function(b){b=b&&b.resultData;var c=!1;if(b&&(b.chats||b.data)){var e={};if(b.chats&&(e.chats=b.chats.filter(function(a){return!j[a[_WA81.contactMapKeys.email]]})),b.data&&(e.data=b.data.filter(function(a){return!j[a[_WA81.contactMapKeys.email]]})),c=e.data&&e.data.length||e.chats&&e.chats.length,d.config.remoteSearchHandler)k=d.config.remoteSearchHandler(e,k,a,[a,h,g]);else if(e.data){var f;(f=k).splice.apply(f,[k.length-l.length,0].concat(_toConsumableArray2(e.data)))}}return r=!0,!!c}),p=this.config.remoteSearchAsync&&k.length?Promise.resolve():q):p=Promise.resolve();var s=function(){var e=k.slice(0);"function"==typeof b&&b.call(c||null,e,a),d.searchReadyEvent.fire(e,a,[a,h,g])};p.then(function(){d.config.remoteSearchAsync&&!r&&q.then(function(a){a&&s()}),s()})}else this._searchParams={query:a,cb:b,scope:c},this.sendDataRequest(),this.searchRequestEvent.fire()}},{key:"destroy",value:function(){this.searchReadyEvent.removeAll(),this.searchRequestEvent.removeAll()}}]),a}();_WA81.SearchDataAbstraction=SearchDataAbstraction;var _WA82=WebIM,_U68=_WA82.util,_Activatable14=_WA82.Activatable,SEARCH_DELAY=500,_CACHE_LIVE_TIME=3e4,APPROXIMATE_VISIBLE_SYMBOLS_IN_RESULT=60,MAX_RENDERED_SYMBOLS_IN_RESULT=100,globalCache={},cacheCleaner=new _U68.DelayedTask({interval:_CACHE_LIVE_TIME,fn:function(){var a={},b=_WA82.now();for(var c in globalCache)globalCache.hasOwnProperty(c)&&b-globalCache[c].timestamp>_CACHE_LIVE_TIME&&(a[c]=globalCache[c]);globalCache=a,cacheCleaner.start()}}),_trimFriendlyName=function(a){return(a||"").trim()},_highlightMessageContent=function(a,b){var c,d,e,f,g,h,i,j="",k=a,l=0;if(b&&b.length){for(f=b.join("|").replace(/([.\[\](){}\\])/g,"\\$1"),g=new RegExp("(?:^|[^а-яА-ЯA-Za-z0-9])("+f+")");null!=(i=g.exec(k));)d=i.index+(i[0].length-i[1].length),e=i[1].length,h=d+e-APPROXIMATE_VISIBLE_SYMBOLS_IN_RESULT,0===l&&h>0&&(k=k.substr(h),d-=h,c=!0),j=j+k.substr(0,d)+"<mark>"+k.substr(d,e)+"</mark>",k=k.substr(d+e,MAX_RENDERED_SYMBOLS_IN_RESULT),l++;j=(c?"&hellip;":"")+j+(l>0?k:"")}return j},friendlyNames={},chatMembersCounts={},RemoteContactSearchAbstraction=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a._searchTimer=null,a._chatsData={},a._requested={},a}return _inherits2(b,a),_createClass2(b,[{key:"startSearch",value:function(a){var b=this;return this._requested[a]||(this._requested[a]=new Promise(function(c){b._searchTimer&&(clearTimeout(b._searchTimer),b._searchTimer=null),globalCache[a]?(delete b._requested[a],c(globalCache[a])):b._searchTimer=_WA82.setTimeout(function(){b._searchTimer=null,_WA82.rapi.search({keyword:a},function(d,e,f,g){200===d&&b._makeResultData(g,a),delete b._requested[a],c(globalCache[a])})},SEARCH_DELAY)})),this._requested[a]}},{key:"prepareDataItem",value:function(a){var b=a.anketa||{},c=b.firstName?[b.firstName]:[];c=c.concat(b.lastName?[b.lastName]:[]).join(" "),b.friendly=_trimFriendlyName(b.friendly);var d=[a.sn,b.friendly||c];return d[1]!==b.friendly&&b.friendly&&(friendlyNames[a.sn]=b.friendly),b.nickname&&(d[_WA82.contactMapKeys.uNick]=b.nickname),d}},{key:"prepareChatItem",value:function(a){var b=[a.sn,a.name];return chatMembersCounts[a.sn]=a.membersCount,this._chatsData[a.sn]=a,b}},{key:"getChatItem",value:function(a){return this._chatsData[a]}},{key:"_updateGlobalCache",value:function(a,b,c){cacheCleaner.isStarted()||cacheCleaner.start(),globalCache[b]&&globalCache[b].reqTag===a?(c.data&&c.data.length&&(globalCache[b].resultData.data=(globalCache[b].resultData.data||[]).concat(c.data)),c.chats&&c.chats.length&&(globalCache[b].resultData.chats=(globalCache[b].resultData.chats||[]).concat(c.chats)),globalCache[b].reqTag=a,globalCache[b].timestamp=_WA82.now()):globalCache[b]={resultData:c,reqTag:a,timestamp:_WA82.now()}}},{key:"_makeResultData",value:function(a,b){var c={};a&&(a.data&&(c.data=a.data.map(this.prepareDataItem.bind(this))),a.chats&&(c.chats=a.chats.map(this.prepareChatItem.bind(this))),this._updateGlobalCache(a.newTag,b,c))}}]),b}(_WA82.conn.ES6ConnectionRoster),ContactSearchAbstraction=function(a){function b(a){var c;return _classCallCheck2(this,b),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a)),c.searchReadyEvent.on(c._saveSearchResultData,_assertThisInitialized2(_assertThisInitialized2(c))),c.multiSearchReadyEvent=new _U68.Event,c.remoteAbstraction=new RemoteContactSearchAbstraction,c}return _inherits2(b,a),_createClass2(b,[{key:"search",value:function(a){var c=this;this._searchParams={query:a},this._serverResult=null,this.updateData(),_get2(_getPrototypeOf2(b.prototype),"search",this).call(this,a),this.remoteAbstraction.startSearch(a).then(function(b){b||(b={}),c.onRemoteSearchUpdate(b.resultData,a)})}},{key:"onRemoteSearchUpdate",value:function(a,b){this._searchResult&&a&&this._searchParams&&this._searchParams.query===b&&(this._serverResult=this._serverResult||{},a.data&&a.data.length&&(this._serverResult.data=(this._serverResult.data||[]).concat(a.data)),a.chats&&a.chats.length&&(this._serverResult.chats=(this._serverResult.chats||[]).concat(a.chats)),this.multiSearchReadyEvent.fire(this._concatLocalAndRemoteData(),this._searchParams.queryList||this._searchParams.query,!0))}},{key:"getChatItem",value:function(a){return this.remoteAbstraction.getChatItem(a)}},{key:"stopSearch",value:function(){this._searchParams=this._searchResult=this._serverResult=null}},{key:"updateData",value:function(){var a=_WA82.ma.contactList.abstraction.getFullData(),b=_WA82.ma.dialogsWindow.getRecentData(),c=b.recent,d=b.recentKeys;this.data=c.concat(a.filter(function(a){return!d[a[0]]}));var e=_U68.Array.indexOfBy(this.data,function(a){return a[0]===_WA82.ACTIVE_MAIL});e>-1&&this.data.unshift(this.data.splice(e,1)[0])}},{key:"_concatLocalAndRemoteData",value:function(){var a,b={chats:(this._searchResult||[]).slice(0)},c={};return _U68.Array.each(b.chats,function(a){c[a[0]]=!0}),this._serverResult&&(this._serverResult.data&&(a=[],_U68.Array.each(this._serverResult.data,function(b){c[b[0]]||a.push(b)}),a.length&&(b.chats=b.chats.concat(a))),this._serverResult.chats&&(a=[],_U68.Array.each(this._serverResult.chats,function(b){c[b[0]]||a.push(b)}),a.length&&(b.global=(b.global||[]).concat(a)))),b}},{key:"_saveSearchResultData",value:function(a,b,c){this._searchResult=a,this._searchParams&&(this._searchParams.queryList=c),this.multiSearchReadyEvent.fire(this._concatLocalAndRemoteData(),c||b)}},{key:"destroy",value:function(){this.multiSearchReadyEvent.removeAll(),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_WA82.SearchDataAbstraction),MultiSearch=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.foundData=null,a.viewState={},a.notFound=_WA82.TD.getTMPL("searchNothingFound"),a.dialogSearch=_WA82.DialogSearchAbstraction.getInstance(),a.dialogSearch.searchReadyEvent.on(a._onDialogSearchResult,_assertThisInitialized2(_assertThisInitialized2(a))),a.contactSearch=new ContactSearchAbstraction({limit:!1}),a.contactSearch.multiSearchReadyEvent.on(a._onContactSearchResult,_assertThisInitialized2(_assertThisInitialized2(a))),a.stateChangeEvent=new _U68.Event,a.itemSelectEvent=new _U68.Event,a.itemClickEvent=new _U68.Event,a.listView=new _WA82.ui.InfiniteListView({uid:"multisearch",prerenderScreens:4,selectable:!0,templates:{title:_WA82.TD.getTMPL("searchTitleItem"),contact:_WA82.TD.getTMPL("searchContactItem"),message:_WA82.TD.getTMPL("searchMessageItem")},buildEntryBundle:a.buildListEntry.bind(_assertThisInitialized2(_assertThisInitialized2(a)))}),a.listView.checkpointEvent.on(a._onCheckpointPassed,_assertThisInitialized2(_assertThisInitialized2(a))),a.listView.applyItemEvent.on(a._onItemSelect,_assertThisInitialized2(_assertThisInitialized2(a))),a.listView.requestNextPageEvent&&a.listView.requestNextPageEvent.on(a._onPageRequest,_assertThisInitialized2(_assertThisInitialized2(a))),a.contactSearch.updateData(),a}return _inherits2(b,a),_createClass2(b,[{key:"_onPageRequest",value:function(){this.dialogSearch.getNextPage()}},{key:"getList",value:function(a,b,c,d){var e=this.foundData;this.oneDialogMode?(c.call(d,e.slice(a,b)||[],e.length,{from:a,to:b}),b>=e.length&&this.dialogSearch.getNextPage()):e&&c.call(d,e.slice(a,b)||[],e.length)}},{key:"_renderNextPage",value:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1;if(this.isActive())if(this.stateChangeEvent.fire(this.viewState),a&&(this.renderedItemsCount=0,this.listView.reset()),this.foundData){this.hideSpinner(),this.listView.isActive()||this.listView.activate();var d=this.foundData.slice(this.renderedItemsCount);this.renderedItemsCount=this.foundData.length,this.listView.renderNextDataBundle(d,b)}else c&&(this.hideSpinner(),this.listView.deactivate(),this.resultsEl.updateHTML(this.notFound).setStyle("height","100%"))}},{key:"_onDialogSearchResult",value:function(a){var b=a.messages,c=[],d=a.count;_U68.Array.each(b,function(a){c.push({entryType:"message",entryData:a})});var e=!this.foundData||0===this.foundData.length;this.viewState.messagesCount=d||0,a.firstPage&&d>0&&c.unshift({entryType:"title",entryData:{text:_WA82.tr("search.messages")+": "+d,anchor:"message"}}),this.foundData=(this.foundData||[]).concat(c),this.foundData.length||(this.foundData=null),this.isActive()&&(this._renderNextPage(e,!a.nextCursor,!0),this.listView.setCheckpoint("imSearchAnchor_message"))}},{key:"_onContactSearchResult",value:function(a,b,c){a=a||{},this.listView.resetCheckpoint(),this.queryList=b,this.drawChatsData(a.chats||[],b),this.drawGlobalData(a.global||[],b),c&&this.dialogSearch.search({keyword:this.query})}},{key:"drawChatsData",value:function(a,b){var c=a.length,d=[];this.viewState.chatsCount=c||0,b&&c>0&&a.unshift(_WA82.tr("search.chats")+": "+c),_U68.Array.each(a,function(a){"string"==typeof a?d.push({entryType:"title",entryData:{text:a,anchor:"chats"}}):d.push({entryType:"contact",entryData:a})},this),this.foundData=d.length?d:null,this.isActive()&&(this._renderNextPage(!0,!0),this.listView.setCheckpoint("imSearchAnchor_chats"))}},{key:"drawGlobalData",value:function(a,b){var c=a.length,d=[];this.viewState.globalCount=c||0,b&&c>0&&a.unshift(_WA82.tr("search.global")+": "+c),_U68.Array.each(a,function(a){"string"==typeof a?d.push({entryType:"title",entryData:{text:a,anchor:"global"}}):d.push({entryType:"contact",entryData:a})},this);var e=!this.foundData||0===this.foundData.length;this.foundData=(this.foundData||[]).concat(d),this.foundData.length||(this.foundData=null),this.isActive()&&(this._renderNextPage(e,!0),this.listView.setCheckpoint("imSearchAnchor_global"))}},{key:"bindView",value:function(a){this.el||(this.el=a,this.resultsEl=a.createChild({tag:"div",cls:"im-multisearch-results im-search-results_infinite",style:"display:none"}),this.spinnerEl=a.createChild({tag:"div",cls:"im-multisearch-spinner"}),this.scrollBar=new _WA82.ui.ScrollBar({source:a}),this.listView.bindListView(a,this.resultsEl,this.scrollBar),this.el.on("click",this._onClick,this),this.el.on("contextmenu",this._onContextmenu,this))}},{key:"unbindView",value:function(){this.stopSearch(),this.el&&(this.el.un("click",this._onClick,this),this.el.un("contextmenu",this._onContextmenu,this),this.scrollBar.destroy(),delete this.resultsEl,delete this.el,delete this.scrollBar),this.listView.unbindListView()}},{key:"scrollUp",value:function(a){a?this.listView.scrollUp("imSearchAnchor_"+a):this.listView.scrollUp()}},{key:"navigate",value:function(a){return this.listView.navigate(a)}},{key:"_onCheckpointPassed",value:function(a,b,c){this.viewState.lastPassedAnchor=c&&c.replace("imSearchAnchor_",""),
this.stateChangeEvent.fire(this.viewState)}},{key:"_onItemSelect",value:function(a){return a&&this.selectEntry(a),!1}},{key:"_onActivate",value:function(){this.oneDialogMode=null,this.listView.activate()}},{key:"_onDeactivate",value:function(){this.hideSpinner(),this.dialogSearch.reset(),this.viewState={},this.selectedItem=null,this.query=null,this.foundData=null,this.oneDialogMode=null,this.listView.deactivate(),this.el&&(this.listView.scrollUp(),this.listView.hide()),this.contactSearch.stopSearch()}},{key:"showSpinner",value:function(){this.spinnerEl.updateHTML(_WA82.TD.getTMPL("CircleSpinner")).show()}},{key:"hideSpinner",value:function(){this.spinnerEl.updateText("").hide()}},{key:"search",value:function(a,b){this.activate(),this.foundData=null,this.query=a,this.oneDialogMode=!!b,this.viewState={},this.listView.reset(),this.showSpinner(),b?this.dialogSearch.search({sn:b,keyword:a}):this.contactSearch.search(a)}},{key:"selectEntry",value:function(a){var b=a.getAttribute("data-entry"),c=a.getAttribute("data-sn"),d=a.getAttribute("data-arch-id"),e=a.getAttribute("data-friendly");switch(b){case"message":_WA82.ma.dialogsWindow.openDialog([c],d),this.itemSelectEvent.fire(c),this.selectedItem&&this.selectedItem.removeClass("im-list-entry_focused"),this.selectedItem=a,_WA82.splitView&&a.addClass("im-list-entry_focused");break;case"contact":if(c){var f=_WA82.CLD.inList(c);if(_WA82.splitView||f)if(f||!_WA82.MainAgent.isChat(c))_WA82.contactAbstraction.openDialog(c,e);else{var g=this.contactSearch.getChatItem(c);g&&g.stamp?(_WA82.chatController.saveChatStamp(c,g.stamp),_WA82.ma.openDialog([c,e])):g?_WA82.LiveChats.showChatProfileDialog(g):_WA82.LiveChats.showChatProfile({sn:c})}else if(_WA82.MainAgent.isChat(c)){var h=this.contactSearch.getChatItem(c);h?h.stamp?(_WA82.chatController.saveChatStamp(c,h.stamp),_WA82.overlayScreen.show(_WA82.tr("chat.pleaseWait"),!0),_WA82.chatController.getChatInfoByStamp(h.stamp,1,!0,function(a,b,d,f){_WA82.overlayScreen.hide(),d&&f&&(f.joinModeration?_WA82.LiveChats.showChatProfile(h,!0):_WA82.ma.openDialog([c,e]))})):_WA82.LiveChats.showChatProfileDialog(h):_WA82.LiveChats.showChatProfile({sn:c})}else _WA82.ma.openProfile({sn:c,friendly:e});this.itemSelectEvent.fire(c,f)}}}},{key:"_onContextmenu",value:function(a){var b=a.getTarget(!0).up("imSearchEntry"),c=b&&b.getAttribute("data-sn");if(c&&"contact"===b.getAttribute("data-entry")&&_WA82.CLD.inList(c)){var d=_WA82.MainAgent.isChat(c),e={ignore:!0,remove:!_WA82.configurator.getOption("disable_remove_user_button")||d,profile:!d,spam:!d&&!_WA82.configurator.getOption("disable_remove_user_button")};c!==_WA82.ACTIVE_MAIL&&_WA82.contextMenu.show(a,e,{mail:c,nick:b.getAttribute("data-friendly"),contact:_WA82.ContactListAgent.nodeToContactArray(b)})}return!!a.stopEvent()}},{key:"_onClick",value:function(a){var b=a.getTarget(!0),c=b.up("imSearchEntry");this.itemClickEvent.fire(b),c&&(this.selectEntry(c),a.stopEvent())}},{key:"buildListEntry",value:function(a,b,c,d,e,f){var g;switch(a){case"title":g={text:b.text,cls:"imSearchAnchor_"+(b.anchor||"")};break;case"contact":var h=b[_WA82.contactMapKeys.email],i=h===_WA82.ACTIVE_MAIL,j=i?_WA82.tr("dialog.favorite"):b[_WA82.contactMapKeys.nick]||_WA82.CLD.getFriendlyName(h),k=b[_WA82.contactMapKeys.uNick]||(_WA82.isUIN(h)?h:""),l=_WA82.CLD.getLastseenMessage(b[_WA82.contactMapKeys.lastseen],{userState:b[_WA82.contactMapKeys.userState],bot:b[_WA82.contactMapKeys.bot]}),m=_U68.String.htmlEntity(j||h);if(this.query){var n=this.queryList||this.query;_WA82.isArray(n)||(n=[n]),m=_WA82.ContactListView.highlightFoundContact(_U68.String.htmlEntity(h),_U68.String.htmlEntity(j),_U68.String.htmlEntity(k),n)}if(friendlyNames[h]&&(l=_U68.String.htmlEntity(friendlyNames[h])),chatMembersCounts[h]){var o=chatMembersCounts[h];o>1e3&&(o=Math.min(10,Math.round(o/100)/10)+"k"),l=_U68.String.htmlEntity(_WA82.tr("chat.countMembers",{count:o}))}g={sn:_U68.String.htmlEntity(h),friendly:_WA82.Emoji.parse(m),dataFriendly:_U68.String.htmlEntity(j),avatarHtml:_WA82.Ava.make(h,j,32,null,{isFavorite:i,official:!!b[_WA82.contactMapKeys.official],mute:!!b[_WA82.contactMapKeys.mute]}),subtitle:l,classes:i?"im-cl-contact_self":""};break;case"message":var p,q,r,s=b.dialogSn,t=s===_WA82.ACTIVE_MAIL,u=t?_WA82.tr("dialog.favorite"):b.dialogName||_WA82.CLD.getFriendlyName(s),v=b.sender,w=t?_WA82.tr("dialog.favorite"):b.senderFriendly||_WA82.CLD.getFriendlyName(v),x=b.text,y="",z=b.highlight.slice(0).sort(function(a,b){return a.length>b.length?-1:1});b.snippets&&b.snippets.forEach(function(a){Object.keys(a).forEach(function(b){r||(r=_highlightMessageContent(_U68.String.htmlEntity(a[b].title),z)),r||(r=_highlightMessageContent(_U68.String.htmlEntity(b),z)),r||(r=_highlightMessageContent(_U68.String.htmlEntity(a[b].snippet),z))})}),!r&&b.parts&&b.parts.length&&b.parts.slice(0).reverse().forEach(function(a){!r&&a.text&&(r=_highlightMessageContent(_U68.String.htmlEntity(a.text),z),(r&&"quote"===a.mediaType||"forward"===a.mediaType)&&(v=a.sn,w=a.friendly))}),r||(x=_U68.String.htmlEntity(x),r=_highlightMessageContent(x,z)||x),r=_WA82.Emoji.parse(r),b.mentions&&_U68.Array.each(b.mentions,function(a){var b=_WA82.CLD.getFriendlyName(a)||a;r=r.replace(new RegExp("\\@\\["+a.replace(/\./g,"\\.")+"\\]","g"),"@"+_WA82.Emoji.parse(_U68.String.htmlEntity(b)))}),this.oneDialogMode?(p=_WA82.Ava.make(v,w,52,null,{isFavorite:t,official:_WA82.CLD.isOfficial(v)}),q=w||v):(p=_WA82.Ava.make(s,u,52,null,{isFavorite:t,official:_WA82.CLD.isOfficial(s)}),q=u||s,_WA82.MainAgent.isChat(s)&&v!==_WA82.ACTIVE_MAIL&&v!==s&&(y=(w||v)+": "));var A=r.length>APPROXIMATE_VISIBLE_SYMBOLS_IN_RESULT,B=[];A&&B.push("im-search-item_large"),t&&B.push("im-cl-contact_self"),g={sn:_U68.String.htmlEntity(s),title:_WA82.Emoji.parse(_U68.String.htmlEntity(q)),sender:_U68.String.htmlEntity(v),textPrefix:_U68.String.htmlEntity(y),arch_id:_U68.String.htmlEntity(b.arch_id),date:_U68.Date.formatNicely(b.timestamp),text:r,classes:B.join(" "),avatarHtml:p,idx:c,absIdx:c+(f&&f.from||0),offset:d}}return g}},{key:"stopSearch",value:function(){this.deactivate()}},{key:"destroy",value:function(){this.stateChangeEvent.removeAll(),this.itemSelectEvent.removeAll(),this.itemClickEvent.removeAll(),this.listView.destroy(),this.dialogSearch.destroy(),this.contactSearch.destroy()}}]),b}(_Activatable14);_WA82.MultiSearch={getInstance:function(){return this._multiSearchInstance||(this._multiSearchInstance=new MultiSearch),this._multiSearchInstance},remoteSearch:function(a){return this._multiSearchInstance||(this._multiSearchInstance=new MultiSearch),this._multiSearchInstance.contactSearch.remoteAbstraction.startSearch(a)},getChatItem:function(a){return this._multiSearchInstance?this._multiSearchInstance.contactSearch.getChatItem(a):void 0}};var _WA83=WebIM,_U69=_WA83.util,_DomUtil39=_WA83.DomUtil,SearchFieldSimple=function(a){function b(a){var c;return _classCallCheck2(this,b),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a)),c._value="",c._changeDelay=a.changeDelay||0,c.onChangeWithDelayEvent=new _U69.Event,c.onChangeEvent=new _U69.Event,c.onCancelEvent=new _U69.Event,c.searchDT=new _U69.DelayedTask,c.pasteDT=new _U69.DelayedTask({fn:function(){c._checkChange()||c.pasteDT.start()},scope:_assertThisInitialized2(_assertThisInitialized2(c)),interval:c._changeDelay||200}),c.changeValueDT=new _U69.DelayedTask({fn:function(){c.onChangeWithDelayEvent.fire(c._value,c._oldVal)},scope:_assertThisInitialized2(_assertThisInitialized2(c)),interval:300}),c}return _inherits2(b,a),_createClass2(b,[{key:"val",value:function(a,c){var d=_get2(_getPrototypeOf2(b.prototype),"val",this).call(this,a);return c===!0&&this._checkChange(),d}},{key:"_checkChange",value:function(){var a=this.val(),b=this._value;return this._value!==a?(this._value=a,this._oldVal=b,""===a?(this.changeValueDT.stop(),this.clearBtn.hide(),this.onCancelEvent.fire(!1)):(this.clearBtn.show(),this.onChangeEvent.fire(a,b)),!0):void 0}},{key:"_onRender",value:function(a){var c=this;_get2(_getPrototypeOf2(b.prototype),"_onRender",this).call(this,a),this.searchIcon=a.createChild({cls:"im-search-icon"}).on("click",function(){c.focus()}),this.clearBtn=a.createChild({tag:"button",cls:"im-ui-button im-search-clear"}).on("click",function(){c.cancelSearch()}),this.clearBtn.hide()}},{key:"_onAfterRender",value:function(){var a=this;_get2(_getPrototypeOf2(b.prototype),"_onAfterRender",this).call(this),this.el.on("keyup",this._onSearchFieldKeyUp,this),this.el.on("paste",function(){_WA83.setTimeout(a._checkChange,a._changeDelay||200,a)}),_WA83.isOpera&&this.el.on("mouseup",function(b){2===b.button&&a.pasteDT.start()})}},{key:"cancelSearch",value:function(a){this._value="",this.val(""),this.clearBtn.hide(),this.onCancelEvent.fire(!!a)?this.abort():this.focus()}},{key:"_checkVisibility",value:function(){if(this.el&&this.el.dom){var a=this.el.getBoundingClientRect(),b=_U69.DomHelper.elementFromPoint(a.left+5,a.top+5);return b.dom===this.el.dom}return!1}},{key:"_onBodyKeyDown",value:function(a){var b=a.keyCode,c=_WA83.isMac?a.browserEvent.metaKey:a.browserEvent.ctrlKey;return 70===b&&c&&this._checkVisibility()?(this.focus(),a.stopEvent()):void 0}},{key:"_onSearchFieldKeyUp",value:function(a){var b=a.getKeyCode();27===b?(a.preventDefault(),this.cancelSearch(!0)):this.searchDT.start(this._changeDelay||150,this._checkChange,this)}},{key:"abort",value:function(){this.stop()}},{key:"stop",value:function(){this.pasteDT.stop(),this.searchDT.stop()}},{key:"destroy",value:function(){this.clearBtn&&this.clearBtn.remove(),this.searchIcon&&this.searchIcon.remove(),this.pasteDT.stop(),this.searchDT.stop(),this.onChangeEvent.removeAll(),this.onCancelEvent.removeAll(),this.onChangeEvent=this.onCancelEvent=null,_DomUtil39.getBody().un("keydown",this._onBodyKeyDown,this),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_WA83.ui.TextField);_WA83.SearchFieldSimple=SearchFieldSimple;var _WA84=WebIM,_U70=_WA84.util,_UI45=_WA84.ui,DEFAULT_VALUES={name:_WA84.tr("profile.inputName"),aboutMe:_WA84.tr("profile.inputAboutMe"),uNick:_WA84.tr("profile.inputNickname"),phone:_WA84.tr("profile.inputPhone"),email:""},_DomUtil40=_WA84.DomUtil,checkSelfFirstNameOnce=!1,_sessionCache=null,SelfProfilePage=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"selfProfile")),_WA84.contactAbstraction.myInfoEvent.on(a._onMyInfoEvent,_assertThisInitialized2(_assertThisInitialized2(a))),a.backClick=new _U70.Event,a}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a,c){var d=this;this.localIconId=_WA84.DialogsAbstraction.iconId,this.el=_DomUtil40.get(a),this._content=this.el.getSelector(".app-content"),this._content.getSelector(".imPrivacyLinkButton").setVisible(!_WA84.configurator.getOption("hide_all_policy_notes")),_WA84.configurator.getOption("disable_name_change")&&this._content.getSelector('.imProfileItem[data-key="name"]').removeAttribute("data-editable"),_WA84.configurator.getOption("disable_self_info_change")&&this._content.getSelector('.imProfileItem[data-key="aboutMe"]').removeAttribute("data-editable"),this._drawFields(),this._drawAvatar(),this.scrollBar=new _UI45.ScrollBar({source:this._content}),this._content.on("click",this._onClick,this),this._content.on("change",this._onChange,this),this._content.on("contextmenu",this._onContextmenu,this),App.on("navigation:back",this._onNavBack,this),this.el.getSelector(".appBack").on("click",this._onBackClick,this),this.data&&this._updateView(),_WA84.contactAbstraction.getUserProfile(_WA84.ACTIVE_MAIL,function(a){d._onProfileReady(a)},!0),_get2(_getPrototypeOf2(b.prototype),"onPageLoad",this).call(this)}},{key:"onPageUnload",value:function(){this._content&&(this.scrollBar.destroy(),this._content.un("contextmenu",this._onContextmenu,this),this._content.un("click",this._onClick,this),this._content.un("change",this._onChange,this),App.off("navigation:back",this._onNavBack,this),this.el.getSelector(".appBack").un("click",this._onBackClick,this),this._editDialog&&(this._editDialog=null),delete this._content,delete this.avatarLoaded),_get2(_getPrototypeOf2(b.prototype),"onPageUnload",this).call(this)}},{key:"_onContextmenu",value:function(a){if(a.getTarget(!0).up("imAvatarBox")){if(this.avatarLoaded){var b=_WA84.configurator.getOption("disable_avatar_change")?["lookAvatar"]:["changeAvatar","lookAvatar"];_WA84.contextMenu.show(a,b,null,{changeAvatar:this._onAvatarChoose.bind(this),lookAvatar:this._fullPreviewAvatar.bind(this)}),_WA84.Ava.make(_WA84.ACTIVE_MAIL,null,400)}a.stopEvent()}}},{key:"_fullPreviewAvatar",value:function(){var a=this;this._mediaPlayer||(this._mediaPlayer=new _UI45.PhotoPreview({autoRender:_DomUtil40.getBody(),fadeIn:!0,modal:!0}));var b=_WA84.Ava.make(_WA84.ACTIVE_MAIL,null,400,function(){_WA84.Pane.isCurrentPage("selfProfile")&&a._fullPreviewAvatar()});if(b.remoteLoaded&&b.url){var c=_WA84.fileTools.emulateFileObjForPreview(b.url);this._mediaPlayer.open(c)}}},{key:"_drawAvatar",value:function(){if(this._content){var a=this._content.getSelector(".imAvatarBox"),b=_WA84.Ava.make(_WA84.ACTIVE_MAIL,this._getMyName(),80,this._drawAvatar.bind(this));this.avatarLoaded=b.remoteLoaded&&(this.localIconId||this.data&&!!this.data.avatarId),_WA84.configurator.getOption("disable_avatar_change")?a.first().updateHTML(b.html):(a.addClass("im-selfprofile-ava_editable"),this.avatarLoaded&&(a.addClass("im-selfprofile-ava_loaded"),a.first().updateHTML(b.html)))}}},{key:"_getMyName",value:function(){var a="",b=this.data||{};return b.friendly?a=b.friendly:b.firstname||b.lastname?a=(b.firstname||"")+" "+(b.lastname||""):_WA84.DialogsAbstraction.nick&&(a=_WA84.DialogsAbstraction.nick),a}},{key:"_drawFields",value:function(){var a=!_WA84.isUIN(_WA84.ACTIVE_MAIL),b=this.data||{},c=_WA84.ConnectionFacade.getAttachedPhone(),d=_WA84.configurator.getOption("enable_password_change"),e={name:_WA84.Emoji.parse(_U70.String.htmlEntity(this._getMyName())),aboutMe:_WA84.Emoji.parse(_U70.String.htmlEntity(b.aboutMe||"")).replace(/\n/g,"<br/>"),uNick:b.uNick?"@"+_U70.String.htmlEntity(b.uNick):"",phone:c&&_U70.String.formatPhoneNumber(c)||"",email:a?_U70.String.htmlEntity(_WA84.ACTIVE_MAIL):""};Object.keys(e).forEach(function(a){var b=this._content.getSelector('.imProfileItem[data-key="'+a+'"]');b.toggleClass("im-selfprofile-item_default",!e[a]),b.getSelector(".imProfileValue").updateHTML(e[a]||DEFAULT_VALUES[a])},this),a&&(this._content.getSelector('.imProfileItem[data-key="email"]').show(),this._content.getSelector('.imProfileItem[data-key="uNick"]').hide());var f=this._content.getSelector('.imProfileItem[data-key="phone"]');_WA84.configurator.getOption("disable_phone_switch")||f.setAttribute("data-editable",1),(!c||_WA84.configurator.getOption("disable_phone_signin"))&&f.hide();var g=this._content.getSelector('.imProfileItem[data-key="password"]');g.setVisible(d&&b.hasPassword&&!a);var h=_WA84.urlBuilder.getUrl("profilePrivacy")+_WA84.resLanguage;this._content.getSelector(".imPrivacyLink").setAttribute("href",h)}},{key:"_onProfileReady",value:function(a){if(a){if(this.data=a,a.phone){var b=a.phone.replace(/\+/,"");b!==_WA84.ConnectionFacade.getAttachedPhone()&&_WA84.ConnectionFacade.setAttachedPhone(b)}this._updateView()}}},{key:"_onMyInfoEvent",value:function(a){this.data&&(this.data.friendly=a.friendly),a.largeIconId&&a.largeIconId!==this.localIconId&&(this.localIconId=a.largeIconId,_WA84.setTimeout(this._drawAvatar,300,this)),this._updateView()}},{key:"_updateView",value:function(){this._content&&((_WA84.configurator.getOption("disable_avatar_change")||this.data&&this.data.avatarId)&&this._drawAvatar(),this._drawFields(),this.scrollBar.sync())}},{key:"editField",value:function(a){var b,c,d=this,e=this.data||{};switch(a){case"name":if(_WA84.configurator.getOption("disable_name_change"))return;c=new _UI45.EditNamesBox,c.actionEvent.on(function(a,b){"ok"===a&&((e.firstname||"")!==b.firstname&&(e.firstname=b.firstname||void 0,_WA84.contactAbstraction.updateProfile("firstname",b.firstname)),(e.lastname||"")!==b.lastname&&(e.lastname=b.lastname||void 0,_WA84.contactAbstraction.updateProfile("lastname",b.lastname)),this._updateView())},this),c.show(e);break;case"aboutMe":if(_WA84.configurator.getOption("disable_self_info_change"))return;b=e.aboutMe||"",c=new _UI45.EditAboutBox({defaultValue:b,onEditOk:function(a){a!==b&&(e.aboutMe=a||void 0,d._updateView(),_WA84.contactAbstraction.updateProfile("aboutMe",a))}}),c.show();break;case"uNick":b=e.uNick||"",c=new _UI45.EditNickBox({defaultValue:b,onOk:function(a){_WA84.rapi.setNick(a,function(f,g,h){200===f?(c.hide(),e.uNick=a,d._updateView(),_U70.Mnt.countRB(b.match(/^\d+$/)?41694829:41694830)):406===f?c.showCheckErrorMessage():c.showApplyError()})},checkValueCallback:function(a){a&&_WA84.rapi.checkNick(a,function(b,d,e){200===b?c.onCheck(a,!0):406===b?c.onCheck(a,!1):c.onCheck(a,!1,!0)})}}),c.show();break;case"phone":_WA84.switchPhonePage.open({onSuccess:function(){d._updateView()}});break;case"password":var f=new _WA84.ChangePasswordBox;f.show()}}},{key:"_onBackClick",value:function(){_WA84.splitView?this.backClick.fire():App.back()}},{key:"_onAvatarChoose",value:function(a){var c=this;b.uploadSelfAvatar(a,function(a){console.log("###_onAvatarChoose done:",a),_WA84.setTimeout(function(){this.localIconId!==a&&(this.localIconId=a,console.log("... setting (2) this.localIconId=",this.localIconId),this._drawAvatar())},900,c)})}},{key:"_onChange",value:function(a){if(!_WA84.configurator.getOption("disable_avatar_change")){var b=a.getTarget(!0);b.up("imAvatarBox")&&b.dom.files&&this._onAvatarChoose(b.dom)}}},{key:"_onNavBack",value:function(){this._mediaPlayer&&this._mediaPlayer.visible||_WA84.splitView&&this.backClick.fire()}},{key:"_onClick",value:function(a){var b=a.getTarget(!0),c=b.up("imProfileItem"),d=b.up("imButton");if(c){if("1"===c.getAttribute("data-editable"))return this.editField(c.getAttribute("data-key"))}else d&&"signOut"===d.getAttribute("data-action")&&(a.altKey?_WA84.ConnectionFacade.forceOffline():_UI45.showConfirmBox(_WA84.tr("signOut"),_WA84.tr("msgSignOutConfirmation"),function(){_WA84.ConnectionFacade.logout()}))}}],[{key:"uploadSelfAvatar",value:function(a,b){var c=a.files[0];c&&((c.type||"").match(/^image\/(?:jpeg|png|gif)$/)?c.size>_WA84.Ava.MAX_FILE_SIZE?(_WA84.showPopup(_WA84.tr("file.errorFileTooLarge")),a.value=null):_WA84.rapi.uploadAvatar(c).then(function(a){a.id&&b&&b(a.id)},function(a){_WA84.showPopup(_WA84.tr("file.errorFile"))}):_WA84.showPopup(_WA84.tr("file.errorFile")))}},{key:"getSessionList",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:!1;return new Promise(function(b,c){_sessionCache&&!a?b(_sessionCache):_WA84.rapi.sessionList(function(a,d,e,f){_sessionCache=null,f&&f.sessions?(_sessionCache=f.sessions,b(f.sessions)):c(e||a)})})}},{key:"checkSelfFirstName",value:function(){checkSelfFirstNameOnce||(checkSelfFirstNameOnce=!0,_WA84.contactAbstraction.getUserProfile(_WA84.ACTIVE_MAIL,function(a){a.firstname||b.showStartProfileDialog(a.firstname||"",a.lastname||"")},!0))}},{key:"showStartProfileDialog",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return new Promise(function(d,e){var f=new _UI45.StartProfile;f.changeAvatarEvent.on(function(a){b.uploadSelfAvatar(a,function(){_WA84.Ava.updateLastModified(_WA84.ACTIVE_MAIL),_WA84.setTimeout(f.renderAvatar,900,f)})}),f.actionEvent.on(function(a,b){"signout"===a&&(f.hide(),e()),"ok"===a&&b.firstname&&b.firstname.match(/\S/)&&_WA84.contactAbstraction.updateProfile("firstname",b.firstname,function(a,e){a?b.lastname!==c?_WA84.contactAbstraction.updateProfile("lastname",b.lastname,function(){f.hide(),d()}):(f.hide(),d()):_WA84.showPopup(_WA84.tr("auth.msgCommonError")+(e?" ["+e+"]":""))})}),f.show({firstname:a,lastname:c})})}}]),b}(_WA84.Page);_WA84.SelfProfilePage=SelfProfilePage;var _WA85=WebIM,_TD26=_WA85.TemplateDriver,_U71=_WA85.util,_DomUtil41=_WA85.DomUtil,createSafeTag=function(a,b,c){var d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!1,e=(c?" im-search-tag_active":"")+(d?" im-search-tag_closable":"");return _TD26.parseSafe("searchTag",{title:_WA85.Emoji.parse(_U71.String.htmlEntity(b)),action:a,cls:e},{safeKeys:["title"]})},stopEventPropagation=function(a){a.browserEvent.stopPropagation()},MultiSearchPage=function(a){function b(){return _classCallCheck2(this,b),_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"multiSearch"))}return _inherits2(b,a),_createClass2(b,[{key:"_initOnce",value:function(){var a=this;this.__inited||(this.__inited=!0,this._cacheState={},this.searchModule=_WA85.MultiSearch.getInstance(),this.searchModule.stateChangeEvent.on(this._onSearchStateChange,this),this.searchModule.itemClickEvent.on(function(){a.searchField&&a.searchField.focus()}),this.searchModule.itemSelectEvent.on(function(b,c){c&&a.cancelSearch(!0)}))}},{key:"focusPage",value:function(a){var b=a||{},c=b.sn,d=b.nick;this._searchOneDialog!==c&&this._switchSearchMode({sn:c,nick:d}),this.searchField&&this.searchField.focus()}},{key:"renderTags",value:function(){var a=[];if(this._searchOneDialog){if(!_WA85.Feature.getModeParameter("allowOnlyChatSearch")){var b=this._searchOneDialog===_WA85.ACTIVE_MAIL?_WA85.tr("dialog.favorite"):_WA85.CLD.getFriendlyName(this._searchOneDialog)||this._searchOneDialog;a.push(createSafeTag("exitDialogMode",b,!0,!0))}}else this.initialMode||(this._cacheState.chatsCount>0&&a.push(createSafeTag("goToContacts",_WA85.tr("search.chats"),"chats"===this._cacheState.lastPassedAnchor)),this._cacheState.globalCount>0&&a.push(createSafeTag("goToGlobals",_WA85.tr("search.global"),"global"===this._cacheState.lastPassedAnchor)),this._cacheState.messagesCount>0&&a.push(createSafeTag("goToMessages",_WA85.tr("search.messages"),"message"===this._cacheState.lastPassedAnchor)));this.el.toggleClass("im-multi-search_tags-available",!!a.length),this.searchTags&&(this.searchTags.updateHTML(a.join("")),this._checkTagsScrollButtons())}},{key:"_updateClasses",value:function(){_DomUtil41.getBody().toggleClass("im-mode_searchchat",!!this._searchOneDialog),this.el.toggleClass("im-search-to-write",!!this.writeMessageMode)}},{key:"_switchSearchMode",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},b=a.sn,c=a.nick,d=a.keyword;c&&b&&!_WA85.CLD.getFriendlyName(b)&&_WA85.CLD.saveFriendly(b,c),this._searchOneDialog=b||null,this.el.getSelector(".app-topbar__title").updateHTML(_WA85.tr("search.search")),this._updateClasses(),this.renderTags(),this.searchModule.stopSearch(),this.searchField.cancelSearch(),this.searchField.delayedFocus(),this.initialMode=!d,d&&this.searchField.val(d,!0)}},{key:"_onSearchStateChange",value:function(a){this._cacheState=a,this.renderTags()}},{key:"_onTagsScroll",value:function(a){this._checkTagsScrollButtons()}},{key:"_onTagsWheel",value:function(a){var b=a.browserEvent,c=b.deltaY;b.deltaX&&Math.abs(b.deltaX)>Math.abs(c)&&(c=b.deltaX);var d=b.constructor;!d||b.deltaMode!==d.DOM_DELTA_LINE&&b.deltaMode!==d.WM_MOUSEWHEEL&&b.deltaMode!==d.WM_MOUSEHWHEEL||(c*=4),0!==c&&(this.searchTags.dom.scrollLeft+=c),a.stopEvent()}},{key:"_checkTagsScrollButtons",value:function(a){if(void 0===a&&(a=this.searchTags.dom.scrollLeft),this._scrollTagsButtons){var b=_slicedToArray(this._scrollTagsButtons,2),c=b[0],d=b[1];a+this.searchTags.dom.offsetWidth<this.searchTags.dom.scrollWidth?d.show():d.hide(),a>0?c.show():c.hide()}}},{key:"_scrollTagsLeft",value:function(){var a=this.searchTags.dom.scrollLeft,b=0;_U71.animation.start(a,b,Math.abs((b-a)/150),function(a,b){this.searchTags.dom.scrollLeft=Math.round(a)}.bind(this))}},{key:"_scrollTagsRight",value:function(){var a=this.searchTags.dom.scrollLeft,b=this.searchTags.dom.scrollWidth-this.searchTags.dom.offsetWidth;_U71.animation.start(a,b,Math.abs((b-a)/150),function(a,b){this.searchTags.dom.scrollLeft=Math.round(a)}.bind(this))}},{key:"_onClick",value:function(a){var b=a.getTarget(!0),c=b.up("imButton"),d=c&&c.getAttribute("data-action");switch(d&&a.stopEvent(),d){case"exitSearch":App.back();break;case"exitDialogMode":b.up("imButtonClose")&&this._switchSearchMode({keyword:this.searchModule.query});break;case"goToContacts":this.searchModule.scrollUp("chats");break;case"goToGlobals":this.searchModule.scrollUp("global");break;case"goToMessages":this.searchModule.scrollUp("message");break;case"addContact":App.back(),_WA85.ma.showAddDialog();break;case"newGroup":App.back(),_WA85.ma.newGroup();break;case"newChannel":App.back(),_WA85.ma.showNewChannelDialog();break;case"searchTagsLeft":this._scrollTagsLeft();break;case"searchTagsRight":this._scrollTagsRight()}}},{key:"_renderPage",value:function(){var a=this,b=this.el.getSelector(".imTopSearchBar");this.resultsBlock=this.el.getSelector(".im-search-results"),this.searchModule.bindView(this.resultsBlock),this.el.getSelector(".im-search-buttons__add").setVisible(!_WA85.configurator.getOption("disable_add_contact_by_phone")),this.searchField=new _WA85.SearchFieldSimple({changeDelay:300,cls:"im-search-field imSearchFieldBlock",hintText:_WA85.tr("search.search")}),this.searchField.onChangeEvent.on(function(b){b&&(delete a.writeMessageMode,delete a.initialMode,a._updateClasses()),a.searchModule.search(b,a._searchOneDialog)}),this.searchField.onCancelEvent.on(this.cancelSearch,this),this.searchField.onHotKeyFocusedLayer(["arrowLeft","arrowRight","arrowDown","arrowUp","enter"],this._onFieldHotKey,this),this.searchField.render(b),this.searchField.el.setAttribute("data-tabindex","5"),this.searchTags=this.el.getSelector(".imSearchTags");var c=this.el.getSelector(".im-search-tags-button_left"),d=this.el.getSelector(".im-search-tags-button_right");this._scrollTagsButtons=[c,d]}},{key:"renderStartList",value:function(){this.searchModule.activate();var a=_WA85.ma.contactList.abstraction.getFullData(function(a){return!_WA85.CLD.getStranger(a[0])}),b=_U71.Array.indexOfBy(a,function(a){return a[0]===_WA85.ACTIVE_MAIL});b>-1&&a.unshift(a.splice(b,1)[0]),this.searchModule.drawChatsData(a)}},{key:"cancelSearch",value:function(a){if(a)if(App.isCurrentPage("multiSearch"))App.back();else{var b=App.indexOfPage("multiSearch",!0);b>-1&&App.spliceHistory(b,1)}else this.initialMode=!0,this.searchModule.stopSearch(),this.searchField.stop(),this._searchOneDialog||this.renderStartList();return!!a}},{key:"_onFieldHotKey",value:function(a,b){this.searchModule.navigate(b)&&a.stopEvent()}},{key:"onPageLoad",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.el=_DomUtil41.get(a),this._initOnce(),this._renderPage(),this.el.on("click",this._onClick,this),this.writeMessageMode="message"===b.mode,this.initialMode=!0,this._switchSearchMode(b),this.searchTags&&(this.searchTags.on("scroll",this._onTagsScroll,this),this.searchTags.on("touchmove",stopEventPropagation),_WA85.isDesktop&&(this.searchTags.setStyle("overflow","hidden"),this.searchTags.on("wheel",this._onTagsWheel,this)))}},{key:"onPageUnload",value:function(){_DomUtil41.getBody().toggleClass("im-mode_searchchat",!1),this.el.un("click",this._onClick,this),this.searchTags&&(this.searchTags.un("scroll",this._onTagsScroll,this),this.searchTags.un("touchmove",stopEventPropagation),_WA85.isDesktop&&this.searchTags.un("wheel",this._onTagsWheel,this)),this.searchField.destroy(),this.searchModule.unbindView(),delete this.searchField,delete this.resultsBlock,delete this.searchTags,delete this.el}}]),b}(_WA85.Page);_WA85.MultiSearchPage=MultiSearchPage;var _WA86=WebIM,_U72=_WA86.util,_TD27=_WA86.TemplateDriver,_UI46=_WA86.ui,_DomUtil42=_WA86.DomUtil,ShowcasePage=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"showcase")),a.previewPack=!1,a.selectedPack=null,a._packListCache="",a.shareEvent=new _U72.Event,a}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.initOnce(),this.contentEl=_DomUtil42.get(a).getSelector(".app-content"),this.backButton=this.contentEl.getSelector(".im-showcase-topbar__back"),this.backButton.on("click",this._onBackClick,this),this.el=this.contentEl.getSelector(".im-showcase-content"),this.el.on("click",this._onClick,this),this.el.on(["longtap","contextmenu"],this._longTapPreview,this),this.scrollBar=new _WA86.ui.ScrollBar({source:this.el}),this.selectedPack=null,this.singlePackMode=!!b.id,this.singlePackMode?this._showPackPreview(b.id,b.idType):this._refresh()}},{key:"onPageUnload",value:function(){_UI46.StickerPreview.hide(),this.scrollBar.destroy(),this.el.un("click",this._onClick,this),this.el.un(["longtap","contextmenu"],this._longTapPreview,this),this.backButton.un("click",this._onBackClick,this)}},{key:"initOnce",value:function(){this.__inited||(this.__inited=!0,this.packInstalledEvent=new _U72.Event,this.packRemovedEvent=new _U72.Event,this.spinnerTMPL=_WA86.TD.getTMPL("CircleSpinner"))}},{key:"_refresh",value:function(a){this.setTitle(_WA86.tr("sticker.stickers")),this.scrollBar.setSource(null),this.el.updateHTML(this.spinnerTMPL),_WA86.Sticker.requestShowcase(this._showPackList.bind(this),a)}},{key:"_showPackList",value:function(){var a=[],b=_WA86.Sticker.getShowcaseList();this.previewPack=null,this.contentEl.toggleClass("im-showcase_pack",!1),_U72.Array.each(b,function(b){a.push(_TD27.parseSafe("showcaseItem",{id:b.id,store_id:b.store_id,icon:_U72.String.encodeHref(_WA86.Sticker.getPackIconUrl(b.id,90)||""),name:b.name,descr:b.description,purchased:+b.purchased,action:b.purchased?"remove":"install",action_cls:b.purchased?"im-button_attention":"im-button_highlight",action_title:b.purchased?_WA86.tr("sticker.remove"):_WA86.tr("sticker.add"),cls_installed:b.purchased?"im-showcase_item-installed":""},{safeKeys:["icon"]}))}),this._packListCache=a.join(""),this.el.updateHTML(this._packListCache),this.scrollBar.setSource(this.el),this.scrollBar.sync()}},{key:"_showPackPreview",value:function(a,b,c){var d=this,e=_WA86.Sticker.getPackName(a);this.previewPack=a,e&&this.setTitle(e),this.el.updateHTML(this.spinnerTMPL),this.scrollBar.sync(),_WA86.Sticker.requestShowcase(function(){_WA86.Sticker.requestPackInfo(a,b||"packId",function(b,c){c&&(d.previewPack=a=c),b!==!1?d.renderPackPreview(d.previewPack):(d.close(),_WA86.showPopup(_WA86.tr("sticker.stickerPackNotFound")))},!!c)})}},{key:"renderPackPreview",value:function(a){var b=_WA86.Sticker.getShowcasePreview(a);if(b){_UI46.StickerPreview.hide(),this.previewPack=a,this.contentEl.toggleClass("im-showcase_pack",!0);var c=_TD27.parseSafe("packPreviewItem",{id:a,store_id:b.store_id,icon:_U72.String.encodeHref(_WA86.Sticker.getPackIconUrl(a,120)||""),name:b.name,descr:b.description,content:this.createContentPreview(a),purchased:+b.purchased},{safeKeys:["icon","content"]});this.setTitle(b.name,b.description),this.el.updateHTML(c),this.scrollBar.setSource(this.el.getSelector(".im-showcase__preview-content")),this.scrollBar.sync(),this._updateItemStatus(this.el.first(),b.purchased)}}},{key:"createContentPreview",value:function(a){var b=_WA86.Sticker.getAllPackContent()[a],c="";return _U72.Array.each(b,function(b){var d=_WA86.Sticker.getStickerPreviewUrl(a,b,60);c+=_TD27.parseSafe("stickerPackPreviewItem",{icon:d},{safeKeys:["icon"]})}),c}},{key:"createSuggestPreview",value:function(a){var b=_U72.Array.transform(a,function(a){var b=a.split(":"),c=2===b.length?_WA86.Sticker.getStickerPreviewUrl(b[0],b[1],60):_WA86.Sticker.getStickerPreviewUrl("",b[0],60);return _TD27.parseSafe("stickerSuggestItem",{icon:c},{safeKeys:["icon"]})});return b.join("")}},{key:"setTitle",value:function(a,b){this.contentEl.getSelector(".im-showcase__title").updateText(a||""),this.contentEl.getSelector(".im-showcase__subtitle").updateText(b||"")}},{key:"_longTapPreview",value:function(a){var b=a.getTarget(!0),c=b.up("im-showcase__preview-content");c&&b.hasClass("im-showcase__preview-content__item")&&(a.stopEvent(),
"longtap"===a.type&&_UI46.StickerPreview.show(b,c,this.el))}},{key:"_onClick",value:function(a){var b=a.getTarget(!0),c=b.up("imShowcaseItembox"),d=c&&c.getAttribute("data-id");if(d){var e=b.up("im-showcase-action");e?this._doItemAction(c,e):this.previewPack!==d&&this._showPackPreview(d)}}},{key:"_updateItemStatus",value:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:!1,d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:!1;this.previewPack||(c=!1);var e=_WA86.tr("sticker.add"),f="install";d?(e=this.spinnerTMPL,f=""):b&&(e=c?_WA86.tr("sticker.tryNow"):_WA86.tr("sticker.remove"),f=c?"try":"remove"),a.toggleClass("im-showcase_item-installed",b||!!d);var g=a.getSelector(".im-showcase-action");g.toggleClass("im-button_highlight",(!b||b&&c)&&!d),g.toggleClass("im-button_attention",b&&!c&&!d),g.setAttribute("data-action",f),g.updateHTML(e)}},{key:"_doItemAction",value:function(a,b){var c=a&&a.getAttribute("data-id"),d=b.getAttribute("data-action");if("share"===d)return void this.shareEvent.fire(a.getAttribute("data-storeid"),this.previewPack,this.singlePackMode);var e=function(){this._updateItemStatus(a,"install"===d,!0)}.bind(this);"try"!==d&&this._updateItemStatus(a,!1,!0,!0),"remove"===d?this._uninstallPack(c,a.getAttribute("data-storeid"),e):"install"===d?this._installPack(c,a.getAttribute("data-storeid"),e):"try"===d&&(this.selectedPack=c,this.close())}},{key:"_installPack",value:function(a,b,c){var d=this;_WA86.Sticker.requestInstallPack(a,b,function(b){200===b.status&&(c&&c(),d.packInstalledEvent.fire(a))})}},{key:"_uninstallPack",value:function(a,b,c){var d=this;_WA86.Sticker.requestRemovePack(a,function(b){200===b.status&&(c&&c.call(),d.packRemovedEvent.fire(a))})}},{key:"_onBackClick",value:function(){this.previewPack&&!this.singlePackMode?this._refresh():this.close()}},{key:"close",value:function(){_WA86.Pane.back()}},{key:"resetData",value:function(){_WA86.Sticker.resetShowcaseData(),_WA86.Pane.isCurrentPage("showcase")&&(this.previewPack&&this.singlePackMode?this._showPackPreview(this.previewPack,"packId"):this._refresh())}}]),b}(_WA86.Page);_WA86.showcasePage=new ShowcasePage;var _WA87=WebIM,_U73=_WA87.util,DEBUG_SCREENS=!1,_DomUtil43=_WA87.DomUtil,logginIn=!1,_gPhoneNumber,_gTransId,_gCodeLength,_gCodeRegex,_gCountryCode=7,_gCodeFromPhone=!1,_currentForm,_autoSubmitCode=!0,txtPhone,txtCode,scrollBar,lblResendTimer,lastCodeRequested=0,AttachPhonePage=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.appPageName="attachPhone",a}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a,b){_WA87.Pane.overlay(!0),initForm(b),changeCountryCode(7),switchForm("frmAttachPhone")}},{key:"onPageUnload",value:function(){_WA87.Pane.overlay(!1)}}]),b}(_WA87.Page);_WA87.attachPhonePage=new AttachPhonePage;var initForm=function(a){var b=_DomUtil43.get("pageAttachPhone");txtPhone=b.getSelector(".txtPhone"),txtCode=b.getSelector(".txtSmsCode"),lblResendTimer=b.getSelector(".btnResendCode"),scrollBar=new _WA87.ui.ScrollBar({source:b});var c,d=!1,e=function(){setTimeout(function(){switchForm("frmAttachPhone")},0)},f=function(a){d||(a.preventDefault(),e())},g=function(a){d=!0,a.preventDefault(),e()},h=function(a){a.preventDefault(),a.stopPropagation()};c=b.getSelector(".btnGoBack1"),c.on("click",f).on("touchstart",g).on("touchend",h),c=b.getSelector(".btnGoBack2"),c.on("click",f).on("touchstart",g).on("touchend",h),_DomUtil43.getSelector("#btnAttachSelectCountry").on("click",function(){App.load("countryPage",{onClick:changeCountryCode})}),_DomUtil43.getSelector("#btnAttachLogout").on("click",function(){_WA87.ConnectionFacade.logout()}),a.close_btn||(_DomUtil43.getSelector("#frmAttachPhone .btnAttachCancel").hide(),_DomUtil43.getSelector("#frmAttachPhoneCode .btnAttachCancel").hide()),_DomUtil43.getSelector("#frmAttachPhone .btnAttachCancel").on("click",function(){_WA87.comApi.sendPhonePopupClose(),closePage()}),_DomUtil43.getSelector("#frmAttachPhoneCode .btnAttachCancel").on("click",function(){_WA87.comApi.sendPhonePopupClose(),closePage()}),_DomUtil43.getSelector(".im-attachphone .btnAttachOK").on("click",closePage),lblResendTimer.on("click",function(){return _WA87.now()-lastCodeRequested>=60&&submitPhone(),!1});var i=function(a){var b=a.getTarget();b&&setTimeout(b.scrollIntoView.bind(b),200)};txtPhone.on("keyup",checkCurrentForm).on("change",checkCurrentForm).on("input",checkCurrentForm).on("focus",i),txtCode.on("keyup",checkCurrentForm).on("change",checkCurrentForm).on("input",checkCurrentForm).on("focus",i),_DomUtil43.getSelector("#txtProtectionTitle").updateText(a.title),_DomUtil43.getSelector("#txtProtectionText").first().updateText(a.text),_DomUtil43.getSelector("#frmAttachPhone").setAttribute("action",_WA87.urlBuilder.getUrl("phoneValidation")).on("submit",submitPhone),_DomUtil43.getSelector("#frmAttachPhoneCode").setAttribute("action",_WA87.urlBuilder.getUrl("attachPhone")).on("submit",submitPhoneCode)},submitPhone=function(a){if(a&&a.preventDefault(),clearError(),DEBUG_SCREENS)return lastCodeRequested=_WA87.now(),switchForm("frmAttachPhoneCode"),!1;var b=txtPhone.dom.value;return 0===b.trim().length?showError(txtPhone,_WA87.tr("auth.msgWrongPhone")):/^\d+$/.test(b)?getCodeByPhone(_gCountryCode+b,function(){lastCodeRequested=_WA87.now(),switchForm("frmAttachPhoneCode")},function(a,b,c){var d,e=b||a;d=462===e||469===e?_WA87.tr("auth.msgWrongPhone"):465===e||"smsapi/verify limit"===c?_WA87.tr("auth.msgRequestRateLimit"):e?_WA87.tr("auth.msgCommonError")+" ("+e+")":_WA87.tr("auth.msgNetworkUnavailable"),showError(txtPhone,d)}):showError(txtPhone,_WA87.tr("auth.msgWrongPhone")),!1},submitPhoneCode=function(a){a&&a.preventDefault(),clearError();var b=txtCode.dom.value;return DEBUG_SCREENS?(switchForm("frmAttachDone"),!1):(0===b.trim().length?showError(txtCode,_WA87.tr("auth.msgWrongCode")):/^\d+$/.test(b)?tryAttachByCode(b,function(a,b){var c,d=a;200===d?(_WA87.ConnectionFacade.setAttachedPhone(_gPhoneNumber),switchForm("frmAttachDone")):471===d?(c=_WA87.tr("auth.msgPhoneAlreadyAttached",{tel:_U73.String.formatPhone("+"+_gCountryCode+txtPhone.dom.value)}),switchForm("frmAttachPhone")):c=401===d?_WA87.tr("auth.msgWrongCode"):d?b&&b.statusText||_WA87.tr("auth.msgCommonError")+" ("+d+")":_WA87.tr("auth.msgNetworkUnavailable"),showError(txtCode,c)}):showError(txtCode,_WA87.tr("auth.msgWrongCode")),!1)},changeCountryCode=function(a){_gCountryCode=a,_DomUtil43.getSelector("#btnAttachSelectCountry").updateText("+"+a),_focusField(txtPhone)},_focusField=function(a){a&&_WA87.setTimeout(a.dom.focus.bind(a.dom),50)},checkCurrentForm=function(){var a=checkFieldsNotEmpty(_currentForm),b=_DomUtil43.getSelector("#"+_currentForm).getSelector("button[type=submit]");a?(b&&b.removeAttribute("disabled"),"frmAttachPhoneCode"===_currentForm&&_autoSubmitCode&&(_autoSubmitCode=!1,submitPhoneCode())):b&&b.setAttribute("disabled","disabled")},checkFieldsNotEmpty=function(a){switch(a){case"frmAttachPhone":if(txtPhone.dom.value.trim().length>0)return!0;break;case"frmAttachPhoneCode":var b=txtCode.dom.value;if(b.length>0&&(!_gCodeLength||_gCodeLength===b.length&&_gCodeRegex.test(b)))return!0}return!1},switchForm=function(a){_currentForm=a,clearError(),_DomUtil43.getSelector("#frmAttachPhone").hide(),_DomUtil43.getSelector("#frmAttachPhoneCode").hide(),_DomUtil43.getSelector("#frmAttachDone").hide(),_DomUtil43.getSelector("#"+a).show();var b;switch(a){case"frmAttachPhone":txtPhone.dom.value="",b=txtPhone;break;case"frmAttachPhoneCode":refreshSmsCodeForm(),txtCode.dom.value="",b=txtCode,updateResendCountdown();break;case"frmAttachDone":_DomUtil43.getSelector("#frmAttachDone .imAttachPhoneNumber").updateText(_U73.String.formatPhone("+"+_gCountryCode+txtPhone.dom.value))}checkCurrentForm(),scrollBar.sync(),_focusField(b)},getCodePhrase=function(a){return _WA87.VerifyPhoneBySMS.getSmsCodePhrase(a,_gCodeFromPhone)},refreshSmsCodeForm=function(){var a=_DomUtil43.getSelector("#frmAttachPhoneCode");a.getSelector(".imAttachPhoneNumber").updateText(_U73.String.formatPhone("+"+_gCountryCode+txtPhone.dom.value)),a.getSelector(".im-attachphone-title").updateText(getCodePhrase("title")),a.getSelector(".txtSmsCode").setAttribute("placeholder",getCodePhrase("placeholder"))},updateResendCountdown=function c(){var a=60-_WA87.now()+lastCodeRequested;lblResendTimer.updateText(getCodePhrase("resendCode")+(a>0?" 0:"+a:"")),a>0&&setTimeout(c,1e3)},clearError=function(){for(var a,b=_DomUtil43.get("pageAttachPhone");a=b.getSelector(".im-authpage_error");)a.removeClass("im-authpage_error")},showError=function(a,b){clearError(),b&&_WA87.showPopup(b),a&&(a.addClass("im-authpage_error"),_focusField(a))},closePage=function(){return App.back(),_WA87.Pane.overlay(!1),!1},getCodeByPhone=function(a,b,c){logginIn||(logginIn=!0,_WA87.comApi.requestPhoneCode(a,!1,function(a){logginIn=!1,_gPhoneNumber=a.msisdn,_gTransId=a.trans_id,_gCodeLength=a.code_length,_gCodeRegex=new RegExp(a.key_regex),_gCodeFromPhone="callui"===a.checks,_gCodeFromPhone&&_U73.Mnt.countRB(41343664),b&&b.call()},function(a,b,d){logginIn=!1,c&&c(a,b,d)}))},tryAttachByCode=function(a,b){logginIn||(logginIn=!0,_WA87.comApi.requestAttachPhoneCode(_gPhoneNumber,_gTransId,a,function(a,c){logginIn=!1,b&&b(a,c)}))},_WA88=WebIM,_U74=_WA88.util,_DomUtil44=_WA88.DomUtil,pagesClass=["im-switchphone_hello","im-switchphone_verify","im-switchphone_success"],requestSent=!1,_tryAttachByCode=function(a,b,c,d){requestSent||(requestSent=!0,_WA88.comApi.requestAttachPhoneCode(b,c,a,function(a,b){requestSent=!1,d&&d(a,b)}))},SwitchPhonePage=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.appPageName="switchPhone",a.verifyPhoneForm=new _WA88.VerifyPhoneBySMS({autoSubmitCode:!0,subMessage:_WA88.tr("auth.inputNewPhone")}),a.verifyPhoneForm.cancelEvent.on(a.close,_assertThisInitialized2(_assertThisInitialized2(a))),a.verifyPhoneForm.codeSendEvent.on(function(b,c,d){_tryAttachByCode(b,c,d,function(b,d){var e;if(200===b){var f=c;if(_WA88.ACTIVE_IS_UIN||(f=f.replace(/\d{4}$/,"****")),_WA88.ConnectionFacade.setAttachedPhone(f),a.el){var g='<div class="im-switchphone__success__phone">'.concat(_U74.String.formatPhoneNumber(c),"</div>");a.el.getSelector(".imSwitchedOnPhone").updateHTML(_WA88.tr("auth.successSwitchedOn",{number:g})),a.onSuccessCallback&&a.onSuccessCallback(c)}a.nextPage()}else e=401===b?_WA88.tr("auth.msgWrongCode"):b?d&&d.statusText||_WA88.tr("auth.msgCommonError")+" ("+b+")":_WA88.tr("auth.msgNetworkUnavailable");a.verifyPhoneForm.showCodeError(e)})}),a}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a,b){this.el=_DomUtil44.get(a),this._currentPage=0,this.el.addClass(pagesClass[this._currentPage]);var c=this.el.getSelector(".imVerifyPhoneForm");this.verifyPhoneForm.bind(c,this.el,this.el),this.el.on("click",this._onClick,this),b.onSuccess&&(this.onSuccessCallback=b.onSuccess)}},{key:"onPageUnload",value:function(){this.verifyPhoneForm.unbind(),this.el.un("click",this._onClick,this),this.onSuccessCallback=null}},{key:"nextPage",value:function(){this.el.removeClass(pagesClass[this._currentPage]),this._currentPage++,pagesClass[this._currentPage]?(this.el.addClass(pagesClass[this._currentPage]),1===this._currentPage&&this.verifyPhoneForm.focus()):this.close()}},{key:"_onClick",value:function(a){var b=a.getTarget(!0),c=b.up("im-button");c&&(c.hasClass("btnPhoneOk")?this.nextPage():c.hasClass("btnPhoneCancel")&&this.close())}}]),b}(_WA88.Page);_WA88.switchPhonePage=new SwitchPhonePage;var _WA89=WebIM,_UI47=_WA89.ui,_U75=_WA89.util,RESEND_CODE_TIMEOUT=60,DeleteAccountBox=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,{content:_WA89.TD.getTMPL("deleteAccountBox"),blockCls:"im-delete-account",buttons:[{action:"cancel",text:_WA89.tr("box.cancel")},{action:"ok",text:_WA89.tr("settings.sendSMS"),cls:"im-button_highlight"}]})),a._transData={},a}return _inherits2(b,a),_createClass2(b,[{key:"_onShow",value:function(){if(this.el){_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this);var a=_WA89.Ava.make(_WA89.ACTIVE_MAIL,null,86),c=_WA89.ConnectionFacade.getAttachedPhone();this._transData={phone:c,sentTs:0},this.block.getSelector(".imAvatarBox").updateHTML(a),this.block.getSelector(".imNick").updateText(_WA89.DialogsAbstraction.uNick?"@"+_WA89.DialogsAbstraction.uNick:_WA89.ACTIVE_MAIL),this.block.getSelector(".imInfo").updateHTML(_WA89.tr("settings.youWillGetSmsWithCode",[_U75.String.formatPhoneNumber(c||"")])),this.txtCode=this.block.getSelector(".imSmsCode")}}},{key:"focusField",value:function(){this.txtCode&&setTimeout(this.txtCode.dom.focus.bind(this.txtCode.dom),50)}},{key:"_updateResendButton",value:function(){if(this.block){var a=RESEND_CODE_TIMEOUT-_WA89.now()+this._transData.sentTs,b=this.block.getSelector('.imButton[data-action="resendCode"]'),c=_WA89.tr("auth.resendCode");b.setDisabled(a>0),a>0?(b.updateText(c+" (0:"+a+")"),_WA89.setTimeout(this._updateResendButton,1e3,this)):b.updateText(c)}}},{key:"_requestConfirmationCode",value:function(){var a=this,b=this.block.getSelector(".imButton[data-action=ok]");b&&b.setDisabled(),_WA89.rapi.sendCode(this._transData.phone,!1,function(){for(var b=arguments.length,c=new Array(b),d=0;b>d;d++)c[d]=arguments[d];200===c[0]&&c[3]?(a._transData.sentTs=_WA89.now(),a._transData.sessionId=c[3].sessionId,a._transData.codeLength=c[3].codeLength,a._showConfirmScreen()):_WA89.showPopup(_WA89.tr("auth.msgCommonError")+" ["+(c[2]||c[0])+"]")})}},{key:"_resendCode",value:function(){_WA89.now()-this._transData.sentTs<RESEND_CODE_TIMEOUT||(this._clearError(),this._requestConfirmationCode())}},{key:"_requestDeleteAccount",value:function(){var a=this,b=_U75.String.trim(this.txtCode.dom.value),c={smsCode:b,sessionId:this._transData.sessionId,phone:this._transData.phone};this._clearError(),this._transData.codeLength>0&&b.length!==this._transData.codeLength?this._showError(_WA89.tr("auth.msgWrongCode")):/^\d+$/.test(b)?_WA89.rapi.deleteAccount(c,function(b,c,d){2e4===d?(a.hide(),_U75.Mnt.countRB(53982262),_WA89.ConnectionFacade.logout()):40001===d?a._showError(_WA89.tr("auth.msgWrongCode")):4e4===d?a._showError(_WA89.tr("auth.msgValidationLimit")):_WA89.showPopup(_WA89.tr("auth.msgCommonError")+" ["+(d||b)+"]")}):this._showError(_WA89.tr("auth.msgWrongCode"))}},{key:"_clearError",value:function(){this.block.getSelector(".imError").updateText(""),this.txtCode.removeClass("im-field-text_error")}},{key:"_showError",value:function(a){this.el.getSelector(".imError").updateText(a||""),this.txtCode.addClass("im-field-text_error"),this.focusField()}},{key:"_showConfirmScreen",value:function(){this.block.getSelector(".imStage1").hide(),this.block.getSelector(".imStage2").show();var a=this.block.getSelector(".imButton[data-action=ok]");a&&a.setDisabled(!1).updateText(_WA89.tr("settings.delete")).addClass("im-button_attention").setAttribute("data-action","delete"),this.txtCode.dom.value="",this._updateResendButton(),this.focusField()}},{key:"_onClick",value:function(a){var b=a.up("imButton"),c=b&&b.getAttribute("data-action");switch(c){case"ok":this._requestConfirmationCode();break;case"resendCode":this._resendCode();break;case"delete":this._requestDeleteAccount();break;case"cancel":this.hide()}}},{key:"destroy",value:function(){_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI47.ConfirmModalBox);_WA89.DeleteAccountBox=DeleteAccountBox;var _WA90=WebIM,_UI48=_WA90.ui,_U76=_WA90.util,ERRORS={EMPTY_FIELD:1,OLD_PASSWORD_MISMATCH:2,CONFIRMATION_MISMATCH:3,NO_ERROR:2e4,PASSWORD_UNKNOWN_WEAK:20001,OLD_PASSWORD_MATCH:20002,PASSWORD_SIMPLE:20003,PASSWORD_MATCH_ID:20004,PASSWORD_WEAK:20005,PASSWORD_INCORRECT:20006,PASSWORD_ONLY_DIGITS:20007,PASSWORD_SHORT:20008,PASSWORD_LONG:20009},PASSWORD_LENGTH_REQUIREMENTS="8-16",ChangePasswordBox=function(a){function b(){return _classCallCheck2(this,b),_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,{content:_WA90.TD.getTMPL("changePasswordBox"),blockCls:"im-change-password",buttons:[{action:"cancel",text:_WA90.tr("box.cancel")},{action:"ok",text:_WA90.tr("box.apply"),cls:"im-button_highlight"}]}))}return _inherits2(b,a),_createClass2(b,[{key:"_onShow",value:function(){this.el&&(_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),this.block.getSelector(".imInfo").updateText(_WA90.tr("settings.passwordRequirements",{count:PASSWORD_LENGTH_REQUIREMENTS})),this.p0=this.block.getSelector(".imField0"),this.p1=this.block.getSelector(".imField1"),this.p2=this.block.getSelector(".imField2"),this.p0.dom.focus(),this._validateFields(),this.block.on("input",this._validateFields,this))}},{key:"_clearError",value:function(){this.block.getSelector(".imError").updateText("")}},{key:"_showError",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this.el.getSelector(".imError").updateText(a||""),b&&b.dom.focus()}},{key:"_checkFields",value:function(){return(this.p0.dom.value||"").match(/\S/)&&(this.p1.dom.value||"").match(/\S/)&&(this.p2.dom.value||"").match(/\S/)}},{key:"_validateFields",value:function(){this.block.getSelector(".imButton[data-action=ok]").setDisabled(!this._checkFields())}},{key:"_validateNewPassword",value:function(){var a=this.p1.dom.value;return a.match(/\S{8,16}/)&&a.match(/[0-9]+/)&&a.match(/[a-z]+/)&&a.match(/[A-Z]+/)}},{key:"_remoteCheckOldPassword",value:function(){var a=this;return new Promise(function(b,c){a._cacheOldPasswordMatch?a._cacheOldPasswordMatch===a.p0.dom.value?b():c():_WA90.rapi.checkPassword(a.p0.dom.value,function(d,e,f){f===ERRORS.OLD_PASSWORD_MATCH?(console.log("###.... caching old password"),a._cacheOldPasswordMatch=a.p0.dom.value,b()):c()})})}},{key:"_remoteCheckNewPassword",value:function(){}},{key:"_validate",value:function(){var a=this;return new Promise(function(b,c){a._checkFields()?a._validateNewPassword()?a.p1.dom.value!==a.p2.dom.value?c(ERRORS.CONFIRMATION_MISMATCH):a._remoteCheckOldPassword().then(function(){_WA90.rapi.checkPassword(a.p1.dom.value,function(a,d,e){e===ERRORS.NO_ERROR?b():c(e)})})["catch"](function(){c(ERRORS.OLD_PASSWORD_MISMATCH)}):c(ERRORS.PASSWORD_UNKNOWN_WEAK):c(ERRORS.EMPTY_FIELD)})}},{key:"_submitForm",value:function(){var a=this;this._clearError(),this._validate().then(function(){a.block.getSelector(".imButton[data-action=ok]").setDisabled(!0),_WA90.rapi.resetPassword(a.p0.dom.value,a.p1.dom.value,function(b,c,d){d===ERRORS.NO_ERROR?(_WA90.showPopup(_WA90.tr("settings.passwordChanged")),_U76.Mnt.countRB(53982392),a.hide()):a._onError()})},this._onError.bind(this))["finally"](function(){a._validateFields()})}},{key:"_onError",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(this.el)switch(a){case ERRORS.EMPTY_FIELD:this._showError(_WA90.tr("settings.emptyField"),this.p0);break;case ERRORS.CONFIRMATION_MISMATCH:this._showError(_WA90.tr("settings.passwordsDoNotMatch"),this.p2);break;case ERRORS.OLD_PASSWORD_MISMATCH:this._showError(_WA90.tr("settings.oldPasswordMismatch"),this.p0);break;case ERRORS.PASSWORD_SIMPLE:this._showError(_WA90.tr("settings.passwordWeakWord"),this.p1);break;case ERRORS.OLD_PASSWORD_MATCH:case ERRORS.PASSWORD_MATCH_ID:case ERRORS.PASSWORD_INCORRECT:case ERRORS.PASSWORD_UNKNOWN_WEAK:case ERRORS.PASSWORD_WEAK:case ERRORS.PASSWORD_ONLY_DIGITS:case ERRORS.PASSWORD_SHORT:case ERRORS.PASSWORD_LONG:default:this._showError(_WA90.tr("settings.passwordWeak"),this.p1)}}},{key:"_onClick",value:function(a){var b=a.up("imButton"),c=b&&b.getAttribute("data-action");switch(c){case"ok":this._submitForm();break;case"cancel":this.hide()}}},{key:"destroy",value:function(){this.block.un("input",this._validateFields,this),this.p0=this.p1=this.p2=null,_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI48.ConfirmModalBox);_WA90.ChangePasswordBox=ChangePasswordBox;var _WA91=WebIM,_U77=_WA91.util,_DomUtil45=_WA91.DomUtil,NATIVE_ELEMENT_SELECTOR="[contenteditable],a[href],input,textarea,button",TabNavigator=function(){function a(b){_classCallCheck2(this,a),this._filterFunction=function(){return!0},this.currentFocused=null,this.changeEvent=new _U77.Event,this.overEvent=new _U77.Event,this.initialConfig=_U77.Object.extend({parent:null,loop:!0,ignoreGlobalActive:!1,keepClassName:!1,useNative:!1,className:"im-tab-focused",attrName:"data-tabindex"},b),this.initialConfig.selector=this.initialConfig.selector||"["+this.initialConfig.attrName+"]",this.initialConfig.sortAttr=this.initialConfig.sortAttr||this.initialConfig.attrName,this.parent=this.initialConfig.parent?_DomUtil45.get(this.initialConfig.parent):_DomUtil45.getBody()}return _createClass2(a,[{key:"getCurrentFocused",value:function(){return this.currentFocused}},{key:"setFilterFunction",value:function(a){this._filterFunction=a}},{key:"resetFilterFunction",value:function(){this._filterFunction=function(){return!0}}},{key:"_getSortedElementsArray",value:function(a,b){var c=[];return this.parent&&this.parent.dom&&(_U77.Array.each(this.parent.dom.querySelectorAll(a)||[],function(a){a=_DomUtil45.get(a),a.getStyle("opacity")>0&&a.isVisible(!0)&&c.push(a)}),b&&c.sort(function(a,c){var d=parseInt(a.getAttribute(b)),e=parseInt(c.getAttribute(b));return d>e?1:e>d?-1:0})),c.length?c:null}},{key:"_setNextFocusedElement",value:function(a,b,c){if(a||(a=b),a){this.currentFocused=a;var d=this.initialConfig,e=d.className,f=d.keepClassName;!f&&e&&a.addClass(e),a.on("blur",this._removeClassOnBlur,this),a.dom.focus()}(c&&a&&c.dom!==a.dom||!!c!=!!a)&&(this.changeEvent.fire(c,a),this._currentFocusedIsHidden=!1)}},{key:"switchElement",value:function(a){var b=-1,c=this.initialConfig,d=c.sortAttr,e=c.selector,f=c.useNative,g=c.loop,h=this.currentFocused,i=h;i=this._resetCurrentFocused();var j,k=!1,l=!1,m=f?NATIVE_ELEMENT_SELECTOR:e,n=f?"tabindex":d,o=this._getSortedElementsArray(m,n);if(o){var p=o.length-1;i&&o.some(function(a,c){return a.dom===i.dom?(b=c,!0):void 0});var q;if(q=0>b?a?p:0:b+(a?-1:1),q>p?(k=!0,g&&(q=0)):0>q&&(l=!0,g&&(q=o.length-1)),o[q])for(;!j&&q!==b;)if(j=this._filterFunction(o[q])&&o[q],!j){if(q+=a?-1:1,q>p){if(!g){k=!0;break}q=0}else if(0>q){if(!g){l=!0;break}q=p}0>b&&(b=a?p:0)}this._setNextFocusedElement(j,i,h),(l||k)&&this.overEvent.fire(l,k)}return i}},{key:"hideFocused",value:function(){var a=this.initialConfig,b=a.className,c=a.keepClassName;if(b&&!c){var d=this.currentFocused;d||(d=this.parent.getSelector("."+b)),d&&(this.currentFocused=d,d.removeClass(b),this._currentFocusedIsHidden=!0)}}},{key:"showFocused",value:function(){var a=this.initialConfig,b=a.className,c=a.keepClassName;if(b&&!c){var d=this.currentFocused;d&&(d.addClass(b),this._currentFocusedIsHidden=!1)}}},{key:"_resetCurrentFocused",value:function(){var a=this.initialConfig,b=a.className,c=a.selector,d=a.useNative,e=a.keepClassName,f=a.ignoreGlobalActive,g=this.currentFocused,h=d?NATIVE_ELEMENT_SELECTOR:c;if((!g||b&&!g.hasClass(b))&&(g=b&&this.parent.getSelector("."+b),!g&&!f)){var i=_DomUtil45.get(document.activeElement);i&&this.parent&&this.parent.dom&&i.isAncestor(this.parent)&&i.matchSelector(h)&&(!b||i.hasClass(b))&&(g=i)}return g&&(g.matchSelector(h)?(g.un("blur",this._removeClassOnBlur,this),!e&&b&&g.removeClass(b),g.dom.blur()):g=null),this.currentFocused=null,g}},{key:"reset",value:function(){var a=this.currentFocused,b=this._resetCurrentFocused();return a&&this.changeEvent.fire(a),this._currentFocusedIsHidden=!1,b}},{key:"_removeClassOnBlur",value:function(a){var b=this,c=a.getTarget(!0),d=this.initialConfig,e=d.className,f=d.keepClassName;c.un("blur",this._removeClassOnBlur,this),!f&&e&&c.removeClass(e),this.currentFocused=null,e?_WA91.setTimeout(function(){if(b.parent&&b.parent.dom){var a=b.parent.getSelector("."+e);a||_WA91.inFocus()||!c.dom?(b._currentFocusedIsHidden=!1,b.changeEvent.fire(c)):(c.on("blur",b._removeClassOnBlur,b),b._currentFocusedIsHidden||f||c.addClass(e),b.currentFocused=c)}},100):this.changeEvent.fire(c)}}]),a}();_WA91.TabNavigator=TabNavigator;var _WA92=WebIM,_U78=_WA92.util,_TD28=_WA92.TemplateDriver,_UI49=_WA92.ui,_DomUtil46=_WA92.DomUtil,switchersData={group:[{action:"joinModeration",name:"channel.joinModeration",description:"channel.joinModerationDesc"},{action:"public",name:"group.public",description:"group.publicDesc"}],channel:[{action:"joinModeration",name:"channel.joinModeration",description:"channel.joinModerationDesc"},{action:"public",name:"channel.public",description:"channel.publicDesc"}]},GroupSettingsBox=function(a){function b(){var a,c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck2(this,b);var d={title:"",blockCls:"im-group-settings-box im-modal-box_expand-mobile",content:_WA92.TD.getTMPL("groupSettings"),buttons:[{action:"cancel",text:_WA92.tr("box.cancel")},{action:"ok",text:_WA92.tr("box.ok"),cls:"im-button_highlight"}]};return c=_WA92.applyIf(c,d),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,c)),a.editable=!1,a.avatarHtml="",a.chatInfo={},a._reInfoTimer=null,a.nameField=new _UI49.SmilesTextField,a.aboutField=new _UI49.SmilesTextField,a.rulesField=new _UI49.SmilesTextField,a}return _inherits2(b,a),_createClass2(b,[{key:"_onShow",value:function(){_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),this.chatId=this.initialConfig.chatId,this.block.on("change",this._onChange,this),this._drawAvatar(),this.avatarInput=this.block.getSelector(".imAvatarBox input");var a=this.block.dom.querySelectorAll(".imField");this.nameField.renderBind(_DomUtil46.get(a[0])),this.aboutField.renderBind(_DomUtil46.get(a[1])),this.rulesField.renderBind(_DomUtil46.get(a[2])),this.switchersBlock=this.block.getSelector(".im-livechat-switchers"),this.switchersBlock.on("change",this._onSwitchersChange,this),this.linkBlock=this.block.getSelector(".im-livechat-link"),this.applyButton=this.block.getSelector('.imButton[data-action="ok"]');var c=this.block.getSelector(".im-modal-box__body");this.scrollBar=new _UI49.ScrollBar({source:c}),_WA92.chatController.infoReadyEvent.on(this._onChatInfoReady,this),this._chatInfoRequested=!0,_WA92.chatController.getChatInfo(this.chatId,1)}},{key:"_onHide",value:function(){this.block.un("change",this._onChange,this),this.switchersBlock.un("change",this._onSwitchersChange,this),_WA92.chatController.infoReadyEvent.un(this._onChatInfoReady,this),this.scrollBar.destroy(),this.nameField.renderUnbind(),this.aboutField.renderUnbind(),this.rulesField.renderUnbind(),this._resetAvatar(),this.nickEditor&&(this.nickEditor.destroy(),this.nickEditor=null),this.chatId=null,this._reInfoTimer&&(clearTimeout(this._reInfoTimer),this._reInfoTimer=null),_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this)}},{key:"_drawAvatar",value:function(){if(this.block){var a=_WA92.Ava.make(this.chatId,null,100,this._drawAvatar.bind(this));if(a.remoteLoaded){var b=this.block.getSelector(".imAvatarBox");b.addClass("im-avatar-uploader_loaded"),b.first().updateHTML(a.html)}}}},{key:"_onChange",value:function(a){var b=a.getTarget(!0);b.up("imAvatarBox")&&b.dom.files&&this._onAvatarChoose(b.dom)}},{key:"_onAvatarChoose",value:function(a){var b=this,c=a.files[0];c&&((c.type||"").match(/^image\/(?:jpeg|png|gif)$/)?c.size>_WA92.Ava.MAX_FILE_SIZE?(_WA92.showPopup(_WA92.tr("file.errorFileTooLarge")),a.value=null):_WA92.rapi.uploadAvatar(c,{sn:this.chatId}).then(function(a){var c=a.id;c&&_WA92.setTimeout(function(){b.localIconId!==c&&(b.localIconId=c,b._drawAvatar())},900)},function(a){var b=413===a?"file.errorFileTooLarge":"file.errorFile";_WA92.showPopup(_WA92.tr(b))}):_WA92.showPopup(_WA92.tr("file.errorFile")))}},{key:"_onChatInfoReady",value:function(a,b,c){a===this.chatId&&b&&this._chatInfoRequested&&(delete this._chatInfoRequested,this._applyChatInfo(c))}},{key:"_onClick",value:function(a){var b=this,c=a.up("imButton"),d=c&&c.getAttribute("data-action");if("copyLink"===d){var e=this.linkBlock&&this.linkBlock.getSelector(".imNickLink"),f=e&&e.dom.innerHTML;return void(f&&(_U78.Selection.copy2clipboard(f),_WA92.showPopup(_WA92.tr("msgLinkCopied"))))}if("generateNewLink"!==d)"ok"===d&&this.editable&&this._onOk(),d&&this.hide();else{var g=this.linkBlock&&this.linkBlock.getSelector(".imNickLink");if(this.chatInfo&&this.chatInfo.stamp&&this.chatInfo.live&&!this.chatInfo["public"]&&g.getAttribute("data-action")){var h=new _UI49.ConfirmModalBox({title:_WA92.tr("box.generateNewLinkConfirmTitle"),autoRender:this.el,content:this._isChannel?_WA92.tr("box.generateNewChannelLinkConfirmDesc"):_WA92.tr("box.generateNewLinkConfirmDesc"),buttons:[{action:"cancel",text:_WA92.tr("box.cancel")},{action:"ok",text:_WA92.tr("box.generateNewLinkConfirm"),cls:"im-button_highlight"}],onOk:function(){b._generateNewPrivateLink()}});h.show()}else this._generateNewPrivateLink()}}},{key:"_onOk",value:function(){var a=this._getChanges();a&&(a.email=this.chatId,_WA92.rapi.modifyChat(a))}},{key:"_getChanges",value:function(){var a={},b=!1,c=["name","about","rules"];_U78.Array.each(c,function(c){var d=this[c+"Field"].textVal();d!==(this.chatInfo[c]||"")&&(b=!0,a[c]=d)},this);var d=this.block.dom.querySelectorAll(".im-livechat-switcher");_U78.Array.each(d,function(c){var d,e=c.getAttribute("data-action"),f=c.getElementsByTagName("input")[0],g=f.checked;d=g!==(this.chatInfo[e]===!0),d&&(b=!0,a[e]=g)},this);var e;if(this.nickEditor)e=this.nickEditor.getValue().value;else if(this.linkBlock){var f=this.linkBlock.getSelector(".imNickLink"),g=f&&f.dom.innerHTML;e=g&&g.match(/\/([^\/]+)$/),e=e&&e[1]}return e&&e!==this.chatInfo.stamp&&(a.stamp=e,b=!0),b&&a}},{key:"_applyChatInfo",value:function(a){var b=!(a.controlled&&(!a.you||"admin"!==a.you.role&&"moder"!==a.you.role));this.chatInfo=a,this.editable=b,this._isChannel="readonly"===a.defaultRole,this.block.toggleClass("im-group-settings-box_editable",b),this.block.toggleClass("im-channel-settings",this._isChannel),this.nameField.el.setAttribute("contenteditable",b).updateHTML(_WA92.Emoji.parse(_U78.String.htmlEntity(a.name||""))),this.aboutField.el.setAttribute("contenteditable",b).updateHTML(_WA92.Emoji.parse(_U78.String.htmlEntity(a.about||""))),this.rulesField.el.setAttribute("contenteditable",b).updateHTML(_WA92.Emoji.parse(_U78.String.htmlEntity(a.rules||""))),a.controlled?(this.switchersBlock.show(),this.updateSwitchers(),this.linkBlock&&(this.linkBlock.show(),this.updateLinkBlock(a["public"]))):(this.switchersBlock.hide(),this.linkBlock&&this.linkBlock.hide()),b?this.avatarInput.removeAttribute("disabled"):this.avatarInput.setAttribute("disabled",!0),this.scrollBar.sync()}},{key:"_generateNewPrivateLink",value:function(){var a=this;this.linkBlock.addClass("im-chat-link_loading"),_WA92.rapi.generatePrivateGroupStamp(this.chatId,function(b,c,d,e){if(200===b&&a.chatId===e.requestParams.sn&&e.stamp){var f=_WA92.urlBuilder.chatLink({stamp:e.stamp,live:!0});return a.linkBlock.updateHTML(_TD28.parseSafe("chatLink",{link:f,linkExplanation:_WA92.tr(a._isChannel?"nickBox.channelStampLinkDescription":"nickBox.stampLinkDescription",{product:_WA92.PRODUCT_TITLE,groupName:a.chatInfo&&a.chatInfo.name||""}),spinner:_WA92.TD.getTMPL("CircleSpinner")},{safeKeys:["spinner"]})),void a.linkBlock.removeClass("im-chat-link_loading")}a.linkBlock.removeClass("im-chat-link_loading"),_WA92.showPopup(_WA92.tr("nickBox.serverError"))})}},{key:"_makeNickEditor",value:function(){var a=this;this.linkBlock.updateHTML(_TD28.parseSafe("editGroupNick",{linkExplanation:_WA92.tr(this._isChannel?"nickBox.channelStampLinkDescription":"nickBox.stampLinkDescription",{product:_WA92.PRODUCT_TITLE,groupName:this.chatInfo&&this.chatInfo.name||""}),nickExampleTitle:this._isChannel?_WA92.tr("nickBox.channelStampExampleDescription"):_WA92.tr("nickBox.stampExampleDescription"),preText:_WA92.urlBuilder.chatLink({live:!0}),spinner:_WA92.TD.getTMPL("CircleSpinner")},{safeKeys:["spinner"]})),this.nickEditor=new _UI49.EditNickModule({takenNickMessage:_WA92.tr("nickBox.takenLink"),freeNickMessage:_WA92.tr("nickBox.freeLink"),
focusFieldOnRender:!1,buildLink:function(a){return _WA92.urlBuilder.chatLink({stamp:a,live:!0})},changeStateCallback:function(b){a.applyButton&&(b.applyDisabled?a.applyButton.setAttribute("disabled",!0):a.applyButton.removeAttribute("disabled"))},checkValueCallback:function(b){b&&_WA92.rapi.checkGroupStamp(b,function(c,d,e){a.nickEditor&&(200===c?a.nickEditor.onCheck(b,!0):406===c?a.nickEditor.onCheck(b,!1):a.nickEditor.onCheck(b,!1,!0))})}}),this.nickEditor.render(this.linkBlock.parent(),this.linkBlock)}},{key:"updateSwitchers",value:function(){if(this.editable&&this.chatInfo){var a=this.chatInfo,b=[];_U78.Array.each(this._isChannel?switchersData.channel:switchersData.group,function(c,d){var e={action:c.action,name:_WA92.tr(c.name),description:_WA92.tr(c.description),checked:a[c.action]?"checked":"",style:""};b[d]=_TD28.parseSafe("liveChatSwitcher",e)}),this.switchersBlock.updateHTML(b.join(""))}}},{key:"updateLinkBlock",value:function(a,b){var c=this;if(a)this.nickEditor||this._makeNickEditor(),this.chatInfo&&this.chatInfo.stamp&&this.chatInfo["public"]?(this.nickEditor.setDefaultValue(this.chatInfo.stamp),b&&this.nickEditor.field&&this.nickEditor.field.dom.focus()):(this.nickEditor.showLoading(),_WA92.rapi.generatePublicGroupStamp(this.chatId,function(a,d,e,f){return 200===a&&c.chatId===f.requestParams.sn&&f.stamp?(c.nickEditor.setDefaultValue(f.stamp),c.nickEditor.onCheck(f.stamp,!0),void(b&&c.nickEditor.field&&c.nickEditor.field.dom.focus())):void c.nickEditor.hideLoading()}));else if(this.nickEditor&&(this.nickEditor.destroy(),this.nickEditor=null,this.applyButton.removeAttribute("disabled")),this.chatInfo&&this.chatInfo.stamp&&!this.chatInfo["public"]){var d=_WA92.urlBuilder.chatLink({stamp:this.chatInfo.stamp,live:!0});this.linkBlock.updateHTML(_TD28.parseSafe("chatLink",{link:d,link_attr:this.chatInfo.live?'data-action="copyLink"':"",linkExplanation:_WA92.tr(this._isChannel?"nickBox.channelStampLinkDescription":"nickBox.stampLinkDescription",{product:_WA92.PRODUCT_TITLE,groupName:this.chatInfo&&this.chatInfo.name||""}),spinner:_WA92.TD.getTMPL("CircleSpinner")},{safeKeys:["link_attr","spinner"]})),this.linkBlock.removeClass("im-chat-link_loading")}else this.linkBlock.updateHTML(_WA92.TD.getTMPL("CircleSpinner")),this._generateNewPrivateLink()}},{key:"_onSwitchersChange",value:function(a){var b=this,c=a.getTarget(!0).up("im-livechat-switcher"),d=c.getAttribute("data-action");if("public"===d){if(this.chatInfo&&this.chatInfo["public"]&&this.chatInfo.live){var e=c.getSelector("input").dom;if(!e.checked){this.switchersBlock.un("change",this._onSwitchersChange,this),e.checked=!0,e.setAttribute("checked",!0),this.switchersBlock.on("change",this._onSwitchersChange,this);var f=new _UI49.ConfirmModalBox({title:_WA92.tr("box.publicOffConfirmTitle"),autoRender:this.el,content:this._isChannel?_WA92.tr("box.publicOffChannelConfirmDesc"):_WA92.tr("box.publicOffConfirmDesc"),buttons:[{action:"cancel",text:_WA92.tr("box.cancel")},{action:"ok",text:this._isChannel?_WA92.tr("box.publicOffChannelConfirm"):_WA92.tr("box.publicOffConfirm"),cls:"im-button_highlight"}],onOk:function(){b.switchersBlock.un("change",b._onSwitchersChange,b),e.checked=!1,e.removeAttribute("checked"),b.switchersBlock.on("change",b._onSwitchersChange,b),b.linkBlock&&b.updateLinkBlock(!1)}});return void f.show()}}if(this.linkBlock){var g=c;g=g&&g.getSelector("input").dom;var h=g&&g.checked;this.updateLinkBlock(h,!0)}}}},{key:"_resetAvatar",value:function(){this.avatarInput.dom.value=null}}]),b}(_UI49.ConfirmModalBox);_WA92.GroupSettingsBox=GroupSettingsBox;var _WA93=WebIM,_U79=_WA93.util,ChatController=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.infoSets={},a.stampMap={},a.snMap={},a.statuses={},a._blockingMembers={},a._waitingFullData={},a._requestedInfo={},a._requestedBlocked={},a._requestedAdmins={},a._requestedPending={},a._membersRoleCache={},a._modifyRoleByAction={removeAdminRights:"member",giveAdminRights:"moder",forbidWriting:"readonly",allowWriting:"member"},a._roleChangeMap={admGranted:{role:"moder",adding:!0},admRevoked:{role:"moder",adding:!1},allowedToWrite:{role:"readonly",adding:!1},disallowedToWrite:{role:"readonly",adding:!0}},a._statusesMap={40001:"noStamp",40002:"blocked"},a.blockedMembers={},a.infoReadyEvent=new _U79.Event,a.infoChangedEvent=new _U79.Event,a.chatCreatedEvent=new _U79.Event,_WA93.ChangeLog.updateEvent.on(a._onChangeLogUpdate,_assertThisInitialized2(_assertThisInitialized2(a))),a}return _inherits2(b,a),_createClass2(b,[{key:"saveChatStamp",value:function(a,b){a&&b&&(this.snMap[a]=b,this.stampMap[b]=a)}},{key:"getChatStampBySn",value:function(a){return a&&this.snMap[a]}},{key:"getChatSnByStamp",value:function(a){return a&&this.stampMap[a]}},{key:"getCachedChatInfo",value:function(a){return this.infoSets[a]}},{key:"getChatInfoStatus",value:function(a){return this._statusesMap[this.statuses[a]]}},{key:"getChatInfoByStamp",value:function(a,b,c,d){var e=this;if(this.stampMap[a]&&!c&&this.infoSets[this.stampMap[a]]){var f=this.infoSets[this.stampMap[a]];this.infoReadyEvent.fire(f.sn,!0,f,f.stamp),d&&d(f.sn,f.stamp,!0,f)}else{if(d){var g=function h(b,c,f,g){g===a&&(e.infoReadyEvent.un(h),d(b,g,c,f))};this.infoReadyEvent.on(g)}if(this._requestedInfo[a]&&(!this._requestedInfo[a].limit||b&&this._requestedInfo[a].limit>=b))return;this._requestedInfo[a]={limit:b||0},_WA93.rapi.getChatInfo({stamp:a,limit:b},function(b,c,d){delete this._requestedInfo[a],200!==b&&(this.stampMap[a]&&(this.statuses[this.stampMap[a]]=d),this.infoReadyEvent.fire(this.stampMap[a],!1,d,a))},this)}}},{key:"requestChatWriters",value:function(a,b){_WA93.rapi.getChatWriters({sn:a,keyword:b||""},function(b,c,d){200!==b&&this.infoReadyEvent.fire(a,!1,d)},this)}},{key:"getChatInfo",value:function c(a,b,d,e,f){var g,h=this;if(this.infoSets[a]&&(g=this.infoSets[a].you&&"readonly"===this.infoSets[a].you.role?!0:b?this.infoSets[a].members.length>=b||this.infoSets[a].membersCount<=b:this.infoSets[a].members.length>=this.infoSets[a].membersCount),f){var i=function j(b,c,d,e){b===a&&(h.infoReadyEvent.un(j),f(b,e,c,d))};this.infoReadyEvent.on(i)}if(!this._waitingFullData[a])if(d||!g||e&&!this.infoSets[a].blockedList){if(e&&(this._waitingFullData[a]={blocked:!1,info:!1,email:a},this.getBlockedMembers(a)),this._requestedInfo[a]&&(!this._requestedInfo[a].limit||b&&this._requestedInfo[a].limit>=b))return;this._requestedInfo[a]={limit:b||0};var c=function(){_WA93.rapi.getChatInfo({email:a,limit:b},function(b,c,d){200!==b&&(delete this._requestedInfo[a],delete this._requestedPending[a],this._waitingFullData[a]&&delete this._waitingFullData[a],this.statuses[a]=d,this.infoReadyEvent.fire(a,!1,d,this.infoSets[a]&&this.infoSets[a].stamp||null))},h)};_WA93.CLD.inList(a)?c():this.snMap[a]?(delete this._requestedInfo[a],this.getChatInfoByStamp(this.snMap[a],b,d,f)):_WA93.contactAbstraction.getContactInfoById(a).then(function(c){c.stamp&&(h.saveChatStamp(c.sn,c.stamp),delete h._requestedInfo[a],h.getChatInfoByStamp(c.stamp,b,d,f))},function(){c()})}else this.infoReadyEvent.fire(a,!0,this.infoSets[a],this.infoSets[a].stamp)}},{key:"getBlockedMembers",value:function(a){this._requestedBlocked[a]||(this._requestedBlocked[a]=!0,_WA93.rapi.getBlockedMembers(a,function(b,c,d){200!==b&&(delete this._requestedBlocked[a],this._waitingFullData[a]?this._waitingFullData[a].info&&(delete this._waitingFullData[a],this.infoReadyEvent.fire(a,!0,this.infoSets[a],this.infoSets[a].stamp)):this.infoReadyEvent.fire(a,!1,d,this.infoSets[a]&&this.infoSets[a].stamp||null))},this))}},{key:"getChatAdmins",value:function(a){this._requestedAdmins[a]||(this._requestedAdmins[a]=!0,_WA93.rapi.getChatAdmins(a,function(b,c,d){200!==b&&(delete this._requestedAdmins[a],this.infoReadyEvent.fire(a,!1,d,this.infoSets[a]&&this.infoSets[a].stamp||null))},this))}},{key:"getCommonChats",value:function(a,b){_WA93.rapi.getCommonChats({sn:a},function(a,c,d,e){var f=e||null;b&&b(f)},this)}},{key:"getPendingList",value:function(a){this._requestedPending[a]||(this._requestedPending[a]=!0,_WA93.rapi.getPendingList(a,function(b,c,d){200!==b&&(delete this._requestedPending[a],this.infoReadyEvent.fire(a,!1,d,this.infoSets[a]&&this.infoSets[a].stamp))},this))}},{key:"getMemberRole",value:function(a,b){var c=null;if(this.infoSets[a]&&this.infoSets[a].members){var d=_U79.Array.indexOfBy(this.infoSets[a].members,function(a){var c=a.email;return c===b});d>-1&&this.infoSets[a].members[d]&&(c=this.infoSets[a].members[d])}return!c&&this._membersRoleCache[a]&&(c=this._membersRoleCache[a][b]),c&&c.role||"member"}},{key:"addMembers",value:function(a,b,c,d){_WA93.wimApi.addChatMembers({email:a,members:b},function(a){c&&c.call(d,a)},this)}},{key:"delMembers",value:function(a,b,c,d){_WA93.wimApi.delChatMembers({email:a,members:b},function(a){c&&c.call(d,a)},this)}},{key:"blockMembers",value:function(a,b,c,d,e){this._blockingMembers[a]=b,_WA93.rapi.blockChatMembers({email:a,members:b,withMessages:c},function(c){var f=this;if(200===c){if(this._waitingFullData[a])return;if(this.infoSets[a]&&this._blockingMembers[a]&&this._blockingMembers[a]===b){this.infoSets[a].blockedCount=(this.infoSets[a].blockedCount||0)+b.length,this.infoSets[a].blockedList=this.infoSets[a].blockedList||[];var g={},h=[];b.forEach(function(b){g[b.sn]=!0,f.infoSets[a].blockedList.push({email:b.sn})}),this.infoSets[a].members.forEach(function(a){g[a.email]||h.push(a)}),this.infoSets[a].members=h,this.infoReadyEvent.fire(a,!0,this.infoSets[a],this.infoSets[a].stamp)}}d&&d.call(e,c)},this)}},{key:"unblockMembers",value:function(a,b,c,d){var e=this;_WA93.rapi.unblockChatMembers({email:a,members:b},function(f){if(200===f){if(e._waitingFullData[a])return;var g=!1;if(e.infoSets[a]&&(e.infoSets[a].blockedCount=Math.max(0,(e.infoSets[a].blockedCount||0)-b.length),g=!0),e.infoSets[a].blockedList){var h=[],i={};b.forEach(function(a){var b=a.sn;i[b]=!0}),e.infoSets[a].blockedList.forEach(function(a){i[a.email]||h.push(a)}),e.infoSets[a].blockedList=h,g=!0}g&&e.infoReadyEvent.fire(a,!0,e.infoSets[a],e.infoSets[a].stamp)}c&&c.call(d,f)})}},{key:"modifyMember",value:function(a){var b=this;_WA93.rapi.modifyChatMember(a,function(c){(201===c||200===c)&&b._onConnectionChatMember({mail:a.email,timestamp:_WA93.now(),memberEvent:{type:"roleChanged",role:a.role,members:[a.member]}})})}},{key:"resolvePending",value:function(a,b){_WA93.rapi.resolvePending(a,b)}},{key:"createGroupChat",value:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,d={members:a,name:b};return c&&(d=_U79.Object.extend(d,c)),_WA93.rapi.createGroupChat(d).then(function(a){return a.data?a.data.sn:Promise.reject()})["catch"](function(){_WA93.showPopup(_WA93.tr("chat.createFailed"))})}},{key:"onUpdateClistData",value:function(){var a=this,b=[];Object.keys(this.infoSets).forEach(function(c){var d=a.infoSets[c];d.members&&d.members.forEach(function(a){var e=_WA93.CLD.getFriendlyName(a.email),f=_WA93.CLD.inList(a.email);e&&a.nickname!==e&&(-1===_U79.Array.indexOf(b,c)&&b.push(c),a.nickname=e),a.inCL!==f&&(-1===_U79.Array.indexOf(b,c)&&b.push(c),a.inCL=f),d.blockedList&&d.blockedList.forEach(function(a){var d=_WA93.CLD.getFriendlyName(a.email);d&&a.nickname!==d&&(-1===_U79.Array.indexOf(b,c)&&b.push(c),a.nickname=d)})})}),b.forEach(function(b){a._waitingFullData[b]||a.infoReadyEvent.fire(b,!0,a.infoSets[b],a.infoSets[b].stamp)})}},{key:"chatMemberAction",value:function(a,b){var c=this;this._modifyRoleByAction[b]&&_WA93.ui.showConfirmBox(_WA93.tr("box."+b,{nick:_U79.String.htmlEntity(a.nick||a.mail)}),function(){c.modifyMember({email:a.chat_id,member:a.mail,role:c._modifyRoleByAction[b]})})}},{key:"_onChangeLogUpdate",value:function(a){var b=this,c=[];a.forEach(function(a){var d=a.email||a.mail,e=a.action;"auth"===e&&(e="add"),"add"!==e&&"remove"!==e||!d||_WA93.MainAgent.isChat(d)||Object.keys(b.infoSets).forEach(function(a){var f=b.infoSets[a];if(f.members){var g=_U79.Array.indexOfBy(f.members,function(a){return a.email===d});g>-1&&(-1===_U79.Array.indexOf(c,a)&&c.push(a),f.members[g].inCL="add"===e)}})}),c.forEach(function(a){b._waitingFullData[a]||b.infoReadyEvent.fire(a,!0,b.infoSets[a],b.infoSets[a].stamp)})}},{key:"_onConnectionMchatState",value:function(a){var b=a.sn,c=this.infoSets[b],d=a.infoVersion,e=a.membersVersion;if(c){var f=c.infoVersion&&c.infoVersion<d,g=c.membersVersion&&c.membersVersion<e;(f||g)&&(this.getChatInfo(b,0,!0),this.infoChangedEvent.fire(b,{infoChanged:f,membersChanged:g}))}}},{key:"_onConnectionChatEvent",value:function(a){a.forEach(function(a){switch(a.method){case"add_members":453===a.sip_code&&_WA93.showPopup(_WA93.tr("dialog.addMemberGroupError"),5e3)}})}},{key:"_onConnectionRecentWriters",value:function(a){var b=a.requestParams.sn,c={},d=[];a.writers&&a.persons&&(a.persons.forEach(function(a,b){a.uNick=a.nick,c[a.sn]=b}),a.writers.forEach(function(b){var e=c[b];d.push(a.persons[e])})),this.infoSets[b]||(this.infoSets[b]={}),this.infoSets[b].writersSeachResult={writers:d,query:a.requestParams.keyword},this.infoReadyEvent.fire(b,!0,this.infoSets[b])}},{key:"_onConnectionChatInfo",value:function(a){var b=this;_WA93.ma.contactList.getContactsInfo(a.membersList,function(c){if(c){var d;a.members.forEach(function(a){d=c.indexOf(a.email),d>-1&&(a.inCL=!0,a.nickname=_WA93.CLD.getFriendlyName(a.email),c.splice(d,1))})}a.avatarLastModified?_WA93.Ava.updateGroupChatModified(a.sn,a.avatarLastModified):_WA93.Ava.drop(a.sn);var e,f,g;if(b.infoSets[a.sn]&&(e=b.infoSets[a.sn].blockedList,f=b.infoSets[a.sn].pendingList,g=b.infoSets[a.sn].adminList),b.infoSets[a.sn]=a,b.stampMap[a.stamp]=a.sn,b.snMap[a.sn]=a.stamp,delete b._requestedInfo[a.sn],delete b._requestedInfo[a.stamp],e&&(b.infoSets[a.sn].blockedList=e),f&&(b.infoSets[a.sn].pendingList=f),g&&(b.infoSets[a.sn].adminList=g),b._waitingFullData[a.sn]){if(b._waitingFullData[a.sn].info=!0,!b._waitingFullData[a.sn].blocked&&b._requestedBlocked[a.sn])return;b._waitingFullData[a.sn].blocked&&(b.infoSets[a.sn].blockedList=b._waitingFullData[a.sn].blocked),delete b._waitingFullData[a.sn]}b._requestedPending[a.sn]&&b._requestedPending[a.sn].list&&(a.pendingList=b._requestedPending[a.sn].list,delete b._requestedPending[a.sn]),b.infoReadyEvent.fire(a.sn,!0,a,a.stamp)},{raw:!0,instantly:!0})}},{key:"_onConnectionPendingList",value:function(a){var b=this;return this.infoSets[a.sn]?(delete this._requestedPending[a.sn],this.infoSets[a.sn].pendingList=a.list,this.infoSets[a.sn].pendingCount=a.list.length,void this.infoReadyEvent.fire(a.sn,!0,this.infoSets[a.sn],this.infoSets[a.sn].stamp)):(this._requestedPending[a.sn]={list:a.list},void(this._requestedInfo[a.sn]||(this._requestedInfo[a.sn]={limit:1},_WA93.rapi.getChatInfo({email:a.sn,limit:1},function(c,d,e){200!==c&&(delete b._requestedPending[a.sn],delete b._requestedInfo[a.sn],b._waitingFullData[a.sn]&&delete b._waitingFullData[a.sn],b.statuses[a.sn]=e,b.infoReadyEvent.fire(a.sn,!1,e,null))}))))}},{key:"_onConnectionAdminList",value:function(a){return this.infoSets[a.sn]?(delete this._requestedAdmins[a.sn],this.infoSets[a.sn].adminList=a.list,this.infoSets[a.sn].adminsCount=a.adminsCount,void this.infoReadyEvent.fire(a.sn,!0,this.infoSets[a.sn],this.infoSets[a.sn].stamp)):(this._requestedAdmins[a.sn]={list:a.list},void(this._requestedInfo[a.sn]||(this._requestedInfo[a.sn]={limit:1},_WA93.rapi.getChatInfo({email:a.sn,limit:1},function(b,c,d){200!==b&&(delete this._requestedAdmins[a.sn],delete this._requestedInfo[a.sn],this._waitingFullData[a.sn]&&delete this._waitingFullData[a.sn],this.statuses[a.sn]=d,this.infoReadyEvent.fire(a.sn,!1,d,null))},this))))}},{key:"_onConnectionBlockedMembers",value:function(a){if(delete this._requestedBlocked[a.sn],this._waitingFullData[a.sn]){if(this._waitingFullData[a.sn].blocked=a.list,!this._waitingFullData[a.sn].info)return;delete this._waitingFullData[a.sn]}return this.infoSets[a.sn]?(this.infoSets[a.sn].blockedList=a.list,void this.infoReadyEvent.fire(a.sn,!0,this.infoSets[a.sn],this.infoSets[a.sn].stamp)):(this._waitingFullData[a.sn]={blocked:a.list,info:!1},void(this._requestedInfo[a.sn]||_WA93.rapi.getChatInfo({email:a.sn,limit:1},function(b,c,d){200!==b&&(delete this._requestedPending[a.sn],delete this._requestedInfo[a.sn],this._waitingFullData[a.sn]&&delete this._waitingFullData[a.sn],this.statuses[a.sn]=d,this.infoReadyEvent.fire(a.sn,!1,d,null))},this)))}},{key:"_onConnectionChatModified",value:function(a){if(this.infoSets[a.mail]){var b,c,d;if(a.modifiedInfo){var e=["about","name","rules","avatarLastModified"];switch(_U79.Array.each(e,function(c){a.modifiedInfo.hasOwnProperty(c)&&(this.infoSets[a.mail][c]=a.modifiedInfo[c],b=!0)},this),a.eventTypeId){case"27:39000":this.infoSets[a.mail]["public"]=!0,b=!0;break;case"27:40000":this.infoSets[a.mail]["public"]=!1,b=!0;break;case"27:57500":this.infoSets[a.mail].ageRestriction=!0,b=!0;break;case"27:57600":this.infoSets[a.mail].ageRestriction=!1,b=!0;break;case"27:57100":this.infoSets[a.mail].controlled=this.infoSets[a.mail].joinModeration=!0,b=!0;break;case"27:57200":this.infoSets[a.mail].joinModeration=!1,this.infoSets[a.mail].controlled=!!this.infoSets[a.mail].live,b=!0;break;case"27:57700":this.infoSets[a.mail].defaultRole="readonly",b=!0;break;case"27:57701":this.infoSets[a.mail].you&&(this.infoSets[a.mail].you.role="readonly"),b=!0;break;case"27:57703":this.infoSets[a.mail].you&&(this.infoSets[a.mail].you.role="moder"),b=!0;break;case"27:57704":case"27:57702":this.infoSets[a.mail].you&&(this.infoSets[a.mail].you.role="member"),b=!0;break;case"27:57800":this.infoSets[a.mail].defaultRole="member",b=!0;break;case"27:57300":this.infoSets[a.mail].controlled=this.infoSets[a.mail].live=!0,b=!0;break;case"27:57400":this.infoSets[a.mail].live=!1,this.infoSets[a.mail].controlled=!!this.infoSets[a.mail].joinModeration,b=!0;break;case"27:55000":a.sender===_WA93.ACTIVE_MAIL?(this.infoSets[a.mail].you||(this.infoSets[a.mail].you={}),this.infoSets[a.mail].you.pending=!0,b=!0):a.senderInfo?(this.infoSets[a.mail].pendingCount||(this.infoSets[a.mail].pendingCount=0),this.infoSets[a.mail].pendingCount++,this.infoSets[a.mail].pendingList&&(a.senderInfo.email=a.senderInfo.sn,this.infoSets[a.mail].pendingList.push(a.senderInfo)),d=!0,b=!0):(c=!0,delete this.infoSets[a.mail]);break;case"27:56003":this.infoSets[a.mail].you&&delete this.infoSets[a.mail].you.role,b=!0}}else if(this.infoSets[a.mail].members&&this.infoSets[a.mail].members.length>1)return void this.getChatInfo(a.mail,this.infoSets[a.mail].members.length,!0);if(c)delete this._blockingMembers[a.mail],_WA93.rapi.getChatInfo({email:a.mail},function(b,c,d){200!==b&&(this._waitingFullData[a.mail]&&delete this._waitingFullData[a.mail],this.statuses[a.mail]=d,this.infoReadyEvent.fire(a.mail,!1,d,this.infoSets[a.mail]&&this.infoSets[a.mail].stamp))},this);else if(b){if(d&&this.infoChangedEvent.fire(a.mail,{membersChanged:!0}),this._waitingFullData[a.mail])return;this.infoReadyEvent.fire(a.mail,!0,this.infoSets[a.mail],this.infoSets[a.mail].stamp)}}a.modifiedInfo&&a.modifiedInfo.avatarLastModified&&_WA93.Ava.updateLastModified(a.mail,a.modifiedInfo.avatarLastModified)}},{key:"_onConnectionChatMember",value:function(a){var b,c,d=this,e=this.infoSets[a.mail],f=e&&e.members;if(a.memberEvent){if("roleChanged"===a.memberEvent.type){var g={},h=a.timestamp,i=a.msgId,j=a.memberEvent.role,k=this._membersRoleCache[a.mail]||{};_U79.Array.each(a.memberEvent.members,function(a){var b=!k[a]||(k[a].arch_id&&i?k[a].arch_id<i:k[a].timestamp<=h);b&&(g[a]=!0,k[a]={role:j,timestamp:h,arch_id:i})}),f&&f.forEach(function(a){g[a.email]&&(a.role=j,b=!0)}),this._membersRoleCache[a.mail]=k}else if(f)if(this._roleChangeMap[a.memberEvent.type]){if(a.memberEvent.members&&a.memberEvent.members.length){var l=this._roleChangeMap[a.memberEvent.type];if(l){var m={},n=this._membersRoleCache[a.mail]||{};_U79.Array.each(a.memberEvent.members||[],function(c){c===_WA93.ACTIVE_MAIL&&(b=!0,e.you||(e.you={}),e.you.role=l.adding?l.role:e.defaultRole),m[c]=l.adding?l.role:e.defaultRole,n[c]={role:m[c],timestamp:a.timestamp,arch_id:a.msgId}}),f.forEach(function(a){m[a.email]&&(a.role=m[a.email],b=!0)}),this._membersRoleCache[a.mail]=n}}}else{var o;switch(a.memberEvent.type){case"waitingForApprove":a.memberEvent.members&&a.memberEvent.members.length&&(e.pendingCount||(e.pendingCount=0),_U79.Array.each(a.memberEvent.members||[],function(c){if(c===_WA93.ACTIVE_MAIL&&(e.you||(e.you={}),e.you.pending=!0),e.pendingCount++,e.pendingList){var d=a.persons[c]||{aimId:c};d.sn=d.email=d.aimId,e.pendingList.push(d)}b=!0}));break;case"addMembers":case"invite":case"joiningApproved":if(a.memberEvent.members&&a.memberEvent.members.length){o={};var p={};f.forEach(function(a){p[a.email]=!0}),a.memberEvent.members.forEach(function(d){d===_WA93.ACTIVE_MAIL&&(e.you||(e.you={}),delete e.you.pending,e.you.role=e.defaultRole,b=!0),o[d]=!0,a.persons[d]||(c=!0);var g=a.persons[d]||{aimId:d};g.sn=g.email=g.aimId,g.role=e.defaultRole,p[d]||(e.membersCount++,f.push(g),p[d]=!0,b=!0)})}case"waitingCanceled":case"joiningRejected":if(a.memberEvent.members&&a.memberEvent.members.length){var q=o||{},r=e.pendingList;if(o||a.memberEvent.members.forEach(function(f){return f===_WA93.ACTIVE_MAIL&&e.you&&e.you.pending?(c=!0,b=!0,delete d.infoSets[a.mail],!1):void(q[f]=!0)}),this.infoSets[a.mail])if(b=!0,r&&r.length){var s=[];r.forEach(function(a){q[a.sn]||s.push(a)}),e.pendingList=s,e.pendingCount=s.length}else if(e.pendingCount){var t=Object.keys(q).length;e.pendingCount=e.pendingCount-t}}break;case"delMembers":case"kicked":case"leave":var u={},v=[],w=0;a.memberEvent.members.forEach(function(e){return e===_WA93.ACTIVE_MAIL?(c=!0,b=!0,delete d.infoSets[a.mail],!1):(w++,void(u[e]=!0))}),this.infoSets[a.mail]&&(f.forEach(function(a){u[a.email]||v.push(a)}),b=w>0,e.members=v,e.membersCount=e.membersCount-w)}}else if(["addMembers","invite","joiningApproved"].indexOf(a.memberEvent.type)>-1){var x=_U79.Array.indexOfBy(a.memberEvent.members,function(a){return a===_WA93.ACTIVE_MAIL});x>-1&&(c=!0)}if(c)delete this._blockingMembers[a.mail],_WA93.rapi.getChatInfo({email:a.mail},function(b,c,e){200!==b&&(d._waitingFullData[a.mail]&&delete d._waitingFullData[a.mail],d.statuses[a.mail]=e,d.infoReadyEvent.fire(a.mail,!1,e,d.infoSets[a.mail]&&d.infoSets[a.mail].stamp))});else if(b){if(this.infoChangedEvent.fire(a.mail,{membersChanged:!0}),this._waitingFullData[a.mail])return;this.infoReadyEvent.fire(a.mail,!0,this.infoSets[a.mail],this.infoSets[a.mail].stamp)}}}}]),b}(_WA93.conn.ES6ConnectionRoster);_WA93.chatController=new ChatController;var _WA94=WebIM,_U80=_WA94.util,_Activatable16=_WA94.Activatable,ES6ConnectionRoster=_WA94.conn.ES6ConnectionRoster,_JSON=_WA94.getJSON(),_S4=_WA94.AccountStorage,RELOAD_HISTORY_ON_REFRESH=!1,HISTORY_PART_VOLUME=20,HISTORY_PART_MAX_VOLUME=50,MESSAGE_RESEND_TIMEOUT=3e3,MESSAGE_SENDING_STATUS_DELAY=300,CRITICAL_ERROR_CODES=[400,401,462,600,601,602,603,606],VOIP_EVENTS_MAP=["dialog.outgoingCall","dialog.incomingCall","dialog.missedCall"],_firstLoad=!0,_prepareEventMessageSafe=function(a,b,c){var d=a.text,e="",f="string"==typeof a.event?a.event:!1,g=a.info,h=a.from===_WA94.ACTIVE_MAIL;if(g){var i=_U80.String.htmlEntity(g.sender.aimId),j=_WA94.Emoji.parse(_U80.String.htmlEntity(_WA94.CLD.getFriendlyName(g.sender.aimId)||g.sender.friendly||_WA94.uinAsName(i))),k=("channel"===g.type||c)&&(i===a.dialogSn||i===a.sn),l="voip"===f&&g.voip;if(l){var m=l.inCall===!0?1:0;l.inCall===!0&&"missed"===l.subtype&&(m=2),e=_WA94.tr(VOIP_EVENTS_MAP[m])+(l.duration?" ("+_U80.Date.formatDurationTime(l.duration)+")":"")}else if(b){var n="channel"===g.type||c?channelEventsMap:chatEventsMap;if(n[f]){var o=k?_WA94.tr("group.roleAdmin").replace(/^./,function(a){return a.toUpperCase()}):'<b data-user="'+i+'">'+j+"</b>";if(g.members){var p=[],q=n[f];_U80.Array.each(g.members,function(a){p.push('<b data-user="'+_U80.String.htmlEntity(a.aimId)+'">'+_WA94.Emoji.parse(_U80.String.htmlEntity(_WA94.CLD.getFriendlyName(a.aimId)||a.friendly||a.aimId))+"</b>")}),e=_WA94.tr(q[g.self?h?2:0:1]||q[0],[o,p.join(", ")]),"addMembers"===f&&g.self&&h&&(a.event="invite")}else e=g.name||g.about?_WA94.tr(n[f][h?2:0],[o,_WA94.Emoji.parse(_U80.String.htmlEntity(g.name||g.about))]):"modifiedRules"===f?_WA94.tr(n[f][h?2:0],[o,_WA94.Emoji.parse(_U80.String.htmlEntity(g.rules))]):_WA94.tr(n[f][h?2:0],[o])}else e=_WA94.Emoji.parse(_U80.String.htmlEntity(d))}else e=_WA94.tr(dialogEventsMap[f][h?0:1]||dialogEventsMap[f][0],['<b data-user="'+i+'">'+j+"</b>",g[f]&&g[f].data])}else e=_WA94.Emoji.parse(_U80.String.htmlEntity(d));return e},_repackHistoryItem=function(a,b,c,d,e,f){return{sn:f,from:a.from,text:a.event?_prepareEventMessageSafe(a,c,d):a.text,hidden:!!a.hidden,highlight:a.highlight,gamma:a.gamma,arch_id:a.arch_id,mid:a.mid||null,parts:b,contact:a.contact,poll:a.poll,inlineKeyboardMarkup:a.inlineKeyboardMarkup,date:a.timestamp,event:a.event,info:a.info||null,parse:a.parse,mentions:a.mentions,updated:a.updated,hideEdit:a.hideEdit,sender:a.sender,snippets:a.snippets||null,senderFriendly:a.senderFriendly,sticker:a.sticker||null,state:a.state||c&&"5"||e&&"5"||null}},ChatLooking=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a._lastFocused=null,a.lookingTimeout=new _U80.DelayedTask({interval:3e4,fn:a._sendLooking,scope:_assertThisInitialized2(_assertThisInitialized2(a))}),a}return _inherits2(b,a),_createClass2(b,[{key:"focus",value:function(a,b){this.lookingTimeout.stop(),this.isActive()&&(b?(this._lastFocused&&this._lastFocused!==a&&_WA94.wimApi.sendTyping({t:this._lastFocused,typingStatus:"none"}),this._lastFocused=a,this.lookingTimeout.startNow()):(_WA94.wimApi.sendTyping({t:a,typingStatus:"none"}),this._lastFocused===a&&(this._lastFocused=null)))}},{key:"_sendLooking",value:function(){this._lastFocused&&(_WA94.autoAway.isAway()||_WA94.wimApi.sendTyping({t:this._lastFocused,typingStatus:"looking"}),this.lookingTimeout.start())}},{key:"_onDeactivate",value:function(){this._lastFocused=null,this.lookingTimeout.stop()}}]),b}(_Activatable16);_WA94.chatLooking=new ChatLooking;var DynamicMessage=function(){function a(b){_classCallCheck2(this,a),this.data={dynamic:!0,from:b.from||_WA94.ACTIVE_MAIL,date:b.date,message_id:b.id,text:b.text||""},_WA94.isObject(b.text)&&(b.text.mentions&&(this.data.mentions=b.text.mentions,delete b.text.mentions),b.text.quotes&&b.text.quotes.length?this._prepareQuoteMessage(b.text):this.data.text=b.text.text||"")}return _createClass2(a,[{key:"_prepareQuoteMessage",value:function(a){var b=a.quotes.slice(0),c=a.text,d=this.data.sticker?{mediaType:"sticker",stickerId:this.data.sticker}:{mediaType:"text",text:c};(d.text||d.stickerId)&&b.push(d),this.data.parts=_U80.Array.transform(b,function(a){return a=_U80.Object.extend({},a,!0),a.stickerId&&delete a.text,a}),this.data.text=c||"",this.data.sticker&&(this.data.text=this.data.sticker,delete this.data.sticker)}}]),a}(),OutgoingMessage=function(a){function b(a){var c,d=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck2(this,b),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this));var e=_WA94.now();if(c.mail=a.mail||a.from,c.text=a.text,c.resend=a.resend,c.resendCount=0,c.data={text:a.text,date:a.date||_WA94.TIME_INFINITY,localDate:a.date||e,from:_WA94.ACTIVE_MAIL,message_id:(1e7*Math.random()).toFixed(0),undelivered:1,unread:0,state:0,deliverExpired:0},c.message_id=c.data.message_id,_WA94.isObject(a.text)){if(a.text.editedMessage)c._prepareEditedMessage(c.text);else if(c.resend&&(c.text.text||c.text.sticker||c.text.parts))c._prepareResendMessage(c.text,c.resend);else{if(a.text.pack_id){var f=_WA94.Sticker.getStickerCode(a.text.pack_id,a.text.sticker_id);c.data.sticker=f,c.data.stickerText=_WA94.tr("notify.youHaveSticker"),c.data.text=f}a.text.mentions&&(c.data.mentions=a.text.mentions,delete a.text.mentions),a.text.poll&&(d.poll=a.text.poll,delete a.text.poll),!a.text.text&&a.text.captionedContent&&a.text.captionedContent.url&&(c.data.text=a.text.captionedContent.url,a.caption=a.text.captionedContent.caption),a.text.contact&&(a.contact=a.text.contact,delete a.text.contact),a.text.smartReplyMeta&&(c.data.smartReplyMeta=a.text.smartReplyMeta),a.text.quotes&&a.text.quotes.length?c._prepareQuoteMessage(c.text):a.text.text&&(c.data.text=a.text.text)}c.text=c.data.text||""}if(a.caption)if(c.data.parts){var g=c.data.parts[c.data.parts.length-1];g.text="",g.captionedContent={caption:a.caption,url:c.text}}else c.data.text=" ".concat(c.text," ").concat(a.caption),c.data.parts=[{mediaType:"text",text:"",captionedContent:{caption:a.caption,url:c.text}}];return d.poll&&(c.data.text=c.text,c.data.poll={id:_WA94.Polls.allocate()},c.data.parts=[{mediaType:"text",text:c.text,poll:{type:"anon",responses:d.poll.answers}}]),a.text.poll&&!c.data.parts&&(c.data.parts=[{mediaType:"text",text:c.text,poll:a.text.poll}],delete a.text.poll),a.contact&&!c.data.parts&&(c.data.parts=[{mediaType:"text",text:"",contact:a.contact}]),c.updateEvent=new _U80.Event,c}return _inherits2(b,a),_createClass2(b,[{key:"send",value:function(){var a=this,b=this.data.text,c=this.mail;-1!==c.indexOf("@uin.icq")||c.match(/^\d+$/);var d={to:c,message_id:this.data.message_id,text:this.data.stickerText||b,parse:this.data.parse||null,updateMsgId:this.data.updateMsgId||null,smartReplyMeta:this.data.smartReplyMeta||null,r:this.data.requestId||null};this.data.parts&&(d.parts=_U80.Array.transform(this.data.parts,function(a){return a.captionedContent&&(a=_U80.Object.extend({},a,!0),a.text=""),a.chat&&a.chat.sn&&!_WA94.MainAgent.isChat(a.chat.sn)&&(a=_U80.Object.extend({},a,!0),delete a.chat),a}),delete d.text),this.data.mentions&&(d.mentions=this.data.mentions),this.data.sticker?(d.code=this.data.sticker,this.data.requestId=_WA94.wimApi.sendSticker(d,function(a,b){this.updateEvent.fire(this.data.message_id)}.bind(this))):this.data.requestId=_WA94.wimApi.sendMessage(d,function(a,b){_U80.Mnt.countRB(41352564),a?this.updateEvent.fire(this.data.message_id):(this.resendCount++,-1===CRITICAL_ERROR_CODES.indexOf(b)?this.resendCount>2?_WA94.showPopup(_WA94.tr("dialog.msgSendingFailed")):_WA94.setTimeout(this.send,MESSAGE_RESEND_TIMEOUT,this):this.updateEvent.fire(this.data.message_id))}.bind(this)),_WA94.setTimeout(function(){a._updateReadState(2),2===a.data.state&&a.updateEvent.fire(a.data.message_id)},MESSAGE_SENDING_STATUS_DELAY)}},{key:"_prepareEditedMessage",value:function(a){this.editing=!0,this.data.text=a.text;var b=a.editedMessage;if(this.data.updateMsgId=b.msgId,a.mentions&&(this.data.mentions=a.mentions),b.parts&&b.parts.length){this.data.parts=_U80.Array.transform(b.parts,function(a){return a=_U80.Object.extend({},a,!0),a.stickerId&&delete a.text,a});var c=this.data.parts[this.data.parts.length-1];c.text=a.text,c.captionedContent&&(c.captionedContent=_U80.Object.extend({},c.captionedContent,!0),c.captionedContent.caption=a.text,c.text="")}}},{key:"_prepareResendMessage",value:function(a,b){if(this.data.text=a.text,a.mentions&&(this.data.mentions=a.mentions),!b.from)return(a.sticker||a.stickerId)&&(this.data.text=a.sticker||a.stickerId,this.data.sticker=this.data.text,this.data.stickerText=_WA94.tr("notify.youHaveSticker")),void(a.contact&&!this.data.parts&&(this.data.parts=[{mediaType:"text",text:"",contact:a.contact}]));if(a.parts)this.data.parts=a.parts,a.sticker&&(this.data.text=a.sticker);else{var c={sn:a.sender||a.from,time:a.date,msgId:a.arch_id};a.senderFriendly&&(c.friendly=a.senderFriendly),a.sticker?(c.stickerId=a.sticker,this.data.text=a.sticker):c.text=this.data.text,a.contact&&(c.contact=a.contact),a.poll&&(c.poll=a.poll),this.data.parts=[c]}var d;if(b.from&&(_WA94.MainAgent.isChat(b.from)||this.mail===_WA94.ACTIVE_MAIL)){d={sn:b.from},b.name&&(d.name=b.name);var e=_WA94.chatController.getCachedChatInfo(b.from);e&&e["public"]&&e.stamp&&(d.stamp=e.stamp)}this.data.parts=_U80.Array.transform(this.data.parts,function(a){var b=_U80.Object.extend({},a,!0);
return b.mediaType="forward","forward"!==a.mediaType&&!a.chat&&d&&(b.chat=d),b},this);var f=this.data.parts[this.data.parts.length-1];f.msgId||(f.msgId=a.arch_id,f.time=a.date,f.sn=a.sender||a.from)}},{key:"_prepareQuoteMessage",value:function(a){var b=a.quotes.slice(0),c=a.text,d=this.data.sticker?{mediaType:"sticker",stickerId:this.data.sticker}:{mediaType:"text",text:c};a.contact&&(d.contact=a.contact),(d.text||d.stickerId)&&b.push(d),this.data.parts=_U80.Array.transform(b,function(a){return a=_U80.Object.extend({},a,!0),a.stickerId&&delete a.text,a}),this.data.text=c||"",this.data.sticker&&(this.data.text=this.data.sticker,delete this.data.sticker)}},{key:"_updateReadState",value:function(a,b){b&&(this.data.mid=this.data.arch_id=b),this.data.state<a&&(this.data.state=a,3===a&&_WA94.ring("sent")),a>3&&delete this.data.undelivered}},{key:"_onConnectionMessageSent",value:function(a){a.message_id===this.data.message_id&&(this.data.date=a.timestamp||this.data.localDate,this._updateReadState(3,a.arch_id),this.updateEvent.fire(a.message_id))}},{key:"_onConnectionHistoryState",value:function(a,b){if(this.mail===a.sn&&this.data.mid){var c=this.data.state;if(a.theirs&&a.theirs.lastDelivered>=this.data.mid&&(c=4,a.theirs.lastRead>=this.data.mid&&(c=5)),c){this._updateReadState(c);var d=this.data.message_id;5===c&&delete this.data.message_id,b||this.updateEvent.fire(d)}}}},{key:"destroy",value:function(){_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this),this.updateEvent.removeAll()}}]),b}(ES6ConnectionRoster);_WA94.OutgoingMessage=OutgoingMessage;var chatEventsMap={addMembers:["chat.message.attached","chat.message.add","chat.message.attached"],invite:["chat.message.attached","chat.message.add","chat.message.attached"],delMembers:["chat.message.detached","chat.message.del","chat.message.detached"],kicked:["chat.message.detached","chat.message.del","chat.message.detached"],leave:["chat.message.detached"],admRevoked:["chat.message.admRevoked"],admGranted:["chat.message.admGranted"],rename:["chat.message.rename","","chat.message.youRename"],modify:["chat.message.modifyAbout","","chat.message.youModifyAbout"],modifiedRules:["chat.message.userChangedChatRules","","chat.message.youChangedChatRules"],changeIcon:["chat.message.changeIcon","","chat.message.youChangeIcon"],create:["chat.message.create"],pinMessage:["chat.message.pinMessage","","chat.message.youPinMessage"],invitationCanceled:["chat.message.invitationCanceled"]},channelEventsMap={addMembers:["channel.message.attached","channel.message.add","channel.message.attached"],invite:["channel.message.attached","channel.message.add","channel.message.attached"],delMembers:["channel.message.detached","channel.message.del","channel.message.detached"],kicked:["channel.message.detached","channel.message.del","channel.message.detached"],leave:["channel.message.detached"],admRevoked:["channel.message.admRevoked"],admGranted:["channel.message.admGranted"],rename:["channel.message.rename","","channel.message.youRename"],modify:["channel.message.modifyAbout","","channel.message.youModifyAbout"],modifiedRules:["channel.message.userChangedChatRules","","channel.message.youChangedChatRules"],changeIcon:["channel.message.changeIcon","","channel.message.youChangeIcon"],create:["channel.message.create"],pinMessage:["channel.message.pinMessage","","channel.message.youPinMessage"]},dialogEventsMap={bday:["dialog.hasBirthdayToday"],addedToBuddyList:["dialog.youAddToCL","dialog.addedYouToCL"],buddyReg:["dialog.nowAvailableFroChat"],buddyFound:["dialog.recentlyAddedToTelBook"],voip:["dialog.outgoingCall","dialog.incomingCall"]},_convertHistoryFromOldFormat=function(a){return a[0]instanceof Array?a:[a]},ignoreListIsRequestedFromHistory=!1,History=function(a){function b(a){var c;return _classCallCheck2(this,b),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),c.dialog=a,c.dialog.history=c.dialog.history||[[]],c.dialog.history=_convertHistoryFromOldFormat(c.dialog.history),c.dialog.historyCurrentPack=c.dialog.history.length-1,c.updateEvent=new _U80.Event,c.clearHistoryEvent=new _U80.Event,c._instances={},c._patchCache={},c._requestedKeys={},c._requestCallbacks={},c._fetchHistory(),_WA94.chatController.infoReadyEvent.on(c._onChatInfoReady,_assertThisInitialized2(_assertThisInitialized2(c))),c}return _inherits2(b,a),_createClass2(b,[{key:"_fetchHistory",value:function(){_WA94.now();if(this.dialog.history){var a,b=[];this.dialog.history=_convertHistoryFromOldFormat(this.dialog.history),_U80.Array.each(this.dialog.history,function(c){var d=[];_U80.Array.each(c,function(a){(!a.dynamic||_WA94.fileTools.getUploadedFileInfo(a.message_id))&&(a.auth&&(this._has_auth=a.auth),(a.from!==_WA94.ACTIVE_MAIL||a.state>2)&&d.push(a))},this),b.push(d),a=d},this),this.dialog.history=b,_WA94.isProblemStrictSafari&&this.dialog.auth&&!this._has_auth&&(a&&a.length?a[a.length-1].auth=1:a||(a=[],b.push(a)))}}},{key:"append",value:function(a){this.dialog.history||(this.dialog.history=[[]]);var b,c=this.dialog.history[this.dialog.history.length-1];if(!(a instanceof DynamicMessage&&(b=!0,this._indexOf(a.data,"message_id",c)>-1))){for(var d,e=c.length-1;!d&&c[e];)d=c[e].mid,e--;c.push(a.data),this.dialog.lastMessageDate=a.data.date,this.dialog.lastMessageId=a.data.arch_id,a instanceof OutgoingMessage&&(this._instances[a.data.message_id]=a,a.updateEvent.on(this._onMessageUpdate,this),b=!0),this.updateEvent.fire(b,!1,[{type:"new",afterMid:d,message:a.data,historyPart:c}])}}},{key:"_onMessageUpdate",value:function(a){var b=this._instances[a],c=this.dialog.history[this.dialog.history.length-1],d=[];if(b){var e=b.data.mid;if(e){var f=_U80.Array.indexOfBy(c,function(a){return a.mid===e&&a!==b.data});f>-1&&(c.splice(f,1),d.push({type:"remove",message_id:a,historyPart:c}))}b&&!b.data.message_id&&(b.destroy(),delete this._instances[a]),d.push({type:"modified",mid:b.data.mid,message_id:a,message:b.data,historyPart:c})}var g=this._sort(c);g>-1&&d.unshift({type:"sort",index:g,historyPart:c}),this.updateEvent.fire(!0,!1,d)}},{key:"loadPatch",value:function(){this._patchRequested||(this._patchRequested=!0,this.cbRequest({email:this.dialog.mail,count:-1,patchVersion:this.dialog.patchVersion},function(a){this._patchRequested=!1;var b=a&&this._updateHistoryFromPatch(a);this.updateEvent.fire(b&&!0,!1,b)}.bind(this)))}},{key:"multiRequest",value:function(a,b){var c=a.length,d=[];this._patchRequested=!0,_U80.Array.each(a,function(a){var e=function(a){a&&d.push(a),c--,c||(this._patchRequested=!1,b&&b(d))}.bind(this);this.cbRequest(a,e)},this)}},{key:"cbRequest",value:function(a,b){var c=_WA94.rapi.getHistory(a,function(a,c,d){200!==a&&(delete this._requestCallbacks[c],b())},this);this._requestCallbacks[c]=b}},{key:"loadMiddlePack",value:function(a){for(var b,c=a,d=[],e=-1;0>e;)e=c.slice(-10),c=c.slice(0,-10),b=e.length,e=e?(e-1).toString():"",d.unshift(new Array(b-e.length+1).join("0")+e);c=(c+d.join("")).replace(/^0+/,""),this.dialog.requestedHistoryPackFlag=!0,console.log("###loadMiddlePack ",c),this.multiRequest([{email:this.dialog.mail,msgId:c,count:21,patchVersion:this.dialog.patchVersion},{email:this.dialog.mail,msgId:a,count:-20,patchVersion:this.dialog.patchVersion}],function(b){if(b.length<2)return delete this.dialog.requestedHistoryPackFlag,void this.updateEvent.fire();this._cacheUnread&&(this._cacheUnread={count:this.dialog.unreadCount,mid:this.dialog.lastRead}),this.dialog.insertingHistoryPackFlag=!0;var c,d,e=b[0].email;b[0].olderMsgId&&b[1].olderMsgId&&(c=b[0].olderMsgId<b[1].olderMsgId?b[0].olderMsgId:b[1].olderMsgId),b[0].newerMsgId&&b[1].newerMsgId&&(d=b[1].newerMsgId>b[0].newerMsgId?b[1].newerMsgId:b[0].newerMsgId);var f={email:e,olderMsgId:c,newerMsgId:d,history:b[0].history.concat(b[1].history)},g=this._updateHistory(f),h=this.dialog.history[g.packNum],i=this.dialog.history[this.dialog.historyCurrentPack],j=_U80.Array.indexOfBy(h||[],function(b){return b.arch_id===a});if(this.dialog.requestedHistoryPackFlag&&j>-1)delete this.dialog.requestedHistoryPackFlag,this.dialog.historyCurrentPack=g.packNum;else if(this.dialog.historyLoaded!==!0&&i.length<HISTORY_PART_VOLUME)return void this.load();this.updateEvent.fire(g.updateTabs,!1,g.viewPatches)}.bind(this))}},{key:"getHistoryPack",value:function(a){var b=this.dialog.history||[[]];b=_convertHistoryFromOldFormat(b);var c=_U80.Array.indexOfBy(b,function(b){var c=_U80.Array.indexOfBy(b,function(b){return b.arch_id===a});return c>-1});c>-1?(this.dialog.historyCurrentPack=c,this.dialog.insertingHistoryPackFlag=!0,this._cacheUnread&&(this._cacheUnread={count:this.dialog.unreadCount,mid:this.dialog.lastRead}),!this.dialog.historyLoaded&&b[b.length-1].length<HISTORY_PART_VOLUME?this.load():this.updateEvent.fire()):this.loadMiddlePack(a)}},{key:"loadPack",value:function(a){var b,c=this.dialog.historyCurrentPack,d=this.dialog.history||[[]];d=_convertHistoryFromOldFormat(d);var e=d.length-1,f=d[c];f||(c=this.dialog.historyCurrentPack=0,f=d[0]);var g=this.getSideArchId(a,f),h=a?20:-20;if(g){if(a){if(c>=e)return;b=d[c+1][0]}else if(c)b=d[c-1][d[c-1].length-1];else if(this.dialog.historyLoaded===!0)return;b=b&&b.arch_id}else h=-20;var i=[g||-1,h,b||null,this.dialog.patchVersion].join("_");this._requestedKeys[i]||(this._requestedKeys[i]=!0,this._patchRequested=!0,_WA94.rapi.getHistory({email:this.dialog.mail,msgId:g,patchVersion:this.dialog.patchVersion,tillMsgId:b,count:h},function(b,c,d){delete this._requestedKeys[i],200!==b&&(this._patchRequested=!1,this.dialog.historyLoaded||a||(40401===d||4e4===d)&&(this.dialog.historyLoaded=!0,4e4===d&&(this.dialog.isNotMember=!0)),this.updateEvent.fire())},this))}},{key:"load",value:function(){var a=this.dialog.history||[[]];a=_convertHistoryFromOldFormat(a),this.dialog.historyCurrentPack=a.length-1;var b=a[this.dialog.historyCurrentPack].length;if(!(this.dialog.historyLoaded===!0||this.dialog.historyLoaded&&b>=HISTORY_PART_VOLUME)){var c=-HISTORY_PART_VOLUME,d=-1,e=this.dialog.unreadCount||this._cacheUnread&&this._cacheUnread.count||0;if(console.log("@@@@@ LOAD HISTORY",e,this.dialog.unreadCount),_WA94.MainAgent.isChat(this.dialog.mail)?(this.waitForChatInfo=!0,_WA94.chatController.getChatInfo(this.dialog.mail,5)):_WA94.CLD.blockedIsReady()||(this.waitForChatInfo=!0,ignoreListIsRequestedFromHistory||(ignoreListIsRequestedFromHistory=!0,_WA94.wimApi.getIgnoreList())),e>HISTORY_PART_MAX_VOLUME)return d=this._cacheUnread&&this._cacheUnread.mid||this.dialog.lastRead,void this.getHistoryPack(d);e>HISTORY_PART_VOLUME-5&&(c=-(e+5));var f=[d,c,null,this.dialog.patchVersion].join("_");this._requestedKeys[f]||(this._requestedKeys[f]=!0,this._patchRequested=!0,_WA94.rapi.getHistory({email:this.dialog.mail,msgId:d,patchVersion:this.dialog.patchVersion,count:c},function(a,b,c){delete this._requestedKeys[f],200!==a&&(this._patchRequested=!1,this.dialog.historyLoaded||((40401===c||4e4===c)&&(this.dialog.historyLoaded=!0,4e4===c&&(this.dialog.isNotMember=!0)),this.updateEvent.fire()))},this))}}},{key:"_repack",value:function(a){var b,c=[],d=a.email,e=this._patchCache,f=_WA94.MainAgent.isChat(d),g=this.dialog.isChannel,h=d.indexOf("@uin.icq")>0;return a.history&&_U80.Array.each(a.history,function(a){var i=a[1];e[i.arch_id]?delete e[i.arch_id]:(b=i.parts||null,b&&!b.length&&(b=null),i.event&&i.info&&"channel"===i.info.type&&(this.dialog.isChannel=!0),c.push(_repackHistoryItem(i,b,f,g,h,d)))},this),c}},{key:"markMessageAsRead",value:function(a,b){if(this.dialog.history&&this.dialog.history.length&&(!this.dialog.lastRead||this.dialog.lastRead<a)){var c=_convertHistoryFromOldFormat(this.dialog.history),d=this.dialog.lastRead||0,e=this.dialog.lastReadMention||0,f=0,g=0;return _U80.Array.each(c,function(b){_U80.Array.each(b,function(b){if(b.mid){if(b.mid>a)return!1;b.mid>d&&(f++,b.mentions&&b.mentions.indexOf(_WA94.ACTIVE_MAIL)>-1&&b.mid>e&&(g++,e=b.mid)),delete b.unread}},this)},this),this.dialog.unreadCount<1e3&&(this.dialog.unreadCount=Math.max(0,this.dialog.unreadCount-f)),this.dialog.unreadCount||delete this.dialog.unread,b&&g&&(this.dialog.mentionSyncCount||this.dialog.mentionCount)&&(this.dialog.mentionSyncCount&&(this.dialog.mentionSyncCount=Math.max(0,this.dialog.mentionSyncCount-g)),this.dialog.mentionCount&&(this.dialog.mentionCount=Math.max(0,this.dialog.mentionCount-g)),this.dialog.lastReadMention=e),this.dialog.lastRead=a,_WA94.rapi.setDialogState({email:this.dialog.mail,msgId:a}),!0}}},{key:"markHistoryAsRead",value:function(a){var b;if(this._cacheUnread={count:this.dialog.unreadCount,mid:this.dialog.lastRead},this.dialog.history&&this.dialog.history.length){var c=_convertHistoryFromOldFormat(this.dialog.history);_U80.Array.each(c,function(a){_U80.Array.each(a,function(a){a.mid&&(this.dialog.lastRead&&this.dialog.lastRead>=a.mid||(delete a.unread,(!b||b<a.mid)&&(b=a.mid||a.arch_id)))},this)},this)}return!b&&this.dialog.unread&&this.dialog.unreadCount>0&&(b=this.dialog.lastRead),b&&(this.dialog.lastRead=b,a||_WA94.rapi.setDialogState({email:this.dialog.mail,msgId:b})),!!b}},{key:"makeAuthorized",value:function(){var a=!1;if(this.dialog.history&&this.dialog.history.length){var b=_convertHistoryFromOldFormat(this.dialog.history);_U80.Array.each(b[b.length-1],function(b,c){b.auth&&(delete b.auth,a=!0)},this)}return a}},{key:"_sortCb",value:function(a,b){return a.arch_id&&b.arch_id?b.arch_id&&a.arch_id>b.arch_id?1:-1:a.date<b.date?-1:(a.date>b.date,1)}},{key:"_sort",value:function(a){a=a||this.dialog.history[this.dialog.history.length-1];var b=a===this.dialog.history[this.dialog.history.length-1];if(a&&a.sort){var c=a.map(function(a){return a.mid||a.message_id});a.sort(this._sortCb.bind(this));var d=a.map(function(a){return a.mid||a.message_id}),e=-1;if(c.some(function(a,b){return d[b]!==a?(e=b,!0):void 0}),b){_WA94.isProblemStrictSafari&&this.dialog.auth&&!this._has_auth&&a.length&&(a[a.length-1].auth=1);var f=a[a.length-1];f&&(this.dialog.lastMessageId=f.arch_id,this.dialog.lastMessageDate=f.date)}return e}}},{key:"_indexOf",value:function(a,b,c){c||(c=this.dialog.history[this.dialog.history.length-1]),b||(b="arch_id");var d=a[b],e=_U80.Array.indexOfBy(c,function(a){return d&&"0"!==d&&a[b]===d?!0:void 0},this);return e}},{key:"removeMessage",value:function(a,b,c){var d={};d[b]=a,c=c||this.dialog.history[this.dialog.history.length-1];var e=this._indexOf(d,b,c);if(-1!==e){d=c.splice(e,1)[0];var f={type:"remove",historyPart:c};return d.mid?f.mid=d.mid:f.message_id=d.message_id,this.updateEvent.fire(!0,!1,[f]),d}}},{key:"getSideArchId",value:function(a,b){if(!b){var c=this.dialog.history||[[]];c=_convertHistoryFromOldFormat(c),b=c[c.length-1]}for(var d=b,e=a?d.length-1:0,f=a?-1:1;d[e]&&!d[e].arch_id;)e+=f;return d[e]&&(d[e].mid||d[e].arch_id)}},{key:"getLastMessage",value:function(){var a=this.dialog.history||[[]];a=_convertHistoryFromOldFormat(a);var b=a[a.length-1];return b[b.length-1]}},{key:"_addUniqOnly",value:function(a,b){if(this.dialog.history||(this.dialog.history=[[]]),!b){var c=this.dialog.history;c=_convertHistoryFromOldFormat(c),b=c[c.length-1]}var d,e,f=_WA94.MainAgent.isChat(this.dialog.mail),g=b[0]&&b[0].mid,h=b[0]&&b[b.length-1].mid,i=[],j=[],k={};if(_U80.Array.each(a,function(a){var c=this._indexOf(a,null,b);-1===c?(a.auth&&(this._has_auth=a.auth),f&&a.sender&&!this.dialog.cast[a.sender]&&(e=_WA94.CLD.getInfo(a.sender),e.nick=e.nick||a.senderFriendly||_WA94.CLD.getFriendlyName(a.sender),e.nick&&(delete e.email,this.dialog.cast[a.sender]=e)),d||(d=[]),k[a.mid]||(k[a.mid]=!0,a.mid>h?(d.push({type:"new",message:a,historyPart:b}),i.push(a)):a.mid<g?j.push(a):(d.push({type:"new",message:a,historyPart:b}),b.push(a)))):a.mid&&(b[c].message_id&&this._instances[b[c].message_id]&&b[c].parts&&a.parts&&(a.parts=b[c].parts),_U80.Object.extend(b[c],a,!0),d||(d=[]),d.push({type:"modified",mid:a.mid,message:a,historyPart:b}))},this),i.length){var l;i.sort(this._sortCb.bind(this)),(l=b).push.apply(l,i)}if(j.length){var m;j.sort(this._sortCb.bind(this)),j.forEach(function(a){d.unshift({type:"new",message:a,toStart:!0,historyPart:b})}),(m=b).unshift.apply(m,j)}return d}},{key:"_delHistoryUpto",value:function(a){this.dialog.history||(this.dialog.history=[]);var b,c,d=[],e=this.dialog.history||[[]];e=_convertHistoryFromOldFormat(e);var f=this.dialog.historyCurrentPack;void 0===f&&(f=e.length-1);var g=[];_U80.Array.each(e,function(e,h){c=[],_U80.Array.each(e,function(b){!b.mid&&!b.auth||b.mid>a?c.push(b):g.push({type:"remove",mid:b.mid,historyPart:e})}),f===h&&(f=c.length?d.length:h+1),b=b||c.length!==e.length,c.length&&d.push(c)}),d[0]||(d=[[]],f=0,b&&(this.dialog.historyLoaded=!0)),this.dialog.historyCurrentPack=f,this.dialog.history=d,b&&this.updateEvent.fire(!0,!1,g)}},{key:"_getModifiedMessages",value:function(a){_U80.Array.each(a,function(a){this.cbRequest({email:this.dialog.mail,count:a.count,msgId:a.from,tillMsgId:a.till,patchVersion:this.dialog.patchVersion},this._modifyMessage.bind(this))},this)}},{key:"_modifyMessage",value:function(a){if(a&&a.history&&a.history.length){var b=(this._repack(a)||[])[0];if(b){var c=this.dialog.history||[[]];c=_convertHistoryFromOldFormat(c);var d=-1,e=_U80.Array.indexOfBy(c,function(a){return d=_U80.Array.indexOfBy(a,function(a){return b.arch_id===a.arch_id}),d>-1});if(e>-1&&d>-1){_WA94.DialogsAgent.resetBoundUrlFromMessage(b.arch_id);var f=c[e];this._instances[f[d].message_id]?_U80.Object.extend(f[d],b,!0):f.splice(d,1,b),this.dialog.insertingHistoryFlag=!0,this.updateEvent.fire(!0,!1,[{type:"modified",mid:b.mid,message:b,historyPart:f}])}}}}},{key:"_checkPinnedState",value:function(a){a?this.dialog.pinned&&this.dialog.pinned.msgId===a[0].msgId&&this.dialog.pinned.updatePatchVersion===a[0].updatePatchVersion||(this.dialog.pinned=a[0],delete this.dialog.collapsePinned):(delete this.dialog.pinned,delete this.dialog.collapsePinned)}},{key:"_updateHistoryFromPatch",value:function(a){var b=a&&a.patch;if(a.patchVersion&&(this.dialog.patchVersion=a.patchVersion),b&&b.length){var c,d,e,f=[],g=this._patchCache,h={},i=[],j=!1;if(this._checkPinnedState(a.pinned),_U80.Array.each(b,function(a){switch(a.type){case"clear":return j=!0,!1;case"delete":g[a.msgId]=!0;break;case"update":case"modify":h[a.msgId]=!0}}),j)return this.dialog.history=[[]],this.dialog.historyCurrentPack=0,this.dialog.historyLoaded=!1,this.clearHistoryEvent.fire(this.dialog.mail),this.load(),!1;var k=this.dialog.history||[[]];k=_convertHistoryFromOldFormat(k);var l=this.dialog.historyCurrentPack;void 0===l&&(l=k.length-1);var m=[];return _U80.Array.each(k,function(a,b){c=[],_U80.Array.each(a,function(b){g[b.arch_id]?(delete g[b.arch_id],d=!0,m.push({type:"remove",mid:b.arch_id,historyPart:a})):(c.push(b),e&&(i.push(c[c.length-3]?{count:1,from:c[c.length-3].arch_id,till:b.arch_id}:{count:-1,from:b.arch_id}),e=!1),h[b.arch_id]&&(e=!0))}),e&&(i.push(c[c.length-2]?{count:1,from:c[c.length-2].arch_id,till:-1}:{count:-1,from:-1}),e=!1),l===b&&(l=c.length?f.length:b+1),c.length&&f.push(c)}),f[0]||(f=[[]],l=0),this.dialog.historyCurrentPack=l,this.dialog.history=f,this._patchCache=g,this._getModifiedMessages(i),d&&m}}},{key:"_updateHistory",value:function(a,b,c){this.dialog.insertingHistoryFlag=!(!this.dialog.history||!this.dialog.history.length),this._patchRequested=!1;var d,e,f=!1;if(a.lastRead&&(!this.dialog.lastRead||a.lastRead>this.dialog.lastRead)&&(f=!0,this.dialog.lastRead=a.lastRead),a.theirs&&a.theirs.lastRead&&(f=f||this.dialog.theirsLastRead!==a.theirs.lastRead,this.dialog.theirsLastRead=a.theirs.lastRead),a.lastMessageHeads&&(this.dialog.lastMessageHeads&&this.dialog.lastMessageHeads.length===a.lastMessageHeads.length||(f=!0),this.dialog.lastMessageHeads=a.lastMessageHeads),a.persons&&_U80.Array.each(a.persons,function(a){this.dialog.cast[a.sn]||(this.dialog.cast[a.sn]={nick:a.friendly||a.nickname})},this),a.pinned&&this._checkPinnedState(a.pinned),a.history&&a.history.length){this.dialog.history||(this.dialog.history=[[]]);var g=this.dialog.history;d=g.length-1;var h=g[d],i=g.length,j=a.newerMsgId,k=a.olderMsgId,l=g[i-1]&&g[i-1][g[i-1].length-1],m=this.dialog.historyCurrentPack;if(h.length){if(k&&l&&l.arch_id<k&&(this.dialog.unreadCount<500&&_U80.Mnt.log({reason:"lostMessagesFromHistory",sn:_WA94.ACTIVE_MAIL,packSize:h.length,olderMsgId:k,localLastMsgId:l.arch_id,dlgSn:this.dialog.mail,hasUnread:this.dialog.unreadCount>0,unreadCount:this.dialog.unreadCount}),c=!0),c)h=[],g.push(h),d=i+1;else if(!b){if(j)for(;i--&&!(j>=g[i][0].arch_id););else i=d;!g[i+1]||g[i]&&(j===g[i][0].arch_id||k&&k<=g[i][g[i].length-1].arch_id)?(h=g[i],d=i,g[i-1]&&k<=g[i-1][g[i-1].length-1].arch_id&&(g.splice(i-1,2,h=g[i-1].concat(h)),d=i-1,m>=i&&m--)):(h=[],g.splice(i+1,0,h),d=i+1,m>i&&m++)}m!==this.dialog.historyCurrentPack&&(this.dialog.historyCurrentPack=m)}var n=this._addUniqOnly(this._repack(a),h),o=this._sort(h);o>-1&&(n=[{type:"sort",index:o,historyPart:h}]),a.patchVersion&&(this.dialog.patchVersion=a.patchVersion),a.requestParams&&"init"!==a.requestParams.patchVersion&&(e=this._updateHistoryFromPatch(a),f=e?!0:f),e=e?(n||[]).concat(e):n,i=g.length-1,f=f||(g[i]&&g[i][g[i].length-1])===l}return this.dialog.historyLoaded!==!0&&(a.olderMsgId?b||(this.dialog.historyLoaded="loaded"):this.dialog.historyLoaded=!0),{updateTabs:f,packNum:d,viewPatches:e}}},{key:"_updateInviteMessage",value:function(a){if(a){if(a.you&&"admin"===a.you.role){var b=this.dialog.history&&this.dialog.history[0],c=[Number(!a.avatarLastModified),Number(!a.about)].join(""),d=b.filter(function(a){return"invite"===a.event})[0];d&&d.buttonsState!==c&&(d.buttonsState||(d.eventText=_prepareEventMessageSafe({from:a.sn,event:"create",info:{self:!0,sender:{aimId:d.sender,friendly:d.senderFriendly},members:a.members}},!0,this.dialog.isChannel)),d.buttonsState=c,this.waitForChatInfo=!0)}}else _WA94.chatController.getChatInfo(this.dialog.mail)}},{key:"_onChatInfoReady",value:function(a,b,c){a===this.dialog.mail&&(b&&c&&(c.stamp&&(this.dialog.stamp=c.stamp),this.dialog.isChannel="readonly"===c.defaultRole,this.dialog.canWrite=c.you&&c.you.role&&"readonly"!==c.you.role,this.dialog.historyLoaded===!0&&_WA94.MainAgent.isChat(this.dialog.mail)&&this._updateInviteMessage(c),this.dialog.isNotMember&&c.you&&c.you.role&&(delete this.dialog.isNotMember,this.dialog.historyLoaded===!0&&(this.dialog.historyLoaded=this.dialog.history&&this.dialog.history[0]&&this.dialog.history[0].length?"loaded":!1,this.waitForChatInfo=!0,this.dialog.historyLoaded?this.loadPack():this.load()))),this.waitForChatInfo&&(delete this.waitForChatInfo,this.updateEvent.fire(!0,!0)))}},{key:"_onConnectionContactHistory",value:function(a,b,c,d){if(a.email===this.dialog.mail){if(a.reqId&&this._requestCallbacks[a.reqId]){var e=this._requestCallbacks[a.reqId];return delete this._requestCallbacks[a.reqId],e(a)}var f=this._updateHistory(a,b,c);if(this.dialog.historyLoaded===!0&&_WA94.MainAgent.isChat(this.dialog.mail)&&this._updateInviteMessage(),!b&&this._cacheUnread&&(this._cacheUnread={count:this.dialog.unreadCount,mid:this.dialog.lastRead}),(!b||d===a.email)&&this.dialog.historyLoaded===!0&&_WA94.Feature.getModeParameter("hideEmptyDialog")){var g=null,h=this.dialog.history[this.dialog.history.length-1];h&&h.some(function(a){return a.event?void 0:g=!0}),g||_WA94.wimApi.hideActiveDialog({email:this.dialog.mail,lastMsgId:h[h.length-1].mid})}this.updateEvent.fire(f.updateTabs,!1,f.viewPatches)}}},{key:"_onConnectionSearchOneDialog",value:function(a){if(this._reqId&&a.requestParams&&a.requestParams.reqId===this._reqId.reqId){var b=a.requestParams.sn;b===this.dialog.mail&&a.persons&&_U80.Array.each(a.persons,function(a){this.dialog.cast[a.sn]||(this.dialog.cast[a.sn]={nick:a.friendly||a.nickname})},this)}}},{key:"_onConnectionSearchAllDialogs",value:function(a){this._reqId&&a.requestParams&&a.requestParams.reqId===this._reqId.reqId}},{key:"_checkIdentityOfMessages",value:function(a,b){if(b.text===a.text||a.sticker&&a.sticker===b.sticker)return!0;if(a.parts&&b.parts){var c=!0;return _U80.Object.each(a.parts,function(a,d){return c=a.stickerId?b.parts[d].stickerId===a.stickerId:b.parts[d].text===a.text,c?void 0:c}),c}return!1}},{key:"updateChatHeads",value:function(a){var b=this.dialog.positions||{},c=!1,d={};a.resetState&&(d=b,b={});var e={};a.positions&&(a.positions.forEach(function(a){for(var f=b[a.msgId]||[],g=a.heads.length-1;g>=0;g--)-1===f.indexOf(a.heads[g].sn)&&(c=!0,f.unshift(a.heads[g].sn)),e[a.heads[g].sn]=a.msgId;f.length&&(b[a.msgId]=f,c&&(d[a.msgId]=f))}),Object.keys(b).forEach(function(a){var f=!1;b[a]=b[a].filter(function(b){return e[b]&&e[b]!==a?(f=!0,console.log("### remove head "+b+" from "+a),!1):!0}),f&&(c=!0,d[a]=b[a])})),this.dialog.positions=b,c&&this.updateEvent.fire(!0,!1,[{type:"heads",heads:d}])}},{key:"updateState",value:function(a,b){var c,d,e,f=!1;a.theirs&&a.theirs.lastRead&&(this.dialog.theirsLastRead!==a.theirs.lastRead&&(c=!0),this.dialog.theirsLastRead=a.theirs.lastRead);var g=a.lastMessageHeads&&a.lastMessageHeads.length||0;g!==(this.dialog.lastMessageHeads&&this.dialog.lastMessageHeads.length||0)&&(c=!0,this.dialog.lastMessageHeads=a.lastMessageHeads),a.delUpto?this._delHistoryUpto(a.delUpto):(this.dialog.suspicious=a.suspicious,this.dialog.stranger=a.stranger,c=!0,a&&(a.olderMsgId&&this.dialog.lastMessageId&&this.dialog.lastMessageId<a.olderMsgId&&(f=!0),e=a.lastMsgId)),d=a.patchVersion||this.dialog.patchVersion||"init";var h=a&&a.historyPart;if(h&&h.email===this.dialog.mail){var i=[];a.noRecentsUpdate||(this.dialog.isRecent=!0),_U80.Array.each(h.history||[],function(a){var b=this;if("message"===a[0]){var c=a[1];c.modifiedInfo&&c.modifiedInfo.name&&this.dialog.cast[this.dialog.mail]&&(this.dialog.cast[this.dialog.mail].nick=c.modifiedInfo.name),c.from===_WA94.ACTIVE_MAIL&&c.mid>=(h.lastRead||0)&&Object.keys(this._instances).some(function(a){return!b._instances[a].data.arch_id&&b._checkIdentityOfMessages(c,b._instances[a].data)?(b._instances[a].data.mid=b._instances[a].data.arch_id=c.mid,b._instances[a].data.date=c.timestamp,b._instances[a].data.parts&&c.parts&&(c.parts=b._instances[a].data.parts),!0):void 0}),i.push(a)}},this),h.history=i,i.length&&(this.dialog.addingMessageFlag=!0),i.length&&this._onConnectionContactHistory(h,!0,f,b),f&&this.dialog.historyCurrentPack<this.dialog.history.length-1&&this.loadPack(!0)}if(e&&this.dialog.lastMessageId&&e>this.dialog.lastMessageId){this.dialog.unreadCount<500&&_U80.Mnt.log({reason:"lostMessagesFromDlgState",sn:_WA94.ACTIVE_MAIL,remoteLastMsgId:e,localLastMsgId:this.dialog.lastMessageId,dlgSn:this.dialog.mail,hasUnread:this.dialog.unreadCount>0,unreadCount:this.dialog.unreadCount});var j=-1,k=-HISTORY_PART_VOLUME,l=[j,k,null,this.dialog.patchVersion].join("_");this._requestedKeys[l]||(this._requestedKeys[l]=!0,this._patchRequested=!0,_WA94.rapi.getHistory({email:this.dialog.mail,msgId:j,patchVersion:this.dialog.patchVersion,count:k},function(a,b,c){delete this._requestedKeys[l],200!==a&&(this._patchRequested=!1,this.dialog.historyLoaded||((40401===c||4e4===c)&&(this.dialog.historyLoaded=!0,4e4===c&&(this.dialog.isNotMember=!0)),this.updateEvent.fire()))},this))}history&&history.length||!c||this.updateEvent.fire(c),this.dialog.patchVersion?d!==this.dialog.patchVersion&&this.loadPatch():d&&(this.dialog.patchVersion=d)}},{key:"destroy",value:function(){_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this),_U80.Object.each(this._instances,function(a){a.destroy()},this),this.updateEvent.removeAll(),this.clearHistoryEvent.removeAll(),this.__destroyed=!0}}]),b}(ES6ConnectionRoster),Dialog=function(){function a(b,c){if(_classCallCheck2(this,a),this.data=c||{mail:b,modifDate:+new Date,modifDataFactor:0,lastMessageId:0,lastMessageDate:0,cast:{},unreadCount:0},this.data.unreadCount=this.data.unreadCount||0,this.data.cast[_WA94.ACTIVE_MAIL]={nick:_WA94.DialogsAbstraction.nick},this.history=new History(this.data),this.history.updateEvent.on(this._onHistoryUpdate,this),this.focusedEvent=new _U80.Event,this.updateEvent=new _U80.Event,this.clearHistoryEvent=new _U80.Event,this.clearHistoryEvent.relay(this.history.clearHistoryEvent),this.typingTimeout=new _U80.DelayedTask({interval:15e3,fn:this._onTypingTimeout,scope:this}),this.data.typing){var d=+new Date,e=15e3-(d-(this.data.typing[0]||this.data.typing));e>0?this.typingTimeout.start(e,this._onTypingTimeout,this):delete this.data.typing}}return _createClass2(a,[{key:"updateChatHeads",value:function(a){this.history.updateChatHeads(a)}},{key:"updateHistoryState",value:function(a,b){this.history.updateState(a,b)}},{key:"updateSelfNickDialog",value:function(a,b){this.data.cast[_WA94.ACTIVE_MAIL].nick=a,this.data.cast[_WA94.ACTIVE_MAIL].uNick=b,this.data.modifDate=+new Date,this.updateEvent.fire()}},{key:"_onTypingTimeout",value:function(){this.data.typing&&(this.data.modifDataFactor++,delete this.data.typing,this.updateEvent.fire(!0))}},{key:"setTyping",value:function(a){this.data.modifDataFactor++,this.data.typing=[+new Date,a],this.updateEvent.fire(!0),this.typingTimeout.start(15e3)}},{key:"stopTyping",value:function(){this.data.typing&&(this.data.modifDataFactor++,this.typingTimeout.stop(),delete this.data.typing,this.updateEvent.fire(!0))}},{key:"setCast",value:function(a){delete a.email,this.data.cast[this.data.mail]=a,this.updateEvent.fire(!0)}},{key:"focus",value:function(a){var b=this.data.history||[[]];b=_convertHistoryFromOldFormat(b),this.data.historyCurrentPack=b.length-1,this.focusedEvent.fire(this.data.mail,this),this.data.historyLoaded!==!0&&(a?this.history.getHistoryPack(a):this.history.load())}},{key:"syncMentionMe",value:function(a){this.data.mentionSyncCount=a,this.data.modifDataFactor++,0===a&&(this.data.mentionIds=[],this.data.mentionCount=0),this.updateEvent.fire(!0)}},{key:"syncLastReadMention",value:function(a){this.data.mentionIds||(this.data.mentionIds=[]),this.data.lastReadMention=a;var b=this.data.mentionIds.filter(function(b){return b>a}),c=b.length;c<this.data.mentionIds.length&&(this.data.mentionIds=b,this.data.mentionCount=c,this.data.mentionSyncCount>c&&(this.data.mentionSyncCount=c),this.data.modifDataFactor++,this.updateEvent.fire(!0))}},{key:"syncLastRead",value:function(a){if(a&&(!this.data.lastRead||this.data.lastRead<a)){if(this.data.lastRead=a,this.data.mentionIds&&this.data.mentionIds.length&&(!this.data.lastReadMention||this.data.lastReadMention<a)){var b=this.data.mentionIds.filter(function(b){return a>=b}).pop();b&&this.syncLastReadMention(b)}this.data.modifDataFactor++,this.updateEvent.fire(!0)}}},{key:"addMentionMe",value:function(a){(!this.data.lastRead||this.data.lastRead<a)&&(this.data.mentionIds||(this.data.mentionIds=[]),this.data.mentionIds.push(a),this.data.mentionCount=this.data.mentionIds.length,this.data.modifDataFactor++,this.updateEvent.fire(!0))}},{key:"readMentionMe",value:function(a){var b,c,d=[];if(this.data.mentionIds&&this.data.mentionIds.length)return a&&(d=this.data.mentionIds.filter(function(b){return b>a})),c=d.length,b=c<this.data.mentionCount,this.data.mentionIds=d,this.data.mentionCount=c,this.data.mentionSyncCount>c&&(this.data.mentionSyncCount=c),b}},{key:"resetPin",value:function(){delete this.data.pinned,delete this.data.collapsePinned}},{key:"togglePin",value:function(a){a?delete this.data.collapsePinned:this.data.pinned&&(this.data.collapsePinned=this.data.pinned.msgId),this.updateEvent.fire()}},{key:"isUnread",value:function(){return this.data.unread}},{key:"updateCounter",value:function(a){this.data.unread=1,this.data.unreadCount=a,this.data.modifDataFactor++,this.typingTimeout.stop(),delete this.data.typing,this.updateEvent.fire(!0)}},{key:"markMessageAsRead",value:function(a,b){var c=!0;return b&&(c=!this.readMentionMe(b)),this.history.markMessageAsRead(a,c)}},{key:"markDialogAsRead",value:function(a){var b,c=this.history.markHistoryAsRead(!!a);(c||this.data.unreadCount)&&(this.data.mentionCount&&0!==this.data.mentionCount||(this.data.mentionSyncCount=0),this.data.unreadCount=0,b=!0),a?!!a.attention!=!!this.data.unread&&(a.attention?this.data.unread=1:delete this.data.unread,b=!0):this.data.unread&&(delete this.data.unread,c||_WA94.wimApi.setUnreadFlag({
sn:this.data.mail,unread:0},function(a){a||this.data.unread||(this.data.unread=1,this.data.modifDataFactor++,this.updateEvent.fire(!0))},this),b=!0),b&&(this.data.modifDataFactor++,this.updateEvent.fire(!0))}},{key:"markAsUnread",value:function(){this.data.unread||(this.data.unread=1,_WA94.wimApi.setUnreadFlag({sn:this.data.mail,unread:1},function(a){a||this.data.unreadCount||(delete this.data.unread,this.data.modifDataFactor++,this.updateEvent.fire(!0))},this),this.data.modifDataFactor++,this.updateEvent.fire(!0))}},{key:"makeAuthorized",value:function(){(this.history.makeAuthorized()||this.data.auth)&&(delete this.data.auth,delete this.data.historyLoaded,this.history.load(),this.data.modifDate=+new Date,this.updateEvent.fire(!0))}},{key:"getHistory",value:function(){return this.history}},{key:"removeFromRecent",value:function(){this.data.isRecent=!1,this.updateEvent.fire(!0)}},{key:"_onHistoryUpdate",value:function(a,b,c){this.history.waitForChatInfo||(this.data.modifDate=+new Date,this.updateEvent.fire(a,this.data.mail,b,{patch:c,sn:this.data.mail}))}},{key:"destroy",value:function(){this.history.destroy(),this.focusedEvent.removeAll(),this.updateEvent.removeAll(),this.clearHistoryEvent.removeAll(),this.typingTimeout.stop()}}]),a}(),DialogsCache=function(a){function b(a){var c;return _classCallCheck2(this,b),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),c._firstSync=!0,c.updateEvent=new _U80.Event,c.focusEvent=new _U80.Event,c.clearHistoryEvent=new _U80.Event,c.data={dialogs:[]},c._instances={},c._unreadData={},c._mentionMeData={},c._unreadCounter=0,c._unreadDialogsCounter=0,c._mutedData={},c}return _inherits2(b,a),_createClass2(b,[{key:"_fetchDialogs",value:function(){if(this.data.dialogs&&this.data.dialogs.length){_U80.Array.each(this.data.dialogs,function(a){a.cast&&a.cast[a.mail]&&(_WA94.CLD.saveMute(a.mail,a.cast[a.mail].mute),a.cast[a.mail].nick&&_WA94.CLD.saveFriendly(a.mail,a.cast[a.mail].nick)),(a.unread||a.typing)&&(a.unreadCount&&(this.updateUnreadCounter(a.mail,a.unreadCount),this._makeInstance(a.mail)),this.updateMarkCounter(a.mail,a.unread))},this);var a=this.getFocused();a&&(a.history.load(),a.data.stamp&&(_WA94.chatController.saveChatStamp(a.data.mail,a.data.stamp),a.history.waitForChatInfo=!0))}}},{key:"_indexOfDialog",value:function(a){return _U80.Array.indexOfBy(this.data.dialogs,function(b){return b.mail===a?!0:void 0})}},{key:"checkDialogAsNewest",value:function(a){var b=this._indexOfDialog(a);if(-1!==b){var c=this.getLastMessage(a);c=c&&c.date;var d=this.getLastMessage(this.data.dialogs[this.data.dialogs.length-1].mail);return d=d&&d.date,d>=c}}},{key:"moveDialogToEnd",value:function(a){var b=this._indexOfDialog(a);if(-1!==b&&b!==this.data.dialogs.length-1){var c=this.data.dialogs.splice(b,1)[0];this.data.dialogs.push(c),this.data.dialogsModifDate=+new Date}}},{key:"moveDialogInPlace",value:function(a){var b=this._indexOfDialog(a),c=this.data.dialogs[b];if(c&&(this.data.dialogs[b+1]&&(this.data.dialogs[b+1].lastMessageId<c.lastMessageId||this.data.dialogs[b+1].lastMessageDate<c.lastMessageDate)||this.data.dialogs[b-1]&&(this.data.dialogs[b-1].lastMessageId>c.lastMessageId||this.data.dialogs[b-1].lastMessageDate>c.lastMessageDate))){var d=this.data.dialogs.length;_U80.Array.each(this.data.dialogs,function(a,e){var f=a.lastMessageId&&c.lastMessageId&&a.lastMessageDate!==c.lastMessageDate?a.lastMessageDate>c.lastMessageDate:a.lastMessageId>c.lastMessageId;return e!==b&&f?(d=e,!1):void 0}),this.data.dialogs.splice(b,1),this.data.dialogs.splice(d-(d>b?1:0),0,c),this.data.dialogsModifDate=+new Date,this.commit()}}},{key:"editHiddenMarkOnMessage",value:function(a,b,c){var d,e,f=this._indexOfDialog(a);if(f>-1){var g=this.data.dialogs[f].history;e=g[g.length-1],g.some(function(a,c){return a[0].mid>b?(e=g[c-1],!0):void 0}),e&&(d=e.filter(function(a){var c=a.mid;return c===b})[0])}d&&(d.hidden=!!c,this.data.dialogs[f].modifDate=+new Date,this.commit(!0,{sn:a,patch:[{type:"modified",mid:b,message:d,historyPart:e}]}))}},{key:"getIfExist",value:function(a){var b=this._indexOfDialog(a);return-1!==b?this.get(a):void 0}},{key:"get",value:function(a){return a&&!this._instances[a]&&this._makeInstance(a),this._instances[a]}},{key:"_makeInstance",value:function(a){var b=this._indexOfDialog(a);this.data.dialogs[b]?this._instances[a]=new Dialog(a,this.data.dialogs[b]):(this._instances[a]=new Dialog(a),this.data.dialogs.push(this._instances[a].data),this.data.dialogsModifDate=+new Date),this._unreadData[a]&&(this._instances[a].data.unreadCount=this._unreadData[a],this._instances[a].data.unread=1),this._mentionMeData[a]&&(this._instances[a].data.mentionIds=_U80.Array.clone(this._mentionMeData[a]),this._instances[a].data.mentionCount=this._mentionMeData[a].length,this._instances[a].data.mentionSyncCount=this._mentionMeData[a].length),this.setMute(a,(this._instances[a].data.cast[a]||{}).mute),this._instances[a].focusedEvent.on(this._onDialogFocused,this),this._instances[a].updateEvent.on(this._onDialogUpdate,this),this._instances[a].clearHistoryEvent.on(this._onHistoryClear,this)}},{key:"_moveDialog",value:function(a,b){var c=this.data.dialogs.splice(a,1)[0];this.data.dialogs.splice(b,0,c)}},{key:"_onDialogFocused",value:function(a,b){if(this.data.focused!==a){if(this.data.focused){var c=this.getIfExist(this.data.focused);this.focusEvent.fire(this.data.focused,!1),c&&!c.data.isRecent&&(this.updateUnreadCounter(this.data.focused,0),this.close(this.data.focused)),c&&c.data.modifDataFactor++}this.data.dialogsModifDate=+new Date,b&&b.data.modifDataFactor++}this.data.focused=a,this.focusEvent.fire(a,!0),this.commit()}},{key:"blur",value:function(){if(this.data.focused){var a=this.getIfExist(this.data.focused);a&&a.data.modifDataFactor++,this.data.dialogsModifDate=+new Date,this.focusEvent.fire(this.data.focused,!1)}this.data.focused=!1,this.commit()}},{key:"_onDialogUpdate",value:function(a,b,c,d){if(a&&(this.data.dialogsModifDate=+new Date),c){var e=_WA94.chatController.getCachedChatInfo(b);!e||e.you&&e.you.role||e.joinModeration||!e.stamp||this.data.focused!==b||this.subscribeToGroup(e.stamp)}this.commit(!!b,d)}},{key:"_onHistoryClear",value:function(a){this.clearHistoryEvent.fire(a)}},{key:"count",value:function(){return this.data.dialogs.length}},{key:"getFocusedId",value:function(){return this.data.focused}},{key:"getFocused",value:function(){return this.data.focused?this.get(this.data.focused):!1}},{key:"getDataFromDialog",value:function(a){return this._instances[a]&&this._instances[a].data}},{key:"reopenFocused",value:function(){var a=this.getFocused();a&&(a.data.modifDate=+new Date,this.data.dialogsModifDate=+new Date,this.commit())}},{key:"updateMentionMeData",value:function(a,b){this._mentionMeData[a]||(this._mentionMeData[a]=[]),b?this._mentionMeData[a].push(b):delete this._mentionMeData[a]}},{key:"updateMarkCounter",value:function(a,b){b?a in this._unreadData||(this._unreadData[a]=0,this._unreadDialogsCounter++):a in this._unreadData&&(delete this._unreadData[a],this._unreadDialogsCounter--)}},{key:"updateUnreadCounter",value:function(a,b,c){b=b||0;var d=!1,e=this._unreadData[a]||0,f=b-e;if(c&&f>0){var g,h=_WA94.Feature.getModeParameter("forceSoundInFocusedDialog");h?g=this.data.focused===a:(g=!_WA94.CLD.getMute(a),g=g&&this.data.focused!==a),g&&(this._newIncomingMessage=a)}return b?(a in this._unreadData||this._mutedData[a]?0===this._unreadData[a]&&this._mutedData[a]&&this._unreadDialogsCounter--:this._unreadDialogsCounter++,this._unreadData[a]=b):((0===this._unreadData[a]||this._unreadData[a]&&!this._mutedData[a])&&this._unreadDialogsCounter--,delete this._unreadData[a]),this._mutedData[a]||(this._unreadCounter+=f,d=!!f),d}},{key:"setMute",value:function(a,b){return!this._mutedData[a]!=!b?(b?(this._mutedData[a]=b,this._unreadCounter-=this._unreadData[a]||0,this._unreadData[a]&&this._unreadDialogsCounter--):(delete this._mutedData[a],this._unreadCounter+=this._unreadData[a]||0,this._unreadData[a]&&this._unreadDialogsCounter++),!0):void 0}},{key:"getUnreadCounter",value:function(a){return a?this._unreadData[a]||0:this._unreadCounter}},{key:"getUnreadDialogsCounter",value:function(){return this._unreadDialogsCounter}},{key:"getLastUnread",value:function(){for(var a=this.data.dialogs,b=a.length;b--;)if(a[b].unread&&!a[b].cast[a[b].mail].mute)return a[b]}},{key:"getOpenDialogs",value:function(){var a=_U80.Array.transform(this.data.dialogs||[],function(a){return a&&a.mail});return a}},{key:"eachDialog",value:function(a,b){_U80.Array.each(this.data.dialogs,function(c,d){var e=c.mail;a.call(b||this,c,e,d)},this)}},{key:"updateSelfNick",value:function(a,b){this.preventCommit(),_U80.Object.each(this._instances,function(c){c.updateSelfNickDialog(a,b)},this),this.permitCommit()}},{key:"onUpdateClistData",value:function(){var a;this.preventCommit(),_U80.Array.each(this.data.dialogs,function(b){var c=!1,d=b.mail;_U80.Object.each(b.cast,function(a,b){var d=_WA94.CLD.getFriendlyName(b),e=_WA94.CLD.getMute(b),f=_WA94.CLD.getAuthStatus(b),g=_WA94.CLD.getLastseen(b),h=_WA94.CLD.getUserState(b),i=_WA94.CLD.getUNick(b),j=_WA94.CLD.isBlocked(b),k=_WA94.CLD.isBot(b);d&&d!==a.nick&&(a.nick=d,c=!0),i&&i!==a.uNick&&(a.uNick=i,c=!0),a.mute!==e&&(a.mute=e,this.setMute(b,e),c=!0),a.lastseen!==g&&(a.lastseen=g,c=!0),a.userState!==h&&(a.userState=h,c=!0),a.bot!==k&&(a.bot=k,c=!0),f&&!f.needAuth&&a.needAuth&&(a.needAuth=!1,f.status&&(a.status=f.status),c=!0),a.blocked!==j&&(a.blocked=j,c=!0)},this),this._instances[d]&&this._instances[d].history&&!_WA94.MainAgent.isChat(d)&&this._instances[d].history.waitForChatInfo&&(delete this._instances[d].history.waitForChatInfo,ignoreListIsRequestedFromHistory=!1,c=!0),c&&(b.modifDate=+new Date,a=!0)},this),a&&(this.data.dialogsModifDate=+new Date,this.commit()),this.permitCommit(),_WA94.chatController.onUpdateClistData()}},{key:"closeAll",value:function(){this.destroy(),this._instances={},this.data.dialogs=[],this.data.focused=!1,this.data.dialogsModifDate=+new Date,this.commit()}},{key:"close",value:function(a,b){this._instances[a]&&(this._destroyDialog(this._instances[a]),delete this._instances[a]),this.data.focused==a&&(this.data.focused=!1,b=!0);var c=this._indexOfDialog(a);if(-1!=c){var d=this.data.dialogs[c].history;d=_convertHistoryFromOldFormat(d),d=d[d.length-1],d&&d.length&&d[d.length-1].mid&&_WA94.wimApi.hideActiveDialog({email:a,lastMsgId:d[d.length-1].mid}),this.data.dialogs.splice(c,1),this.data.dialogsModifDate=+new Date,b=!0}b&&this.commit()}},{key:"subscribeToGroup",value:function(a){var b=this,c=_WA94.chatController.getChatSnByStamp(a);c&&this.data.focused===c&&(this._groupSubscribed&&this._groupSubscribed.stamp===a||(this._groupSubscribed&&this._groupSubscribed.timeout&&clearTimeout(this._groupSubscribed.timeout),_WA94.rapi.groupSubscribe(a,function(c,d,e,f){f&&f.resubscribeIn&&(b._groupSubscribed&&clearTimeout(b._groupSubscribed.timeout),b._groupSubscribed={stamp:a},b._groupSubscribed.timeout=_WA94.setTimeout(function(){delete b._groupSubscribed,b.subscribeToGroup(a)},1e3*f.resubscribeIn))})))}},{key:"_destroyDialog",value:function(a){a.destroy(),delete this._instances[a.data.mail]}},{key:"destroy",value:function(){this.data.focused&&this.focusEvent.fire(this.data.focused,!1),_U80.Object.each(this._instances,this._destroyDialog,this)}},{key:"clearHistory",value:function(){+new Date;this.data.dialogs&&this.data.dialogs.length&&(_U80.Array.each(this.data.dialogs,function(a){this._instances[a.mail]&&this._destroyDialog(this._instances[a.mail]),delete a.typing,delete a.historyLoaded,delete a.history},this),this.commit())}},{key:"activate",value:function(a,b){_WA94.boardMode||_WA94.chatLooking.activate(),_WA94.SessionStorage.load("dialogs_data",{success:function(c){this._onSyncRead(c),a&&a.call(b||window)},scope:this})}},{key:"deactivate",value:function(){this.clearHistory(),this.destroy(),_WA94.chatLooking.deactivate(),this.data={dialogs:[]}}},{key:"_onSyncRead",value:function(a){try{a=_JSON.parse(a||"null")}catch(b){a=null}a&&(this.destroy(),this.data=a),_firstLoad&&(_firstLoad=!1,RELOAD_HISTORY_ON_REFRESH&&this.clearHistory(),this.data.focused&&this.focusEvent.fire(this.data.focused,!0)),this._fetchDialogs(),a&&this.updateEvent.fire(this.data,1)}},{key:"_onBeforeConnectionResponse",value:function(){this._preventCommit=1}},{key:"_onAfterConnectionResponse",value:function(){this._newIncomingMessage&&(_WA94.ring("incoming"),delete this._newIncomingMessage),delete this._preventCommit,this._uncommitted&&this.commit(this.__fromHistory&&this.__fromHistory.value)}},{key:"preventCommit",value:function(){this._preventCommit=!0}},{key:"permitCommit",value:function(){this._preventCommit=!1,this._uncommitted&&this.commit(this.__fromHistory&&this.__fromHistory.value)}},{key:"commit",value:function(a,b){if(this._commitPatches=this._commitPatches||[],b&&b.sn===this.data.focused&&b.patch&&(this._commitPatches=this._commitPatches.concat(b.patch)),this._preventCommit)this._uncommitted=1,this.__fromHistory&&a||(this.__fromHistory={value:a});else{this.__fromHistory&&delete this.__fromHistory,delete this._uncommitted,this._preventCommit=1;var c=this._commitPatches;delete this._commitPatches,this.updateEvent.fire(this.data,a,c),this._uncommitted&&(c=this._commitPatches,delete this._commitPatches,this.updateEvent.fire(this.data,a,c)),delete this._preventCommit,_WA94.SessionStorage.save({dialogs_data:_JSON.stringify(this.data)})}}}]),b}(ES6ConnectionRoster),DialogsAbstraction=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a._cache=new DialogsCache,a._temporaryDlgData={},a._needCloseAfterAddMessage={},a.updateEvent=(new _U80.Event).relay(a._cache.updateEvent),a.updateSelfNickEvent=new _U80.Event,a.updateSettings=new _U80.Event,a.clearHistoryEvent=new _U80.Event,a._cache.focusEvent.on(function(a,b){_WA94.chatLooking.focus(a,b)},_assertThisInitialized2(_assertThisInitialized2(a))),a.clearHistoryEvent.relay(a._cache.clearHistoryEvent),_WA94.contactAbstraction.muteEvent.on(a.updateMuteState,_assertThisInitialized2(_assertThisInitialized2(a))),_WA94.fileTools.startUploadEvent.on(function(a,b){var c=_WA94.now()+10,d=b.attachedInfo||{},e=d.caption,f=d.quotes,g=d.mentions;this.addDynamicMessage(a,b.id,c,{text:e,quotes:f,mentions:g})},_assertThisInitialized2(_assertThisInitialized2(a))),_WA94.fileTools.endUploadEvent.on(function(a,b,c){if(this.removeDynamicMessage(a,b.id),c){var d=b.attachedInfo||{},e=d.caption,f=d.quotes,g=d.mentions;this.postMessage(a,f||g?{text:c.static_url,quotes:f,mentions:g}:c.static_url,{caption:e})}},_assertThisInitialized2(_assertThisInitialized2(a))),_S4.load(["selfnick","self_unick","server_time_diff","status.official"],{success:function(a){a.server_time_diff&&(_WA94.serverTimeDiff=a.server_time_diff),(a.selfnick||a.self_unick)&&(_WA94.DialogsAbstraction.uNick=a.self_unick||"",_WA94.DialogsAbstraction.nick=a.selfnick||"",this.updateSelfNickEvent.fire(a.selfnick,a.self_unick)),"1"===a["status.official"]&&(_WA94.DialogsAbstraction.official=!0)},scope:_assertThisInitialized2(_assertThisInitialized2(a))}),a}return _inherits2(b,a),_createClass2(b,[{key:"activate",value:function(a,b){this._cache.activate(a,b)}},{key:"deactivate",value:function(){this._cache.deactivate()}},{key:"moveNewestDialogToEnd",value:function(a){this.moveDialogInPlace(a)}},{key:"moveDialogInPlace",value:function(a){this._cache.moveDialogInPlace(a)}},{key:"updateMuteState",value:function(a,b){this._cache.setMute(a,b)}},{key:"updateSetting",value:function(a,b,c){this._cache.getIfExist(a)}},{key:"onUpdateClistData",value:function(){this._cache.onUpdateClistData()}},{key:"_onConnectionContactStatus",value:function(a){var b=this._cache.getIfExist(a.email);if(b){var c=b.data.cast[a.email],d=a.nickname||c&&c.nick||_WA94.CLD.getFriendlyName(a.email);this._cache.setMute(a.email,a.mute),b.data.modifDataFactor++;var e={nick:d,needAuth:c&&c.needAuth,status:"",statusTitle:"",onlineTime:a.onlineTime,mute:a.mute,official:a.official,uNick:a.uNick||c&&c.uNick};"userState"in a&&(e.userState=a.userState),"lastseen"in a&&(e.lastseen=a.lastseen),(a.bot||c&&c.bot)&&(e.bot=!0),b.setCast(e)}}},{key:"_onConnectionWp",value:function(a){var b=this;if(a&&a.result){var c=!1;a.result.forEach(function(a){var d=b._cache.getIfExist(a.email);if(d){var e=d.data.cast[a.email],f=!1;"lastseen"in a&&e.lastseen!==a.lastseen&&(e.lastseen=a.lastseen,f=!0),"userState"in a&&e.userState!==a.userState&&(e.userState=a.userState,f=!0),a.bot&&!e.bot&&(e.bot=!0,f=!0),f&&(d.data.modifDataFactor++,c=!0)}}),c&&this._cache.commit(!0)}}},{key:"_onConnectionTypingNotify",value:function(a){var b=this._cache.getIfExist(a.from);b&&b.setTyping(a.sender)}},{key:"updateSelfNick",value:function(a,b){_WA94.DialogsAbstraction.nick=a,_WA94.DialogsAbstraction.uNick=b,_S4.save({selfnick:a||"",self_unick:b||""}),this._cache.updateSelfNick(a,b),this.updateSelfNickEvent.fire(a,b)}},{key:"_onConnectionMyInfo",value:function(a){(a.friendly!==_WA94.DialogsAbstraction.nick||a.uNick!==_WA94.DialogsAbstraction.uNick)&&this.updateSelfNick(a.friendly,a.uNick),a.largeIconId&&a.largeIconId!==_WA94.DialogsAbstraction.iconId&&(_WA94.DialogsAbstraction.iconId=a.largeIconId,this._updateSelfAvatarDelay&&clearTimeout(this._updateSelfAvatarDelay),this._updateSelfAvatarDelay=_WA94.setTimeout(function(){_WA94.Ava.updateLastModified(_WA94.ACTIVE_MAIL,a.largeIconId)},200))}},{key:"_onConnectionArchSync",value:function(a){if("number"==typeof a.count){var b=a["with"],c=this._cache.updateUnreadCounter(b,a.count,!a.starting),d=this._cache.getIfExist(b);d?(this._cache.getFocusedId()!==b&&(0!==a.count||a.mentionCount||(a.mentionCount=0),void 0!==a.mentionCount&&d.syncMentionMe(a.mentionCount),a.lastReadMention&&d.syncLastReadMention(a.lastReadMention)),d.syncLastRead(a.lastRead),a.count?d.updateCounter(a.count):(this._cache.updateMarkCounter(b,a.attention),d.markDialogAsRead(a))):c&&this._cache.commit()}}},{key:"_onConnectionMentionMeMessage",value:function(a){this._cache.updateMentionMeData(a.sn,a.message.msgId);var b=this._cache.getIfExist(a.sn);b&&b.addMentionMe(a.message.msgId)}},{key:"getUnreadCounter",value:function(){return this._cache.getUnreadCounter()}},{key:"getUnreadDialogsCounter",value:function(){return this._cache.getUnreadDialogsCounter()}},{key:"getLastUnread",value:function(){var a={data:this._cache.getLastUnread()};return a.data&&this.extractDataFromDialog(a)}},{key:"_onConnectionHiddenChat",value:function(a){var b=this.getLastMessage(a.aimId),c=b?b.mid:"0";c&&c<=a.lastMsgId&&!_WA94.boardMode&&(this.close(a.aimId),delete this._temporaryDlgData[a.aimId])}},{key:"_onConnectionChatHeadsUpdate",value:function(a){this._cache.preventCommit();var b=this._cache.getIfExist(a.sn);b&&b.updateChatHeads(a)}},{key:"_onConnectionHistoryState",value:function(a){var b=a.sn;this._showNotification(a),this._cache.preventCommit();var c=this._cache.getIfExist(b);if(c)c.updateHistoryState(a,this._cache.data.focused),c.data.isRecent&&this.moveNewestDialogToEnd(c.data.mail),a.historyPart&&a.historyPart.history&&a.historyPart.history.length&&this._tryCloseDialogAfterAddMessage(b,a.historyPart.history);else{if(a.noRecentsUpdate)return;var d=this._temporaryDlgData[b];if(!d&&(!a.messages||!a.messages.length)&&(a.delUpto||!a.unreadCnt))return;if(this._temporaryDlgData[b]=a.messages?a:d||a,!d){var e=function(c){if(this._temporaryDlgData[b]){this._cache.preventCommit();var d=this._cache.get(c.email,!0);d.setCast(_U80.Object.extend({},c,!0)),this._cache.setMute(c.email,d.data.cast[c.email].mute),d.updateHistoryState(this._temporaryDlgData[b],this._cache.data.focused),d.data.isRecent&&this.moveNewestDialogToEnd(d.data.mail),delete this._temporaryDlgData[b],a.historyPart&&a.historyPart.history&&a.historyPart.history.length&&this._tryCloseDialogAfterAddMessage(b,a.historyPart.history)}}.bind(this);_WA94.ma.contactList.getContactsInfo([a.sn],function(a){var c=a&&a[0];c?e(_WA94.contactToHash(c)):(c={email:b,nick:_WA94.CLD.getFriendlyName(b),mute:_WA94.CLD.getMute(b),status:"",needAuth:1},e(c))})}}}},{key:"_onConnectionStoreCommand",value:function(a){_WA94.showcasePage.resetData(),_WA94.Sticker.resetContentData()}},{key:"_onConnectionAsyncResponse",value:function(a){a.payload&&_WA94.bots.executeAction(a.payload,a.reqId)}},{key:"_onAfterConnectionResponse",value:function(){delete this._offlineMessageArrived,this._cache.permitCommit()}},{key:"_showNotification",value:function(a){if(!a.noRecentsUpdate){var b=a.historyPart&&a.historyPart.history&&a.historyPart.history[0]&&a.historyPart.history[0][1],c=_WA94.Feature.getModeParameter("forceSoundInFocusedDialog");if(!a.starting&&b&&b.from!==_WA94.ACTIVE_MAIL&&(c||!_WA94.CLD.getMute(b.from))){var d,e=b.text,f=a.persons&&a.persons[0].friendly||a.sn,g=b.sticker,h=!1;if(b.parts&&b.parts.length){var i=b.parts[b.parts.length-1];g=i.stickerId,e=i.text}if(g?e=_WA94.tr("sticker.sticker"):(d=_WA94.fileTools.resolveLinkAsFileText(e,{asPlainText:!0})||_WA94.snippet.resolveLinkAsContactText(e),d&&(e=d)),b.mentions&&_U80.Array.each(b.mentions,function(b){b===_WA94.ACTIVE_MAIL&&(h=!0);var c=_WA94.CLD.getFriendlyName(b);c||_U80.Array.each(a.persons,function(a){return a.sn===b?(c=a.friendly,!1):void 0},this),e=e.replace(new RegExp("\\@\\["+b.replace(/\./g,"\\.")+"\\]","g"),"@"+(c||b))}),e){var j=b.event&&b.info&&"channel"===b.info.type,k=b.sender?_WA94.CLD.getFriendlyName(b.sender)||b.senderFriendly||b.sender:b.senderFriendly||f;j&&(k=f,e=_prepareEventMessageSafe(b,!0,!0)),h&&(k=_WA94.tr("notify.leadEmoji")+_WA94.tr("notify.mentionedYou"));var l=_WA94.Ava.make(b.from,f,80),m=a.unreadCnt;b.hidden||_WA94.Api.postEventToParent("newMessage",{from:b.from,title:k,text:e}),_WA94.MessageNotifier.show(b.from,{ts:+new Date,state:b.state,icon:l.url,title:k,date:b.timestamp,text:e,textPrefix:!j&&_WA94.MainAgent.isChat(b.from)&&b.sender!==b.from&&_WA94.tr("to")+" "+f+":\n",newCounter:m,offline:b.offline},b.mid||b.arch_id)}}}}},{key:"postMessage",value:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},d=this._cache.get(a),e=new OutgoingMessage({text:b,mail:a,resend:c.resend,caption:c.caption},c);e.editing||(d.getHistory().append(e),this.moveDialogInPlace(a)),e.send()}},{key:"addDynamicMessage",value:function(a,b,c,d){var e=this._cache.getIfExist(a);e&&e.getHistory().append(new DynamicMessage({from:_WA94.ACTIVE_MAIL,id:b,date:c||_WA94.now(),text:d}))}},{key:"removeDynamicMessage",value:function(a,b){var c=this._cache.getIfExist(a);c&&c.getHistory().removeMessage(b,"message_id")}},{key:"markAsRead",value:function(a,b,c){var d=a?this._cache.getIfExist(a):this._cache.getFocused();if(d&&d.isUnread()&&_WA94.inFocus())if(b){var e=d.markMessageAsRead(b,c);this._cache.updateUnreadCounter(d.data.mail,d.data.unreadCount),e&&(d.data.modifDataFactor++,this._cache.data.dialogsModifDate=+new Date,this._cache.commit(!1))}else this._cache.updateUnreadCounter(d.data.mail,0),d.markDialogAsRead()}},{key:"markAsUnread",value:function(a){var b=a?this._cache.getIfExist(a):this._cache.getFocused();b&&!b.isUnread()&&(this._cache.updateMarkCounter(a,!0),b.markAsUnread())}},{key:"markAllAsRead",value:function(){this._cache.preventCommit(),this._cache.eachDialog(function(a,b){var c=this._cache.getIfExist(b);c&&c.isUnread()&&(this._cache.updateUnreadCounter(b,0),c.markDialogAsRead())},this),this._cache.permitCommit()}},{key:"makeAuthorized",value:function(){var a=this._cache.getFocused();a&&a.makeAuthorized()}},{key:"loadSideHistory",value:function(a){var b=this._cache.getFocused();b&&b.data.history&&b.history.loadPack(a)}},{key:"loadHistoryPack",value:function(a,b){var c=this._cache.getFocused();!b||c&&c.data.mail===b.email?c&&c.data.history&&c.history.getHistoryPack(a):this.open(b,a)}},{key:"focus",value:function(a){this.open({email:a})}},{key:"blur",value:function(){this._cache.blur()}},{key:"isNotRecent",value:function(a){var b=a?this._cache.get(a):this._cache.getFocused();return b&&!b.data.isRecent&&b.data.mail}},{key:"_tryCloseDialogAfterAddMessage",value:function(a,b){this._needCloseAfterAddMessage[a]&&(delete this._needCloseAfterAddMessage[a],b&&1===b.length&&b[0]&&b[0][1]&&"addedToBuddyList"===b[0][1].event&&b[0][1].from===_WA94.ACTIVE_MAIL&&this.close(a))}},{key:"closeDialogAfterAddMessage",value:function(a){this._needCloseAfterAddMessage[a]=!0}},{key:"closeAll",value:function(){var a=this._cache;a.closeAll()}},{key:"close",value:function(a){var b=this._cache.updateUnreadCounter(a,0);this._cache.close(a,b)}},{key:"reopen",value:function(){this._cache.reopenFocused()}},{key:"open",value:function(a,b,c){this._cache.preventCommit();var d,e,f=c?this._cache.getIfExist(a.email):this._cache.get(a.email);return console.log("IM:DAbs:open: contact:",a," dialog?",!!f),f?(_WA94.CLD.inList(a.email)?d=_WA94.CLD.getInfo(a.email):(d={needAuth:1},_WA94.CLD.getMute(a.email)&&(d.mute=1),_U80.Array.each(_WA94.contactMap,function(b){a.hasOwnProperty(b)&&(d[b]=a[b])}),d.nick=_WA94.CLD.getFriendlyName(a.email)||d.nick,e=_WA94.chatController.getChatStampBySn(a.email),e&&(f.data.stamp=e)),f.setCast(d),f.focus(b),this._cache.permitCommit(),!0):!1}},{key:"extractDataFromDialog",value:function(a){var b=a.data.mail,c=a.data.cast[b]||{};return{mail:b,nick:c.nick,status:c.status||"",statusTitle:c.statusTitle||"",lastseen:c.lastseen,userState:c.userState,onlineTime:c.onlineTime,mute:c.mute||0,official:c.official||0,unread:a.data.unread,isRecent:a.data.isRecent,stranger:a.data.stranger,suspicious:a.data.suspicious,uNick:c.uNick}}},{key:"saveDataFromLastMessages",value:function(a){var b=this;if(-1!==_WA94.ACTIVE_MAIL.indexOf("@corp.mail.ru")){var c;this._cache.data.dialogs.forEach(function(a){var b=a.history,d=a.mail;c=c||{},c[d]=c[d]||{data:[],willBeRequested:{}};var e=b||[];e=e[e.length-1]||[],c[d].data=e.slice(-20).map(function(a){var b=a.arch_id;return b})}),a&&a.forEach(function(a){var d=_slicedToArray(a,2),e=d[0],f=d[1];if("historyState"===e&&!f.delUpto){var g=f.historyPart&&f.historyPart.history||[],h=g[0][1],i=g[0][1];g.forEach(function(a){var b=_slicedToArray(a,2),c=b[0],d=b[1];"message"===c&&(d.arch_id>h.arch_id&&(h=d),d.arch_id<i.arch_id&&(i=d))});var j=b._cache.getDataFromDialog(f.sn);c=c||{},c[f.sn]=c[f.sn]||{data:[],willBeRequested:{}},c[f.sn].data=c[f.sn].data.concat(g.map(function(a){var b=a.arch_id;return b})),j&&f.olderMsgId&&j.lastMessageId&&j.lastMessageId<f.olderMsgId&&(c[f.sn].willBeRequested.middle={from:j.lastMessageId,to:i.arch_id});var k=h&&h.arch_id;f.lastMsgId&&k&&f.lastMsgId>k&&(c[f.sn].willBeRequested.end=1)}}),c&&_S4.save({__dataForLog:_JSON.stringify(c)})}}},{key:"checkDataForLog",value:function(){-1!==_WA94.ACTIVE_MAIL.indexOf("@corp.mail.ru")&&_S4.load(["__dataForLog"],{success:function(a){if(a.__dataForLog){_S4.remove("__dataForLog");var b={reason:"lostMessagesData",sn:_WA94.ACTIVE_MAIL,lostMiddle:[],lostMiddleCount:0,lostEnding:[],lostEndingCount:0,newDlg:[],newDlgCount:0},c=_JSON.parse(a.__dataForLog);this._cache.data.dialogs.forEach(function(a){var d=a.history,e=a.mail,f=a.lastMessageId;if(c[e]){var g=c[e],h=g.data,i=g.willBeRequested,j=d&&d[d.length-1],k=0,l=0;if(j&&h.length){var m=1,n=h[h.length-1];j.slice(0).reverse().some(function(a,b,c){var d=a.arch_id;return n&&d!==n?void(1===m&&k++):h[h.length-m]?void(h[h.length-m]!==d?l++:(m++,i.middle&&i.middle.to===d&&i.middle.from===h[h.length-m]&&(n=i.middle.from))):!0}),l&&(b.lostMiddle.push(l+"|"+e),b.lostMiddleCount++)}f&&(!h.length||h[h.length-1]<f)&&!i.end&&(b.lostEnding.push(k+"|"+e),b.lostEndingCount++)}else b.newDlg.push(e),b.newDlgCount++}),(b.lostMiddleCount||b.lostEndingCount||b.newDlgCount)&&_U80.Mnt.log(b)}},scope:this})}},{key:"getFocused",value:function(){var a=this._cache.getFocused();return a?this.extractDataFromDialog(a):!1}},{key:"getOpenDialogs",value:function(){return this._cache.getOpenDialogs()}},{key:"getRecentData",value:function(a){var b=[],c={};return this._cache.eachDialog(function(d){var e=this.extractDataFromDialog({data:d});!d.isRecent||d.suspicious||a&&!_WA94.CLD.inList(e.mail)||(e.email=e.mail,c[e.email]=e,b.unshift(_WA94.CLD.inList(e.mail)?_WA94.CLD.getInfoArray(e.mail):_WA94.contactToArray(e)))},this),{recent:b,recentKeys:c}}},{key:"getLastMessage",value:function(a){var b=this._cache.getIfExist(a);return b&&b.history&&b.history.getLastMessage()}},{key:"renameContact",value:function(a,b){var c=this._cache.getIfExist(a);if(c){var d=c.data.cast[a];c.data.modifDataFactor++,d.nick=b,c.setCast(d)}}},{key:"clearHistory",value:function(a,b){var c=this._cache.getIfExist(a);c&&(b||(b=c.getHistory().getSideArchId(!0)),b&&_WA94.rapi.delHistory({email:a,msgId:b}))}},{key:"deleteMessage",value:function(a,b,c){this._cache.editHiddenMarkOnMessage(a,b,!0),_WA94.rapi.delMessage({email:a,msgId:b,shared:c},function(c){200!==c&&(this._cache.editHiddenMarkOnMessage(a,b,!1),_WA94.showPopup(_WA94.tr("auth.msgNetworkError"),5e3))},this)}},{key:"togglePin",value:function(a,b){var c=a?this._cache.getIfExist(a):this._cache.getFocused();c&&c.togglePin(b)}},{key:"pinMessage",value:function(a,b,c){var d=this._cache.getIfExist(a);d&&d.resetPin(),_WA94.rapi.pinMessage({sn:a,msgId:b,unpin:!!c})}},{key:"getDialogCount",value:function(){return this._cache.count()}}]),b}(ES6ConnectionRoster);_WA94.DialogsAbstraction=DialogsAbstraction,_WA94.DialogsAbstraction.repackHistoryItem=_repackHistoryItem;var _WA95=WebIM,_TD29=_WA95.TemplateDriver,_U81=_WA95.util,QUOTE_TMPL=_WA95.TD.getTMPL("dialogQuoteMessage"),QUOTE_REPLY_TMPL=_WA95.TD.getTMPL("dialogQuoteReply"),DEBUG_MSG=!1,parseLinks=function(a){return a.replace(_WA95.urlBuilder.REG_REPLACE_URL,function(a,b,c,d,e){return b+'<a href="'+c+'" target="_blank" rel="nofollow noopener noreferrer">'+c+"</a>"+a.substr(b.length+c.length)})},isText=function(a){return a.length>0&&" "!==a},MF={buildSafeTextMessage:function(a){var b,c=a||"",d=_WA95.fileTools.resolveLinkAsFileText(c,{withIcon:!1,forceRequest:!0,allowLeadingText:!0})||_WA95.snippet.resolveLinkAsContactText(c,!0);if(d)b=d;else{c=_U81.String.trim(c.replace(/\s+/g," "));var e=this.extractUrlFromText(c);_WA95.snippet.resolveLinkAsContact(e)&&!_WA95.snippet.resolveLinkAsContact(c)&&(e=!1);var f=e&&_U81.String.htmlEntity(_WA95.snippet.getTitle(e));b=f||MF.buildPlainHtmlMessage(c)}return b},buildPlainHtmlMessage:function(a,b,c){var d=c?a:_U81.String.htmlEntity(a);d=_WA95.Emoji.parse(d);var e=b?" ":"<br />";return d=d.replace(/(\n|\r\n)/g,e).replace(/(\t)/g,"    "),d=d.replace(/ (\s+)/g,function(a,b){return new Array(b.length+1).join("&nbsp;")})},replaceUrlsInText:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(a){return a},c=[],d=0,e=!1,f="";return a=a.replace(_WA95.urlBuilder.REG_REPLACE_URL,function(a,g,h,i,j){var k=!1;i>0&&isText(j.substring(d,i))&&(k=e=!0,c.length>0&&(c[c.length-1].textAfter=!0)),f=j.substr(i+a.length),c.push({href:h,textBefore:k});var l=g+b(h,k,c.length-1)+a.substr(g.length+h.length);return d=i+a.length,l}),f&&isText(f)&&(e=!0,c[c.length-1].textAfter=!0),{text:a,links:c,mixedContent:e}},extractUrlFromText:function(a){var b="",c=_WA95.urlBuilder.linksFromText(a)||[];return _U81.Array.each(c,function(a,d){return a=a.replace(/^(\s|>)/,""),c[d]=a,_WA95.fileTools.resolveLinkAsFile(a)?(b=a,!1):void 0}),b||(1===c.length&&0===c[0].indexOf("http")?c[0]:"")},_buildRichMessage:function(a,b){var c=this,d=a.orig,e=(new Date).getTime(),f="{0}"+e+"_{1}_",g=!1,h=0,i="",j="",k=[];a.mentions&&_U81.Array.each(a.mentions,function(b){var c=a.cast[b]&&a.cast[b].nick||_WA95.CLD.getFriendlyName(b)||b,e="imMention im-message__mention"+(b===_WA95.ACTIVE_MAIL?" im-message__mention_me":""),g='<span class="'+e+'" data-user="'+_U81.String.htmlEntity(b)+'">'+_WA95.Emoji.parse(_U81.String.htmlEntity(c))+"</span>",h=new RegExp("\\@\\["+b.replace(/\./g,"\\.")+"\\]","g");d=d.replace(h,function(a,b){return k.push({source:a,tag:g}),_TD29.parseString(f,["M",k.length-1])})});var l=!1,m=[],n=d.replace(_WA95.urlBuilder.REG_REPLACE_URL,function(a,b,c,d,e){var g=!1;d>0&&isText(e.substring(h,d))&&(g=l=!0,m.length>0&&(m[m.length-1].textAfter=!0)),
i=e.substr(d+a.length),m.push({href:c,textBefore:g});var j=b+_TD29.parseString(f,["L",m.length-1])+a.substr(b.length+c.length);return h=d+a.length,j});i&&isText(i)&&(l=!0,m[m.length-1].textAfter=!0),n=_U81.String.htmlEntity(n),b.showCommands&&(n=n.replace(/(^|\b|[\s\t\n]|<br\s*\/>|&nbsp;)(\/[a-zA-Z]\w{0,31})(?=[\s\t\n]|\b|<br\s*\/>|$)/g,function(a,b,c){return b+_TD29.parseSafe("botCommand",[c])})),n=_WA95.Emoji.parse(n),n=n.replace(/(\n|\r\n)/g,"<br />").replace(/(\t)/g,"    "),n=n.replace(/(\s\s+)/g,function(a,b){return new Array(b.length+1).join("&nbsp;")}),n=n.replace(/(^|[\s\t\n]|<br\s*\/>|&nbsp;)@([a-zA-Z0-9._]+)(?=[\s\t\n]|<br\s*\/>|$)/g,function(a,b,c){var d=c.match(new RegExp("([a-zA-Z0-9\\._]+)?(M"+e+"_\\d+_(?:[a-zA-Z0-9\\._]+)?)")),f="";return d&&(c=_U81.String.htmlEntity(d[1]||""),f=d[2]+f),c?b+'<span class="imMention im-message__mention" data-id="'+c+'">@'+c+"</span>"+f:a});var o=1===m.length&&!m[0].textBefore&&!m[0].textAfter,p=b.date?'<span class="im-message__dummy-date">'+b.date+"</span>":"";if(m.length){i="",h=0;var q="",r="",s=!1;if(n=n.replace(new RegExp("(L)"+e+"_(\\d+)_","g"),function(d,e,f,k,n){if(f=parseInt(f),_WA95.isNumber(f)&&f>=0&&"L"===e&&f<m.length){k>0&&(q+=n.substring(h,k)),h=k+d.length;var t,u,v=m[f],w=v.href,x=!1,y=0!==w.indexOf("http"),z=y&&w.match(_WA95.urlBuilder.REG_EMAIL),A=v.notImage?'notimage="true"':"",B="",C="",D=""===j?" im-message_first":"",E="im-message-link "+(b.showSnippet?"imRawLink":"imKeepLink"),F="",G=0;if(l&&(G+=_WA95.snippet.FLAG_TEXT_MIX),v.textBefore&&(G+=_WA95.snippet.FLAG_TEXT_BEFORE),y&&(z||(w="http://"+w),_WA95.snippet.resolveLinkAsContact(w)&&(y=!1)),b.showPreview&&!z&&(u=_WA95.fileTools.resolveLinkAsFile(w,!0),y||u||!b.showSnippet||(l&&_WA95.snippet.resolveLinkAsContact(w)||(t=_WA95.snippet.getPreviewCode(w,null,G,p)),0===f&&_WA95.DialogsAgent.bindUrlToMessage(a.archId,w),t?(-1===t.indexOf("im-snippet_image")||t.indexOf("im-snippet_title")>-1?o=!1:x=l,x?(0===f&&""===j&&""===q&&(F="im-message_first"),v.textAfter||(F+=" im-message_last"),q&&(j+=c.wrapTextBlock(q,{cls:D,highlight:a.highlight}),q=""),j+=c.wrapSnippetBlock(t,{cls:F})):1===m.length&&(F=(l?"":"im-message_first ")+"im-message_last",r=c.wrapSnippetBlock(t,{cls:F})),s=!0):1===m.length&&(r=c.wrapSnippetBlock(p,{cls:"im-message_snippet-place imMessageSnippetPlace","data-class":"im-message_last"})),r&&v.textAfter&&!x&&(G+=_WA95.snippet.FLAG_DONT_REPLACE_LINK))),u){q&&(j+=c.wrapTextBlock(q,{cls:D,highlight:a.highlight}),q=""),0===f&&_WA95.DialogsAgent.bindUrlToMessage(a.archId,w),g=!0,u.text&&(o=!1);var H=a.archId+"_"+u.id;j+=_WA95.fileTools.getPreviewCode(u.id,u.url||w,"",a.archId,!1,v.textAfter?"":p,_WA95.DialogPage.getSpeechVisibility(H))}else(!t||!x&&(v.textAfter||m.length>1))&&(q+=_TD29.parseString('<a class="{5}" data-orig="{6}" data-flags="{7}" href="{0}" rel="nofollow noopener noreferrer" target="_blank" {2}>{1}{3}{4}</a>',[(z?"mailto:":"")+_U81.String.encodeHref(w),_U81.String.encodeHref(v.href),A,B,C,E,encodeURIComponent(w),G],{safeKeys:["0","1","2","6"]}));return i=n.substr(k+d.length),""}return d}),i=q+i,i&&isText(i)){var t=(j?"":"im-message_first ")+(s&&r?"":"im-message_last");j+=this.wrapTextBlock(i,{cls:t,"data-class":t,dummyDate:s&&r?null:p,highlight:a.highlight})}j+=r,g=g||s}else j=this.wrapTextBlock(n,{cls:"im-message_first im-message_last",dummyDate:p,highlight:a.highlight});return k.length&&(j=j.replace(new RegExp("(M)"+e+"_(\\d+)_","g"),function(a,b,c){return c=parseInt(c),_WA95.isNumber(c)&&c>=0&&"M"===b&&c<k.length?k[c].tag:a})),{html:j,media:g,singleImage:g&&o}},_formatMessageHtml:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=b.index||"",d=b.addDateToEnd||!1,e=b.template||null,f=b.parentArchId,g=b.showCommands||!1,h=b.isGroup||!1,i=[],j="",k=!1,l=a.isIncoming,m="",n=a.parse&&a.parse.indexOf("url")>-1||!a.parse;DEBUG_MSG&&(m='<div style="white-space: normal;">ARCHID='+a.archId+" DATE="+a.date+"</div>");var o,p=_U81.Date.formatPlainTime(new Date(1e3*a.date));if(a.updated&&!a.hideEdit&&(p=_WA95.tr("dialog.edited")+" "+p),a.sticker)i.push("im-message_sticker"),j=_WA95.Sticker.getStickerHTML(a.sticker);else if(a.dynamic){if(i.push("im-message_dynamic"),j=_WA95.fileTools.generateUploaderHTML(a.message_id),!j)return"";a.orig&&(o=this._buildRichMessage(a,{showPreview:!1,showSnippet:!1,showCommands:g,date:d&&p}),j+='<span class="im-message__textblock im-message__caption">'+o.html+"</span>"),j="<div>"+j+"</div>"}else if(a.file){_WA95.fileTools.isStickerFile(a.file)?i.push("im-message_sticker"):i.push("im-message_file"),!a.fileText&&_WA95.fileTools.getPreviewUrl(a.file,!0)&&i.push("im-message-single_image");var q=(f||a.archId)+"_"+a.file;j=_WA95.fileTools.getPreviewCode(a.file,a.fileUrl||a.orig,a.fileText,f||a.archId,!0,!1,_WA95.DialogPage.getSpeechVisibility(q));var r=_WA95.fileTools.getUploadedFileInfo(a.file);r&&r.attachedInfo&&r.attachedInfo.caption&&(o=this._buildRichMessage({orig:r.attachedInfo.caption,mentions:a.mentions,cast:a.cast},{showPreview:!1,showSnippet:!1,showCommands:g,date:d&&p}),j+='<span class="im-message__textblock im-message__caption">'+o.html+"</span>")}else if("voip"===a.event&&a.info&&_WA95.RTCTools.isEnabled())l=!!a.info.voip.inCall,j=this.renderVoipEvent(a.info.sender,a.info.voip);else if(a.event)i.push("im-message_event"),j='<span class="im-message__textblock">'+(a.eventContent||parseLinks(a.orig))+"</span>";else if(a.poll)if("quote"===a.partType){var s=this.buildSafeTextMessage(a.orig);j=_WA95.Polls.generateShortSnippet(s)}else o=this._buildRichMessage({orig:a.orig,mentions:a.mentions,cast:a.cast},{showPreview:!0,showSnippet:!1,showCommands:g}),j=_WA95.Polls.generateSnippet(a.poll.id,o.html);else if(a.quotes)j=a.quotes;else if(a.contact)j=_WA95.snippet.generateContactCardHTMLFromPart(a.contact);else{var t=this._buildRichMessage(a,{showPreview:!0,showSnippet:n,showCommands:g,date:d&&p});j=t.html,k=t.media,t.singleImage&&i.push("im-message-single_image")}a.groupKey&&i.push("im-message-"+a.groupKey),a.partType&&i.push("forward"===a.partType?"im-message-forward":"im-message-quote"),a.isLastPart&&i.push("im-message-last__part"),a.hasQuote&&i.push("im-message-has__quote"),a.hasResponse&&i.push("im-message-has__response"),a.latest&&i.push("im-message_latest");var u=a.avatarHtml,v=a.nickColor,w=4,x="",y=[],z=a.heads&&a.heads.length;if(z){i.push("im-message_has-seens");var A=1;a.heads.forEach(function(b){var c=a.cast[b]&&a.cast[b].nick||_WA95.CLD.getFriendlyName(b);w>A||z===w?x+=_WA95.Ava.make(b,c,16):y.push(_U81.String.htmlEntity(c||b)),A++}),z>w&&(x+='<div class="im-message__seens-more" title="'+y.join("\n")+'"><div></div><div></div><div></div></div>')}l||(i.push("im-message_self"),5===a.state?i.push("im-message_state-read"):4===a.state||h&&3===a.state?i.push("im-message_state-delivered"):3===a.state?i.push("im-message_state-sent"):-1===a.state?i.push("im-message_state-error"):2===a.state?i.push("im-message_state-sending"):i.push("im-message_state-delay"));var B=null;k&&(B=_WA95.DialogsAgent.getMediaBlockMaxSize());var C="",D=a.inlineKeyboardMarkup;return D&&D.length&&(_WA95.bots.saveMarkup(a.archId,D),C=this.renderBotButtons(D,_WA95.bots.getState(a.archId)||[],{wrapSection:!0,maxBlockWidth:B})),_TD29.parseString(e||_WA95.TD.getTMPL("dialogMessage"),[p,a.parsedFromName,j,k?"im-message__text-media":"",i.join(" "),a.fromPersonId,B?"max-width:"+B+"px":"",u,c,a.archId,a.date,a.fromName,"",a.fromForwardId||"",x,v?"color:"+v:"",a.message_id||"",C,m],{safeKeys:["1","2","7","11","14","17","18"]})},renderBotButtons:function(a,b){var c=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},d=8,e=14,f=[],g=0;a.forEach(function(a,c){if(!(c>=e)&&a&&a.length){var h=[],i=!1;a.forEach(function(a,c){if(!(c>=d)){var e=[],f=_WA95.Emoji.parse(_U81.String.htmlEntity(a.text||a.url||"")),j=a.url||"",k=j&&_WA95.snippet.resolveLinkAsContact(j),l=b.indexOf(g)>-1;"primary"===a.style&&e.push("im-message__bot-button_primary"),"attention"===a.style&&e.push("im-message__bot-button_attention"),l&&e.push("im-message__bot-button_loading"),j&&!k&&e.push("im-message__bot-button_url"),f.indexOf("\n")>-1&&(i=!0),f=f.replace(/\n/,"<br/>"),h.push(_TD29.parseSafe("botButton",{title:f,cls:e.join(" "),url:encodeURIComponent(j),data:a.callbackData||"",attributes:l?'disabled="disabled"':"",spinner:l?_WA95.TD.getTMPL("CircleSpinner"):"",index:g},{safeKeys:["title","url","attributes","spinner"]})),g++}}),f.push(_TD29.parseSafe("botButtonRow",{buttons:h.join(""),cls:i?"im-message__bot-row_double":""},{safeKeys:["buttons"]}))}});var h=f.join("");return c.wrapSection&&(h=_TD29.parseSafe("botButtonSection",{rows:h,style:c.maxBlockWidth?"max-width:"+c.maxBlockWidth+"px":""},{safeKeys:["rows"]})),h},renderVoipEvent:function(a,b){var c,d,e=a.aimId,f=a.friendly,g=!!b.conference,h=!!b.inCall,i="missed"===b.subtype||"busy"===b.subtype||"error"===b.subtype,j=!!b.video,k="decline"===b.subtype,l="",m=[],n=[];if(b.duration&&(l=_WA95.tr("calls.duration")+" "+_U81.Date.formatDurationTime(b.duration),k=!1),j&&n.push("im-voip-callcard_video"),h&&n.push("im-voip-callcard_incoming"),h&&i&&n.push("im-voip-callcard_missed"),g){n.push("im-voip-callcard_group");var o=b.conference.partyList||[];o.slice(0,5).forEach(function(a){a.sn!==_WA95.ACTIVE_MAIL&&m.push(_WA95.Ava.make(a.sn,a.friendly,14))}),m=m.slice(0,4),m.reverse()}return!g||i||k?h?(d="callFromUser",i&&(d=g?"groupCallMissed":"callFromUserMissed"),k&&(d="callFromUserDeclined")):(d="youCalledUser",i&&(d="youCalledUserMissed"),k&&(d="youCalledUserDeclined")):(d="groupCallFromYou",h&&(d="groupCall")),c=_WA95.tr(d,{scope:"calls.event",name:_WA95.Emoji.parse(_U81.String.htmlEntity(f||e))}),_TD29.parseSafe("voipCallCard",{sn:e,video:+j,group:+g,cls:n.join(" "),title:c,subtitle:l,coins:m.join("")},{safeKeys:["title","coins"]})},renderPromoMessage:function(a){var b=_U81.String.htmlEntity(a.sender.name),c=a.sender.avatar?_WA95.Ava.buildAvatarHtml("background-image:url("+_U81.String.encodeHref(a.sender.avatar)+")"):"",d={message_id:"100",archId:"101",orig:_U81.String.trim(a.text),sticker:!1,fromPersonId:"102",isIncoming:!0,fromName:b,parsedFromName:_WA95.Emoji.parse(b),avatarHtml:c,nickColor:"#111111",date:a.time,cast:null};return this._formatMessageHtml(d,{index:0,addDateToEnd:!0,isGroup:!0})},renderDate:function(a,b){return b||(b=_U81.Date.formatMessageDate(a.date===_WA95.TIME_INFINITY?a.localDate:a.date)),_TD29.parseSafe("dialogMessageDate",{mid:a.mid||a.message_id,date:b})},renderMessage:function(a,b,c,d,e,f,g,h,i){var j=c.sender||c.from,k=d[j]&&d[j].nick||_WA95.uinAsName(j);c.text=c.text||"";var l,m=d[a]||{},n=c.date===_WA95.TIME_INFINITY?c.localDate:c.date,o=c.contact,p=!1,q={},r=!!c.tel,s=c.from!==_WA95.ACTIVE_MAIL,t=c.sender||c.from,u=c.event?"":b,v="",w=c.text,x=c.sticker,y=c.dynamic,z=_WA95.MainAgent.isChat(a),A=_WA95.MainAgent.isChat(a)&&i.botAvailable||m.bot;if(s&&z&&c.sender){k=d[c.sender]&&d[c.sender].nick||_WA95.uinAsName(c.sender),t=c.sender;var B=d[t]&&d[t].official||_WA95.CLD.isOfficial(t);u=_WA95.Ava.make(t,k,32,null,{official:B}),v=_WA95.Ava.getColor(t)}(c.dynamic||c.event)&&(c.unread=!1);var C=_U81.String.htmlEntity(k);r&&(C=_WA95.tr(s?"dialog.smsFrom":"dialog.smsTo",{tel:c.tel}));var D,E=[],F=[],G=!1;if(c.parts){var H=c.parts.length-1;_U81.Array.each(c.parts,function(b,e){var f,g,h,i,j,k=_WA95.fileTools.resolveLinkAsFile(b.text||"",!0),l=_WA95.CLD.getFriendlyName(b.sn)||b.friendly||"",m="forward"===b.mediaType||b.chat&&b.chat.sn!==a;m?(i=b.chat&&_WA95.MainAgent.isChat(b.chat.sn)&&b.chat.sn,g=b.chat&&_WA95.MainAgent.isChat(b.chat.sn)&&(b.chat.name||_WA95.CLD.getFriendlyName(b.chat.sn)),l&&l!==g&&(f=g,g=l,j=i,i=b.sn),g=g||b.sn&&_WA95.uinAsName(b.sn),h=_TD29.parseSafe("imForwardFrom",{sn:i,name:g}),h=f?_WA95.tr("dialog.forwardedFromFrom",[h,_TD29.parseSafe("imForwardFrom",{sn:j,name:f})]):_WA95.tr("dialog.forwardedFrom")+" "+h,h="<span>"+h+"</span>"):!l&&b.sn&&(l=_WA95.uinAsName(b.sn));var o=_U81.String.htmlEntity(l),p=m&&(f?b.chat&&b.chat.sn||b.sn:b.sn||b.chat&&b.chat.sn),q={message_id:b.msgId,archId:b.msgId,parse:b.parse||c.parse||null,mentions:b.mentions||c.mentions,orig:_U81.String.trim(b.text||""),sticker:b.stickerId,contact:b.contact,file:k.id,fileUrl:k.url,fileText:_U81.String.trim(k.text||""),fromPersonId:p,isIncoming:!0,fromName:o,isLastPart:e===H,parsedFromName:_WA95.Emoji.parse(h||"<span>"+o+"</span>"),nickColor:m?"":p&&_WA95.Ava.getColor(p),fromForwardId:m&&b.chat&&b.chat.sn,avatarHtml:"",date:b.time||n,cast:d};b.poll&&"text"===b.mediaType?(q.poll=b.poll,F.push(this._formatMessageHtml(q,{parentArchId:c.arch_id,showCommands:A,isGroup:z}))):"text"===b.mediaType&&(b.text||b.contact)||"sticker"===b.mediaType&&b.stickerId?(q.updated=c.updated,D=q,y&&(q.message_id=c.message_id,q.dynamic=y,y=!1),E.push(this._formatMessageHtml(q,{index:b.chat&&b.chat.stamp||"",addDateToEnd:!0,template:QUOTE_REPLY_TMPL,parentArchId:c.arch_id,showCommands:A,isGroup:z}))):("quote"===b.mediaType||"forward"===b.mediaType)&&(q.partType=b.mediaType,b.poll&&(q.poll=b.poll),G="quote"===b.mediaType,F.push(this._formatMessageHtml(q,{index:b.chat&&b.chat.stamp||"",template:QUOTE_TMPL,parentArchId:c.arch_id,showCommands:A,isGroup:z})))},this),F.length||!D||w||x||o?p=F.concat(E).join(""):(w=D.orig,x=D.sticker,o=D.contact,q={id:D.file,url:D.fileUrl,text:D.fileText},E=[])}else c.buttonsState?l=this._makeEventContent(c.event,_U81.String.trim(c.eventText||_U81.String.htmlEntity(w)),c.buttonsState):q=_WA95.fileTools.resolveLinkAsFile(c.text,!0);var I={message_id:c.message_id,archId:c.arch_id,state:c.state,orig:_U81.String.trim(w),sticker:x||!1,dynamic:y||!1,event:c.event||!1,info:c.info,eventContent:l||!1,parse:c.parse,mentions:c.mentions,updated:c.updated,hideEdit:c.hideEdit,quotes:p,hasQuote:G,hasResponse:E&&E.length,contact:o,poll:c.poll,inlineKeyboardMarkup:c.inlineKeyboardMarkup,file:q.id,fileUrl:q.url,fileText:_U81.String.trim(q.text||""),fromPersonId:t,isIncoming:t!==_WA95.ACTIVE_MAIL||c.event||!1,fromName:C,parsedFromName:_WA95.Emoji.parse(C),avatarHtml:u,nickColor:v,groupKey:f,date:n,latest:g,highlight:c.highlight,heads:a!==_WA95.ACTIVE_MAIL&&h,cast:d};return this._formatMessageHtml(I,{index:e,addDateToEnd:!0,showCommands:A,isGroup:z})},_makeEventContent:function(a,b,c){if("invite"===a){var d=["im-message__buttons_show-avatar-btn","im-message__buttons_show-about-btn"],e=c.split("").map(function(a,b){return"1"===a?d[b]:""}).join(" ");return _TD29.parseSafe(a+"EventButtons",{text:b,classes:e},{safeKeys:["text"]})}},wrapSnippetBlock:function(a,b){var c=b.cls||"im-message_middle",d=b["data-class"]?' data-class="'+b["data-class"]+'"':"";return'<span class="'+c+'"'+d+">"+a+"</span>"},wrapTextBlock:function(a,b){var c,d,e=a,f=b.cls||"",g=-1;-1===f.indexOf("im-message_first")&&(e=e.replace(/^<br\s*\/?>/,""));var h=b["data-class"]?' data-class="'+b["data-class"]+'"':"";if(b.highlight&&b.highlight.length){d=e,e="";for(var i=0;i<b.highlight.length;i++)c=b.highlight[i],g=d.toLowerCase().indexOf(c.toLowerCase()),g>-1&&(e=e+d.substr(0,g)+"<mark>"+d.substr(g,c.length)+"</mark>",d=d.substr(g+c.length));e+=d}return b.dummyDate&&(e+=b.dummyDate),'<span class="im-message__textblock '+f+'"'+h+">"+e+"</span>"}};_WA95.MessageFormatter=MF;var _WA96=WebIM,_U82=_WA96.util,_UI50=_WA96.ui,_TD30=_WA96.TemplateDriver,DOM_ID_RECENT_PREFIX="imDialogTab_recent",DOM_ID_UNKNOWN_PREFIX="imDialogTab_unknown",MAX_RENDERED_SYMBOLS_IN_SUBTITLE=100,_DomUtil47=_WA96.DomUtil,_dialogsList=[],_unknownDialogsList=[],_templateRenderer,_dialogStateHash={},_getTemplateRenderer=function(a){return _templateRenderer||(_templateRenderer={recent:new _UI50.TemplateRenderer(_WA96.TD.getTMPL("RecentItem")),unknown:new _UI50.TemplateRenderer(_WA96.TD.getTMPL("UnknownItem"))}),_templateRenderer[a?"unknown":"recent"]},_getStartEl=function(a){for(var b=a.first(),c=b.next();c&&!c.hasClass("im-recent-item");)b=c,c=b.next();return b&&(b=b.next()),b},_grabTrash=function(a){for(var b,c,d=a.dialogsList,e=d.length,f=a.unknown?DOM_ID_UNKNOWN_PREFIX:DOM_ID_RECENT_PREFIX,g=a.active,h=a.ind;++h<e;)b=d[h],!g[b]&&_dialogStateHash[b]&&(c=_DomUtil47.get(f+b),c&&c.remove(),delete _dialogStateHash[b]);d.length=a.ind+1},_getViewStateKey=function(a){return[a.modifDataFactor,a.modifDate].join("_")},_fetchMessageDate=function(a){var b=a.date===_WA96.TIME_INFINITY?a.localDate:a.date;return b&&(b=_U82.Date.formatTime(1e3*b),b=b.yesterday?b.value:b.now||b.minutes||b.hours?b.time:b.date.replace(/^(\d)\./,"0$1.")),b},_fetchLastMessage=function(a){var b;if(a){var c=a[0]instanceof Array?a[a.length-1]:a,d=c.length;for(b=c[d-1];b&&(b.hidden||!b.text&&!b.sticker&&(!b.parts||!b.parts.length)&&!_WA96.fileTools.getUploadedFileInfo(b.message_id));)b=c[--d]}return b},_buildSubMessage=function(a,b,c){var d=a.mail,e="",f="";if(a.typing&&(e=(a.typing[1]?_WA96.Emoji.parse(_U82.String.htmlEntity(a.typing[1].replace(/\s+.*/,"")))+" ":"")+_WA96.tr("dialog.typing")+"..."),b&&!e){var g,h,i=a.cast,j=_WA96.MainAgent.isChat(d),k=a.theirsLastRead;if(!a.unread&&b.from===_WA96.ACTIVE_MAIL&&!b.event)if(!j&&k&&b.mid<=k)f=_WA96.Ava.make(d,i[d]&&i[d].nick,14);else if(a.lastMessageHeads&&a.lastMessageHeads.length)for(var l=2;l>=0;l--)a.lastMessageHeads[l]&&(g=a.lastMessageHeads[l].sn,f+=_WA96.Ava.make(g,i[g]&&i[g].nick,14));else h=5===b.state?"":4===b.state||j&&3===b.state?"delivered":3===b.state?"sent":-1===b.state?"error":"sending",f=h&&'<div class="im-recent_message__state im-message_state-'+h+'"></div>';var m=b.sticker,n=b.contact;if(e=b.eventText||b.text||"",b.parts&&b.parts.length){var o;for(h=b.parts.length;h--;)if(o=b.parts[h],o.text||o.stickerId||o.contact){e=o.text||"",m=o.stickerId,n=o.contact;break}}var p=_WA96.fileTools.resolveLinkAsFileText(e,{withIcon:!0,forceRequest:!0})||_WA96.snippet.resolveLinkAsContactText(e,!0);if(e=_U82.String.trim(e.replace(/\s+/g," ")),n)e=_WA96.snippet.getContactTextSafeHtml(!0);else if(p)e=p;else if(b.dynamic){var q=_WA96.fileTools.getUploadedFileInfo(b.message_id);q&&(e=_U82.String.htmlEntity(q.name))}else if(m)e=_WA96.tr("sticker.sticker");else if(!b.event){var r=_WA96.MessageFormatter.replaceUrlsInText(e,function(a,b,d){if(_WA96.snippet.resolveLinkAsContact(a))return _WA96.snippet.getContactTextSafeHtml();var e=_WA96.fileTools.resolveLinkAsFileText(a);if(e)return e;var f=_WA96.snippet.getContentType(a);return f.match(/image|gif/)?_WA96.tr("cl.photo"):(c[a]=1,a)});if(e=r.text,1!==r.links.length||r.mixedContent)e=_WA96.MessageFormatter.buildPlainHtmlMessage(e.substring(0,MAX_RENDERED_SYMBOLS_IN_SUBTITLE));else{var s=_WA96.DialogsAgent.extractUrlFromMessage(b.mid||b.arch_id,_U82.String.htmlEntity(e));(_WA96.fileTools.resolveLinkAsFile(s)||_WA96.snippet.resolveLinkAsContact(s)&&!_WA96.snippet.resolveLinkAsContact(e))&&(s=!1);var t=s&&_U82.String.htmlEntity(_WA96.snippet.getTitle(s));e=t||_WA96.MessageFormatter.buildPlainHtmlMessage(e.substring(0,MAX_RENDERED_SYMBOLS_IN_SUBTITLE))}b.poll&&(e=_TD30.parseSafe("mediaAsText",{type:"poll",text:_WA96.tr("polls.poll")+": "+e},{safeKeys:["text"]}))}"voip"===b.event&&(e=_TD30.parseSafe("mediaAsText",{type:"call",text:e},{safeKeys:["text"]})),b.mentions&&_U82.Array.each(b.mentions,function(a){var b=i[a]&&i[a].nick||a;e=e.replace(new RegExp("\\@\\["+a.replace(/\./g,"\\.")+"\\]","g"),_WA96.Emoji.parse(_U82.String.htmlEntity(b)))}),j&&e&&!b.event&&(h=e.match(/([^@\r\n]+@[^@\r\n]+):\r?\n([\s\S]*)/),h?(e=h[2],h=h[1]):b.sender&&(h=b.sender),h&&h!==d&&(h=i[h]&&i[h].nick||h,e='<span class="im-recent-item__subtitle__from">'+_WA96.Emoji.parse(_U82.String.htmlEntity(h.replace(/\s+.*/,"")))+"</span>: "+e))}return{seenBy:f,submessage:e}},_fetchRecentTemplateData=function(a,b,c,d){var e=a.mail,f=a.cast[e]||{},g=e===_WA96.ACTIVE_MAIL,h=g?_WA96.tr("dialog.favorite"):f.nick,i=!(_WA96.MainAgent.isChat(e)||f.lastseen>0||f.userState||f.bot),j=_WA96.Ava.make(e,h,52,null,{isFavorite:g,official:f.official,mute:f.mute,online:i}),k="",l="",m="";if(!c){var n=_fetchLastMessage(a.history);if(n){k=_fetchMessageDate(n)||"";var o=_buildSubMessage(a,n,d);l=o.seenBy,m=o.submessage}}return h||(h=e),{sn:_U82.String.htmlEntity(e),nickView:_WA96.Emoji.parse(_U82.String.htmlEntity(h)),nick:_U82.String.htmlEntity(f.nick),count:a.unreadCount>999?"1k":a.unreadCount||(a.unread?'<div class="im-msg-counter__unread-symbol"></div>':""),avatarHtml:j,classes:[i?"im-recent-item_online":"",a.history&&a.history.length||a.unreadCount>0?"im-recent-item_message":"",a.unread?"im-recent-item_unread":a.typing?"im-recent-item_typing":"",a.unread&&!a.unreadCount?"im-recent-item_unread__mark":"",a.mentionSyncCount>0?"im-recent-item_mentioned":"",f.mute?"im-recent-item_mute":"",b&&_WA96.splitView?"im-recent-item_focused":"",f.official?"im-recent-item_official":"",g?"im-cl-contact_self":""].join(" "),date:k,seenBy:g?"":l,submessage:m}},_updateRecentTab=function(a,b,c,d){var e=a.mail,f=b.unknown?DOM_ID_UNKNOWN_PREFIX:DOM_ID_RECENT_PREFIX,g=_DomUtil47.get(f+e),h=!b.dialogsList[b.ind]||b.dialogsList[b.ind]!==e||!g,i=_getViewStateKey(a);if(b.forceRedrawTab||!g||i!==_dialogStateHash[e]){if(b.dialogsEl){var j=_fetchRecentTemplateData(a,c,b.unknown,d);g=_getTemplateRenderer(b.unknown).renderElement(g,j)}_dialogStateHash[e]=i}if(h){b.dialogsEl&&(b.beforeEl?b.dialogsEl.dom.insertBefore(g.dom,b.beforeEl.dom):b.dialogsEl.appendChild(g));var k=_U82.Array.indexOf(b.dialogsList,e),l=-1===k?e:b.dialogsList.splice(k,1)[0];b.dialogsList.splice(b.ind,0,l)}return g&&(b.beforeEl=g.next()),!!g};_WA96.RecentViewRenderHelper={proceed:function(a,b){var c=0,d=0,e=0,f={},g={ind:-1,beforeEl:_getStartEl(b.container),dialogsList:_dialogsList,dialogsEl:b.container,forceRedrawTab:b.forceRedrawTabs,active:{}},h={unknown:!0,ind:-1,beforeEl:!1,dialogsList:_unknownDialogsList,dialogsEl:b.unknownContainer,forceRedrawTab:!1,active:{}};return _U82.Array.each(a,function(a){var i=a.mail;if(a.cast[i]&&a.isRecent){var j=!_WA96.CLD.inList(i)&&a.suspicious&&!_WA96.MainAgent.isChat(i);j&&(d++,c+=a.unreadCount);var k=j?h:g;k.ind++;var l=_updateRecentTab(a,k,i===b.focused,f);k.active[i]=!0,!j&&l&&e++}}),_grabTrash(g),_grabTrash(h),{pendingUrls:f,recentCount:e,unknownCount:d,unknownUnreadCount:c}},getUnknownSnArray:function(){return _unknownDialogsList},reset:function(){_dialogStateHash={},_dialogsList=[],_unknownDialogsList=[]}};var _WA97=WebIM,_U83=_WA97.util,_UI51=_WA97.ui,PRERENDER_MINIMUM_RECENTS_COUNT=10,_DomUtil48=_WA97.DomUtil,_cachedRecentDialogs=[],_focusedSn,UnknownsPage=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.appPageName="unknowns",a.tabClickEvent=new _U83.Event,a.closeTabEvent=new _U83.Event,a.loadPageEvent=new _U83.Event,a.unloadPageEvent=new _U83.Event,a}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a){this.page=a,this.contentEl=_DomUtil48.get(a).getSelector(".app-content"),this.contentEl.on("click",this._onClick,this),this.scrollBar=new _UI51.ScrollBar({source:this.contentEl}),this.loadPageEvent.fire(this.contentEl,this.scrollBar)}},{key:"onPageUnload",value:function(a){this.page=null,this.contentEl.un("click",this._onClick,this),this.contentEl=null,this.scrollBar.destroy(),this.scrollBar=null,this.unloadPageEvent.fire()}},{key:"_onClick",value:function(a){var b=a.getTarget(!0),c=b.up("im-recent-item");if(c){var d=c.getAttribute("data-mail"),e=c.getAttribute("data-nick"),f=b.getAttribute("data-action");if(f)switch(f){case"add":_UI51.showConfirmBox(_WA97.tr("dialog.addContact",[_WA97.Emoji.parse(_U83.String.htmlEntity(e))]),function(){_WA97.rapi.approveDialog(d)});break;case"remove":this.closeTabEvent.fire(d)}else this.tabClickEvent.fire(d)}}}]),b}(_WA97.Page),RecentView=function(){function a(){_classCallCheck2(this,a),this.tabClickEvent=new _U83.Event,this.closeTabEvent=new _U83.Event,this.markAsReadedEvent=new _U83.Event,this.markAsUnreadEvent=new _U83.Event,this.updateUnknownsEvent=new _U83.Event,this._unknownCont=null,this.unknownsPage=new UnknownsPage,this.unknownsPage.loadPageEvent.on(this._onUnknownLoad,this),this.unknownsPage.unloadPageEvent.on(this._onUnknownUnload,this),this.tabClickEvent.relay(this.unknownsPage.tabClickEvent),this.closeTabEvent.relay(this.unknownsPage.closeTabEvent),_WA97.snippet.loadEvent.on(this._updateSnippetTitle.bind(this)),this.swappedTab=!1,this._doNotRedrawFlag=!1,_WA97.isDesktop&&(this.dragDropArea=new _UI51.DragDropArea,this.dragDropArea.dragEvent.on(this._onDragDropAreaMove,this),this.dragDropArea.dropEvent.on(this._onDragDropAreaDrop,this))}return _createClass2(a,[{key:"updateView",value:function(a,b){_focusedSn=a.focused,this._modifDate!=a.dialogsModifDate&&(this._modifDate=a.dialogsModifDate,a.dialogs&&(_cachedRecentDialogs=a.dialogs),this.renderTabs(),b&&this.finishPreloading(),this.scrollBar.sync(),this._unknownScrollBar&&this._unknownScrollBar.sync())}},{key:"scrollToFirstUnreadDialog",value:function(){var a=this.block.getSelector(".im-recent-item_unread:not(.im-recent-item_mute), .im-recent-item_unread__mark");a=a&&a.up("im-recent-item"),a&&(this.block.dom.scrollTop=a.dom.offsetTop,this.scrollBar.sync())}},{key:"_onDragDropAreaMove",value:function(a){var b=a.up("im-recent-item"),c=b&&b.getAttribute("data-mail"),d=_WA97.chatController.getCachedChatInfo(c);return!c||d&&d.you&&"readonly"===d.you.role?(this.dragDropArea.disableDragDropMode(),!1):void(c!==this.dragDropArea.itemAimId&&(this.dragDropArea.itemAimId=b.getAttribute("data-mail"),this.dragDropArea.el.setStyle({top:b.dom.offsetTop-this.block.dom.scrollTop+"px"})))}},{key:"_onDragDropAreaDrop",value:function(a){this.dragDropArea.itemAimId&&(this.tabClickEvent.fire(this.dragDropArea.itemAimId),_U83.Mnt.countRB(33783515),_WA97.fileTools.sendFiles(this.dragDropArea.itemAimId,a))}},{key:"render",value:function(a){var b=this;this.page=a,this.el=_DomUtil48.get("imRecent"),this.block=this.el.first(),this.el.on("click",this._onClick,this).on("contextmenu",this._onContextmenu,this).on("mouseover",function(){var a=b.el.getSelector(".im-recent-item_active");a&&a.removeClass("im-recent-item_active")}),this.dragDropArea&&this.dragDropArea.activate(this.el),this.scrollBar=new _UI51.ScrollBar({source:this.block}),_WA97.hotKeyManager.activationLayerEvent.on(function(a){"recentArrows"===a&&b._onArrowDown()}),_WA97.hotKeyManager.deactivationLayerEvent.on(function(a){if("recentArrows"===a){var c=b.el.getSelector(".im-recent-item_active");c&&c.removeClass("im-recent-item_active")}}),_WA97.hotKeyManager.addLayer({name:"recentArrows",overlayOnHandle:!0,handlers:{enter:function(a){var c=b.el.getSelector(".im-recent-item_active");c&&b.tabClickEvent.fire(c.getAttribute("data-mail")),_WA97.hotKeyManager.deactivateLayer("recentArrows"),a.stopEvent()},arrowDown:this._onArrowDown.bind(this),arrowUp:this._onArrowUp.bind(this)}})}},{key:"_onArrowDown",value:function(){this.moveCursor(!0)}},{key:"_onArrowUp",value:function(){var a=this.moveCursor();a||_WA97.hotKeyManager.deactivateLayer("recentArrows")}},{key:"moveCursor",value:function(a){var b,c=this.el.getSelector(".im-recent-item_active");if(c?(b=a?c.next():c.prev(),c.removeClass("im-recent-item_active"),b&&!b.hasClass("im-recent-item")&&(b=null)):b=this.el.getSelector(".im-recent-item"),b){b.addClass("im-recent-item_active");var d=b.dom.offsetTop-b.parent().dom.scrollTop,e=b.dom.offsetHeight;e>d?this.block.dom.scrollTop=Math.max(0,b.dom.offsetTop-e):d>this.block.dom.offsetHeight-2*e&&(this.block.dom.scrollTop=b.dom.offsetTop-this.block.dom.offsetHeight+2*e),this.scrollBar.sync()}return b}},{key:"_findDialogRootNode",value:function(a){return a.up("im-recent-item")}},{key:"_closeDialogConfirm",value:function(a,b,c,d){var e,f=this,g={content:_WA97.tr("dialog.closeChat"),buttons:[{action:"cancel",text:_WA97.tr("box.cancel")},{action:"ok",text:_WA97.tr("contextmenu.hideChat"),cls:"im-button_highlight"}]},h=new _UI51.ConfirmModalBox(g);h.actionEvent.on(function(a){e=a}),h.hideEvent.on(function(){c.call(d||f,a,b,e)}),h.show()}},{key:"_onClick",value:function(a){if(_WA97.contextMenu.isVisible())return!!a.stopEvent();var b=a.getTarget(!0),c=b&&b.getAttribute("data-action"),d=this._findDialogRootNode(b);d?this.tabClickEvent.fire(d.getAttribute("data-mail")):c&&"searchContact"===c&&App.load("multiSearch",{mode:"message",keyword:""})}},{key:"_handleCloseAction",value:function(a,b,c){"ok"===c&&this.closeTabEvent.fire(a)}},{key:"_onContextmenu",value:function(a){var b,c,d=a.getTarget(!0),e=this._findDialogRootNode(d);if(e){var f=e.first(),g=f.hasClass("im-recent-item_mute"),h=f.hasClass("im-recent-item_unread");b=e.getAttribute("data-mail"),c=_WA97.MainAgent.isChat(b)?["hideChat"]:["profile","ignore","hideChat"],c.unshift(g?"unmute":"mute"),b===_WA97.ACTIVE_MAIL&&(c=["hideChat"]),c.unshift("readAll"),c.unshift(h?"markAsReaded":"markAsUnread"),_WA97.contextMenu.show(a,c,{mail:b,nick:e.getAttribute("data-nick")},{mute:function(a){_WA97.contactAbstraction.mute(a.mail,!0)}.bind(this),unmute:function(a){_WA97.contactAbstraction.mute(a.mail,!1)}.bind(this),hideChat:function(a){var b=this;_WA97.CLD.inList(a.mail)?this.closeTabEvent.fire(a.mail):this._closeDialogConfirm(a.mail,a.nick,function(a,c,d){b._handleCloseAction(a,c,d)})}.bind(this),readAll:function(a){this.markAsReadedEvent.fire()}.bind(this),markAsReaded:function(a){this.markAsReadedEvent.fire(a.mail)}.bind(this),markAsUnread:function(a){this.markAsUnreadEvent.fire(a.mail)}.bind(this)}),a.stopEvent()}}},{key:"_onSwapStart",value:function(a){var b=a.getTarget(!0);a=a.browserEvent,b.dom.__alreadySwappedFlag||a.deltaX<=0||(this.swappedTarget=b.dom,this.swappedTarget.__alreadySwappedFlag=!0,this.swappedTab=this._findDialogRootNode(b),this.swappedTab&&this.swappedTab.removeClass("im-recent__slide-item").addClass("im-recent__swapped-item"))}},{key:"_onSwapMove",value:function(a){a=a.browserEvent,a.deltaX>0&&this.swappedTab&&this.swappedTab.setStyle({transform:"translateX("+a.deltaX+"px)","-webkit-transform":"translateX("+a.deltaX+"px)"})}},{key:"_onSwapEnd",value:function(a){var b=this;if(a=a.browserEvent,this.swappedTab){if(this.swappedTarget&&(delete this.swappedTarget.__alreadySwappedFlag,delete this.swappedTarget),a.deltaX>this.block.dom.offsetWidth/3){var c=this.swappedTab;this._closeDialogConfirm(this.swappedTab.getAttribute("data-mail"),this.swappedTab.getAttribute("data-nick"),function(a,d,e){b._handleCloseAction(a,d,e),"ok"!==e&&c.removeClass("im-recent__swapped-item").addClass("im-recent__slide-item").setAttribute("style","")})}else this.swappedTab.removeClass("im-recent__swapped-item").addClass("im-recent__slide-item").setAttribute("style","");this.swappedTab=!1}}},{key:"_updateSnippetTitle",value:function(a,b){var c=this._pendingUrls||{};(b||c[a])&&(delete c[a],this.renderTabs(!0))}},{key:"updateTabs",value:function(){clearTimeout(this._updateTabsTimer),delete this._updateTabsTimer,this.renderTabs(!0),this.scrollBar.sync(),this._unknownScrollBar&&this._unknownScrollBar.sync()}},{key:"_onUnknownLoad",value:function(a,b){this._unknownCont=_DomUtil48.get(a),this._unknownScrollBar=b,this.renderTabs(),this._unknownScrollBar.sync()}},{key:"_onUnknownUnload",value:function(){var a=this;this._unknownCont=null,this._unknownScrollBar=null,this._doNotRedrawFlag=!0;var b=_WA97.RecentViewRenderHelper.getUnknownSnArray();_U83.Array.each(b,function(b){a.markAsReadedEvent.fire(b)}),this._doNotRedrawFlag=!1,this.renderTabs()}},{key:"renderTabs",value:function(a){if(!_WA97.boardMode&&this.block&&!this._doNotRedrawFlag){this._updateTabsTimer&&(clearTimeout(this._updateTabsTimer),delete this._updateTabsTimer);for(var b=_cachedRecentDialogs.length,c=[];b--;)_cachedRecentDialogs[b].mail===_WA97.ACTIVE_MAIL?c.unshift(_cachedRecentDialogs[b]):c.push(_cachedRecentDialogs[b]);var d={container:this.block,unknownContainer:this._unknownCont,focused:_focusedSn,forceRedrawTabs:a},e=_WA97.RecentViewRenderHelper.proceed(c,d),f=e.recentCount,g=e.unknownCount,h=e.unknownUnreadCount,i=e.pendingUrls;if(this._pendingUrls=i,this.updateUnknownsEvent.fire(g,h),!g)if("unknowns"===App.getPage().name)App.back();else{var j=App.indexOfPage("unknowns");j>-1&&App.spliceHistory(j,1)}this._updateTabsTimer||(this._updateTabsTimer=_WA97.setTimeout(this.updateTabs,6e4,this)),
f>=PRERENDER_MINIMUM_RECENTS_COUNT&&this.finishPreloading(),f||g?this.block.removeClass("im-recent-list_empty"):this.block.addClass("im-recent-list_empty")}}},{key:"finishPreloading",value:function(){if(!this.__preloadFinished){this.__preloadFinished=!0,this.block.removeClass("im-recent-list_loading");var a=_WA97.TD.getTMPL(_WA97.configurator.getOption("alt_recents_default_screen")?"recentListDefaultScreenAlternative":"recentListDefaultScreen");this.block.getSelector(".im-recent__default-screen").updateHTML(a)}}},{key:"activate",value:function(){this.block.addClass("im-recent-list_empty"),this.block.addClass("im-recent-list_loading")}},{key:"deactivate",value:function(){_WA97.RecentViewRenderHelper.reset(),this.__preloadFinished=!1,this._modifDate=!1,this.dragDropArea&&this.dragDropArea.deactivate(),_cachedRecentDialogs=[],this._updateTabsTimer&&(clearTimeout(this._updateTabsTimer),delete this._updateTabsTimer)}}]),a}();_WA97.RecentView=RecentView;var _WA98=WebIM,_U84=_WA98.util,REQUEST_PAGE_SIZE=50,REQUEST_CACHE_TIME=30,_filterCache={},getKeywordCache=function(a,b){var c=a+"_"+b,d=_filterCache[c];if(d){if(d.expired>=_WA98.now())return d.data;delete _filterCache[c]}},setKeywordCache=function(a,b,c){var d=a+"_"+b;_filterCache[d]={expired:_WA98.now()+REQUEST_CACHE_TIME,sn:a,data:c}},DialogSearchRemote=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.loadEvent=new _U84.Event,a}return _inherits2(b,a),_createClass2(b,[{key:"request",value:function(a){var b=this,c=a.sn,d={pagesize:REQUEST_PAGE_SIZE},e=(c||"all")+"_"+(a.keyword||a.cursorOne);if(this._reqId&&this._reqTag===e)return this._reqId;a.keyword?d.filter={keyword:a.keyword}:c?d.cursorOne=a.cursorOne:d.cursorAll=a.cursorOne,this._reqTag=e;var f=function(a){200!==a&&(delete b._reqId,delete b._reqTag)};return c?(d.sn=c,this._reqId=_WA98.rapi.searchDialog(d,f)):this._reqId=_WA98.rapi.searchAllDialogs(d,f),this._reqId}},{key:"_onConnectionSearchOneDialog",value:function(a){this._onConnectionSearchAllDialogs(a)}},{key:"_onConnectionSearchAllDialogs",value:function(a){if(this._reqId&&a.requestParams&&a.requestParams.reqId===this._reqId){delete this._reqId,delete this._reqTag;var b=a.exhausted?null:a.cursorOne;this.fireLoadEvent({sn:a.requestParams.sn,nextCursor:b,count:a.entryCount,messages:a.history||[],query:a.keyword,firstPage:!!a.keyword,requestCursor:a.requestParams.cursorOne||null})}}},{key:"fireLoadEvent",value:function(a){this.loadEvent.fire(a)}},{key:"destroy",value:function(){this.loadEvent.removeAll(),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_WA98.conn.ES6ConnectionRoster),DialogSearchCache=function(a){function b(){return _classCallCheck2(this,b),_possibleConstructorReturn2(this,_getPrototypeOf2(b).apply(this,arguments))}return _inherits2(b,a),_createClass2(b,[{key:"fireLoadEvent",value:function(a,c){!c&&a.query&&setKeywordCache(a.sn,a.query,a),_get2(_getPrototypeOf2(b.prototype),"fireLoadEvent",this).call(this,a)}},{key:"request",value:function(a){var c=a.sn;if(a.keyword){var d=getKeywordCache(c,a.keyword);if(!d&&_U84.String.isEmpty(a.keyword)&&(d={sn:c,nextCursor:null,count:0,messages:[],query:a.keyword,firstPage:!!a.keyword,requestCursor:null}),d)return void this.fireLoadEvent(d,!0)}return _get2(_getPrototypeOf2(b.prototype),"request",this).call(this,a)}}]),b}(DialogSearchRemote),DialogSearchAbstraction=function(){function a(){_classCallCheck2(this,a),this.remoteData=new DialogSearchCache,this.searchReadyEvent=new _U84.Event,this.cursorOne=null,this.cursorSn=null,this.remoteData.loadEvent.on(function(a){this.cursorOne=a.nextCursor,this.cursorSn=a.sn,this.searchReadyEvent.fire(a)},this)}return _createClass2(a,[{key:"search",value:function(a){a.keyword&&(delete this.cursorOne,this.remoteData.request({sn:a.sn,keyword:a.keyword}))}},{key:"getNextPage",value:function(){this.cursorOne&&this.remoteData.request({sn:this.cursorSn,cursorOne:this.cursorOne})}},{key:"reset",value:function(){this.cursorOne=null,this.cursorSn=null}},{key:"destroy",value:function(){this.searchReadyEvent.removeAll(),this.remoteData.destroy()}}]),a}(),dialogSearchAbstractionInstance;_WA98.DialogSearchAbstraction={getInstance:function(){return dialogSearchAbstractionInstance||(dialogSearchAbstractionInstance=new DialogSearchAbstraction),dialogSearchAbstractionInstance}};var _WA99=WebIM,_TD31=_WA99.TemplateDriver,_UI52=_WA99.ui,_U85=_WA99.util,TYPES_MAP={media:["video","image"],video:["video"],files:["file","audio"],links:["link"],ptt:["ptt"]},SCROLL_LIMIT=200,WAIT_FOR_RENDER_TIMEOUT=500,uniqCounter=0,uniqClassPrefix="imGalleryItemUniq_",fileUniqIdMap={},getIdClass=function(a,b){var c;return fileUniqIdMap[b]?c=fileUniqIdMap[b].idClass:(c=uniqClassPrefix+ ++uniqCounter,fileUniqIdMap[b]={idClass:c,items:{}}),fileUniqIdMap[b].items[a.id.mid]=a,c},requestItemData=function(a){var b=_WA99.fileTools.resolveLinkAsFile(a.url);b?_WA99.fileTools.requestFileInfo(b):_WA99.snippet.getContentType(a.url)},renderItem=function(a,b,c,d){var e,f="",g=_WA99.fileTools.resolveLinkAsFile(a.url);if("video"===b||"media"===b){var h,i;if(g){e=getIdClass(a,g);var j=_WA99.fileTools.requestFileInfo(g);j&&(h=_WA99.fileTools.getPreviewUrl(g,!0,a.url),"image/gif"===j.mime?i="GIF":j.duration&&(i=_U85.Date.formatDurationTime(j.duration)))}else e=getIdClass(a,a.url),h=_WA99.snippet.getPreviewUrl(a.url);f=_TD31.parseString(c,{url:_U85.String.encodeHref(_U85.String.ensureHttpsUrl(h||"")),orig_url:encodeURIComponent(a.url),mid:a.id.mid,info:i,idClass:e,type:TYPES_MAP[b].join(",")},{safeKeys:["url","orig_url"]})}else{var k=a.author&&a.author.friendly||"";!k&&a.author&&(k=a.author.firstName||a.author.lastName?"".concat(a.author.firstName||""," ").concat(a.author.lastName||""):a.author.sn);var l=a.time&&_U85.Date.formatTime(1e3*a.time),m=_TD31.parseSafe("galleryAdditionalInfo",{author:_WA99.Emoji.parse(_U85.String.htmlEntity(k)),dateString:l&&"".concat(l.dateShortString," ").concat(l.time)||""},{safeKeys:["author"]}),n=_TD31.parseSafe("galleryMenuButton",{url:encodeURIComponent(a.url),mid:a.id.mid},{safeKeys:["url"]});if("links"===b)e=getIdClass(a,a.url),f=_WA99.snippet.generateGalleryItemHTML(a.url,"im-gallery-item "+e,m,n);else if(g){e=getIdClass(a,g);var o=_WA99.fileTools.requestFileInfo(g)||g;f=_WA99.fileTools.generateHTML(o,{galleryType:b,additionalInfo:m,wrapClass:"im-gallery-item "+e,additionalHtml:n,speechVisible:d["".concat(a.id.mid,"_").concat(g)]},"",a.id.mid)}}return f},GalleryView=function(a){function b(){return _classCallCheck2(this,b),_possibleConstructorReturn2(this,_getPrototypeOf2(b).apply(this,arguments))}return _inherits2(b,a),_createClass2(b,[{key:"initComponent",value:function(){this.galleryData=null,this.previewTMPL=_WA99.TD.getTMPL("galleryPreviewItem"),this.spinnerTMPL=_WA99.TD.getTMPL("CircleSpinner"),this.currentType="",this.countersContent="",this._pttSpeechVisibility={},this.clickOnPttEvent=new _U85.Event,this.clickOnPreviewEvent=new _U85.Event,this.itemActionEvent=new _U85.Event}},{key:"show",value:function(a,c){this.contentEl&&this.contentEl.updateHTML(this.spinnerTMPL),this.topbarEl&&this.topbarEl.updateText(""),_get2(_getPrototypeOf2(b.prototype),"show",this).call(this),this.currentType=c,this.sn=a,this.galleryData=_WA99.gallery.getLastItems(a,100,TYPES_MAP[this.currentType]),this.galleryData&&this.updateContent()}},{key:"_onShow",value:function(){this.contentEl.on("scroll",this._onScroll,this),this.el.on("click",this._onClick,this),this.el.on("contextmenu",this._onContextmenu,this),this._pttSpeechVisibility={},_WA99.gallery.updateEvent.on(this._onGalleryUpdate,this),_WA99.snippet.loadEvent.on(this._updatePreviews,this),_WA99.fileTools.loadEvent.on(this._updatePreviews,this),_WA99.mediaPlayer.stateEvent.on(this._updateMediaFilesState,this),this.scrollBar.setSource(this.contentEl),_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this)}},{key:"_onHide",value:function(){this._waitForRenderTimeout&&(clearTimeout(this._waitForRenderTimeout),delete this._waitForRenderTimeout),this.contentEl.un("scroll",this._onScroll,this),this.el.un("click",this._onClick,this),this.el.un("contextmenu",this._onContextmenu,this),_WA99.gallery.updateEvent.un(this._onGalleryUpdate,this),_WA99.snippet.loadEvent.un(this._updatePreviews,this),_WA99.fileTools.loadEvent.un(this._updatePreviews,this),_WA99.mediaPlayer.stateEvent.un(this._updateMediaFilesState,this),this.scrollBar.setSource(null),_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this)}},{key:"updateTopbar",value:function(){if(this.el&&this.galleryData){var a=this.el.getSelector(".im-gallery-topbar"),b=this.galleryData;if(b&&a){var c=b&&b.counters||{},d=[];_U85.Array.each(_WA99.gallery.GALLERY_COUNTERS_SCHEMA,function(a){var b=0;_U85.Array.each(a.keys,function(a){c[a]&&(b+=c[a])}),b&&(a.counter=b,d.push(_TD31.parseSafe("galleryCounterItem",a)))},this),this.countersContent=d.join(""),a.updateHTML(_TD31.parseSafe("galleryTopbar",{counters:this.countersContent,title:_WA99.tr("gallery.".concat(this.currentType))},{safeKeys:["counters"]})),this.menu=a.last()}}}},{key:"updateContent",value:function(a){var b=this;if(this._waitForRenderTimeout&&(clearTimeout(this._waitForRenderTimeout),delete this._waitForRenderTimeout),this.el){var c=this.contentEl,d=this.galleryData;if(d&&c){var e={},f=(new Date).getFullYear(),g=[],h=c.dom,i=h.scrollTop;c.setStyle("overflow","hidden"),this.scrollBar.setSource(null),a||this.updateTopbar(),this._waitForRender&&!a?(this.galleryData.items.forEach(requestItemData),this._waitForRenderTimeout=_WA99.setTimeout(function(){delete b._waitForRenderTimeout,b.updateContent(!0)},WAIT_FOR_RENDER_TIMEOUT)):(this.galleryData.items.forEach(function(a){var c=new Date(1e3*a.time),d={month:c.getMonth(),year:c.getFullYear()};if(e.month!==d.month||e.year!==d.year){e=d;var h=_WA99.tr(d.month+1,{scope:"nom_month_gen"})+(f===d.year?"":" "+d.year);g.push('<div class="im-gallery-date">'.concat(h,"</div>"))}var i=renderItem(a,b.currentType,b.previewTMPL,b._pttSpeechVisibility);g.push(i)}),this.galleryData.startIsReached||g.push(this.spinnerTMPL),c.updateHTML(g.join("")),h.scrollTop=i,this._waitForRenderTimeout=_WA99.setTimeout(function(){delete b._waitForRenderTimeout,b._waitForRender=!1,c.setStyle("overflow","auto"),b.scrollBar.setSource(c),b.scrollBar.sync()},200))}else c&&c.setStyle("overflow","auto"),this.scrollBar&&(this.scrollBar.setSource(c),this.scrollBar.sync())}}},{key:"updateItemContent",value:function(a){var b=this;if(this.el&&this.galleryData){var c=this.el.getSelector(".im-gallery-content");if(c&&fileUniqIdMap[a]){var d=fileUniqIdMap[a],e=d.idClass,f=d.items,g=c.dom.getElementsByClassName(e);g&&g.length&&(_U85.Array.each(g,function(a){var c=a.getAttribute("data-mid");if(!c){var d=a.getElementsByClassName("im-gallery-menu__button")||[];c=d[0]&&d[0].getAttribute("data-mid")}if(c&&f[c]){var e=renderItem(f[c],b.currentType,b.previewTMPL,b._pttSpeechVisibility),g=_U85.DomHelper.elementFromHtml(e);a.parentNode.replaceChild(g,a)}}),this.scrollBar.sync())}}}},{key:"_updateMediaFilesState",value:function(a,b){_WA99.mediaFileStateManager.updateMediaFileState(a,b,this.el)}},{key:"_onGalleryUpdate",value:function(a){this.el&&this.sn===a&&(this.galleryData=_WA99.gallery.getLastItems(a,100,TYPES_MAP[this.currentType]),this.galleryData&&this.updateContent())}},{key:"_onScroll",value:function(){if(this.contentEl&&this.galleryData&&!this.galleryData.startIsReached&&!this._waitForRender){var a=this.contentEl.dom;if(a.offsetHeight&&a.scrollHeight-(a.scrollTop+a.offsetHeight)<SCROLL_LIMIT){var b=this.galleryData.items[this.galleryData.items.length-1];b?this.galleryData=_WA99.gallery.getFromItem(this.sn,b.id,100,0,TYPES_MAP[this.currentType]):this.galleryData=_WA99.gallery.getLastItems(this.sn,100,TYPES_MAP[this.currentType]),this._waitForRender=!0,this.galleryData&&this.updateContent()}}}},{key:"showItemMenu",value:function(a,c,d,e){var f=b.prepareItemMenu(a,c,d)||{},g=f.menuItems,h=f.options,i=f.msg;g&&_WA99.contextMenu.show(e,g,{mail:h.sn,chat_id:a,nick:h.nick,msgText:h.msgText,origUrl:h.origUrl,downloadUrl:h.downloadUrl,message:i,contact:_WA99.CLD.getInfoArray(h.sn)||_WA99.makeContactArray(h.sn,h.nick,1)},this._onContextMenuAction.bind(this))}},{key:"_onContextMenuAction",value:function(a,b){this.itemActionEvent.fire(a,b)}},{key:"_onContextmenu",value:function(a){var b,c=a.getTarget(!0),d=c.up("im-gallery-item");d&&(b=d.hasClass("im-gallery-preview")?d:d.getSelector(".im-gallery-menu__button"),b&&(this.showItemMenu(this.sn,decodeURIComponent(b.getAttribute("data-url")||""),b.getAttribute("data-mid"),a),a.stopEvent()))}},{key:"_onClick",value:function(a){var b=this,c=a.getTarget(!0);if(c.up("appBack"))this.hide();else if(this.menu&&(c.up("im-gallery-dropdown")||c.up("im-gallery-topbar__title")))this.menu.toggle();else{var d=c.up("imButton");if(d){var e=d.getAttribute("data-action");if(d.up("imPttPlay")||d.up("imPttTranslate"))this.clickOnPttEvent.fire(d,function(a,c){b._pttSpeechVisibility[a]=c});else if(e){if("goToMessage"===e){var f=d.up("im-gallery-item"),g=f&&f.getSelector(".im-gallery-menu__button"),h=g&&g.getAttribute("data-mid");h&&this.itemActionEvent.fire({message:{mid:h}},"goToMessage")}else if("preview"===e){var i=c.up("im-gallery-item");i&&this.clickOnPreviewEvent.fire(decodeURIComponent(i.getAttribute("data-url")||""),i.getAttribute("data-mid"),i.getAttribute("data-type"))}else"itemMenu"===e?this.showItemMenu(this.sn,decodeURIComponent(d.getAttribute("data-url")||""),d.getAttribute("data-mid"),a):c.up("im-gallery-counters__button")&&this.show(this.sn,e);a.stopEvent()}}}}},{key:"_updatePreviews",value:function(a){var b=this;this.el&&this.galleryData&&(this._needUpdatePreviews=this._needUpdatePreviews||[],a&&this._needUpdatePreviews.push(a),this._updatePreviewsTimer||(this._needUpdatePreviews.forEach(function(a){b.updateItemContent(a)}),this._needUpdatePreviews=!1,this._updatePreviewsTimer=_WA99.setTimeout(function(){delete b._updatePreviewsTimer,b._needUpdatePreviews&&b._updatePreviews()},300)))}},{key:"_onRender",value:function(a){this.el=a.createChild({tag:"div",cls:"im-gallery",children:[{tag:"div",cls:"im-gallery-topbar"},{tag:"div",cls:"im-gallery-content",html:this.spinnerTMPL}]}),this.topbarEl=this.el.first(),this.contentEl=this.topbarEl.next(),this.scrollBar=new _UI52.ScrollBar({autoRender:this.el})}},{key:"destroy",value:function(){_WA99.gallery.updateEvent.un(this._onGalleryUpdate,this),_WA99.snippet.loadEvent.un(this._updatePreviews,this),_WA99.fileTools.loadEvent.un(this._updatePreviews,this),_WA99.mediaPlayer.stateEvent.un(this._updateMediaFilesState,this),this.contentEl&&this.contentEl.un("scroll",this._onScroll,this),this.el&&this.el.un("click",this._onClick,this),this.scrollBar.destroy(),this.clickOnPttEvent.removeAll(),this.clickOnPreviewEvent.removeAll(),this.itemActionEvent.removeAll(),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI52.ES6Component);GalleryView.prepareItemMenu=function(a,b,c){var d=_WA99.gallery.getItem(a,c,b);if(d){var e,f=d.author.friendly||(d.author.firstName||d.author.lastName?"".concat(d.author.firstName||""," ").concat(d.author.lastName||""):""),g={sender:d.author.sn,sn:a,from:d.author.sn===_WA99.ACTIVE_MAIL?_WA99.ACTIVE_MAIL:a,mid:d.id.mid,arch_id:d.id.mid,date:d.time,senderFriendly:f,text:d.url},h=_WA99.fileTools.resolveLinkAsFile(d.url),i=h&&_WA99.fileTools.getLocalFileInfo(h),j=b,k="image"===d.type||"video"===d.type;k?i&&(j=i.orig_url||j,e=i.url,k=i.is_previewable):("file"===d.type||"audio"===d.type)&&i&&(e=i.url);var l={resend:!0,goToMessage:!0,saveAs:!!e,copyLink:!e&&_WA99.clipboardSupported&&j,openInBrowser:k&&!e&&j,toFavorite:a!==_WA99.ACTIVE_MAIL};return{menuItems:l,options:{sn:d.author.sn,nick:f,msgText:d.url,origUrl:j,downloadUrl:e},msg:g}}},_WA99.GalleryView=GalleryView;var REQUEST_CHAT_MEMBERS_LIMIT=50,SIDEBAR_CHAT_MEMBERS_LIMIT=5,SIDEBAR_UPDATE_DELAY=1e3,_WA100=WebIM,_TD32=_WA100.TemplateDriver,_U86=_WA100.util,_UI53=_WA100.ui,_DomUtil49=_WA100.DomUtil,COLLAPSE_LONG_TEXT_LIMIT=150,ACCENT_BUTTON_SCHEMA={openDialog:{action:"openDialog",icon:"message",titleKey:"contextmenu.message"},unblockContact:{action:"unblockContact",icon:"unblock",titleKey:"contextmenu.unblock"},openFavorite:{action:"openDialog",icon:"favorite",titleKey:"dialog.openFavorite"},joinGroup:{action:"joinGroup",icon:"join",titleKey:"chat.joinChat"},addToChat:{action:"addToChat",icon:"join",titleKey:"group.addToGroup"},addToChannel:{action:"addToChat",icon:"join",titleKey:"group.addToChannel"}},ACTION_BUTTON_LOCALIZATION={allMembers:"chat.allMembers",adminMembers:"chat.admins",blockedMembers:"chat.blocked",pendingMembers:"chat.pending"},buildCounterButton=function(a,b){return _TD32.parseSafe("dialogInfoCounterButton",{action:a,title:_WA100.tr(ACTION_BUTTON_LOCALIZATION[a]),counter:b>=0?b:""})},DialogsInfo=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"dialogInfo")),a.galleryPreviews={},a.infoData={},a.actionEvent=new _U86.Event,a.showContextMenuEvent=new _U86.Event,_WA100.gallery.updateEvent.on(a._onGalleryUpdate,_assertThisInitialized2(_assertThisInitialized2(a))),_WA100.snippet.loadEvent.on(a._updateGalleryPreviews,_assertThisInitialized2(_assertThisInitialized2(a))),_WA100.fileTools.loadEvent.on(a._updateGalleryPreviews,_assertThisInitialized2(_assertThisInitialized2(a))),a.el=_DomUtil49.get(_WA100.TD.getTMPL("dialogInfo",!0).firstChild),a.scrollBar=new _UI53.ScrollBar,a}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a,b){this.activate(a,b,!0)}},{key:"onPageUnload",value:function(){this.deactivate()}},{key:"activate",value:function(a,b,c){if(!this._active){if(c){var d=_DomUtil49.get(a);d.appendChild(this.el)}this.el.on("click",this._onClick,this).on("contextmenu",this._onContextmenu,this),this.scrollBar.render(this.el),this.scrollBar.setSource(this.el.getSelector(".im-sidebar__content")),_WA100.ContactListAgent.updateEvent.on(this._getUserCLData,this),(!this.infoData.sn||b&&this.infoData.sn!==b.sn)&&this.updateDialogInfoData(b),this.infoData.isChat?(_WA100.chatController.infoReadyEvent.on(this._onGroupInfoUpdate,this),_WA100.chatController.infoChangedEvent.on(this._onGroupInfoChanged,this),_WA100.chatController.getChatInfo(this.infoData.sn,REQUEST_CHAT_MEMBERS_LIMIT),_WA100.Statuses.updateEvent.on(this.updateGroupMembers,this)):_WA100.Statuses.updateEvent.on(this.updateTopInfo,this),_WA100.onlineManager.toggleEvent.on(this.updateTopInfo,this)}this._active=!0,this.refreshView()}},{key:"deactivate",value:function(){this._active&&(this.el.un("click",this._onClick,this).un("contextmenu",this._onContextmenu,this),this.hideGallery(),_WA100.chatController.infoReadyEvent.un(this._onGroupInfoUpdate,this),_WA100.chatController.infoChangedEvent.un(this._onGroupInfoChanged,this),_WA100.onlineManager.toggleEvent.un(this.updateTopInfo,this),_WA100.Statuses.updateEvent.un(this.updateGroupMembers,this),_WA100.Statuses.updateEvent.un(this.updateTopInfo,this),_WA100.ContactListAgent.updateEvent.un(this._getUserCLData,this),delete this._active)}},{key:"getElement",value:function(){return this.el}},{key:"update",value:function(a){this.updateDialogInfoData(a)}},{key:"updateDialogInfoData",value:function(a){var b=this,c=a.sn,d=c!==this.infoData.sn;d&&(this.infoData={profileId:_WA100.uniq(),sn:c,selfProfile:c===_WA100.ACTIVE_MAIL,isChat:_WA100.MainAgent.isChat(c),editable:!1,nameEditable:!1,mobile:null,uNick:a.uNick,official:void 0===a.official?_WA100.CLD.isOfficial(c):a.official,commonChats:0}),this.infoData.friendly=a.friendly||_WA100.CLD.getFriendlyName(c),this.infoData.mute=void 0===a.mute?_WA100.CLD.getMute(c):a.mute,this.infoData.activeChat=a.activeChat,this.infoData.uNick=a.uNick,this.infoData.historyAvailable=a.historyAvailable,this.infoData.isFavorite=this.infoData.selfProfile&&this.infoData.activeChat,this.infoData.lastseen=a.lastseen,this.infoData.userState=a.userState,a.bot&&(this.infoData.bot=a.bot),d&&(this._userCLData=null,this._groupData=null,this.resetView(),this._getUserCLData(),this.infoData.isChat?_WA100.chatController.getChatInfo(c,REQUEST_CHAT_MEMBERS_LIMIT):_WA100.contactAbstraction.getUserProfile(c,function(a){a&&(b.infoData.aboutMe=a.aboutMe,b.infoData.firstname=a.firstname,b.infoData.lastname=a.lastname,b.infoData.friendly=a.friendly,b.infoData.commonChats=a.commonChats,b.infoData.lastseen=a.lastseen,b.infoData.userState=a.userState,b.infoData.uNick=a.uNick,b.infoData.bot=a.bot,a.phone&&(b.infoData.mobile=a.phone)),b.infoData.selfProfile||_WA100.contactAbstraction.getAbData(c,b._onAbData.bind(b)),b.refreshView()},!1)),this.refreshView()}},{key:"resetView",value:function(){this.setEditable(!1),this.el.getSelector(".imSidebarActions").setVisible(!1),this.el.getSelector(".imSidebarGroupMembers").setVisible(this.infoData.isChat),this.el.getSelector(".imSidebarUserGroups").setVisible(!this.infoData.isChat),this.el.getSelector(".imSidebarCounters").setVisible(!1)}},{key:"setEditable",value:function(a){this.el.toggleClass("im-sidebar__editable",!!a)}},{key:"refreshView",value:function(){this._active&&(this.updateTopInfo(),this.updateActions(),this.infoData.isChat?this.updateGroupMembers():this.updateUserGroups(),this.updateGalleryCounters(),this.updateNegativeActions(),this.scrollBar.sync())}},{key:"updateTopInfo",value:function(){if(this._active){var a=this.infoData.sn,b="",c="",d=null,e="";if(this.el.getSelector(".imSidebarTopTitle").updateText(this.infoData.isFavorite?_WA100.tr("dialog.favorite"):_WA100.tr("box.info")),this.el.getSelector(".imSidebarTopInfo").setVisible(!this.infoData.isFavorite),this.el.getSelector(".imAvatarBox").setVisible(!this.infoData.isFavorite),this.infoData.isFavorite)this.el.getSelector(".imSidebarTop").hide();else{var f=_WA100.Ava.make(a,this.infoData.friendly,52,function(){this.updateTopInfo()}.bind(this),{official:this.infoData.official}),g=this.el.getSelector(".imAvatarBox");if(g.toggleClass("im-sidebar__topinfo-ava_loaded",f.remoteLoaded),g.updateHTML(f.html),this.infoData.isChat)this._groupData&&this._groupData.member&&(b=this._groupData.membersCount>1?_WA100.tr("chat.countMembers",{count:parseInt(this._groupData.membersCount)}):this._groupData.channel?_WA100.tr("chat.aloneSubscriber"):_WA100.tr("chat.aloneMember"),this._groupData.pending?(b="",c=_WA100.tr("group.yourRequestUnderConsideration")):this._groupData.banned?(b="",c=_WA100.tr("group.youAreBannedInGroup")):this._groupData.membersCount||(b=""),e=_TD32.parseSafe("dialogInfoTopGroup",{infoAbout:_WA100.Emoji.parse(_U86.String.htmlEntity(this._groupData.about)),titleAbout:_WA100.tr(this._groupData.channel?"channel.about":"group.about"),styleAbout:this._groupData.about?"":"display:none;",clsAbout:this.infoData.fullAbout?"":"im-sidebar-short-text",infoRules:_WA100.Emoji.parse(_U86.String.htmlEntity(this._groupData.rules)),styleRules:this._groupData.rules?"":"display:none;",clsRules:this.infoData.fullRules?"":"im-sidebar-short-text",styleLink:this._groupData.link?"":"display:none;",infoLink:(this._groupData.link||"").replace(/^https?:\/\//,"")},{safeKeys:["infoAbout","infoRules"]}),this._groupData.banned||(_WA100.CLD.isBlocked(a)?d="unblockContact":this._groupData.pending?d="":!this._groupData.member&&this._groupData.stamp?d="joinGroup":!this._groupData.member||this.infoData.activeChat&&_WA100.splitView||(d=this._groupData.channel?"addToChannel":"addToChat")));else{if(this.infoData.selfProfile)b="offline"!==_WA100.onlineManager.getStatus()?_WA100.CLD.getLastseenMessage(0):"";else{var h=_WA100.CLD.getUserState(a)||this.infoData.userState,i=_WA100.CLD.getLastseen(a);null===i&&(i=this.infoData.lastseen),b=_WA100.CLD.getLastseenMessage(i,{userState:h,bot:this.infoData.bot})}var j=this.infoData.mobile?_U86.String.formatPhoneNumber(this.infoData.mobile,!0):"",k=_WA100.isUIN(a)?"":a,l=this.infoData.uNick||"";e=_TD32.parseSafe("dialogInfoTopUser",{infoAbout:_WA100.Emoji.parse(_U86.String.htmlEntity(this.infoData.aboutMe)).replace(/\n/g,"<br/>"),aboutStyle:this.infoData.aboutMe?"":"display:none;",infoPhone:j,phoneStyle:j?"":"display:none;",infoEmail:k,emailStyle:k?"":"display:none;",infoNick:"@"+l,nickStyle:l?"":"display:none;"},{safeKeys:["infoAbout"]}),_WA100.CLD.isBlocked(a)?d="unblockContact":this.infoData.activeChat&&_WA100.splitView||(d=this.infoData.selfProfile?"openFavorite":"openDialog")}this.el.getSelector(".imSidebarTitle").updateHTML(_WA100.Emoji.parse(_U86.String.htmlEntity(this.infoData.friendly||a))),this.el.getSelector(".imSidebarSubtitle").updateHTML(b),this.el.getSelector(".imSidebarWarning").updateText(c),this.el.getSelector(".imSidebarTop").show().updateHTML(e)}this.updateAccentButton(d)}}},{key:"updateAccentButton",value:function(a){var b=this.el.getSelector(".imButtonAccent");b&&(ACCENT_BUTTON_SCHEMA[a]&&(b.setAttribute("data-action",ACCENT_BUTTON_SCHEMA[a].action||""),b.first().dom.className="im-button-accent_"+ACCENT_BUTTON_SCHEMA[a].icon,b.first().updateText(_WA100.tr(ACCENT_BUTTON_SCHEMA[a].titleKey,{defaultNull:!0})||"")),b.setVisible(!!ACCENT_BUTTON_SCHEMA[a]))}},{key:"updateActions",value:function(){var a=this.infoData.selfProfile||_WA100.CLD.isBlocked(this.infoData.sn)||this._groupData&&(this._groupData.banned||!this._groupData.member&&!this._groupData.pending),b=this.infoData.isChat&&this._groupData&&this._groupData.member&&(this._groupData.moder||!this._groupData.controlled),c=this.el.getSelector(".imSidebarActions"),d=c.getSelector(".imSidebarNotifications"),e=d.getSelector("input");this.infoData.mute?e.removeAttribute("checked").dom.checked=!1:e.setAttribute("checked","1").dom.checked=!0,d.setVisible(!a),c.getSelector("div[data-action=groupSettings]").updateText(_WA100.tr(this._groupData&&this._groupData.channel?"group.channelSettings":"group.groupSettings")).setVisible(b),c.getSelector("div[data-action=shareGroup]").updateText(_WA100.tr(this._groupData&&this._groupData.channel?"contextmenu.shareChannel":"contextmenu.shareGroup")).setVisible(!(!this._groupData||!this._groupData.link)),c.getSelector("div[data-action=shareContact]").setVisible(this.infoData.mobile),c.setVisible(!a||b)}},{key:"updateUserGroups",value:function(){var a=this.el.getSelector(".imSidebarUserGroups"),b=this.infoData.isChat,c=this.infoData.commonChats||0;a.getSelector("div[data-action=commonGroups]").setVisible(c>0),a.getSelector("div[data-action=commonGroups] span").updateText(c),a.setVisible(!b&&!this.infoData.selfProfile&&!_WA100.CLD.isBlocked(this.infoData.sn))}},{key:"updateGalleryCounters",value:function(){var a=this,b="",c=this.infoData.sn,d=this.el.getSelector(".imSidebarCounters"),e=this.el.getSelector(".imSidebarNegative");if(!this.infoData.activeChat||_WA100.CLD.isBlocked(c)||this.infoData.isChat&&(!this._groupData||!this._groupData.member))return void d.setVisible(!1);var f=_WA100.gallery.getLastItems(c,5,["video","image"]);if(f){var g=f&&f.counters||{},h=[];_U86.Array.each(_WA100.gallery.GALLERY_COUNTERS_SCHEMA,function(b){var c=0;_U86.Array.each(b.keys,function(a){g[a]&&(c+=g[a])}),c&&(b.counter=c,h.push(_TD32.parseSafe("galleryCounterItem",b)),"media"===b.type&&h.push(a._buildGalleryWidget(f.items)))}),b=h.join("")}d.updateHTML(b),d.setVisible(!!b),d.toggleClass("im-sidebar-delimiter",!this.infoData.isFavorite),e.toggleClass("im-sidebar-delimiter",!this.infoData.isFavorite||!!b)}},{key:"updateNegativeActions",value:function(){var a=this.infoData.sn,b=this.infoData.isChat,c=_WA100.CLD.isBlocked(a),d=b&&this._groupData&&this._groupData.creator,e=b&&this._groupData&&this._groupData.member,f=!b&&!this.infoData.selfProfile&&this._userCLData,g=b&&!c&&this._userCLData,h=this.el.getSelector(".imSidebarNegative");h.show(),h.getSelector('div[data-action="clearHistory"]').setVisible(this.infoData.historyAvailable&&!(this._groupData&&this._groupData.pending)),h.getSelector('div[data-action="blockContact"]').setVisible(!c&&!this.infoData.selfProfile&&!d&&(!b||e)),h.getSelector('div[data-action="unblockContact"]').setVisible(c),h.getSelector('div[data-action="reportSpam"]').setVisible(!_WA100.configurator.getOption("disable_remove_user_button")&&f||g&&e&&!d),h.getSelector('div[data-action="leave"]').setVisible(g)}},{key:"_getUserCLData",value:function(){var a=this;_WA100.ma.contactList.getContactsInfo([this.infoData.sn],function(b){b=b&&b[0],b&&b[0]===a.infoData.sn&&(a._userCLData=b,a.refreshView())})}},{key:"_onGroupInfoChanged",value:function(a,b){a===this.infoData.sn&&_WA100.chatController.getChatInfo(a,0,!0)}},{key:"_onGroupInfoUpdate",value:function(a,b,c,d){if(a===this.infoData.sn){if(b&&c){this.infoData.friendly=c.name;var e=!(!c.controlled||c.you&&("admin"===c.you.role||"moder"===c.you.role));this._groupData={channel:"readonly"===c.defaultRole,about:c.about||"",rules:c.rules||"",locked:e,members:c.members.slice(0,SIDEBAR_CHAT_MEMBERS_LIMIT),member:c.you&&c.you.role,creator:c.creator===_WA100.ACTIVE_MAIL,admin:c.you&&"admin"===c.you.role,moder:c.you&&("moder"===c.you.role||"admin"===c.you.role),readonly:c.you&&"readonly"===c.you.role,pending:c.you&&c.you.pending,membersCount:c.membersCount,blockedCount:c.blockedCount,pendingCount:c.pendingCount,adminsCount:c.adminsCount,stamp:c.stamp,controlled:c.controlled,link:c.stamp&&_WA100.urlBuilder.chatLink(c)},this._groupData.about.length<COLLAPSE_LONG_TEXT_LIMIT&&(this.infoData.fullAbout=!0),this._groupData.rules.length<COLLAPSE_LONG_TEXT_LIMIT&&(this.infoData.fullRules=!0)}else this._groupData={banned:40002===c};this.setEditable(this._groupData.member&&(this._groupData.moder||!this._groupData.controlled)),this.refreshView()}}},{key:"_onAbData",value:function(a,b){this.infoData.sn===a&&(this.infoData.nameEditable=!(!this._userCLData||b.abName||b.abPhone||this.infoData.selfProfile),this.infoData.nameEditable&&this.setEditable(!0),b.abPhone&&!this.infoData.mobile&&(this.infoData.mobile=b.abPhone),this.refreshView())}},{key:"updateGroupMembers",value:function(){var a="",b=this.el.getSelector(".imSidebarGroupMembers"),c=this._groupData&&this._groupData.moder;if(this._groupData&&this._groupData.member&&(c||!this._groupData.channel)&&!_WA100.CLD.isBlocked(this.infoData.sn)){var d=this._groupData.membersCount,e=[];this._groupData.pendingCount&&c&&e.push(buildCounterButton("pendingMembers",this._groupData.pendingCount));var f=this._generateShortList();f&&e.push(f),this._groupData.adminsCount&&e.push(buildCounterButton("adminMembers",this._groupData.adminsCount)),d&&e.push(buildCounterButton("allMembers",d)),this._groupData.blockedCount&&c&&e.push(buildCounterButton("blockedMembers",this._groupData.blockedCount)),a=_TD32.parseSafe("dialogInfoGroupMembers",{title:_WA100.tr("chat.countMembers",{count:d}),memberList:e.join("")},{safeKeys:["memberList"]})}b.updateHTML(a),b.setVisible(!!a)}},{key:"_generateShortList",value:function(){var a=this,b=[];return this._groupData.members.forEach(function(c){var d=c.email,e=c.friendly,f="",g=c.honours&&c.honours.length&&c.honours.indexOf("official")>-1,h=_WA100.Ava.make(d,e,32,null,{official:g,mute:_WA100.CLD.getMute(d)});c.creator?f=_WA100.tr("group.roleCreator"):"admin"===c.role||"moder"===c.role?f=_WA100.tr("group.roleAdmin"):"readonly"!==c.role||a._groupData.channel||(f=_WA100.tr("group.roleReadonly"));var i=[];f&&i.push("im-member-item_has-role");var j=_WA100.CLD.getLastseen(c.email),k=_WA100.CLD.getUserState(c.email)||c.userState;null===j&&(j=c.lastseen),b.push(_TD32.parseSafe("dialogInfoMember",{avatarHtml:h,friendly:_WA100.Emoji.parse(_U86.String.htmlEntity(e||d)),dataFriendly:e||d,sn:d,role:f,lastSeen:_WA100.CLD.getLastseenMessage(j,{userState:k,bot:_WA100.CLD.isBot(c.email)||c.bot}),classes:i.join(" ")},{safeKeys:["avatarHtml","friendly","lastSeen"]}))},this),b.join("")}},{key:"_onClick",value:function(a){var b=this,c=a.getTarget(!0),d=this.infoData.sn,e=c.up("imButton"),f=e&&e.getAttribute("data-action");switch(f){case"showGroupAbout":this.infoData.fullAbout=!0,this.el.getSelector(".imSidebarAbout").removeClass("im-sidebar-short-text"),this.scrollBar.sync();break;case"showGroupRules":
this.infoData.fullRules=!0,this.el.getSelector(".imSidebarRules").removeClass("im-sidebar-short-text"),this.scrollBar.sync();break;case"openDialog":_WA100.splitView||_WA100.InfoPanel.close(),_WA100.contactAbstraction.openDialog(d,this.infoData.friendly);break;case"groupSettings":case"editInfo":if(this.infoData.isChat){if(this._groupData.moder||!this._groupData.controlled){var g=new _WA100.GroupSettingsBox({chatId:d});g.show()}}else if(this.infoData.nameEditable){if(this._userCLData){var h=new _UI53.EditModalBox({title:_WA100.tr("profile.name"),formType:"text",defaultValue:this.infoData.friendly,onEditOk:function(a){a!==b.infoData.friendly&&(b.infoData.friendly=a,_WA100.contactAbstraction.renameEvent.fire(b.infoData.sn,a),b.updateTopInfo())}});h.show()}return}break;case"copySn":_U86.Selection.copy2clipboard(this.infoData.sn),_WA100.showPopup(_WA100.tr("msgEmailCopied"));break;case"copyNick":_U86.Selection.copy2clipboard("@"+this.infoData.uNick),_WA100.showPopup(_WA100.tr("msgNickCopied"));break;case"copyPhoneNumber":_U86.Selection.copy2clipboard(_U86.String.formatPhoneNumber(this.infoData.mobile,!0)),_WA100.showPopup(_WA100.tr("msgPhoneCopied"));break;case"copyGroupLink":_U86.Selection.copy2clipboard(this._groupData.link),_WA100.showPopup(_WA100.tr("msgLinkCopied"));break;case"shareGroup":_WA100.ma.dialogsWindow.forwardMessage(this.infoData.sn,this.infoData.friendly,this._groupData.link,!0);break;case"shareNick":_WA100.ma.dialogsWindow.forwardMessage(this.infoData.sn,this.infoData.friendly,_WA100.urlBuilder.profileLink(this.infoData.uNick),!0);break;case"shareSn":_WA100.ma.dialogsWindow.forwardMessage(this.infoData.sn,this.infoData.friendly,_WA100.urlBuilder.emailLink(this.infoData.sn),!0);break;case"shareContact":_WA100.ma.dialogsWindow.forwardMessage(this.infoData.sn,this.infoData.friendly,{contact:{sn:this.infoData.sn,phone:this.infoData.mobile,name:this.infoData.friendly},text:"".concat(this.infoData.friendly||_WA100.uinAsName(this.infoData.sn)," ").concat(this.infoData.mobile)},!0);break;case"muteChat":"checkbox"===c.dom.type&&_WA100.contactAbstraction.mute(d,!c.dom.checked);break;case"commonGroups":this._commonGroupsList||(this._commonGroupsList=new _WA100.GroupListPage),_WA100.splitView?_WA100.Pane.openPageBox(this._commonGroupsList,{sn:d}):App.load("groupList",{sn:d});break;case"addToChat":_WA100.DialogsAgent.showAddMemberDialog({contact:[d,this.infoData.friendly],isChat:this.infoData.isChat,nameBlock:!this.infoData.isChat,allowEmpty:!this.infoData.isChat});break;case"closeSidebar":_WA100.Pane.isCurrentPage("dialogInfo")?App.back():_WA100.InfoPanel.close();break;case"avatarPreview":this.openAvatarPreview();break;case"memberMenu":this._onContextmenu(a);break;case"openProfile":_WA100.contactAbstraction.openProfile(e.getAttribute("data-sn"),e.getAttribute("data-friendly"));break;case"blockedMembers":_WA100.LiveChats.showMemberList(d,"blocked");break;case"pendingMembers":_WA100.LiveChats.showMemberList(d,"pending");break;case"adminMembers":_WA100.LiveChats.showMemberList(d,"admins");break;case"allMembers":_WA100.LiveChats.showMemberList(d,"members");break;case"joinGroup":_WA100.LiveChats.joinChat(this._groupData.stamp,function(a){});break;case"preview":return void this._onGalleryPreview(decodeURIComponent(e.getAttribute("data-url")||""),e.getAttribute("data-mid"),e.getAttribute("data-type"));case"media":case"video":case"ptt":case"files":case"links":return void this.showGallery(d,f);case"leave":case"clearHistory":this.actionEvent.fire(d,f,this.infoData.friendly);break;case"blockContact":case"reportSpam":case"removeContact":case"unblockContact":_WA100.contactAbstraction.doAction(f,d,this.infoData.friendly)}}},{key:"openAvatarPreview",value:function(){var a=this;null==this._mediaPlayer&&(this._mediaPlayer=new _UI53.PhotoPreview({autoRender:_DomUtil49.getBody(),fadeIn:!0,modal:!0}));var b=_WA100.Ava.make(this.infoData.sn,null,400,function(){a._active&&a.openAvatarPreview()});if(b.remoteLoaded&&b.url){var c=_WA100.fileTools.emulateFileObjForPreview(b.url);this._mediaPlayer.open(c)}}},{key:"_buildMemberMenuItems",value:function(a){var b=a===_WA100.ACTIVE_MAIL,c=_WA100.chatController.getMemberRole(this.infoData.sn,a),d=!b&&_WA100.CLD.inList(a),e=this._groupData.admin,f=!b&&(e||this._groupData.moder&&"admin"!==c&&"moder"!==c);return{profile:!0,blockMember:f,allowWriting:f&&"readonly"===c,forbidWriting:f&&"readonly"!==c,removeAdminRights:e&&f&&("admin"===c||"moder"===c),giveAdminRights:e&&f&&!("admin"===c||"moder"===c),spam:!_WA100.configurator.getOption("disable_remove_user_button")&&d}}},{key:"_onContextmenu",value:function(a){var b,c=a.getTarget(!0),d=this.infoData.sn,e=this.infoData.friendly,f=this.infoData.uNick,g=c.up("im-gallery-preview"),h=c.up("im-member-item"),i=c.up("im-sidebar__topinfo-item");g?(this.initGalleryView(),this._galleryView.showItemMenu(this.infoData.sn,decodeURIComponent(g.getAttribute("data-url")||""),g.getAttribute("data-mid"),a),a.stopEvent()):i&&(i.hasClass("imGroupLink")||i.hasClass("imEmail")||i.hasClass("imPhoneNumber")||i.hasClass("imNick"))?b={shareProfile:i.hasClass("imEmail")&&!_WA100.isUIN(this.infoData.sn),shareContact:i.hasClass("imPhoneNumber")&&this.infoData.mobile,shareChannel:this._groupData&&this._groupData.channel&&this._groupData.link,shareGroup:this._groupData&&!this._groupData.channel&&this._groupData.link,shareNick:i.hasClass("imNick")&&this.infoData.uNick,copyGroupLink:_WA100.clipboardSupported&&this._groupData&&this._groupData.link,copyEmail:_WA100.clipboardSupported&&i.hasClass("imEmail"),copyPhoneNumber:_WA100.clipboardSupported&&i.hasClass("imPhoneNumber")&&this.infoData.mobile,copyNick:_WA100.clipboardSupported&&i.hasClass("imNick")&&this.infoData.uNick,copyProfileLink:_WA100.clipboardSupported&&(i.hasClass("imEmail")||i.hasClass("imNick")&&this.infoData.uNick)}:h&&(d=h.getAttribute("data-sn"),e=h.getAttribute("data-friendly"),b=this._buildMemberMenuItems(d)),b&&(_WA100.contextMenu.show(a,b,{sn:d,friendly:e,uNick:f},this._onContextMenuAction.bind(this)),a.stopEvent())}},{key:"_onContextMenuAction",value:function(a,b){switch(b){case"spam":_WA100.contactAbstraction.doAction("reportSpam",a.sn,a.friendly);break;case"openProfile":_WA100.contactAbstraction.openProfile(a.sn);break;case"shareChannel":case"shareGroup":_WA100.ma.dialogsWindow.forwardMessage(this.infoData.sn,this.infoData.friendly,this._groupData.link,!0);break;case"shareProfile":_WA100.ma.dialogsWindow.forwardMessage(this.infoData.sn,this.infoData.friendly,_WA100.urlBuilder.emailLink(this.infoData.sn),!0);break;case"shareContact":_WA100.ma.dialogsWindow.forwardMessage(this.infoData.sn,this.infoData.friendly,{contact:{sn:this.infoData.sn,phone:this.infoData.mobile,name:this.infoData.friendly},text:"".concat(this.infoData.friendly||_WA100.uinAsName(this.infoData.sn)," ").concat(this.infoData.mobile)},!0);break;case"shareNick":_WA100.ma.dialogsWindow.forwardMessage(this.infoData.sn,this.infoData.friendly,_WA100.urlBuilder.profileLink(this.infoData.uNick),!0);break;case"blockMember":var c=new _UI53.BlockModalBox({chatSn:this.infoData.sn,sn:a.sn,friendly:a.friendly,onOk:function(a,b,c){_WA100.chatController.blockMembers(a,[{sn:b}],c)}});c.show();break;case"excludeMember":_WA100.chatController.delMembers(this.infoData.sn,[[a.sn]]);break;case"copyGroupLink":_U86.Selection.copy2clipboard(this._groupData.link),_WA100.showPopup(_WA100.tr("msgLinkCopied"));break;case"copyPhoneNumber":_U86.Selection.copy2clipboard(this.infoData.mobile),_WA100.showPopup(_WA100.tr("msgPhoneCopied"));break;case"copyEmail":_U86.Selection.copy2clipboard(this.infoData.sn),_WA100.showPopup(_WA100.tr("msgEmailCopied"));break;case"copyNick":_U86.Selection.copy2clipboard("@"+this.infoData.uNick),_WA100.showPopup(_WA100.tr("msgNickCopied"));break;case"copyProfileLink":_U86.Selection.copy2clipboard(_WA100.isUIN(this.infoData.sn)?_WA100.urlBuilder.profileLink(this.infoData.uNick):_WA100.urlBuilder.emailLink(this.infoData.sn)),_WA100.showPopup(_WA100.tr("msgLinkCopied"));break;default:_WA100.chatController.chatMemberAction({mail:a.sn,nick:a.friendly,chat_id:this.infoData.sn},b)}}},{key:"_onPttAction",value:function(a,b){this.actionEvent.fire(this.infoData.sn,"ptt",{btn:a,savePttSpeechState:b})}},{key:"_onGalleryAction",value:function(a,b){this.actionEvent.fire(this.infoData.sn,"contextMenu",{menuData:a,action:b})}},{key:"_onGalleryPreview",value:function(a,b,c){this.actionEvent.fire(this.infoData.sn,"preview",{url:a,mid:b,type:c})}},{key:"hideGallery",value:function(){this._galleryView&&this._galleryView.hide()}},{key:"initGalleryView",value:function(){this._galleryView||(this._galleryView=new _WA100.GalleryView({autoRender:this.el}),this._galleryView.clickOnPttEvent.on(this._onPttAction,this),this._galleryView.itemActionEvent.on(this._onGalleryAction,this),this._galleryView.clickOnPreviewEvent.on(this._onGalleryPreview,this))}},{key:"showGallery",value:function(a,b){this.el&&(this.initGalleryView(),this._galleryView.show(a,b))}},{key:"_buildGalleryWidget",value:function(a){var b=this,c=[],d=this.galleryPreviews[this.infoData.sn]=[];return a.some(function(a){if("image"===a.type||"video"===a.type){var e={url:a.url,mid:a.id.mid};d.push(e),c.push(b._buildSafeGalleryPreview(e))}return d.length>4}),'<div class="im-sidebar-gallery__previews">'.concat(c.join(""),"</div>")}},{key:"_buildSafeGalleryPreview",value:function(a){var b,c,d=_WA100.fileTools.resolveLinkAsFile(a.url);if(d){var e=_WA100.fileTools.requestFileInfo(d);a.id=d,e&&(b=_WA100.fileTools.getPreviewUrl(d,!0,a.url),"image/gif"===e.mime?c="GIF":e.duration&&(c=_U86.Date.formatDurationTime(e.duration)))}else a.id=a.url,b=_WA100.snippet.getPreviewUrl(a.url);return a.preview_url=b,_TD32.parseSafe("galleryPreviewItem",{url:_U86.String.encodeHref(_U86.String.ensureHttpsUrl(b||"")),orig_url:encodeURIComponent(a.url),mid:a.mid,info:c},{safeKeys:["url","orig_url"]})}},{key:"_updateGalleryPreviews",value:function(a){if(this.el){var b=this.infoData.sn,c=this.el.getSelector(".im-sidebar-gallery__previews");if(c&&this.galleryPreviews[b]&&_U86.Array.findBy(this.galleryPreviews[b],function(b){return b.id===a})){var d=this.galleryPreviews[b].map(this._buildSafeGalleryPreview.bind(this)).join("");d&&c.updateHTML(d),this.scrollBar.sync()}}}},{key:"_onGalleryUpdate",value:function(a){a===this.infoData.sn&&this.updateGalleryCounters()}},{key:"destroy",value:function(){this.scrollBar.destroy(),_WA100.gallery.updateEvent.un(this._onGalleryUpdate,this),_WA100.snippet.loadEvent.un(this._updateGalleryPreviews,this),_WA100.fileTools.loadEvent.un(this._updateGalleryPreviews,this)}}]),b}(_WA100.Page);_WA100.DialogsInfo=DialogsInfo;var _WA101=WebIM,_U87=_WA101.util,_UI54=_WA101.ui,_TD33=_WA101.TemplateDriver,_AS2=_WA101.AccountSettings,_DomUtil50=_WA101.DomUtil,POST_MAX_LENGTH=2e4,_MAX_PTT_DURATION=9e5,PTT_HISTOGRAM_BAR_WIDTH=2,PTT_HISTOGRAM_BAR_STEP=2,DEFAULT_INPUT_MAX_HEIGHT=216,MIN_INPUT_HEIGHT=34,SHIFT_FOR_IOS_SAFARI_KEYBOARD=_WA101.isIOSSafari?10:0,REGEX_MENTION_HOLDER=/<mark[^>]+data-mention="([^"]+)"[^>]*>(.+?)<\/mark>/gi,needDetectKeyboardOnIOS=_WA101.isIOS,tail="%[89A-B][\\dA-F]",utf1="%[0-7][\\dA-F]",utf2="%(?:C[2-9A-F]|D[\\dA-F])"+tail,utf3="%E0%[AB][\\dA-F]"+tail+"|%E[1-9A-C](?:"+tail+"){2}|%ED%[89][\\dA-F]"+tail+"|%E[EF](?:"+tail+"){2}",utf4="%F0%[9AB][\\dA-F](?:"+tail+"){2}|%F[1-3](?:"+tail+"){3}|%F4%8[\\dA-F](?:"+tail+"){2}",rfcRegExp="(?:"+[utf1,utf2,utf3,utf4].join("|")+")",RFCReplacer=function(a){return a.replace(/\%/g,"$_$")},IOSKeyboardSize,ignoreFocusEvent,bodyScrollFixed,DialogInput=function(){function a(){_classCallCheck2(this,a),this.changeEvent=new _U87.Event,this.submitEvent=new _U87.Event,this.stickerEvent=new _U87.Event,this.sendPttEvent=new _U87.Event,this.chooseFileEvent=new _U87.Event,this.shareContactEvent=new _U87.Event,this.overflowEvent=new _U87.Event,this.showSmileMenuEvent=new _U87.Event,this.hideSmileMenuEvent=new _U87.Event,this.showPttEvent=new _U87.Event,this.hidePttEvent=new _U87.Event,this.topMessageToggleEvent=new _U87.Event,this.clickOnEditedMsgEvent=new _U87.Event,this.upArrowEvent=new _U87.Event,this.topMessagesEl=null,this._quotedData=null,this._editedData=null,this._activeMessageAction="",this.lastPicturesState=!1,this.field=new _UI54.SmilesTextField({cls:"im-chat__input-field",maxLength:POST_MAX_LENGTH,hintText:_WA101.tr("dialog.message")}),this.field.hotKeyFocusedLayerConfig.overlayOnHandle=!1,this.hotKeyLayerConfig={name:"dialogInput",activateOnCreate:!0,overlayOnHandle:!0},this.stickersSuggest=new _WA101.StickersSuggest,this.stickersSuggest.itemClickEvent.on(function(a){a=a||{},this.picturesMenu&&this.picturesMenu.hide(),this.setVal(""),this.stickerEvent.fire(a.pack,a.id,this._quotedData&&this._quotedData.messages),this.resetTopMessages("quote")},this),this.resizeEvent=(new _U87.Event).relay(this.field.resizeEvent),this.focusEvent=(new _U87.Event).relay(this.field.focusEvent),this.blurEvent=(new _U87.Event).relay(this.field.blurEvent),this.field.toggleEvent.on(this._checkSendAction,this),this.field.changeEvent.on(this._onFieldChange,this),this.field.suggestsEvent.on(this._onSuggestsEvent,this),this.field.pasteFileEvent.on(this._onPasteFile,this),this.field.onHotKeyFocusedLayer(["arrowLeft","arrowRight","arrowDown","arrowUp","enter"],this._onFieldHotKey,this)}return _createClass2(a,[{key:"init",value:function(a){this.dialogSn=a}},{key:"renderBind",value:function(a){var b=this;this.el&&this.renderUnbind(),this.winEl=a,this.el=a.getSelector(".im-chat__input"),this.field.renderBind(this.el.first().first().first()),this.el.on("click",this._onClick,this),this.el.on("change",this._onChange,this),this.stickerPickerBtn=this.el.getSelector(".imButtonSmiles"),_WA101.isDesktop||this.stickerPickerBtn.setVisible(!_WA101.Feature.getModeParameter("hideStickerPickerOnMobile")),this.userSuggests&&this.userSuggests.destroy(),this.userSuggests=new _WA101.SuggestBox({}),this.userSuggests.itemClickEvent.on(function(a,b){this.addMention(a,b)},this),this.userSuggests.render(this.el),this.userSuggests.setControlElement(this.el.first()),needDetectKeyboardOnIOS&&(this.field.el.on("touchend",this._fixBodyScroll,this),this.inputForFocus&&this.inputForFocus.remove(),this.inputForFocus=this.field.el.parent().createChild({tag:"input",cls:"im-textfield_rich im-chat__input-field im-chat__input-field__foriphonefocus"}),this.inputForFocus.on("focus",function(){this._onHelperInputFocus&&_WA101.setTimeout(this._onHelperInputFocus,500,this)},this)),this.lastPicturesState=!1,this._readyToSubmitPtt=!1,this.picturesMenu&&this.picturesMenu.destroy(),this.picturesMenu=new _WA101.DialogPage.SmileBox,this.picturesMenu.itemClickEvent.on(function(a,b){b=b||{},"emoji"===a?this.addEmoji(b.id,b.blockId):"showcase"===a?this.openShowcase(b.pack):"sticker"===a&&(this.picturesMenu.hide(),this.stickerEvent.fire(b.pack,b.id,this._quotedData&&this._quotedData.messages),this.resetTopMessages("quote"))},this),this.picturesMenu.backspaceEvent.on(function(){ignoreFocusEvent=needDetectKeyboardOnIOS,this.field.doBackspace(function(){this.field.blur(),ignoreFocusEvent=!1}.bind(this))},this),this.picturesMenu.hotKeyTabEvent.on(this.blurField,this),this.picturesMenu.render(this.el),this.picturesMenu.setControlElement(this.el),this.showSmileMenuEvent.relay(this.picturesMenu.showEvent),this.picturesMenu.hideEvent.on(function(){this.stickersSuggest&&(this.stickersSuggest.fromMenuData?this.stickersSuggest.hide():_WA101.setTimeout(this.stickersSuggest.updatePosition,1,this.stickersSuggest)),this.hideSmileMenuEvent.fire.apply(this.hideSmileMenuEvent,arguments)},this),this.picturesMenu.showEvent.on(function(){this.stickersSuggest&&_WA101.setTimeout(this.stickersSuggest.updatePosition,1,this.stickersSuggest)},this),this.attachMenu=new _UI54.Menu({hideOnEscape:!0,toggleMethod:"visibility",itemClass:"im-attachmenu__item",activeItemClass:"im-attachmenu__item_active"}),this.attachMenu.showEvent.on(function(){b.el.addClass("im-chat__input_attachmenu-opened")}),this.attachMenu.hideEvent.on(function(){b.el.removeClass("im-chat__input_attachmenu-opened")}),this.attachMenu.render(this.el,this.el.getSelector(".im-attachmenu")),this.attachMenu.setControlElement(this.el.getSelector(".im-chat__input-sub-action"));var c=!_WA101.configurator.getOption("disable_polls")&&!_WA101.Feature.getModeParameter("disablePollsSending");this.attachMenu.el.getSelector('.imButton[data-action="poll"]').setVisible(c),this.attachMenu.el.getSelector('.imButton[data-action="contact"]').setVisible(!_WA101.Feature.getModeParameter("disableContactSending")),_WA101.pttRecorder.stateEvent.on(this._onPttRecorderState,this),_WA101.pttRecorder.analyserEvent.on(this._onPttRecording,this),_WA101.pttRecorder.playbackEvent.on(this._onPttPlayback,this),this.pttWrap=this.el.getSelector(".im-chat__input-ptt-wrap"),_WA101.hotKeyManager.addLayer(this.hotKeyLayerConfig)}},{key:"renderUnbind",value:function(){this.el&&(_WA101.hotKeyManager.removeLayer(this.hotKeyLayerConfig),_WA101.pttRecorder.stateEvent.un(this._onPttRecorderState,this),_WA101.pttRecorder.analyserEvent.un(this._onPttRecording,this),_WA101.pttRecorder.playbackEvent.un(this._onPttPlayback,this),_WA101.pttRecorder.stop(),this.pttHistogram&&(this.pttHistogram.destroy(),this.pttHistogram=null),this.stickersSuggest&&this.stickersSuggest.hide(),this.el.un("click",this._onClick,this),this.el.un("change",this._onChange,this),this.inputForFocus&&(this.field.el.un("touchend",this._fixBodyScroll,this),this.inputForFocus.remove(),delete this.inputForFocus),this.field.renderUnbind(),this.picturesMenu.destroy(),this.picturesMenu=null,this.attachMenu.destroy(),this.attachMenu=null,this.pttWrap=null,this._readyToSubmitPtt=!1,this.resetTopMessages(),this.winEl=this.el=null)}},{key:"getIgnoreFocusEventFlag",value:function(){return ignoreFocusEvent}},{key:"_onPttDrawHistogram",value:function(a,b,c,d,e){this._pttDrawHistogramTimer&&clearTimeout(this._pttDrawHistogramTimer),(c>=d||!this.el.hasClass("im-chat__input_ptt-played"))&&(e=!0),this._pttDrawHistogramParams={mode:a,data:b,curTime:c,duration:d,force:e,ts:(new Date).getTime()},this._pttDrawHistogramTimer=_WA101.setTimeout(this._pttDrawHistogram,e?0:50,this)}},{key:"_onPttRecording",value:function(a){if(this.pttDuration.updateText(_U87.Date.formatDurationTime(a)+","+a.toFixed(2).replace(/^\d+\./,"")),!_WA101.isEdge&&!_WA101.isIE){var b=Math.floor(10*a);if(this._lastDrawTime!==b){this._lastDrawTime=b;var c=_WA101.pttRecorder.buildCurrentAnalyserData();if(c&&c.bars&&this.pttHistogram){var d=PTT_HISTOGRAM_BAR_WIDTH,e=PTT_HISTOGRAM_BAR_STEP,f=Math.floor(this.pttHistogram.el.dom.offsetWidth/(d+e)),g=c.bars.slice(-f);this.pttHistogram.draw(g)}}}}},{key:"_onPttPlayback",value:function(a,b,c){this.pttDuration.updateText(_U87.Date.formatDurationTime(a)+","+a.toFixed(2).replace(/^\d+\./,""));var d=Math.floor(10*a);if(c||this._lastDrawTime!==d||a===b)if(this._lastDrawTime=d,_WA101.isEdge||_WA101.isIE){var e;a===b&&(this.el.removeClass("im-chat__input_ptt-played"),a=0),a&&(e=this.pttHistogram.el.dom.offsetWidth*Math.min(1,a/b)),this.pttHistogram.draw(null,e,!0)}else{var f=PTT_HISTOGRAM_BAR_WIDTH,g=PTT_HISTOGRAM_BAR_STEP,h=Math.floor(this.pttHistogram.el.dom.offsetWidth/(f+g));a===b&&(this.el.removeClass("im-chat__input_ptt-played"),a=0);var i,j,k=_WA101.pttRecorder.analyserData;if(!k)return;if(k.customBars||(k=_WA101.pttRecorder.calculateAnalyserCustomBars(h)),a&&k){var l=k.customBars.length*(f+g);j=l*Math.min(1,a/b)}i=k&&k.customBars,this.pttHistogram.draw(i,j)}}},{key:"_onPttRecorderState",value:function(a,b){switch(a){case"error":console.log("@!@!PTT ERROR",b),this.el.removeClass("im-chat__input_ptt-loading"),this.hidePttEvent.fire();var c="",d=(b&&(b.message||b.toString())||"").toLowerCase();"recorder is not supported"===d?c="box.recIsUnavailable":d.indexOf("permission")>-1||d.indexOf("allowed")>-1?c="box.micPermission":d.indexOf("not found")>-1&&(c="box.micNotFound"),c?_UI54.showAlertBox(_WA101.tr(c),_WA101.tr(c+"Title")):_UI54.showAlertBox(_WA101.tr("box.recIsUnavailableTitle"));break;case"overtime":this.el.addClass("im-chat__input_ptt-loading"),_WA101.pttRecorder.stop();break;case"start":this.el.removeClass("im-chat__input_ptt-loading"),this.el.addClass("im-chat__input_ptt-recording"),this.resizeEvent.fire();break;case"ready":if(this.el.removeClass("im-chat__input_ptt-loading"),!this.el.hasClass("im-chat__input_ptt-recording"))return;console.log("### WE HAVE RECORD!!!!",b.url,b.duration),this.el.addClass("im-chat__input_ptt-ready"),this._readyToSubmitPtt?this._submitPtt():this._onPttPlayback(b.duration,b.duration,!0)}}},{key:"_onClick",value:function(a){var b=a.getTarget(!0),c=b.up("imButton")||b.up("im-ui-button");if(b.hasClass("im-chat__input-ptt-canvas"))_WA101.pttRecorder.isStarted()?(this.el.addClass("im-chat__input_ptt-loading"),_WA101.pttRecorder.stop()):this.el.hasClass("im-chat__input_ptt-was-played")?_WA101.pttRecorder.setCurrentProgress((a.pageX-b.offset().left)/b.dom.offsetWidth):_WA101.pttRecorder.hasRecord()&&(_WA101.pttRecorder.play(),this.el.addClass("im-chat__input_ptt-played"),this.el.addClass("im-chat__input_ptt-was-played"));else if(c){var d=c.getAttribute("data-action")||"";if(c.up("im-attachmenu")&&this.attachMenu.hide(),c.hasClass("im-chat__input-action")?(d="ptt",(this.el.hasClass("im-chat__input-message")||this.el.hasClass("im-chat__input_ptt-recording"))&&(d="submit")):c.hasClass("im-attachmenu__item_ptt")?d="ptt":c.hasClass("im-chat__input-sub-action")&&(d="attach_menu",this.el.hasClass("im-chat__input_ptt-recording")&&(d="ptt_remove")),d)switch(d){case"ptt":_WA101.pttRecorder.isStarted()||(this.pttHistogram||(this.pttHistogram=new _UI54.AudioHistogram({barSize:PTT_HISTOGRAM_BAR_WIDTH,basrStep:PTT_HISTOGRAM_BAR_STEP,cls:"im-chat__input-ptt-canvas"}),this.pttHistogram.render(this.pttWrap),this.pttDuration=this.pttWrap.getSelector(".im-chat__input-ptt-time")),this.el.addClass("im-chat__input_ptt-loading"),_WA101.pttRecorder.start(_MAX_PTT_DURATION),this.showPttEvent.fire());break;case"submit":this._submit(a);break;case"attach_menu":this.attachMenu.toggle(),!a||a.pageX||a.pageY||this.attachMenu.selectItem(0);break;case"ptt_remove":this._resetPttRecorder();break;case"poll":this._makePoll();break;case"contact":this._shareContact()}else if(c.hasClass("im-chat__input-ptt-control"))_WA101.pttRecorder.isStarted()?(console.log("###handler stop record"),this.el.addClass("im-chat__input_ptt-loading"),_WA101.pttRecorder.stop()):_WA101.pttRecorder.playMode?(_WA101.pttRecorder.pause(),this.el.removeClass("im-chat__input_ptt-played")):_WA101.pttRecorder.hasRecord()&&(_WA101.pttRecorder.play(),this.el.addClass("im-chat__input_ptt-played"),this.el.addClass("im-chat__input_ptt-was-played"));else if(c.hasClass("im-chat__input-smiles"))this.picturesMenu.isVisible()?(this.focusField(!0,!0),this.picturesMenu.hide()):(this.picturesMenu.show(),_WA101.isDesktop&&a&&a.pageX&&a.pageY&&(this.focusField(!0),this.picturesMenu.deactivateArrowNavigation()));else if(c.hasClass("im-top-messages__close")&&this.topMessagesEl){var e=c.getAttribute("data-msg-id");if("quote"===this._activeMessageAction&&this._quotedData&&e){var f=_U87.Array.indexOfBy(this._quotedData.messages||[],function(a){return a.msgId===e});if(f>-1){var g=c.parent();if(g.remove(),this._quotedData.messages.splice(f,1),this._quotedData.messages.length)return void this.resizeEvent.fire()}}this.resetActiveTopMessage()}else if(c.hasClass("im-top-message")){var h=c.getAttribute("data-msg-id");h&&this.clickOnEditedMsgEvent.fire(h)}}}},{key:"_onChange",value:function(a){var b=a.getTarget?a.getTarget():a;b.files&&b.files.length&&(_U87.Mnt.countRB(33783227),this.setFilesToUpload(b.files),b.value=null)}},{key:"_onPasteFile",value:function(a){a&&(_U87.Mnt.countRB(34736261),this.setFilesToUpload([a]))}},{key:"setFilesToUpload",value:function(a,b){var c={};b||(this.field.textVal().match(/\S/)||"quote"===this._activeMessageAction)&&("quote"===this._activeMessageAction&&this._quotedData&&(c.quotes=this._quotedData.messages),c.message=this.field.val(),this.field.val("",!0)),this.chooseFileEvent.fire(a,b,c)}},{key:"_makePoll",value:function(){var a=this,b=new _WA101.CreatePollBox({onEditOk:function(b){var c=b.title,d=b.answers;_U87.Mnt.countRB(52121131);var e=null;"quote"===a._activeMessageAction&&a._quotedData&&(e=a._quotedData.messages),a.submitEvent.fire(c,{poll:{answers:d},quotes:e})}});b.show()}},{key:"_shareContact",value:function(){var a=null;"quote"===this._activeMessageAction&&this._quotedData&&(a=this._quotedData.messages),this.shareContactEvent.fire(this.dialogSn,{quotes:a})}},{key:"_onFieldHotKey",value:function(a,b){if(this.userSuggests.navigate(b))return a.stopEvent(),!1;var c=this.field.textVal().match(/\S/);if("enter"===b){if(!a.shiftKey&&(a.ctrlKey||_AS2.getOption(_AS2.OPTION_SEND_BY_ENTER))&&(this.el.hasClass("im-chat__input_ptt-recording")||c||"quote"===this._activeMessageAction))return this._submit(a),a.stopEvent(),!1}else if("arrowUp"===b&&this.upArrowEvent.fire(""===this.getVal()))return!1}},{key:"_checkSendAction",value:function(a){"quote"===this._activeMessageAction&&(a=!1),this.el.toggleClass("im-chat__input-message",!a)}},{key:"_onFieldChange",value:function(a){var b=encodeURIComponent(a),c=b.length;c>POST_MAX_LENGTH?(a=decodeURIComponent(b.substr(0,POST_MAX_LENGTH).replace(new RegExp(rfcRegExp,"g"),RFCReplacer).replace(/%[\dA-F]*/g,"").replace(/\$_\$/g,"%")),this.stickersSuggest&&this.stickersSuggest.hide(),this.field.textVal(a,!0),this.field.blur(),this.overflowEvent.fire(_WA101.tr("msgTooLongAndCut"))):this.stickersSuggest&&this.stickersSuggest.onInput(a,this.el,this.dialogSn),"\n"!==a&&this.changeEvent.fire(a)}},{key:"_onSuggestsEvent",value:function(a,b,c){a?this.userSuggests.show({text:b,winEl:this.winEl,rect:c}):this.userSuggests.hide()}},{key:"_resetPttRecorder",value:function(){this.el&&(this.el.removeClass("im-chat__input_ptt-played"),this.el.removeClass("im-chat__input_ptt-was-played"),this.el.removeClass("im-chat__input_ptt-recording"),this.el.removeClass("im-chat__input_ptt-ready"),this.pttHistogram&&this.pttHistogram.clear()),_WA101.pttRecorder.stop(),this.resizeEvent.fire(),this.hidePttEvent.fire()}},{key:"_submitPtt",value:function(){if(this._readyToSubmitPtt=!1,_WA101.pttRecorder.recordedData){var a,b=_WA101.pttRecorder.recordedData,c=[];"quote"===this._activeMessageAction&&this._quotedData&&(a=this._quotedData.messages,_U87.Array.each(this._quotedData.messages,function(a){a.mentions&&(c=c.concat(a.mentions))})),this.sendPttEvent.fire([b.blob],{quotes:a,mentions:c,ptt:{duration:Math.ceil(b.duration)}}),a&&this.resetActiveTopMessage()}this._resetPttRecorder()}},{key:"_submit",value:function(a){if(this.stickersSuggest&&this.stickersSuggest.hide(),this.el.hasClass("im-chat__input_ptt-recording"))_WA101.pttRecorder.isStarted()?(this._readyToSubmitPtt=!0,this.el.addClass("im-chat__input_ptt-loading"),_WA101.pttRecorder.stop()):_WA101.pttRecorder.hasRecord()&&this._submitPtt();else{var b=this.field.textVal(),c={};if(b.match(/\S/)||"quote"===this._activeMessageAction){var d=this._quotedData&&JSON.stringify(this._quotedData.messages)||"";if(encodeURIComponent(b+d).length>POST_MAX_LENGTH)return void this.overflowEvent.fire();var e=[];if(b=b.replace(REGEX_MENTION_HOLDER,function(a,b){return e.push(b),"@["+b+"]"}.bind(this)),"quote"===this._activeMessageAction&&this._quotedData)c.quotes=this._quotedData.messages,_U87.Array.each(this._quotedData.messages,function(a){a.mentions&&(e=e.concat(a.mentions))});else if("edit"===this._activeMessageAction&&this._editedData){if(b===this._editedData.message.text)return this.field.val("",!0),this.focusField(!1,!0),void this.resetActiveTopMessage();c.editedMessage=this._editedData.message}c.mentions=_U87.Array.unique(e),this.submitEvent.fire(b,c)?(this.field.val("",!0),this.focusField(!1,!0),this.resetActiveTopMessage()):a&&a.stopEvent()}}}},{key:"hasPttRecord",value:function(){return this.el&&this.el.hasClass("im-chat__input_ptt-recording")}},{key:"setVal",value:function(a,b,c){c&&c.length&&_U87.Array.each(c,function(b){var c=_WA101.CLD.getFriendlyName(b)||b,d=_TD33.parseSafe("dialogMentionHolder",{sn:b,nick:_WA101.Emoji.parse(_U87.String.htmlEntity(c))},{safeKeys:["nick"]});a=a.replace(new RegExp("\\@\\["+b.replace(/\./g,"\\.")+"\\]","g"),d)}),a=a.replace(/(\n|\r\n)/g,"<br />"),this.field.val(a,!0),b&&this.focusField(!0)}},{key:"getVal",value:function(){return this.field.val()}},{key:"blurField",value:function(){this.field.blur()}},{key:"onResize",value:function(){this.el&&this.el.hasClass("im-chat__input_ptt-ready")&&_WA101.pttRecorder.analyserData&&(_WA101.pttRecorder.resetAnalyserCustomBars(),this.el.hasClass("im-chat__input_ptt-played")||this._onPttPlayback(_WA101.pttRecorder.audio&&_WA101.pttRecorder.audio.currentTime||0,_WA101.pttRecorder.analyserData.duration,!0))}},{key:"getIOSKeyboardSize",value:function(){return IOSKeyboardSize}},{key:"resetIOSKeyboardSize",value:function(){IOSKeyboardSize=!1}},{key:"calculateIOSKeyboardSize",value:function(){IOSKeyboardSize=IOSKeyboardSize||document.body.scrollTop-SHIFT_FOR_IOS_SAFARI_KEYBOARD,!IOSKeyboardSize&&bodyScrollFixed&&(IOSKeyboardSize=bodyScrollFixed,bodyScrollFixed=!1)}},{key:"_fixBodyScroll",value:function(){bodyScrollFixed=!1,IOSKeyboardSize||this.picturesMenu&&this.picturesMenu.hide(),IOSKeyboardSize&&_WA101.setTimeout(function(){bodyScrollFixed=document.body.scrollTop,document.body.scrollTop=0},500)}},{key:"focusField",value:function(a,b){this.field.el&&(b=needDetectKeyboardOnIOS||b,needDetectKeyboardOnIOS&&!IOSKeyboardSize&&this.inputForFocus?(this._onHelperInputFocus=function(){this.calculateIOSKeyboardSize(),this.field.focus(a),this.inputForFocus.hide()},this.inputForFocus.show(),this.inputForFocus.dom.focus()):b?this.field.focus(a):this.field.delayedFocus(a))}},{key:"setMenuSize",value:function(a){this.picturesMenu&&this.picturesMenu.el.setStyle("height",a+"px")}},{key:"getMenuSize",value:function(){return this.picturesMenu?this.picturesMenu.el.dom.offsetHeight:0}},{key:"getInputFieldHeight",value:function(){return this.field&&this.field.el?this.field.el.parent().dom.offsetHeight:0}},{key:"setInputFieldMaxHeight",value:function(a){MIN_INPUT_HEIGHT>a&&(a=MIN_INPUT_HEIGHT),a>DEFAULT_INPUT_MAX_HEIGHT&&(a=DEFAULT_INPUT_MAX_HEIGHT),this.field&&this.field.el&&this.field.el.parent().setStyle("maxHeight",a+"px"),this.field.scrollBar.sync()}},{key:"toggleMenu",value:function(a){this.picturesMenu&&this.picturesMenu.toggle(a)}},{key:"addMention",value:function(a,b){var c=this,d=_TD33.parseSafe("dialogMentionHolder",{sn:a,nick:b});_WA101.setTimeout(function(){c.focusField(!0,!0),c._selectTextBeforeCaret();var a=_U87.DomHelper.elementFromHtml(d);_U87.Selection.insertNodeAtCaret(a,!0),c.field.onInput(),c.field._saveCaretPosition(),c.field.checkScroll()},1)}},{key:"_selectTextBeforeCaret",value:function(){var a,b,c,d=window.getSelection();if(0===d.rangeCount)return!1;if(a=d.getRangeAt(0),b=a.startContainer,c=a.startOffset,a.collapsed&&3===b.nodeType){var e=b.nodeValue,f=e.substr(0,c),g=f.lastIndexOf("@");g>-1&&(a.setStart(b,g),a.setEnd(b,c),d.removeAllRanges(),d.addRange(a))}}},{key:"addEmoji",value:function(a,b){_WA101.setTimeout(function(){needDetectKeyboardOnIOS&&(ignoreFocusEvent=!0,this.picturesMenu&&this.picturesMenu.hide()),this.field.focus(!0);var c=_WA101.Emoji.codeToHTML(a),d=_WA101.util.DomHelper.elementFromHtml(c);d.setAttribute("data-immutable",!0),this.stickersSuggest&&this.stickersSuggest.fromPicturesMenu(a,_DomUtil50.get(b)),_U87.Selection.insertNodeAtCaret(d),this.field.onInput(),this.field._saveCaretPosition(),this.field.checkScroll(),needDetectKeyboardOnIOS&&(this.field.blur(),this.picturesMenu&&this.picturesMenu.show()),ignoreFocusEvent=!1},1,this)}},{key:"restoreState",value:function(){_WA101.showcasePage.selectedPack?(this.openStickerMenu(_WA101.showcasePage.selectedPack,!0),_WA101.showcasePage.selectedPack=null):this.lastPicturesState&&(delete this.lastPicturesState,this.picturesMenu.show())}},{key:"openShowcase",value:function(a,b){this.lastPicturesState=this.picturesMenu.isVisible();var c={
id:a,idType:b||"packId"};_WA101.splitView?_WA101.Pane.openPageBox(_WA101.showcasePage,c):App.load("showcase",c)}},{key:"openStickerMenu",value:function(a,b){this.picturesMenu&&this.picturesMenu.switchSetMenu(a||0,b)}},{key:"onThemeSwitch",value:function(){this.pttHistogram&&_WA101.pttRecorder.analyserData&&this.el.hasClass("im-chat__input_ptt-ready")&&!this.el.hasClass("im-chat__input_ptt-played")&&this.pttHistogram.redraw()}},{key:"getDataToSave",value:function(){return{action:this._activeMessageAction,quote:this._quotedData,edit:this._editedData,val:this.getVal()}}},{key:"setSavedData",value:function(a,b){a&&(this._activeMessageAction=a.action||"",this._quotedData=a.quote||null,this._editedData=a.edit||null,this._restoreTopMessageAndVal(a.val,b))}},{key:"_restoreTopMessageAndVal",value:function(a,b){var c=[];"quote"===this._activeMessageAction&&this._quotedData?(this._renderTopMessages(this._quotedData.messages,this._quotedData.mentions||[]),a=this._quotedData.val||a):"edit"===this._activeMessageAction&&this._editedData&&(c=this._editedData.mentions||[],this._renderTopMessages([this._editedData.message],c),a=this._editedData.val||a),this.setVal(a||"",!b,c)}},{key:"setEditMessage",value:function(a,b){"quote"===this._activeMessageAction&&this._quotedData&&(this._quotedData.val=this.getVal()),this._activeMessageAction="edit";var c=_WA101.Emoji.parse(_U87.String.htmlEntity(b)),d=a.mentions||[];this._editedData={val:c,message:{msgId:a.arch_id,parts:a.parts,text:b,isEditing:!0,friendly:_WA101.tr("dialog.messageEditing")},mentions:d},this._renderTopMessages([this._editedData.message],d),this.setVal(c,!0,d)}},{key:"removeTopMessages",value:function(){this.topMessagesScrollBar.destroy(),this.topMessagesEl.remove(),this.topMessagesScrollBar=this.topMessagesEl=null,this.el.removeClass("im-chat__input_quote"),this.el.removeClass("im-chat__input_edit"),_WA101.hotKeyManager.un("esc",{handler:this.resetActiveTopMessage,scope:this},this.hotKeyLayerConfig.name),this.topMessageToggleEvent.fire()}},{key:"resetTopMessages",value:function(a){this.topMessagesEl&&(a?a===this._activeMessageAction&&(this.removeTopMessages(),"quote"===a?(this._quotedData=null,this._editedData?(this._activeMessageAction="edit",this._restoreTopMessageAndVal()):this._activeMessageAction="",this._checkSendAction(this.field.isEmpty)):"edit"===a&&(this._editedData=null,this._quotedData?(this._activeMessageAction="quote",this._restoreTopMessageAndVal()):(this._activeMessageAction="",this.setVal(""))),this.resizeEvent.fire()):(this.removeTopMessages(),this._editedData=null,this._quotedData=null,this._activeMessageAction=""))}},{key:"resetActiveTopMessage",value:function(){this.resetTopMessages(this._activeMessageAction)}},{key:"setQuotedMessage",value:function(a,b){if(a&&a.arch_id){"edit"===this._activeMessageAction&&this._editedData&&(this._editedData.val=this.getVal(),this.setVal(""));var c,d=a.parts&&a.parts.slice(-1)||[],e=d[d.length-1],f="readonly"===(_WA101.chatController.getCachedChatInfo(a.sn)||{}).defaultRole;!e||!e.mediaType||"quote"!==e.mediaType&&"forward"!==e.mediaType?(c={mediaType:"quote",sn:f?a.sn:a.sender||a.from,friendly:b||a.senderFriendly,time:a.date,msgId:a.arch_id},a.parse&&(c.parse=a.parse),a.mentions&&(c.mentions=a.mentions),e?(a={sticker:e.stickerId,text:e.text,contact:e.contact,captionedContent:e.captionedContent},d.splice(d.length-1,1,c)):d=[c],a.sticker?c.stickerId=a.sticker:(c.text=a.text,a.contact&&(c.contact=a.contact),a.poll&&(c.poll=a.poll),a.captionedContent&&(c.captionedContent=a.captionedContent))):e&&(d=a.parts.slice(0));var g=this._quotedData&&this._quotedData.messages||[];if(_U87.Array.each(g,function(a){var b=_U87.Array.indexOfBy(d,function(b){return b.msgId===a.msgId});d[b]&&d.splice(b,1)}),d.length){g=g.concat(d);var h=c&&c.mentions||a.mentions||[];this._activeMessageAction="quote",this._quotedData={messages:g,val:this.getVal(),mentions:h},this._renderTopMessages(g,h),this.focusField(!1),this._checkSendAction(!1)}}}},{key:"_renderTopMessages",value:function(a,b){this.topMessagesEl&&this.removeTopMessages();var c=_U87.Array.transform(a,function(a){var c=(a.text||"").replace(/(\n|\r\n)/g," "),d=!1;if(a.contact)c=_WA101.snippet.getContactTextSafeHtml();else if(a.poll)c=_WA101.tr("polls.poll");else if(a.stickerId)c=_WA101.tr("sticker.sticker");else{!c&&a.captionedContent&&(c=" ".concat(a.captionedContent.url," ").concat(a.captionedContent.caption||""));var e=_WA101.MessageFormatter.replaceUrlsInText(c,function(a){if(_WA101.snippet.resolveLinkAsContact(a))return _WA101.snippet.getContactTextSafeHtml();var b=_WA101.fileTools.resolveLinkAsFileText(a);if(b)return b;var c=_WA101.snippet.getContentType(a);return c.match(/image|gif/)?_WA101.tr("cl.photo"):a});c=_WA101.fileTools.resolveLinkAsFileText(c)||_WA101.snippet.resolveLinkAsContactText(c),c||(c=e.text,d=!0)}return b&&_U87.Array.each(b,function(a){var b=_WA101.CLD.getFriendlyName(a)||a;c=c.replace(new RegExp("\\@\\["+a.replace(/\./g,"\\.")+"\\]","g"),b)}),c=_WA101.MessageFormatter.buildPlainHtmlMessage(c.substring(0,400),!1,!d),_TD33.parseSafe("dialogTopInputMessage",[a.isEditing?"":_WA101.Ava.make(a.sn,a.friendly,16),_WA101.Emoji.parse(_U87.String.htmlEntity(a.friendly||a.sn)),c,a.msgId,"imButton im-top-message "+(a.isEditing?"im-edited-message":"im-quoted-message")],{safeKeys:["0","1","2"]})});this.topMessagesEl=this.el.createChild({cls:"im-top-messages",html:'<div class="im-top-messages__wrap">'+c.join("")+'</div><div class="im-ui-button im-top-messages__close"><span></span></div>'},!0),this.el.addClass("im-chat__input_"+this._activeMessageAction),this.topMessagesScrollBar=new _UI54.ScrollBar({source:this.topMessagesEl.first()}),this.topMessagesScrollBar.sync(),this.resizeEvent.fire(),_WA101.hotKeyManager.on("esc",{handler:this.resetActiveTopMessage,scope:this},this.hotKeyLayerConfig.name),this.topMessageToggleEvent.fire(this._activeMessageAction)}}]),a}();_WA101.DialogInput=DialogInput;var _WA102=WebIM,_U88=_WA102.util,messageInMap=function(a,b){return b[a.mid]||b[a.message_id]},getMessageObj=function(a){for(;a&&!a.message;)a=a.nextObj;return a},getMessageFromObj=function(a){return a=getMessageObj(a),a&&a.message},getReallyFirst=function(a){for(;a.prevObj;)a=a.prevObj;return a},getPrevMessageObj=function(a){for(a=a.prevObj;a&&!a.message;)a=a.prevObj;return a},getVisibleObj=function(a,b){var c,d=a.getAttribute("data-arch-id")||a.getAttribute("data-message-id");if(d)c=b[d];else{var e=a.getAttribute("data-next-id");if(e)for(c=b[e]&&b[e].prevObj;c&&c.node!==a;)c=c.prevObj;else{var f=a.getAttribute("data-prev-id");for(c=b[f]&&b[f].nextObj;c&&c.node!==a;)c=c.nextObj}}return c},HistoryRenderer=function(){function a(b){_classCallCheck2(this,a),this.maxSizeOfMessageBlock=b.maxSizeOfMessageBlock,this.spinnerTMPL=b.spinnerTMPL,this.stepDownCallback=b.stepDownCallback,this.stepUpCallback=b.stepUpCallback,this.afterStepCallback=b.afterStepCallback}return _createClass2(a,[{key:"onBind",value:function(a){this.scrolledCont=a.scrolledCont,this.messagesBlock=a.messagesBlock,this.wrapEl=a.wrapEl,this._makeHistorySpinner(),this._resetMessageBlocks()}},{key:"onUnbind",value:function(){this._historySpinner.parentNode&&this._historySpinner.parentNode.removeChild(this._historySpinner),this._historySpinnerIsVisible=!1,this._historySpinner=this._renderedData=this.scrolledCont=this.messagesBlock=this.wrapEl=null}},{key:"setRenderedData",value:function(a){this._renderedData=a}},{key:"_updateMiddleScrolledView",value:function(){var a=this.scrolledCont.dom.offsetHeight*this.maxSizeOfMessageBlock,b=this._renderedData,c=b.firstVisible,d=b.lastVisible,e=b.messagesMap,f=b.lastMid,g=b.firstMid;if(d){if(d.nextObj&&this.messagesBlock.dom.offsetHeight<a){var h=d.nextObj;h=this._fillDownCont(this.messagesBlock,h,a),this._renderedData.lastVisible=h?h.prevObj:e[f]}var i=c.prevObj;this.messagesBlock.dom.offsetHeight<a&&(i=this._fillUpCont(this.messagesBlock,i,a)),this._renderedData.firstVisible=i?i.nextObj:getReallyFirst(e[g])}}},{key:"_updateBottomScrolledView",value:function(){var a=this.scrolledCont.dom.offsetHeight*this.maxSizeOfMessageBlock,b=this._renderedData,c=b.messagesMap,d=b.lastMid,e=this._renderedData,f=e.firstVisible,g=e.lastVisible,h=!0;if(g){var i=g.message||(getPrevMessageObj(g)||{}).message;if(i&&messageInMap(i,c)){var j=this.messagesBlock;if(g.nextObj){if(j.dom.offsetHeight<a){var k=g.nextObj;k=this._fillDownCont(j,k,a),g=this._renderedData.lastVisible=k?k.prevObj:c[d]}if(g.nextObj){var l=c[d];j.updateText(""),j.firstVisible=j.lastVisible=null,this._fillUpCont(j,l,a),this._renderedData.lastVisible=c[d],f=this._renderedData.firstVisible=j.firstVisible}}f.prevObj&&j.dom.offsetHeight<a&&(j.dom.offsetHeight<a&&this._fillUpCont(j,f.prevObj,a),this._renderedData.firstVisible=j.firstVisible),h=!1}}h&&this._redrawVisibleFromBottom()}},{key:"_resetMessageBlocks",value:function(){this.hideSpinnerElement(),this.messagesBlock.updateText(""),this.messagesBlock.firstVisible=this.messagesBlock.lastVisible=null}},{key:"_redrawVisibleFromMiddle",value:function(a){var b=this._renderedData,c=b.firstMid,d=b.lastMid,e=b.messagesMap,f=this.scrolledCont.dom.offsetHeight*this.maxSizeOfMessageBlock,g=e[a.mid]||e[a.message_id];if(this._resetMessageBlocks(),c){var h,i=this.messagesBlock,j=this._fillUpCont(i,g,f/2);g=g.nextObj,h=this._fillDownCont(i,g,f),this._renderedData.firstVisible=j?j.nextObj:getReallyFirst(e[c]),this._renderedData.lastVisible=h?h.prevObj:e[d]}}},{key:"_redrawVisibleFromBottom",value:function(){this._resetMessageBlocks();var a=this._renderedData,b=a.firstMid,c=a.lastMid,d=a.messagesMap;if(b){var e=this.scrolledCont.dom.offsetHeight*this.maxSizeOfMessageBlock,f=d[c];f=this._fillUpCont(this.messagesBlock,f,e),this._renderedData.firstVisible=f?f.nextObj:getReallyFirst(d[b]),this._renderedData.lastVisible=d[c]}}},{key:"_fixMaxHeightByMessageHeight",value:function(a,b){return a.offsetHeight>b-this.scrolledCont.dom.offsetHeight&&(this.maxSizeOfMessageBlock=a.offsetHeight/this.scrolledCont.dom.offsetHeight+1,b=this.scrolledCont.dom.offsetHeight*this.maxSizeOfMessageBlock),b}},{key:"_fillUpCont",value:function(a,b,c){var d=a.dom.offsetHeight;if(b&&c>d){var e=a.firstVisible;for(e||(a.appendChild(b.node),e=b,d=a.dom.offsetHeight,a.lastVisible||(a.lastVisible=b),b=b.prevObj);b&&c>d;)a.insertBefore(b.node,e.node),c=this._fixMaxHeightByMessageHeight(b.node,c),e=b,d=a.dom.offsetHeight,b=b.prevObj;a.firstVisible=e}return b}},{key:"_fillDownCont",value:function(a,b,c){var d=a.dom.offsetHeight;if(b&&c>d){var e=b;for(a.firstVisible||(a.firstVisible=b);b&&c>d;)a.appendChild(b.node),c=this._fixMaxHeightByMessageHeight(b.node,c),d=a.dom.offsetHeight,e=b,b=b.nextObj;a.lastVisible=e}return b}},{key:"showTopSpinner",value:function(){this._historySpinner&&(this.messagesBlock.insertBefore(this._historySpinner,this.messagesBlock.first()),this.wrapEl.setStyle("height",this.messagesBlock.dom.offsetHeight+"px"),this._historySpinnerIsVisible=!0)}},{key:"showBottomSpinner",value:function(){this._historySpinner&&(this.messagesBlock.appendChild(this._historySpinner),this.wrapEl.setStyle("height",this.messagesBlock.dom.offsetHeight+"px"),this._historySpinnerIsVisible=!0)}},{key:"_makeHistorySpinner",value:function(){this._historySpinner=_U88.DomHelper.elementFromHtml('<div class="im-message__info"><div class="im-message__spinner">'+this.spinnerTMPL+"</div>")}},{key:"hideSpinnerElement",value:function(){this._historySpinnerIsVisible&&this._historySpinner&&(this._historySpinner.parentNode&&this._historySpinner.parentNode.removeChild(this._historySpinner),this.wrapEl.setStyle("height",this.messagesBlock.dom.offsetHeight+"px"),this._historySpinnerIsVisible=!1)}},{key:"fixVisibleOfBlockAfterDomUpdate",value:function(){var a=this._renderedData.messagesMap,b=this.messagesBlock,c=b.dom.firstChild;this._historySpinner&&c===this._historySpinner&&(c=this._historySpinner.nextElementSibling);var d=c&&getVisibleObj(c,a);c=b.dom.lastChild,this._historySpinner&&c===this._historySpinner&&(c=this._historySpinner.previousElementSibling);var e=c&&getVisibleObj(c,a);d&&e?(b.firstVisible=this._renderedData.firstVisible=d,b.lastVisible=this._renderedData.lastVisible=e):(this.hideSpinnerElement(),b.updateText(""),b.firstVisible=b.lastVisible=null,this._renderedData.firstVisible=this._renderedData.lastVisible=null)}},{key:"getMiddleMessageId",value:function(){var a=this.scrolledCont.dom.scrollTop+this.scrolledCont.dom.offsetHeight/2-this.messagesBlock.dom.offsetTop,b=this.messagesBlock;if(b){var c=b.dom.querySelectorAll(".imMessage"),d=_U88.Array.findBy(c,function(b){return b.offsetTop+b.offsetHeight>=a});return d&&d.getAttribute("data-arch-id")}var e=getMessageFromObj(this._renderedData.firstVisible);return e&&(e.mid||e.message_id)}},{key:"update",value:function(a){a?this._updateBottomScrolledView():this._updateMiddleScrolledView()}},{key:"redraw",value:function(a){var b=a.middleMessage,c=a.bottomScrolled,d=this._renderedData.messagesMap;if(c)this._redrawVisibleFromBottom();else{if(!b||!messageInMap(b,d)){var e=Object.keys(d).sort();b=e.length&&d[e[Math.floor(e.length/2)]].message}this._redrawVisibleFromMiddle(b)}}},{key:"fixAfterViewUpdate",value:function(){this.messagesBlock.setStyle("bottom",0),this.wrapEl.setStyle("height",this.messagesBlock.dom.offsetHeight+"px")}},{key:"stepUp",value:function(){var a,b=this._renderedData,c=b.firstMid,d=b.firstVisible,e=b.lastVisible,f=b.messagesMap,g=b.firstInHistoryPartPrepared;if(d&&d.prevObj){var h=this.messagesBlock,i=this.scrolledCont.dom.offsetHeight*this.maxSizeOfMessageBlock,j=d.node.offsetTop-this.scrolledCont.dom.scrollTop;h.setStyle({bottom:"auto",top:0});for(var k=e,l=i/2;k&&h.dom.offsetHeight>l&&d!==k;)k.node.parentNode.removeChild(k.node),k=k.prevObj;h.lastVisible=this._renderedData.lastVisible=k,h.setStyle({top:"auto",bottom:this.scrolledCont.dom.scrollHeight-h.dom.offsetHeight+"px"});var m=this._fillUpCont(h,d.prevObj,i);this._renderedData.firstVisible=m?m.nextObj:getReallyFirst(f[c]),h.dom.offsetHeight<i&&!g?a=this.stepUpCallback():(this.fixAfterViewUpdate(),a=this.afterStepCallback(d.node.offsetTop-j))}else g||(a=this.stepUpCallback());return a||Promise.resolve()}},{key:"stepDown",value:function(){var a,b=this._renderedData,c=b.lastMid,d=b.firstVisible,e=b.lastVisible,f=b.messagesMap,g=b.lastInHistoryPartPrepared;if(e&&e.nextObj){for(var h=this.messagesBlock,i=this.scrolledCont.dom.offsetHeight*this.maxSizeOfMessageBlock,j=e.node.offsetTop-this.scrolledCont.dom.scrollTop,k=this.scrolledCont.dom.scrollHeight,l=d,m=i/2;l&&h.dom.offsetHeight>m&&e!==l;)l.node.parentNode.removeChild(l.node),l=l.nextObj;h.firstVisible=this._renderedData.firstVisible=l,h.setStyle({top:h.dom.offsetTop+"px",bottom:"auto"});var n=this._fillDownCont(h,e.nextObj,i);this._renderedData.lastVisible=n?n.prevObj:f[c],h.dom.offsetHeight<i&&!g?(h.setStyle({bottom:k-(h.dom.offsetTop+h.dom.offsetHeight)+"px",top:"auto"}),a=this.stepDownCallback()):(this.messagesBlock.setStyle({top:"auto",bottom:0}),this.wrapEl.setStyle("height",this.messagesBlock.dom.offsetHeight+"px"),a=this.afterStepCallback(e.node.offsetTop-j))}else g||(a=this.stepDownCallback());return a||Promise.resolve()}}]),a}();_WA102.HistoryRenderer=HistoryRenderer;var _WA103=WebIM,_U89=_WA103.util,_guid=0,removeObjNode=function(a){a.node&&a.node.parentNode&&a.node.parentNode.removeChild(a.node)},_messageInMap=function(a,b){return b[a.mid]||b[a.message_id]},_getMessageObj=function(a){for(;a&&!a.message;)a=a.nextObj;return a},messageIsNotHidden=function(a){return!a.hidden&&(a.text||a.sticker||a.dynamic||a.parts)},checkObjectType=function(a,b){return a&&a.type===b},_getMessageFromObj=function(a){return a=_getMessageObj(a),a&&a.message},_getReallyFirst=function(a){for(;a.prevObj;)a=a.prevObj;return a},_getPrevMessageObj=function(a){for(a=a.prevObj;a&&!a.message;)a=a.prevObj;return a},getNextMessageObj=function(a){for(a=a.nextObj;a&&!a.message;)a=a.nextObj;return a},getNextNotHiddenMessage=function(a,b){for(var c=b+1;a[c]&&!messageIsNotHidden(a[c]);)c++;return a[c]},getEndIndex=function(a,b,c){for(var d=0,e=b.length-1;e>a&&c>d;)messageIsNotHidden(b[a])&&d++,a++;return a},getStartIndex=function(a,b,c){for(var d=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,e=d;a&&c>e;)messageIsNotHidden(b[a])&&e++,a--;return a},HistoryPreparer=function(){function a(b){_classCallCheck2(this,a),this.maxPreparedMessages=b.maxPreparedMessages,this.onMakeHTML=b.onMakeHTML,this.beforeUpdate=b.beforeUpdate}return _createClass2(a,[{key:"onBind",value:function(a){this.scrolledCont=a.scrolledCont}},{key:"onUnbind",value:function(){this._cacheLastRead=this.dialogSn=this._renderedData=this.scrolledCont=null}},{key:"makeRenderedData",value:function(a,b,c){this._renderedData||(this._renderedData={}),this.isChat=b,this.dialogSn=a.mail;var d=(a.cast[this.dialogSn]||{}).nick;return this.avatarHtml=_WA103.Ava.make(this.dialogSn,d,32,null,{official:a.cast[this.dialogSn].official}),this._cacheLastRead=c,this._renderedData}},{key:"_fixMessageId",value:function(a){var b=this._renderedData.messagesMap,c=a.message;return c&&c.mid&&c.message_id&&b[c.message_id]&&(delete b[c.message_id],b[c.mid]=a,this._renderedData.lastMid===c.message_id&&(this._renderedData.lastMid=c.mid),this._renderedData.firstMid===c.message_id&&(this._renderedData.firstMid=c.mid),this._renderedData.lastPreparedMid===c.message_id&&(this._renderedData.lastPreparedMid=c.mid),this._renderedData.firstPreparedMid===c.message_id&&(this._renderedData.firstPreparedMid=c.mid)),c&&(c.mid||c.message_id)}},{key:"_removeNodeFromRenderChain",value:function(a){if(removeObjNode(a),a.prevMessage&&(a.prevMessage.nextMessage=a.nextMessage,a.nextMessage||(this._renderedData.lastPreparedMid=a.prevMessage.message.mid||a.prevMessage.message.message_id)),a.nextMessage?(a.nextMessage.prevMessage=a.prevMessage,a.prevMessage||(this._renderedData.firstPreparedMid=a.nextMessage.message.mid||a.nextMessage.message.message_id)):a.prevMessage||(this._renderedData.firstPreparedMid=this._renderedData.lastPreparedMid=null),a.prevObj&&!a.prevObj.message&&(!a.nextObj||a.nextObj&&!a.nextObj.message)){var b=a.prevObj;removeObjNode(b),delete a.prevObj,b.prevObj&&(b.prevObj.nextObj=a,a.prevObj=b.prevObj)}a.prevObj&&(a.prevObj.nextObj=a.nextObj,a.nextObj||(this._renderedData.lastMid=a.prevObj.message.mid||a.prevObj.message.message_id)),a.nextObj?(a.nextObj.prevObj=a.prevObj,a.prevObj||(this._renderedData.firstMid=a.nextObj.message.mid||a.nextObj.message.message_id)):a.prevObj||(this._renderedData.firstMid=this._renderedData.lastMid=null)}},{key:"applyRemovePatches",value:function(a){var b=this,c=this._renderedData.messagesMap;Object.keys(a).forEach(function(d){var e=a[d],f=e.mid,g=e.message_id,h=c[f]||c[g];h&&(c[f]?delete c[f]:delete c[g],b._removeNodeFromRenderChain(h))})}},{key:"_updateMessage",value:function(a,b,c,d,e,f){var g=this._renderedData,h=g.firstMid,i=g.messagesMap;this._fixMessageId(a);var j=c&&{isGroup:c.isGroup,lastDate:c.lastDate,messageObj:c},k=this._renderMessage(b,e,j||{},d,f);if(a.prevMessage=k.messageObj.prevMessage,a.prevMessage&&(a.prevMessage.nextMessage=a),a.isGroup=k.isGroup,a.lastDate=k.lastDate,a.message=b,k.isHidden)a.isHidden||(this._removeNodeFromRenderChain(a),a.isHidden=!0);else{var l=document.createElement("div");l.innerHTML=k.html.join("");var m=l.firstChild;if(a.isHidden){var n=c?getNextMessageObj(c):i[h];n?(checkObjectType(n.prevObj,"date")&&n.lastDate!==k.lastDate&&(n=n.prevObj),n.prevObj?(n.prevObj.nextObj=a,a.prevObj=n.prevObj):this._renderedData.firstMid=b.mid,a.nextObj=n,n.prevObj=a):c?(c.nextObj=a,a.prevObj=c,this._renderedData.lastMid=b.mid):this._renderedData.firstMid=this._renderedData.lastMid=b.mid,delete a.isHidden,a.nextObj&&a.nextObj.node&&a.nextObj.node.offsetHeight&&("date"===k.messages[0].type&&(k.messages.shift(),a.nextObj.node.parentNode.insertBefore(m,a.nextObj.node),m=l.firstChild),k.messages.shift(),a.nextObj.node.parentNode.insertBefore(m,a.nextObj.node))}else{if("date"===k.messages[0].type){if(l.removeChild(m),k.messages.shift(),!a.prevObj||"date"!==a.prevObj.type){var o={node:m,prevObj:a.prevObj,nextObj:a,type:"date"};o.prevObj&&(o.prevObj.nextObj=o),a.prevObj=o,a.node.parentNode&&a.node.parentNode.insertBefore(m,a.node)}}else if(checkObjectType(a.prevObj,"date")){var p=a.prevObj;p.node.parentNode&&p.node.parentNode.removeChild(p.node),p.prevObj&&(p.prevObj.nextObj=a),a.prevObj=p.prevObj}var q=a.node;m=l.firstChild,q.parentNode?q.parentNode.replaceChild(m,q):l.removeChild(m)}a.node=m,k.messages.shift()}}},{key:"_addHtmlToPrepared",value:function(a,b,c){var d,e=this,f=document.createElement("div"),g=null,h=null;f.innerHTML=a.join(""),this.onMakeHTML(f);var i={},j=this._renderedData&&this._renderedData.messagesMap||{},k=_U89.Array.transform(f.childNodes,function(a,c){var f=b[c];return f.node=a,f.prevObj=d,f.uid=_guid++,d&&(d.nextObj=f),d=f,"message"===b[c].type?(h=f.message.mid||f.message.message_id,g||(g=h),j[h]=f,i[h]=f):"lastRead"===f.type&&e._cacheLastRead&&(e._cacheLastRead.obj=f),f});return c.forEach(function(a){j[a.message.mid]=a}),{newObjects:i,messagesMap:j,firstMid:g,lastMid:h,messages:k}}},{key:"_makeDataForMessageRender",value:function(a){var b=new Date,c={},d=a.positions||{},e=!1,f=null;if(Object.keys(d).forEach(function(a){c[a]=_U89.Array.clone(d[a]),(!f||a>f)&&(f=a)}),this.isChat){var g=_WA103.chatController.getCachedChatInfo(a.mail);e=g&&"readonly"!==g.defaultRole}return{nowDate:b,lastSeenMsg:f,cast:a.cast,botAvailable:e,fromMidnight:_U89.Date.getTimeFromMidnight(b),heads:c,theirsLastRead:a.theirsLastRead,oursLastRead:this._cacheLastRead&&this._cacheLastRead.mid}}},{key:"_checkGrouping",value:function(a,b,c,d){if(a.dynamic||a.event||b.dynamic||b.event||a.from!==b.from||a.sender!==b.sender||d&&d.length)return!1;if(a.from!==_WA103.ACTIVE_MAIL&&this.isChat){var e=c[a.sender]&&c[a.sender].nick||a.sender,f=c[b.sender]&&c[b.sender].nick||b.sender;if(e!==f)return!1}var g=a.date===_WA103.TIME_INFINITY?a.localDate:a.date,h=b.date===_WA103.TIME_INFINITY?b.localDate:b.date;return 600>h-g}},{key:"_renderMessage",value:function(a,b,c,d,e){var f,g,h=this,i=b.cast,j=b.nowDate,k=b.fromMidnight,l=b.heads,m=b.botAvailable,n=b.theirsLastRead,o=b.oursLastRead,p=b.lastSeenMsg,q=c.isGroup,r=c.lastDate,s=c.messageObj,t=o&&a.mid===o,u=[],v=[],w=!0;if(messageIsNotHidden(a)){var x=_U89.Date.formatMessageDate(a.date===_WA103.TIME_INFINITY?a.localDate:a.date,j,k);r!==x&&(r=x,v.push({type:"date"}),u.push(_WA103.MessageFormatter.renderDate(a,r)));var y=l[a.mid];!this.isChat&&n&&a.mid===n&&(y=[this.dialogSn]),p&&a.arch_id<=p&&(a.state=5),d&&!t&&this._checkGrouping(a,d,i)?(f=q?"group":"group__start",q=!0):(f=q?"group__last":!1,q=!1),g={type:"message",message:a,isGroup:q,lastDate:r},_U89.Mnt.wrapTryCatch(function(){u.push(_WA103.MessageFormatter.renderMessage(h.dialogSn,h.avatarHtml,a,i,0,f,e,y,{botAvailable:!!m})),v.push(g),w=!1},this)}else g={type:"hidden",message:a,isHidden:!0,isGroup:q,lastDate:r};return t&&this._cacheLastRead&&!e&&(v.push({type:"lastRead"}),u.push('<span id="'+this._cacheLastRead.domId+'" data-prev-id="'+(a.mid||a.message_id)+'" class="im-message__info im-message__unread" data-unread="1">'+_WA103.tr("dialog.newMessages")+"</span>"),this._cacheLastRead.loaded=!0),s&&(s.nextMessage=g,g.prevMessage=s),{html:u,messages:v,isGroup:q,lastDate:r,message:a,messageObj:g,messageIsLastRead:t,isHidden:w}}},{key:"getHistoryPart",value:function(a){var b=a.history;if(b&&b[0]instanceof Array){var c=a.historyCurrentPack;b[c]||(c=0),this._renderedData.historyNotFirst=c>0,this._renderedData.historyNotLast=c<b.length-1,b=b[c]}return b||(b=[]),b}},{key:"rebuild",value:function(a,b,c,d){+new Date;this.beforeUpdate();var e=2*Math.ceil(this.maxPreparedMessages*this.scrolledCont.dom.offsetHeight/2),f=this._renderedData.historyPart,g=this.getHistoryPart(a);this._renderedData.historyPart=g,this._renderedData.historyCurrentPack=a.historyCurrentPack,f!==g&&(this._renderedData.endInd=0),this._renderedData.dialog=a;var h=d?this._renderedData.messagesMap:{};this._renderedData.messagesMap={};var i=this._renderedData.endInd;if(c>-1)i=getEndIndex(c,g,e/2)+1;else if(b){var j=_U89.Array.indexOfBy(g,function(a){return a.mid===b});j>-1&&(c=j,i=getEndIndex(c,g,e/2)+1)}i=i?Math.min(g.length,Math.max(i,e)):g.length;for(var k,l,m,n,o=i&&getStartIndex(i-1,g,e),p=this._makeDataForMessageRender(a),q=g.length-1,r=[],s={},t=[],u=[],v=o;i>v;v++)n=g[v],m=getNextNotHiddenMessage(g,v),s=this._renderMessage(n,p,s,m,!m||v===q),k||(k=n.mid||n.message_id),l=n.mid||n.message_id,t.push.apply(t,_toConsumableArray2(s.html)),r.push.apply(r,_toConsumableArray2(s.messages)),s.isHidden&&u.push(s.messageObj);var w=this._addHtmlToPrepared(t,r,u,h);this._renderedData.messagesMap=w.messagesMap,this._renderedData.firstMid=w.firstMid,this._renderedData.lastMid=w.lastMid,this._renderedData.firstPreparedMid=k,this._renderedData.lastPreparedMid=l,this._renderedData.startInd=o,this._renderedData.endInd=i,this._renderedData.firstInHistoryPartPrepared=0===o,this._renderedData.lastInHistoryPartPrepared=i===g.length,this._renderedData.lastSeen=p.theirsLastRead}},{key:"update",value:function(a,b,c,d){var e=this,f=2*Math.ceil(this.maxPreparedMessages*this.scrolledCont.dom.offsetHeight/2);a=this._renderedData.dialog=a||this._renderedData.dialog;var g=this._renderedData,h=g.messagesMap,i=g.historyPart,j=g.lastSeen,k=this._renderedData,l=k.firstMid,m=k.lastMid,n=k.lastVisible,o=k.firstVisible;if(!l||!m)return this.rebuild(a,b),!0;var p=this._makeDataForMessageRender(a);p.theirsLastRead&&p.theirsLastRead!==j&&(d||(d={}),d[p.theirsLastRead]=!0,d[j]=!0,this._renderedData.lastSeen=p.theirsLastRead);var q,r={},s={},t=_getMessageObj(o),u=_getMessageObj(n),v=!1,w=!1,x=[],y=[],z=[],A=0,B=0,C=i.length-1,D=[],E=-1,F=-1,G=-1;h[l].message.mid&&h[l].message.mid!==l&&(l=this._fixMessageId(h[l]));var H=this._renderedData.firstPreparedMid;h[H].message.mid&&h[H].message.mid!==H&&(H=this._fixMessageId(h[H]));var I=this._renderedData.lastPreparedMid;if(this.beforeUpdate(),i.some(function(a,b){if(w||a.mid===H){w=!0,0>E&&(E=b),B++,messageIsNotHidden(a)&&A++;var g=_messageInMap(a,h);0>F&&t===g&&(F=b),0>G&&u===g&&-1!==F&&(G=b);var j=A===f||b===C,k=getNextNotHiddenMessage(i,b),l=!k||j;if(v){var n,o;s=e._renderMessage(a,p,s,k,l),(n=x).push.apply(n,_toConsumableArray2(s.html)),(o=y).push.apply(o,_toConsumableArray2(s.messages)),I=a.mid||a.message_id,H||(H=I),s.isHidden&&z.push(s.messageObj)}else if(g){var J=q&&_messageInMap(q,h),K=a.mid||a.message_id;r[K]=g,c[K]?e._updateMessage(g,a,J,k,p,l):d[K]&&e._updateMessage(g,a,J,k,p,l),E===b||j||e.onMakeHTML(g.node),(a.mid===m||a.message_id===m)&&(v=!0,y=[],x=[],z=[],s=_messageInMap(a,h)||{},s={lastDate:s.lastDate,isGroup:s.isGroup,messageObj:s})}else;if(j)return C=b,!0}else D.push(a);q=messageIsNotHidden(a)?a:q}),l=this._renderedData.firstMid,m=this._renderedData.lastMid,0>G)return 0>E||!r[l]||!r[m]?this.rebuild(a,b):(this._renderedData.messagesMap=r,this._renderedData.startInd=E,this._renderedData.endInd=E+Object.keys(r).length,this._renderedData.firstInHistoryPartPrepared=0===E,this._renderedData.lastInHistoryPartPrepared=this._renderedData.endInd===i.length),!0;if(x.length){var J=this._addHtmlToPrepared(x,y,z);this._updateMessage(h[m],h[m].message,h[m].prevMessage,h[J.firstMid].message,p,!1),this.onMakeHTML(h[m]&&h[m].node),m=this._renderedData.lastMid,h[m].nextObj=_getReallyFirst(h[J.firstMid]),h[m].nextObj.prevObj=h[m],m=this._renderedData.lastMid=J.lastMid,this._renderedData.lastPreparedMid=I}else this.onMakeHTML(h[m]&&h[m].node);var K=getStartIndex(E,i,f,A),L=E-K;if(L>0){var M=h[l].message;if(y=[],x=[],s={},z=[],H=null,D.slice(-L).forEach(function(a,b,c){var d,f;s=e._renderMessage(a,p,s,getNextNotHiddenMessage(c,b)||M,!1),(d=x).push.apply(d,_toConsumableArray2(s.html)),(f=y).push.apply(f,_toConsumableArray2(s.messages)),s.isHidden&&z.push(s.messageObj),H||(H=a.mid||a.message_id),B++,s.isHidden||A++}),this._updateMessage(h[l],M,s.messageObj,_getMessageFromObj(h[l].nextObj),p,!1),this.onMakeHTML(h[l]&&h[l].node),l=this._renderedData.firstMid,this._renderedData.firstPreparedMid=H,y.length){var N=this._addHtmlToPrepared(x,y,z),O=_getReallyFirst(h[l]);O.prevObj=h[N.lastMid],O.prevObj.nextObj=O,l=this._renderedData.firstMid=N.firstMid}else z.forEach(function(a){h[a.message.mid]=a})}else this.onMakeHTML(h[l]&&h[l].node);E=K;for(var P=h[m]&&h[m].nextObj;P;)h[P.mid]?delete h[P.mid]:delete h[P.message_id],P=P.nextObj;for(var Q=h[l]&&h[l].prevObj;Q;)h[Q.mid]?delete h[Q.mid]:delete h[Q.message_id],Q=Q.prevObj;this._renderedData.startInd=E,this._renderedData.endInd=E+B,this._renderedData.firstInHistoryPartPrepared=0===E,this._renderedData.lastInHistoryPartPrepared=this._renderedData.endInd===i.length}}]),a}();_WA103.HistoryPreparer=HistoryPreparer;var _WA104=WebIM,_U90=_WA104.util,_UI55=_WA104.ui,_DomUtil51=_WA104.DomUtil,GO_DOWN_BUTTON_MIN_CONDITION=32,UPDATE_FILE_LINKS_PERIOD=12e5,MAX_HOLDING_INTERVAL=5e3,MAX_SIZE_OF_MESSAGE_BLOCK=15,MIN_MESSAGE_HEIGHT=50,MAX_PREPARED_MESSAGES=.5*MAX_SIZE_OF_MESSAGE_BLOCK/MIN_MESSAGE_HEIGHT,getLastInputMessagesId=function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,c=a[a.length-1];if(c){var d=[];return b-=1,[].concat(c).reverse().some(function(a){var c=a.sender||a.from;return c===_WA104.ACTIVE_MAIL||a.event?!0:(d.push(a.mid),d.length>b?!0:void 0)}),d}},_messageInMap2=function(a,b){return b[a.mid]||b[a.message_id]},_getMessageObj2=function(a){for(;a&&!a.message;)a=a.nextObj;return a},isObjRendered=function(a){return a&&a.node&&a.node.offsetHeight},_checkObjectType=function(a,b){return a&&a.type===b},_getPrevMessageObj2=function(a){for(a=a.prevObj;a&&!a.message;)a=a.prevObj;return a},_getNextMessageObj=function(a){for(a=a.nextObj;a&&!a.message;)a=a.nextObj;return a},getMessageObjByCondition=function(a,b){if(a){for(var c=a;a&&!b(a);)a=_getPrevMessageObj2(a);if(!a)for(a=_getNextMessageObj(c);a&&!b(a);)a=_getNextMessageObj(a)}return a},DialogHistory=function(){function a(){_classCallCheck2(this,a),_U90.Mnt.countRB(55518705),this._timers=["_checkTimer","_renderTimer","_scrollFixTimer","_fileLinksUpdateTimer","_blinkingTimer","_dynamicObjectsUpdateTimer","_checkLastVisibleMessageTimer"],this.spinnerTMPL=_WA104.TD.getTMPL("CircleSpinner"),this._scrollUpTriesCounter=0,this._setScrollTriesCounter=0,this._scrollAutoSetValue=!1,this.sideScrolledEvent=new _U90.Event,this.jumpToMessageEvent=new _U90.Event,this.readNextMessageEvent=new _U90.Event,this.updateMediaEvent=new _U90.Event,this.smartReplyEvent=new _U90.Event,this.flowDate=new _WA104.DialogsFlowDate,this.flowAvatar=new _WA104.DialogsFlowAvatar,this.renderer=new _WA104.HistoryRenderer({maxSizeOfMessageBlock:MAX_SIZE_OF_MESSAGE_BLOCK,stepDownCallback:this.onStepDown.bind(this),stepUpCallback:this.onStepUp.bind(this),afterStepCallback:this.afterStep.bind(this),spinnerTMPL:this.spinnerTMPL}),this.preparer=new _WA104.HistoryPreparer({maxPreparedMessages:MAX_PREPARED_MESSAGES,onMakeHTML:this._saveDynamicObjects.bind(this),beforeUpdate:this._resetDynamicObject.bind(this)}),_WA104.snippet.loadEvent.on(this._onLoadSnippet.bind(this)),_WA104.Sticker.loadErrorEvent.on(this._onLoadStickers.bind(this)),_WA104.fileTools.loadEvent.on(this._onLoadFiles.bind(this)),_WA104.Polls.updatePollEvent.on(this._onLoadPoll.bind(this)),_WA104.bots.stateUpdateEvent.on(this._redrawBotButtons.bind(this))}return _createClass2(a,[{key:"renderBind",value:function(a){this.el&&this.renderUnbind(),this.winEl=a,this.el=this.winEl.getSelector(".im-chat__shadow").first(),this.scrolledCont=this.el.first(),this.wrapEl=this.scrolledCont.first(),this.messagesBlock=this.wrapEl.first(),this.messagesBlock.setStyle({bottom:0,top:"auto"}),this.renderer.onBind({scrolledCont:this.scrolledCont,wrapEl:this.wrapEl,messagesBlock:this.messagesBlock}),this.preparer.onBind({scrolledCont:this.scrolledCont}),this.goDownButton=this.el.createChild({cls:"btnGoDown im-chat__history-go-down",children:{tag:"span"}}).on("click",function(){this.jumpToEnd()},this),this.goMentionButton=this.el.createChild({
cls:"btnGoMention im-chat__history-go-mention",children:{tag:"span"}}).on("click",function(){var a=this._cacheMentions[0];a&&this.scrollUpToMessage(a)},this),this.flowDate.renderBind(this.el.createChild({cls:"im-messages__date im-messages__date_flow"}),this.messagesBlock,this.scrolledCont),this.flowAvatar.renderBind(this.el.createChild({cls:"im-messages__avatar_flow im-avatar-block"}),this.messagesBlock,this.scrolledCont),!_WA104.configurator.getOption("enable_smart_reply_text")&&!_WA104.configurator.getOption("enable_smart_reply_stickers")||_WA104.Feature.getModeParameter("disableSmartReply")||(this.smartReply=new _WA104.SmartReply({sn:this.dialogSn}),this.smartReply.render(this.el,a.getSelector(".imSmartReply")),this.smartReply.el.setStyle("height","1px"),this.smartReply.toggleEvent.on(this._onSmartReplyToggle,this),this.smartReply.itemClickEvent.on(this._onSmartReplyClick,this)),this._scrollUpTriesCounter=0,this._setScrollTriesCounter=0,this._scrollAutoSetValue=!1,this._needUpdateDynamicObjects={},this._middleRenderedMessage=null,this._cacheLastRead=null,this.el.on("mousedown",this._onHistoryMouseDown,this),_DomUtil51.getDoc().on("mouseup",this._onHistoryMouseUp,this),this.scrollBar=new _UI55.ScrollBar({source:this.scrolledCont}),this.scrolledCont.on("scroll",this._onScroll,this)}},{key:"renderUnbind",value:function(){this.el&&(this.el.un("mousedown",this._onHistoryMouseDown,this),_DomUtil51.getDoc().un("mouseup",this._onHistoryMouseUp,this),this.scrolledCont.un("scroll",this._onScroll,this),_U90.Array.each(this._timers,function(a){this[a]&&(clearTimeout(this[a]),this[a]=null)},this),this._stopSmartReplyAnimation(),this.renderer.onUnbind(),this.preparer.onUnbind(),this.scrollBar.destroy(),this._cacheLastRead=null,this._needUpdateDynamicObjects={},this.clearWaitScreen(),this.flowAvatar.el.remove(),this.flowDate.el.remove(),this.goDownButton.remove(),this.goMentionButton.remove(),this.flowDate.renderUnbind(),this.flowAvatar.renderUnbind(),this.smartReply&&(this.smartReply.toggleEvent.un(this._onSmartReplyToggle,this),this.smartReply.itemClickEvent.un(this._onSmartReplyClick,this),this.smartReply.destroy(),this.smartReply=null),this._renderedData=null,this.winEl=this.el=this.scrolledCont=this.wrapEl=this.messagesBlock=null)}},{key:"init",value:function(a,b){this.isChat=b,this.dialogSn=a,this.resetStickyPosition()}},{key:"_onHistoryMouseDown",value:function(){}},{key:"_onHistoryMouseUp",value:function(){}},{key:"showMasterSpinner",value:function(){this._blockHistoryScroll=!0,this._masterSpinnerEl&&this._masterSpinnerEl.remove(),this._masterSpinnerEl=this.el.createChild({cls:"im-waitscreen im-waitscreen_white",html:this.spinnerTMPL})}},{key:"hideMasterSpinner",value:function(){this._blockHistoryScroll=!1,this._masterSpinnerEl&&this._masterSpinnerEl.remove(),this._masterSpinnerEl=null}},{key:"showWaitScreen",value:function(a){return this.clearWaitScreen(),this._waitScreen=this.el.createChild({cls:"im-waitscreen "+(a?"im-waitscreen_white":""),html:this.spinnerTMPL}),this._waitScreen}},{key:"clearWaitScreen",value:function(){this._waitScreen&&(this._waitScreen.remove(),this._waitScreen=null,delete this._waitingMessage,this._renderedData&&this._renderedData.dialog&&delete this._renderedData.dialog.requestedHistoryPackFlag)}},{key:"updateGoDownButton",value:function(a){_WA104.boardMode||this.goDownButton.first().updateText(a?a>999?"1k":a:"")}},{key:"toggleGoDownButton",value:function(a){this.goDownButton.toggleClass("im-chat__history-go-down_visible",a)}},{key:"toggleGoMentionButton",value:function(a){_WA104.boardMode||(this.goMentionButton.first().updateText(a),this.goMentionButton.toggleClass("im-chat__history-go-mention_visible",!!a))}},{key:"updateHistoryWithScrollCorrection",value:function(a){return this._renderedData?a?this.updateViewWithFixPosition(a):void 0:Promise.resolve()}},{key:"updateFileProgress",value:function(a){if(this.messagesBlock)for(var b=this._dynamicData&&this._dynamicData.files||[],c=b.length,d=(a||"").toString();c--;)if("file"===b[c].getAttribute("data-type")&&b[c].getAttribute("data-id")===d){_WA104.fileTools.updateUploaderProgress(a,b[c]);break}}},{key:"_onLoadStickers",value:function(a){this.messagesBlock&&(this._needUpdateDynamicObjects.stickers||(this._needUpdateDynamicObjects.stickers={}),this._needUpdateDynamicObjects.stickers[a]=!0,this._updateDynamicObjects())}},{key:"_onLoadSnippet",value:function(){this.messagesBlock&&(this._needUpdateDynamicObjects.links=!0,this._updateDynamicObjects(),this.updateMediaEvent.fire())}},{key:"_onLoadFiles",value:function(){this.messagesBlock&&(this._fileLinksUpdateTimer&&clearTimeout(this._fileLinksUpdateTimer),this._needUpdateDynamicObjects.files=!0,this._updateDynamicObjects(),this.updateMediaEvent.fire(),this._fileLinksUpdateTimer=_WA104.setTimeout(this._redrawMessages,UPDATE_FILE_LINKS_PERIOD,this))}},{key:"_onLoadPoll",value:function(a){this.messagesBlock&&(this._needUpdateDynamicObjects.polls||(this._needUpdateDynamicObjects.polls={}),this._needUpdateDynamicObjects.polls[a]=!0,this._updateDynamicObjects())}},{key:"_updateDynamicObjects",value:function(){var a=this;if(!this._dynamicObjectsUpdateTimer){var b=!1,c=Object.keys(this._needUpdateDynamicObjects);this._dynamicData&&c.length&&this.updateHistoryWithScrollCorrection(function(){c.forEach(function(c){if(a._needUpdateDynamicObjects[c])switch(b=!0,c){case"stickers":a._updateStickers();break;case"links":a._updateSnippetLinks();break;case"files":a.updateFileLinks();break;case"polls":a._updatePoll()}})}),b&&(this._dynamicObjectsUpdateTimer=_WA104.setTimeout(function(){a._dynamicObjectsUpdateTimer=null,a._updateDynamicObjects()},200))}}},{key:"_updateStickers",value:function(){if(this._needUpdateDynamicObjects.stickers){var a=this._needUpdateDynamicObjects.stickers;delete this._needUpdateDynamicObjects.stickers;for(var b=this._dynamicData.stickers||[],c=[],d=b.length;d--;)a[b[d].getAttribute("data-id")]?(b[d].parentNode.removeAttribute("style"),b[d].parentNode.removeAttribute("data-action"),b[d].parentNode.innerHTML=""):c.push(b[d]);this._dynamicData.stickers=c}}},{key:"updateFileLinks",value:function(){if(this._needUpdateDynamicObjects.files){delete this._needUpdateDynamicObjects.files;for(var a,b,c,d,e,f,g,h,i=this._dynamicData.files||[],j=i.length,k=[];j--;){var l=!0;if(b=i[j].getAttribute("data-id"),c=b&&_WA104.fileTools.getLocalFileInfo(b)){if(_WA104.fileTools.isImageFile(b)){var m=i[j].parentNode.previousSibling;m&&"im-message-prefile"===m.className&&m.parentNode.removeChild(m)}if(g=i[j].getAttribute("data-text"),h=i[j].parentNode.lastChild,h=h&&"im-message__dummy-date"===h.className?h.outerHTML:null,d="1"===i[j].getAttribute("data-single"),e=i[j].getAttribute("data-mid"),f=e+"_"+b,a=_WA104.fileTools.generateHTML(c,{speechVisible:_WA104.DialogPage.getSpeechVisibility(f)},g,e,d,h),l=!1,i[j].parentNode.innerHTML!==a){if(d&&!g&&c.is_previewable&&!_DomUtil51.get(i[j]).up("imQuote")&&!_DomUtil51.get(i[j]).up("im-message-quote__reply")){var n=_DomUtil51.get(i[j]).up("imMessage");n&&n.addClass("im-message-single_image")}i[j].parentNode.innerHTML=a}}else _WA104.fileTools.UPLOAD_PREFIX===i[j].getAttribute("data-name")&&this.wrapEl.contains(i[j])&&_WA104.fileTools.updateUploaderProgress(b,i[j]);l&&k.unshift(i[j])}this._dynamicData.files=k}}},{key:"_updatePoll",value:function(){if(this._needUpdateDynamicObjects.polls){var a=this._needUpdateDynamicObjects.polls;delete this._needUpdateDynamicObjects.polls;var b,c=this._dynamicData&&this._dynamicData.polls||[],d=c.length;if(d)for(;d--;)if(b=c[d].getAttribute("data-id"),a[b]){var e=_DomUtil51.get(c[d]);e&&_WA104.Polls.updatePollNode(b,e)}}}},{key:"_updateSnippetLinks",value:function(){if(this._needUpdateDynamicObjects.links){delete this._needUpdateDynamicObjects.links;for(var a,b,c,d,e,f,g=this._dynamicData&&this._dynamicData.links||[],h=g.length,i=[];h--;){var j=!0;if(g[h].className.indexOf("imRawLink")>-1&&(a=decodeURIComponent(g[h].getAttribute("data-orig")),_WA104.snippet.urlHasSnippet(a))){var k=g[h],l=k.parentNode,m=+k.getAttribute("data-flags"),n=_WA104.snippet.getContentType(a),o=m&_WA104.snippet.FLAG_TEXT_MIX&&("image"===n||"gif"===n);if(e=_DomUtil51.get(l.parentNode),d=e.getSelector(".imMessageSnippetPlace"),f=d&&d.dom.lastChild,f&&"im-message__dummy-date"!==f.className&&(f=null),o){var p=-1!==l.className.indexOf("im-message_last");if(j=!1,b=_WA104.snippet.generateHTML(a,m,f&&f.outerHTML)){if(!e.hasClass("im-message__text-media")){e.addClass("im-message__text-media").setStyle("maxWidth",_WA104.DialogsAgent.getMediaBlockMaxSize()+"px");var q=e.next();q&&q.hasClass("imMessageButtons")&&q.setStyle("maxWidth",_WA104.DialogsAgent.getMediaBlockMaxSize()+"px")}p&&l.lastChild&&"im-message__dummy-date"===l.lastChild.className&&(f||(f=l.lastChild),l.removeChild(l.lastChild));var r=k.nextSibling;l.removeChild(k);var s=document.createElement("span");for(s.className="im-message__textblock "+(p?"im-message_last":"im-message_middle"),r&&r.tagName&&"br"===r.tagName.toLowerCase()&&(r=r.nextSibling,l.removeChild(r.previousSibling));r;){var t=r.nextSibling;s.appendChild(r),r=t}var u=!s.childNodes.length,v=l.firstChild===k;if(v)l.innerHTML=b,u||(l.className=l.className.replace("im-message_last",""));else{l.className=l.className.replace("im-message_last","");var w=_U90.DomHelper.elementFromHtml(_WA104.MessageFormatter.wrapSnippetBlock(b,{cls:p&&u?"im-message_last":""}));l.nextSibling?e.dom.insertBefore(w,l.nextSibling):e.dom.appendChild(w),l=w}u||(p&&f&&s.appendChild(f),l.nextSibling?e.dom.insertBefore(s,l.nextSibling):e.dom.appendChild(s))}}else if(d&&(j=!1,b=_WA104.snippet.generateHTML(a,m,f&&f.outerHTML))){if(!e.hasClass("im-message__text-media")){e.addClass("im-message__text-media").setStyle("maxWidth",_WA104.DialogsAgent.getMediaBlockMaxSize()+"px");var x=e.next();x&&x.hasClass("imMessageButtons")&&x.setStyle("maxWidth",_WA104.DialogsAgent.getMediaBlockMaxSize()+"px")}if(l.lastChild&&"im-message__dummy-date"===l.lastChild.className&&l.removeChild(l.lastChild),!(m&_WA104.snippet.FLAG_DONT_REPLACE_LINK)){l.removeChild(k);var y=l.innerHTML;(0===y.length||" "===y)&&(d.remove(),d=null)}d&&(l=d.dom,d=d.prev(),d&&d.removeClass("im-message_last")),l.innerHTML!==b&&(m&_WA104.snippet.FLAG_TEXT_MIX||!(b.indexOf("im-snippet_image")>-1)||-1!==b.indexOf("im-snippet_title")||_DomUtil51.get(l).up("imQuote")||_DomUtil51.get(l).up("im-message-quote__reply")||(d=_DomUtil51.get(l).up("imMessage"),d&&d.addClass("im-message-single_image")),l.innerHTML=b,c=l.getAttribute("data-class")||"",c&&(l.className=c))}}j&&i.unshift(g[h])}this._dynamicData.links=i}}},{key:"_resetDynamicObject",value:function(){this._dynamicData={links:[],files:[],polls:[],stickers:[]}}},{key:"_saveDynamicObjects",value:function(a){if(a){var b,c,d,e;this._dynamicData||(this._dynamicData={links:[],files:[],polls:[],stickers:[]});var f=_U90.Array.clone(a.querySelectorAll(_WA104.fileTools.OBJECT_TAG+'[data-type="file"]'));(b=this._dynamicData.links).push.apply(b,_toConsumableArray2(_U90.Array.clone(a.querySelectorAll("a.imRawLink")))),(c=this._dynamicData.files).push.apply(c,_toConsumableArray2(f)),(d=this._dynamicData.stickers).push.apply(d,_toConsumableArray2(_U90.Array.clone(a.querySelectorAll(_WA104.fileTools.OBJECT_TAG+'[data-type="sticker"]')))),(e=this._dynamicData.polls).push.apply(e,_toConsumableArray2(_U90.Array.clone(a.querySelectorAll(".imPollCard[data-id]")))),f.forEach(function(a){_WA104.fileTools.UPLOAD_PREFIX===a.getAttribute("data-name")&&_WA104.fileTools.updateUploaderProgress(a.getAttribute("data-id"),a)})}}},{key:"_redrawMessages",value:function(){this._renderedData&&this._renderedData.dialog&&this._fullRedraw(this._renderedData.dialog)}},{key:"_applyPatches",value:function(a,b){var c=this,d={},e={},f={},g=this._renderedData,h=g.messagesMap,i=g.firstMid,j=g.lastMid,k=g.startInd,l=g.endInd,m=g.historyCurrentPack,n=g.firstInHistoryPartPrepared,o=g.lastInHistoryPartPrepared,p=!1,q=!1,r=!1,s=!1,t=!1,u=a.historyLoaded,v=this.preparer.getHistoryPart(a);if(m!==a.historyCurrentPack||!v.length||!i||!j)return void this._fullRedraw(a);var w=this.stickyMessage;if(w&&!isObjRendered(h[w])){var x=_U90.Array.indexOfBy(v,function(a){return a.mid===w});if(x>0)return void this._fullRedraw(a,x);this.stickyMessage=null,this.stickyPosition=null}var y={};if(b.some(function(a){var b=a.type,c=a.message,g=a.mid,i=a.message_id,j=a.heads,k=a.toStart,l=a.historyPart;switch(b){case"sort":if(l===v)return s=!0,!0;break;case"new":var m=k?n:o;l===v&&m&&(y[c.mid||c.message_id]=!0,t=!0);break;case"modified":(h[i]||h[g])&&(d[i]=d[g]=!0,p=!0);break;case"remove":(h[i]||h[g])&&(f[g||i]={mid:g,message_id:i},q=!0);break;case"heads":Object.keys(j).forEach(function(a){(h[a]||y[a])&&(e[a]=!0,r=!0)})}}),s)return void this._fullRedraw(a);if(p=p||v[k]!==h[i].message||v[l-1]!==h[j].message,q||p||r||t){+new Date;this._renderedData.historyPart=v;var z=w?h[w]:h[this.renderer.getMiddleMessageId()];z&&(z=getMessageObjByCondition(z,function(a){var b=z.message,c=b.mid,d=b.message_id;return!f[c]&&!f[d]&&!a.message.hidden})),this.updateViewWithFixPosition(function(b){(t||u)&&c.renderer.hideSpinnerElement(),c.preparer.applyRemovePatches(f),c.renderer.fixVisibleOfBlockAfterDomUpdate();var g=c.preparer.update(a,w,d,e);c.renderer.fixVisibleOfBlockAfterDomUpdate(),g?c.renderer.redraw(b):c.renderer.update(b.bottomScrolled)},z,!0).then(function(){})}}},{key:"_isScrolledToHistoryEnd",value:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(!this._renderedData)return!0;var b=this._renderedData,c=b.lastInHistoryPartPrepared,d=b.historyNotLast,e=b.lastVisible,f=c&&!d&&!(e&&e.nextObj);return f&&this._compareScrollTop(this._getScrollToBottom()-a)>=0}},{key:"updateVisibleArea",value:function(){return this._onScrollCheck()}},{key:"updateViewWithFixPosition",value:function(a,b,c){var d,e=this,f=this.scrolledCont.dom.scrollTop;if(this._blinkingTimer&&(clearTimeout(this._blinkingTimer),this._blinkingTimer=null),!this.stickyMessage&&this._isScrolledToHistoryEnd()){a({bottomScrolled:!0}),this.renderer.fixAfterViewUpdate(),this._updateScrollLimits();var g=this._getScrollToBottom();0!==this._compareScrollTop(g)?d=this._setScroll(g,!0):this._isScrolledToHistoryEnd()||(d=this._onScrollCheck())}else{var h,i=this._renderedData&&this._renderedData.messagesMap||{};if(c?h=b&&b.message:(this.stickyMessage&&(b=i[this.stickyMessage]),b||(b=i[this.renderer.getMiddleMessageId()]),b=getMessageObjByCondition(b,function(a){return!a.message.hidden&&_messageInMap2(a.message,i)}),h=b&&b.message),b&&h){var j;if(j=this.stickyMessage&&(c||i[this.stickyMessage]===b)?_WA104.isNumber(this.stickyPosition)?this.stickyPosition:this.scrolledCont.dom.offsetHeight/2:b.node.offsetTop+this.messagesBlock.dom.offsetTop-f,a({middleMessage:b.message}),this.renderer.fixAfterViewUpdate(),this._updateScrollLimits(),b=_messageInMap2(h,this._renderedData.messagesMap)){this.stickToUnread&&_checkObjectType(b.nextObj,"lastRead")&&(b=b.nextObj);var k=b.node.offsetTop+this.messagesBlock.dom.offsetTop-this.scrolledCont.dom.scrollTop;j!==k&&(d=this._setScroll(this.scrolledCont.dom.scrollTop+(k-j),!0))}else{console.log("@!@!WARNING 2");var l=this.messagesBlock.dom.offsetTop+this.messagesBlock.dom.offsetHeight/2;0!==this._compareScrollTop(l)&&(d=this._setScroll(l))}}else{console.log("@!@!WARNING 1"),a({bottomScrolled:!0}),this.renderer.fixAfterViewUpdate(),this._updateScrollLimits();var m=this._getScrollToBottom();0!==this._compareScrollTop(m)&&(d=this._setScroll(m,!0))}}return(d||Promise.resolve()).then(function(){e.afterViewUpdate()})}},{key:"_updateScrollLimits",value:function(){this._minScrollTopForRoll=this.scrolledCont.dom.offsetHeight/2,this._maxScrollTopForRoll=this._getScrollToBottom()-this.scrolledCont.dom.offsetHeight/2;var a=this._renderedData||{},b=a.dialog,c=a.historyNotFirst,d=a.historyNotLast,e=a.lastInHistoryPartPrepared,f=a.firstInHistoryPartPrepared,g=a.lastVisible,h=a.firstVisible;this._canCheckTop=(b.historyLoaded!==!0||c)&&f&&!(h&&h.prevObj),this._canCheckBottom=d&&e&&!(g&&g.nextObj)}},{key:"getElementById",value:function(a){return this.wrapEl&&this.wrapEl.getSelector('[data-id="'+a+'"]')}},{key:"_getScrollToBottom",value:function(){return this.scrolledCont.dom.scrollHeight-this.scrolledCont.dom.offsetHeight}},{key:"_setScroll",value:function(a,b){var c=this;return this._scrollAutoSetValue=0>a?0:Math.min(a,this._getScrollToBottom()),this._currentScrollTopValue=this.scrolledCont.dom.scrollTop,this.scrolledCont.setStyle("overflow","hidden"),this._scrollFixTimer&&clearTimeout(this._scrollFixTimer),this._scrollFixTimer=_WA104.setTimeout(function(){c._scrollFixTimer=null,c._scrollAutoSetValue!==!1&&(c.scrollBar.sync(),c._onScroll())},100),this.scrolledCont.dom.scrollTop=this._scrollAutoSetValue,this.scrollBar.sync(),this._setScrollPromise||(this._setScrollPromise=new Promise(function(a){c._setScrollPromiseResolve=a})),b&&(this._setScrollPromise=this._setScrollPromise.then(this._onScrollAction.bind(this))),this._setScrollPromise}},{key:"saveMiddleMessage",value:function(){var a=this.renderer.getMiddleMessageId(),b=a&&this._renderedData.messagesMap[a];b&&(this._middleRenderedMessage={top:b.node.offsetTop+this.messagesBlock.dom.offsetTop,mid:b.message.mid})}},{key:"afterViewUpdate",value:function(){this.saveMiddleMessage(),this.flowDate.onUpdateVisible(),this.isChat&&this.flowAvatar.onUpdateVisible(),this._blinkingMessageId&&this.blinkMessageById(this._blinkingMessageId),this._checkLastVisibleMessageTimer||this.delayedCheckLastVisibleMessage(),this._checkSideScrolled(),this.tryToShowSmartReply()}},{key:"tryToShowSmartReply",value:function(){if(!this._canCheckBottom&&this.smartReply){var a=getLastInputMessagesId(this._renderedData.dialog.history,this.smartReply.getCacheSize());this.smartReply.updateAndShow(a)}}},{key:"hideSmartReply",value:function(){this.smartReply&&this.smartReply.safeHide()}},{key:"delayedCheckLastVisibleMessage",value:function(){var a=this;this.scrolledCont&&this.messagesBlock&&(this._checkLastVisibleMessageTimer&&clearTimeout(this._checkLastVisibleMessageTimer),this._checkLastVisibleMessageTimer=_WA104.setTimeout(function(){a._waitScreen||a._blockHistoryScroll?a.delayedCheckLastVisibleMessage():a.checkLastVisibleMessage()},700))}},{key:"checkLastVisibleMessage",value:function(){if(this._checkLastVisibleMessageTimer&&(clearTimeout(this._checkLastVisibleMessageTimer),this._checkLastVisibleMessageTimer=null),this._renderedData){var a=this.getLastViewedMessageId(),b=this._renderedData,c=b.dialog,d=b.historyPart,e=this._cacheLastRead?this._cacheLastRead.mid:c&&c.lastRead;if((!e||a>e)&&d){var f=this._cacheMentions&&this._cacheMentions.length||0,g=null;if(f>0){var h=this._cacheMentions.filter(function(b){return b>a?!0:((!g||b>=g)&&(g=b),!1)}.bind(this));g&&(this._cacheMentions=h),f!==this._cacheMentions.length&&this.toggleGoMentionButton(this._cacheMentions.length)}this.readNextMessageEvent.fire(this.dialogSn,a,g)}}}},{key:"resetStickyPosition",value:function(){this.stickyMessage=null,this.stickyPosition=null,this.stickToUnread=null}},{key:"scrollDownOn",value:function(a){var b=this._getScrollToBottom(),c=0===this._compareScrollTop(b);return this._setScroll(c?b:this.scrolledCont.dom.scrollTop+a,!0)}},{key:"_compareScrollTop",value:function(a){var b=this.scrolledCont.dom.scrollTop-a;return 2>b&&b>-2?0:2>b?-1:1}},{key:"_stopSmartReplyAnimation",value:function(){this._smartReplyAnimation&&(_U90.animation.clear(this._smartReplyAnimation),this._smartReplyAnimation=null,this.smartReply&&this.smartReply.el&&this.smartReply.isVisible()&&!this.smartReply.isHiding&&(this.smartReply.el.setStyle("height","84px"),this.scrollBar.sync()))}},{key:"_onSmartReplyToggle",value:function(a,b){var c=this;_U90.animation.clear(this._smartReplyAnimation);var d=a?(b?4:68)+16:b?20:1;this._smartReplyAnimation=_U90.animation.start(this.smartReply.el.dom.offsetHeight,d,.44,function(b,d){if(c.smartReply&&c.smartReply.el){var e=b-c.smartReply.el.dom.offsetHeight;c.smartReply.el.setStyle("height",b+"px"),a&&c.scrollDownOn(e),d&&(c._smartReplyAnimation=null,a||c.scrollBar.sync())}else _U90.animation.clear(c._smartReplyAnimation),c._smartReplyAnimation=null})}},{key:"_onSmartReplyClick",value:function(a){a=a||{},this.smartReplyEvent.fire(a)}},{key:"_redrawBotButtons",value:function(a){var b=this;this._renderedData&&this.messagesBlock&&a.forEach(function(a){var c=b.messagesBlock.getSelector('.imMessage[data-arch-id="'+a+'"] .imMessageButtons');if(c){var d=_WA104.bots.getMarkup(a);if(d){var e=_WA104.MessageFormatter.renderBotButtons(d,_WA104.bots.getState(a)||[]);c.updateHTML(e)}}})}},{key:"_fullRedraw",value:function(a,b){var c,d=this,e=this._renderedData&&this._renderedData.messagesMap;if(this.preparer.rebuild(a,this.stickyMessage,b),this.stickyMessage)c=this._renderedData.messagesMap[this.stickyMessage];else if(e){var f=this.renderer.getMiddleMessageId();c=e[f],c=getMessageObjByCondition(c,function(a){return!a.message.hidden&&_messageInMap2(a.message,d._renderedData.messagesMap)})}return this.updateViewWithFixPosition(function(a){d.renderer.hideSpinnerElement(),d.renderer.redraw(a)},c,!0)}},{key:"_updateRenderedData",value:function(a){this._renderedData=this.preparer.makeRenderedData(a,this.isChat,this._cacheLastRead),this.renderer.setRenderedData(this._renderedData)}},{key:"_renderHistory",value:function(a,b,c){if(!this.stickyMessage&&this.stickToUnread&&this._cacheLastRead&&(this.stickyMessage=this._cacheLastRead.mid,this.stickyPosition=35),a&&a.history&&(this._updateRenderedData(a),c&&this._renderedData&&this._renderedData.endInd?this._applyPatches(a,c):this._fullRedraw(a)),a&&(delete a.insertingHistoryFlag,delete a.addingMessageFlag),this._checkingTopScroll=!0,this._checkingBottomScroll=this._canCheckBottom||this._renderedData.historyNotLast,this.toggleGoMentionButton(this._cacheMentions.length),a.insertingHistoryPackFlag&&(delete a.insertingHistoryPackFlag,this._waitScreen)){var d=this._waitingMessage||{},e=d.archId,f=d.skipBlinking;this.clearWaitScreen(),e&&this.scrollUpToMessage(e,!1,f)}}},{key:"renderHistory",value:function(a,b,c){var d=this;clearTimeout(this._renderTimer),this._renderTimer=null,b&&!this._cacheLastRead&&(this._cacheLastRead={count:b,mid:a.lastRead,domId:"unr"+_WA104.uniq(),loaded:!1}),this._cacheMentions=_U90.Array.clone(a.mentionIds||[]),this.updateGoDownButton(a.unreadCount),this.scrolledCont.getHeight()?(this._setForceState&&(this._middleRenderedMessage=this._setForceState.midMess,this._setForceState.lasReadCount&&(this._cacheLastRead={count:this._setForceState.lasReadCount,mid:this._setForceState.lastReadMid,domId:"unr"+_WA104.uniq(),loaded:!1}),this._middleRenderedMessage&&this._middleRenderedMessage.mid&&(this.stickyMessage=this._middleRenderedMessage.mid,this._setForceState.scrollTop&&(this.stickyPosition=this._middleRenderedMessage.top-this._setForceState.scrollTop))),this._renderHistory(a,!!b,c),delete this._setForceState):this._renderTimer=_WA104.setTimeout(function(){d.renderHistory(a,b,c)},1)}},{key:"blinkMessageById",value:function(a){var b=this;this._blinkingTimer&&clearTimeout(this._blinkingTimer),this._blinkingMessageId=a,this._blinkingTimer=_WA104.setTimeout(function(){b._blinkingTimer=null;var c=b._renderedData.messagesMap,d=c[a];isObjRendered(d)&&(_DomUtil51.get(d.node).addClass("im-message__blinking"),b._blinkingTimer=_WA104.setTimeout(function(){delete b._blinkingMessageId,b._blinkingTimer=null,d.node&&_DomUtil51.get(d.node).removeClass("im-message__blinking")},200))},200)}},{key:"getMessageByElement",value:function(a){var b=a.getAttribute("data-arch-id")||a.getAttribute("data-message-id");return this.getMessageByIndexAndId(!1,b)}},{key:"getMessageByIndexAndId",value:function(a,b){var c=this._renderedData,d=c.historyPart,e=c.messagesMap;if(d){if(e[b]&&e[b].message)return e[b].message;var f=_U90.Array.indexOfBy(d,function(a){return a.mid===b||a.message_id===b});return f>-1&&d[f]}}},{key:"jumpToEnd",value:function(){this.resetStickyPosition(3);var a,b=this._renderedData&&this._renderedData.dialog;return b&&(this.renderer.hideSpinnerElement(),this._renderedData.historyNotLast&&(b.historyCurrentPack=b.history.length-1,this._renderedData.historyPart=this.preparer.getHistoryPart(b),this._renderedData.historyCurrentPack=b.historyCurrentPack),this.preparer.rebuild(this._renderedData.dialog,this.stickyMessage,this._renderedData.historyPart.length-1),this.renderer.redraw({bottomScrolled:!0}),this.renderer.fixAfterViewUpdate(),this._updateScrollLimits(),a=this._setScroll(this._getScrollToBottom(),!0).then(this.afterViewUpdate.bind(this))),a||Promise.resolve()}},{key:"scrollUpToMessage",value:function(a,b,c){var d=this;if(this._renderedData&&this._renderedData.historyPart){b||this.resetStickyPosition(2);var e=this._renderedData,f=e.messagesMap,g=e.historyPart,h=e.dialog;if(f[a]&&(this.stickyMessage=a,f[a].node.offsetHeight||(this.renderer.hideSpinnerElement(),this.renderer.redraw({middleMessage:f[a].message}),this.renderer.fixAfterViewUpdate()),f[a].node.offsetHeight)){var i=this.scrolledCont.dom.scrollTop,j=f[a].node.offsetTop+this.messagesBlock.dom.offsetTop-i,k=Math.max(10,this.scrolledCont.dom.offsetHeight/2-f[a].node.offsetHeight/2);return this._setScroll(i-(k-j),!0).then(function(){d.afterViewUpdate(),c||d.blinkMessageById(a)})}var l=_U90.Array.indexOfBy(g,function(b){return b.mid===a});return l>-1?(this.stickyMessage=a,this._fullRedraw(h,l).then(function(){c||d.blinkMessageById(a)})):(b||(this._scrollUpTriesCounter<2?(this._scrollUpTriesCounter++,this.waitForMessage(a),this.jumpToMessageEvent.fire(a)):(this._scrollUpTriesCounter=0,this.clearWaitScreen())),Promise.resolve())}}},{key:"waitForMessage",value:function(a,b){var c=this.showWaitScreen();this._waitingMessage={archId:a,skipBlinking:b},c.on("click",function(){this.clearWaitScreen()},this)}},{key:"getLastViewedMessageId",value:function(){if(this.scrolledCont&&this.messagesBlock){var a,b=this.scrolledCont.dom.offsetHeight-(this.messagesBlock.dom.offsetTop-this.scrolledCont.dom.scrollTop),c=this.messagesBlock.dom.querySelectorAll(".imMessage"),d=0;return _U90.Array.each(c,function(c){if(c=_DomUtil51.get(c),c.hasClass("imMessage")){if(d=c.dom.offsetHeight>90?.7*c.dom.offsetHeight:3,c.dom.offsetTop+d>b)return!1;a=c}}),a&&a.getAttribute("data-arch-id")}}},{key:"onStepDown",value:function(){return this._fullRedraw(this._renderedData.dialog,this._renderedData.endInd-1)}},{key:"onStepUp",value:function(){return this._fullRedraw(this._renderedData.dialog,this._renderedData.startInd)}},{key:"afterStep",value:function(a){return this._updateScrollLimits(),this._setScroll(a).then(this.afterViewUpdate.bind(this))}},{key:"_onScrollCheck",value:function(){var a=this,b=this.scrolledCont.dom.scrollTop;return b>this._maxScrollTopForRoll?this.renderer.stepDown().then(function(){return a._renderedData.lastVisible&&a._renderedData.lastVisible.nextObj&&a.scrolledCont.dom.scrollTop>a._maxScrollTopForRoll?a._fullRedraw(a._renderedData.dialog,a._renderedData.endInd-1):void 0}):b<this._minScrollTopForRoll?this.renderer.stepUp().then(function(){return a._renderedData.firstVisible&&a._renderedData.firstVisible.prevObj&&a.scrolledCont.dom.scrollTop<a._minScrollTopForRoll?a._fullRedraw(a._renderedData.dialog,a._renderedData.startInd):void 0}):void 0}},{key:"_checkSideScrolled",value:function(){var a=!1,b=this.scrolledCont.dom.scrollTop;return this._canCheckTop&&this._checkingTopScroll&&0>b-200?(this._checkingTopScroll=!1,this.renderer.showTopSpinner(),this.sideScrolledEvent.fire(),a=!0):this._canCheckBottom&&this._checkingBottomScroll&&b+200>this._getScrollToBottom()&&(this._checkingBottomScroll=!1,this.renderer.showBottomSpinner(),this.sideScrolledEvent.fire(!0),a=!0),a}},{key:"_onScrollAction",value:function(){this.scrolledCont.dom.scrollTop;this._renderedData&&this._renderedData.dialog&&this._renderedData.dialog.unreadCount&&(this._waitScreen||this._blockHistoryScroll?this.delayedCheckLastVisibleMessage():this.checkLastVisibleMessage()),this._checkSideScrolled()||this._onScrollCheck()}},{key:"_onUserScroll",value:function(){this.resetStickyPosition(1),this._onScrollAction()}},{key:"_onScroll",value:function(a){var b=this.scrolledCont.dom.scrollTop;if(this._currentScrollTopValue=b,this._scrollAutoSetValue!==!1){this._scrollFixTimer&&(clearTimeout(this._scrollFixTimer),this._scrollFixTimer=null);var c=this._scrollAutoSetValue-b;if(this._setScrollTriesCounter<3&&(c>5||-5>c))this._setScrollTriesCounter++,this._setScroll(this._scrollAutoSetValue);else if(this._setScrollTriesCounter=0,this._scrollAutoSetValue=!1,this.scrolledCont.setStyle("overflow","auto"),this.scrolledCont.dom.scrollTop=b,this.scrollBar.sync(),this._setScrollPromiseResolve){var d=this._setScrollPromiseResolve;this._setScrollPromise=this._setScrollPromiseResolve=null,d(b)}}else this._onUserScroll(a);this.toggleGoDownButton(!this._isScrolledToHistoryEnd(GO_DOWN_BUTTON_MIN_CONDITION)),this.flowDate.onScroll(),this.isChat&&this.flowAvatar.onScroll()}},{key:"setCurrentState",value:function(a){this._setForceState=a}},{key:"setCacheLastRead",value:function(a,b){a&&b&&(this._cacheLastRead={count:a,mid:b,domId:"unr"+_WA104.uniq(),loaded:!1})}},{key:"getCurrentState",value:function(){return{midMess:this._middleRenderedMessage,lasReadCount:this._cacheLastRead&&this._cacheLastRead.count,lastReadMid:this._cacheLastRead&&this._cacheLastRead.mid,scrollTop:this._currentScrollTopValue}}}]),a}();_WA104.DialogHistory=DialogHistory;var _WA105=WebIM,_TD34=_WA105.TemplateDriver,_U91=_WA105.util,_UI56=_WA105.ui,_AS3=_WA105.AccountSettings,_DomUtil52=_WA105.DomUtil,_REQUEST_CHAT_MEMBERS_LIMIT=50,MAX_DIALOGS_STACK_SIZE=5,EDITING_AVAILABLE_TIME=1e10,MIN_SMILES_MENU_HEIGHT=130,_POST_MAX_LENGTH=2e4,MIN_WINDOW_HEIGHT_INPUT_MAX_HEIGHT=118,MIN_HISTORY_HEIGHT=30,TOP_SUB_BAR_HEIGHT=48,MAX_SMILES_MENU_HEIGHT=290,DIALOG_SEARCH_HOTKEY_TOOLTIP="",_REGEX_MENTION_HOLDER=/<mark[^>]+data-mention="([^"]+)"[^>]*>(.+?)<\/mark>/gi,BOARD_MODE_CONTEXT_MENU_ACTIONS=["mention","reply","saveAs","copyText","copyLink","openInBrowser","edit","delForMe","delForAll","pollRecall","pollStop"],NO_INPUT_STATE_DATA={subscribe:{className:"im-dialogpage_input-subscribe",action:"subscribe",title:_WA105.tr("dialog.noinput.subscribe")},join:{className:"im-dialogpage_input-join",action:"join",title:_WA105.tr("dialog.noinput.join")},mute:{className:"im-dialogpage_input-mute",action:"mute",title:_WA105.tr("dialog.noinput.mute")},unmute:{className:"im-dialogpage_input-unmute",action:"unmute",title:_WA105.tr("dialog.noinput.unmute")},remove:{className:"im-dialogpage_input-remove",action:"remove",title:_WA105.tr("dialog.noinput.remove")},unblock:{className:"im-dialogpage_input-unblock",action:"unblock",title:_WA105.tr("dialog.noinput.unblock")},readonly:{className:"im-dialogpage_input-readonly",action:"",title:_WA105.tr("dialog.noinput.readonly")},pending:{className:"im-dialogpage_input-readonly",action:"",title:_WA105.tr("dialog.noinput.pending")},blocked:{className:"im-dialogpage_input-readonly",action:"",title:_WA105.tr("group.youAreBannedInGroup")},unknown:{className:"im-dialogpage_input-unknown",action:"",title:_WA105.tr("dialog.noinput.unknown")},comment:{className:"im-dialogpage_input-join",action:"join",title:_WA105.tr(_WA105.Feature.getModeParameter("boardJoinButtonTitle"))}},pttSpeechVisibility={},_needDetectKeyboardOnIOS=_WA105.isIOS,DialogPage=function(a){function b(a){var c;return _classCallCheck2(this,b),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a||"dialog")),c.backEvent=new _U91.Event,c.messageEvent=new _U91.Event,c.typingEvent=new _U91.Event,c.stickerEvent=new _U91.Event,c.sideScrolledEvent=new _U91.Event,c.jumpToMessageEvent=new _U91.Event,c.readNextMessageEvent=new _U91.Event,c.clearHistoryEvent=new _U91.Event,c.deleteMessageEvent=new _U91.Event,c.pinMessageEvent=new _U91.Event,c.forwardLinkEvent=new _U91.Event,c.globalActionEvent=new _U91.Event,c.pinToggleEvent=new _U91.Event,c.backToHistoryEvent=new _U91.Event,c.shareContactEvent=new _U91.Event,c.typingNotifyChecker=new _U91.DelayedTask({
interval:1e4,fn:c._onTypingNotifyCheck,scope:_assertThisInitialized2(_assertThisInitialized2(c))}),_WA105.Statuses.updateEvent.on(c._updateAwayStatus,_assertThisInitialized2(_assertThisInitialized2(c))),c._noInputState="",c._firstUpdateView=!0,c._savedTextareaData={},c._keyboardSize={portrait:0,landscape:0},c._keyboard=0,c._contentSizeHolded=!1,c._orientation="portrait",c._uniq=null,c._opened=!1,c._onPageVisible=null,c.chatRole=null,c._isTyping=!1,c._subMessage="",c._forChangesCheck=null,c._backTimer=null,c.infoPanel=_WA105.InfoPanel,_WA105.chatController.infoReadyEvent.on(c.updateMembersList,_assertThisInitialized2(_assertThisInitialized2(c))),_WA105.fileTools.progressUploadEvent.on(c.onProgressEvent,_assertThisInitialized2(_assertThisInitialized2(c))),_WA105.fileTools.endUploadEvent.on(c.onEndUploadEvent,_assertThisInitialized2(_assertThisInitialized2(c))),_WA105.showcasePage.shareEvent.on(c.onShowcaseShareEvent,_assertThisInitialized2(_assertThisInitialized2(c))),_WA105.contactAbstraction.muteEvent.on(c._onContactMute,_assertThisInitialized2(_assertThisInitialized2(c))),_WA105.mediaPlayer.stateEvent.on(c._onMediaPlayerState,_assertThisInitialized2(_assertThisInitialized2(c))),c}return _inherits2(b,a),_createClass2(b,[{key:"_onContactMute",value:function(a){a===this.mail&&(this._muteSettingChanged=!0)}},{key:"_onMediaPlayerState",value:function(a,b){this.history&&_WA105.mediaFileStateManager.updateMediaFileState(a,b,this.history.wrapEl)}},{key:"makeHistory",value:function(a){var b=this;this.history&&(this.history.renderUnbind(),this.history.sideScrolledEvent.removeAll(),this.history.jumpToMessageEvent.removeAll(),this.history.readNextMessageEvent.removeAll(),this.history.updateMediaEvent.removeAll(),this.history.smartReplyEvent.removeAll()),this.history=new a,this.history.sideScrolledEvent.on(this._onSideScrolledEvent,this),this.jumpToMessageEvent.relay(this.history.jumpToMessageEvent),this.readNextMessageEvent.relay(this.history.readNextMessageEvent),this.history.updateMediaEvent.on(this._updatePinnedData,this),this.history.smartReplyEvent.on(function(a){var c=a.id,d=a.text,e=a.messageId,f=a.type,g={messageId:e,type:f};c?b.messageEvent.fire(b.mail,{text:_WA105.Sticker.getStickerSendUrl(c),smartReplyMeta:g}):d&&b.messageEvent.fire(b.mail,{text:d,smartReplyMeta:g})},this)}},{key:"initOnce",value:function(){this.__initCompleted||(this.__initCompleted=!0,this.spinnerTMPL=_WA105.TD.getTMPL("CircleSpinner"),this.makeHistory(_WA105.DialogHistory),this.textarea=new _WA105.DialogInput,this.textarea.resizeEvent.on(this._onTextfieldResize,this),this.textarea.changeEvent.on(this._onMessageChanged,this),this.textarea.submitEvent.on(this.submitMessage,this),this.textarea.overflowEvent.on(this._onMessageOverflow,this),this.textarea.showSmileMenuEvent.on(this.onShowSmilesMenu,this),this.textarea.hideSmileMenuEvent.on(this.onHideSmilesMenu,this),this.textarea.showPttEvent.on(this.onShowPttRecorder,this),this.textarea.hidePttEvent.on(this.onHidePttRecorder,this),this.textarea.topMessageToggleEvent.on(this.onTopInputMessageToggle,this),this.textarea.clickOnEditedMsgEvent.on(this.scrollUpToMessage,this),_needDetectKeyboardOnIOS&&(this.textarea.focusEvent.on(this._onTextareaFocus,this),this.textarea.blurEvent.on(this._onTextareaBlur,this)),this.textarea.stickerEvent.on(function(a,b,c){b&&this.messageEvent.fire(this.mail,{text:_WA105.Sticker.getStickerSendUrl(b),quotes:c})},this),this.textarea.sendPttEvent.on(this._sendFileBundle,this),this.textarea.chooseFileEvent.on(this._onChooseFiles,this),this.shareContactEvent.relay(this.textarea.shareContactEvent),this.textarea.upArrowEvent.on(function(a){var b=this;if(a&&this._cachedDialog&&this._cachedDialog.history){var c=this._cachedDialog.history[this._cachedDialog.history.length-1];if(c){var d=function(){for(var a,d,e=0,f=c.length;f--;){if(e++,e>10)return{v:!1};if(a=c[f],!a.event&&!a.poll&&a.from===_WA105.ACTIVE_MAIL&&_WA105.now()-a.date<EDITING_AVAILABLE_TIME){if(a.parts){if(d=a.parts[a.parts.length-1],d.contact||"text"!==d.mediaType||_WA105.fileTools.resolveLinkAsFile(d.text))return{v:!1}}else if(a.sticker||a.contact||_WA105.fileTools.resolveLinkAsFile(a.text))return{v:!1};return _WA105.setTimeout(function(){this.editMessage({message:a})},1,b),{v:void 0}}}}();if("object"===_typeof2(d))return d.v}}return!1},this),_WA105.isDesktop&&(this.dragDropArea=new _UI56.DragDropArea({dualMode:!0}),this.dragDropArea.dropEvent.on(this._onDragDropFile,this),this.dragDropArea.dragEvent.on(this._onFileDrag,this)))}},{key:"renderBind",value:function(){this._content&&this.renderUnbind(),this._nameField=this.winEl.getSelector(".imDialogTitle"),this._avatarBox=this.winEl.getSelector(".imDialogTitleAvatar"),this._subNameField=this.winEl.getSelector(".imDialogSubTitle"),this._topbar=this.winEl.getSelector(".app-topbar"),this._bottombar=this.winEl.getSelector(".app-bottombar"),this._content=this.winEl.getSelector(".app-content"),this._unreadMessagesCounter=this.winEl.getSelector(".im-msg-counter"),this._noInputBlock=this.winEl.getSelector(".im-chat__no-input"),this.winEl.getSelector(".imStartSearchChat").setAttribute("title",_WA105.tr("search.dialogSearch")+DIALOG_SEARCH_HOTKEY_TOOLTIP),this.infoPanel&&this.infoPanel.actionEvent.on(this._onPanelAction,this),this.history&&(this.history.renderBind(this.winEl),this.history.el.on("change",this._onHistoryInputChange,this)),this.textarea&&this.textarea.renderBind(this.winEl),this._typingField=this.winEl.getSelector(".im-chat__typing"),_DomUtil52.fly(window).on("resize",this.onResize,this),this.winEl.on("click",this._onClick,this),this.winEl.on("contextmenu",this._onContextmenu,this),_WA105.isDesktop&&this.winEl.on("dblclick",this._onDblClick,this),this.dragDropArea&&this.dragDropArea.activate(this.winEl),this._winSize=this.getWinSize(),this._contentSizeHolded=!1,this._orientation=this._winSize.height>this._winSize.width?"portrait":"landscape";var a=parseInt(this._content.dom.style.bottom||this._content.getStyle("bottom"));this._content.setStyle("bottom",a+"px");var b=_WA105.Feature.getModeParameter("extDialogTopBarTrKey");if(b&&_WA105.boardModeParams){var c=this.winEl.getSelector(".extDialogTopbar"),d=_WA105.Feature.getModeParameter("extDialogTopBarTrParams"),e=_WA105.Feature.getModeParameter("extDialogTopBarUseLink");if(c){var f=(d||[]).map(function(a){return _U91.String.htmlEntity(_WA105.boardModeParams[a])});e&&f.push(_WA105.urlBuilder.inviteChatLink(this.mail)),c.updateHTML(_WA105.tr(b,f)),this.winEl.addClass("im-dialogpage_ext-topbar-show")}}_WA105.splitView&&this._keepSidebarPosition&&this.toggleSidebar(!0,!0)}},{key:"renderUnbind",value:function(){_DomUtil52.fly(window).un("resize",this.onResize,this),this.winEl.un("click",this._onClick,this),this.winEl.un("contextmenu",this._onContextmenu,this),_WA105.isDesktop&&this.winEl.un("dblclick",this._onDblClick,this),this.infoPanel&&(this._keepSidebarPosition=this.infoPanel.isShown(),this.infoPanel.closeAll(),this.infoPanel.actionEvent.removeAll()),this.history&&this.history.renderUnbind(),this.textarea&&this.textarea.renderUnbind(),this.dragDropArea&&this.dragDropArea.deactivate(),this._typingField=this._content=this._nameField=this._subNameField=this._bottombar=this._noInputBlock=null}},{key:"onPageLoad",value:function(a,b){this._backTimer&&(clearTimeout(this._backTimer),this._backTimer=null);b.cast[b.mail]||{nick:b.mail};this.mail=b.mail,this.isChat=_WA105.MainAgent.isChat(this.mail),this.isFavorite=this.mail===_WA105.ACTIVE_MAIL,this.isChannel=this.isChat&&b.isChannel,this._uniq=null,this._onPageVisible=null,this.chatRole=null,this._isTyping=!1,this.nick=!1,this._subMessage="",this._noInputState="",this._forChangesCheck=null,this._mediaPlayer=null,this._galleryView=null,this._typingInfo=!1,pttSpeechVisibility={},this.initOnce(),this.history&&this.history.init(this.mail,this.isChat),this.textarea&&this.textarea.init(this.mail),this.winEl=_DomUtil52.get(a),this.winEl.setAttribute("mail",_U91.String.htmlEntity(b.mail)),this.winEl.toggleClass("im-dialogpage__is_chat",this.isChat),this.winEl.toggleClass("im-dialogpage_self",this.isFavorite),this.winEl.removeClass("im-dialogpage__has-pending"),this.renderBind();var c=this.updateNoInputState();this.previousDialog&&this.previousDialog.restoring&&(b.historyCurrentPack=this.previousDialog.historyCurrentPack,this.history&&this.history.setCurrentState(this.previousDialog.historyState),this.previousDialog=this.previousDialog.prev||null);var d=_WA105.Feature.getModeParameter("hideBackButtonInFirstChat")&&!this.previousDialog;this.winEl.toggleClass("im-dialogpage_hide-back-button",d),this.updateWindow(b,!0,!0),App.on("page:change",this._onPageChange,this),App.on("page:show",this._onPageShow,this),App.on("page:hide",this._onPageHide,this),App.on("navigation:back",this._onNavigationBack,this),_WA105.Pane.boxCloseEvent.on(this.textarea.restoreState,this.textarea),this.infoPanel&&this.infoPanel.toggleEvent.on(this._onSidebarToggle,this),this._awaitChatInfoForFocus=this.isChat&&!this.chatRole,c&&(this._savedTextareaData[this.mail]?this.textarea.setSavedData(this._savedTextareaData[this.mail],!_WA105.isDesktop):_WA105.isDesktop&&!_WA105.boardMode&&this.textarea.focusField()),this._pageLoaded=!0}},{key:"onPageUnload",value:function(a){delete this._pageLoaded,_WA105.mediaPlayer.pause(),this.winEl&&this.winEl.dom===a&&(this._onPageVisible=null,App.off("page:change",this._onPageChange,this),App.off("page:show",this._onPageShow,this),App.off("page:hide",this._onPageHide,this),App.off("navigation:back",this._onNavigationBack,this),this.infoPanel&&this.infoPanel.toggleEvent.un(this._onSidebarToggle,this),this.textarea&&(_WA105.Pane.boxCloseEvent.un(this.textarea.restoreState,this.textarea),this._savedTextareaData[this.mail]=this.textarea.getDataToSave()),this.renderUnbind(),this._resizeCheckerTimer&&(clearTimeout(this._resizeCheckerTimer),this._resizeCheckerTimer=!1),this._messageTimer&&(clearTimeout(this._messageTimer),this._messageTimer=!1),this._mediaPlayer&&(this._mediaPlayer.destroy(),this._mediaPlayer=null),this._galleryView&&(this._galleryView.destroy(),this._galleryView=null),this._resizeDelay&&clearTimeout(this._resizeDelay),this._resizeDelay=!1,delete this._pinnedMessage,delete this._pinnedMsgId,delete this._pinnedWaitData,this.typingNotifyChecker.stop(),this.winEl=null,this._opened===this.mail&&(this._backTimer=_WA105.setTimeout(this.backEvent.fire,10,this.backEvent)))}},{key:"updateNoInputState",value:function(){var a=this._noInputState,b="",c=!1;if(this.isChat){var d=_WA105.chatController.getCachedChatInfo(this.mail);if(d){var e="readonly"===d.defaultRole;d.you&&d.you.role?(c=!d.you.pending,"readonly"===d.you.role?b=e?this.muted?"unmute":"mute":"readonly":d.you.pending&&(b="pending")):b=d.you&&d.you.pending?"pending":e?"subscribe":"join"}else{var f=_WA105.chatController.getChatInfoStatus(this.mail);b=_WA105.CLD.inList(this.mail)?"noStamp"===f||"blocked"===f?"remove":"unknown":"blocked"===f?"blocked":"unknown"}}if(_WA105.CLD.isBlocked(this.mail)&&(b="unblock"),"join"===b&&_WA105.boardMode&&(b="comment"),a!==b){if(this._noInputBlock&&(NO_INPUT_STATE_DATA[a]&&this._noInputBlock.removeClass(NO_INPUT_STATE_DATA[a].className),b&&NO_INPUT_STATE_DATA[b])){var g=NO_INPUT_STATE_DATA[b],h=g.className,i=g.action,j=g.title;this._noInputBlock.last().updateHTML(j),this._noInputBlock.addClass(h).first().setAttribute("data-action",i).updateHTML(j)}this.winEl&&(this.winEl.toggleClass("im-dialogpage_readonly",!!b),this.winEl.toggleClass("im-dialogpage_is_member",c)),this._noInputState=b}return!this._noInputState}},{key:"toggleSidebar",value:function(a,b){!_WA105.Feature.getModeParameter("disableDialogSidebar")&&this.infoPanel&&this.infoPanel.toggle(a,{sn:this.mail},b)}},{key:"_onSidebarToggle",value:function(){_WA105.splitView&&this.history&&this.history.updateVisibleArea()}},{key:"onProgressEvent",value:function(a,b){a===this.mail&&this.history&&this.winEl&&this.history.updateFileProgress(b)}},{key:"onEndUploadEvent",value:function(a,b,c){this.history&&(a===this.mail&&this.winEl&&!c&&(b.errorMsg&&_WA105.showPopup('<div class="im-ellipsis-block">'+_U91.String.htmlEntity(b.name)+"</div>"+_U91.String.htmlEntity(b.errorMsg),void 0,!0),this.history.updateFileLinks()),this.history.jumpToEnd())}},{key:"onShowcaseShareEvent",value:function(a,b,c){this.forwardLinkEvent.fire(this.mail,this.nick,_WA105.urlBuilder.getUrl("stickerShare")+"/"+a,_WA105.splitView&&function(){_WA105.Pane.openPageBox(_WA105.showcasePage,{id:b}),c||(_WA105.showcasePage.singlePackMode=!1)},!_WA105.splitView&&function(){var a=App.indexOfPage("showcase");a>-1&&App.spliceHistory(a,1)})}},{key:"checkForChanges",value:function(a){var b,c=a.cast[this.mail]||{},d=[a.modifDate,a.unreadCount,c.nick,c.mute,_WA105.DialogsAbstraction.nick||_WA105.ACTIVE_MAIL,c.statusTitle,c.status,c.lastseen,c.userState,this.isChat?a.typing&&a.typing[1]:a.typing].join("|");return b=d!==this._forChangesCheck,this._forChangesCheck=d,b}},{key:"_updateAwayStatus",value:function(){if(this.winEl&&!this.isChat&&this._cachedLastSeen){var a=_U91.Date.formatLastSeenData(this._cachedLastSeen);_WA105.boardModeParams&&_WA105.boardModeParams.imchat===this.mail&&_WA105.boardModeParams.spec_status&&(a=_WA105.boardModeParams.spec_status),this.updateSubtitle(a)}}},{key:"updateWindow",value:function(a,c,d,e){var f=this,g=b.fetchDialogInfo(a),h=this.nick!==g.nick,i=_WA105.CLD.inList(this.mail)?0:1,j=c||this._uniq!==a.modifDate||h,k=d&&a.unreadCount,l=!this.isChat&&this._cachedLastSeen!==g.lastseen,m=c||this._muteSettingChanged||h||!this.muted!=!g.mute||this.selfNick!==(_WA105.DialogsAbstraction.nick||_WA105.ACTIVE_MAIL)||this.uNick!==g.uNick;if(_WA105.RTCTools.isEnabled()&&this.mail!==_WA105.ACTIVE_MAIL){var n=!this.isChat;if(this.isChat){var o=_WA105.chatController.getCachedChatInfo(this.mail);if(o){var p="readonly"===o.defaultRole;n=!p&&o.you&&"readonly"!==o.you.role}}this.winEl.getSelector(".imButton[data-action=callVoice]").setVisible(n),this.winEl.getSelector(".imButton[data-action=callVideo]").setVisible(n)}if(h||this._muteSettingChanged||l){this.nick=g.nick||this.nick;var q=this.isFavorite?_WA105.tr("dialog.favorite"):this.nick;_WA105.boardModeParams&&_WA105.boardModeParams.imchat===this.mail&&_WA105.boardModeParams.friendly&&(q=_WA105.boardModeParams.friendly),h&&this._nameField&&this._nameField.first().updateHTML(_WA105.Emoji.parse(_U91.String.htmlEntity(q||this.mail))),this.avatarHtml=_WA105.Ava.make(this.mail,q,32,null,{isFavorite:this.isFavorite,official:!!g.official,mute:!!g.mute,online:0===g.lastseen&&!g.bot}),this._avatarBox.updateHTML(this.avatarHtml),delete this._muteSettingChanged}if(delete this._cachedLastSeen,this._subNameField){var r="",s=!1,t="";this.isChat?(r=this._subMessage,a.typing&&a.typing[1]?(s=!0,t=_WA105.Emoji.parse(_U91.String.htmlEntity(a.typing[1].replace(/\s+.*/,"")))+" "+_WA105.tr("dialog.typing")):s=!1):(r=g.lastseenMessage,g.userState||g.bot||(this._cachedLastSeen=g.lastseen),a.typing&&(s=!0,t=_WA105.tr("dialog.typing"))),_WA105.boardModeParams&&_WA105.boardModeParams.imchat===this.mail&&_WA105.boardModeParams.spec_status&&(r=_WA105.boardModeParams.spec_status),this.updateSubtitle(r),this._isTyping!==s&&this._typingField&&(this._isTyping=s,this._typingField.updateHTML(t||""))}this.needAuthStatus!==i&&(m=!0),m&&(this.muted=g.mute,this.selfNick=_WA105.DialogsAbstraction.nick||_WA105.ACTIVE_MAIL,this.uNick=g.uNick,this.needAuthStatus=!!i,this.updateChatInfo());var u=a.history;if(this.infoPanel&&this.infoPanel.updateData({sn:this.mail,friendly:this.nick,uNick:this.uNick,mute:g.mute,official:g.official,lastseen:g.lastseen,userState:g.userState,activeChat:!0,historyAvailable:!!(u&&u[0]&&u[0]instanceof Array&&u[0][0]),bot:g.bot}),this.updateNoInputState(),this.history){if(!this.history.stickToUnread&&k&&(this.history.stickToUnread=!0,a.historyLoaded||this.history.showMasterSpinner()),this.jumpingToMessage){if(this.jumpingToMessage.mail===this.mail){var v=this.jumpingToMessage,w=v.archId,x=v.skipBlinking;a.historyLoaded!==!0?(this.history.showMasterSpinner(),this.history.waitForMessage(w,x)):this.history.scrollUpToMessage(w,!1,x)}delete this.jumpingToMessage}if(a.historyLoaded&&(this.history.hideMasterSpinner(),this.isFavorite&&a.history&&(!a.history[0]||!a.history[0][0]))){var y=_WA105.configurator.getOption("client_name"),z="myteam"===y?"firstFavoriteMessageBusiness":"firstFavoriteMessage",A=_WA105.urlBuilder.favoriteFirstMessageImageLink();this.messageEvent.fire(_WA105.ACTIVE_MAIL,_WA105.tr(z,[_WA105.DialogsAbstraction.nick,A]))}j?(this._uniq=a.modifDate,this.history.renderHistory(a,k,e)):this.history.updateGoDownButton(a.unreadCount)}this._updateHistoryWithScrollCorrection(function(){f.isChat&&(f._updatePinnedMessage(a.pinned,a.cast),f._togglePinnedMessage(!a.collapsePinned)),f._toggleStrangerBar(a.stranger)})}},{key:"_onSendFileDialogCallback",value:function(a,b,c){var d=c&&JSON.stringify(c)||"";if(encodeURIComponent(b+d).length>_POST_MAX_LENGTH)return this._showLimitAlert(),!1;var e=[],f=b.replace(_REGEX_MENTION_HOLDER,function(a,b){return e.push(b),"@["+b+"]"});this.textarea&&this.textarea.resetTopMessages("quote"),this._sendFileBundle(a,{caption:f,mentions:e,quotes:c})}},{key:"_onChooseFiles",value:function(a,c){var d=this,e=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(c){var f=e.quotes,g=f&&JSON.stringify(f)||"";if(encodeURIComponent(g).length>_POST_MAX_LENGTH)return this._showLimitAlert(),!1;this._sendFileBundle(a,{quotes:f})}else{var h=_AS3.getOption(_AS3.OPTION_SEND_BY_ENTER),i=b.openSendFileDialog(a,e.message,h,function(a,b){var c=e.quotes;d._onSendFileDialogCallback(a,b,c),e.message=""});i.hideEvent.on(function(){e.message&&d.textarea&&(d.textarea.field.val(i.textBoxLastValue||e.message,!0),d.textarea.field.focus(!0))})}}},{key:"_sendFileBundle",value:function(a,b){b.caption&&_U91.Mnt.countRB(33783241),a.length>1&&b.caption&&(this.submitMessage(b.caption,b),b={caption:""}),_WA105.fileTools.sendFiles(this.mail,a,b)}},{key:"_updateHistoryWithScrollCorrection",value:function(a){a&&(this.history?this.history.updateHistoryWithScrollCorrection(a):a())}},{key:"_toggleStrangerBar",value:function(a){this.winEl.toggleClass("im-dialog_stranger",!!a),this.history&&this.history.scrollBar.sync()}},{key:"_togglePinnedMessage",value:function(a,b){this._pinnedMessage&&(this.winEl.toggleClass("im-dialog_pinned-collapsed",!a),this._pinnedMessage.toggleClass("im-pin-bar_collapsed",!a),this.history&&this.history.scrollBar.sync(),b&&this.pinToggleEvent.fire(this.mail,!!a))}},{key:"_updatePinnedMessage",value:function(a,b,c){if(this.isChat&&(this._pinnedMsgId||a)&&(c||!this.__waitForMessageToBePinned||a&&this.__waitForMessageToBePinned===a.msgId))if(c?this.__waitForMessageToBePinned=a.msgId:delete this.__waitForMessageToBePinned,this.winEl.toggleClass("im-dialog_pinned",!!a),delete this._pinnedWaitData,this._pinnedMessage||(this._pinnedMessage=this.winEl.getSelector(".imPinBar")),a){var d,e,f,g,h,i,j,k,l="",m="",n=a.text||"",o="",p="",q="";if(a.parts&&a.parts.length)for(e=a.parts.length;e--;){if(h=a.parts[e],h.contact){k=h.contact;break}if(h.text||h.stickerId){n=h.text||"",i=h.stickerId;break}}i=i||a.sticker&&a.sticker.id,k=k||a.contact;var r;if(k)g=_WA105.snippet.getContactTextSafeHtml(),o=g+": "+_U91.String.htmlEntity(k.name);else if(i)o=_WA105.tr("sticker.sticker"),j=_WA105.Sticker.getStickerPreviewUrl(i,30),m="im-pin-bar-widget_sticker";else{var s;r=_WA105.MessageFormatter.replaceUrlsInText(n,function(a,b,c){if(_WA105.snippet.resolveLinkAsContact(a))return _WA105.snippet.getContactTextSafeHtml();var d=_WA105.fileTools.resolveLinkAsFileText(a);if(d)return d;var e=_WA105.snippet.getContentType(a);return e.match(/image|gif/)?_WA105.tr("cl.photo"):a});var t=r.links[0]&&r.links[0].href;g=_WA105.fileTools.resolveLinkAsFileText(t||n),g?(o=t&&r.mixedContent?"":g,e=_WA105.fileTools.resolveLinkAsFile(t||n,!0,!0),q=e.id,j=_WA105.fileTools.getPreviewUrl(q,!1,e.url),j||(this._pinnedWaitData={fileId:q}),_WA105.fileTools.isVideoFile(q)?f="video":_WA105.fileTools.isStickerFile(q)?f="sticker":_WA105.fileTools.isImageFile(q)&&(f="image"),m="imFile"):(g=_WA105.snippet.resolveLinkAsContactText(n),g?(s=n,o=_U91.String.htmlEntity(_WA105.snippet.getTitle(s)),o?o=g+": "+o:(o=g,this._pinnedWaitData={url:s,waitForTitle:!0}),p=s):(s=_WA105.DialogsAgent.extractUrlFromMessage(a.msgId,n),s&&(f="link",_WA105.snippet.resolveLinkAsContact(s)||(j=_WA105.snippet.getPreviewUrl(s),j||(this._pinnedWaitData={url:s})),p=s,m="imSnippet")))}j&&(l="background-image:url("+_U91.String.encodeHref(_U91.String.ensureHttpsUrl(j))+")",m+=" im-pin-bar-widget_preview"),f&&(m+=" im-pin-bar_"+f),(j||i||f)&&(m+=" im-pin-bar-widget_hover"),o||(n=r?r.text:n,o=_WA105.MessageFormatter.buildPlainHtmlMessage(_U91.String.encodeAmp(n.substring(0,400)),!0),a.parts&&a.parts&&a.parts[0]&&a.parts[0].poll&&(o=_WA105.tr("polls.poll")+": "+o)),a.mentions&&_U91.Array.each(a.mentions,function(a){var c=_WA105.CLD.getFriendlyName(a)||b&&b[a]&&b[a].nick||a;o=o.replace(new RegExp("\\@\\["+a.replace(/\./g,"\\.")+"\\]","g"),_WA105.Emoji.parse(_U91.String.htmlEntity(c)))}),d=_WA105.CLD.getFriendlyName(a.chat.sender),!d&&b&&b[a.chat.sender]&&(d=b[a.chat.sender].nick);var u=_TD34.parseSafe("dialogPinnedMessage",[a.msgId,_WA105.Emoji.parse(_U91.String.htmlEntity(d||a.chat.sender)),o,l,m,q,_U91.String.encodeHref(p),encodeURIComponent(p)],{safeKeys:["1","2","3","6","7"]});this._pinnedMsgId=a.msgId,this._pinnedMessage.updateHTML(u)}else this._pinnedMsgId=null,this._pinnedMessage.updateText("")}},{key:"_preRenderPinnedMessage",value:function(a,b,c,d){var e=this;this._updateHistoryWithScrollCorrection(function(){c?e._updatePinnedMessage(null):(e._updatePinnedMessage({msgId:d.arch_id,text:d.text,parts:d.parts,sticker:d.sticker&&{id:d.sticker}||null,mentions:d.mentions,chat:{sender:d.sender||d.from}},null,!0),e._togglePinnedMessage(!0))}),this.pinMessageEvent.fire(a,b,c,d)}},{key:"_onSideScrolledEvent",value:function(a){this.sideScrolledEvent.fire(a)}},{key:"_updatePinnedData",value:function(){if(this._pinnedWaitData&&this._pinnedMessage){var a;if(this._pinnedWaitData.url)if(this._pinnedWaitData.waitForTitle){var b=_U91.String.htmlEntity(_WA105.snippet.getTitle(this._pinnedWaitData.url));b&&(this._pinnedMessage.getSelector(".im-pin-bar-text").updateHTML("".concat(_WA105.tr("cl.contact"),": ").concat(b)),delete this._pinnedWaitData)}else a=_WA105.snippet.getPreviewUrl(this._pinnedWaitData.url);else a=_WA105.fileTools.getPreviewUrl(this._pinnedWaitData.fileId,!0);if(a){var c=this._pinnedMessage.getSelector(".imPinBarWidget");c.setStyle("background-image","url("+_U91.String.ensureHttpsUrl(a)+")"),c.addClass("im-pin-bar-widget_preview"),delete this._pinnedWaitData}}}},{key:"updateChatInfo",value:function(){this.chatRole=!1,this.isChat&&this.updateSubtitle(_WA105.tr("chat.membersListLoading")),this.isChat&&_WA105.chatController.getChatInfo(this.mail,_REQUEST_CHAT_MEMBERS_LIMIT)}},{key:"updateMembersList",value:function(a,b,c){if(this.isChat&&a===this.mail){var d=this._awaitChatInfoForFocus;delete this._awaitChatInfoForFocus,this.updateNoInputState();var e=b&&c?"readonly"===c.defaultRole:this.isChannel;if(b&&c.members&&c.you&&c.you.role){var f=!(!c.controlled||"admin"===c.you.role),g="readonly"===c.you.role;this.chatRole={locked:f,isAdmin:"admin"===c.you.role},this.chatRole.isModer=this.chatRole.isAdmin||"moder"===c.you.role,g&&this.textarea&&this.textarea.picturesMenu&&this.textarea.picturesMenu.hide(),this.dragDropArea&&g&&this.dragDropArea.disableDragDropMode();var h=_WA105.tr("chat.countMembers",{count:c.membersCount});c.membersCount<=1&&(h=e?_WA105.tr("chat.aloneSubscriber"):_WA105.tr("chat.aloneMember")),this.updateSubtitle(h);var i=this._topbar&&this._topbar.getSelector(".imPendingCounter");i&&i.updateText(c.pendingCount),this.winEl&&(this.winEl.toggleClass("im-dialogpage__has-pending",!(!this.chatRole.isModer||!c.pendingCount)),this.winEl.addClass("im-dialogpage_is_member")),_WA105.isDesktop&&d&&!g&&this.textarea&&!_WA105.boardMode&&this.textarea.focusField()}else{this.chatRole=!1,this.winEl&&this.winEl.removeClass("im-dialogpage_is_member"),this.textarea&&this.textarea.picturesMenu&&this.textarea.picturesMenu.hide(),this.dragDropArea&&this.dragDropArea.disableDragDropMode();var j=e?_WA105.tr("chat.outOfChannel"):_WA105.tr("chat.outOfGroup");40002===c&&(j=_WA105.tr("group.youAreBannedInGroup")),this.updateSubtitle(j)}}}},{key:"updateSubtitle",value:function(a){this._subMessage=a,this._subNameField&&this._subNameField.updateHTML(a)}},{key:"close",value:function(){if(_WA105.splitView)_WA105.Pane.hasOpenedBox()?_WA105.Pane.clear():(this.previousDialog&&this.previousDialog.mail===this.mail&&(this.previousDialog=this.previousDialog.prev||null),this.previousDialog?(this.previousDialog.restoring=!0,_WA105.ma.openDialog(_WA105.CLD.getInfoArray(this.previousDialog)||[this.previousDialog.mail,this.previousDialog.nick])):_WA105.Pane.clear());else if(App.isCurrentPage("dialog"))if(this.previousDialog&&this.previousDialog.mail===this.mail&&(this.previousDialog=this.previousDialog.prev||null),this.previousDialog&&!this.winEl)this.previousDialog.restoring=!0,_WA105.ma.openDialog(_WA105.CLD.getInfoArray(this.previousDialog)||[this.previousDialog.mail,this.previousDialog.nick]);else{App.back();var a=App.indexOfPage("dialog",!0);a>-1?App.isCurrentPage("dialog")?this.close():this._onPageVisible=function(){this.winEl&&this.onPageUnload(this.winEl.dom),this.previousDialog.restoring=!0,_WA105.ma.openDialog(_WA105.CLD.getInfoArray(this.previousDialog)||[this.previousDialog.mail,this.previousDialog.nick])}:this.previousDialog=null}}},{key:"open",value:function(a,b){if(_WA105.Emoji.initSmiles(),this.stackDialog(),_WA105.splitView)_WA105.Pane.hasOpenedBox()||this.previousDialog&&!this.previousDialog.restoring&&(this.previousDialog.next?this.previousDialog=null:this.previousDialog.next=a.mail),_WA105.Pane.loadChat(this,a);else{var c,d=this.winEl&&this.winEl.dom;if(this.previousDialog&&!this.previousDialog.restoring)if(this.previousDialog.next){c=App.indexOfPage("dialog");for(var e=!0;e;)e=App.spliceHistory(c,1),e=e&&e.length,c=App.indexOfPage("dialog");this.previousDialog=null,d&&this.onPageUnload(d),App.isCurrentPage("dialog")?this.onPageLoad(App.getPage().html,a):App.load("dialog",a,b)}else this.previousDialog.next=a.mail,d&&this.onPageUnload(d),App.isCurrentPage("dialog")?App.forceLoad("dialog",a,b):App.load("dialog",a,b);else d&&this.onPageUnload(d),App.isCurrentPage("dialog")?this.onPageLoad(App.getPage().html,a):App.load("dialog",a,b)}}},{key:"refreshWindow",value:function(){this._opened&&this._cachedDialog&&this.updateWindow(this._cachedDialog,!0)}},{key:"updateView",value:function(a,c,d){if(a.focused){var e=b.getFocusedIndex(a.dialogs,a.focused),f=a.dialogs[e],g=App.getPage();g=g&&"dialog"===g.name||_WA105.splitView,this._opened!==a.focused?(this._opened=a.focused,this._onPageVisible=null,this.open(f,this._firstUpdateView)):this.checkForChanges(f)&&(g&&this._pageLoaded?this.updateWindow(f,!1,!1,d):this._onPageVisible=function(){this._onPageVisible=null,this.updateWindow(f,!1,!1,d)}),this._cachedDialog=f}else this._opened&&(this._opened=!1,this.close());delete this._firstUpdateView}},{key:"updateUnreadCounter",value:function(a,b){if(this._unreadMessagesCounter){_WA105.splitView&&(a=0);var c=a>999?"1k":_U91.String.htmlEntity(a);b&&!c&&(c='<div class="im-msg-counter__unread-symbol"></div>'),this._unreadMessagesCounter.updateHTML(c||"")}}},{key:"deactivate",value:function(){this.backEvent.removeAll(),this.previousDialog=null,this._opened=!1,this.close(!0)}},{key:"_onNavigationBack",value:function(a){return"dialog"===a.pageName&&this.infoPanel&&this.infoPanel.isShown()?(this.infoPanel.close(),!1):!(App.isCurrentPage("main")&&_WA105.splitView&&!_WA105.Pane.hasOpenedBox()&&this.previousDialog&&this.winEl)||this._mediaPlayer&&this._mediaPlayer.isVisible()||this.textarea&&this.textarea.picturesMenu&&this.textarea.picturesMenu.isVisible()||_WA105.contextMenu.isVisible()||_UI56.ModalComponent.isShown()?void 0:(this.onPageUnload(this.winEl.dom),!1)}},{key:"_onPageChange",value:function(a){"dialog"===a.newPage&&a.isBack&&!_WA105.splitView&&this._keepSidebarPosition&&this.toggleSidebar(!0,!0)}},{key:"_onPageShow",value:function(a){"dialog"===a.pageName&&(this.textarea&&this.textarea.restoreState(),this._onPageVisible&&this._onPageVisible())}},{key:"_onPageHide",value:function(a){"dialog"===a.pageName&&this.infoPanel&&(this._keepSidebarPosition=this.infoPanel.isShown(),this.toggleSidebar(!1,!0))}},{key:"_showContextMenu",value:function(a,b,c,d){a&&_WA105.contextMenu.show(d,a,{mail:b.sn,chat_id:this.mail,nick:b.nick,msgText:b.msgText,origUrl:b.origUrl,downloadUrl:b.downloadUrl,message:c,contact:_WA105.CLD.getInfoArray(b.sn)||_WA105.makeContactArray(b.sn,b.nick,1)},this._onContextMenuAction.bind(this))}},{key:"_onContextMenuAction",value:function(a,b){var c=a.message;switch(b){case"pinMessage":case"unpinMessage":this._preRenderPinnedMessage(this.mail,c.arch_id,"unpinMessage"===b,c);break;case"delForAll":this.deleteMessageEvent.fire(this.mail,c.arch_id,!0);break;case"delMessage":case"delForMe":this.deleteMessageEvent.fire(this.mail,c.arch_id);break;case"mention":this.textarea.addMention(a.mail,a.nick);break;case"reply":this.quoteMessage(a);break;case"pollRecall":case"pollStop":var d=c.poll&&c.poll.id||c.parts&&c.parts[0].poll.id;"pollRecall"===b?_WA105.Polls.revoke(d):_WA105.Polls.stop(d);break;case"saveAs":window.location=a.downloadUrl;break;case"openInBrowser":window.open(a.origUrl);break;case"copyText":_U91.Selection.copy2clipboard(a.msgText);break;case"copyLink":_U91.Selection.copy2clipboard(a.origUrl),_WA105.showPopup(_WA105.tr("msgLinkCopied"));break;case"copyEmail":_U91.Selection.copy2clipboard(a.origUrl),_WA105.showPopup(_WA105.tr("msgEmailCopied"));break;case"resend":c&&this._forwardMessage(c);break;case"toFavorite":c&&this._forwardMessage(c,!0);break;case"edit":this.editMessage(a);break;case"goToMessage":_WA105.splitView||(this.toggleSidebar(!1),this._galleryView&&this._galleryView.hide()),this.scrollUpToMessage(a.message.mid);break;case"goToProfile":_WA105.contactAbstraction.getUserProfile(a.origUrl,function(a){if(a&&a.email){var b=_WA105.ma.openDialog([a.email,a.nickname],!1,!0);b||_WA105.ma.openProfile({mail:a.email,nick:a.nickname})}else _WA105.showPopup(_WA105.tr("msgNoProfileWithThisEmail"))});break;default:_WA105.chatController.chatMemberAction(a,b)}}},{key:"_onContextmenu",value:function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o=a.getTarget(!0),p=null;o.up("im-messages__avatar_flow")&&this.history&&this.history.flowAvatar&&this.history.flowAvatar.currentItem&&(o=_DomUtil52.get(this.history.flowAvatar.currentItem.el).getSelector(".im-avatarbox")||o);var q=o.up("imMessage"),r=q?o.up("im-avatarbox"):null;if(q){if(q.hasClass("im-message_event"))return;if(r&&o.up("im-file-author"))return;b=q.getAttribute("data-from"),c=q.getAttribute("data-nick"),e=q.hasClass("im-message_self"),g=q.hasClass("im-message_sticker"),f=q.hasClass("im-message_file"),h=r||g||f,k=!1;var s=h||o.up("im-message__text");if(s&&o.hasClass("im-message__textblock")){var t=_U91.Selection.getSelection();if(t&&!t.isCollapsed)return}var u=q.getSelector(".imFile"),v=o.up("imSnippetLink");v?(v=v.up("imSnippet"),v&&(l=v.getAttribute("data-url"),j=v.getAttribute("data-content"),j="image"===j||"gif"===j),l?(l=decodeURIComponent(l),v=null):v=o.up("imSnippetLink")):v=o.up("imRawLink"),v&&(l=v.getAttribute("data-orig"),l=l?decodeURIComponent(l):v.getAttribute("href"));var w=o.up("imPollCard"),x=w&&w.getAttribute("data-id");x&&(p={canStop:_WA105.Polls.isStoppable(x),canRecall:_WA105.Polls.isRecallable(x)});var y=o.up("imQuote");y&&(u=y.getSelector(".imFile"),g=y.hasClass("im-message_sticker"),f=y.hasClass("im-message_file"));var z=o.up("im-message-quote__reply");if(z&&(u=z.getSelector(".imFile"),g=z.hasClass("im-message_sticker"),f=z.hasClass("im-message_file")),u=o.up("imFile")||u,d=q.getSelector(".im-message-quote__reply "),d&&(d={el:d,isSticker:d.hasClass("im-message_sticker")
},d.isFile=d.isSticker||d.el.hasClass("im-message_file")),u){var A=u.getAttribute("data-file-id");if(g=_WA105.fileTools.isStickerFile(A))l=!1;else{var B=_WA105.fileTools.getLocalFileInfo(A);B&&(m=B.url,l=l||B.orig_url,j=B.is_previewable)}}}else{if(!r)return;b=r.getAttribute("data-sn"),c=r.getAttribute("data-nick"),e=r.hasClass("im-members-self")}var C=r?"profile":"message";if(b){var D=this.winEl.hasClass("im-dialogpage_readonly"),E=q&&this.history&&this.history.getMessageByElement(q);!l&&E&&!g&&E.text&&_WA105.urlBuilder.REG_EXACT_URL.test(E.text)&&(l=E.text),n=!g&&E&&E.text||!1,n=n&&n.replace(_WA105.urlBuilder.REGEX_STICKER,_WA105.tr("sticker.sticker"));var F=E.parts&&E.parts[E.parts.length-1],G={sn:b,readOnly:D,outgoing:e,msgText:n,origUrl:l,isPreviewable:j,downloadUrl:m,poll:p,pinned:E&&this._pinnedMsgId&&this._pinnedMsgId===E.arch_id,moder:this.isChat&&this.chatRole&&this.chatRole.isModer,admin:this.isChat&&this.chatRole&&this.chatRole.isAdmin,editable:e&&!h&&(!d||!d.isFile)&&E&&!D&&!E.contact&&(!F||"text"===F.mediaType&&!F.contact&&(F.text||F.captionedContent))&&(this.isFavorite||_WA105.now()-E.date<EDITING_AVAILABLE_TIME)};i=this._buildMenuItems(C,G),this._showContextMenu(i,{sn:b,nick:c,msgText:n,origUrl:l,downloadUrl:m},E,a),a.stopEvent()}}},{key:"_buildMenuItems",value:function(a,b){var c={};switch(a){case"profile":if(b.outgoing||this.isChat&&b.sn===this.mail)break;c.profile=!0,c.spam=!_WA105.configurator.getOption("disable_remove_user_button");var d=_WA105.CLD.inList(b.sn);if(this.isChat){var e=_WA105.chatController.getMemberRole(this.mail,b.sn);c.mention=!_WA105.MainAgent.isChat(b.sn),c.add=!d,b.moder&&("admin"!==e&&"moder"!==e||b.admin)&&(c.removeAndBlock=!0,c.allowWriting="readonly"===e,c.forbidWriting="readonly"!==e,c.removeAdminRights=b.admin&&("admin"===e||"moder"===e),c.giveAdminRights=b.admin&&!("admin"===e||"moder"===e))}else c.mention=d,c.ignore=d,c.remove=d;break;case"message":c.reply=!b.readOnly,c.resend=!0,c.toFavorite=!this.isFavorite,c.saveAs=!!b.downloadUrl,c.copyText=_WA105.clipboardSupported&&!b.origUrl&&b.msgText,c.copyLink=!c.saveAs&&_WA105.clipboardSupported&&b.origUrl,c.copyObject=_WA105.clipboardSupported&&!1,c.openInBrowser=b.isPreviewable&&c.copyLink,c.edit=!!b.editable&&!b.poll,c.delMessage=this.isFavorite,c.delForMe=!this.isFavorite,c.delForAll=!this.isFavorite&&(b.moder||b.outgoing)&&!b.readOnly,c.pinMessage=this.isChat&&(!this.chatRole.locked||b.moder)&&!b.pinned,c.unpinMessage=this.isChat&&(!this.chatRole.locked||b.moder)&&b.pinned,c.goToProfile=c.copyLink&&b.origUrl.match(_WA105.urlBuilder.REG_EXACT_EMAIL),c.pollRecall=b.poll&&b.poll.canRecall===!0,c.pollStop=b.poll&&b.poll.canStop===!0,c.goToProfile&&(delete c.copyLink,c.copyEmail=!0)}if(_WA105.boardMode){var f={};return BOARD_MODE_CONTEXT_MENU_ACTIONS.forEach(function(a){f[a]=c[a]}),f}return c}},{key:"_forwardMessage",value:function(a,b){if(!_WA105.boardMode&&a){var c=a.parts&&JSON.stringify(a.parts)||a.text;if(encodeURIComponent(c).length>_POST_MAX_LENGTH)return void this._showLimitAlert();var d=_WA105.chatController.getCachedChatInfo(a.sn),e=d?"readonly"===d.defaultRole:this.isChannel;if(e&&(a=_U91.Object.extend({},a,!0),a.from=a.sn,delete a.sender,delete a.senderFriendly),b){this.messageEvent.fire(_WA105.ACTIVE_MAIL,a,{from:this.mail,nick:this.nick});var f=_WA105.showPopup(_WA105.tr("dialog.msgSentToFavorite",[_TD34.parseSafe("linkButton",{action:"favorite",cls:"im-popup-link",text:_WA105.tr("dialog.favorite")})]),void 0,!0);f.clickEvent.on(function(a){var b=a.getTarget(!0),c=b&&b.up("imButton");c&&(_WA105.ma.openDialog([_WA105.ACTIVE_MAIL]),a.preventDefault())})}else{var g=a.parts&&!a.parts.filter(function(a){var b=a.mediaType;return"forward"!==b}).length;this.forwardLinkEvent.fire(this.mail,this.nick,a,this.isFavorite&&!g)}}}},{key:"_openUrl",value:function(a,b,c){var d=_WA105.fileTools.resolveLinkAsFile(a);if(!d){var e=_WA105.snippet.getContentType(a),f="image"===e||"gif"===e?_WA105.snippet.getPreviewUrl(a):null;f&&(d=_WA105.fileTools.emulateFileObjForPreview(f,"image/"+e,a))}d?this._openFilePreview(d,b,c):window.open(a)}},{key:"_openFilePreview",value:function(a,b,c){var d;if("object"===_typeof2(a)&&a.mediumPreview)d=a;else{if(_WA105.fileTools.isStickerFile(a))return this.openShowcase(a,"fileId"),!0;d=_WA105.fileTools.getLocalFileInfo(a)}if(d&&d.is_previewable){null==this._mediaPlayer&&(this._mediaPlayer=new _UI56.GalleryPreview({autoRender:_DomUtil52.getBody(),fadeIn:!0,modal:!0}),this._mediaPlayer.forwardEvent.on(this._forwardMessage,this));var e=d.id||d.orig_url||d.url,f=_WA105.gallery.getItem(this.mail,b,e);if(!f&&b){var g=this.history&&this.history.getMessageByIndexAndId(!1,b);g&&(f={url:e,id:{mid:b,seq:0},author:{friendly:g.senderFriendly,firstName:g.sender,lastName:"",aimId:g.sender},time:g.date})}return this._mediaPlayer.open(d,{sn:this.mail,mid:b,url:f&&f.url||e,item:f,typeKey:c},{})}return!1}},{key:"_pttPlay",value:function(a){var b=a.up("imFile"),c=b.getAttribute("data-file-id"),d=b.getAttribute("data-ready");d?_WA105.mediaPlayer.play(b.getAttribute("data-context-id")+"_"+c,b.getAttribute("data-url")):_WA105.showPopup(_WA105.tr("dialog.msgRecordIsNotReadyYet"))}},{key:"_pttToggleSpeech",value:function(a,b,c,d){var e=a.up("imFile"),f=e.getAttribute("data-file-id"),g=e.getAttribute("data-context-id")+"_"+f;e=e&&e.getSelector(".imPttBox");var h=e&&e.getSelector(".imPttSpeech");if(c&&c(g,!e.hasClass("im-file__ptt-speech_opened")),e.hasClass("im-file__ptt-speech_opened")){var i=h.getHeight();e.removeClass("im-file__ptt-speech_opened"),d&&d(-i)}else a.updateHTML(this.spinnerTMPL).addClass("imPttWait"),_WA105.fileTools.getSpeech(f,function(a,c){var e=b("imPtt_"+g);if(e){e.getSelector(".imPttTranslate").updateHTML("<span></span>").removeClass("imPttWait");var f=e.getSelector(".imPttSpeech");if(a){f.updateHTML(_WA105.Emoji.discover(_U91.String.htmlEntity(a))),e.addClass("im-file__ptt-speech_opened");var h=f.getHeight();d&&d(h)}else{var i=_WA105.tr("dialog.msgFailedToRecognize");202===c&&(i=_WA105.tr("dialog.msgFailedToRecognizeTryLater")),_WA105.showPopup(i)}}}.bind(this))}},{key:"hasPttRecord",value:function(){return this.textarea&&this.textarea.hasPttRecord()}},{key:"editMessage",value:function(a){if(a.message){var b=a.message.arch_id&&a.message;if(this.textarea&&b){var c=b.text;if(b.parts){var d=b.parts[b.parts.length-1];"text"===d.mediaType&&(c=d.captionedContent?d.captionedContent.caption:d.text)}this.textarea.setEditMessage(b,c)}}}},{key:"quoteMessage",value:function(a){if(a.message){var b=a.message.arch_id&&a.message;this.textarea&&this.textarea.setQuotedMessage(b,a.nick)}}},{key:"onShowSmilesMenu",value:function(){var a=this;this.textarea&&!this.textarea.getIgnoreFocusEventFlag()&&(this.winEl.addClass("im-pictures_opened"),this.history&&this.history.hideSmartReply(),this._winSize=this.getWinSize(),this._keyboard?(this.textarea.setMenuSize(this._keyboard),this._checkInputMaxSize()):(this.textarea.setMenuSize(this._keyboardSize[this._orientation]||Math.min(MAX_SMILES_MENU_HEIGHT,2*this.winEl.getHeight()/5)),_WA105.setTimeout(function(){!a._keyboard&&a.winEl.hasClass("im-pictures_opened")?a._holdSizes(a.textarea.getMenuSize()):a._checkInputMaxSize()},100)))}},{key:"_holdSizes",value:function(a,b){this._releaseSizes();var c=MIN_HISTORY_HEIGHT;(this.winEl.hasClass("im-dialog_stranger")||this.winEl.hasClass("im-dialog_pinned"))&&(c+=TOP_SUB_BAR_HEIGHT);var d=Math.max(this._content.getHeight()-a,c);this._content.setStyle("height",d+"px"),this.textarea&&this.textarea.el.parent().setStyle("top",this._bottombar.dom.offsetTop-a+"px"),this._contentSizeHolded=!0,this.history&&(this.history.scrollDownOn(a?a:b||0),this.history.updateVisibleArea(!0)),this._checkInputMaxSize()}},{key:"_releaseSizes",value:function(){var a=this._content.getHeight();this._content.setStyle("height","auto"),this.textarea&&this.textarea.el.parent().setStyle("top","auto"),this._contentSizeHolded=!1,this._onTextfieldResize();var b=this._content.getHeight()-a;return this.history&&(b&&this.history.scrollDownOn(-b),this.history.updateVisibleArea(!0)),b}},{key:"onHideSmilesMenu",value:function(a){this.textarea&&!this.textarea.getIgnoreFocusEventFlag()&&(this.winEl.removeClass("im-pictures_opened"),this.history&&this.history.tryToShowSmartReply(),this._releaseSizes(),this._keyboard&&this._holdSizes(this.textarea.getIOSKeyboardSize()&&this._keyboard||0))}},{key:"onShowPttRecorder",value:function(){this.winEl.addClass("im-ptt-recorder_active"),this.history&&this.history.hideSmartReply()}},{key:"onHidePttRecorder",value:function(){this.winEl.removeClass("im-ptt-recorder_active"),this.history&&this.history.tryToShowSmartReply()}},{key:"onTopInputMessageToggle",value:function(a){a?(this.winEl.addClass("im-input-top-message_available"),this.history&&this.history.hideSmartReply()):(this.winEl.removeClass("im-input-top-message_available"),this.history&&this.history.tryToShowSmartReply())}},{key:"getWinSize",value:function(){return{width:window.innerWidth,height:window.innerHeight}}},{key:"_resizeChecker",value:function(){this._resizeCheckerTimer&&clearTimeout(this._resizeCheckerTimer);var a=this._winSize;this._winSize=this.getWinSize(),this._winSize.width!==a.width&&this._winSize.height!==a.height?this.onOrientationChange():this._winSize.width===a.width&&this._winSize.height!==a.height&&this.onKeyboardToggle(a.height>this._winSize.height,a.height-this._winSize.height),this._resizeCheckerTimer=_WA105.setTimeout(this._resizeChecker,100,this)}},{key:"onResize",value:function(){var a=this;this._resizeDelay&&clearTimeout(this._resizeDelay),this._resizeDelay=_WA105.setTimeout(function(){a._resizeDelay=!1;var b=a._winSize;if(a._winSize=a.getWinSize(),_WA105.splitView){var c=Math.max(b.height,_WA105.MIN_WINDOW_HEIGHT)-Math.max(a._winSize.height,_WA105.MIN_WINDOW_HEIGHT);if(c&&a._contentSizeHolded){var d=MIN_HISTORY_HEIGHT;(a.winEl.hasClass("im-dialog_stranger")||a.winEl.hasClass("im-dialog_pinned"))&&(d+=TOP_SUB_BAR_HEIGHT);var e=a._content.getHeight(),f=Math.max(e-c,d);a._content.setStyle("height",f+"px"),a._bottombar.setStyle("top",a._bottombar.dom.offsetTop-c+"px"),a._checkInputMaxSize()}a._winSize.width>b.width||a._winSize.height>b.height?a.history&&a.history.updateVisibleArea(!0):(a._winSize.width!==b.width||a._winSize.height!==b.height)&&a.isChat&&a.history&&a.history.flowAvatar&&a.history.flowAvatar.onUpdateVisible()}else a._winSize.width!==b.width&&a._winSize.height!==b.height?a.onOrientationChange():a._winSize.width===b.width&&a._winSize.height!==b.height&&a.onKeyboardToggle(b.height>a._winSize.height,b.height-a._winSize.height);a.textarea&&a.textarea.onResize()},10)}},{key:"onKeyboardToggle",value:function(a,c){if(_WA105.isTouchDevice){if(b.resizeSendFileDialog(),a){if(this._keyboard&&c<this._keyboard)this._keyboard+=c;else{if(MIN_SMILES_MENU_HEIGHT>c)return;this._keyboard=c}this._keyboardSize[this._orientation]=this._keyboard,this.winEl.hasClass("im-pictures_opened")?this.textarea&&this.textarea.toggleMenu():this._holdSizes(this._keyboard&&this.textarea&&this.textarea.getIOSKeyboardSize()&&c||0,c)}else{if(this._keyboard&&Math.abs(c)<this._keyboard)return void(this._keyboard+=c);this._keyboard=0,this.textarea&&this.textarea.blurField(),this.winEl.hasClass("im-pictures_opened")||this._releaseSizes()}document.body.scrollTop=0}}},{key:"onOrientationChange",value:function(){if(this._orientation=this._winSize.height>this._winSize.width?"portrait":"landscape",this.textarea&&this.textarea.resetIOSKeyboardSize(),b.resizeSendFileDialog(),this.winEl.hasClass("im-pictures_opened")){var a=this._keyboardSize[this._orientation]?this._keyboardSize[this._orientation]:Math.min(MAX_SMILES_MENU_HEIGHT,2*this._winSize.height/5);this.textarea&&this.textarea.setMenuSize(a),this._holdSizes(this.textarea&&this.textarea.getMenuSize()||0)}else this._keyboard&&this._holdSizes(0)}},{key:"onThemeSwitch",value:function(){this.textarea&&this.textarea.onThemeSwitch()}},{key:"_onTextareaFocus",value:function(){var a=this;this.textarea.getIgnoreFocusEventFlag()||(this.textarea.getIOSKeyboardSize()?this.onKeyboardToggle(!0,this.textarea.getIOSKeyboardSize()):_WA105.setTimeout(function(){a.winEl&&!a.winEl.hasClass("im-pictures_opened")&&(a.textarea.calculateIOSKeyboardSize(),a.textarea.getIOSKeyboardSize()&&a.onKeyboardToggle(!0,a.textarea.getIOSKeyboardSize()))},500))}},{key:"_onTextareaBlur",value:function(){var a=this;this.textarea.getIgnoreFocusEventFlag()||_WA105.setTimeout(function(){a.textarea.getIOSKeyboardSize()&&a.onKeyboardToggle(!1,-a.textarea.getIOSKeyboardSize())},0)}},{key:"openStickerMenu",value:function(a,b){this.textarea.openStickerMenu(a,b)}},{key:"openShowcase",value:function(a,b){this.textarea.openShowcase(a,b)}},{key:"_showLimitAlert",value:function(a){_WA105.showPopup(a||_WA105.tr("msgTooLong"))}},{key:"_onTypingNotifyCheck",value:function(a){var b=+new Date;a&&(this.mail=a),this._typingInfo&&b-this._typingInfo.date<9e3?(this.typingEvent.fire(this.mail),this.typingNotifyChecker.start()):this.typingNotifyChecker.stop()}},{key:"_checkInputMaxSize",value:function(){var a=this.textarea.el.dom.offsetHeight;if(a){var b=this._bottombar.dom.offsetTop+this._bottombar.dom.offsetHeight,c=this.textarea.getInputFieldHeight(),d=0;(this.winEl.hasClass("im-dialog_stranger")||this.winEl.hasClass("im-dialog_pinned"))&&(d=TOP_SUB_BAR_HEIGHT);var e=this._topbar.dom.offsetHeight+d+a-c,f=b-e,g=f-MIN_HISTORY_HEIGHT;this.winEl.hasClass("im-pictures_opened")&&this._winSize.height<=_WA105.MIN_WINDOW_HEIGHT&&g>MIN_WINDOW_HEIGHT_INPUT_MAX_HEIGHT&&(g=MIN_WINDOW_HEIGHT_INPUT_MAX_HEIGHT),this.textarea.setInputFieldMaxHeight(g)}}},{key:"_onTextfieldResize",value:function(){var a=this.textarea.el.dom.offsetHeight;if(a){this._checkInputMaxSize(),a=this.textarea.el.dom.offsetHeight;var b=parseInt(this._content.dom.style.bottom||this._content.getStyle("bottom"));this._content.setStyle("bottom",a-1+"px");var c=parseInt(this._content.dom.style.bottom||this._content.getStyle("bottom"))-b;this._contentSizeHolded&&this._content.setStyle("height",this._content.getHeight()-c+"px"),this.history&&(c&&this.history.scrollDownOn(c),this.history.scrollBar.sync())}}},{key:"_onMessageChanged",value:function(a){var b=a.length,c=!1;b&&(this._typingInfo={date:+new Date,mail:this.mail},this.typingNotifyChecker.isStarted()||this._onTypingNotifyCheck(this.mail),"@"!==a.charAt(b-1)||1!==b&&!a.charAt(b-2).match(/\s/)||(c=!0))}},{key:"_onMessageOverflow",value:function(a){this._showLimitAlert(a)}},{key:"scrollUpToMessage",value:function(a,b){this.history&&this.history.scrollUpToMessage(a,b)}},{key:"jumpToEnd",value:function(){this.jumpingToMessage=!1,this.history&&this.history.jumpToEnd()}},{key:"getLastViewedMessageId",value:function(){return this.history&&this.history.getLastViewedMessageId()}},{key:"tryToReadLastVisibleMessage",value:function(){this.history&&this.history.delayedCheckLastVisibleMessage()}},{key:"submitMessage",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},c=[a,b.quotes&&JSON.stringify(b.quotes)||"",b.poll&&JSON.stringify(b.poll)||"",b.contact&&JSON.stringify(b.contact)||""].join("");if(!(encodeURIComponent(c).length<_POST_MAX_LENGTH))return this._showLimitAlert(),!1;if(this.isChat&&b.quotes){var d=b.mentions||[];b.quotes.forEach(function(a){"quote"===a.mediaType&&a.sn!==_WA105.ACTIVE_MAIL&&d.push(a.sn)}),b.mentions=_U91.Array.unique(d)}var e={text:a,mentions:b.mentions};b.poll?e.poll=b.poll:b.contact&&(e.contact=b.contact),b.quotes?e.quotes=b.quotes:b.editedMessage&&(e.editedMessage=b.editedMessage),this.messageEvent.fire(this.mail,e),this.typingNotifyChecker.stop(),!b.editedMessage&&this.history&&this.history.jumpToEnd()}},{key:"_handleUrlClick",value:function(a){var b=_WA105.urlBuilder.stickersMatch(a);if(b&&b[1])return this.openShowcase(b[1],"storeId"),!0;if(_WA105.boardMode)return!1;var c=_WA105.urlBuilder.liveChatMatch(a);if(c&&c[1])return _WA105.LiveChats.showChatProfile({stamp:c[1]}),!0;var d=_WA105.urlBuilder.profileMatch(a);if(d&&d[1])return _WA105.ma.openProfile({mail:d[1]}),!0;var e=_WA105.urlBuilder.idLinkMatch(a);return e&&e[1]?(this._onPersonClick("","",e[1]),!0):void 0}},{key:"_onContactCardClick",value:function(a){var b=this,c=a.up("imSnippet"),d=c.getAttribute("data-sn"),e=c.getAttribute("data-name"),f=c.getAttribute("data-phone"),g=a.up("im-contact-card__action");if(g&&d)return this.mail!==d?_WA105.CLD.inList(d)?_WA105.ma.openDialog(_WA105.CLD.getInfoArray(d)):_WA105.MainAgent.isChat(d)?_WA105.chatController.getChatInfoByStamp(c.getAttribute("data-stamp"),5,!0,function(a,b,c,d){c?d["public"]?_WA105.ma.openDialog([d.sn,d.name]):_WA105.LiveChats.showChatProfile({stamp:b},!0):_WA105.LiveChats.showChatProfile({stamp:b})}):(_WA105.overlayScreen.show(_WA105.tr("chat.pleaseWait"),!0),_WA105.contactAbstraction.getUserProfile(d,function(a){_WA105.overlayScreen.hide(),a&&_WA105.ma.openDialog([d,e])})):this.history&&this.history.jumpToEnd(),!0;if(a.up("im-contact-card__title")||!d&&g){if(d&&_WA105.MainAgent.isChat(d))_WA105.LiveChats.showChatProfile({stamp:c.getAttribute("data-stamp")});else if(f)if(d)_WA105.overlayScreen.show(_WA105.tr("chat.pleaseWait"),!0),_WA105.contactAbstraction.getUserProfile(d,function(a){if(_WA105.overlayScreen.hide(),a){var c=new _WA105.ContactModalBox({phone:f,name:e,sn:d,lastseen:a.lastseen,userState:a.userState,bot:a.bot},{sn:b.mail,name:b.nick});c.show()}});else{var h=new _WA105.ContactModalBox({phone:f,name:e,sn:d},{sn:this.mail,name:this.nick});h.show()}else _WA105.ma.openProfile({mail:d,nick:e});return!0}}},{key:"_clickOnMessageButton",value:function(a){var b=a.getAttribute("data-action");switch(b){case"editInfo":if(this.isChat&&this.chatRole&&this.chatRole.isAdmin){var c=new _WA105.GroupSettingsBox({chatId:this.mail});c.show()}}}},{key:"_onHistoryInputChange",value:function(a){var b=a.getTarget(!0);if(b.up("im-message__buttons")){var c=b.up("imButton");if("editAvatar"===c.getAttribute("data-action")){var d=b.dom.files&&b.dom.files[0];if(!d)return;(d.type||"").match(/^image\/(?:jpeg|png|gif)$/)?d.size>_WA105.Ava.MAX_FILE_SIZE?(_WA105.showPopup(_WA105.tr("file.errorFileTooLarge")),b.dom.value=null):_WA105.rapi.uploadAvatar(d,{sn:this.mail}).then(function(a){a.id&&c.hide()},function(a){var b=413===a?"file.errorFileTooLarge":"file.errorFile";_WA105.showPopup(_WA105.tr(b))}):_WA105.showPopup(_WA105.tr("file.errorFile"))}}}},{key:"_historyClick",value:function(a,b,c){var d,e,f,g,h,i,j=b&&b.getAttribute("data-action");if("bot"===j&&!b.hasAttr("disabled"))return i=a.up("imMessage"),e=i&&i.getAttribute("data-arch-id"),g=decodeURIComponent(b.getAttribute("data-url")),_WA105.bots.clickButton({url:g,dialogSn:this.mail,archId:e,data:b.getAttribute("data-data"),index:parseInt(b.getAttribute("data-index"))}),!0;if("command"===j){if(this.isChat){var k=_WA105.chatController.getCachedChatInfo(this.mail);if(k){var l="readonly"===k.defaultRole;if(l||!k.you||"readonly"===k.you.role)return void _WA105.showPopup(_WA105.tr("bots.youAreNotMember"))}}return i=b.getAttribute("data-com"),this.submitMessage(i),!0}if(a.up("imCallCard"))return"callBack"===j&&(h=b.getAttribute("data-sn"),_WA105.Voip.startOutgoinCall(h,this.nick,"1"===b.getAttribute("data-video"))),!0;if(f=a.up("imMention"))return h=f.getAttribute("data-user"),d=f.getAttribute("data-id"),this._onPersonClick(h,"",d),!0;if(a.up("imForward"))return this.history&&(f=a.up("im-message"),i=this.history.getMessageByElement(f),this._forwardMessage(i)),c.stopEvent(),!0;if(a.up("imPttPlay"))return this._pttPlay(a),!0;if(a.up("imPollCard")&&_WA105.Polls.pollClick(a))return!0;if(b&&b.hasClass("imPttTranslate")&&!b.hasClass("imPttWait"))return this.history&&this._pttToggleSpeech(b,function(a){return this.history.getElementById(a)}.bind(this),function(a,b){pttSpeechVisibility[a]=b}.bind(this),function(a){this.history.scrollDownOn(a)}.bind(this)),!0;var m=a.up("imFile");if(m&&(!a.hasClass("imFileDrop")||a.up("im-file_play"))){a.hasClass("imFileDrop")&&c.stopEvent(),d=a.up("imFile").getAttribute("data-file-id");var n=a.up("im-file__circlebar");if(n&&"upload-abort"===n.getAttribute("data-action"))return _WA105.fileTools.abort(d),!0;if(i=a.up("imQuote"),i&&i.hasClass("im-message-quote")||(i=a.up("imMessage")),i=i&&this.history&&this.history.getMessageByElement(i),this._openFilePreview(d,i&&i.mid))return c.stopEvent(),!0}if(m=a.up("imSnippetLink")||a.up("imRawLink"),m&&(g=m.getAttribute("data-orig"),g=g?decodeURIComponent(g):m.getAttribute("href"),this._handleUrlClick(g)))return c.stopEvent(),!0;if(a.up("imSnippet")){g=decodeURIComponent(a.up("imSnippet").getAttribute("data-url"));var o=g?_WA105.snippet.getContentType(g):a.up("imSnippet").getAttribute("data-content");if("contact"!==o)return("image"===o||"gif"===o)&&(i=a.up("imMessage"),i&&i.hasClass("im-message-quote")||(i=a.up("imMessage")),i=i&&this.history&&this.history.getMessageByElement(i),g&&this._openUrl(g,i&&i.mid),c.stopEvent()),!0;if(this._onContactCardClick(a))return!0}if("sticker"===a.getAttribute("data-action"))return d=a.getAttribute("data-pack"),this.openShowcase(d),!0;if(a.up("im-message__buttons")&&b&&this._clickOnMessageButton(b),a.up("imPinBar")&&!a.up("imRawLink")){var p=this._pinnedMessage.hasClass("im-pin-bar_collapsed");return p||a.up("imPinBarToggle")?this._togglePinnedMessage(p,!0):(f=this._pinnedMessage.first(),this.scrollUpToMessage(f.getAttribute("data-arch-id"))),c.stopEvent(),!0}if(a.up("imQuote")&&!a.up("imRawLink")){if(f=a.up("imQuote"),e=f.getAttribute("data-arch-id"),f.hasClass("im-message-quote")&&this.scrollUpToMessage(e),f.hasClass("im-message-forward")){if(_WA105.boardMode)return!0;var q=f.getAttribute("data-chat")||f.getAttribute("data-from"),r=f.getAttribute("data-stamp"),s=_WA105.CLD.inList(q),t=a.up("imForwardFrom");if(t){var u=t.getAttribute("data-sn");if(u){if(u!==this.mail)if(_WA105.CLD.inList(u)){var v=_WA105.CLD.getInfoArray(u);_WA105.ma.openDialog(v)}else _WA105.MainAgent.isChat(u)?_WA105.LiveChats.showChatProfile({sn:d}):_WA105.ma.openProfile({mail:u});return c.stopEvent(),!0}}if(_WA105.MainAgent.isChat(q)&&(s||r))if(s)q===this.mail?this.scrollUpToMessage(e):(this.jumpingToMessage={fromMail:this.mail,mail:q,archId:e},this.jumpToMessageEvent.fire(e,_WA105.CLD.inList(q)&&_WA105.CLD.getInfo(q)));else{if(a.hasClass("imFileDrop"))return!0;_WA105.LiveChats.showChatProfile({sn:q,stamp:r})}else{var w=a.up("im-message");if(w=w&&w.getAttribute("data-from"),this.isFavorite||w===_WA105.ACTIVE_MAIL&&s&&!f.getAttribute("data-chat"))q===this.mail?this.scrollUpToMessage(e):(this.jumpingToMessage={fromMail:this.mail,mail:q,archId:e},this.jumpToMessageEvent.fire(e,_WA105.CLD.inList(q)&&_WA105.CLD.getInfo(q)));else{if(a.hasClass("imFileDrop"))return!0;_WA105.ma.openProfile({mail:q,nick:f.getAttribute("data-nick")})}}}return c.stopEvent(),!0}if(f=a.up("im-avatarbox")||a.up("im-message__from")){var x;if(h=f.getAttribute("data-sn"),!h&&(f=a.up("im-message"))){var y=a.up("im-file-author");y?(h=y.getAttribute("data-userId"),x=y.getAttribute("data-nick")):(h=f.getAttribute("data-from").replace("@uin.icq",""),x=f.getAttribute("data-nick"))}if(h)return _WA105.MainAgent.isChat(h)||this._onPersonClick(h,x),!0}return h=a.getAttribute("data-user"),h?(this._onPersonClick(h),!0):void 0}},{key:"stackDialog",value:function(){if(this.mail&&this.winEl&&this._cachedDialog&&this.history){if(this.previousDialog&&this.previousDialog.mail===this.mail)return void(this.previousDialog=this.previousDialog.prev||null);if(this.previousDialog={num:this.previousDialog?this.previousDialog.num+1:0,mail:this.mail,nick:this.nick,historyCurrentPack:this._cachedDialog.historyCurrentPack,historyState:this.history.getCurrentState(),prev:this.previousDialog},this.previousDialog.num>MAX_DIALOGS_STACK_SIZE){for(var a=this.previousDialog;--a.num;)a=a.prev;a.prev=null}}}},{key:"_onPersonClick",value:function(a,b,c){_WA105.boardMode||(c?_WA105.rapi.getIdInfo(c,function(a,b,c,d){d=d||{},d.user&&d.user.sn?_WA105.CLD.inList(d.user.sn)?_WA105.ma.openDialog(_WA105.CLD.getInfoArray(d.user.sn)):_WA105.ma.openProfile({mail:d.user.sn,nick:d.user.friendly}):d.chat?(d.chat.stamp&&_WA105.chatController.saveChatStamp(d.chat.sn,d.chat.stamp),_WA105.CLD.inList(d.chat.sn)?_WA105.ma.openDialog(_WA105.CLD.getInfoArray(d.chat.sn)):_WA105.LiveChats.showChatProfile({stamp:d.chat.stamp})):_WA105.showPopup(_WA105.tr("msgNoProfileWithThisNick"))}.bind(this)):this.mail!==a&&_WA105.CLD.inList(a)?_WA105.ma.openDialog(_WA105.CLD.getInfoArray(a)):_WA105.ma.openProfile({mail:a,nick:b||_WA105.CLD.getFriendlyName(a)}))}},{key:"_onDblClick",value:function(a){var b=a.getTarget(!0);if(_WA105.contextMenu.isVisible())return a.stopEvent(),!1;if(!this.winEl.hasClass("im-dialogpage_readonly")&&b.up("im-history")){var c=b.up("imMessage");if(!c||c.hasClass("im-message_event")||b.up("im-avatar-block")||b.up("im-message__text "))return;var d=c.getAttribute("data-nick"),e=this.history&&this.history.getMessageByElement(c);e&&this.quoteMessage({nick:d,message:e})}}},{key:"_onGalleryPttClick",value:function(a){if(a.btn.up("imPttPlay"))this._pttPlay(a.btn);else{var b=a.btn.up("im-gallery");this._pttToggleSpeech(a.btn,function(a){return b&&b.getSelector('[data-id="'+a+'"]')}.bind(this),a.savePttSpeechState)}}},{key:"_onPanelAction",value:function(a,b,c){var d=this;switch(b){case"contextMenu":this._onContextMenuAction(c.menuData,c.action);break;case"ptt":this._onGalleryPttClick(c);break;case"preview":this._openUrl(c.url,c.mid,c.type);break;case"clearHistory":_UI56.showConfirmBox(_WA105.tr("dialog.confirmClearHistory"),function(){d.clearHistoryEvent.fire(a)});break;case"leave":_WA105.ma.removeContact({sn:a,nick:c})}}},{key:"_onClick",value:function(a){if(_WA105.contextMenu.isVisible())return a.stopEvent(),!1;var b,c=a.getTarget(!0),d=this.mail,e=c.up("imButton")||c.up("im-ui-button"),f=e&&e.getAttribute("data-action");if(!(c.up("im-history")||c.up("imPinBar")||c.up("im-messages__avatar_flow"))||!this._historyClick(c,e,a))if(f)switch(f){case"callVoice":case"callVideo":this.isChat?_WA105.ma.dialogsWindow.groupCallDialog(d,"callVideo"===f):_WA105.Voip.startOutgoinCall(d,this.nick,"callVideo"===f);break;case"openSidebar":this.toggleSidebar();break;case"startSearchChat":a.stopEvent(),this.globalActionEvent.fire("activateGlobalSearch",{sn:d,nick:this.nick});break;case"addUser":this._toggleStrangerBar(!1),_WA105.rapi.approveDialog(d);break;case"banUser":_WA105.contactAbstraction.doAction("banContact",d,this.nick);break;case"closeSidebar":this.toggleSidebar(!1);break;case"mute":_WA105.contactAbstraction.mute(d,!0);break;case"unmute":_WA105.contactAbstraction.mute(d,!1);break;case"join":case"subscribe":if(b=_WA105.chatController.getCachedChatInfo(d),b&&b.stamp){_WA105.LiveChats.joinChat(b.stamp);break}case"add":this.globalActionEvent.fire("addContact",{mail:e.getAttribute("data-mail")||d,nick:e.getAttribute("data-nick")||this.nick});break;case"unblock":_WA105.contactAbstraction.doAction("unblockContact",d,this.nick);break;case"addToChat":_WA105.DialogsAgent.showAddMemberDialog({contact:[d,this.nick],isChat:this.isChat,nameBlock:!this.isChat,allowEmpty:!this.isChat});break;case"pendingMembers":_WA105.LiveChats.showMemberList(d,"pending");break;case"exclude":this.isChat&&this.globalActionEvent.fire("excludeContact",{chat_id:d,mail:e.getAttribute("data-mail")});break;case"ignore":this.globalActionEvent.fire("ignoreContact",{mail:d,nick:this.nick});break;case"remove":this.globalActionEvent.fire("removeContact",{mail:d,nick:this.nick});break;case"copyChatLink":_U91.Selection.copy2clipboard(e.getAttribute("data-url"))&&_WA105.showPopup(_WA105.tr("chat.linkCopied"),2e3);break;case"preview":this._openUrl(decodeURIComponent(e.getAttribute("data-url")||""),e.getAttribute("data-mid"),e.getAttribute("data-type"));break;case"shareChat":b=_WA105.chatController.getCachedChatInfo(d);var g=b&&b.stamp&&_WA105.urlBuilder.chatLink(b);g&&_WA105.ma.dialogsWindow.forwardMessage(d,this.nick,g);break;case"media":case"video":case"ptt":case"files":case"links":break;case"profile":e=e.getSelector("[data-mail]"),this.globalActionEvent.fire("openProfile",{mail:e&&e.getAttribute("data-mail")||d,nick:e&&e.getAttribute("data-nick")||this.nick})}else c.up("app-topbar__title")&&!c.up("im-connection-title")&&this.toggleSidebar()}},{key:"_onDragDropFile",value:function(a,b){_U91.Mnt.countRB(33783225),this.textarea&&this.textarea.setFilesToUpload(a,b)}},{key:"_onFileDrag",value:function(){return this.winEl&&this.winEl.hasClass("im-dialogpage_readonly")?(this.dragDropArea.disableDragDropMode(),!1):void 0}}],[{key:"getSpeechVisibility",value:function(a){return pttSpeechVisibility[a]}},{key:"fetchDialogInfo",value:function(a){var b=a.mail,c=a.cast[b]||{},d=_WA105.MainAgent.isChat(b),e=c.lastseen,f=c.userState,g=_WA105.CLD.getLastseenMessage(e,{userState:f,bot:c.bot});return{_nick:c.nick,nick:c.nick||c.uNick||b,uNick:c.uNick,mute:c.mute,mentioned:a.mentionSyncCount,lastseenMessage:g,lastseen:e,userState:f,official:c.official,online:!(d||e>0||f),unreadCount:a.unreadCount,unread:a.unread,bot:c.bot}}},{key:"getFocusedIndex",value:function(a,b){return _U91.Array.indexOfBy(a,function(a){return a.mail===b?!0:void 0})}}]),b}(_WA105.Page);_WA105.DialogPage=DialogPage;var _WA106=WebIM,_U92=_WA106.util,SOCK=_WA106.ConnectionFacade,_AS4=_WA106.AccountSettings,_Activatable18=_WA106.Activatable,_DomUtil53=_WA106.DomUtil,_urlIds={},DialogsAgent=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.countChangedEvent=new _U92.Event,a.unreadEvent=new _U92.Event,a.sendMessageEvent=new _U92.Event,a.removeContactEvent=new _U92.Event,a.abstraction=new _WA106.DialogsAbstraction,SOCK.preloadCompletedEvent.on(a._onPreloadCompleted,_assertThisInitialized2(_assertThisInitialized2(a))),a.updateSelfNickEvent=(new _U92.Event).relay(a.abstraction.updateSelfNickEvent),a._recentView=new _WA106.RecentView,a._dialogPage=new _WA106.DialogPage,a._recentView.tabClickEvent.on(a._onTabClick,_assertThisInitialized2(_assertThisInitialized2(a))),a._recentView.markAsReadedEvent.on(function(b){b?a.markAsReaded(b):a.markAllAsRead()}),a._recentView.markAsUnreadEvent.on(a.markAsUnread,_assertThisInitialized2(_assertThisInitialized2(a))),a.updateUnknownsEvent=(new _U92.Event).relay(a._recentView.updateUnknownsEvent),a.abstraction.updateSettings.on(a.onUpdateSettings,_assertThisInitialized2(_assertThisInitialized2(a))),a.abstraction.clearHistoryEvent.on(a.onHistoryClear,_assertThisInitialized2(_assertThisInitialized2(a))),a._recentView.closeTabEvent.on(a._onTabClose,_assertThisInitialized2(_assertThisInitialized2(a))),a._dialogPage.messageEvent.on(a.submitMessage,_assertThisInitialized2(_assertThisInitialized2(a))),a._dialogPage.typingEvent.on(a._onMessageTyping,_assertThisInitialized2(_assertThisInitialized2(a))),a._dialogPage.backEvent.on(function(){var b=a.abstraction.isNotRecent();b?a._onTabClose(b):a.abstraction.blur()}),a.globalActionEvent=(new _U92.Event).relay(a._dialogPage.globalActionEvent),a._dialogPage.sideScrolledEvent.on(a.abstraction.loadSideHistory,a.abstraction),a._dialogPage.jumpToMessageEvent.on(a.abstraction.loadHistoryPack,a.abstraction),a._dialogPage.readNextMessageEvent.on(a.markViewedAsReaded,_assertThisInitialized2(_assertThisInitialized2(a))),a._dialogPage.pinToggleEvent.on(a.abstraction.togglePin,a.abstraction),a._dialogPage.backToHistoryEvent.on(function(){this.abstraction.reopen()},_assertThisInitialized2(_assertThisInitialized2(a))),a._dialogPage.forwardLinkEvent.on(a.forwardMessage,_assertThisInitialized2(_assertThisInitialized2(a))),a._dialogPage.shareContactEvent.on(a.shareContact,_assertThisInitialized2(_assertThisInitialized2(a))),a._dialogPage.clearHistoryEvent.on(a.abstraction.clearHistory,a.abstraction),a._dialogPage.deleteMessageEvent.on(a.abstraction.deleteMessage,a.abstraction),a._dialogPage.pinMessageEvent.on(a.abstraction.pinMessage,a.abstraction),_WA106.contactAbstraction.blockEvent.on(a.ignoreContact,_assertThisInitialized2(_assertThisInitialized2(a))),_WA106.contactAbstraction.spamEvent.on(a.sendAbuse,_assertThisInitialized2(_assertThisInitialized2(a))),
a}return _inherits2(b,a),_createClass2(b,[{key:"groupCallDialog",value:function(a,b){this.groupCallList=new _WA106.GroupCallListPage;var c={sn:a,isVideo:b};_WA106.splitView?_WA106.Pane.openPageBox(this.groupCallList,c):App.load("groupCallList",c,this.groupCallList)}},{key:"forwardMessage",value:function(a,b,c,d,e,f){this.forwardList||(this.forwardList=new _WA106.ForwardListPage),this.forwardList.forwardMessageEvent.removeAll();var g={msg:c,email:a,nick:b,onBack:e,skipOptions:d};_WA106.splitView?_WA106.Pane.openPageBox(this.forwardList,g):App.load("forwardlist",g,this.forwardList),this.forwardList.forwardMessageEvent.on(function(a,b,c){f&&f(),this.submitMessage(a,b,c)},this)}},{key:"shareContact",value:function(a,b){var c=this;this.shareContactList||(this.shareContactList=new _WA106.ShareContactListPage),this.shareContactList.shareEvent.removeAll(),_WA106.splitView?_WA106.Pane.openPageBox(this.shareContactList):App.load("shareContactList",{},this.shareContactList),this.shareContactList.shareEvent.on(function(d){c._dialogPage.mail===a&&(d.contact&&(b.contact=d.contact),c._dialogPage.submitMessage(d.text,b))})}},{key:"_onPreloadCompleted",value:function(){this._preloadReady=!0,this._recentView&&this._recentView.finishPreloading(),this.abstraction.checkDataForLog()}},{key:"submitMessage",value:function(a,b,c){this.abstraction.postMessage(a,b,{resend:c}),this.sendMessageEvent.fire()}},{key:"blurFocusedDialog",value:function(){if(this._dialogPage.previousDialog=null,_WA106.splitView)this.abstraction.blur();else if(this.abstraction.blur(),!App.isCurrentPage("dialog"))for(var a=App.indexOfPage("dialog");a>-1;)App.spliceHistory(a,1),a=App.indexOfPage("dialog")}},{key:"_onTabClick",value:function(a){var b=(this.abstraction.getFocused()||{}).mail;b===a?this._dialogPage.jumpToEnd():this.abstraction.focus(a)}},{key:"_onTabClose",value:function(a){this.abstraction.close(a)}},{key:"_onMessageTyping",value:function(a){_WA106.wimApi.sendTyping({t:a,typingStatus:"typing"})}},{key:"_onAbstractionUpdate",value:function(a,b,c){this.countChangedEvent.fire(a.dialogs.length),this._dialogPage.updateView(a,b,c),this._recentView.updateView(a,!!this._preloadReady);var d=this.abstraction.getUnreadCounter(),e=this.abstraction.getUnreadDialogsCounter();if(this._dialogPage.updateUnreadCounter(d,e),this.unreadEvent.fire(d,e),d){var f=this.abstraction.getLastUnread();_WA106.titleAnimator.start(d,f?f.nick||f.mail:"")}else _WA106.titleAnimator.stop()}},{key:"scrollToFirstUnreadDialog",value:function(){this._recentView.scrollToFirstUnreadDialog()}},{key:"ignoreContact",value:function(a){this.abstraction.close(a),_WA106.ChangeLog.logAction("remove",{email:a})}},{key:"sendAbuse",value:function(a){this.abstraction.close(a),this.removeContactEvent.fire(a)}},{key:"markAsReaded",value:function(a){this.abstraction.markAsRead(a)}},{key:"markViewedAsReaded",value:function(a,b,c){b&&this.abstraction.markAsRead(a,b,c)}},{key:"markAsUnread",value:function(a){var b=this.abstraction.getFocused();b&&b.mail===a&&this.abstraction.blur(),this.abstraction.markAsUnread(a)}},{key:"markAllAsRead",value:function(){this.abstraction.markAllAsRead()}},{key:"render",value:function(a){this._recentView.render(a)}},{key:"openDialog",value:function(a,b,c){var d=a[0],e=this.abstraction.getFocused();if(console.log("IM:D:openDialog:sn="+d+" focused="+(e&&e.mail)),e&&e.mail===d){if(_WA106.splitView||App.isCurrentPage("dialog"))b&&this._dialogPage.scrollUpToMessage(b);else{var f=App.indexOfPage("dialog",!0);if(f>-1){var g=App.getPage(f);g&&g.context&&g.context.mail===d&&(App.showPage(f),b&&(this._dialogPage.jumpingToMessage={fromMail:d,mail:d,archId:b},this._dialogPage.jumpToMessageEvent.fire(b,_WA106.CLD.inList(d)&&_WA106.CLD.getInfo(d))))}}return!0}var h=_WA106.CLD.inList(d)&&_WA106.CLD.getInfoArray(d);return h?(h.forEach(function(b,c){void 0===a[c]&&(a[c]=b)}),a=_WA106.contactToHash(a)):(a=_WA106.contactToHash(a),void 0===a.needAuth&&(a.needAuth=1)),b&&(this._dialogPage.jumpingToMessage={fromMail:d,mail:d,archId:b}),this.abstraction.open(a,b,c)}},{key:"hasPttRecord",value:function(){return this._dialogPage.hasPttRecord()}},{key:"hasDialogs",value:function(){return this.abstraction._cache.getDialogCount()>0}},{key:"getRecentData",value:function(a){return this.abstraction.getRecentData(a)}},{key:"onUpdateSettings",value:function(a,b,c){}},{key:"onHistoryClear",value:function(a){var b=this.abstraction.getFocused();if(b&&b.mail===a&&(_WA106.splitView||App.isCurrentPage("dialog"))){var c=this._dialogPage.history,d=c&&c.renderer&&c.renderer.getMiddleMessageId();d&&(this._dialogPage.jumpingToMessage={fromMail:a,mail:a,archId:d,skipBlinking:!0},this.abstraction.loadHistoryPack(d))}}},{key:"onUpdateClistData",value:function(){this.abstraction.onUpdateClistData()}},{key:"onHotSessionRestart",value:function(a){this.abstraction.saveDataFromLastMessages(a);var b=this.abstraction.getFocused();this.abstraction.deactivate(),this.abstraction.activate(),this.openDialog([b.mail,b.nick])}},{key:"onThemeSwitch",value:function(){this._dialogPage.onThemeSwitch()}},{key:"_onActivate",value:function(){_DomUtil53.fly(document.body).on("click",function(){this.tryToReadLastVisibleMessage()},this._dialogPage).on("keydown",function(){this.tryToReadLastVisibleMessage()},this._dialogPage),_WA106.focusEvent.on(this._dialogPage.tryToReadLastVisibleMessage,this._dialogPage),this._recentView.activate(),this.abstraction.updateEvent.on(this._onAbstractionUpdate,this),this.abstraction.activate()}},{key:"_onDeactivate",value:function(){_DomUtil53.fly(document.body).un("click",function(){this.tryToReadLastVisibleMessage()},this._dialogPage).un("keydown",function(){this.tryToReadLastVisibleMessage()},this._dialogPage),_WA106.focusEvent.un(this._dialogPage.tryToReadLastVisibleMessage,this._dialogPage),_WA106.titleAnimator.stop(),this.abstraction.updateEvent.un(this._onAbstractionUpdate,this),this.abstraction.deactivate(),this._recentView.deactivate(),this._dialogPage.deactivate()}},{key:"getOpenDialogs",value:function(){return this.abstraction.getOpenDialogs()}},{key:"getVisibleDialog",value:function(){return this.abstraction.getFocused()}}]),b}(_Activatable18),addMemberList;DialogsAgent.showAddMemberDialog=function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},b={isChat:a.isChat,cntctData:a.contact,showGroupNameBlock:a.nameBlock,allowEmpty:a.allowEmpty,createGroupCallback:a.callback,chatName:a.name,disableBack:a.disableBack};addMemberList||(addMemberList=new _WA106.AddMemberListPage),_WA106.splitView?_WA106.Pane.openPageBox(addMemberList,b):a.force?App.forceLoad("addmemberlist",b,addMemberList):App.load("addmemberlist",b,addMemberList)},DialogsAgent.extractUrlFromMessage=function(a,b){var c=a in _urlIds?_urlIds[a]:_WA106.MessageFormatter.extractUrlFromText(b);return this.bindUrlToMessage(a,c),c},DialogsAgent.bindUrlToMessage=function(a,b){!a||a in _urlIds||(_urlIds[a]=b)},DialogsAgent.resetBoundUrlFromMessage=function(a){a&&a in _urlIds&&delete _urlIds[a]},DialogsAgent.getMediaBlockMaxSize=function(){if(!this.__mediaSize){var a=window.innerWidth;a>449?this.__mediaSize=300:a>359?this.__mediaSize=260:this.__mediaSize=220}return this.__mediaSize},_WA106.DialogsAgent=DialogsAgent;var _WA107=WebIM,ANIMATION_DISABLED=!_WA107.isDesktop||_WA107.boardMode,TitleAnimator=function(){function a(){_classCallCheck2(this,a),this.originalTitle=document.title,this.updater=new _WA107.util.DelayedTask({interval:500,fn:this._doUpdate,scope:this}),this._reset()}return _createClass2(a,[{key:"_reset",value:function(){this.index=0,this.unreadCount=0,this.subTitle="",this._lastTitle=!1}},{key:"_getTitle",value:function(){var a=this.index;return 0===a?_WA107.tr("titleAnimator",{count:this.unreadCount}):1===a?this.subTitle:2===a?"* * * * * * * *":this.originalTitle}},{key:"_doUpdate",value:function(){document.title!==this._lastTitle&&(this.originalTitle=document.title),document.title=this._lastTitle=this._getTitle(),this.index=++this.index>=3?0:this.index,this.updater.start()}},{key:"start",value:function(a,b){ANIMATION_DISABLED||(this.updater.isStarted()||this._reset(),this.unreadCount=a>999?"1k":a,this.subTitle=_WA107.util.String.trim(b),this._doUpdate())}},{key:"stop",value:function(){this.updater.isStarted()&&(this.updater.stop(),document.title===this._lastTitle&&(document.title=this.originalTitle))}}]),a}();_WA107.titleAnimator=new TitleAnimator;var _WA108=WebIM,_U93=_WA108.util,_UI57=_WA108.ui,navigationActionsList=["tab","enter","arrowDown","arrowUp","arrowLeft","arrowRight"],SmileBox=function(a){function b(a){var c;_classCallCheck2(this,b);var d=_WA108.applyIf(a||{},{cls:"im-smilebox",hideOnClick:!1,hideOnEscape:!0,eraseButton:!1,fadeIn:!1});return d.eraseButton&&(d.cls+=" im-smilebox_with-erase"),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,d)),c.itemClickEvent=new _U93.Event,c.backspaceEvent=new _U93.Event,c.hotKeyTabEvent=new _U93.Event,c}return _inherits2(b,a),_createClass2(b,[{key:"_onShow",value:function(){if(!this.setsMenu){this.el.updateHTML('<div class="im-ui-button im-dialog-showcase-button" data-action="showcase"></div><div class="im-multitabs__leftbtn im-ui-button"></div><div class="im-multitabs__rightbtn im-ui-button"></div>');var a=[this.el.last().prev(),this.el.last()];this.setsMenu=new _UI57.AppTabBox({autoRender:this.el,dataSource:_UI57.AppTabBox.StickerDataSource,clsSuffix:"stickers",switchOptions:"swipe::100",swipeSwitch:!0}),_WA108.splitView&&this.setsMenu.enableScrollButtons(a),this.setsMenu.tabClickEvent.on(function(a,b,c){this.activeTabId=c,"_emoji"!==c||this.emojiMenu.rendered||(this.initialConfig.eraseButton&&b.updateHTML('<div class="im-ui-button im-dialog-erase-button" data-action="erase"></div>'),this.emojiMenu.render(b),this.emojiMenu.show(),this.emojiMenu.selectTab(0),this.emojiMenu.tabNavigator.initialConfig.loop=!1,this.emojiMenu.tabNavigator.overEvent.on(this._onEmojiMenuTabNavigatorOver,this))},this),this.setsMenu.itemClickEvent.on(function(a){a=a.split("#"),"showcase"===a[0]?this.itemClickEvent.fire("showcase",{pack:a[1]}):this.itemClickEvent.fire("sticker",{pack:a[0],id:a[1]})},this),this.emojiMenu=new _UI57.AppTabBox({dataSource:_UI57.AppTabBox.EmojiDataSource,clsSuffix:"emoji",switchOptions:"swipe::100",swipeSwitch:!0,dontStopSwapOnEdge:!0}),this.emojiMenu.itemClickEvent.on(function(a,b){this.itemClickEvent.fire("emoji",{id:a,blockId:b})},this),this.setsMenu.show(),this.setsMenu.selectTab(0),this.setsMenu.el.on(["longtap","contextmenu"],function(a){var b=a.getTarget(!0);b.up("im-tabbox_emoji")||b.hasClass("im-tabbox__layer-item")&&(a.stopEvent(),"longtap"===a.type&&_UI57.StickerPreview.show(b,this.setsMenu.getActiveContentBlock(),this.setsMenu.el,"im-tabbox-content_stickers"))},this)}_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),_WA108.hotKeyManager.on(navigationActionsList,{handler:this._onNavigationAction,scope:this},this.hotKeyLayerConfig.name),this._arrowNavigationActive=!0,this.el.on("mousemove",this._onMouseMove,this)}},{key:"_onHide",value:function(){this.el.un("mousemove",this._onMouseMove,this),_WA108.hotKeyManager.un(navigationActionsList,{handler:this._onNavigationAction,scope:this},this.hotKeyLayerConfig.name),_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this)}},{key:"_onMouseMove",value:function(a){if(this._arrowNavigationActive){var b=a.getTarget(!0),c="_emoji"===this.activeTabId?this.emojiMenu:this.setsMenu,d=c&&c.getActiveContentBlock();b.isAncestor(d)&&this.deactivateArrowNavigation(d)}}},{key:"deactivateArrowNavigation",value:function(a){if(this._arrowNavigationActive){if(!a){var b="_emoji"===this.activeTabId?this.emojiMenu:this.setsMenu;a=b&&b.getActiveContentBlock()}var c=a&&a.getSelector(".im-tabbox__layer-item_selected");this._arrowNavigationActive=!1,c&&c.removeClass("im-tabbox__layer-item_selected")}}},{key:"_onEmojiMenuTabNavigatorOver",value:function(a,b){a?this.setsMenu.tabNavigator.switchElement(!0):b&&this.setsMenu.tabNavigator.switchElement()}},{key:"_onHotKeyTab",value:function(a){"_emoji"===this.activeTabId?this.emojiMenu.tabNavigator.switchElement(a.shiftKey):this.setsMenu.tabNavigator.switchElement(a.shiftKey),this._arrowNavigationActive=!0,a.preventDefault(),this.hotKeyTabEvent.fire()}},{key:"_getCursorStepItemHorizontally",value:function(a,b){var c=b?a.next():a.prev();return c&&(c.hasClass("im-img__overlay")&&(c=b?c.next():c.prev()),c&&!c.hasClass("im-tabbox__layer-item")&&(c=null)),c}},{key:"_getCursorStepItemVertically",value:function(a,b){var c=a.offset(),d=a.dom.offsetWidth,e=a.dom.offsetHeight,f=_U93.DomHelper.elementFromPoint(c.left+.5*d,c.top+(b?1.5*e:-.5*e));return f&&(f.hasClass("im-tabbox__layer-item")?f.hasClass("im-img__overlay")&&(f=f.prev(),f.hasClass("im-tabbox__layer-item")||(f=null)):f=null),f}},{key:"_moveCursor",value:function(a){var b,c="_emoji"===this.activeTabId?this.emojiMenu:this.setsMenu,d=c.getActiveContentBlock(),e=d.getSelector(".im-tabbox__layer-item_selected");if(e){var f="arrowDown"===a||"arrowRight"===a;b="arrowDown"===a||"arrowUp"===a?this._getCursorStepItemVertically(e,f):this._getCursorStepItemHorizontally(e,f)}else b=d.getSelector(".im-tabbox__layer-item"),b.hasClass("im-img__overlay")&&(b=b.prev(),b.hasClass("im-tabbox__layer-item")||(b=null));if(b){e&&e.removeClass("im-tabbox__layer-item_selected"),b.addClass("im-tabbox__layer-item_selected");var g=b.dom.offsetTop-b.parent().dom.scrollTop,h=b.dom.offsetHeight;h>=g?d.dom.scrollTop=Math.max(0,b.dom.offsetTop-h):g>=d.dom.offsetHeight-2*h&&(d.dom.scrollTop=b.dom.offsetTop-d.dom.offsetHeight+2*h),c.scrollBar.sync()}}},{key:"_onNavigationAction",value:function(a,b){switch(b){case"arrowDown":case"arrowUp":case"arrowLeft":case"arrowRight":this._arrowNavigationActive&&(a.stopEvent(),this._moveCursor(b));break;case"tab":this._onHotKeyTab(a);break;case"enter":a.stopEvent(),this._onHotKeyEnter()}}},{key:"_onHotKeyEnter",value:function(){var a="_emoji"===this.activeTabId?this.emojiMenu:this.setsMenu,b=a.getActiveContentBlock(),c=b.getSelector(".im-tabbox__layer-item_selected");c&&(c.dom.click(),this.hide())}},{key:"_onMouseDown",value:function(a){if(0===a.button){var c=a.getTarget(!0);return c&&"showcase"===c.getAttribute("data-action")?(this.itemClickEvent.fire("showcase"),!1):c&&"erase"===c.getAttribute("data-action")?(this.backspaceEvent.fire(),!1):void _get2(_getPrototypeOf2(b.prototype),"_onMouseDown",this).call(this,a)}}},{key:"switchSetMenu",value:function(a,b){this.show(),this.setsMenu.selectTab(a,b)}},{key:"destroy",value:function(){_WA108.hotKeyManager.un(navigationActionsList,{handler:this._onNavigationAction,scope:this},this.hotKeyLayerConfig.name),_UI57.StickerPreview.hide(),this.hide(),this.setsMenu&&this.setsMenu.destroy(),this.emojiMenu&&this.emojiMenu.destroy(),this.itemClickEvent.removeAll(),this.itemClickEvent=null,this.backspaceEvent.removeAll(),this.backspaceEvent=null,this.hotKeyTabEvent.removeAll(),this.hotKeyTabEvent=null,_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI57.Layer);_WA108.DialogPage.SmileBox=SmileBox;var _WA109=WebIM,_U94=_WA109.util,_UI58=_WA109.ui,MINIMUM_WIN_HEIGHT_FOR_FULL_PREVIEW=530,SendFileBox=function(a){function b(a){var c;_classCallCheck2(this,b);var d={title:_WA109.tr("dialog.sendFile"),blockCls:"im-filebox",content:_WA109.TD.getTMPL("sendFileBox"),submitByEnter:!0,buttons:[{action:"cancel",text:_WA109.tr("box.cancel")},{action:"ok",text:_WA109.tr("dialog.send"),cls:"im-button_highlight"}]};return _WA109.applyIf(a||{},d),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a)),c._fileQueue=[],c._fileData={},c._singlePreviewMode=!1,c.textBox=new _UI58.SmilesTextField,_WA109.isDesktop&&(c.dragDropArea=new _UI58.DragDropArea({dualMode:!1,title:_WA109.tr("dialog.addFiles"),affectWholePage:!0}),c.dragDropArea.dropEvent.on(c._onDragDropFile,_assertThisInitialized2(_assertThisInitialized2(c)))),c}return _inherits2(b,a),_createClass2(b,[{key:"createFilePreviewHTML",value:function(a,b,c){var d,e=_U94.String.crc32(a.name+a.size),f=this._fileData[e],g=_WA109.fileTools.fetchLocalFileObj(a);if(f&&(g.preview=f.url),f&&!c){this._singlePreviewMode=!0;var h="";f.width&&f.width<308&&(h="width:308px;"),f.height&&f.height<80&&(h=""),f.width&&f.width<80&&(h=""),d='<img alt="" src="'+_U94.String.encodeHref(f.url)+'" style="'+h+'">'}else this._singlePreviewMode=!1,d=_WA109.fileTools.generateHTML(g,{cleanVersion:1},null,b);return d}},{key:"windowResize",value:function(){this.refreshFileBox()}},{key:"refreshFileBox",value:function(){var a=this;if(this.listBox){var b=window.innerHeight<=MINIMUM_WIN_HEIGHT_FOR_FULL_PREVIEW;if(this.block.toggleClass("im-filebox_extremely-low-height",b),this.block.getSelector('.imButton[data-action="ok"]').toggleClass("im-button_disabled",!this._fileQueue.length),this.listContent){var c=this._fileQueue.length?_WA109.tr("dialog.sendFilesCount",{count:this._fileQueue.length}):_WA109.tr("dialog.sendFiles");this._updateTitle(c);var d="",e=this._fileQueue.length>1||b;this._fileQueue.forEach(function(b,c){d+=a.createFilePreviewHTML(b,c,e)}),this.listBox.toggleClass("im-filebox-list_single",this._singlePreviewMode),this.listContent.updateHTML(d),this.scrollBar.sync()}}}},{key:"addFiles",value:function(a){_U94.Array.each(a||[],this.addFile,this),this.refreshFileBox(),a.length<6&&(this.listBox.dom.scrollTop=this.listBox.dom.offsetHeight,this.scrollBar.sync())}},{key:"addFile",value:function(a){a&&a[0]&&(a=a[0]);var b=_U94.String.crc32(a.name+a.size);_U94.Array.indexOfBy(this._fileQueue,function(a){return b===_U94.String.crc32(a.name+a.size)})>-1||(this._fileQueue.push(a),this._fileData[b]||_WA109.setTimeout(this._makePreview.bind(this,b,a),1))}},{key:"_makePreview",value:function(a,b){var c=this;_WA109.fileTools.makeFileLocalPreview(b,function(b){c._fileData[a]=b||{error:1},b&&c.refreshFileBox()})}},{key:"removeFile",value:function(a){this._fileQueue.splice(a,1),this._fileQueue.length||this.holdEmptyFileList(),this.refreshFileBox()}},{key:"holdEmptyFileList",value:function(){this.dragDropArea&&this.dragDropArea.enableDragDropMode()}},{key:"_onDragDropFile",value:function(a){_U94.Mnt.countRB(34099034),this.addFiles(a)}},{key:"_onOk",value:function(){return this._fileQueue.length?void(this.initialConfig.onOk&&this.initialConfig.onOk(this._fileQueue.slice(0),this.textBox.textVal()||"",this.textBox.val()||"")===!1||this.hide()):!1}},{key:"_onClick",value:function(a){var b=a.up("imButton"),c=b&&b.getAttribute("data-action");"ok"===c?this._onOk():"removeFile"===c?this.removeFile(a.up("imFile").getAttribute("data-context-id")):c&&this.hide()}},{key:"_onHotKey",value:function(a,b){"enter"===b&&_WA109.isDesktop&&(a.shiftKey||!a.ctrlKey&&!this.initialConfig.submitByEnter||(a.preventDefault(),this._onOk()))}},{key:"_onShow",value:function(){_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),this.listBox=this.block.getSelector(".imSendFileList"),this.listContent=this.listBox.first(),this.textBox.renderBind(this.block.getSelector(".imSendFileText")),this.textBox.scrollBar.setSource(this.textBox.el),this.scrollBar=new _UI58.ScrollBar({source:this.listBox,watchResize:!1}),this.textBox.onHotKeyFocusedLayer("enter",this._onHotKey,this),this.textBox.val(this.initialConfig.caption||""),this.textBox.focus(!0),this.refreshFileBox(),this.dragDropArea&&this.dragDropArea.activate(this.listBox.parent()),this.addFiles(this.initialConfig.files)}},{key:"_onHide",value:function(){this.dragDropArea&&this.dragDropArea.deactivate(),this.scrollBar.destroy(),this._fileQueue=[],this.listBox=null,this.textBoxLastValue=this.textBox.val()||"",this.textBox.unHotKeyFocusedLayer("enter",this._onHotKey,this),this.textBox.renderUnbind(),_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this)}},{key:"destroy",value:function(){this._fileQueue=[],_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI58.ConfirmModalBox),box;_WA109.DialogPage.openSendFileDialog=function(a,b,c,d){return box=new SendFileBox({files:a,caption:b,onOk:d,submitByEnter:c}),box.show(),box},_WA109.DialogPage.resizeSendFileDialog=function(){box&&box.windowResize()};var _WA110=WebIM,_U95=_WA110.util,_UI59=_WA110.ui,_TD35=_WA110.TemplateDriver,USE_RECENT_WRITERS_SERVICE=!0,MAX_LIST_ITEMS=50,MAX_VISIBLE_ITEMS=7,MIN_VISIBLE_ITEMS=3,VISIBLE_LIST_UNDERLAY=.3,lineHeight=32,SuggestBox=function(a){function b(a){var c;_classCallCheck2(this,b);var d=_WA110.applyIf(a||{},{cls:"im-suggestbox",hideOnClick:!1,hideOnEscape:!0,fadeIn:!1});return c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,d)),c._maxListLength=null,c._searchText=null,c.itemClickEvent=new _U95.Event,c}return _inherits2(b,a),_createClass2(b,[{key:"initOnce",value:function(){if(!this.__initCompleted){this.__initCompleted=!0,this.searchData=new SuggestUserAbstraction,this.el.updateHTML('<div class="im-list"><div class="im-list-wrapper"></div></div><div class="im-suggestbox__anchor"><span></span></div>'),this._anchorEl=this.el.last();var a=this.el.first();this.config={uid:"mentions",dynamicListLength:this._getCurrentMaxListLength.bind(this),highlightQuery:!1,itemHeight:lineHeight,templates:{contact:_TD35.getTMPL("mentionSuggestItem"),title:_TD35.getTMPL("mentionSuggestSeparator")},buildEntryBundle:this.buildListEntry.bind(this),selectable:!0,loopNavigation:!0},this.listView=new _WA110.ContactListView(this.config),this.listView.applyItemEvent.on(this.onItemSelect,this),this.listView.bindListView(a,a.first())}}},{key:"show",value:function(a){a=a||{},this._winEl=a.winEl,this._anchorRect=a.rect;var c=this._getCurrentMaxListLength();this.initOnce(),this._maxListLength!==c||this._searchText!==a.text?(this.isVisible()||this.searchData.searchCompleteEvent.on(this._renderSearchResult,this,{single:!0}),this._searchText=a.text,this._maxListLength=c,this.searchData.searchAll(this._searchText)):this.listView&&this.listView.renderedData&&this.listView.renderedData.listLength&&_get2(_getPrototypeOf2(b.prototype),"show",this).call(this)}},{key:"_onShow",value:function(){if(this._anchorRect&&this._anchorEl&&this.el){var a=this.el.parent().getBoundingClientRect(),c=a.bottom-this._anchorRect.top+this._anchorEl.getHeight(),d=this._anchorRect.left-a.left-this.el.dom.offsetLeft+this._anchorRect.width/2;this._anchorEl.setStyle("left",d+"px"),this.el.setStyle("bottom",c+"px")}this.searchData.searchCompleteEvent.on(this._renderSearchResult,this),this.searchData.dataUpdatedEvent.on(this._onDataUpdatedEvent,this),this.listView.activate(),_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this)}},{key:"_onHide",value:function(){this.listView.deactivate(),this.searchData.searchCompleteEvent.un(this._renderSearchResult,this),this.searchData.dataUpdatedEvent.un(this._onDataUpdatedEvent,this),_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this)}},{key:"_onDataUpdatedEvent",value:function(a){this.listView.redraw(a)}},{key:"_renderSearchResult",value:function(a,c,d){a.length?(_get2(_getPrototypeOf2(b.prototype),"show",this).call(this),this.listView.searchQuery=d||c,this.listView.renderList(a),this.listView.el.dom.scrollTop=0,this.listView.selectFirstItem()):this.hide()}},{key:"_getCurrentMaxListLength",value:function(){var a=this._winEl?this._winEl.getSelector(".imChatContent").getHeight():0;return Math.min(Math.max(Math.floor(a/lineHeight),MIN_VISIBLE_ITEMS),MAX_VISIBLE_ITEMS)-VISIBLE_LIST_UNDERLAY}},{key:"buildListEntry",value:function(a,b,c,d){var e={};if("contact"===a&&(e=_WA110.ContactListView.prepareArrayContactItem(b,c,d),this.listView.searchQuery)){var f=e.uNick||(_WA110.isUIN(e.email)?e.email:""),g=_WA110.ContactListView.highlightFoundContact(e.email,e.nick,f,this.listView.searchQuery);e.vNick=_WA110.Emoji.parse(g)}return e}},{key:"navigate",value:function(a){return this.isVisible()&&this.listView.navigate(a)}},{key:"onItemSelect",value:function(a){if(a){var b=a&&a.getAttribute("data-sn"),c=a&&a.getAttribute("data-idx")||0,d=this.searchData.getContactDisplayName(b,c);return this.itemClickEvent.fire(b,d||b),this.hide(),!0}return!1}},{key:"_onAncestorDown",value:function(a,b,c){var d=a.up("imSearchEntry");d&&d.getAttribute("data-sn")&&(c.preventDefault&&c.preventDefault(),this.onItemSelect(d))}},{key:"destroy",value:function(){this.hide(),this.itemClickEvent.removeAll(),this.itemClickEvent=null,this.searchData&&this.searchData.destroy(),this._anchorEl=null,_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI59.Layer),SuggestUserAbstraction=function(){function a(){_classCallCheck2(this,a),this._topData=[],this._clData=[],this._clAbstraction=new _WA110.SearchDataAbstraction,this._clAbstraction.searchReadyEvent.on(this._onSearchCLReady,this),this._clAbstraction.searchRequestEvent.on(function(){var a=this.getCLData(!1);a&&this._clAbstraction.onDataReceived(a)},this),this._memberList={},this.searchCompleteEvent=new _U95.Event,this.dataUpdatedEvent=new _U95.Event,_WA110.globalEvents.cListLoaded.on(function(){var a=this.combineData();this.dataUpdatedEvent.fire(a)},this)}return _createClass2(a,[{key:"getCLData",value:function(){var a=this;return _WA110.ma.contactList.abstraction.getFullData(function(b){return!_WA110.MainAgent.isChat(b[0])&&!a._memberList[b[0]]})}},{key:"searchAll",value:function(a){var b=_WA110.ma.dialogsWindow.getVisibleDialog();b&&this._searchMembers(b.mail,a)}},{key:"_searchMembers",value:function(a,b){b=b||"",this._searchQuery=b,this._memberList={};var c=b.toLowerCase(),d=_U95.KeyMapping.translate(c),e=[];if(_WA110.MainAgent.isChat(a)){var f=function h(e,f,g){if(e===a){if(!f)return void _WA110.chatController.infoReadyEvent.un(h,this);var i=[];if(USE_RECENT_WRITERS_SERVICE){var j=g.writersSeachResult;if(j.query!==b)return;if(_WA110.chatController.infoReadyEvent.un(h,this),b!==this._searchQuery)return;_U95.Array.each(j.writers,function(a){this._memberList[a.sn]=1;var b=a.friendly||a.nickname||a.sn,c=a.uNick;a.sn===_WA110.ACTIVE_MAIL&&(b=_WA110.DialogsAbstraction.nick||b,c=_WA110.DialogsAbstraction.uNick||c),i.push(_WA110.contactToArray({email:a.sn,nick:b,uNick:c}))},this),this._clAbstraction.data=null}else{_WA110.chatController.infoReadyEvent.un(h,this);var k,l=0,m=MAX_LIST_ITEMS;_U95.Array.each(g.members,function(a){var b=a.email,e=a.friendly||a.nickname||b,f=a.uNick;return this._memberList[b]=1,a.sn===_WA110.ACTIVE_MAIL&&(e=_WA110.DialogsAbstraction.nick||e,f=_WA110.DialogsAbstraction.uNick||f),k=e.toLowerCase(),(-1!==b.indexOf(c)||-1!==k.indexOf(c)||-1!==b.indexOf(d)||-1!==k.indexOf(d))&&(i.push([b,e]),l++),l>=m?!1:void 0},this)}this._chatData=i,this._clAbstraction.config.remoteSearchAsync=!1,this._onSearchMembersReady(i,b)}};_WA110.chatController.infoReadyEvent.on(f,this),USE_RECENT_WRITERS_SERVICE?_WA110.chatController.requestChatWriters(a,b):_WA110.chatController.getChatInfo(a,0,!1,!0)}else{if(_WA110.CLD.inList(a)){var g=_WA110.CLD.getInfoArray(a);this._clAbstraction.checkItem(g,[c,d])&&(this._memberList[a]=1,e=[g])}this._clAbstraction.config.remoteSearchAsync=!0,this._onSearchMembersReady(e,b)}}},{key:"_onSearchMembersReady",value:function(a,b){this._topData=a||[],b?this._clAbstraction.search(b):(this._clData=this.getCLData()||[],this.searchCompleteEvent.fire(this.combineData()))}},{key:"_onSearchCLReady",value:function(a,b,c){this._clData=a||[],this.searchCompleteEvent.fire(this.combineData(),b,c)}},{key:"combineData",value:function(){var a=[],b=this._topData.length;return this._cacheFriendlyName={},_U95.Array.each(this._topData.concat(this._clData||[]),function(b){this._cacheFriendlyName[b[0]]=b[1],a.push({entryType:"contact",entryData:b})},this),b&&MAX_LIST_ITEMS>b&&this._clData.length&&a.splice(b,0,{entryType:"title",entryData:_WA110.ContactListView.TOP_LIST_SEPARATE_ITEM}),a.slice(0,MAX_LIST_ITEMS)}},{key:"getContactDisplayName",value:function(a){return this._cacheFriendlyName&&this._cacheFriendlyName[a]||a}},{key:"destroy",value:function(){this.searchCompleteEvent.removeAll(),this.dataUpdatedEvent.removeAll()}}]),a}();_WA110.SuggestBox=SuggestBox;var _WA111=WebIM,_U96=_WA111.util,SuggestAbstraction=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this)),a.suggestEvent=new _U96.Event,a._localData=null,a._cachedBySnAndText={},a._cachedBySnAndMid={},a.localRequestedPromise=null,a.requested=null,a.smartRequested=null,a}return _inherits2(b,a),_createClass2(b,[{key:"_getLocalData",value:function(){var a=this;return this.localRequestedPromise||(this.localRequestedPromise=new Promise(function(b){a._localData?b():_WA111.Sticker.getSuggest(function(c,d){c&&Object.keys(c).length&&(a._localData=a._localData||{},a._localData.emoji=c),d&&Object.keys(d).length&&(a._localData=a._localData||{},a._localData.words=d),b()})})),this.localRequestedPromise}},{key:"getLocalData",value:function(a,b,c){var d=this;this._getLocalData().then(function(){var e={};d._localData&&(d._localData.emoji&&(e.emoji=d._localData.emoji[a]),d._localData.words&&(e.words=d._localData.words[a])),b&&(e.words=(e.words||[]).concat(b)),c(e)})}},{key:"getServerData",value:function(a,b,c){var d=this;if(!_WA111.configurator.getOption("server_suggests_enabled"))return void c({});var e=this._getLocalData();this.requested=_WA111.rapi.getSuggests({text:a,sn:b},function(f,g,h,i){e.then(function(){if(i&&i.suggests){var e;i.suggests.forEach(function(a){"sticker-by-text"===a.type&&a.sn===b&&a.stickers&&a.stickers.length&&(e=(e||[]).concat(a.stickers))}),d._cachedBySnAndText[b]=d._cachedBySnAndText[b]||{},e?d._cachedBySnAndText[b][a]=(d._cachedBySnAndText[b][a]||[]).concat(e):200===f&&(d._cachedBySnAndText[b][a]=[])}d.requested===g&&(d.requested=null,c({words:d._cachedBySnAndText[b][a]}))})})}},{key:"_addSuggest",value:function(a){var b;return a.text&&a.text.length?b=a.text.map(function(a){return{text:a,type:"text"}}):a.stickers&&a.stickers.length&&(b=a.stickers),b?(this._cachedBySnAndMid[a.sn]=this._cachedBySnAndMid[a.sn]||{},this._cachedBySnAndMid[a.sn][a.msgId]=this._cachedBySnAndMid[a.sn][a.msgId]||[],this._cachedBySnAndMid[a.sn][a.msgId]=b.concat(this._cachedBySnAndMid[a.sn][a.msgId]),!0):void 0}},{key:"getSmartReply",value:function(a,b,c){var d=this,e=this._getLocalData();b||this._cachedBySnAndMid[a]?c(this._cachedBySnAndMid[a]):this.smartRequested=_WA111.rapi.getSuggests({sn:a,withSmartReply:!0},function(b,f,g,h){e.then(function(){h&&h.suggests&&h.suggests.forEach(function(b){("sticker-smartreply"===b.type||"text-smartreply"===b.type)&&b.sn===a&&d._addSuggest(b)}),d.smartRequested===f&&(d.smartRequested=null,c(d._cachedBySnAndMid[a]))})})}},{key:"getData",value:function(a,b,c,d){var e=this._cachedBySnAndText[b]&&this._cachedBySnAndText[b][a];c?this.getLocalData(a,e,d):e||this.getServerData(a,b,d)}},{key:"breakRequest",value:function(){this.requested=null}},{key:"breakSmartRequest",value:function(){this.smartRequested=null}},{key:"clearOld",value:function(a,b){var c=this._cachedBySnAndMid[a];b?c&&Object.keys(c).forEach(function(a){b>a&&delete c[a]}):c&&(this._cachedBySnAndMid[a]={})}},{key:"_onConnectionSuggest",value:function(a){var b=this;("sticker-smartreply"===a.type||"text-smartreply"===a.type)&&this._getLocalData().then(function(){var c=b._addSuggest(a);c&&b.suggestEvent.fire(a.sn)})}}]),b}(_WA111.conn.ES6ConnectionRoster);_WA111.suggestAbstraction=new SuggestAbstraction;var _WA112=WebIM,_UI60=_WA112.ui,_TD36=_WA112.TemplateDriver,_U97=_WA112.util,_AS5=_WA112.AccountSettings,_DomUtil54=_WA112.DomUtil,SUGGESTS_GRACEFUL_INTERVAL=150,SUGGESTS_MAX_ALLOWED_WORDS=10,SUGGESTS_MAX_ALLOWED_CHARS=150,SERVER_SUGGESTS_REQUEST_INTERVAL=300,SERVER_SUGGESTS_MAX_ALLOWED_WORDS=5,SERVER_SUGGESTS_MAX_ALLOWED_CHARS=55,StickersSuggest=function(a){function b(){var a;return _classCallCheck2(this,b),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,{hideOnEscape:!0,cls:"im-stickers-suggest__wrapper",autoRender:!0})),a.abstraction=_WA112.suggestAbstraction,a.itemClickEvent=new _U97.Event,a}return _inherits2(b,a),_createClass2(b,[{key:"fromPicturesMenu",value:function(a,b){if(b){var c=b.getSelector('[data-code="'+a+'"]');c&&(this._emojiElement=c);
}}},{key:"_cleanHandlers",value:function(){this._currentData&&(this._currentData.parent&&this._currentData.parent.un(["mouseup","touchend"],this.hide,this),this._currentData=null),this.fromMenuData&&(this.fromMenuData.imgParent&&this.fromMenuData.imgParent.un("scroll",this.hide,this),this.fromMenuData=null),this.el.un("click",this.onClick,this),this.el.un("wheel",this._onWheel,this),this.el.un(["mouseup","touchend","mousedown"],this._stopPropagation,this)}},{key:"_stopPropagation",value:function(a){a.stopPropagation()}},{key:"updatePosition",value:function(){var a=this.fromMenuData&&this.fromMenuData.img,b=this._currentData&&this._currentData.parent;if(b&&this.el){var c,d=this.el.first(),e=this.el.last(),f=this.el.dom.offsetLeft;a?(c=a.offsetBy(b,!0),c.left=c.left+a.dom.offsetWidth/2-f):c={left:75,top:10},f=c.left,this.el.setStyle({top:c.top+"px",opacity:1});var g=Math.min(this.el.dom.offsetWidth-d.dom.offsetWidth,Math.max(0,f-d.dom.offsetWidth/2));d.setStyle("left",g+"px"),e.setStyle("left",Math.max(20,f)+"px")}}},{key:"_onAfterRender",value:function(){this.el.on("click",this.onClick,this),this.el.on("wheel",this._onWheel,this),this.el.on(["mouseup","touchend","mousedown"],this._stopPropagation,this),this._onShow()}},{key:"_onShow",value:function(){this.initialConfig.hideOnEscape&&(_DomUtil54.getBody().on("keydown",this._onEscape,this),App.on("navigation:back",this._onBack,this)),this._currentData&&(this._currentData.parent.on(["mouseup","touchend"],this.hide,this),this._content=this.el.first().first(),this.updatePosition())}},{key:"_onHide",value:function(){_DomUtil54.getBody().un("keydown",this._onEscape,this),App.off("navigation:back",this._onBack,this),this.el.remove(),this.rendered=!1,delete this.container,delete this.el}},{key:"destroy",value:function(){this.initialConfig.hideOnEscape&&(_DomUtil54.getBody().un("keydown",this._onEscape,this),App.off("navigation:back",this._onBack,this)),this._cleanHandlers(),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}},{key:"_onWheel",value:function(a){var b=a.browserEvent,c=b.deltaY;b.deltaX&&Math.abs(b.deltaX)>Math.abs(c)&&(c=b.deltaX);var d=b.constructor;!d||b.deltaMode!==d.DOM_DELTA_LINE&&b.deltaMode!==d.WM_MOUSEWHEEL&&b.deltaMode!==d.WM_MOUSEHWHEEL||(c*=4),0!==c&&(this._content.dom.scrollLeft=this._content.dom.scrollLeft+c),a.stopEvent()}},{key:"_onEscape",value:function(a){27==a.keyCode&&(a.stopEvent(),this.hide())}},{key:"onClick",value:function(a){var b=a.getTarget(!0),c=b.up("im-ui-button");if(c)c.hasClass("im-stickers-suggest__close")&&this.hide();else{var d=_WA112.Sticker.getStickerIdFromUrl(b.getAttribute("src"));d&&(this.hide(),this.itemClickEvent.fire({id:d}))}a.stopEvent()}},{key:"hide",value:function(){var a=this;this._emojiElement&&(this._emojiElement=null),this.abstraction&&this.abstraction.breakRequest(),this.el&&!this._hideTimer&&(this._cleanHandlers(),this.el.addClass("im-stickers-suggest_hide"),this.el.setStyle("opacity",0),this._hideTimer=_WA112.setTimeout(function(){a._hideTimer=null,_get2(_getPrototypeOf2(b.prototype),"hide",a).call(a)},100))}},{key:"onInput",value:function(a,b,c){var d=this;if(clearTimeout(this._localInterval),clearTimeout(this._serverInterval),a=a.toLowerCase().replace(/^[\s\n\t]+|[\s\n\t]+$/g,""),a&&-1===a.indexOf("@")){this._currentData||(this._currentData={}),this._currentData.text=a,this._currentData.hasData=!1;var e=!_AS5.getOption(_AS5.OPTION_HIDE_STICKER_SUGGEST_BY_WORDS),f=!_AS5.getOption(_AS5.OPTION_HIDE_STICKER_SUGGEST_BY_EMOJI)||e,g=e&&_WA112.configurator.getOption("server_suggests_enabled");_WA112.Feature.getModeParameter("disableStickerSuggest")&&(g=f=!1),this.fromMenuData?f&&(this._show(a,b,c,!0),g&&this._show(a,b,c)):f&&(this._localInterval=_WA112.setTimeout(function(){d._show(a,b,c,!0),g&&(d._serverInterval=_WA112.setTimeout(function(){d._show(a,b,c)},SERVER_SUGGESTS_REQUEST_INTERVAL-SUGGESTS_GRACEFUL_INTERVAL))},SUGGESTS_GRACEFUL_INTERVAL))}else this.hide()}},{key:"_show",value:function(a,b,c,d){var e=this,f=d?SUGGESTS_MAX_ALLOWED_CHARS:SERVER_SUGGESTS_MAX_ALLOWED_CHARS,g=d?SUGGESTS_MAX_ALLOWED_WORDS:SERVER_SUGGESTS_MAX_ALLOWED_WORDS;a.length>f||a.split(/\s+/).length>g?this.hide():this.abstraction.getData(a,c,d,function(c){var d=c.emoji,f=c.words,g=e._currentData||{},h=g.parent,i=g.text,j=g.content,k=g.hasData,l=!k,m=!_AS5.getOption(_AS5.OPTION_HIDE_STICKER_SUGGEST_BY_EMOJI),n=!_AS5.getOption(_AS5.OPTION_HIDE_STICKER_SUGGEST_BY_WORDS);_WA112.Feature.getModeParameter("disableStickerSuggest")&&(m=n=!1);var o=m&&d||n&&f;if(o&&a===i){var p=(k&&j||"")+_WA112.showcasePage.createSuggestPreview(o);if(e._currentData={parent:b,text:a,content:p,hasData:!0},p&&(h||b)){if(l&&(e.fromMenuData&&e.fromMenuData.imgParent&&e.fromMenuData.imgParent.un("scroll",e.hide,e),e._emojiElement&&e._emojiElement.dom&&e._emojiElement.dom.offsetParent?e.fromMenuData=_WA112.splitView&&{img:e._emojiElement,imgParent:e._emojiElement.parent()}:e.fromMenuData=null,e._emojiElement=null),e.el&&h&&b.dom===h.dom){var q=e.el.getSelector(".imStickersSuggestContent");q?j!==p&&q.updateHTML(p):e.hide()}else e.rendered&&(e._cleanHandlers(),e._hideTimer&&(clearTimeout(e._hideTimer),e._hideTimer=null),e._onHide()),e.autoRender=b,e.autoEl={html:_TD36.parseSafe("stickersSuggest",{content:p},{safeKeys:["content"]})},e.show();l&&e.fromMenuData&&e.fromMenuData.imgParent&&e.fromMenuData.imgParent.on("scroll",e.hide,e)}}else l&&e.hide()})}}]),b}(_UI60.ES6Component);_WA112.StickersSuggest=StickersSuggest;var _WA113=WebIM,_UI61=_WA113.ui,_U98=_WA113.util,_TD37=_WA113.TemplateDriver,_AS6=_WA113.AccountSettings,_DomUtil55=_WA113.DomUtil,HIDE_DELAY=3e3,HIDE_ON_CLICK_DELAY=125,CACHED_MESSAGES_NUM=3,_stopEvent5=function(a){a.stopPropagation()},SmartReply=function(a){function b(a){var c,d=a.sn;return _classCallCheck2(this,b),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,{hideOnEscape:!0,cls:"im-stickers-suggest__wrapper"})),c.toggleEvent=new _U98.Event,c.showEvent.on(function(){c.toggleEvent.fire(!0,c.el&&c.el.hasClass("im-stickers-suggest_hide"))}),c.beforeHideEvent.on(function(){c.toggleEvent.fire(!1,!1)}),c.sn=d,c.abstraction=_WA113.suggestAbstraction,c.abstraction.suggestEvent.on(c._onSuggestEvent,_assertThisInitialized2(_assertThisInitialized2(c))),c.itemClickEvent=new _U98.Event,c}return _inherits2(b,a),_createClass2(b,[{key:"_onShow",value:function(){this.el.on("click",this.onClick,this),this.el.on("wheel",this._onWheel,this),this.el.on(["mouseup","touchend","mousedown"],_stopEvent5),_AS6.optionChange.on(this._onOptionChange,this),this.el.setStyle("opacity",1),_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this)}},{key:"_onHide",value:function(){this.el.un("click",this.onClick,this),this.el.un("wheel",this._onWheel,this),this.el.un(["mouseup","touchend","mousedown"],_stopEvent5),_AS6.optionChange.un(this._onOptionChange,this),this.abstraction.clearOld(this.sn,this.lastMidWithSmartReply),this.mainBlock.setStyle("opacity",1),this.el.removeClass("im-stickers-suggest_hide"),_get2(_getPrototypeOf2(b.prototype),"_onHide",this).call(this)}},{key:"_onOptionChange",value:function(a,b){a===_AS6.OPTION_HIDE_SMART_REPLY&&(b?this.hide():this.show())}},{key:"_onRender",value:function(a,b){this.el=_DomUtil55.get(b),this.el.setStyle("display","none"),this.el.updateHTML(_TD37.parseSafe("stickersSuggest",{})),this.toggleButton=this.el.createChild({cls:"im-chat__smart-reply__toggle-button imButton"}),this.contentBlock=this.el.getSelector(".imStickersSuggestContent"),this.mainBlock=this.contentBlock.parent()}},{key:"destroy",value:function(){this.el.un("click",this.onClick,this),this.el.un("wheel",this._onWheel,this),this.el.un(["mouseup","touchend","mousedown"],_stopEvent5),_AS6.optionChange.un(this._onOptionChange,this),this.abstraction.suggestEvent.un(this._onSuggestEvent,this),this.itemClickEvent.removeAll(),_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}},{key:"_onWheel",value:function(a){var b=a.browserEvent,c=b.deltaY;b.deltaX&&Math.abs(b.deltaX)>Math.abs(c)&&(c=b.deltaX);var d=b.constructor;!d||b.deltaMode!==d.DOM_DELTA_LINE&&b.deltaMode!==d.WM_MOUSEWHEEL&&b.deltaMode!==d.WM_MOUSEHWHEEL||(c*=4),0!==c&&this.contentBlock&&(this.contentBlock.dom.scrollLeft=this.contentBlock.dom.scrollLeft+c),this.contentBlock.dom.offsetWidth<this.contentBlock.dom.scrollWidth&&a.stopEvent()}},{key:"onClick",value:function(a){var b=a.getTarget(!0),c=b.up("imButton");if(c)c.hasClass("im-stickers-suggest__close")?this.hide():c.hasClass("im-chat__smart-reply__toggle-button")&&(this.el.hasClass("im-stickers-suggest_hide")?this.show():this.hide());else{var d=b.up("suggestItem");if(d){var e=d.getAttribute("data-mid"),f=d.getAttribute("data-type")+"-smartreply";if("sticker-smartreply"===f){var g=_WA113.Sticker.getStickerIdFromUrl(d.getAttribute("src"));g&&(this.delayHide(HIDE_ON_CLICK_DELAY),this.itemClickEvent.fire({id:g,messageId:e,type:f}))}else{var h=_U98.String.htmlEntity(d.first().dom.innerHTML.replace(/<br\/?>/g,"\n"));h&&(this.delayHide(HIDE_ON_CLICK_DELAY),this.itemClickEvent.fire({text:h,messageId:e,type:f}))}}}a.stopEvent()}},{key:"show",value:function(a){this._hideTimer&&(clearTimeout(this._hideTimer),this._hideTimer=null,this.el&&this.el.setStyle("opacity",1)),this.isHiding=!1,this.isVisible()?a||(_AS6.setOption(_AS6.OPTION_HIDE_SMART_REPLY,!1),this.el.hasClass("im-stickers-suggest_hide")&&(this.el.removeClass("im-stickers-suggest_hide"),this.mainBlock.setStyle("opacity",1),this.toggleEvent.fire(!0,!1))):(a&&_AS6.getOption(_AS6.OPTION_HIDE_SMART_REPLY)?(this.el.addClass("im-stickers-suggest_hide"),this.mainBlock.setStyle("opacity",0)):_AS6.setOption(_AS6.OPTION_HIDE_SMART_REPLY,!1),_get2(_getPrototypeOf2(b.prototype),"show",this).call(this))}},{key:"hide",value:function(a,c){var d=this;if(this.el&&this.isVisible()){var e=this.el.hasClass("im-stickers-suggest_hide");this.isHiding||(this.el.addClass("im-stickers-suggest_hide"),this.isHiding=!0,this._hideTimer&&(clearTimeout(this._hideTimer),this._hideTimer=null)),a?(this.lastMids=null,this.el.setStyle("opacity",0),this._hideTimer||(this._hideTimer=_WA113.setTimeout(function(){d._hideTimer=null,_get2(_getPrototypeOf2(b.prototype),"hide",d).call(d),d.isHiding=!1},100))):(this.isHiding=!1,e||(this.toggleEvent.fire(!1,!0),this.mainBlock.setStyle("opacity",0),c||_AS6.setOption(_AS6.OPTION_HIDE_SMART_REPLY,!0)))}}},{key:"safeHide",value:function(){this.hide(!1,!0)}},{key:"delayHide",value:function(a){var b=this;!this._hideTimer&&this.isVisible()&&(this._hideTimer=_WA113.setTimeout(function(){b._hideTimer=null,b.hide(!0)},a||HIDE_DELAY))}},{key:"_onSuggestEvent",value:function(a){if(a===this.sn){var b=this.lastMids;this.lastMids=null,this.updateAndShow(b)}}},{key:"getCacheSize",value:function(){return CACHED_MESSAGES_NUM}},{key:"updateAndShow",value:function(a){var b=this,c=this.lastMids||[];if(this.lastMids=a,a&&a.length){if(c.join(",")===a.join(","))return;this.abstraction.breakSmartRequest(),this.abstraction.getSmartReply(this.sn,!1,function(a){var c=null;if(a&&b.lastMids&&b.lastMids.length){var d={},e=[];b.lastMids.some(function(b){return a[b]&&a[b].length?(c=b,void a[b].forEach(function(a){if("text"===a.type){var c=a.text;d[c]||(d[c]=!0,e.push(_TD37.parseSafe("textSuggestItem",{text:_U98.String.htmlEntity(c).replace(/\n/g,"<br/>"),mid:b},{safeKeys:["text"]})))}else if(!d[a]){d[a]=!0;var f=_WA113.Sticker.getStickerPreviewUrl("",a,60);e.push(_TD37.parseSafe("stickersSuggestItem",{icon:f,mid:b},{safeKeys:["icon"]}))}})):!0}),b.contentBlock&&e.length?(b.contentBlock.updateHTML(e.join("")),b.show(!0)):b.delayHide()}else b.delayHide();b.lastMidWithSmartReply=c})}else this.lastMidWithSmartReply=!1,this.delayHide()}}]),b}(_UI61.ES6Component);_WA113.SmartReply=SmartReply;var _WA114=WebIM,_U99=_WA114.util,DialogsFlowDate=function(){function a(){_classCallCheck2(this,a)}return _createClass2(a,[{key:"renderBind",value:function(a,b,c){this.top=0,this.padding=10,this.el=a,this.parent=this.el.parent(),this.el.setStyle("top",this.top+"px"),this.isVisible=!1,this.isScrollableMode=!1,this.firstDateIsVisible=!1,this.hideTimer=null,this.opacityTimeout=null,this.nextOffset=0,this.datesBlock=b,this.scrolledBlock=c,this.datesList=b.dom.getElementsByClassName("im-messages__date")}},{key:"onUpdateVisible",value:function(){this.currentDate=this.nextDate=null,this.isScrollableMode&&this.switchOffScrollableMode();var a=this.top,b=this.datesBlock.dom,c=this.scrolledBlock.dom.scrollTop,d=_U99.Array.indexOfBy(this.datesList,function(d){return d.offsetTop+b.offsetTop-c>a});if(d>-1?(this.currentInd=d-1,this.nextDate=this.datesList[d],this.currentDate=d>-1?this.datesList[this.currentInd]:null):this.datesList.length>0&&(this.currentInd=this.datesList.length-1,this.currentDate=this.datesList[this.currentInd]),this.currentDate)this.currentDate.style.visibility="hidden",this.firstDateIsVisible=!1,this.el.updateHTML(this.currentDate.innerHTML),this.nextOffset=this.top+this.padding+this.currentDate.offsetHeight;else{var e=this.getFirstMsgDate();if(!e||this.nextDate&&e===this.nextDate.innerHTML)return this.firstDateIsVisible=!0,void this.hide(!0);this.firstDateIsVisible=!1,this.el.updateHTML(e)}this.onScroll()}},{key:"getFirstMsgDate",value:function(){var a=this.datesBlock.getSelector(".im-message");if(a){var b=a.getAttribute("data-time"),c=new Date,d=_U99.Date.getTimeFromMidnight(c);b=new Date(1e3*b);var e=c.getTime()-b.getTime();return b=d>e?_WA114.tr("time.today"):e<d+1e3*_WA114.DAY?_WA114.tr("time.yesterday"):b.getDate()+" "+_WA114.tr(b.getMonth()+1,{scope:"month_gen"})+(b.getFullYear()<c.getFullYear()?" "+b.getFullYear():""),"<span>"+b+"</span>"}}},{key:"switchToNext",value:function(){return this.currentDate&&(this.currentDate.style.visibility="visible"),this.currentDate=this.nextDate,this.currentInd++,this.nextDate=this.currentInd+1<this.datesList.length?this.datesList[this.currentInd+1]:null,this.nextDate&&this.nextDate.offsetTop+this.datesBlock.dom.offsetTop-this.scrolledBlock.dom.scrollTop<this.top?this.onUpdateVisible():(this.currentDate.style.visibility="hidden",this.nextOffset=this.top+this.padding+this.currentDate.offsetHeight,this.el.updateHTML(this.currentDate.innerHTML),void(this.isScrollableMode&&this.switchOffScrollableMode()))}},{key:"switchToPrev",value:function(){if(this.currentDate){this.currentDate.style.visibility="visible";var a="";if(0===this.currentInd&&(a=this.getFirstMsgDate(),!a||a===this.currentDate.innerHTML))return this.hide(!0),void(this.firstDateIsVisible=!0);if(this.nextDate=this.currentDate,this.currentInd--,this.currentDate=this.currentInd>-1?this.datesList[this.currentInd]:null,this.currentDate){if(this.currentDate.offsetTop+this.datesBlock.dom.offsetTop-this.scrolledBlock.dom.scrollTop>this.top)return this.onUpdateVisible();this.nextOffset=this.top+this.padding+this.currentDate.offsetHeight,this.el.updateHTML(this.currentDate.innerHTML),this.currentDate.style.visibility="hidden"}else this.el.updateHTML(a);this.firstDateIsVisible=!1}}},{key:"switchOnScrollableMode",value:function(a){this.el.setStyle("top",a+"px"),this.el.appendTo(this.scrolledBlock),this.isScrollableMode=!0}},{key:"switchOffScrollableMode",value:function(){this.el.setStyle("top",this.top+"px"),this.el.appendTo(this.parent),this.isScrollableMode=!1}},{key:"onScroll",value:function(){var a;if(this.isScrollableMode)a=this.el.dom.offsetTop-this.scrolledBlock.dom.scrollTop,a>this.top||!this.nextDate?this.switchOffScrollableMode():this.nextDate&&(a=this.nextDate.offsetTop+this.datesBlock.dom.offsetTop-this.scrolledBlock.dom.scrollTop,a<this.top&&this.switchToNext());else if(a=this.nextOffset+1,this.nextDate&&(a=this.nextDate.offsetTop+this.datesBlock.dom.offsetTop-this.scrolledBlock.dom.scrollTop),a>this.nextOffset){if(this.currentDate)if(a=this.currentDate.offsetTop+this.datesBlock.dom.offsetTop-this.scrolledBlock.dom.scrollTop,a<this.top)this.firstDateIsVisible&&(this.currentDate.style.visibility="hidden",this.firstDateIsVisible=!1,this.show(!0));else if(!this.firstDateIsVisible){var b=a<this.nextOffset;if(this.switchToPrev(),this.firstDateIsVisible)return;if(b){var c=(this.currentDate||this.nextDate||{offsetHeight:0}).offsetHeight;this.switchOnScrollableMode(this.scrolledBlock.dom.scrollTop+a-this.padding-c)}}}else a>this.top?this.switchOnScrollableMode(this.top-(this.nextOffset-a)+this.scrolledBlock.dom.scrollTop):this.switchToNext();this.show()}},{key:"renderUnbind",value:function(){this.isVisible=!1,this.el=this.datesBlock=this.scrolledBlock=this.datesList=null}},{key:"hide",value:function(a){this.isVisible&&(this.el.setStyle("opacity",a?null:0),this.opacityTimeout&&(clearTimeout(this.opacityTimeout),this.opacityTimeout=null),a?this.el.setStyle({opacity:0,visibility:"hidden"}):(this.el.setStyle("opacity",a?null:0),this.opacityTimeout=_WA114.setTimeout(function(){this.opacityTimeout=null,this.el&&this.el.setStyle("visibility","hidden")},500,this)),this.isVisible=!1,this.hideTimer&&(clearTimeout(this.hideTimer),this.hideTimer=null))}},{key:"show",value:function(a){this.hideTimer&&clearTimeout(this.hideTimer),this.opacityTimeout&&(clearTimeout(this.opacityTimeout),this.opacityTimeout=null),this.hideTimer=_WA114.setTimeout(this.hide,1500,this),this.isVisible||(this.el.setStyle({visibility:"visible",opacity:a?null:.95}),this.isVisible=!0)}}]),a}();_WA114.DialogsFlowDate=DialogsFlowDate;var _WA115=WebIM,_U100=_WA115.util,_DomUtil56=_WA115.DomUtil,DialogsFlowAvatar=function(){function a(){_classCallCheck2(this,a)}return _createClass2(a,[{key:"renderBind",value:function(a,b,c){this.topLimit=0,this.bottomLimit=4,this.el=a,this.parent=this.el.parent(),this.isVisible=!1,this.isScrollableMode=!1,this.itemsBlock=b,this.scrolledBlock=c,this.el.setStyle("bottom",this.bottomLimit+"px"),this._itemsList=b.dom.getElementsByClassName("imMessage"),this.itemsList=[]}},{key:"onUpdateVisible",value:function(){var a=this;if(this.el){if(this._updateVisibleTimeout)return void(this._needUpdate=!0);this.currentItem=this.nextItem=null,this.isScrollableMode&&this.switchOffScrollableMode();var b=null,c=-1,d=this.scrolledBlock.dom.offsetHeight-this.bottomLimit,e=this.itemsBlock.dom,f=this.scrolledBlock.dom.scrollTop,g=this.itemsList;if(g.length=0,_U100.Array.each(this._itemsList,function(a){return a.className.indexOf("im-message_self")>-1||a.className.indexOf("im-message_event")>-1?void(b=null):void(a.className.indexOf("im-message-group__start")>-1?b=a:-1===a.className.indexOf("im-message-group")||a.className.indexOf("im-message-group__last")>-1?(g.push({startEl:b||a,endEl:a,el:_DomUtil56.get(a).getSelector(".im-avatar-block").dom}),b=null,-1===c&&this._getEnd(g[g.length-1])+e.offsetTop-f>d&&(c=g.length-1)):a.className.indexOf("im-message-group")>-1&&!b&&(b=a))},this),b){var h=this._itemsList[this._itemsList.length-1]||b;g.push({startEl:b,endEl:h,el:_DomUtil56.get(h).getSelector(".im-avatar-block").dom}),-1===c&&this._getEnd(g[g.length-1])+e.offsetTop-f>d&&(c=g.length-1)}if(g.reverse(),c=g.length-1-c,g[c]?(this.currentInd=c,this.nextItem=g[c+1]||null,this.currentItem=g[this.currentInd]):g.length>0&&(this.currentInd=-1,this.currentItem=null,this.nextItem=g[0]),!this.currentItem)return void this.hide(!0);this.currentItem.el&&(this.el.updateHTML(this.currentItem.el.innerHTML),this.currentItem.el.style.visibility="hidden"),this.onScroll(),this._updateVisibleTimeout=_WA115.setTimeout(function(){a._updateVisibleTimeout=null,a._needUpdate&&(a._needUpdate=null,a.onUpdateVisible())},100)}}},{key:"_getStart",value:function(a){return a.startEl.offsetTop}},{key:"_getEnd",value:function(a){return a.el.offsetTop+a.endEl.offsetTop+a.el.offsetHeight}},{key:"_makeRelativeFromBottom",value:function(a){return this.scrolledBlock.dom.offsetHeight-(a+this.itemsBlock.dom.offsetTop-this.scrolledBlock.dom.scrollTop)}},{key:"switchToNext",value:function(){if(this.currentItem&&(this.currentItem.el.style.visibility="visible"),!this.nextItem)return this.hide();if(this._makeRelativeFromBottom(this._getEnd(this.nextItem))>this.bottomLimit)return this.hide();this.currentItem=this.nextItem,this.currentInd++,this.nextItem=this.itemsList[this.currentInd+1]||null;var a=this._getStart(this.currentItem),b=this._makeRelativeFromBottom(a);return b<this.topLimit?this.onUpdateVisible():(this.el.updateHTML(this.currentItem.el.innerHTML),this.checkScrollableMode(a,b),void this.show(!0))}},{key:"switchToPrev",value:function(){if(!this.currentItem)return this.hide();if(this.currentItem.el.style.visibility="visible",this.nextItem=this.currentItem,this.currentInd--,this.currentItem=this.itemsList[this.currentInd]||null,this.isScrollableMode&&this.switchOffScrollableMode(),this.currentItem){if(this._makeRelativeFromBottom(this._getEnd(this.currentItem))>this.bottomLimit)return this.onUpdateVisible();this.el.updateHTML(this.currentItem.el.innerHTML);var a=this._getStart(this.currentItem),b=this._makeRelativeFromBottom(a);if(b<this.topLimit)return this.hide();this.checkScrollableMode(a,b),this.show(!0)}else this.hide()}},{key:"checkScrollableMode",value:function(a,b){var c=a+this.itemsBlock.dom.offsetTop;b-this.currentItem.el.offsetHeight<this.bottomLimit?this.isScrollableMode?this.el.setStyle({top:c+"px",bottom:"auto"}):this.switchOnScrollableMode(c):this.isScrollableMode&&this.switchOffScrollableMode()}},{key:"switchOnScrollableMode",value:function(a){this.el.setStyle({top:a+"px",bottom:"auto"}),this.el.appendTo(this.scrolledBlock),this.isScrollableMode=!0}},{key:"switchOffScrollableMode",value:function(){this.el.setStyle({top:"auto",bottom:this.bottomLimit+"px"}),this.el.appendTo(this.parent),this.isScrollableMode=!1}},{key:"onScroll",value:function(){if(this.el)if(this.currentItem){var a=this._makeRelativeFromBottom(this._getEnd(this.currentItem)),b=this._getStart(this.currentItem),c=this._makeRelativeFromBottom(b);c<this.topLimit?this.switchToNext():a>this.bottomLimit?this.switchToPrev():(this.isScrollableMode?c-this.currentItem.el.offsetHeight>this.bottomLimit&&this.switchOffScrollableMode():c-this.currentItem.el.offsetHeight<this.bottomLimit&&this.switchOnScrollableMode(b+this.itemsBlock.dom.offsetTop),this.show())}else this.nextItem&&this.switchToNext()}},{key:"renderUnbind",value:function(){this.isVisible=!1,this._updateVisibleTimeout&&clearTimeout(this._updateVisibleTimeout),this.el=this._updateVisibleTimeout=this._needUpdate=this.itemsBlock=this.scrolledBlock=this.itemsList=this._itemsList=null}},{key:"hide",value:function(){this.isVisible&&(this.el.setStyle("visibility","hidden"),this.isVisible=!1)}},{key:"show",value:function(a){(!this.isVisible||a)&&(this.el.setStyle("visibility","visible"),this.isVisible=!0,this.currentItem&&(this.currentItem.el.style.visibility="hidden"))}}]),a}();_WA115.DialogsFlowAvatar=DialogsFlowAvatar;var _WA116=WebIM,_U101=_WA116.util,_TD38=_WA116.TemplateDriver,_DomUtil57=_WA116.DomUtil,ListPage=function(a){function b(a,c){var d;return _classCallCheck2(this,b),d=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a)),d.initialConfig=c||{},d.appPageScope="self",d.lineHeight=44,d.itemTmpl="",d.scrollingBarTpl=null,d}return _inherits2(b,a),_createClass2(b,[{key:"beforePageLoad",value:function(a,b){this.el=_DomUtil57.get(a),this.content=this.el.getSelector(".app-content"),this.el.getSelector(".app-topbar__title").updateText(this.initialConfig.topTitle||this.topTitle);var c="";(this.initialConfig.buttons||[]).forEach(function(a){a&&(c+=_TD38.parseSafe("actionButton",a))}),this.el.getSelector(".imListBottom").updateHTML(c);var d=(this.initialConfig.cls||"")+" "+(this.classes||"");d&&_U101.Array.each(d.split(" "),this.el.addClass,this.el),this.scrollingBarTpl&&(this.scrollingBar=this.content.createChild(this.scrollingBarTpl))}},{key:"initSearch",value:function(a){if(this.searchConfig={},this.search){this.searchData=new _WA116.SearchDataAbstraction(this.search.config),this.searchData.searchReadyEvent.on(this._renderSearchResult,this),this.searchData.searchRequestEvent.on(function(){var b=this.getData(!1,a,!0);b?this.searchData.onDataReceived(b):"function"==typeof this.requestData&&this.requestData(a,!0)},this),this.searchField=new _WA116.SearchFieldSimple({cls:"im-search-field",hintText:_WA116.tr("search.search")}),this.searchField.onChangeEvent.on(this.searchData.search,this.searchData),this.searchField.onCancelEvent.on(this._onBeforeEndSearch,this);var b;b=this.search.parentSelector?this.el.getSelector(this.search.parentSelector):this.search.parentBlock?this.content.createChild(this.search.parentBlock):this.content,this.searchField.render(b),this.searchConfig={prepareItem:this.search.prepareItem,prepareItemScope:this.search.prepareItemScope||this,itemTmpl:this.search.itemTmpl,showFavorite:this.search.showFavorite}}}},{key:"onPageLoad",value:function(a,b){b=b||{},this.beforePageLoad(a,b);var c=this.el.getSelector(".im-list-wrapper"),d=this.el.getSelector(".im-list"),e=this;this.dataUpdateEvent&&this.dataUpdateEvent.on(this._onDataUpdateEvent,this);var f=function(a,b,c,d){var f=this.getData(!1,e);f?c.call(d,e.data=f.slice(a,b)||[],f.length):this.requestData&&this.requestData(e)};this.initSearch(e),this.config={uid:this.appPageName,prepareItem:this.prepareItem,prepareItemScope:this,itemHeight:this.lineHeight,buildEntryBundle:this.buildEntryBundle||null,templates:this.templates||null,buildItem:this.buildItem||null,itemTmpl:this.itemTmpl,getList:f,preventOftenRendering:!!this.initialConfig.preventOftenRendering,showFavorite:this.showFavorite,getListScope:this},this.cList=new _WA116.ContactListView(this.config),this.cList._debug=1,this.cList.bindListView(d,c,null),this.el.on("click",this._onClick,this),this.el.getSelector(".imButton[data-back=true]").on("click",this._onBackClick,this),this.afterPageLoad()}},{key:"afterPageLoad",value:function(){this.search&&!this.search.skipFocus&&this.searchField&&this.searchField.focus(),this.onUpdate(null),this.cList.activate(this.getData(!1,this))}},{key:"onUpdate",value:function(){}},{key:"onBackClick",value:function(){}},{key:"onClick",value:function(){}},{key:"prepareItem",value:function(){}},{key:"getData",value:function(){}},{key:"requestData",value:function(){}},{key:"onPageUnload",value:function(a){this.cList.deactivate(),this.searchData&&this.searchData.destroy(),this.searchField&&this.searchField.destroy(),this.searchMode=!1,this.el.un("click",this._onClick,this),this.dataUpdateEvent&&this.dataUpdateEvent.un(this._onDataUpdateEvent,this)}},{key:"_onBackClick",value:function(a){this.onBackClick(a)!==!1&&_WA116.Pane.back(this)}},{key:"_onClick",value:function(a){var b=a.getTarget(!0),c=b.up("imButton")||b.up("im-ui-button"),d={button:c,action:c&&c.getAttribute("data-action"),isBack:c&&!!c.dom.getAttribute("data-back"),isBottom:c&&c.up("imListBottom"),target:b,event:a};"cancel"==d.action?this._onBackClick():this.onClick(d)}},{key:"_onDataUpdateEvent",value:function(a){if(this.onUpdate(a),this.searchMode&&this.searchData){this.data=this.getData(!0,this,!0),this.searchData.onDataReceived(this.data);var b=_WA116.isArray(this.cList.searchQuery)?this.cList.searchQuery[0]:this.cList.searchQuery;this.searchData.search(b)}else this.cList.redraw()}},{key:"_renderSearchResult",value:function(a,b,c){a&&a.length&&(this.data=a),this.searchMode||(this.cList.deactivate(),this.cList.contentEl.updateText(""),this.cList.el.addClass("im-clist_search_mode"),this.cList.configure(this.searchConfig),this.searchMode=!0,this.cList.activate()),this.cList.searchQuery=c||b,this.cList.renderList(a),this.cList.el.dom.scrollTop=0}},{key:"_onBeforeEndSearch",value:function(a){return this.searchMode&&(this.cList.deactivate(),this.cList.contentEl.updateText(""),this.cList.el.dom.scrollTop=0,this.cList.el.removeClass("im-clist_search_mode"),this.cList.configure(this.config),this.cList.searchQuery="",this.cList.activate(),this.searchMode=!1),!0}},{key:"_removeFromHistory",value:function(){App.off("page:hide",this._removeFromHistory,this);var a=App.indexOfPage(this.appPageName);a>-1&&App.spliceHistory(a,1),delete this._unloadEventAdded}},{key:"unloadIfDialogIsOpened",value:function(a){var b="dialog"===a.pageName;if((b||a.pageName===this.appPageName)&&(App.off("page:show",this.unloadIfDialogIsOpened,this),b)){var c=App.indexOfPage(this.appPageName);c>-1&&App.spliceHistory(c,1)}}},{key:"unloadOnHide",value:function(){this._unloadEventAdded||(this._unloadEventAdded=!0,App.on("page:hide",this._removeFromHistory,this))}}]),b}(_WA116.Page);_WA116.ListPage=ListPage;var _WA117=WebIM,_U102=_WA117.util,_TD39=_WA117.TemplateDriver,_UI62=_WA117.ui,MAX_OPTIONS_COUNT=10,MAX_OPTION_TEXT_LIMIT=140;OPTION_TEXT_LIMIT_WARNING=70;var CreatePollBox=function(a){function b(){var a,c=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return _classCallCheck2(this,b),_WA117.applyIf(c,{title:_WA117.tr("polls.createPoll"),blockCls:"im-poll-create",content:_WA117.TD.getTMPL("createPoll"),allowTouchEvents:!0,buttons:[{action:"cancel",text:_WA117.tr("box.cancel")},{action:"ok",text:_WA117.tr("dialog.send"),cls:"im-button_highlight"}]}),a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,c)),a.fieldsCount=0,a._textFields=[],a}return _inherits2(b,a),_createClass2(b,[{key:"_getOptionsLength",value:function(){return this.optionList.dom.children.length}},{key:"addOption",value:function(){var a=this;if(!(this._getOptionsLength()>=MAX_OPTIONS_COUNT)){var b=this.fieldsCount,c=_TD39.parseSafe("createPollOption",{idx:b}),d=this.optionList.appendChild(_U102.DomHelper.elementFromHtml(c)),e=new _UI62.SmilesTextField({strictMaxLength:MAX_OPTION_TEXT_LIMIT,expandHeight:!0});return e.renderBind(d.first()),e.changeEvent.on(function(c){a._onOptionChange(b,c)}),e.focus(!0),this._textFields[b]=e,this.fieldsCount++,this._validateForm(),this.scrollBar.scrollToBottom(),this}}},{key:"removeOption",value:function(a){return this._getOptionsLength()>1&&(this._textFields[a].changeEvent.removeAll(),this._textFields[a].renderUnbind(),this.block.getSelector('.imOption[data-index="'+a+'"]').remove()),this._validateForm(),this.scrollBar.sync(),this}},{key:"_validateForm",value:function(){this.block.getSelector('.imButton[data-action="addOption"]').setVisible(this._getOptionsLength()<MAX_OPTIONS_COUNT),this.block.getSelector('.imButton[data-action="ok"]').setDisabled(!this._isValid())}},{key:"_isValid",value:function(){var a=_U102.String.trim(this.titleInput.dom.value),b=this._collectOptions();return!!a&&b.length}},{key:"_collectOptions",value:function(){var a=this,b=[];return this.optionList.each(function(c){var d=c.getAttribute("data-index"),e=_U102.String.trim(a._textFields[d].textVal());e&&b.push(e)}),b}},{key:"_onOptionChange",value:function(a,b){var c=MAX_OPTION_TEXT_LIMIT-b.length,d=this.block.getSelector('.imOption[data-index="'+a+'"] .imOptionCounter');d.updateText(c>OPTION_TEXT_LIMIT_WARNING?"":c),d.toggleClass("im-label-red",0>c),this._validateForm(),this.scrollBar.sync()}},{key:"_onOk",value:function(){if(this._isValid()){var a=_U102.String.trim(this.titleInput.dom.value),b=this._collectOptions();this.initialConfig.onEditOk({title:a,answers:b}),this.hide()}}},{key:"_onClick",value:function(a){var b=a.up("imButton"),c=b&&b.getAttribute("data-action"),d=a.up("imOption");switch(c){case"addOption":this.addOption();break;case"removeOption":this.removeOption(d.getAttribute("data-index"));break;case"ok":this._onOk();break;case"cancel":this.hide()}}},{key:"_onShow",value:function(){_get2(_getPrototypeOf2(b.prototype),"_onShow",this).call(this),this.optionList=this.block.getSelector(".imOptions"),this.titleInput=this.block.getSelector(".imFieldTitle"),this.block.on("input",this._validateForm,this),this.scrollBar=new _UI62.ScrollBar({source:this.block.getSelector(".imPollCreate"),watchResize:!1}),this.addOption().addOption(),this.titleInput.dom.focus(),this.dragger=new _UI62.DragItems({container:this.optionList,dragButtonClass:"im-poll-create__option__drag",dragItemClass:"imOption"})}},{key:"destroy",value:function(){this.dragger.destroy(),this.scrollBar.destroy(),this.block.un("input",this._validateForm,this),this.optionList=null,this.titleInput=null,this.block=null,
_get2(_getPrototypeOf2(b.prototype),"destroy",this).call(this)}}]),b}(_UI62.ConfirmModalBox);_WA117.CreatePollBox=CreatePollBox;var _WA118=WebIM,_TD40=_WA118.TemplateDriver,_U103=_WA118.util,_stopEventPropagation=function(a){a.browserEvent.stopPropagation()},namesForGroup=["group.coolGroup","group.newGroup","group.myCoolGroup","group.myNewGroup"],generateGroupName=function(){var a=Math.floor(Math.random()*namesForGroup.length),b=new Date;return _WA118.tr(namesForGroup[a])+" "+(b.getMonth()+b.getDate()+b.getHours()+b.getMinutes()+b.getSeconds())},AddMemberListPage=function(a){function b(){var a;_classCallCheck2(this,b);var c={topTitle:_WA118.tr("chat.selectViewContacts"),cls:"im-select-list",preventOftenRendering:!0,buttons:[{action:"cancel",text:_WA118.tr("dialog.tools.cancel")},{action:"ok",text:_WA118.tr("done"),cls:"im-button_highlight im-button_disabled"}]},d=_TD40.parseSafe("contactListItem",{extraClasses:"im-list-contact__${checked}",ending:'<div class="im-tickbox im-tickbox_${checked}"></div>'},{reusable:!0,safeKeys:["extraClasses","ending"]});return a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"addmemberlist",c)),a.dataUpdateEvent=new _U103.Event,a.itemTmpl=d,a.search={parentBlock:{tag:"div",cls:"im-search"},config:{remoteSearchAsync:!0}},App.populate("addmemberlist",a.onPageLoad,a.onPageUnload,_assertThisInitialized2(_assertThisInitialized2(a))),a}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a,c){this.isChat=c.isChat,this.onMembersAdded=c.onMembersAdded,this.createGroupCallback=c.createGroupCallback,this.contactData=c.cntctData,this.allowEmpty=c.allowEmpty,c.showGroupNameBlock?(this.initialConfig.buttons[1].text=_WA118.tr("create"),this.initialConfig.topTitle=_WA118.tr(_WA118.Feature.getModeParameter("createGroupTitleTrKey"))):(this.initialConfig.buttons[1].text=_WA118.tr("done"),this.initialConfig.topTitle=_WA118.tr("chat.selectViewContacts")),delete this.__data,delete this.__searchData,delete this.__memberList,delete this._notFirstUpdate,delete this.bottomClicked,this._selected={},this._selectedSize=0,this._selectedStack=[],_get2(_getPrototypeOf2(b.prototype),"onPageLoad",this).call(this,a,c),this.groupNameBlock&&this.groupNameBlock.focus()}},{key:"beforePageLoad",value:function(a,c){_get2(_getPrototypeOf2(b.prototype),"beforePageLoad",this).call(this,a,c),this._initStackNode(),c.showGroupNameBlock&&(this._initNameBlock(c.chatName),this.search.skipFocus=!0),this.el.toggleClass("im-select-list_without-back",!!c.disableBack)}},{key:"onPageUnload",value:function(a){this.stackNode&&(this.stackNode.un("wheel",this._onStackWheel,this),this.stackNode.un("touchmove",_stopEventPropagation),this.stackNode=null),this.groupNameBlock&&(this.groupNameBlock.destroy(),this.groupNameBlock=null),_get2(_getPrototypeOf2(b.prototype),"onPageUnload",this).call(this,a)}},{key:"_initStackNode",value:function(){this.stackNode||(this.stackNode=this.content.getSelector(".imListStack"),this.stackNode.on("touchmove",_stopEventPropagation),_WA118.isDesktop&&(this.stackNode.setStyle("overflow","hidden"),this.stackNode.on("wheel",this._onStackWheel,this)))}},{key:"_initNameBlock",value:function(a){var b=this;this.el.addClass("im-create-group"),this.groupNameBlock=new _WA118.ui.GroupNameBlock({chatName:a,placeHolder:_WA118.tr("group.name")}),this.groupNameBlock.changeEvent.on(function(){b._checkOkButton()}),this.groupNameBlock.render(this.content)}},{key:"_checkOkButton",value:function(){var a=!this.allowEmpty&&0===this._selectedSize||this.groupNameBlock&&!this.groupNameBlock.getName();this.el.getSelector('.imListBottom .imButton[data-action="ok"]').toggleClass("im-button_disabled",!!a)}},{key:"_onStackWheel",value:function(a){var b=a.browserEvent,c=b.deltaY,d=b.constructor;b.deltaX&&Math.abs(b.deltaX)>Math.abs(c)&&(c=b.deltaX),!d||b.deltaMode!==d.DOM_DELTA_LINE&&b.deltaMode!==d.WM_MOUSEWHEEL&&b.deltaMode!==d.WM_MOUSEHWHEEL||(c*=4),0!==c&&(this.stackNode.dom.scrollLeft=this.stackNode.dom.scrollLeft+c),a.stopEvent()}},{key:"prepareItem",value:function(a,b,c,d){return a.idx=c,d.searchQuery&&(a.offset="0"),this._selected&&this._selected[b[0]]&&(a.checked="checked"),a}},{key:"requestData",value:function(a,b){_WA118.chatController.infoReadyEvent.on(function(a,b,c){if(_WA118.overlayScreen.hide(),b&&a===this.contactData[0]){var d={};_U103.Array.each(c.members,function(a){d[a.email]=1}),_U103.Array.each(c.blockedList||[],function(a){d[a.email]=1}),this.__memberList=d,this.dataUpdateEvent.fire()}},this,{single:!0}),_WA118.overlayScreen.show(_WA118.tr("chat.membersListLoading"),!0),_WA118.chatController.getChatInfo(this.contactData[0],0,!1,!0)}},{key:"getData",value:function(a,b,c){if(this.isChat&&this.contactData)return this._getDataChat(a,c);var d=_WA118.ma.contactList.abstraction;this._notFirstUpdate||(this._notFirstUpdate=!0,this._selected={},this.contactData?(this._selected[this.contactData[0]]=this.contactData,this._selectedSize=1,this._selectedStack.unshift(this.contactData[0])):(this._selectedSize=0,this._selectedStack=[]),this.isChat||(this._initStackNode(),this.stackNode&&this._updateStackNode())),this._checkOkButton();var e=this.contactData&&this.contactData[0],f=_WA118.ma.dialogsWindow.getRecentData(),g=f.recent,h=f.recentKeys,i=[];return i=c?g.concat(d.getFullData(function(a){return!h[a[0]]})):g.concat(d.getFullData(function(a){return!h[a[0]]&&(!_WA118.CLD.getStranger(a[0])||e&&a[0]===e)})),_U103.Array.filter(i,function(a){return!_WA118.MainAgent.isChat(a[0])})}},{key:"_getDataChat",value:function(a,b){if(this.__memberList){var c=b?this.__searchData:this.__data;if(!c){var d=_WA118.ma.contactList.abstraction,e=_WA118.ma.dialogsWindow.getRecentData(),f=e.recent,g=e.recentKeys,h=this.__memberList,i=[];i=b?f.concat(d.getFullData(function(a){return!g[a[0]]})):f.concat(d.getFullData(function(a){return!g[a[0]]&&!_WA118.CLD.getStranger(a[0])})),c=_U103.Array.filter(i,function(a){return!_WA118.MainAgent.isChat(a[0])&&!h[a[0]]}),b?this.__searchData=c:this.__data=c}return c}}},{key:"_beforeCreateGroup",value:function(a){return new Promise(function(b,c){if(a.length)b();else{var d=new _WA118.ui.ConfirmModalBox({content:_WA118.tr("group.createGroupWithoutMembers"),buttons:[{action:"cancel",text:_WA118.tr("box.cancel")},{action:"ok",text:_WA118.tr("create"),cls:"im-button_highlight"}]});d.actionEvent.on(function(a){"ok"===a?b():c()}),d.show()}})}},{key:"onClick",value:function(a){"ok"===a.action?this._onBottomClick(a.button):"generateName"===a.action?this.groupNameBlock&&this.groupNameBlock.setName(generateGroupName()):a.target.up("imListStack")?this._onStackClick(a.target):this._onContactClick(this.contactData,a.target.up("im-cl-contact"))}},{key:"_onBottomClick",value:function(a){var b=this;if(!a.hasClass("im-button_disabled")){var c=this.contactData;if(!this.bottomClicked&&(this._selectedSize||this.allowEmpty)){var d=[];if(_U103.Object.each(this._selected,function(a){d.push(a)}),this.bottomClicked=!0,this.isChat)d.length?(_WA118.overlayScreen.show(_WA118.tr("chat.pleaseWait"),!0),_WA118.chatController.addMembers(c[0],d,function(a){_WA118.overlayScreen.hide(),this.bottomClicked=!1,a?(this.onMembersAdded&&this.onMembersAdded(this,d),_WA118.Pane.back()):_WA118.showPopup(_WA118.tr("chat.addingFailed"))},this)):(this.bottomClicked=!1,this.onMembersAdded&&this.onMembersAdded(this,d),_WA118.Pane.back());else if(c||this.groupNameBlock){var e=this.groupNameBlock&&this.groupNameBlock.getName()||d.length>1&&d[0][1]+", "+d[1][1];e&&this._beforeCreateGroup(d).then(function(){_WA118.overlayScreen.show(_WA118.tr("chat.pleaseWait"),!0);var a=b.groupNameBlock?b.groupNameBlock.uploadAvatar():Promise.resolve({});a.then(function(a){var c=a.avatarId;_WA118.chatController.createGroupChat(d,e,c&&{avatarId:c}).then(function(a){_WA118.overlayScreen.hide(),b.bottomClicked=!1,b.onMembersAdded&&b.onMembersAdded(b,d),a&&b.createGroupCallback&&b.createGroupCallback(a),b.unloadOnHide(),a&&_WA118.ma.openDialog(_WA118.makeContactArray(a,e))})})})["catch"](function(a){b.bottomClicked=!1})}else this.onMembersAdded&&this.onMembersAdded(this,d)}}}},{key:"_updateStackNode",value:function(){var a=this;this.el.toggleClass("im-select-list_with-stack",this._selectedSize>0);var b=this.stackNode.dom.children.length,c="";this._selectedStack.forEach(function(a){c+=_WA118.Ava.make(a,_WA118.CLD.getFriendlyName(a),40)},this),this._selectedSize&&b&&b<this._selectedSize?(this.stackNode.addClass("im-list-stack_push"),this.stackNode.updateHTML(c),_WA118.setTimeout(function(){a.stackNode.removeClass("im-list-stack_push")},10)):this.stackNode.updateHTML(c),this._checkOkButton()}},{key:"_onContactClick",value:function(a,b){if(b){var c=!b.hasClass("im-list-contact__checked"),d=b&&b.getAttribute("idx")||0,e=b&&b.getAttribute("mail");this.data&&this.data[d]&&this.data[d][0]===e&&(b.toggleClass("im-list-contact__checked",c),b.getSelector(".im-tickbox").toggleClass("im-tickbox_checked",c),this._selected||(this._selectedSize=0,this._selected={}),c?(this._selectedStack.unshift(e),this._selected[e]=this.data[d],this._selectedSize++):this._selected[e]&&(this._selectedSize--,_U103.Array.remove(this._selectedStack,e),delete this._selected[e]),this._checkOkButton(),this.stackNode&&this._updateStackNode())}}},{key:"_onStackClick",value:function(a){var b=a.up("im-avatarbox"),c=b&&b.getAttribute("data-sn");c&&this._selected[c]&&(this._selectedSize--,_U103.Array.remove(this._selectedStack,c),delete this._selected[c],this._updateStackNode(),this.cList.redraw(this.data))}}]),b}(_WA118.ListPage);_WA118.AddMemberListPage=AddMemberListPage;var _WA119=WebIM,_U104=_WA119.util,listTypeConfigs={admins:{getMethod:"getChatAdmins",listName:"adminList"},members:{getMethod:"getChatInfo",listName:"members"},blocked:{getMethod:"getBlockedMembers",listName:"blockedList"},pending:{getMethod:"getPendingList",listName:"pendingList",bottomTitle:_WA119.tr("chat.approveAll")}},MemberListPage=function(a){function b(){var a;_classCallCheck2(this,b);var c={topTitle:_WA119.tr("chat.allMembers"),cls:"im-chatmembers-list",buttons:[{action:"cancel",text:_WA119.tr("box.close")}],pendingButton:{action:"ok",text:_WA119.tr("chat.approveAll"),cls:"im-button_highlight"}};return a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"memberlist",c)),a.dataUpdateEvent=new _U104.Event,a.itemTmpl=_WA119.TD.getTMPL("groupMemberItem"),a._additionalData={},a.search={parentBlock:{tag:"div",cls:"im-search"}},App.populate("memberlist",a.onPageLoad,a.onPageUnload,_assertThisInitialized2(_assertThisInitialized2(a))),a}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a,c){this.email=c.email,this.listType=c.type,this.chatRole={},this.classes="im-chatmembers-"+this.listType,this.initialConfig.topTitle="members"===this.listType?_WA119.tr("chat.allMembers"):_WA119.tr("chat."+this.listType);var d=listTypeConfigs[c.type||"members"];this.initialConfig.buttons[1]="pending"===this.listType?this.initialConfig.pendingButton:null,this._getMethodName=d.getMethod,this._dataListName=d.listName,delete this.__blockedData,delete this.__data,_WA119.chatController.infoReadyEvent.on(this._onInfoReady,this),_WA119.chatController.infoChangedEvent.on(this._onInfoChanged,this),_get2(_getPrototypeOf2(b.prototype),"onPageLoad",this).call(this,a,c),this.el&&this.el.on("contextmenu",this._showContextMenu,this)}},{key:"onPageUnload",value:function(a){_get2(_getPrototypeOf2(b.prototype),"onPageUnload",this).call(this,a),this.el&&this.el.un("contextmenu",this._showContextMenu,this),_WA119.chatController.infoReadyEvent.un(this._onInfoReady,this),_WA119.chatController.infoChangedEvent.un(this._onInfoChanged,this),delete this.__blockedData,delete this.__data}},{key:"prepareItem",value:function(a,b,c,d){d.searchQuery&&(a.offset="0");var e=this._additionalData[b[0]]||{canAdd:!0},f="";return"admin"===e.role||"moder"===e.role?(a.role="admin",f=_WA119.tr("group.roleAdmin")):"readonly"===e.role&&(a.role="readonly",f=this.isChannel?"":_WA119.tr("group.roleReadonly")),e.creator&&(f=_WA119.tr("group.roleCreator")),a.roleTitle=f,f&&(a.classes=(a.classes||"")+" im-member-item_has-role"),a}},{key:"_onInfoReady",value:function(a,b,c){b&&a===this.email&&(this.isChannel=c&&"readonly"===c.defaultRole,this.dataUpdateEvent.fire(c))}},{key:"_onInfoChanged",value:function(a,b){a===this.email&&b.membersChanged&&this.requestData()}},{key:"onUpdate",value:function(a){if(a){var b=!(!a.controlled||a.you&&("admin"===a.you.role||"moder"===a.you.role));this.chatRole={locked:b,isAdmin:a.you&&"admin"===a.you.role},this.chatRole.isModer=this.chatRole.isAdmin||a.you&&"moder"===a.you.role,this.el.toggleClass("im-chatmembers__locked",b);var c=[],d={};if(_U104.Array.each(a[this._dataListName]||a.members,function(a){var b=_WA119.contactToArray({email:a.email,nick:a.friendly||(a.firstName||"")+(a.firstName&&a.lastName?" ":"")+(a.lastName||"")||"",status:"",statusTitle:"",mute:_WA119.CLD.getMute(a.email),official:a.official||a.honours&&a.honours.indexOf("official")>-1||0,lastseen:_WA119.CLD.getLastseen(a.email),userState:_WA119.CLD.getUserState(a.email),bot:_WA119.CLD.isBot(a.email),uNick:a.uNick});d[a.email]={canAdd:!(a.inCL||a.email===_WA119.ACTIVE_MAIL),creator:a.creator,role:"member"!==a.role&&a.role,isActive:a.email===_WA119.ACTIVE_MAIL},c.push(b)}),this._additionalData=d,this.__data=c,!c.length)if(_WA119.Pane.isCurrentPage("memberlist"))_WA119.Pane.back();else{var e=App.indexOfPage("memberlist");e>-1&&App.spliceHistory(e,1)}}}},{key:"_showContextMenu",value:function(a){var b=this,c=a.getTarget(!0),d=c.up("imContact");if(d){var e=d.getAttribute("data-sn"),f=d.getAttribute("data-friendly"),g=d.getAttribute("data-role"),h=_WA119.CLD.inList(e)&&_WA119.CLD.getInfoArray(e),i="admin"===g,j="readonly"===g,k=["profile"];e!==_WA119.ACTIVE_MAIL&&(this.chatRole&&this.chatRole.isModer&&(!i||this.chatRole.isAdmin)&&("pending"===this.listType?k=["profile"]:"admins"===this.listType?(k=["profile","spam"],this.chatRole.isAdmin&&k.unshift("removeAdminRights")):"blocked"===this.listType?k=["profile","unblock"]:"members"===this.listType&&(k=[j?"allowWriting":"forbidWriting","removeAndBlock"],this.chatRole.isAdmin&&k.unshift(i?"removeAdminRights":"giveAdminRights"))),"members"===this.listType&&k.push("spam")),k.length&&_WA119.contextMenu.show(a,k,{mail:e,chat_id:this.email,nick:f,contact:h||_WA119.makeContactArray(e,f,1)},{any:function(a,b){_WA119.chatController.chatMemberAction(a,b)},profile:function(a){_WA119.splitView&&_WA119.Pane.back(b),_WA119.contactAbstraction.openProfile(a.mail,a.nick)}}),a.stopEvent()}}},{key:"getData",value:function(a){return this.__data}},{key:"requestData",value:function(){_WA119.chatController[this._getMethodName]&&_WA119.chatController[this._getMethodName](this.email,0,!0);var a=_WA119.TD.getTMPL("CircleSpinner");this.cList&&this.cList.el&&(this.cList.contentEl||this.cList.el).updateHTML(a)}},{key:"onExcludeAction",value:function(a){var b=this;"pending"===this.listType?_WA119.chatController.resolvePending({email:this.email,member:a,approve:!1},function(a){200===a&&b.requestData()}):_WA119.chatController.delMembers(this.email,[[a]])}},{key:"_doOkAction",value:function(){if("pending"===this.listType){var a=[];_U104.Array.each(this.__data,function(b){a.push({sn:b[0],approve:!0})}),_WA119.chatController.resolvePending({email:this.email,members:a})}else _WA119.DialogsAgent.showAddMemberDialog({contact:[this.email],isChat:!0,callback:this.unloadOnHide.bind(this),force:!0})}},{key:"onClick",value:function(a){if(_WA119.contextMenu.isVisible())return a.event.stopEvent(),!1;var b=a.button&&a.button.up("imContact"),c=b&&b.getAttribute("data-sn");switch(a.action){case"ok":this._doOkAction();break;case"memberMenu":this._showContextMenu(a.event);break;case"exclude":this.onExcludeAction(c);break;case"approveUser":_WA119.chatController.resolvePending({email:this.email,member:c,approve:!0});break;default:a.button&&a.button.hasClass("imContact")&&(_WA119.splitView?_WA119.Pane.back(this):App.on("page:show",this.unloadIfDialogIsOpened,this),_WA119.ma.openProfile({mail:c,nick:b.getAttribute("data-friendly")}))}}}]),b}(_WA119.ListPage);_WA119.MemberListPage=MemberListPage;var _WA120=WebIM,_U105=_WA120.util,GroupListPage=function(a){function b(){var a;_classCallCheck2(this,b);var c={topTitle:_WA120.tr("contact.commonGroups"),cls:"im-commonchats-list",buttons:[{action:"cancel",text:_WA120.tr("box.close")}]};return a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"groupList",c)),a.buildEntryBundle=a._buildEntryBundle.bind(_assertThisInitialized2(_assertThisInitialized2(a))),a.templates={contact:_WA120.TD.getTMPL("commonGroupsItem")},a.dataUpdateEvent=new _U105.Event,a.search={parentBlock:{tag:"div",cls:"im-search"}},a}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a,c){this.sn=c.sn,delete this.__data,_get2(_getPrototypeOf2(b.prototype),"onPageLoad",this).call(this,a,c),this.searchConfig=this.config}},{key:"_buildEntryBundle",value:function(a,b,c,d){var e=b[0],f=b[1],g=b[2],h=_WA120.Ava.make(e,f,32,null);return{sn:_U105.String.htmlEntity(e),friendly:_WA120.Emoji.parse(_U105.String.htmlEntity(f||e)),dataFriendly:_U105.String.htmlEntity(f),subtitle:_WA120.tr("chat.countMembers",{count:g}),avatarHtml:h,offset:d}}},{key:"onUpdate",value:function(a){a&&(this.__data=a)}},{key:"getData",value:function(a,b,c){return c||!this.__data?this.__data:this._driveViewData(this.__data)}},{key:"_driveViewData",value:function(a){var b=[];return a&&_U105.Array.each(a,function(a){b.push({entryType:"contact",entryData:a})},this),b}},{key:"_renderSearchResult",value:function(a,c,d){_get2(_getPrototypeOf2(b.prototype),"_renderSearchResult",this).call(this,this._driveViewData(a),c,d)}},{key:"onClick",value:function(a){"openProfile"===a.action&&(_WA120.splitView?_WA120.Pane.back(this):App.on("page:show",this.unloadIfDialogIsOpened,this),_WA120.contactAbstraction.openDialog(a.button.getAttribute("data-sn"),a.button.getAttribute("data-friendly")))}},{key:"requestData",value:function(){var a=this;_WA120.chatController.getCommonChats(this.sn,function(b){if(b){var c=[];b.chats.forEach(function(a){c.push([a.sn,a.name,a.membersCount])}),a.dataUpdateEvent.fire(c)}});var b=_WA120.TD.getTMPL("CircleSpinner");this.cList&&this.cList.el&&(this.cList.contentEl||this.cList.el).updateHTML(b)}}]),b}(_WA120.ListPage);_WA120.GroupListPage=GroupListPage;var _WA121=WebIM,_TD41=_WA121.TemplateDriver,_U106=_WA121.util,_stopEventPropagation2=function(a){a.browserEvent.stopPropagation()},mixFavoriteInList=function(a){var b,c=_U106.Array.indexOfBy(a,function(a){return a[0]===_WA121.ACTIVE_MAIL});c>-1?(b=a[c],c&&(a.splice(c,1),a.unshift(b))):(b=_WA121.CLD.getInfoArray(_WA121.ACTIVE_MAIL),a.unshift(b))},ForwardListPage=function(a){function b(){var a;_classCallCheck2(this,b);var c={topTitle:_WA121.tr("contextmenu.resend"),cls:"im-select-list im-forward-page",buttons:[{action:"cancel",text:_WA121.tr("dialog.tools.cancel")},{action:"ok",text:_WA121.tr("contextmenu.resend"),cls:"im-button_highlight im-button_disabled"}]},d=_TD41.parseSafe("contactListItem",{extraClasses:"im-list-contact__${checked}",ending:'<div class="im-tickbox im-tickbox_${checked}"></div>'},{reusable:!0,safeKeys:["extraClasses","ending"]});return a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"forwardlist",c)),a.forwardMessageEvent=new _U106.Event,a.itemTmpl=d,a.showFavorite=!0,a._cachedRecent=null,a._cachedSearchData=null,a._selected={},a._selectedStack=[],a._selectedSize=0,a.search={showFavorite:!0,parentBlock:{tag:"div",cls:"im-search"},config:{remoteSearchAsync:!0}},a}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a,c){this.msg=c.msg,this.email=c.email,this.nick=c.nick;var d=c.skipOptions?!1:_WA121.isObject(this.msg);this.classes=d?"im-forward-with_config":"",this._cachedRecent=null,this._cachedSearchData=null,this._selected={},this._selectedStack=[],this._selectedSize=0,this._onBack=c.onBack||function(){},_get2(_getPrototypeOf2(b.prototype),"onPageLoad",this).call(this,a,c),this.hideMessageAuthor=!d,this.stackNode=this.content.getSelector(".imListStack"),this.stackNode.on("touchmove",_stopEventPropagation2),_WA121.isDesktop&&(this.stackNode.setStyle("overflow","hidden"),this.stackNode.on("wheel",this._onStackWheel,this)),d&&this._prepareForwardConfig()}},{key:"onPageUnload",value:function(a){this.stackNode.un("wheel",this._onStackWheel,this),this.stackNode.un("touchmove",_stopEventPropagation2),_get2(_getPrototypeOf2(b.prototype),"onPageUnload",this).call(this,a)}},{key:"_onStackWheel",value:function(a){var b=a.browserEvent,c=b.deltaY,d=b.constructor;b.deltaX&&Math.abs(b.deltaX)>Math.abs(c)&&(c=b.deltaX),!d||b.deltaMode!==d.DOM_DELTA_LINE&&b.deltaMode!==d.WM_MOUSEWHEEL&&b.deltaMode!==d.WM_MOUSEHWHEEL||(c*=4),0!==c&&(this.stackNode.dom.scrollLeft=this.stackNode.dom.scrollLeft+c),a.stopEvent()}},{key:"_prepareForwardConfig",value:function(){var a=this,b=_WA121.MainAgent.isChat(this.email),c=b?this.nick||this.email:"",d=b&&_WA121.chatController.getCachedChatInfo(this.email),e=this.msg.senderFriendly||_WA121.CLD.getFriendlyName(this.msg.sender)||this.nick;if((this.msg.sender===_WA121.ACTIVE_MAIL||this.msg.from===_WA121.ACTIVE_MAIL)&&(e=_WA121.CLD.getFriendlyName(this.msg.sender||this.msg.from)),this.msg.parts){var f={},g=[],h=!1,i=!1;this.msg.parts.forEach(function(b){var c=b.chat||!b.sn&&d&&{name:d.name,sn:a.email,stamp:d["public"]&&d.stamp};c&&!h&&(i?i.sn!==c.sn&&(h=!0,i=!1):i={name:c.name||_WA121.CLD.getFriendlyName(c.sn),sn:c.sn,stamp:c.stamp});var j=b.sn?b.friendly||_WA121.CLD.getFriendlyName(b.sn):e;f[j]||(f[j]=!0,g.push(j))}),1===g.length&&i&&this.msg.parts[0].sn===i.sn&&(g=[i.name],i=!1),e=g.join(", "),c=h?"":i&&i.name}(c===e||d&&"readonly"===d.defaultRole)&&(e=c,c=""),this.content.createChild(_TD41.parseSafe("forwardConfig",{cls:c?"":"im-forward-config__title_single-line",author:_WA121.Emoji.parse(_U106.String.htmlEntity(e||"")),chat:_WA121.Emoji.parse(_U106.String.htmlEntity(c||""))},{safeKeys:["author","chat"]}));var j=this.content.getSelector(".im-forward-config");j.toggleClass("im-forward-config_checked",!this.hideMessageAuthor),j.getSelector(".im-tickbox").toggleClass("im-tickbox_checked",!this.hideMessageAuthor)}},{key:"_updateState",value:function(){var a=this;this.el.toggleClass("im-select-list_with-stack",this._selectedSize>0);var b=this.stackNode.dom.children.length,c="";this._selectedStack.forEach(function(a){var b=a===_WA121.ACTIVE_MAIL?_WA121.tr("dialog.favorite"):_WA121.CLD.getFriendlyName(a);c+=_WA121.Ava.make(a,b,40,null,{isFavorite:a===_WA121.ACTIVE_MAIL})},this),this._selectedSize&&b&&b<this._selectedSize?(this.stackNode.addClass("im-list-stack_push"),this.stackNode.updateHTML(c),_WA121.setTimeout(function(){a.stackNode.removeClass("im-list-stack_push")},10)):this.stackNode.updateHTML(c),this.el.getSelector('.imListBottom .imButton[data-action="ok"]').toggleClass("im-button_disabled",0==this._selectedSize)}},{key:"prepareItem",value:function(a,b,c,d){return a.idx=c,d.searchQuery&&(a.offset="0"),a.checked=this._selected[b[0]]?"checked":"",a}},{key:"getData",value:function(a,b,c){var d;if(c){if(!this._cachedSearchData){var e=_WA121.ma.contactList.abstraction.getFullData(),f=this._cachedRecent||_WA121.ma.dialogsWindow.getRecentData(),g=f.recent,h=f.recentKeys;mixFavoriteInList(g),this._cachedSearchData=g.concat(e.filter(function(a){return!h[a[0]]&&a[0]!==_WA121.ACTIVE_MAIL}))}d=this._cachedSearchData}else this._cachedRecent||(this._cachedRecent=_WA121.ma.dialogsWindow.getRecentData(),mixFavoriteInList(this._cachedRecent.recent)),d=this._cachedRecent.recent;return d}},{key:"onClick",value:function(a){switch(a.action){case"showAuthor":this._onConfigClick();break;case"ok":this._onOkClick();break;default:a.target.up("imListStack")?this._onStackClick(a.target):a.button&&this._onContactClick(a.button.up("im-cl-contact"))}}},{key:"_onOkClick",value:function(){var a=this;if(this._selectedSize){this.unloadOnHide();var b,c,d=[];Object.keys(this._selected).forEach(function(b){d.push(a._selected[b])}),_WA121.splitView&&(_WA121.Pane.closeBox(),b=this.mail),1===d.length&&(c=_WA121.contactToHash(d[0]),b=c.email);var e=App.indexOfPage("dialog");b?b===this.email&&e>-1?App.showPage(e):(c=_WA121.contactToHash(d[0]),_WA121.ma.openDialog(_WA121.contactToArray({email:b,nick:c.nick,needAuth:c.needAuth,status:c.status,statusTitle:c.statusTitle,lastseen:c.lastseen,userState:c.userState,bot:c.bot,onlineTime:c.onlineTime}))):_WA121.splitView||(_WA121.ma.blurFocusedDialog(),App.back()),d.forEach(function(b){var c=b[0];if(a.hideMessageAuthor){var d={};a.msg.parts?a.msg.parts.forEach(function(b){a.forwardMessageEvent.fire(c,b,d)},a):a.forwardMessageEvent.fire(c,a.msg,d)}else a.forwardMessageEvent.fire(c,a.msg,{from:a.email,nick:a.nick})})}}},{key:"_onContactClick",value:function(a){if(a){var b=!a.hasClass("im-list-contact__checked"),c=a&&a.getAttribute("idx")||0,d=a&&a.getAttribute("mail");this.data&&this.data[c]&&this.data[c][0]===d&&(a.toggleClass("im-list-contact__checked",b),a.getSelector(".im-tickbox").toggleClass("im-tickbox_checked",b),b?(this._selectedStack.unshift(d),this._selected[d]=this.data[c],this._selectedSize++):this._selected[d]&&(this._selectedSize--,_U106.Array.remove(this._selectedStack,d),delete this._selected[d]),this._updateState())}}},{key:"_onStackClick",value:function(a){var b=a.up("im-avatarbox"),c=b&&b.getAttribute("data-sn");c&&this._selected[c]&&(this._selectedSize--,_U106.Array.remove(this._selectedStack,c),delete this._selected[c],this._updateState(),this.cList.redraw())}},{key:"_onConfigClick",value:function(){this.hideMessageAuthor=!this.hideMessageAuthor;var a=this.content.getSelector(".im-forward-config");a.toggleClass("im-forward-config_checked",!this.hideMessageAuthor),a.getSelector(".im-tickbox").toggleClass("im-tickbox_checked",!this.hideMessageAuthor)}}]),b}(_WA121.ListPage);_WA121.ForwardListPage=ForwardListPage;var _WA122=WebIM,_TD42=_WA122.TemplateDriver,_U107=_WA122.util,IgnoreListPage=function(a){function b(){var a;_classCallCheck2(this,b);var c={topTitle:_WA122.tr("cl.ignoreList"),cls:"im-ignore-list",buttons:[{action:"cancel",text:_WA122.tr("box.close")}]},d=_TD42.parseSafe("contactListItem",{ending:'<div class="im-chat__actions"><div class="imButton im-chat__exclude" data-action="exclude"><span></span></div></div>'},{reusable:!0,safeKeys:["ending"]});return a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"ignorelist",c)),a.dataUpdateEvent=new _U107.Event,a.itemTmpl=d,a.search={parentBlock:{tag:"div",cls:"im-search"}},_WA122.contactAbstraction.unblockEvent.on(a._unblockContact,_assertThisInitialized2(_assertThisInitialized2(a))),App.populate("ignorelist",a.onPageLoad,a.onPageUnload,_assertThisInitialized2(_assertThisInitialized2(a))),a}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a){if(delete this.__data,_WA122.ConnectionFacade.triggerEvent.on(this._onConnectionTriggerEvent,this),_get2(_getPrototypeOf2(b.prototype),"onPageLoad",this).call(this,a),this.el){var c=this.el.getSelector(".app-content");c&&c.createChild({cls:"im-ignore-list__empty-message",html:_WA122.tr("cl.hasNoIgnoreList")})}}},{key:"onPageUnload",value:function(a){_get2(_getPrototypeOf2(b.prototype),"onPageUnload",this).call(this,a),_WA122.ConnectionFacade.triggerEvent.un(this._onConnectionTriggerEvent,this),delete this.__data}},{key:"prepareItem",value:function(a,b,c,d){return d.searchQuery&&(a.offset="0"),a}},{key:"_onConnectionTriggerEvent",value:function(a,b){"ignoreList"===a&&b&&(_WA122.ConnectionFacade.triggerEvent.un(this._onConnectionTriggerEvent,this),this.dataUpdateEvent.fire(b))}},{key:"onUpdate",value:function(a){if(a){var b=a.map(function(a){return _WA122.isArray(a)?a:_WA122.contactToArray({email:a.sn,nick:a.friendly||"",status:"",statusTitle:""})});this.__data=b,this.el&&this.el.toggleClass("im-ignore-list__is-empty",!b.length)}}},{key:"getData",value:function(a){return this.__data}},{key:"requestData",value:function(){var a=_WA122.TD.getTMPL("CircleSpinner");this.cList&&this.cList.el&&(this.cList.contentEl||this.cList.el).updateHTML(a),_WA122.wimApi.getIgnoreList()}},{key:"_unblockContact",value:function(a){if(this.__data){var b=_U107.Array.indexOfBy(this.__data,function(b){return b[_WA122.contactMapKeys.email]===a});b>-1&&(this.__data.splice(b,1),this.dataUpdateEvent.fire(this.__data))}}},{key:"onClick",value:function(a){if(_WA122.contextMenu.isVisible())return a.event.stopEvent(),!1;if("exclude"===a.action){var b=a.button&&a.button.up("im-cl-contact");_WA122.contactAbstraction.doAction("unblockContact",b.getAttribute("mail"))}}}]),b}(_WA122.ListPage);_WA122.IgnoreListPage=IgnoreListPage;var _WA123=WebIM,_U108=_WA123.util,ShareContactListPage=function(a){function b(){var a;_classCallCheck2(this,b);var c={topTitle:_WA123.tr("contextmenu.shareContact"),cls:"im-select-list im-forward-page",buttons:[{action:"cancel",text:_WA123.tr("dialog.tools.cancel")}]};return a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"shareContactList",c)),a.shareEvent=new _U108.Event,a._cachedData=null,a.itemTmpl=_WA123.TD.getTMPL("contactListItem"),a.search={parentBlock:{tag:"div",cls:"im-search"},config:{remoteSearchAsync:!0}},a}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a,c){this._cachedData=null,_get2(_getPrototypeOf2(b.prototype),"onPageLoad",this).call(this,a,c)}},{key:"prepareItem",value:function(a,b,c,d){return d.searchQuery&&(a.offset="0"),a}},{key:"getData",value:function(){if(!this._cachedData){var a=_WA123.ma.contactList.abstraction.getFullData(),b=_WA123.ma.dialogsWindow.getRecentData(),c=b.recent,d=b.recentKeys;this._cachedData=c.concat(a.filter(function(a){return!d[a[0]]})).filter(function(a){return!_WA123.MainAgent.isChat(a[0])})}return this._cachedData}},{key:"onClick",value:function(a){var b=this;if(a.button){var c=a.button.up("im-cl-contact"),d=c&&c.getAttribute("mail"),e=c&&c.getAttribute("nick");if(d){var f=_WA123.setTimeout(function(){_WA123.overlayScreen.show(_WA123.tr("chat.pleaseWait"),!0)},500),g=function h(a){if(clearTimeout(f),_WA123.overlayScreen.hide(),a){var c=function(c){var f=c.phone,i=c.uNick,j=c.mail,k=c.canShare;if(g.hide(),k)if(f||i||j)b.unloadOnHide(),_WA123.splitView?_WA123.Pane.closeBox():App.back(),b.shareEvent.fire(f?{contact:{sn:d,phone:f,name:e},text:"".concat(e||_WA123.uinAsName(d)," ").concat(f)}:{text:i?_WA123.urlBuilder.profileLink(i):_WA123.urlBuilder.emailLink(j)});else{var l=new _WA123.ui.ConfirmModalBox({cls:"im-contact-box im-contact-box_alert",title:_WA123.tr("box.noPhoneAndNickname"),content:_WA123.tr("box.noPhoneAndNicknameInfo"),buttons:[{action:"cancel",text:_WA123.tr("search.back")},{action:"ok",text:_WA123.tr("calls.openChatPage"),cls:"im-button_highlight"}]});l.actionEvent.on(function(c){"ok"===c?(b.unloadOnHide(),_WA123.splitView&&_WA123.Pane.closeBox(),_WA123.ma.openDialog(_WA123.contactToArray({email:d,nick:e}))):(l.hide(),h(a))}),l.show()}else b.unloadOnHide(),_WA123.splitView&&_WA123.Pane.closeBox(),_WA123.ma.openDialog(_WA123.contactToArray({email:d,nick:e}))},g=new _WA123.ContactShareModalBox({phone:a.phone,name:e,sn:d,uNick:a.uNick},{onOk:c});g.show()}};_WA123.contactAbstraction.getUserProfile(d,g)}}}}]),b}(_WA123.ListPage);_WA123.ShareContactListPage=ShareContactListPage;var _WA124=WebIM,_U109=_WA124.util,_DomUtil58=_WA124.DomUtil,WIDGET_PARAMS_MAP={new_chat_name:"name",friendly:"name",imchat:"sn"},WidgetWelcomePage=function(a){function b(a){var c;return _classCallCheck2(this,b),c=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,a||"widgetWelcome")),c.infoPanel=null,_WA124.Statuses.updateEvent.un(c._updateAwayStatus,_assertThisInitialized2(_assertThisInitialized2(c))),_WA124.chatController.infoReadyEvent.un(c.updateMembersList,_assertThisInitialized2(_assertThisInitialized2(c))),_WA124.fileTools.progressUploadEvent.un(c.onProgressEvent,_assertThisInitialized2(_assertThisInitialized2(c))),_WA124.fileTools.endUploadEvent.un(c.onEndUploadEvent,_assertThisInitialized2(_assertThisInitialized2(c))),
_WA124.showcasePage.shareEvent.un(c.onShowcaseShareEvent,_assertThisInitialized2(_assertThisInitialized2(c))),_WA124.contactAbstraction.muteEvent.un(c._onContactMute,_assertThisInitialized2(_assertThisInitialized2(c))),_WA124.mediaPlayer.stateEvent.un(c._onMediaPlayerState,_assertThisInitialized2(_assertThisInitialized2(c))),c.messageEvent.on(c._onMessageEvent,_assertThisInitialized2(_assertThisInitialized2(c))),c}return _inherits2(b,a),_createClass2(b,[{key:"initOnce",value:function(){_get2(_getPrototypeOf2(b.prototype),"initOnce",this).call(this),this.textarea.topMessageToggleEvent.un(this.onTopInputMessageToggle,this),this.textarea.clickOnEditedMsgEvent.un(this.scrollUpToMessage,this),this.textarea.stickerEvent.removeAll(),this.textarea.upArrowEvent.removeAll(),this.textarea.field.suggestsEvent.removeAll(),this.textarea.stickersSuggest.hide(),delete this.textarea.stickersSuggest}},{key:"renderBind",value:function(){_get2(_getPrototypeOf2(b.prototype),"renderBind",this).call(this),this._messagesBlock=this.winEl.getSelector(".imMessagesBlock"),this.winEl.addClass("im-dialogpage_dummy"),this.winEl.toggleClass("im-widget-welcome-page_authorized",this.loadParams.authorized)}},{key:"_parseParams",value:function(a){var b=this,c=a||{},d=c.widgetParams,e=c.loadParams;this.widgetParams={},Object.keys(d||{}).forEach(function(a){b.widgetParams[WIDGET_PARAMS_MAP[a]||a]=d[a]}),this.loadParams=e||{}}},{key:"onPageLoad",value:function(a,b){this._parseParams(b);var c=this.widgetParams,d=c.name,e=c.sn,f=c.spec_message,g=c.spec_status;this.nick=d,this.mail=e,this._subMessage=_WA124.Emoji.parse(_U109.String.htmlEntity(g||""));var h=_WA124.Feature.getModeParameter("widgetWelcomePageContentTemplate"),i=_WA124.Feature.getModeParameter(this.loadParams.authorized?"widgetWelcomePageAuthorizedMessageTrKey":"widgetWelcomePageUnAuthorizedMessageTrKey"),j=i?_WA124.tr(i):f;(h||j)&&(h?this._htmlContent=_WA124.TD.parseSafe(h,{text:j}):this._htmlContent=_U109.String.htmlEntity(j)),_WA124.Feature.getModeParameter("readOnlyWidgetWelcomePage")||(_WA124.hotKeyManager.activate(),this.initOnce()),this.textarea&&this.textarea.init(),this.winEl=_DomUtil58.get(a),this.renderBind(),this.updateNoInputState(),this.updateWindow()}},{key:"onPageUnload",value:function(a){_get2(_getPrototypeOf2(b.prototype),"onPageUnload",this).call(this,a),this.messageEvent.removeAll(),this.textarea&&(this.textarea.resizeEvent.removeAll(),this.textarea.changeEvent.removeAll(),this.textarea.submitEvent.removeAll(),this.textarea.overflowEvent.removeAll(),this.textarea.showSmileMenuEvent.removeAll(),this.textarea.hideSmileMenuEvent.removeAll(),this.textarea.showPttEvent.removeAll(),this.textarea.hidePttEvent.removeAll(),this.textarea.topMessageToggleEvent.removeAll(),this.textarea.clickOnEditedMsgEvent.removeAll(),this.textarea.focusEvent.removeAll(),this.textarea.blurEvent.removeAll(),this.textarea.stickerEvent.removeAll(),this.textarea.sendPttEvent.removeAll(),this.textarea.chooseFileEvent.removeAll(),this.textarea.shareContactEvent.removeAll(),this.textarea.upArrowEvent.removeAll()),this.dragDropArea&&(this.dragDropArea.dropEvent.removeAll(),this.dragDropArea.dragEvent.removeAll())}},{key:"updateNoInputState",value:function(){if(_WA124.Feature.getModeParameter("readOnlyWidgetWelcomePage")){this.winEl.addClass("im-dialogpage_readonly");var a=_WA124.Feature.getModeParameter("widgetWelcomePageAuthorizedBottomAction"),b=this.loadParams.authorized?_WA124.tr(_WA124.Feature.getModeParameter("widgetWelcomePageAuthorizedBottomTrKey")):_WA124.tr("auth.login");this._noInputBlock.addClass("im-dialogpage_input-action").first().setAttribute("data-action",a).updateText(b)}else this.winEl.removeClass("im-dialogpage_readonly")}},{key:"updateWindow",value:function(){this._nameField&&this._nameField.first().updateHTML(_WA124.Emoji.parse(_U109.String.htmlEntity(this.nick||""))),this._avatarBox&&this.nick?(this.avatarHtml=this.mail?_WA124.Ava.make(this.mail,this.nick,32):_WA124.Ava.flyLetter(this.nick,32),this._avatarBox.show().updateHTML(this.avatarHtml||"")):this._avatarBox.hide(),this._subNameField&&this._subNameField.updateHTML(this._subMessage||""),this._messagesBlock&&this._messagesBlock.updateHTML(this._htmlContent||"")}},{key:"_sendFileBundle",value:function(a,b){this._onMessageEvent(this.mail,{files:a,options:b})}},{key:"_onMessageEvent",value:function(a,b){var c=_WA124.Feature.getModeParameter("widgetWelcomePageAuthorizedBottomAction");this._onAction(c,{sn:a,message:b})}},{key:"makeHistory",value:function(){}},{key:"_onContextmenu",value:function(a){}},{key:"_onDblClick",value:function(a){}},{key:"close",value:function(){if(_WA124.splitView)_WA124.Pane.clear();else if(App.isCurrentPage(this.appPageName))App.back();else{var a=App.indexOfPage(this.appPageName,!0);a>-1&&App.spliceHistory(a,1)}}},{key:"open",value:function(a){if(this._parseParams(a),this.loadParams.afterAuth&&_WA124.Feature.getModeParameter("skipWidgetWelcomePageAfterAuth")){var b=_WA124.Feature.getModeParameter("widgetWelcomePageAuthorizedBottomAction");return void this._onAction(b)}_WA124.Feature.getModeParameter("readOnlyWidgetWelcomePage")||_WA124.Emoji.initSmiles(),_WA124.splitView?_WA124.Pane.loadChat(this,a):App.load(this.appPageName,a,!0)}},{key:"_onAction",value:function(a,b){var c=this;if(this.loadParams&&!this.loadParams.authorized)return _WA124.Feature.getModeParameter("loginWithoutReload")?(_WA124.hotKeyManager.deactivate(),_WA124.ma.waitForAuthAndAppStarted().then(function(){c.loadParams||(c.loadParams={}),c.loadParams.authorized=!0,c._onAction(a,b)})):_WA124.redirectToAuthPage(),void this.close(!0);switch(this.widgetParams||(this.widgetParams={}),a){case"sendMessage":if(b&&b.message&&_WA124.ma.dialogsWindow){var d=b.sn,e=b.message;if(e.files){var f=e.files,g=e.options,h=void 0===g?{}:g;f.length>1&&h.caption&&(_WA124.ma.dialogsWindow.submitMessage(d,h.caption),h={caption:""}),_WA124.fileTools.sendFiles(d,f,h)}else _WA124.ma.dialogsWindow.submitMessage(d,e)}break;case"makeChat":_WA124.ma.contactList.abstraction.waitForReady().then(function(){return _WA124.ma.newGroup(c.widgetParams.name,!0)}).then(function(a){console.log("@!@!newGroup",a),_WA124.chatController.getChatInfo(a,5,!0,!1,function(a,b,c){console.log("@!@!getChatInfo",c,b),c&&b&&_WA124.Api.postEventToParent("chatCreated",b)})}),this.close(!0)}}},{key:"_onClick",value:function(a){var b=a.getTarget(!0),c=b.up("imButton"),d=c&&c.getAttribute("data-action");d&&this._onAction(d)}}]),b}(_WA124.DialogPage);_WA124.widgetWelcomePage=new WidgetWelcomePage;var _WA125=WebIM,_TD43=_WA125.TemplateDriver,_U110=_WA125.util,_stopEventPropagation3=function(a){a.browserEvent.stopPropagation()},GroupCallListPage=function(a){function b(){var a;_classCallCheck2(this,b);var c={topTitle:_WA125.tr("calls.startGroupAudioCall"),cls:"im-select-list im-forward-page",buttons:[{action:"cancel",text:_WA125.tr("dialog.tools.cancel")},{action:"ok",text:_WA125.tr("calls.makeCall"),cls:"im-button_highlight im-button_disabled"}]},d=_TD43.parseSafe("contactListItem",{extraClasses:"im-list-contact__${checked}",ending:'<div class="im-tickbox im-tickbox_${checked}"></div>'},{reusable:!0,safeKeys:["extraClasses","ending"]});return a=_possibleConstructorReturn2(this,_getPrototypeOf2(b).call(this,"groupCallList",c)),a.dataUpdateEvent=new _U110.Event,a.itemTmpl=d,a._cachedRecent=null,a._cachedSearchData=null,a._selected={},a._selectedStack=[],a._selectedSize=0,a.search={showFavorite:!1,parentBlock:{tag:"div",cls:"im-search"}},a}return _inherits2(b,a),_createClass2(b,[{key:"onPageLoad",value:function(a,c){this.isVideo=c.isVideo,this.sn=c.sn,this.initialConfig.topTitle=this.isVideo?_WA125.tr("calls.startGroupVideoCall"):_WA125.tr("calls.startGroupAudioCall"),this._cachedRecent=null,this._cachedSearchData=null,this._selected={},this._selectedStack=[],this._selectedSize=0,delete this.__data,_WA125.chatController.infoReadyEvent.on(this._onInfoReady,this),_get2(_getPrototypeOf2(b.prototype),"onPageLoad",this).call(this,a,c),this.stackNode=this.content.getSelector(".imListStack"),this.stackNode.on("touchmove",_stopEventPropagation3),_WA125.isDesktop&&(this.stackNode.setStyle("overflow","hidden"),this.stackNode.on("wheel",this._onStackWheel,this))}},{key:"onPageUnload",value:function(a){this.stackNode.un("wheel",this._onStackWheel,this),this.stackNode.un("touchmove",_stopEventPropagation3),_get2(_getPrototypeOf2(b.prototype),"onPageUnload",this).call(this,a),_WA125.chatController.infoReadyEvent.un(this._onInfoReady,this),delete this.__data}},{key:"_onStackWheel",value:function(a){var b=a.browserEvent,c=b.deltaY,d=b.constructor;b.deltaX&&Math.abs(b.deltaX)>Math.abs(c)&&(c=b.deltaX),!d||b.deltaMode!==d.DOM_DELTA_LINE&&b.deltaMode!==d.WM_MOUSEWHEEL&&b.deltaMode!==d.WM_MOUSEHWHEEL||(c*=4),0!==c&&(this.stackNode.dom.scrollLeft=this.stackNode.dom.scrollLeft+c),a.stopEvent()}},{key:"_updateState",value:function(){var a=this;this.el.toggleClass("im-select-list_with-stack",this._selectedSize>0);var b=this.stackNode.dom.children.length,c="";this._selectedStack.forEach(function(a){var b=a===_WA125.ACTIVE_MAIL?_WA125.tr("dialog.favorite"):_WA125.CLD.getFriendlyName(a);c+=_WA125.Ava.make(a,b,40,null,{isFavorite:a===_WA125.ACTIVE_MAIL})},this),this._selectedSize&&b&&b<this._selectedSize?(this.stackNode.addClass("im-list-stack_push"),this.stackNode.updateHTML(c),_WA125.setTimeout(function(){a.stackNode.removeClass("im-list-stack_push")},10)):this.stackNode.updateHTML(c),this.el.getSelector('.imListBottom .imButton[data-action="ok"]').toggleClass("im-button_disabled",0===this._selectedSize)}},{key:"prepareItem",value:function(a,b,c,d){return a.idx=c,d.searchQuery&&(a.offset="0"),a.checked=this._selected[b[0]]?"checked":"",a}},{key:"_onInfoReady",value:function(a,b,c){console.log("###GROUPLIST _onInfoReady:",this.sn,a),b&&a===this.sn&&this.dataUpdateEvent.fire(c)}},{key:"onUpdate",value:function(a){if(a){var b=[];_U110.Array.each(a.members,function(a){if(a.email!==_WA125.ACTIVE_MAIL){var c=_WA125.contactToArray({email:a.email,nick:a.friendly||(a.firstName||"")+(a.firstName&&a.lastName?" ":"")+(a.lastName||"")||"",status:"",statusTitle:"",mute:_WA125.CLD.getMute(a.email),official:a.official||a.honours&&a.honours.indexOf("official")>-1||0,lastseen:_WA125.CLD.getLastseen(a.email),userState:_WA125.CLD.getUserState(a.email),uNick:a.uNick});b.push(c)}}),this.__data=b}}},{key:"getData",value:function(){return this.__data}},{key:"requestData",value:function(){_WA125.chatController.getChatInfo(this.sn,0,!0);var a=_WA125.TD.getTMPL("CircleSpinner");this.cList&&this.cList.el&&(this.cList.contentEl||this.cList.el).updateHTML(a)}},{key:"onClick",value:function(a){switch(a.action){case"ok":this._onOkClick();break;default:a.target.up("imListStack")?this._onStackClick(a.target):a.button&&this._onContactClick(a.button.up("im-cl-contact"))}}},{key:"_onOkClick",value:function(){var a=this;if(this._selectedSize){this.unloadOnHide();var b,c=[];Object.keys(this._selected).forEach(function(b){c.push(a._selected[b])}),_WA125.splitView&&(_WA125.Pane.closeBox(),b=this.mail),console.log("###starting call with",c),_WA125.Voip.startOutgoinCall(c[0][0],c[0][1],this.isVideo)}}},{key:"_onContactClick",value:function(a){if(a){var b=!a.hasClass("im-list-contact__checked"),c=a&&a.getAttribute("idx")||0,d=a&&a.getAttribute("mail");this.data&&this.data[c]&&this.data[c][0]===d&&(a.toggleClass("im-list-contact__checked",b),a.getSelector(".im-tickbox").toggleClass("im-tickbox_checked",b),b?(this._selectedStack.unshift(d),this._selected[d]=this.data[c],this._selectedSize++):this._selected[d]&&(this._selectedSize--,_U110.Array.remove(this._selectedStack,d),delete this._selected[d]),this._updateState())}}},{key:"_onStackClick",value:function(a){var b=a.up("im-avatarbox"),c=b&&b.getAttribute("data-sn");c&&this._selected[c]&&(this._selectedSize--,_U110.Array.remove(this._selectedStack,c),delete this._selected[c],this._updateState(),this.cList.redraw())}}]),b}(_WA125.ListPage);_WA125.GroupCallListPage=GroupCallListPage;var _WA126=WebIM,_U111=_WA126.util,_UI63=_WA126.ui,_TD44=_WA126.TemplateDriver,_SOCK=_WA126.ConnectionFacade,_AS7=_WA126.AccountSettings,_DomUtil59=_WA126.DomUtil;_WA126.PRODUCT_TITLE=_WA126.tr(_WA126.configurator.getOption("title_key"),{scope:"title"});var DEBUG_PROMO=!1,CUSTOM_BRANCH_REGEX=/\/branches\/wi-\d+\//i,APP_AUTO_SCALE=!_WA126.isFF&&_WA126.isDesktop&&(_WA126.forceEnableAutoScale||!_WA126.promoMode&&!_WA126.boardMode&&!_WA126.Feature.getModeParameter("disableAutoScale")),MainTabsSwitcher={PAGES:["main","multiSearch"],_unreadMessagesCounter:null,tabSwitched:new _U111.Event,tabClicked:new _U111.Event,currentTab:"recent",render:function(){var a=_U111.DomHelper.elementFromHtml('<div id="bottomTabs" class="im-tabs"></div>');this.el=_DomUtil59.getBody().appendChild(a),this.el.updateHTML(_WA126.TD.getTMPL("mainTabSwitcher")),this.el.on("tab:switched",this._onSwitch,this),this.el.on("click",this._onClick,this),this._unreadMessagesCounter=this.el.getSelector(".im-msg-counter")},toggle:function(a){this.el.setVisible(this.PAGES.indexOf(a)>-1)},"switch":function(a){var b=this.el.getSelector("."+a+"-tab");this.currentTab!==a&&b&&(this.el.getSelector(".tab-active").removeClass("tab-active"),b.addClass("tab-active"),this.currentTab=a,this.tabSwitched.fire(a))},updateUnreadCounter:function(a,b){if(this._unreadMessagesCounter){var c=a>999?"1k":a;!c&&b&&(c='<div class="im-msg-counter__unread-symbol"></div>'),this._unreadMessagesCounter.updateHTML(c||""),c?this._unreadMessagesCounter.show():this._unreadMessagesCounter.hide()}},_onClick:function(a){var b=a.getTarget(!0).up("app-tab-button");b&&this.tabClicked.fire(b.getAttribute("data-tab"))},_onSwitch:function(a){var b=a.getTarget(!0),c=b.getAttribute("data-tab");this["switch"](c)}},screenLog=function(){return""+screen.width+"x"+screen.height+"_"+(window.devicePixelRatio||0)+"__"+_WA126.orientation+"__"+ +_WA126.isTouchDevice},MainAgent=function(){function a(){_classCallCheck2(this,a),this._getCurrentUserSn(),_U111.Mnt.countRB(_WA126.isDesktop?32743984:32743980),this._currentThemeInd=null,_WA126.splitView&&!_WA126.isDesktop?(_U111.Mnt.countRB(39443558),_U111.Mnt.flog("wide",screenLog())):_WA126.isDesktop&&!_WA126.splitView&&(_U111.Mnt.countRB(39443562),_U111.Mnt.flog("desk",screenLog())),this.sharedEvent=new _U111.Event,this.enterKeyEvent=new _U111.Event,this.queryParams={},this._active=!1,_WA126.setTimeout(this._onDocumentReady,10,this)}return _createClass2(a,[{key:"_getCurrentUserSn",value:function(){var a=_WA126.Sys.getUserLogin(),b=!1,c=_WA126.Feature.getModeParameter("ignoreAuthByEmail");return _WA126.Feature.getModeParameter("tryUseMainAuthData")&&((!a||c&&_WA126.isEmail(a))&&(a=_WA126.Sys.getUserLogin(!0),b=!0),a&&c&&_WA126.isEmail(a)&&(a=null)),a&&(b&&_WA126.Sys.useDefaultStorage(),_WA126.Feature.getModeParameter("attachedPhoneIsRequired")&&!_WA126.Sys.getAttachedPhone()?a=null:(_WA126.ACTIVE_MAIL=a,_WA126.ACTIVE_IS_UIN=_WA126.isUIN(a))),a}},{key:"_onDocumentReady",value:function(){var a=this;return _WA126.boardMode||(document.title=_WA126.PRODUCT_TITLE),this._collectQueryParameters(),_DomUtil59.runGarbageCollector(),this._setRootClass(),_WA126.Api.postEventToParent("documentReady"),APP_AUTO_SCALE&&(this._onResize(),_DomUtil59.fly(window).on("resize",this._onResize.bind(this))),this.removeStorageDataFromCookie(),_WA126.promoMode?this._launchPromoBoard():void this._checkUserAuthorization().then(function(){a._launchApplication()},function(){a._unauthorizedAccess()})}},{key:"_collectQueryParameters",value:function(){var a=this;_WA126.Storage.load("locationQueryParams",function(b){var c=b||App.cutLocationSearch();a.queryParams=_U111.String.parseQueryString(c),_WA126.Storage.remove("locationQueryParams")})}},{key:"_checkUserAuthorization",value:function(){var a=!!_WA126.ACTIVE_MAIL,b=this.queryParams.mlogin;return a&&_WA126.boardMode&&_WA126.isEmail(b||"")&&(a=b===_WA126.ACTIVE_MAIL),console.log("IM:MA:_checkUserAuthorization userAuthorized="+a+" active="+_WA126.ACTIVE_MAIL),a?Promise.resolve():this._tryImplicitAuthorization()}},{key:"_tryImplicitAuthorization",value:function(){var a=!_WA126.Feature.getModeParameter("ignoreAuthByEmail"),b=_WA126.configurator.getOption("enable_email_mpop_auth"),c=this.queryParams.mlogin;console.log("IM:MA:_tryImplicitAuthorization: forcedEmail="+c);var d=b&&(a||!_WA126.boardMode);return d?_WA126.ConnectionFacade.loginByMailCookie(c).then(function(a){return console.log("IM:MA:_tryImplicitAuthorization: then loginId=",a&&a.loginId),Promise.resolve()}):(console.log("IM:MA:_tryImplicitAuthorization: reject"),Promise.reject())}},{key:"_unauthorizedAccess",value:function(){if(_WA126.boardMode)if(this.queryParams&&!_WA126.boardModeParams&&(_WA126.boardModeParams=this.queryParams),_WA126.Feature.getModeParameter("showWidgetWelcomePage")){var a=_U111.String.parseQueryString(location.search);_WA126.widgetWelcomePage.open({widgetParams:a,loadParams:{authorized:!1,afterAuth:a.afterauth}})}else _WA126.Feature.getModeParameter("disableManualAuthorization")?this._showBoardErrorMessage(_WA126.Feature.getModeParameter("msgUnauthorized")):_WA126.redirectToAuthPage();else _WA126.redirectToAuthPage({initial:!0})}},{key:"_launchPromoBoard",value:function(){var a=this,b=["news"],c=_U111.String.parseQueryString(location.search),d=c.stamp,e=c.imskin;return!_WA126.Sys.getUserLogin()||_WA126.embedMode||DEBUG_PROMO?(_WA126.embedMode&&(_WA126.ACTIVE_MAIL?_U111.Mnt.countRB(60112093,!0):_U111.Mnt.countRB(60112092,!0)),e&&b.indexOf(e)>-1&&_DomUtil59.getBody().addClass("im-skin_"+e),void _WA126.serviceApi.getPromoChatData(d).then(function(a){var b=a;if(b)return b;throw"Chat data not found"}).then(function(a){var b=a.stamp,c=a.name,e=a.avatar,f=a.messages||[],g=_WA126.urlBuilder.inviteChatLink(b),h=[],i=_DomUtil59.get("boardRoot");if(_WA126.embedMode&&_WA126.Sys.getUserLogin()&&(g=_WA126.urlBuilder.clientChatDeepLink(b)),_WA126.embedMode){_U111.Mnt.countRbPromo(d);var j=_U111.Mnt.makeRbPromoLink(d);j&&(g=j)}var k,l=new Date,m=_U111.Date.getTimeFromMidnight(l);f.reverse(),f.forEach(function(a){var b=a.previews||[];b.forEach(function(a){var b=a.doc;b&&b.images&&_WA126.snippet.cacheSnippetInfo(b.url,b)});var c=_U111.Date.formatMessageDate(a.time,l,m);if(k!==c){k=c;var d='<div class="im-messages__date" data-next-id=""><span>'+k+"</span></div>";h.push(d)}try{var e=_WA126.MessageFormatter.renderPromoMessage(a);h.push(e)}catch(f){console.error(f)}});var n=_TD44.parseSafe("promoChatBoard",{title:c,subtitle:"",avatarUrl:_U111.String.encodeHref(e||""),linkUrl:_U111.String.encodeHref(g),target:_WA126.embedMode?"_blank":"_self",messages:h.join("")},{safeKeys:["avatarUrl","linkUrl","messages"]});i.updateHTML(n);var o=i.getSelector(".im-history"),p=new _UI63.ScrollBar({source:o});_WA126.setTimeout(function(){o.dom.scrollTop=o.dom.scrollHeight,p.sync()},200)})["catch"](function(){a._showBoardErrorMessage("board.msgChatNotFound")})):void(window.location=_WA126.urlBuilder.clientChatDeepLink(d))}},{key:"_launchApplication",value:function(){var a=this;return console.log("IM:MA:_launchApplication"),_WA126.Sys.checkSystemConfig().then(function(){a._createEssences(),a._renderApp(),a._onStorageInit(),a._sendStatistics()},function(a){_SOCK.logout(),_WA126.showPopup(a.msg||_WA126.tr("auth.msgCommonError"),0)})}},{key:"waitForAuthAndAppStarted",value:function(a){return _WA126.waitForPromiseAuth().then(this._launchApplication.bind(this)).then(function(){return a})}},{key:"_setRootClass",value:function(){var a=[_WA126.configurator.getOption("root_css_class")||"",this._getCurrentThemeClass(),_WA126.boardMode?"im-mode_board":"",_WA126.promoMode?"im-mode_promo":"",_WA126.splitView?"im-splitview":"",_WA126.isDesktop?"im-desktop":"im-mobile","im-language_"+_WA126.resLanguage];_WA126.Feature.getModeParameter("hideDialogTopbar")?a.push("im-mode_hide-dialog-topbar"):_WA126.Feature.getModeParameter("hideDialogTopbarButtons")&&a.push("im-mode_hide-dialog-topbar-buttons"),_DomUtil59.getBody().addClass(a.join(" "))}},{key:"_switchTheme",value:function(a){_DomUtil59.getBody().removeClass(this._getCurrentThemeClass()),this._currentThemeInd=a,_DomUtil59.getBody().addClass(this._getCurrentThemeClass()),this.dialogsWindow&&this.dialogsWindow.onThemeSwitch()}},{key:"_getCurrentThemeClass",value:function(){if(null===this._currentThemeInd){var a=_WA126.Feature.getModeParameter("specificTheme");a?this._currentThemeInd=a:this._currentThemeInd=_WA126.Sys.getUserLogin()?_AS7.getOption(_AS7.OPTION_THEME):null}var b=this._currentThemeInd||_WA126.THEME_SCHEMA[0];return"im-theme-"+b}},{key:"_onStorageInit",value:function(){var a=this;_SOCK.statusChangedEvent.on(this._onUserStateStatusChange,this),_SOCK.preloadStartedEvent.on(function(){},this),_SOCK.preloadCompletedEvent.on(this._onPreloadCompleted,this),_SOCK.hotSessionRestartEvent.on(this._onHotSessionRestart,this),_SOCK.offlineModeEvent.on(this._toggleOfflineMode,this),_SOCK.restore(),_WA126.boardMode?this._handleBoardParams():this.handleQueryParams(),_AS7.optionChange.on(function(b,c){b===_AS7.OPTION_THEME&&a._switchTheme(c)},this)}},{key:"_sendStatistics",value:function(){var a=_WA126.Sys.getUserLogin(),b=!1;(!_WA126.boardMode||a)&&(_WA126.Storage.modify(["statsSentTs"],function(a){var c=_WA126.now();+a.statsSentTs+_WA126.HOUR<c&&(b=!0,a.statsSentTs=c)}),b&&_WA126.miscApi.sendStatistics(a))}},{key:"_onActualStateChange",value:function(a){var b="online"===a;b&&this._activate()}},{key:"_toggleOfflineMode",value:function(a){var b=a!==!1;return _WA126.boardMode&&_WA126.Feature.getModeParameter("disableOfflineMode")?void(b&&this._showBoardErrorMessage("board.msgFailedToConnect")):(this._offlineBox&&this._offlineBox.hide(),void(b&&_WA126.ACTIVE_MAIL&&(this._offlineBox=new _UI63.OfflineBox(function(a){"signout"===a?_SOCK.logout():"ok"===a&&_SOCK.forceRestore()}),this._offlineBox.show())))}},{key:"_onUserStateStatusChange",value:function(a){return console.log("IM:MA:_onUserStateStatusChange status="+a),"offline"===a?(this._deactivate(),void this._toggleOfflineMode()):(this._active||this._activate(),this._toggleOfflineMode(!1),void(App.getPage()||App.load("main")))}},{key:"_activate",value:function(a,b){this._active||(console.log("IM:MA:_Activate !!!"),this._active=!0,this._onActivate(),_WA126.autoAway.activate()),a&&a.call(b||window)}},{key:"_deactivate",value:function(){(this._active||void 0===this._active)&&(this._active=!1,_WA126.autoAway.deactivate(),this._onDeactivate())}},{key:"openDialog",value:function(a,b,c){return a&&_WA126.isArray(a.contact)&&(a=a.contact),this.dialogsWindow.openDialog(a,b,c)}},{key:"blurFocusedDialog",value:function(){this.dialogsWindow.blurFocusedDialog()}},{key:"excludeContact",value:function(a){_WA126.chatController.delMembers(a.chat_id,[[a.mail]])}},{key:"removeAndBlockContact",value:function(a){var b=new _UI63.BlockModalBox({chatSn:a.chat_id,sn:a.mail,friendly:a.nick,onOk:function(a,b,c){_WA126.chatController.blockMembers(a,[{sn:b}],c)}});b.show()}},{key:"unblockContact",value:function(a){_UI63.showConfirmBox(_WA126.tr("box.unblockUser",{nick:_WA126.Emoji.parse(_U111.String.htmlEntity(a.nick||a.mail))}),function(){_WA126.chatController.unblockMembers(a.chat_id,[{sn:a.mail}])})}},{key:"spamReport",value:function(a){var b=this,c=new _UI63.BanModalBox({nick:this.nick,spamOnly:!0,onEditOk:function(c){b.dialogsWindow.sendAbuse(a.mail,c)}});c.show()}},{key:"renameContact",value:function(a,b){this.contactList.abstraction.renameContact(a,b),this.dialogsWindow.abstraction.renameContact(a,b)}},{key:"removeContact",value:function(a){var b=this,c=a.sn||a.mail,d="",e="",f=_WA126.Emoji.parse(_U111.String.htmlEntity(a.nick||c));if(_WA126.MainAgent.isChat(c)){var g=_WA126.chatController.getCachedChatInfo(c);g&&"readonly"===g.defaultRole?(e=f,d=_WA126.tr("leaveChannel",{scope:"box",nick:f})):(e=f,d=_WA126.tr(g?"leaveGroup":"leaveChat",{scope:"box",nick:f}))}else e=_WA126.tr("box.removeUserTitle"),d=_WA126.tr("removeUser",{scope:"box",nick:f});_UI63.showConfirmBox(e,d,function(){b.dialogsWindow.abstraction.close(c),b.contactList.abstraction.removeContact(c)})}},{key:"ignoreContact",value:function(a){_WA126.contactAbstraction.doAction("blockContact",a.mail)}},{key:"activateGlobalSearch",value:function(a){if(!(_WA126.Pane.hasOpenedBox()||_WA126.contextMenu.isVisible()||_UI63.ModalComponent.isShown()||_WA126.Feature.getModeParameter("disableSearch")||!a.sn&&_WA126.Feature.getModeParameter("allowOnlyChatSearch")))if(App.isCurrentPage("multiSearch"))this.multiSearchPage.focusPage(a.sn?a:null);else{var b=App.indexOfPage("multiSearch",!0);b>-1&&App.spliceHistory(b,1),App.load("multiSearch",{sn:a.sn,nick:a.nick})}}},{key:"_onGlobalActionEvent",value:function(a,b){"function"==typeof this[a]&&this[a](b)}},{key:"openProfile",value:function(a){_WA126.contactAbstraction.openProfile(a.sn||a.mail,a.nick)}},{key:"switchTab",value:function(a){App.isCurrentPage("main")||(App.spliceHistory(1),App.back()),MainTabsSwitcher["switch"](a)}},{key:"_onActivate",value:function(){this.contactList.activate(),this.dialogsWindow.activate(),_WA126.hotKeyManager.activate()}},{key:"_onDeactivate",value:function(){_WA126.hotKeyManager.deactivate(),_WA126.Pane.clear(),this.dialogsWindow.deactivate(),this.contactList.deactivate(),this.settingsPage.deactivate()}},{key:"_createEssences",value:function(){var a=this;_WA126.appIsLaunched=!0,_WA126.AppLayout.init(),_WA126.Pane.render(),this.settingsPage=new _WA126.SettingsPage,this.contactList=new _WA126.ContactListAgent,this.contactList.contactSelectEvent.on(function(a){this.openDialog(a)},this),_WA126.contactAbstraction.renameEvent.on(this.renameContact,this),_WA126.contactAbstraction.addSuccessEvent.on(function(a,b){_WA126.ContactListAgent.addContactEvent.fire(a,b)}),_WA126.MessageNotifier.clickEvent.on(function(a){this.openDialog([a])},this),this.dialogsWindow=new _WA126.DialogsAgent,this.dialogsWindow.unreadEvent.on(MainTabsSwitcher.updateUnreadCounter,MainTabsSwitcher),this.dialogsWindow.removeContactEvent.on(function(a){this.contactList.abstraction.removeContact(a)},this),this.dialogsWindow.updateSelfNickEvent.on(this.contactList.setSelfNick,this.contactList),_WA126.DialogsAbstraction.nick&&this.contactList.setSelfNick(_WA126.DialogsAbstraction.nick),this.dialogsWindow.globalActionEvent.on(this._onGlobalActionEvent,this),this.dialogsWindow.updateSelfNickEvent.on(this.settingsPage.updateWidget,this.settingsPage),this.dialogsWindow.updateUnknownsEvent.on(this._updateUnknownButton,this),this.multiSearchPage=new _WA126.MultiSearchPage,_WA126.contactAbstraction.removeEvent.on(function(a){this.dialogsWindow.abstraction.close(a),this.contactList.abstraction.removeContact(a)},this),_WA126.contactAbstraction.messageEvent.on(this.dialogsWindow.openDialog,this.dialogsWindow),_WA126.ContactListAgent.updateEvent.on(function(a){this.dialogsWindow.onUpdateClistData(a)},this),this.tabNavigator=new _WA126.TabNavigator({className:"im-tab-focused",selector:"[data-tabindex]",sortAttr:"data-tabindex"}),this.tabNavigator.changeEvent.on(function(b,c){c&&c.hasClass("imSearchFieldButton")?_WA126.hotKeyManager.on("arrowDown",{handler:a._onHotKeyArrowDown,scope:a},"main"):(_WA126.hotKeyManager.un("arrowDown",{handler:a._onHotKeyArrowDown,scope:a},"main"),_WA126.hotKeyManager.isLayerActive("recentArrows")&&(_WA126.hotKeyManager.deactivationLayerEvent.un(a._onDeactivateRecentHotKeyLayer,a),_WA126.hotKeyManager.deactivateLayer("recentArrows"))),b&&!c?_WA126.hotKeyManager.un("esc",{handler:a._onHotKeyEsc,scope:a},"main"):c&&!b&&_WA126.hotKeyManager.on("esc",{handler:a._onHotKeyEsc,scope:a},"main")})}},{key:"_onDeactivateRecentHotKeyLayer",value:function(a){"recentArrows"===a&&this.tabNavigator.showFocused()}},{key:"_onHotKeyArrowDown",value:function(){_WA126.hotKeyManager.deactivationLayerEvent.on(this._onDeactivateRecentHotKeyLayer,this),this.tabNavigator.hideFocused(),_WA126.hotKeyManager.activateLayer("recentArrows")}},{key:"_onPreloadCompleted",value:function(){var a=this.dialogsWindow.getRecentData()||{},b=a.recent&&a.recent.length||0;1>b?_U111.Mnt.countRB(41352604):11>b?_U111.Mnt.countRB(41352606):31>b?_U111.Mnt.countRB(41352610):61>b?_U111.Mnt.countRB(41352614):_U111.Mnt.countRB(41352615)}},{key:"_onHotSessionRestart",value:function(a){this.dialogsWindow.onHotSessionRestart(a)}},{key:"activateMainTab",value:function(a){App.isCurrentPage("main")&&("settings"===a?this.settingsPage.activate():this.settingsPage.deactivate(),this.contactList.toggleView("clist"===a),this.el.toggleClass("im-clist__visible","clist"===a).toggleClass("im-settings__visible","settings"===a))}},{key:"openSettingsPanel",value:function(a){App.isCurrentPage("main")&&(this.activateMainTab("settings"),this.settingsPage.openPane(a))}},{key:"_onMainTabClicked",value:function(a){App.isCurrentPage("main")?"recent"===a&&a===MainTabsSwitcher.currentTab&&this.dialogsWindow.scrollToFirstUnreadDialog():(App.spliceHistory(1),App.back())}},{key:"_onHotKeyEsc",value:function(){this.tabNavigator.reset()}},{key:"_onMultiSearchFieldClick",value:function(a){var b=a.getTarget();App.load("multiSearch",{sourcePage:b.getAttribute("data-source"),keyword:b.value}),b.value=""}},{key:"_onMainMenuClick",value:function(a,b){var c=this;switch(b){case"addContact":this.showAddDialog();break;case"createGroup":this.newGroup().then(function(){});break;case"createChannel":this.showNewChannelDialog();break;case"readAll":_UI63.showConfirmBox(_WA126.tr("contextmenu.readAll"),_WA126.tr("box.readAllChatsConfirmation"),function(){c.dialogsWindow.markAllAsRead()})}}},{key:"_showMainMenu",value:function(a,b){var c=this,d=["addContact","createGroup","createChannel","readAll"];if(_WA126.configurator.getOption("disable_add_contact_by_phone")&&d.shift(),_WA126.isDesktop){if(!this.mainMenu){var e=d.map(function(a){return _TD44.parseSafe("contextMenuItem",[a,_WA126.tr("contextmenu."+a)])});this.mainMenu=new _UI63.Menu({hideOnEscape:!0,hideOnClick:!0,toggleMethod:"visibility",cls:"im-main-menu",showCls:"im-main-menu_visible",onItemClick:function(a){c._onMainMenuClick(null,a)}}),this.mainMenu.autoEl={tag:"div",html:e.join("")},this.mainMenu.render(this.el),this.mainMenu.setControlElement(b)}this.mainMenu.show()}else _WA126.contextMenu.show(a,d,{},this._onMainMenuClick.bind(this))}},{key:"_onClick",value:function(a){var b=this,c=a.getTarget(!0);if(c.up("im-topbar-buttons")){var d=c.up("imButton");if(d)switch(!0){case d.hasClass("im-readall-button"):_UI63.showConfirmBox(_WA126.tr("contextmenu.readAll"),_WA126.tr("box.readAllChatsConfirmation"),function(){b.dialogsWindow.markAllAsRead()});break;case d.hasClass("im-add-button"):this.showAddDialog();break;case d.hasClass("im-menu-button"):this._showMainMenu(a,d);break;case d.hasClass("im-write-button"):App.load("multiSearch",{mode:"message",keyword:""})}}}},{key:"_onResize",value:function(){var a=Math.min(1,window.innerHeight/_WA126.MIN_WINDOW_HEIGHT),b=Math.min(1,window.innerWidth/a/_WA126.MIN_WINDOW_WIDTH),c=_WA126.MIN_WINDOW_HEIGHT,d=window.innerHeight;1>b&&(a=Math.min(1,window.innerWidth/_WA126.MIN_WINDOW_WIDTH),c=_WA126.MIN_WINDOW_WIDTH,d=window.innerWidth);var e=Math.max(0,c-d),f=100/d*e;_WA126.zoom=a,_DomUtil59.getBody().setStyle({transform:1===a?"none":"scale(".concat(a,") translate(-").concat(f/2,"%, -").concat(f/2,"%)"),width:"".concat(100+f,"%"),height:"".concat(100+f,"%")})}},{key:"_renderApp",value:function(){var a=this;App.config.buttonClass("im-ui-button");var b,c;_DomUtil59.getBody().on("touchstart",function(a){c=!1,b={clientX:a.browserEvent.changedTouches[0].clientX,clientY:a.browserEvent.changedTouches[0].clientY}}).on("touchmove",function(a){var d=a.browserEvent;c?b||d.preventDefault():Math.abs(d.changedTouches[0].clientX-b.clientX)>10&&Math.abs(d.changedTouches[0].clientY-b.clientY)<10?(d.preventDefault(),b=!1,c=!0):Math.abs(d.changedTouches[0].clientY-b.clientY)>10&&(App.canScroll(d.target)&&App.breakSwapEvent(),c=!0)}).insertFirst(_DomUtil59.fly(document.createElement("a")).setAttribute("style","position:absolute;width:0;height:0;z-index:-1;").setAttribute("href","javascript:void(0);")),this.mainTabSwitcher=null,
App.populate("main",this._onMainPageLoad,null,this),_WA126.each(_WA126.populateList||[],function(a){App.populate(a.appPageName,a.onPageLoad,a.onPageUnload,a.appPageScope||a)}),App.load("main"),_WA126.hotKeyManager.addLayer({name:"main",activateOnCreate:!0,overlayOnHandle:!0,handlers:{tab:function(b){a.dialogsWindow.hasPttRecord()?a.tabNavigator.setFilterFunction(function(a){return!a.hasClass("imSearchFieldBlock")}):a.tabNavigator.resetFilterFunction(),a.tabNavigator.switchElement(b.shiftKey),b.preventDefault()},enter:function(b){var c=a.tabNavigator.getCurrentFocused();c&&"input"!==c.dom.tagName.toLowerCase()&&!c.getAttribute("contenteditable")&&(c.dom.click(),b.preventDefault())},search:function(b){var c=!_AS7.getOption(_AS7.OPTION_SEARCH_CHAT_HOTKEY),d={};if(b.browserEvent.shiftKey&&(c=!c),c){var e=a.dialogsWindow.getVisibleDialog();e&&(d={sn:e.mail,nick:e.nick})}a.activateGlobalSearch(d),b.stopEvent()}}})}},{key:"_onMainPageLoad",value:function(a){var b=_DomUtil59.fly(a);this.el=b,this.contactList.render(),this.dialogsWindow.render(b),App.on("page:show",this._onPageShow,this),this.unknownButton=b.getSelector(".im-unknown-button"),b.on("click",this._onClick,this),MainTabsSwitcher.render(),MainTabsSwitcher.tabSwitched.on(this.activateMainTab,this),MainTabsSwitcher.tabClicked.on(this._onMainTabClicked,this),_U111.Array.each(document.querySelectorAll(".imSearchFieldButton")||[],function(a){_DomUtil59.get(a).on(["input","click"],this._onMultiSearchFieldClick,this)},this),_WA126.onlineManager.toggleEvent.on(function(a){_WA126.Feature.getModeParameter("disableNetworkStateMessages")||_DomUtil59.getBody().toggleClass("im-connection-trouble","troubles"===a).toggleClass("im-connection-offline","offline"===a)})}},{key:"_onAfterRender",value:function(){}},{key:"_onPageShow",value:function(a){MainTabsSwitcher.toggle(a.pageName)}},{key:"_updateUnknownButton",value:function(a,b){this.unknownButton&&this.unknownButton[a?"show":"hide"]().first().updateText(b>999?"1k":b||"")}},{key:"_handleBoardParams",value:function(){var a=this,b=this.queryParams,c=b.imchat,d=_WA126.Feature.getModeParameter("showWidgetWelcomePage");if(!c){var e=_U111.String.parseQueryString(document.referrer);c=e.imchat}b=_WA126.boardModeParams||b,_WA126.boardModeParams=b,console.log("IM:MA:_handleBoardParams:openFixedChat:",c),c||d?_SOCK.onRequestable(1e4).then(function(){console.log("IM:MA:_handleBoardParams:onRequestable resolved"),c?_WA126.Feature.getModeParameter("openOnlyPublicChat")?_WA126.contactAbstraction.openReadableGroup(c)["catch"](function(){a._showBoardErrorMessage("board.msgChatNotFound")}):_WA126.contactAbstraction.openDialogById(c).then(function(){_WA126.LiveChats.chatProfileDialog&&_WA126.LiveChats.chatProfileDialog.isVisible()&&(_WA126.LiveChats.chatProfileDialog.initialConfig.hideOnClick=!1,_WA126.LiveChats.chatProfileDialog.initialConfig.hideOnEscape=!1)},function(){_WA126.Feature.getModeParameter("showWidgetWelcomePage")&&_WA126.widgetWelcomePage.open({widgetParams:b,loadParams:{authorized:!0,afterAuth:b.afterauth}})}):_WA126.widgetWelcomePage.open({widgetParams:b,loadParams:{authorized:!0,afterAuth:b.afterauth}})},function(){d?_WA126.widgetWelcomePage.open({widgetParams:b,loadParams:{authorized:!1,afterAuth:b.afterauth}}):a._showBoardErrorMessage("board.msgFailedToLogin")}):this._showBoardErrorMessage("board.msgChatNotFound")}},{key:"_showBoardErrorMessage",value:function(a){var b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";(_WA126.boardMode||_WA126.promoMode)&&_DomUtil59.get("imBoardMessage").updateText(_WA126.tr(a)+b)}},{key:"handleQueryParams",value:function(){var a=this,b=this.queryParams,c=b.mlogin,d=b.from;if(c&&c!==_WA126.ACTIVE_MAIL&&_WA126.isEmail(c)){var e=_WA126.tr("msgSwitchAccountTo",{productName:_WA126.PRODUCT_TITLE,current:_U111.String.htmlEntity(_WA126.ACTIVE_MAIL),forced:_U111.String.htmlEntity(c)});_UI63.showConfirmBox(e,function(){_WA126.ConnectionFacade.logout(!1,{mlogin:c})})}if(d){d.replace(/^\/webim/,"");var f=d.match(/^\/?icq\.new(?:\/([^\/?]+))?/);if(f)return void _SOCK.onRequestable(5e3).then(function(){a.contactList.abstraction.waitForReady().then(function(){App.load("multiSearch",{keyword:f[1]||""})})});var g=d.match(CUSTOM_BRANCH_REGEX);if(console.log("IM:MA:handleQueryParams:fromUrl=",d),g&&!b.autoredir){var h=d.replace(g[0],""),i=location.href;"/"===i.substr(-1)&&(i=i.slice(0,-1));var j=i+g[0]+"?autoredir=1"+(h?"&from="+h:"");return void(window.location=j)}b.autoredir&&console.log("IM:MA:handleQueryParams:Prevent looping redirect"),d.indexOf("bind_phone_result")>-1&&_WA126.ConnectionFacade.onReturnFromBindPhonePage(d);var k=_WA126.urlBuilder.openDialogLinkMatch(d);k&&_SOCK.onRequestable(5e3).then(function(){_WA126.contactAbstraction.openDialogById(k)})}}},{key:"showAddDialog",value:function(){var a=new _WA126.AddContactDialog(_WA126.contactAbstraction);a.show()}},{key:"showNewChannelDialog",value:function(){var a=new _WA126.CreateChannelBox({onCreated:function(){var a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},b=a.sn,c=a.name;b&&(_WA126.ma.openDialog(_WA126.makeContactArray(b,c)),setTimeout(function(){_WA126.Ava.updateLastModified(b,_WA126.now())},1e3))}});a.show()}},{key:"newGroup",value:function(a,b){return new Promise(function(c,d){_WA126.DialogsAgent.showAddMemberDialog({nameBlock:!0,allowEmpty:!0,name:a,disableBack:b,callback:function(a){a?c(a):d()}})})}},{key:"removeStorageDataFromCookie",value:function(){var a=document.cookie.match(/_AIM_[^=]+/g);a&&(_WA126.util.Mnt.log({reason:"storageDataInCookie",sn:_WA126.ACTIVE_MAIL}),a.forEach(function(a){_WA126.CookieStorage.remove(a.replace("_AIM_",""))}))}}]),a}();_WA126.MainAgent=MainAgent,_WA126.MainAgent.isChat=function(a,b){return-1!==a.indexOf("@chat.agent")||"chat"===b},WebIM.util.Mnt.wrapTryCatch(function(){(!WebIM.boardMode||window.WIDGET_MODE)&&(window.__T0=+new Date,WebIM.ma=new WebIM.MainAgent)});